<style>
/* Mobile-specific styles for iPhone 15 and similar devices */
@media screen and (max-width: 480px) {
    /* Force all grid layouts to single column */
    [style*="grid-template-columns"] {
        display: block !important;
    }
    [style*="grid-template-columns"] > div {
        margin-bottom: 16px !important;
    }
    /* Adjust padding for mobile */
    [style*="padding: 32px"],
    [style*="padding: 24px"] {
        padding: 16px !important;
    }
    /* Smaller headings */
    h4[style*="font-size: 18px"],
    h4[style*="font-size: 16px"] {
        font-size: 15px !important;
    }
    /* Readable font sizes */
    [style*="font-size: 13px"],
    [style*="font-size: 12px"],
    [style*="font-size: 11px"],
    [style*="font-size: 10px"] {
        font-size: 13px !important;
        line-height: 1.6 !important;
    }
    /* Flex containers stack vertically */
    [style*="display: flex"][style*="gap"] {
        flex-direction: column !important;
    }
    /* Better spacing for nested content */
    [style*="padding-left: 64px"],
    [style*="padding-left: 48px"],
    [style*="padding-left: 40px"] {
        padding-left: 16px !important;
    }
    /* Code blocks */
    pre {
        font-size: 12px !important;
        padding: 12px !important;
        overflow-x: auto !important;
    }
    pre code {
        font-size: 12px !important;
    }
    /* Tables */
    table {
        font-size: 12px !important;
        display: block !important;
        overflow-x: auto !important;
    }
    th, td {
        padding: 8px !important;
        font-size: 12px !important;
    }
}

.collapsible-code {
    margin: 16px 0;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    overflow: hidden;
}

.code-header {
    background-color: #f8fafc;
    padding: 12px 16px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e2e8f0;
    user-select: none;
    font-weight: 500;
    color: #334155;
}

.code-header:hover {
    background-color: #f1f5f9;
}

.code-toggle-icon {
    display: inline-block;
    width: 20px;
    height: 20px;
    transition: transform 0.2s ease;
    font-size: 14px;
    line-height: 20px;
}

.collapsible-code.collapsed .code-toggle-icon {
    transform: rotate(-90deg);
}

.code-content {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease, visibility 0.3s ease;
    visibility: visible;
}

.collapsible-code.collapsed .code-content {
    max-height: 0;
    visibility: hidden;
}

.code-content pre {
    margin: 0;
    border-radius: 0;
}

.code-content pre code {
    display: block;
    overflow-x: auto;
}

</style>
<h1 id="message-queues">Message Queues</h1>
<h2 id="table-of-contents-toc">Table of Contents {#toc}</h2>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#why-message-queues-matter">Why Message Queues Matter</a></li>
<li><a href="#how-message-queues-work">How Message Queues Work</a></li>
<li><a href="#message-queue-patterns">Message Queue Patterns</a>
<ul>
<li><a href="#pattern-point-to-point">Point-to-Point</a></li>
<li><a href="#pattern-publish-subscribe">Publish-Subscribe</a></li>
<li><a href="#pattern-request-reply">Request-Reply</a></li>
</ul>
</li>
<li><a href="#delivery-guarantees">Delivery Guarantees</a></li>
<li><a href="#dead-letter-queues">Dead Letter Queues</a></li>
<li><a href="#message-ordering">Message Ordering</a></li>
<li><a href="#edge-cases-failure-modes">Edge Cases &amp; Failure Modes</a></li>
<li><a href="#common-pitfalls">Common Pitfalls</a></li>
<li><a href="#popular-systems">Popular Message Queue Systems</a></li>
<li><a href="#interview-questions">Interview Questions</a></li>
<li><a href="#code-examples">Code Examples</a></li>
<li><a href="#best-practices">Best Practices</a></li>
<li><a href="#related-topics">Related Topics</a></li>
</ul>
<hr />
<h2 id="overview-overview">Overview {#overview}</h2>
<p>A message queue is a form of asynchronous service-to-service communication where messages are stored in a queue until they are processed by a consumer. Think of it like a postal system - you drop a letter in the mailbox (produce), and the recipient picks it up when they are ready (consume), without you needing to wait at their door.</p>
<p>Message queues decouple producers from consumers, enabling systems to handle load spikes gracefully, improve reliability through persistence, and scale components independently.</p>
<hr />
<h2 id="why-message-queues-matter-why-message-queues-matter">Why Message Queues Matter {#why-message-queues-matter}</h2>
<div style="background: #f0fdf4; border-radius: 12px; padding: 24px; margin: 20px 0">
<h4 style="color: #166534; margin-top: 0">Real-World Impact</h4>
<div style="color: #1e293b">
<p><strong>LinkedIn</strong> processes over 7 trillion messages per day through Apache Kafka for activity feeds, metrics, and data pipelines. Message queues enable them to handle massive scale without losing data.</p>
<p><strong>Uber</strong> uses message queues to coordinate rides - when you request a ride, the request goes into a queue that matches drivers with riders asynchronously, enabling them to handle millions of concurrent ride requests.</p>
<p><strong>Slack</strong> relies on message queues to deliver billions of messages reliably. Even if a recipient's client is offline, the message is queued and delivered when they reconnect.</p>
</div>
</div>
<h3 id="the-problem-direct-service-communication-problem-direct-communication">The Problem: Direct Service Communication {#problem-direct-communication}</h3>
<div style="background: #fef2f2; border-radius: 12px; padding: 24px; margin: 20px 0">
<h4 style="color: #991b1b; margin-top: 0">Without Message Queues</h4>
<div style="color: #1e293b">
<div class="collapsible-code collapsed">
    <div class="code-header">
        <span>Python</span>
        <span class="code-toggle-icon">▶</span>
    </div>
    <div class="code-content">
        <pre><code class="language-python">def place_order(order):
    save_to_database(order)           # 50ms
    email_service.send_confirmation() # 200ms (external API)
    inventory_service.update()        # 100ms
    warehouse_service.notify()        # 150ms
    analytics_service.track()         # 100ms
    # Total: 600ms before customer sees &quot;Order placed!&quot;
</code></pre>
    </div>
</div>
<p><strong>Problems:</strong></p>
<ul>
<li><strong>Slow response</strong>: Customer waits 600ms. Add more services = even slower</li>
<li><strong>Fragile</strong>: If email service is down, the entire order fails</li>
<li><strong>Tightly coupled</strong>: Order service must know about ALL downstream services</li>
<li><strong>No retries</strong>: If warehouse notification fails, how do you retry it?</li>
</ul>
</div>
</div>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 600; color: #991b1b; margin-bottom: 16px">Synchronous Flow - Slow & Fragile</div>
<div class="flow-row">
<div class="flow-box primary">
<div class="flow-box-title">Order Service</div>
<div class="flow-box-subtitle">Entry Point</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box info">
<div class="flow-box-title">Database</div>
<div class="flow-box-subtitle">50ms</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box warning">
<div class="flow-box-title">Email</div>
<div class="flow-box-subtitle">200ms</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box warning">
<div class="flow-box-title">Inventory</div>
<div class="flow-box-subtitle">100ms</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box warning">
<div class="flow-box-title">Warehouse</div>
<div class="flow-box-subtitle">150ms</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box error">
<div class="flow-box-title">Response</div>
<div class="flow-box-subtitle">600ms total</div>
</div>
</div>
</div>
</div>
<div style="background: #f0fdf4; border-radius: 12px; padding: 24px; margin: 20px 0">
<h4 style="color: #166534; margin-top: 0">With Message Queues</h4>
<div style="color: #1e293b">
<div class="collapsible-code collapsed">
    <div class="code-header">
        <span>Python</span>
        <span class="code-toggle-icon">▶</span>
    </div>
    <div class="code-content">
        <pre><code class="language-python">def place_order(order):
    save_to_database(order)            # 50ms
    queue.publish(&quot;order_placed&quot;, order)  # ~5ms
    return &quot;Success!&quot;
    # Total: 55ms - customer sees &quot;Order placed!&quot; immediately!
</code></pre>
    </div>
</div>
<p>Email, inventory, warehouse, and analytics services subscribe to &quot;order_placed&quot; and process independently at their own pace.</p>
</div>
</div>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 600; color: #166534; margin-bottom: 16px">Asynchronous Flow - Fast & Resilient</div>
<div class="flow-row">
<div class="flow-box primary">
<div class="flow-box-title">Order Service</div>
<div class="flow-box-subtitle">Entry Point</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box info">
<div class="flow-box-title">Database</div>
<div class="flow-box-subtitle">50ms</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box warning">
<div class="flow-box-title">Queue</div>
<div class="flow-box-subtitle">5ms</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box success">
<div class="flow-box-title">Response</div>
<div class="flow-box-subtitle">55ms total</div>
</div>
</div>
<div class="flow-arrow" style="transform: rotate(90deg); margin: 8px 0">&#8595;</div>
<div class="flow-row">
<div class="flow-box neutral">
<div class="flow-box-title">Email</div>
<div class="flow-box-subtitle">Async</div>
</div>
<div class="flow-box neutral">
<div class="flow-box-title">Inventory</div>
<div class="flow-box-subtitle">Async</div>
</div>
<div class="flow-box neutral">
<div class="flow-box-title">Warehouse</div>
<div class="flow-box-subtitle">Async</div>
</div>
<div class="flow-box neutral">
<div class="flow-box-title">Analytics</div>
<div class="flow-box-subtitle">Async</div>
</div>
</div>
</div>
</div>
<hr />
<h2 id="how-message-queues-work-how-message-queues-work">How Message Queues Work {#how-message-queues-work}</h2>
<h3 id="core-components-core-components">Core Components {#core-components}</h3>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 700; color: #1e293b; margin-bottom: 24px; font-size: 1.1rem">Message Queue Architecture</div>
<div class="flow-row">
<div class="flow-box primary">
<div class="flow-box-title">Producer</div>
<div class="flow-box-subtitle">Sends messages</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box warning" style="min-width: 180px">
<div class="flow-box-title">Message Queue</div>
<div class="flow-box-subtitle">Stores & delivers</div>
<div style="display: flex; gap: 6px; justify-content: center; margin-top: 10px">
<span class="diagram-badge warning">msg1</span>
<span class="diagram-badge warning">msg2</span>
<span class="diagram-badge warning">msg3</span>
</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box success">
<div class="flow-box-title">Consumer</div>
<div class="flow-box-subtitle">Processes messages</div>
</div>
</div>
</div>
</div>
<h3 id="key-benefits-key-benefits">Key Benefits {#key-benefits}</h3>
<div style="background: #f8fafc; border-radius: 12px; padding: 24px; margin: 20px 0">
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px">
<div style="background: #eff6ff; padding: 16px; border-radius: 8px">
<h5 style="color: #1e40af; margin: 0 0 8px 0">Temporal Decoupling</h5>
<p style="color: #1e293b; margin: 0; font-size: 13px">Producer and consumer don't need to be running at the same time</p>
</div>
<div style="background: #f0fdf4; padding: 16px; border-radius: 8px">
<h5 style="color: #166534; margin: 0 0 8px 0">Spatial Decoupling</h5>
<p style="color: #1e293b; margin: 0; font-size: 13px">Producer doesn't need to know where or what the consumer is</p>
</div>
<div style="background: #fefce8; padding: 16px; border-radius: 8px">
<h5 style="color: #854d0e; margin: 0 0 8px 0">Rate Decoupling</h5>
<p style="color: #1e293b; margin: 0; font-size: 13px">Producer can send faster than consumer processes</p>
</div>
</div>
</div>
<hr />
<h2 id="message-queue-patterns-message-queue-patterns">Message Queue Patterns {#message-queue-patterns}</h2>
<h3 id="pattern-1-point-to-point-work-queue-pattern-point-to-point">Pattern 1: Point-to-Point (Work Queue) {#pattern-point-to-point}</h3>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 700; color: #1e293b; margin-bottom: 24px; font-size: 1.1rem">Point-to-Point Pattern</div>
<div class="flow-row">
<div class="flow-box primary">
<div class="flow-box-title">Producer</div>
<div class="flow-box-subtitle">Sends tasks</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box warning" style="min-width: 160px">
<div class="flow-box-title">Queue</div>
<div style="display: flex; gap: 4px; justify-content: center; margin-top: 8px">
<span class="diagram-badge warning">msg1</span>
<span class="diagram-badge warning">msg2</span>
<span class="diagram-badge warning">msg3</span>
</div>
</div>
<div style="display: flex; flex-direction: column; gap: 8px">
<div style="display: flex; align-items: center; gap: 8px">
<div class="flow-arrow">&#8594;</div>
<div class="flow-box success">
<div class="flow-box-title">Consumer 1</div>
<div class="flow-box-subtitle">Gets msg1</div>
</div>
</div>
<div style="display: flex; align-items: center; gap: 8px">
<div class="flow-arrow">&#8594;</div>
<div class="flow-box success">
<div class="flow-box-title">Consumer 2</div>
<div class="flow-box-subtitle">Gets msg2</div>
</div>
</div>
</div>
</div>
<div style="background: #eff6ff; padding: 12px 16px; border-radius: 8px; margin-top: 16px">
<div style="color: #1e40af; font-size: 13px"><strong>Key:</strong> Each message is processed by exactly ONE consumer. Add more consumers to process faster.</div>
</div>
</div>
</div>
<p><strong>Use Cases:</strong> Order processing, email sending, image processing, background jobs</p>
<h3 id="pattern-2-publish-subscribe-fan-out-pattern-publish-subscribe">Pattern 2: Publish-Subscribe (Fan-out) {#pattern-publish-subscribe}</h3>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 700; color: #1e293b; margin-bottom: 24px; font-size: 1.1rem">Publish-Subscribe Pattern</div>
<div class="flow-row">
<div class="flow-box primary">
<div class="flow-box-title">Publisher</div>
<div class="flow-box-subtitle">Broadcasts event</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box purple" style="min-width: 140px">
<div class="flow-box-title">Topic</div>
<div class="flow-box-subtitle">user.created</div>
</div>
<div style="display: flex; flex-direction: column; gap: 8px">
<div style="display: flex; align-items: center; gap: 8px">
<div class="flow-arrow">&#8594;</div>
<div class="flow-box success">
<div class="flow-box-title">Email Service</div>
<div class="flow-box-subtitle">Copy 1</div>
</div>
</div>
<div style="display: flex; align-items: center; gap: 8px">
<div class="flow-arrow">&#8594;</div>
<div class="flow-box warning">
<div class="flow-box-title">Analytics</div>
<div class="flow-box-subtitle">Copy 2</div>
</div>
</div>
<div style="display: flex; align-items: center; gap: 8px">
<div class="flow-arrow">&#8594;</div>
<div class="flow-box info">
<div class="flow-box-title">CRM Service</div>
<div class="flow-box-subtitle">Copy 3</div>
</div>
</div>
</div>
</div>
<div style="background: rgba(139, 92, 246, 0.1); padding: 12px 16px; border-radius: 8px; margin-top: 16px">
<div style="color: #7c3aed; font-size: 13px"><strong>Key:</strong> ALL subscribers receive a copy of every message. Publisher doesn't know who is listening.</div>
</div>
</div>
</div>
<p><strong>Use Cases:</strong> Event notifications, activity feeds, real-time updates</p>
<h3 id="pattern-3-request-reply-pattern-request-reply">Pattern 3: Request-Reply {#pattern-request-reply}</h3>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 700; color: #1e293b; margin-bottom: 24px; font-size: 1.1rem">Request-Reply Pattern</div>
<div class="flow-row">
<div class="flow-box primary">
<div class="flow-box-title">Requester</div>
<div class="flow-box-subtitle">Sends request</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box warning">
<div class="flow-box-title">Request Queue</div>
<div class="flow-box-subtitle">with correlation_id</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box info">
<div class="flow-box-title">Responder</div>
<div class="flow-box-subtitle">Processes</div>
</div>
</div>
<div style="display: flex; justify-content: center; margin: 16px 0">
<div class="flow-arrow" style="transform: rotate(180deg)">&#8592;</div>
</div>
<div class="flow-row">
<div class="flow-box success">
<div class="flow-box-title">Requester</div>
<div class="flow-box-subtitle">Gets response</div>
</div>
<div class="flow-arrow" style="transform: rotate(180deg)">&#8592;</div>
<div class="flow-box warning">
<div class="flow-box-title">Reply Queue</div>
<div class="flow-box-subtitle">matched by id</div>
</div>
<div class="flow-arrow" style="transform: rotate(180deg)">&#8592;</div>
<div class="flow-box info">
<div class="flow-box-title">Responder</div>
<div class="flow-box-subtitle">Sends reply</div>
</div>
</div>
</div>
</div>
<div style="background: #f8fafc; border-radius: 12px; padding: 24px; margin: 20px 0">
<h4 style="color: #1e293b; margin-top: 0">Request-Reply Implementation</h4>
<p style="color: #475569">Synchronous-like pattern over async messaging. Used when you need a response but want queue benefits.</p>
<div class="collapsible-code collapsed">
    <div class="code-header">
        <span>Python</span>
        <span class="code-toggle-icon">▶</span>
    </div>
    <div class="code-content">
        <pre><code class="language-python"># Requester
correlation_id = uuid4()
queue.send(&quot;requests&quot;, {
    &quot;action&quot;: &quot;get_user&quot;,
    &quot;user_id&quot;: 123,
    &quot;reply_to&quot;: &quot;responses&quot;,
    &quot;correlation_id&quot;: correlation_id
})
response = wait_for_response(correlation_id)

# Responder
request = queue.receive(&quot;requests&quot;)
result = process(request)
queue.send(request[&quot;reply_to&quot;], {
    &quot;correlation_id&quot;: request[&quot;correlation_id&quot;],
    &quot;result&quot;: result
})
</code></pre>
    </div>
</div>
</div>
<hr />
<h2 id="delivery-guarantees-delivery-guarantees">Delivery Guarantees {#delivery-guarantees}</h2>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 700; color: #1e293b; margin-bottom: 24px; font-size: 1.1rem">Delivery Guarantees Comparison</div>
<div class="flow-row" style="align-items: stretch">
<div class="flow-box error" style="flex: 1; max-width: 250px">
<div class="flow-box-title">At-Most-Once</div>
<div class="flow-box-subtitle">"Fire and forget"</div>
<div style="text-align: left; margin-top: 12px; font-size: 12px">
<div>- Message may be lost</div>
<div>- No duplicates</div>
<div>- Fastest option</div>
</div>
<div style="background: rgba(255,255,255,0.9); padding: 6px 8px; border-radius: 4px; margin-top: 8px; font-size: 11px">
<strong>Use for:</strong> Metrics, logs
</div>
</div>
<div class="flow-box info" style="flex: 1; max-width: 250px">
<div class="flow-box-title">At-Least-Once</div>
<div class="flow-box-subtitle">"Keep trying"</div>
<div style="text-align: left; margin-top: 12px; font-size: 12px">
<div>- Message will arrive</div>
<div>- May have duplicates</div>
<div>- Needs idempotency</div>
</div>
<div style="background: rgba(255,255,255,0.9); padding: 6px 8px; border-radius: 4px; margin-top: 8px; font-size: 11px">
<strong>Use for:</strong> Most systems
</div>
</div>
<div class="flow-box success" style="flex: 1; max-width: 250px">
<div class="flow-box-title">Exactly-Once</div>
<div class="flow-box-subtitle">"Guaranteed single"</div>
<div style="text-align: left; margin-top: 12px; font-size: 12px">
<div>- No loss, no duplicates</div>
<div>- Complex to implement</div>
<div>- Higher latency</div>
</div>
<div style="background: rgba(255,255,255,0.9); padding: 6px 8px; border-radius: 4px; margin-top: 8px; font-size: 11px">
<strong>Use for:</strong> Payments
</div>
</div>
</div>
</div>
</div>
<h3 id="the-duplicate-problem-duplicate-problem">The Duplicate Problem {#duplicate-problem}</h3>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 600; color: #92400e; margin-bottom: 16px">Why At-Least-Once Can Cause Duplicates</div>
<div class="flow-row">
<div class="flow-box warning">
<div class="flow-box-title">1. Queue</div>
<div class="flow-box-subtitle">Sends message</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box success">
<div class="flow-box-title">2. Consumer</div>
<div class="flow-box-subtitle">Transfers $100</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box error">
<div class="flow-box-title">3. ACK Fails</div>
<div class="flow-box-subtitle">Network error!</div>
</div>
</div>
<div class="flow-arrow" style="transform: rotate(90deg); margin: 12px 0">&#8595;</div>
<div class="flow-row">
<div class="flow-box warning">
<div class="flow-box-title">4. Queue</div>
<div class="flow-box-subtitle">Thinks undelivered</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box warning">
<div class="flow-box-title">5. Resends</div>
<div class="flow-box-subtitle">Same message</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box error">
<div class="flow-box-title">6. Double!</div>
<div class="flow-box-subtitle">$200 transferred</div>
</div>
</div>
</div>
</div>
<h3 id="the-solution-idempotency-solution-idempotency">The Solution: Idempotency {#solution-idempotency}</h3>
<div style="background: #f0fdf4; border-radius: 12px; padding: 24px; margin: 20px 0">
<h4 style="color: #166534; margin-top: 0">Making Consumers Idempotent</h4>
<div class="collapsible-code collapsed">
    <div class="code-header">
        <span>Python</span>
        <span class="code-toggle-icon">▶</span>
    </div>
    <div class="code-content">
        <pre><code class="language-python">def process_payment(message):
    # BAD: Always transfers money
    transfer_money(message.from_user, message.to_user, message.amount)

    # GOOD: Check if already processed
    if not already_processed(message.id):
        transfer_money(message.from_user, message.to_user, message.amount)
        mark_as_processed(message.id)
</code></pre>
    </div>
</div>
<div style="color: #166534; font-size: 13px; margin-top: 12px">
<strong>Rule:</strong> Processing the same message twice should have the same effect as processing it once.
</div>
</div>
<hr />
<h2 id="dead-letter-queues-dead-letter-queues">Dead Letter Queues {#dead-letter-queues}</h2>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 700; color: #1e293b; margin-bottom: 24px; font-size: 1.1rem">Dead Letter Queue Flow</div>
<div class="flow-row">
<div class="flow-box warning">
<div class="flow-box-title">Main Queue</div>
<div class="flow-box-subtitle">Messages waiting</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box info">
<div class="flow-box-title">Consumer</div>
<div class="flow-box-subtitle">Processes</div>
</div>
</div>
<div style="display: flex; align-items: center; gap: 16px; margin: 16px 0">
<div style="flex: 1; text-align: right; color: #64748b; font-size: 12px">Retry 1, 2, 3... Failed</div>
<div class="flow-arrow" style="transform: rotate(90deg)">&#8595;</div>
<div style="flex: 1"></div>
</div>
<div class="flow-row">
<div class="flow-box error" style="min-width: 200px">
<div class="flow-box-title">Dead Letter Queue</div>
<div class="flow-box-subtitle">For investigation & manual processing</div>
</div>
</div>
</div>
</div>
<div class="collapsible-code collapsed">
    <div class="code-header">
        <span>Python</span>
        <span class="code-toggle-icon">▶</span>
    </div>
    <div class="code-content">
        <pre><code class="language-python">class MessageProcessor:
    MAX_RETRIES = 3

    def process(self, message):
        try:
            self.handle(message)
            self.queue.acknowledge(message)
        except Exception as e:
            retry_count = message.get('retry_count', 0)

            if retry_count &gt;= self.MAX_RETRIES:
                # Move to dead letter queue
                self.dlq.send(message)
                self.queue.acknowledge(message)
            else:
                # Retry with exponential backoff
                message['retry_count'] = retry_count + 1
                delay = 2 ** retry_count  # 1s, 2s, 4s
                self.queue.send(message, delay=delay)
</code></pre>
    </div>
</div>
<hr />
<h2 id="message-ordering-message-ordering">Message Ordering {#message-ordering}</h2>
<h3 id="fifo-vs-partitioned-ordering-fifo-vs-partitioned">FIFO vs Partitioned Ordering {#fifo-vs-partitioned}</h3>
<div style="background: #f8fafc; border-radius: 12px; padding: 24px; margin: 20px 0">
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 16px">
<div style="background: #eff6ff; padding: 16px; border-radius: 8px">
<h5 style="color: #1e40af; margin: 0 0 12px 0">FIFO Queue</h5>
<p style="color: #475569; font-size: 13px; margin: 0">All messages processed in exact order. Simple but limits throughput to single consumer.</p>
</div>
<div style="background: #f0fdf4; padding: 16px; border-radius: 8px">
<h5 style="color: #166534; margin: 0 0 12px 0">Partitioned Queue</h5>
<p style="color: #475569; font-size: 13px; margin: 0">Order guaranteed within partition. Use partition key to keep related messages together.</p>
</div>
</div>
</div>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 700; color: #1e293b; margin-bottom: 24px; font-size: 1.1rem">Partitioned Ordering</div>
<div style="display: flex; flex-direction: column; gap: 12px; width: 100%">
<div class="flow-row" style="justify-content: flex-start">
<div class="flow-box success" style="min-width: 100px">
<div class="flow-box-title">Partition 0</div>
</div>
<div style="display: flex; gap: 4px; margin: 0 16px">
<span class="diagram-badge success">msg1</span>
<span class="diagram-badge success">msg2</span>
<span class="diagram-badge success">msg3</span>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box success">
<div class="flow-box-title">Consumer 0</div>
</div>
</div>
<div class="flow-row" style="justify-content: flex-start">
<div class="flow-box info" style="min-width: 100px">
<div class="flow-box-title">Partition 1</div>
</div>
<div style="display: flex; gap: 4px; margin: 0 16px">
<span class="diagram-badge info">msg4</span>
<span class="diagram-badge info">msg5</span>
<span class="diagram-badge info">msg6</span>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box info">
<div class="flow-box-title">Consumer 1</div>
</div>
</div>
</div>
<div style="background: #fefce8; padding: 12px 16px; border-radius: 8px; margin-top: 16px">
<div style="color: #854d0e; font-size: 13px"><strong>Partition Key Example:</strong> hash(user_id) % num_partitions ensures all messages for one user go to same partition and are processed in order.</div>
</div>
</div>
</div>
<hr />
<h2 id="edge-cases--failure-modes-edge-cases-failure-modes">Edge Cases &amp; Failure Modes {#edge-cases-failure-modes}</h2>
<p>Understanding failure scenarios is critical for building robust message queue systems.</p>
<h3 id="message-loss-scenarios-message-loss-scenarios">Message Loss Scenarios {#message-loss-scenarios}</h3>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 700; color: #991b1b; margin-bottom: 24px; font-size: 1.1rem">Message Loss Points</div>
<div class="flow-row">
<div class="flow-box primary">
<div class="flow-box-title">Producer</div>
</div>
<div class="flow-box error" style="padding: 8px">
<div style="font-size: 11px">Loss Point 1</div>
<div style="font-size: 10px">Network failure</div>
</div>
<div class="flow-box warning">
<div class="flow-box-title">Queue</div>
</div>
<div class="flow-box error" style="padding: 8px">
<div style="font-size: 11px">Loss Point 2</div>
<div style="font-size: 10px">Disk failure</div>
</div>
<div class="flow-box success">
<div class="flow-box-title">Consumer</div>
</div>
</div>
</div>
</div>
<div style="background: #fef2f2; border-radius: 12px; padding: 24px; margin: 20px 0">
<h4 style="color: #991b1b; margin-top: 0">Common Message Loss Causes</h4>
<div style="display: flex; flex-direction: column; gap: 12px; color: #1e293b">
<div style="background: #fff; padding: 12px; border-radius: 8px">
<strong>Producer-side Loss:</strong> Message sent but network fails before queue receives it. Use acknowledgments and retries.
</div>
<div style="background: #fff; padding: 12px; border-radius: 8px">
<strong>Broker Crash:</strong> In-memory messages lost on restart. Use persistent/durable queues with disk writes.
</div>
<div style="background: #fff; padding: 12px; border-radius: 8px">
<strong>Consumer ACK Before Processing:</strong> Consumer acknowledges, then crashes. Process first, ACK after.
</div>
</div>
</div>
<div class="collapsible-code collapsed">
    <div class="code-header">
        <span>Python</span>
        <span class="code-toggle-icon">▶</span>
    </div>
    <div class="code-content">
        <pre><code class="language-python"># PREVENTION: Transactional Outbox Pattern
def place_order_safely(order):
    with database.transaction():
        # 1. Save order and outbox message in same transaction
        save_order(order)
        save_to_outbox({
            &quot;id&quot;: uuid4(),
            &quot;event&quot;: &quot;order_placed&quot;,
            &quot;payload&quot;: order,
            &quot;status&quot;: &quot;pending&quot;
        })
    # 2. Separate process polls outbox and publishes to queue
    # 3. Only marks as &quot;sent&quot; after queue confirms receipt
</code></pre>
    </div>
</div>
<h3 id="duplicate-message-handling-duplicate-message-handling">Duplicate Message Handling {#duplicate-message-handling}</h3>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 700; color: #1e293b; margin-bottom: 24px; font-size: 1.1rem">Duplicate Prevention Strategies</div>
<div class="flow-row" style="align-items: stretch">
<div class="flow-box info" style="flex: 1; max-width: 220px">
<div class="flow-box-title">Message Deduplication</div>
<div style="text-align: left; margin-top: 12px; font-size: 11px">
<div>1. Store message IDs in cache</div>
<div>2. Check before processing</div>
<div>3. TTL based on retention</div>
</div>
</div>
<div class="flow-box success" style="flex: 1; max-width: 220px">
<div class="flow-box-title">Idempotent Operations</div>
<div style="text-align: left; margin-top: 12px; font-size: 11px">
<div>1. Use unique request IDs</div>
<div>2. Check final state vs action</div>
<div>3. SET not INCREMENT</div>
</div>
</div>
<div class="flow-box purple" style="flex: 1; max-width: 220px">
<div class="flow-box-title">Database Constraints</div>
<div style="text-align: left; margin-top: 12px; font-size: 11px">
<div>1. Unique index on msg_id</div>
<div>2. Upsert operations</div>
<div>3. Optimistic locking</div>
</div>
</div>
</div>
</div>
</div>
<div class="collapsible-code collapsed">
    <div class="code-header">
        <span>Python</span>
        <span class="code-toggle-icon">▶</span>
    </div>
    <div class="code-content">
        <pre><code class="language-python">class IdempotentConsumer:
    def __init__(self, redis_client, ttl_hours=24):
        self.redis = redis_client
        self.ttl = ttl_hours * 3600

    def process(self, message):
        message_id = message['id']

        # Atomic check-and-set with Redis
        if not self.redis.set(f&quot;processed:{message_id}&quot;, &quot;1&quot;,
                              nx=True, ex=self.ttl):
            # Already processed - skip
            return {&quot;status&quot;: &quot;duplicate&quot;, &quot;message_id&quot;: message_id}

        try:
            result = self.handle(message)
            return {&quot;status&quot;: &quot;processed&quot;, &quot;result&quot;: result}
        except Exception as e:
            # Remove marker so message can be retried
            self.redis.delete(f&quot;processed:{message_id}&quot;)
            raise
</code></pre>
    </div>
</div>
<h3 id="consumer-failure-scenarios-consumer-failure-scenarios">Consumer Failure Scenarios {#consumer-failure-scenarios}</h3>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 700; color: #1e293b; margin-bottom: 24px; font-size: 1.1rem">Consumer Failure & Recovery</div>
<div style="display: flex; flex-direction: column; gap: 16px; width: 100%">
<div class="flow-row">
<div class="flow-box warning">
<div class="flow-box-title">Queue</div>
<div class="flow-box-subtitle">Visibility timeout: 30s</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box info">
<div class="flow-box-title">Consumer A</div>
<div class="flow-box-subtitle">Gets message</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box error">
<div class="flow-box-title">CRASH!</div>
<div class="flow-box-subtitle">No ACK sent</div>
</div>
</div>
<div style="text-align: center; color: #64748b; font-size: 12px">After 30 seconds...</div>
<div class="flow-row">
<div class="flow-box warning">
<div class="flow-box-title">Queue</div>
<div class="flow-box-subtitle">Message reappears</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box success">
<div class="flow-box-title">Consumer B</div>
<div class="flow-box-subtitle">Gets same message</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box success">
<div class="flow-box-title">Success</div>
<div class="flow-box-subtitle">ACK sent</div>
</div>
</div>
</div>
</div>
</div>
<div style="background: #fff7ed; border-radius: 12px; padding: 24px; margin: 20px 0">
<h4 style="color: #92400e; margin-top: 0">Critical: Visibility Timeout Configuration</h4>
<div style="color: #1e293b; font-size: 14px">
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Too Short</th>
<th>Too Long</th>
</tr>
</thead>
<tbody>
<tr>
<td>Problem</td>
<td>Message redelivered mid-processing</td>
<td>Slow recovery from crashes</td>
</tr>
<tr>
<td>Effect</td>
<td>Duplicate processing</td>
<td>Messages stuck invisible</td>
</tr>
<tr>
<td>Solution</td>
<td>Timeout &gt; max processing time</td>
<td>Use heartbeat extensions</td>
</tr>
</tbody>
</table>
<div class="collapsible-code collapsed">
    <div class="code-header">
        <span>Python</span>
        <span class="code-toggle-icon">▶</span>
    </div>
    <div class="code-content">
        <pre><code class="language-python"># Heartbeat pattern for long-running tasks
def process_with_heartbeat(message):
    def extend_visibility():
        while not done:
            queue.extend_visibility(message, seconds=30)
            time.sleep(20)  # Extend before timeout

    heartbeat_thread = Thread(target=extend_visibility)
    heartbeat_thread.start()

    try:
        result = long_running_process(message)
        done = True
        queue.acknowledge(message)
    except:
        done = True
        raise
</code></pre>
    </div>
</div>
</div>
</div>
<h3 id="poison-message-handling-poison-message-handling">Poison Message Handling {#poison-message-handling}</h3>
<div class="diagram-container">
<div class="flow-diagram">
<div style="text-align: center; font-weight: 700; color: #991b1b; margin-bottom: 24px; font-size: 1.1rem">Poison Message Detection</div>
<div class="flow-row">
<div class="flow-box error" style="min-width: 160px">
<div class="flow-box-title">Poison Message</div>
<div class="flow-box-subtitle">Always fails</div>
</div>
<div style="display: flex; flex-direction: column; gap: 4px; align-items: center">
<div class="flow-arrow">&#8594;</div>
<div style="font-size: 10px; color: #64748b">Retry 1</div>
</div>
<div class="flow-box error" style="padding: 8px">
<div style="font-size: 11px">FAIL</div>
</div>
<div style="display: flex; flex-direction: column; gap: 4px; align-items: center">
<div class="flow-arrow">&#8594;</div>
<div style="font-size: 10px; color: #64748b">Retry 2</div>
</div>
<div class="flow-box error" style="padding: 8px">
<div style="font-size: 11px">FAIL</div>
</div>
<div style="display: flex; flex-direction: column; gap: 4px; align-items: center">
<div class="flow-arrow">&#8594;</div>
<div style="font-size: 10px; color: #64748b">Retry 3</div>
</div>
<div class="flow-box error" style="padding: 8px">
<div style="font-size: 11px">DLQ</div>
</div>
</div>
</div>
</div>
<div class="collapsible-code collapsed">
    <div class="code-header">
        <span>Python</span>
        <span class="code-toggle-icon">▶</span>
    </div>
    <div class="code-content">
        <pre><code class="language-python">class PoisonMessageHandler:
    &quot;&quot;&quot;Detect and quarantine messages that always fail.&quot;&quot;&quot;

    def __init__(self, max_retries=3, alert_threshold=10):
        self.max_retries = max_retries
        self.alert_threshold = alert_threshold
        self.failure_counts = defaultdict(int)

    def process(self, message):
        msg_id = message['id']
        delivery_count = message.get('delivery_count', 1)

        if delivery_count &gt; self.max_retries:
            self.quarantine(message)
            return

        try:
            result = self.handle(message)
            self.failure_counts.pop(msg_id, None)
            return result
        except Exception as e:
            self.failure_counts[msg_id] += 1

            if self.failure_counts[msg_id] &gt;= self.alert_threshold:
                self.alert_ops_team(message, e)

            raise  # Let queue retry

    def quarantine(self, message):
        &quot;&quot;&quot;Move to DLQ with full context for debugging.&quot;&quot;&quot;
        self.dlq.send({
            &quot;original_message&quot;: message,
            &quot;failure_reason&quot;: self.last_error,
            &quot;retry_count&quot;: message.get('delivery_count', 0),
            &quot;quarantined_at&quot;: datetime.now().isoformat()
        })
</code></pre>
    </div>
</div>
<hr />
<h2 id="common-pitfalls-common-pitfalls">Common Pitfalls {#common-pitfalls}</h2>
<div style="background: #fef2f2; border-radius: 12px; padding: 24px; margin: 20px 0">
<h4 style="color: #991b1b; margin-top: 0">Mistakes to Avoid</h4>
<div style="display: flex; flex-direction: column; gap: 12px; color: #1e293b">
<div style="background: #fff; padding: 12px; border-radius: 8px">
<strong>Non-Idempotent Consumers:</strong> Without idempotency, duplicate messages cause data corruption or double charges.
</div>
<div style="background: #fff; padding: 12px; border-radius: 8px">
<strong>No Dead Letter Queue:</strong> Poison messages (that always fail) will block the queue forever or be lost.
</div>
<div style="background: #fff; padding: 12px; border-radius: 8px">
<strong>Ignoring Backpressure:</strong> If consumers can't keep up, queues grow unbounded, eventually causing OOM or disk full.
</div>
<div style="background: #fff; padding: 12px; border-radius: 8px">
<strong>Wrong Visibility Timeout:</strong> If timeout is shorter than processing time, messages get redelivered mid-processing.
</div>
<div style="background: #fff; padding: 12px; border-radius: 8px">
<strong>No Monitoring:</strong> Without queue depth monitoring, you won't know consumers are falling behind until it's too late.
</div>
</div>
</div>
<hr />
<h2 id="popular-message-queue-systems-popular-systems">Popular Message Queue Systems {#popular-systems}</h2>
<div style="background: #f8fafc; border-radius: 12px; padding: 24px; margin: 20px 0;overflow-x: auto">
<table style="width: 100%; border-collapse: collapse; font-size: 14px; min-width: 500px">
<tr style="background: #f1f5f9">
<th style="padding: 12px; text-align: left; color: #1e293b">System</th>
<th style="padding: 12px; text-align: left; color: #1e293b">Best For</th>
<th style="padding: 12px; text-align: left; color: #1e293b">Key Features</th>
</tr>
<tr>
<td style="padding: 12px; color: #1e293b"><strong>Apache Kafka</strong></td>
<td style="padding: 12px; color: #475569">High throughput streaming</td>
<td style="padding: 12px; color: #475569">Log-based, partitions, retention</td>
</tr>
<tr>
<td style="padding: 12px; color: #1e293b"><strong>RabbitMQ</strong></td>
<td style="padding: 12px; color: #475569">Complex routing</td>
<td style="padding: 12px; color: #475569">AMQP, exchanges, bindings</td>
</tr>
<tr>
<td style="padding: 12px; color: #1e293b"><strong>Amazon SQS</strong></td>
<td style="padding: 12px; color: #475569">AWS workloads</td>
<td style="padding: 12px; color: #475569">Managed, auto-scaling, FIFO</td>
</tr>
<tr>
<td style="padding: 12px; color: #1e293b"><strong>Redis Streams</strong></td>
<td style="padding: 12px; color: #475569">Real-time, low latency</td>
<td style="padding: 12px; color: #475569">In-memory, consumer groups</td>
</tr>
<tr>
<td style="padding: 12px; color: #1e293b"><strong>Apache Pulsar</strong></td>
<td style="padding: 12px; color: #475569">Multi-tenancy</td>
<td style="padding: 12px; color: #475569">Tiered storage, geo-replication</td>
</tr>
</table>
</div>
<hr />
<h2 id="interview-questions-interview-questions">Interview Questions {#interview-questions}</h2>
<div style="background: #f3e8ff; border-radius: 12px; padding: 24px; margin: 20px 0">
<h4 style="color: #7c3aed; margin-top: 0">Common Interview Questions</h4>
<div style="display: flex; flex-direction: column; gap: 16px; color: #1e293b">
<div>
<strong>1. How do you ensure exactly-once processing?</strong>
<ul style="margin: 8px 0 0 0; color: #475569">
<li>Use idempotent consumers with deduplication</li>
<li>Store message ID before processing, check before each operation</li>
<li>Use transactional outbox pattern for database + queue atomicity</li>
<li>Leverage Kafka transactions or similar built-in features</li>
</ul>
</div>
<div>
<strong>2. How do you handle message ordering?</strong>
<ul style="margin: 8px 0 0 0; color: #475569">
<li>Use partition keys to route related messages to same partition</li>
<li>Single consumer per partition guarantees order</li>
<li>Include sequence numbers for verification</li>
<li>Accept eventual consistency where possible</li>
</ul>
</div>
<div>
<strong>3. What happens if a consumer crashes mid-processing?</strong>
<ul style="margin: 8px 0 0 0; color: #475569">
<li>Message remains unacknowledged in queue</li>
<li>After visibility timeout, message becomes visible again</li>
<li>Another consumer (or same one after restart) picks it up</li>
<li>Idempotency ensures safe reprocessing</li>
</ul>
</div>
<div>
<strong>4. How do you scale message consumers?</strong>
<ul style="margin: 8px 0 0 0; color: #475569">
<li>Add more partitions to increase parallelism</li>
<li>Consumer groups share partitions automatically</li>
<li>Each partition assigned to one consumer in the group</li>
<li>Monitor lag and scale based on queue depth</li>
</ul>
</div>
<div>
<strong>5. Kafka vs RabbitMQ - when to use each?</strong>
<ul style="margin: 8px 0 0 0; color: #475569">
<li><strong>Kafka:</strong> High throughput, event streaming, replay capability, log aggregation</li>
<li><strong>RabbitMQ:</strong> Complex routing, request-reply, lower latency, traditional messaging</li>
</ul>
</div>
</div>
</div>
<hr />
<h2 id="code-examples-code-examples">Code Examples {#code-examples}</h2>
<h3 id="python---simple-message-queue-python-example">Python - Simple Message Queue {#python-example}</h3>
<div class="collapsible-code collapsed">
    <div class="code-header">
        <span>Python</span>
        <span class="code-toggle-icon">▶</span>
    </div>
    <div class="code-content">
        <pre><code class="language-python">import json
import threading
import time
from queue import Queue, Empty
from typing import Callable, Dict, Any
from dataclasses import dataclass
from datetime import datetime
import uuid

@dataclass
class Message:
    id: str
    topic: str
    payload: Dict[str, Any]
    timestamp: datetime
    retry_count: int = 0

class InMemoryMessageQueue:
    def __init__(self):
        self.queues: Dict[str, Queue] = {}
        self.subscribers: Dict[str, list] = {}
        self.dlq: Queue = Queue()
        self.processed_ids: set = set()
        self.lock = threading.Lock()

    def create_queue(self, name: str):
        with self.lock:
            if name not in self.queues:
                self.queues[name] = Queue()

    def send(self, queue_name: str, payload: Dict[str, Any], delay: int = 0):
        message = Message(
            id=str(uuid.uuid4()),
            topic=queue_name,
            payload=payload,
            timestamp=datetime.now()
        )

        if delay &gt; 0:
            threading.Timer(delay, lambda: self._enqueue(queue_name, message)).start()
        else:
            self._enqueue(queue_name, message)

        return message.id

    def _enqueue(self, queue_name: str, message: Message):
        self.create_queue(queue_name)
        self.queues[queue_name].put(message)

    def receive(self, queue_name: str, timeout: float = None) -&gt; Message:
        self.create_queue(queue_name)
        try:
            return self.queues[queue_name].get(timeout=timeout)
        except Empty:
            return None

    def subscribe(self, topic: str, handler: Callable):
        with self.lock:
            if topic not in self.subscribers:
                self.subscribers[topic] = []
            self.subscribers[topic].append(handler)

    def publish(self, topic: str, payload: Dict[str, Any]):
        message = Message(
            id=str(uuid.uuid4()),
            topic=topic,
            payload=payload,
            timestamp=datetime.now()
        )

        handlers = self.subscribers.get(topic, [])
        for handler in handlers:
            threading.Thread(target=handler, args=(message,)).start()


# Usage
mq = InMemoryMessageQueue()

# Point-to-point
def order_handler(message):
    print(f&quot;Processing order: {message.payload}&quot;)

mq.send(&quot;orders&quot;, {&quot;order_id&quot;: 123, &quot;amount&quot;: 99.99})

# Pub-Sub
mq.subscribe(&quot;user.created&quot;, lambda msg: print(f&quot;Email: {msg.payload}&quot;))
mq.subscribe(&quot;user.created&quot;, lambda msg: print(f&quot;Analytics: {msg.payload}&quot;))
mq.publish(&quot;user.created&quot;, {&quot;user_id&quot;: 456, &quot;email&quot;: &quot;test@example.com&quot;})
</code></pre>
    </div>
</div>
<h3 id="go---message-queue-with-worker-pool-go-example">Go - Message Queue with Worker Pool {#go-example}</h3>
<div class="collapsible-code collapsed">
    <div class="code-header">
        <span>Go</span>
        <span class="code-toggle-icon">▶</span>
    </div>
    <div class="code-content">
        <pre><code class="language-go">package main

import (
    &quot;context&quot;
    &quot;fmt&quot;
    &quot;sync&quot;
    &quot;time&quot;

    &quot;github.com/google/uuid&quot;
)

type Message struct {
    ID        string
    Topic     string
    Payload   map[string]interface{}
    Timestamp time.Time
    Retries   int
}

type MessageQueue struct {
    queues      map[string]chan *Message
    subscribers map[string][]func(*Message)
    dlq         chan *Message
    mu          sync.RWMutex
}

func NewMessageQueue() *MessageQueue {
    return &amp;MessageQueue{
        queues:      make(map[string]chan *Message),
        subscribers: make(map[string][]func(*Message)),
        dlq:         make(chan *Message, 1000),
    }
}

func (mq *MessageQueue) CreateQueue(name string, size int) {
    mq.mu.Lock()
    defer mq.mu.Unlock()
    if _, exists := mq.queues[name]; !exists {
        mq.queues[name] = make(chan *Message, size)
    }
}

func (mq *MessageQueue) Send(queueName string, payload map[string]interface{}) string {
    mq.CreateQueue(queueName, 1000)
    msg := &amp;Message{
        ID:        uuid.New().String(),
        Topic:     queueName,
        Payload:   payload,
        Timestamp: time.Now(),
    }
    mq.queues[queueName] &lt;- msg
    return msg.ID
}

type WorkerPool struct {
    mq        *MessageQueue
    queueName string
    workers   int
    handler   func(*Message) error
    maxRetry  int
    ctx       context.Context
    cancel    context.CancelFunc
    wg        sync.WaitGroup
}

func NewWorkerPool(mq *MessageQueue, queueName string, workers int, handler func(*Message) error) *WorkerPool {
    ctx, cancel := context.WithCancel(context.Background())
    return &amp;WorkerPool{
        mq:        mq,
        queueName: queueName,
        workers:   workers,
        handler:   handler,
        maxRetry:  3,
        ctx:       ctx,
        cancel:    cancel,
    }
}

func (wp *WorkerPool) Start() {
    for i := 0; i &lt; wp.workers; i++ {
        wp.wg.Add(1)
        go wp.worker(i)
    }
}

func (wp *WorkerPool) worker(id int) {
    defer wp.wg.Done()
    for {
        select {
        case &lt;-wp.ctx.Done():
            return
        case msg := &lt;-wp.mq.queues[wp.queueName]:
            if err := wp.handler(msg); err != nil {
                wp.handleFailure(msg, err)
            }
        }
    }
}

func (wp *WorkerPool) handleFailure(msg *Message, err error) {
    msg.Retries++
    if msg.Retries &gt;= wp.maxRetry {
        fmt.Printf(&quot;Moving to DLQ: %s\n&quot;, msg.ID)
        wp.mq.dlq &lt;- msg
        return
    }
    // Retry with backoff
    delay := time.Duration(1&lt;&lt;msg.Retries) * time.Second
    time.AfterFunc(delay, func() {
        wp.mq.queues[wp.queueName] &lt;- msg
    })
}

func main() {
    mq := NewMessageQueue()

    pool := NewWorkerPool(mq, &quot;orders&quot;, 3, func(msg *Message) error {
        fmt.Printf(&quot;Processing: %v\n&quot;, msg.Payload)
        return nil
    })
    pool.Start()

    for i := 0; i &lt; 10; i++ {
        mq.Send(&quot;orders&quot;, map[string]interface{}{
            &quot;order_id&quot;: i,
            &quot;amount&quot;:   float64(i) * 10.5,
        })
    }

    time.Sleep(2 * time.Second)
}
</code></pre>
    </div>
</div>
<hr />
<h2 id="best-practices-best-practices">Best Practices {#best-practices}</h2>
<div style="background: #f0fdf4; border-radius: 12px; padding: 24px; margin: 20px 0">
<h4 style="color: #166534; margin-top: 0">Production Checklist</h4>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; color: #1e293b">
<div>
<strong style="color: #166534">Reliability</strong>
<ul style="margin: 4px 0 0 0; padding-left: 20px; color: #475569">
<li>Make consumers idempotent</li>
<li>Use dead letter queues</li>
<li>Implement retry with backoff</li>
</ul>
</div>
<div>
<strong style="color: #166534">Performance</strong>
<ul style="margin: 4px 0 0 0; padding-left: 20px; color: #475569">
<li>Use batching for throughput</li>
<li>Set appropriate timeouts</li>
<li>Implement backpressure</li>
</ul>
</div>
<div>
<strong style="color: #166534">Monitoring</strong>
<ul style="margin: 4px 0 0 0; padding-left: 20px; color: #475569">
<li>Track queue depth</li>
<li>Alert on consumer lag</li>
<li>Monitor DLQ size</li>
</ul>
</div>
<div>
<strong style="color: #166534">Operations</strong>
<ul style="margin: 4px 0 0 0; padding-left: 20px; color: #475569">
<li>Plan for replay scenarios</li>
<li>Document message schemas</li>
<li>Version your messages</li>
</ul>
</div>
</div>
</div>
<hr />
<h2 id="related-topics-related-topics">Related Topics {#related-topics}</h2>
<ul>
<li><a href="/topic/system-design/microservices">Microservices</a></li>
<li><a href="/topic/system-design/event-sourcing">Event Sourcing</a></li>
<li><a href="/topic/system-design/rate-limiting">Rate Limiting</a></li>
<li><a href="/topic/system-design/distributed-systems">Distributed Systems</a></li>
</ul>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const headers = document.querySelectorAll('.code-header');
    headers.forEach(header => {
        header.addEventListener('click', function(e) {
            e.preventDefault();
            const container = this.closest('.collapsible-code');
            container.classList.toggle('collapsed');
        });
    });
});
</script>
