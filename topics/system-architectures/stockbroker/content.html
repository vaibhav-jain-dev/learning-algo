<style>
/* Mobile-specific styles for iPhone 15 and similar devices */
@media screen and (max-width: 480px) {
    /* Force all grid layouts to single column */
    [style*="grid-template-columns"] {
        display: block !important;
    }
    [style*="grid-template-columns"] > div {
        margin-bottom: 16px !important;
    }
    /* Adjust padding for mobile */
    [style*="padding: 32px"],
    [style*="padding: 24px"] {
        padding: 16px !important;
    }
    /* Smaller headings */
    h4[style*="font-size: 18px"],
    h4[style*="font-size: 16px"] {
        font-size: 15px !important;
    }
    /* Readable font sizes */
    [style*="font-size: 13px"],
    [style*="font-size: 12px"],
    [style*="font-size: 11px"],
    [style*="font-size: 10px"] {
        font-size: 13px !important;
        line-height: 1.6 !important;
    }
    /* Flex containers stack vertically */
    [style*="display: flex"][style*="gap"] {
        flex-direction: column !important;
    }
    /* Better spacing for nested content */
    [style*="padding-left: 64px"],
    [style*="padding-left: 48px"],
    [style*="padding-left: 40px"] {
        padding-left: 16px !important;
    }
    /* Code blocks */
    pre {
        font-size: 12px !important;
        padding: 12px !important;
        overflow-x: auto !important;
    }
    pre code {
        font-size: 12px !important;
    }
    /* Tables */
    table {
        font-size: 12px !important;
        display: block !important;
        overflow-x: auto !important;
    }
    th, td {
        padding: 8px !important;
        font-size: 12px !important;
    }
}
</style>
<h1 id="design-a-stockbroker-system">Design a Stockbroker System</h1>
<nav class="toc-container" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#problem-statement">Problem Statement</a></li>
<li><a href="#section-1-order-matching-engine">Section 1: Order Matching Engine</a>
<ul>
<li><a href="#matching-core-concept">Core Concept</a></li>
<li><a href="#order-book-data-structure">Order Book Data Structure</a></li>
<li><a href="#matching-implementation">Implementation</a></li>
<li><a href="#matching-edge-cases">Edge Cases in Order Matching</a></li>
<li><a href="#matching-interview-questions">Interview Questions</a></li>
</ul>
</li>
<li><a href="#section-2-market-data-feeds">Section 2: Market Data Feeds</a>
<ul>
<li><a href="#market-data-core-concept">Core Concept</a></li>
<li><a href="#multicast-distribution">Multicast Distribution</a></li>
<li><a href="#handling-packet-loss">Handling Packet Loss</a></li>
<li><a href="#market-data-interview-questions">Interview Questions</a></li>
</ul>
</li>
<li><a href="#section-3-trade-settlement">Section 3: Trade Settlement</a>
<ul>
<li><a href="#settlement-core-concept">Core Concept</a></li>
<li><a href="#settlement-lifecycle">Settlement Lifecycle</a></li>
<li><a href="#settlement-failure-scenarios">Failure Scenarios</a></li>
<li><a href="#settlement-interview-questions">Interview Questions</a></li>
</ul>
</li>
<li><a href="#section-4-latency-optimization">Section 4: Latency Optimization</a>
<ul>
<li><a href="#latency-core-concept">Core Concept</a></li>
<li><a href="#latency-breakdown">Latency Breakdown</a></li>
<li><a href="#optimization-techniques">Optimization Techniques</a></li>
<li><a href="#latency-interview-questions">Interview Questions</a></li>
</ul>
</li>
<li><a href="#section-5-regulatory-compliance">Section 5: Regulatory Compliance</a>
<ul>
<li><a href="#compliance-core-concept">Core Concept</a></li>
<li><a href="#compliance-requirements">Key Requirements</a></li>
<li><a href="#audit-trail-architecture">Audit Trail Architecture</a></li>
<li><a href="#compliance-interview-questions">Interview Questions</a></li>
</ul>
</li>
<li><a href="#edge-cases-failure-modes">Edge Cases &amp; Failure Modes</a></li>
<li><a href="#scaling-strategies">Scaling Strategies</a></li>
<li><a href="#cross-cutting-concerns">Cross-Cutting Concerns</a></li>
<li><a href="#related-topics">Related Topics</a></li>
</ul>
</nav>
<div id="problem-statement" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h2 id="problem-statement">Problem Statement</h2>
<p>Design a real-time electronic trading platform that enables order execution, market data distribution, trade settlement, and regulatory compliance at institutional scale. This system must handle millions of orders daily with sub-millisecond latency while maintaining absolute consistency for financial transactions.</p>
<h3 id="core-technical-challenges">Core Technical Challenges</h3>
<ul>
<li><strong>Order matching</strong> with price-time priority and deterministic execution</li>
<li><strong>Market data distribution</strong> to hundreds of thousands of concurrent subscribers</li>
<li><strong>Trade settlement</strong> with T+1/T+2 cycles and counterparty risk management</li>
<li><strong>Ultra-low latency</strong> execution paths for competitive advantage</li>
<li><strong>Regulatory compliance</strong> with SEC, FINRA, MiFID II audit requirements</li>
</ul>
</div>
<hr />
<h2 id="section-1-order-matching-engine">Section 1: Order Matching Engine</h2>
<div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px; padding: 32px; margin: 20px 0">
<h3 id="matching-core-concept">Core Concept: The Heart of Every Exchange</h3>
<p>The order matching engine is the central component that receives orders, maintains the order book, and executes trades when buy and sell orders cross. It must be <strong>deterministic</strong> (same inputs always produce same outputs), <strong>fair</strong> (first-in-first-out at each price level), and <strong>fast</strong> (sub-microsecond for competitive exchanges).</p>
<div style="background: rgba(248, 81, 73, 0.1);border-radius: 12px; padding: 20px; margin: 20px 0">
<h4 id="assumption-price-time-priority">Assumption: Price-Time Priority</h4>
<p>The matching engine assumes <strong>price-time priority</strong> (also called FIFO): orders are matched first by best price, then by arrival time at that price level. This is the standard for most regulated exchanges, but alternative models exist (pro-rata for options, size-time for some dark pools).</p>
<p><strong>Trade-off</strong>: Price-time priority rewards speed, creating an &quot;arms race&quot; for lower latency. This benefits sophisticated traders but may disadvantage retail investors.</p>
</div>
<h3 id="order-book-data-structure">Internal Mechanism: Order Book Data Structure</h3>
<div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 24px; margin: 20px 0">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px">
<div style="background: rgba(126, 231, 135, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #7ee787; font-weight: 700; text-align: center; margin-bottom: 16px">BID SIDE (Buyers)</div>
<div style="font-family: monospace; font-size: 13px; color: #475569">
<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(126, 231, 135, 0.2); border-radius: 4px; margin-bottom: 4px">
<span>$182.50</span><span>15,000 shares</span><span style="color: #7ee787">Best Bid</span>
</div>
<div style="display: flex; justify-content: space-between; padding: 8px; margin-bottom: 4px">
<span>$182.45</span><span>8,200 shares</span><span style="color: #8b949e">Level 2</span>
</div>
<div style="display: flex; justify-content: space-between; padding: 8px; margin-bottom: 4px">
<span>$182.40</span><span>25,100 shares</span><span style="color: #8b949e">Level 3</span>
</div>
<div style="display: flex; justify-content: space-between; padding: 8px">
<span>$182.35</span><span>12,000 shares</span><span style="color: #8b949e">Level 4</span>
</div>
</div>
<div style="color: #8b949e; font-size: 12px; margin-top: 12px; text-align: center">Sorted DESC by price</div>
</div>
<div style="background: rgba(248, 81, 73, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #f85149; font-weight: 700; text-align: center; margin-bottom: 16px">ASK SIDE (Sellers)</div>
<div style="font-family: monospace; font-size: 13px; color: #475569">
<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(248, 81, 73, 0.2); border-radius: 4px; margin-bottom: 4px">
<span>$182.55</span><span>10,500 shares</span><span style="color: #f85149">Best Ask</span>
</div>
<div style="display: flex; justify-content: space-between; padding: 8px; margin-bottom: 4px">
<span>$182.60</span><span>20,300 shares</span><span style="color: #8b949e">Level 2</span>
</div>
<div style="display: flex; justify-content: space-between; padding: 8px; margin-bottom: 4px">
<span>$182.65</span><span>5,800 shares</span><span style="color: #8b949e">Level 3</span>
</div>
<div style="display: flex; justify-content: space-between; padding: 8px">
<span>$182.70</span><span>18,200 shares</span><span style="color: #8b949e">Level 4</span>
</div>
</div>
<div style="color: #8b949e; font-size: 12px; margin-top: 12px; text-align: center">Sorted ASC by price</div>
</div>
</div>
<div style="text-align: center; margin-top: 20px; padding: 16px; background: rgba(137, 87, 229, 0.1); border-radius: 8px">
<span style="color: #a371f7; font-weight: 600">Spread: $0.05 (Best Ask - Best Bid)</span>
</div>
</div>
<h3 id="matching-implementation">Implementation: Optimal Data Structures</h3>
<p>The choice of data structure directly impacts matching latency. See <a href="/topics/data-structures">[data-structures]</a> for fundamentals.</p>
<div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 20px 0">
<p><strong>For each price level:</strong></p>
<ul>
<li><strong>Red-Black Tree / AVL Tree</strong>: O(log n) insert, delete, lookup for price levels</li>
<li>At each node: <strong>Doubly-linked list</strong> of orders (FIFO queue) for time priority</li>
</ul>
<p><strong>Why not a hash map?</strong><br />
We need <strong>sorted iteration</strong> to find best bid/ask and to match across multiple price levels. Hash maps are O(n) for finding minimum/maximum.</p>
<p><strong>Why not a sorted array?</strong><br />
Insert/delete is O(n) due to shifting elements. With 10,000 price levels and 100,000 operations/second, this becomes a bottleneck.</p>
<pre><code class="language-python"># Conceptual structure (not production code)
class OrderBook:
    def __init__(self):
        self.bids = RedBlackTree()  # Key: -price (negative for DESC sort)
        self.asks = RedBlackTree()  # Key: price (ASC sort)

    def add_order(self, order):
        tree = self.bids if order.side == BUY else self.asks
        price_level = tree.get_or_create(order.price)
        price_level.queue.append(order)  # O(1) append to linked list

    def match(self):
        while self.bids.max() and self.asks.min():
            best_bid = self.bids.max()
            best_ask = self.asks.min()
            if best_bid.price &gt;= best_ask.price:
                execute_trade(best_bid.queue[0], best_ask.queue[0])
            else:
                break  # No crossing orders
</code></pre>
</div>
<div style="background: rgba(240, 136, 62, 0.1);border-radius: 12px; padding: 20px; margin: 20px 0">
<h4 id="design-choice-in-memory-vs-persistent-order-book">Design Choice: In-Memory vs Persistent Order Book</h4>
<p><strong>Production systems keep the order book entirely in memory</strong> for two reasons:</p>
<ol>
<li><strong>Latency</strong>: Memory access is ~100ns, SSD is ~100,000ns, spinning disk is ~10,000,000ns</li>
<li><strong>Volatility</strong>: Orders are cancelled or filled within seconds; persisting each state change would overwhelm any storage system</li>
</ol>
<p><strong>Durability is achieved through <a href="/topics/system-design/event-sourcing">[event-sourcing]</a></strong>: Every order add/cancel/modify is logged to a <a href="/topics/databases/wal">[write-ahead-log]</a> (WAL). On restart, replay the log to rebuild order book state.</p>
</div>
<h3 id="matching-edge-cases">Edge Cases in Order Matching</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 20px 0">
<div style="background: rgba(248, 81, 73, 0.1);border-radius: 12px; padding: 16px">
<div style="color: #f85149; font-weight: 600; margin-bottom: 8px">Self-Trade Prevention</div>
<div style="color: #8b949e; font-size: 13px">When the same firm has orders on both sides that would match, the system must prevent this (wash trading is illegal). Options: cancel newest order, cancel oldest order, or cancel both.</div>
</div>
<div style="background: rgba(126, 231, 135, 0.1);border-radius: 12px; padding: 16px">
<div style="color: #7ee787; font-weight: 600; margin-bottom: 8px">Odd Lot Handling</div>
<div style="color: #8b949e; font-size: 13px">Orders below the standard lot size (typically 100 shares) may have different matching priority. Some exchanges don't display them in the public order book.</div>
</div>
<div style="background: rgba(137, 87, 229, 0.1);border-radius: 12px; padding: 16px">
<div style="color: #a371f7; font-weight: 600; margin-bottom: 8px">Minimum Execution Quantity</div>
<div style="color: #8b949e; font-size: 13px">Some orders specify "fill at least 500 shares or nothing." The engine must check if sufficient liquidity exists before partially filling.</div>
</div>
<div style="background: rgba(88, 166, 255, 0.1);border-radius: 12px; padding: 16px">
<div style="color: #58a6ff; font-weight: 600; margin-bottom: 8px">Price Improvement</div>
<div style="color: #8b949e; font-size: 13px">A market buy order might get filled at a better price than expected if a new sell order arrives at a lower price during processing. Must handle atomically.</div>
</div>
</div>
<h3 id="matching-interview-questions">3-Level Recursive Interview Questions: Matching Engine</h3>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="level-1-how-does-an-order-matching-engine-work">Level 1: &quot;How does an order matching engine work?&quot;</h4>
<p><strong>Expected Answer</strong>: The matching engine maintains an order book with bids sorted descending by price and asks sorted ascending. When a new order arrives, it checks if the order can match (buy price &gt;= best ask, or sell price &lt;= best bid). If so, it executes trades at the passive order's price, removing filled orders from the book. Unmatched portions are added to the book.</p>
<div style="background: rgba(88, 166, 255, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h5 id="level-2-what-happens-when-a-market-order-arrives-that-exceeds-available-liquidity">Level 2: &quot;What happens when a market order arrives that exceeds available liquidity?&quot;</h5>
<p><strong>Expected Answer</strong>: The order &quot;walks the book,&quot; filling against multiple price levels until either:</p>
<ol>
<li>The order is completely filled</li>
<li>The book is exhausted (no more contra-side orders)</li>
<li>A price limit is reached (some market orders have hidden price collars)</li>
</ol>
<p>For case 2, the remaining quantity is typically cancelled (not added to book, since it has no price). This can cause significant price impact during low liquidity periods.</p>
<div style="background: rgba(137, 87, 229, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h6 id="level-3-how-do-you-prevent-a-single-large-market-order-from-crashing-the-price">Level 3: &quot;How do you prevent a single large market order from crashing the price?&quot;</h6>
<p><strong>Expected Answer</strong>: Multiple mechanisms:</p>
<ol>
<li><strong>Circuit breakers</strong>: Halt trading if price moves &gt;X% in Y minutes (see <a href="/topics/system-design/circuit-breaker">[circuit-breakers]</a>)</li>
<li><strong>Limit-up/Limit-down (LULD)</strong>: Orders outside price bands are rejected</li>
<li><strong>Volatility auctions</strong>: Switch from continuous matching to periodic auction mode</li>
<li><strong>Order collars</strong>: Silently convert market orders to limit orders at X% from last trade</li>
</ol>
<p><strong>Real-world example</strong>: The May 6, 2010 &quot;Flash Crash&quot; caused Accenture to trade at $0.01 because market orders exhausted the book. This led to SEC Rule 201 (circuit breakers) and LULD implementation.</p>
</div>
</div>
</div>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="level-1-why-use-a-red-black-tree-instead-of-other-data-structures">Level 1: &quot;Why use a Red-Black tree instead of other data structures?&quot;</h4>
<p><strong>Expected Answer</strong>: Red-Black trees provide O(log n) insert, delete, and lookup while maintaining sorted order. We need sorted order to find best bid/ask (O(1) with pointer to min/max) and to iterate through price levels during matching.</p>
<div style="background: rgba(88, 166, 255, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h5 id="level-2-nasdaqs-matching-engine-reportedly-achieves-sub-microsecond-latency-how-is-that-possible-with-olog-n-operations">Level 2: &quot;NASDAQ's matching engine reportedly achieves sub-microsecond latency. How is that possible with O(log n) operations?&quot;</h5>
<p><strong>Expected Answer</strong>: Several optimizations:</p>
<ol>
<li><strong>Fixed price levels</strong>: For heavily traded symbols, pre-allocate array slots for each tick (e.g., $0.01 increments from $0-$10,000). This converts O(log n) tree lookup to O(1) array index.</li>
<li><strong>LMAX Disruptor pattern</strong>: Lock-free ring buffer with single-writer principle eliminates mutex overhead</li>
<li><strong>Kernel bypass</strong>: DPDK or RDMA to receive network packets directly in user space</li>
<li><strong>CPU pinning</strong>: Dedicate specific CPU cores to matching thread, disable hyperthreading</li>
</ol>
<div style="background: rgba(137, 87, 229, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h6 id="level-3-what-is-mechanical-sympathy-and-how-does-it-apply-to-matching-engine-design">Level 3: &quot;What is 'mechanical sympathy' and how does it apply to matching engine design?&quot;</h6>
<p><strong>Expected Answer</strong>: Mechanical sympathy means designing software that works harmoniously with hardware characteristics:</p>
<ol>
<li><strong>Cache line alignment</strong>: Order structs are 64 bytes (one cache line) to prevent false sharing</li>
<li><strong>Sequential access</strong>: Process orders in ring buffer order; CPU prefetcher predicts next access</li>
<li><strong>Branch prediction</strong>: Matching logic has predictable branches; avoid data-dependent conditionals</li>
<li><strong>Memory allocation</strong>: Pre-allocate all memory at startup; avoid malloc/free during trading</li>
<li><strong>NUMA awareness</strong>: Keep data on same NUMA node as processing thread</li>
</ol>
<p><strong>Concrete impact</strong>: A cache miss costs ~100 cycles. At 3GHz, that's 33ns per miss. With 100K orders/second, cache misses alone could add 3.3 seconds of cumulative delay per second if not optimized.</p>
</div>
</div>
</div>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="level-1-how-do-you-handle-matching-engine-failures">Level 1: &quot;How do you handle matching engine failures?&quot;</h4>
<p><strong>Expected Answer</strong>: Use <a href="/topics/system-design/event-sourcing">[event-sourcing]</a> where every order is written to a durable log before acknowledgment. On failure, a standby engine replays the log to rebuild state. Failover typically takes 1-5 seconds.</p>
<div style="background: rgba(88, 166, 255, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h5 id="level-2-what-is-the-consistency-model-during-failover-can-orders-be-lost-or-duplicated">Level 2: &quot;What is the consistency model during failover? Can orders be lost or duplicated?&quot;</h5>
<p><strong>Expected Answer</strong>:</p>
<p><strong>Lost orders</strong>: Possible if using async replication. Solution: Synchronous replication to standby before acknowledging to client (increases latency by ~1ms but guarantees durability).</p>
<p><strong>Duplicate execution</strong>: Prevented through idempotency keys. Each order has a unique ID; before processing, check if this ID was already processed. Use a bloom filter for fast negative lookups, with full database check on positive hits.</p>
<div style="background: rgba(137, 87, 229, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h6 id="level-3-how-does-your-matching-engine-maintain-deterministic-ordering-across-failover-when-orders-arrive-from-multiple-network-paths">Level 3: &quot;How does your matching engine maintain deterministic ordering across failover when orders arrive from multiple network paths?&quot;</h6>
<p><strong>Expected Answer</strong>: This is the <strong>sequence number gap</strong> problem. Solution:</p>
<ol>
<li><strong>Gateway sequencer</strong>: Single point that assigns global sequence numbers to all orders before forwarding to matching engine</li>
<li><strong>Lamport timestamps</strong>: Logical clocks that establish happened-before relationship</li>
<li><strong>Hybrid approach</strong>: Use wall-clock time as primary sort, sequence number as tiebreaker</li>
</ol>
<p><strong>Critical insight</strong>: The gateway sequencer becomes a single point of failure. Use <a href="/topics/system-design/raft-consensus">[Raft]</a> or <a href="/topics/system-design/paxos">[Paxos]</a> for leader election with sub-second failover. Accept that during leader election (~500ms), no new orders can be accepted.</p>
<p><strong>Trade-off accepted</strong>: Brief unavailability is acceptable; inconsistent matching is not. This is a CP system in <a href="/topics/system-design/cap-theorem">[CAP theorem]</a> terms.</p>
</div>
</div>
</div>
</div>
<hr />
<h2 id="section-2-market-data-feeds">Section 2: Market Data Feeds</h2>
<div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px; padding: 32px; margin: 20px 0">
<h3 id="market-data-core-concept">Core Concept: Publishing Price Information</h3>
<p>Market data feeds distribute real-time price information to subscribers. This includes:</p>
<ul>
<li><strong>Level 1 (L1)</strong>: Best bid, best ask, last trade price</li>
<li><strong>Level 2 (L2)</strong>: Top N price levels with aggregate quantities</li>
<li><strong>Level 3 (L3)</strong>: Full order book with individual order details</li>
</ul>
<div style="background: rgba(137, 87, 229, 0.1);border-radius: 12px; padding: 20px; margin: 20px 0">
<h4 id="assumption-eventual-consistency-is-acceptable">Assumption: Eventual Consistency is Acceptable</h4>
<p>Unlike order execution (which requires strong consistency), market data display can tolerate brief inconsistency. If a user sees a price that's 50ms stale, it's acceptable. This assumption enables aggressive caching and <a href="/topics/system-design/eventual-consistency">[eventual-consistency]</a> patterns.</p>
<p><strong>Trade-off</strong>: Traders may submit orders based on stale prices, leading to rejections or unexpected fills. Mitigated by requiring limit prices on all orders.</p>
</div>
<h3 id="multicast-distribution">Internal Mechanism: Multicast Distribution</h3>
<div class="diagram-container" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 24px; margin: 20px 0">
<div class="flow-diagram">
<div class="flow-row">
<div class="flow-box error" style="min-width: 150px">
<div class="flow-box-title">Matching Engine</div>
<div class="flow-box-subtitle">Trade Events</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box purple" style="min-width: 180px">
<div class="flow-box-title">Market Data Gateway</div>
<div class="flow-box-subtitle">Normalizes, sequences</div>
</div>
</div>
<div class="flow-row">
<div class="flow-arrow vertical">&#8595;</div>
</div>
<div class="flow-row">
<div class="flow-box primary" style="min-width: 200px">
<div class="flow-box-title">UDP Multicast</div>
<div class="flow-box-subtitle">239.255.0.0/16</div>
</div>
</div>
<div class="flow-row">
<div class="flow-arrow">&#8601;</div>
<div class="flow-arrow vertical">&#8595;</div>
<div class="flow-arrow">&#8600;</div>
</div>
<div class="flow-row">
<div class="flow-box success" style="min-width: 120px">
<div class="flow-box-title">Subscriber 1</div>
<div class="flow-box-subtitle">HFT Firm</div>
</div>
<div class="flow-box info" style="min-width: 120px">
<div class="flow-box-title">Subscriber 2</div>
<div class="flow-box-subtitle">Retail Broker</div>
</div>
<div class="flow-box warning" style="min-width: 120px">
<div class="flow-box-title">Subscriber 3</div>
<div class="flow-box-subtitle">Data Vendor</div>
</div>
</div>
</div>
</div>
<div style="background: rgba(240, 136, 62, 0.1);border-radius: 12px; padding: 20px; margin: 20px 0">
<h4 id="design-choice-udp-multicast-vs-websocket">Design Choice: UDP Multicast vs WebSocket</h4>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>UDP Multicast</th>
<th>WebSocket</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Latency</strong></td>
<td>~10 microseconds</td>
<td>~1-10 milliseconds</td>
</tr>
<tr>
<td><strong>Scalability</strong></td>
<td>1 packet serves unlimited subscribers</td>
<td>1 connection per subscriber</td>
</tr>
<tr>
<td><strong>Reliability</strong></td>
<td>None (must implement own)</td>
<td>TCP guarantees delivery</td>
</tr>
<tr>
<td><strong>Use case</strong></td>
<td>Co-located HFT firms</td>
<td>Retail web clients</td>
</tr>
</tbody>
</table>
<p><strong>Production systems use both</strong>: UDP multicast for professional traders in the same data center, WebSocket (via <a href="/topics/system-design/api-gateway">[api-gateway]</a>) for retail clients over the internet.</p>
</div>
<h3 id="handling-packet-loss">Handling Packet Loss in UDP Feeds</h3>
<p>UDP is unreliable by design. Market data systems implement their own reliability layer:</p>
<div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 20px 0">
<pre><code class="language-python">class MarketDataReceiver:
    def __init__(self):
        self.expected_seq = 0
        self.buffer = {}  # Out-of-order buffer
        self.gap_start = None

    def on_packet(self, packet):
        if packet.seq == self.expected_seq:
            self.process(packet)
            self.expected_seq += 1
            self.drain_buffer()
        elif packet.seq &gt; self.expected_seq:
            # Gap detected - buffer this packet
            self.buffer[packet.seq] = packet
            if not self.gap_start:
                self.gap_start = time.now()
                self.request_retransmit(self.expected_seq, packet.seq - 1)
        # packet.seq &lt; expected_seq: duplicate, ignore

    def drain_buffer(self):
        while self.expected_seq in self.buffer:
            self.process(self.buffer.pop(self.expected_seq))
            self.expected_seq += 1
        if not self.buffer:
            self.gap_start = None
</code></pre>
<p><strong>Gap recovery</strong>: Subscriber sends unicast request to exchange for missing sequence numbers. Exchange maintains a <strong>retransmission buffer</strong> (typically 30-60 seconds of messages).</p>
</div>
<h3 id="market-data-interview-questions">3-Level Recursive Interview Questions: Market Data</h3>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="level-1-how-would-you-design-a-system-to-distribute-market-data-to-100000-concurrent-users">Level 1: &quot;How would you design a system to distribute market data to 100,000 concurrent users?&quot;</h4>
<p><strong>Expected Answer</strong>: Use a tiered architecture. Matching engine publishes to market data gateway. Gateway fans out via UDP multicast for co-located clients and Kafka for geographic distribution. Regional servers subscribe to Kafka and maintain WebSocket connections to end users. Use <a href="/topics/system-design/pub-sub">[pub-sub]</a> pattern.</p>
<div style="background: rgba(88, 166, 255, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h5 id="level-2-what-happens-during-a-market-open-when-every-stocks-price-updates-simultaneously">Level 2: &quot;What happens during a market open when every stock's price updates simultaneously?&quot;</h5>
<p><strong>Expected Answer</strong>: This is the <strong>thundering herd</strong> problem. At 9:30 AM market open:</p>
<ul>
<li>~8,000 stocks have opening auctions</li>
<li>Each produces 10-100 messages (trades, quote updates)</li>
<li>Total: 800,000+ messages in the first second</li>
</ul>
<p><strong>Solutions</strong>:</p>
<ol>
<li><strong>Batching</strong>: Aggregate multiple updates into single network packet (up to MTU ~1500 bytes)</li>
<li><strong>Conflation</strong>: If symbol updates twice before subscriber processes first update, send only latest</li>
<li><strong>Subscription filtering</strong>: Client subscribes only to symbols they care about; server filters at source</li>
<li><strong>Throttling</strong>: Rate limit per-subscriber updates (e.g., 10 updates/second for retail)</li>
</ol>
<div style="background: rgba(137, 87, 229, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h6 id="level-3-how-do-you-ensure-market-data-fairness-when-some-subscribers-are-faster-than-others">Level 3: &quot;How do you ensure market data fairness when some subscribers are faster than others?&quot;</h6>
<p><strong>Expected Answer</strong>: This is a regulatory requirement (SEC Regulation NMS, MiFID II). Solutions:</p>
<ol>
<li><strong>Intentional latency (speed bumps)</strong>: IEX adds 350 microsecond delay to all orders, negating speed advantages</li>
<li><strong>Synchronized release</strong>: Hold messages until wall-clock time X, then release simultaneously</li>
<li><strong>Randomized delays</strong>: Add random 0-100 microsecond delay to prevent systematic advantage</li>
<li><strong>Physical distance parity</strong>: Ensure all co-located cabinets have equal cable length to exchange</li>
</ol>
<p><strong>The ethical dilemma</strong>: Exchanges profit from selling co-location and low-latency feeds to HFT firms. Strict fairness would eliminate this revenue. Regulators have allowed &quot;fair access&quot; (everyone CAN buy the fast feed) rather than &quot;equal access&quot; (everyone gets the same speed).</p>
</div>
</div>
</div>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="level-1-why-do-exchanges-charge-for-market-data">Level 1: &quot;Why do exchanges charge for market data?&quot;</h4>
<p><strong>Expected Answer</strong>: Market data is a significant revenue source. NYSE made $533M in market data revenue in 2022. They charge for access (connection fees), bandwidth (messages/second), and depth (L1 vs L2 vs L3). This creates a tiered system where professional traders pay more.</p>
<div style="background: rgba(88, 166, 255, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h5 id="level-2-how-does-the-consolidated-tape-sip-work-and-why-does-it-exist">Level 2: &quot;How does the consolidated tape (SIP) work and why does it exist?&quot;</h5>
<p><strong>Expected Answer</strong>: A stock like AAPL trades on 16+ exchanges simultaneously. The Securities Information Processor (SIP) consolidates quotes from all exchanges into a single feed showing the National Best Bid and Offer (NBBO).</p>
<p><strong>Why it exists</strong>: Regulation NMS requires brokers to execute at the best price across ALL exchanges. Without SIP, each broker would need direct feeds from all 16 exchanges.</p>
<p><strong>Latency implication</strong>: SIP adds ~500 microseconds of latency. HFT firms subscribe to all direct feeds AND the SIP, using the direct feeds for trading and SIP for compliance documentation.</p>
<div style="background: rgba(137, 87, 229, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h6 id="level-3-what-is-latency-arbitrage-and-how-do-market-data-delays-enable-it">Level 3: &quot;What is latency arbitrage and how do market data delays enable it?&quot;</h6>
<p><strong>Expected Answer</strong>: Latency arbitrage exploits the time difference between when a price change occurs and when different participants learn about it.</p>
<p><strong>Example</strong>:</p>
<ul>
<li>10:00:00.000000: AAPL bid on NYSE changes from $182.50 to $182.55</li>
<li>10:00:00.000050: HFT firm sees this via direct feed</li>
<li>10:00:00.000500: SIP reflects the change</li>
<li>10:00:00.000500: Retail broker sees new price</li>
</ul>
<p>During that 450-microsecond window, the HFT firm can:</p>
<ol>
<li>Buy at $182.50 on NASDAQ (which hasn't updated yet)</li>
<li>Immediately sell at $182.55 on NYSE</li>
<li>Profit: $0.05/share, risk-free</li>
</ol>
<p><strong>Scale</strong>: With millions of such opportunities daily, this adds up to significant profits extracted from slower participants. Critics call it a &quot;tax&quot; on retail investors.</p>
</div>
</div>
</div>
</div>
<hr />
<h2 id="section-3-trade-settlement">Section 3: Trade Settlement</h2>
<div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px; padding: 32px; margin: 20px 0">
<h3 id="settlement-core-concept">Core Concept: From Trade to Transfer</h3>
<p>Settlement is the process of transferring ownership of securities and cash between buyer and seller after a trade executes. In the US, equities settle T+1 (trade date plus one business day). This delay exists for operational and risk management reasons.</p>
<div style="background: rgba(248, 81, 73, 0.1);border-radius: 12px; padding: 20px; margin: 20px 0">
<h4 id="assumption-central-counterparty-ccp-clearing">Assumption: Central Counterparty (CCP) Clearing</h4>
<p>Modern settlement assumes a central clearing house (like DTCC in the US) acts as counterparty to both sides of every trade. Buyer sees CCP as seller; seller sees CCP as buyer. This <strong>novation</strong> eliminates bilateral counterparty risk.</p>
<p><strong>Trade-off</strong>: CCP concentration creates systemic risk. If the CCP fails, the entire market freezes. Mitigated through massive capital requirements and government backing.</p>
</div>
<h3 id="settlement-lifecycle">Internal Mechanism: Settlement Lifecycle</h3>
<div class="diagram-container" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 24px; margin: 20px 0">
<div class="flow-diagram">
<div class="flow-row" style="width: 100%">
<div class="flow-box success" style="min-width: 80px">
<div class="flow-box-title">T</div>
</div>
<div style="flex: 1; background: rgba(16, 185, 129, 0.15); border-radius: 8px; padding: 12px; margin-left: 16px">
<div style="color: #10b981; font-weight: 600">Trade Execution</div>
<div style="color: #8b949e; font-size: 13px">Matching engine executes trade. Both parties receive execution report. Trade is "locked in" but not yet settled.</div>
</div>
</div>
<div class="flow-row" style="width: 100%">
<div class="flow-box info" style="min-width: 80px">
<div class="flow-box-title">T+0</div>
</div>
<div style="flex: 1; background: rgba(59, 130, 246, 0.15); border-radius: 8px; padding: 12px; margin-left: 16px">
<div style="color: #3b82f6; font-weight: 600">Trade Capture & Matching</div>
<div style="color: #8b949e; font-size: 13px">Both brokers submit trade details to clearing house. System validates both sides agree on terms (symbol, quantity, price).</div>
</div>
</div>
<div class="flow-row" style="width: 100%">
<div class="flow-box purple" style="min-width: 80px">
<div class="flow-box-title">T+0</div>
</div>
<div style="flex: 1; background: rgba(139, 92, 246, 0.15); border-radius: 8px; padding: 12px; margin-left: 16px">
<div style="color: #8b5cf6; font-weight: 600">Novation</div>
<div style="color: #8b949e; font-size: 13px">CCP becomes counterparty. Original trade (Broker A to Broker B) becomes two trades: (Broker A to CCP) and (CCP to Broker B).</div>
</div>
</div>
<div class="flow-row" style="width: 100%">
<div class="flow-box warning" style="min-width: 80px">
<div class="flow-box-title">T+0</div>
</div>
<div style="flex: 1; background: rgba(245, 158, 11, 0.15); border-radius: 8px; padding: 12px; margin-left: 16px">
<div style="color: #f59e0b; font-weight: 600">Netting</div>
<div style="color: #8b949e; font-size: 13px">If Broker A bought 1000 AAPL and sold 800 AAPL today, net obligation is receive 200 AAPL. Reduces settlement volume by ~98%.</div>
</div>
</div>
<div class="flow-row" style="width: 100%">
<div class="flow-box error" style="min-width: 80px">
<div class="flow-box-title">T+1</div>
</div>
<div style="flex: 1; background: rgba(239, 68, 68, 0.15); border-radius: 8px; padding: 12px; margin-left: 16px">
<div style="color: #ef4444; font-weight: 600">Settlement (DVP)</div>
<div style="color: #8b949e; font-size: 13px">Delivery vs Payment: Securities and cash move simultaneously. Buyer's account credited with shares, debited cash. This is the moment of legal ownership transfer.</div>
</div>
</div>
</div>
</div>
<div style="background: rgba(240, 136, 62, 0.1);border-radius: 12px; padding: 20px; margin: 20px 0">
<h4 id="design-choice-why-not-settle-instantly">Design Choice: Why Not Settle Instantly?</h4>
<p>Theoretically, blockchain-based systems could enable T+0 settlement. Why doesn't the industry adopt this?</p>
<ol>
<li><strong>Netting efficiency</strong>: T+1 allows end-of-day netting, reducing actual transfers by 98%. Instant settlement means every trade moves full amounts.</li>
<li><strong>Funding requirements</strong>: Brokers need cash/securities on hand before trade, not after. This requires 10x more capital.</li>
<li><strong>Error correction</strong>: 24-hour window allows catching and fixing errors before finality</li>
<li><strong>Time zone differences</strong>: Global participants need time to fund accounts from different banking systems</li>
<li><strong>Legacy integration</strong>: 50+ years of infrastructure assumes T+1; changing would require coordinated global effort</li>
</ol>
</div>
<h3 id="settlement-failure-scenarios">Failure Scenarios in Settlement</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 20px 0">
<div style="background: rgba(248, 81, 73, 0.1);border-radius: 12px; padding: 16px">
<div style="color: #f85149; font-weight: 600; margin-bottom: 8px">Fail to Deliver (FTD)</div>
<div style="color: #8b949e; font-size: 13px">Seller doesn't have securities to deliver. CCP may: (1) buy shares in market and charge seller, (2) defer settlement with penalty interest, (3) initiate buy-in procedure forcing delivery.</div>
</div>
<div style="background: rgba(126, 231, 135, 0.1);border-radius: 12px; padding: 16px">
<div style="color: #7ee787; font-weight: 600; margin-bottom: 8px">Fail to Pay</div>
<div style="color: #8b949e; font-size: 13px">Buyer doesn't have cash. Similar remedies apply. CCP's guarantee fund covers shortfall initially; defaulting party pays penalties and may lose membership.</div>
</div>
<div style="background: rgba(137, 87, 229, 0.1);border-radius: 12px; padding: 16px">
<div style="color: #a371f7; font-weight: 600; margin-bottom: 8px">Corporate Action During Settlement</div>
<div style="color: #8b949e; font-size: 13px">Stock splits or dividends between trade and settlement dates create complexity. "Ex-date" rules determine who receives the benefit.</div>
</div>
<div style="background: rgba(88, 166, 255, 0.1);border-radius: 12px; padding: 16px">
<div style="color: #58a6ff; font-weight: 600; margin-bottom: 8px">Broker Default</div>
<div style="color: #8b949e; font-size: 13px">If a broker becomes insolvent mid-settlement, customer assets are protected (SIPC insurance up to $500K), but settlement may be delayed while positions are transferred to another broker.</div>
</div>
</div>
<h3 id="settlement-interview-questions">3-Level Recursive Interview Questions: Settlement</h3>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="level-1-what-is-t1-settlement-and-why-does-it-exist">Level 1: &quot;What is T+1 settlement and why does it exist?&quot;</h4>
<p><strong>Expected Answer</strong>: T+1 means trades settle one business day after execution. It exists to allow time for trade matching, netting, error correction, and funding. The industry recently moved from T+2 to T+1 (May 2024 in US) to reduce counterparty risk.</p>
<div style="background: rgba(88, 166, 255, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h5 id="level-2-how-does-netting-reduce-settlement-risk-and-whats-the-efficiency-gain">Level 2: &quot;How does netting reduce settlement risk and what's the efficiency gain?&quot;</h5>
<p><strong>Expected Answer</strong>: Netting offsets opposing obligations. Example:</p>
<ul>
<li>Broker trades 10M shares total in a day</li>
<li>After netting: only 200K shares actually need to move</li>
<li>Efficiency: 98% reduction in settlement volume</li>
</ul>
<p><strong>Types of netting</strong>:</p>
<ol>
<li><strong>Bilateral</strong>: Between two specific parties</li>
<li><strong>Multilateral</strong>: Across all participants via CCP</li>
<li><strong>Payment netting</strong>: Only net cash flows</li>
<li><strong>Close-out netting</strong>: In default scenarios, all positions reduced to single payment</li>
</ol>
<p>Risk reduction: Instead of $10M in gross exposure, only $200K in net exposure needs collateralization.</p>
<div style="background: rgba(137, 87, 229, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h6 id="level-3-what-happens-to-pending-settlements-if-a-major-broker-defaults">Level 3: &quot;What happens to pending settlements if a major broker defaults?&quot;</h6>
<p><strong>Expected Answer</strong>: This is the <strong>Lehman moment</strong> scenario. CCP has multiple layers of protection:</p>
<ol>
<li><strong>Defaulter's margin</strong>: Collateral already posted by the failing member</li>
<li><strong>Defaulter's guarantee fund contribution</strong>: Pre-funded loss absorption</li>
<li><strong>CCP's own capital</strong>: &quot;Skin in the game&quot;</li>
<li><strong>Non-defaulting members' guarantee fund</strong>: Mutualized loss sharing</li>
<li><strong>Additional assessments</strong>: CCP can demand more from surviving members</li>
<li><strong>Central bank support</strong>: In extreme scenarios, government backstop</li>
</ol>
<p><strong>Real example</strong>: When Lehman Brothers failed in 2008, LCH.Clearnet (the CCP) managed to close out $9 trillion in positions within 3 weeks using these mechanisms. No non-defaulting member lost money.</p>
<p><strong>The systemic risk concern</strong>: All risk concentrates in CCPs. If a CCP fails, the entire financial system locks up. This is why CCPs are designated as &quot;Systemically Important Financial Market Utilities&quot; and subject to enhanced regulation.</p>
</div>
</div>
</div>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="level-1-what-is-dvp-and-why-is-it-important">Level 1: &quot;What is DVP and why is it important?&quot;</h4>
<p><strong>Expected Answer</strong>: Delivery versus Payment (DVP) means securities and cash move simultaneously and conditionally. Neither party is exposed to the risk of delivering their side without receiving the other. This is the fundamental principle preventing settlement failures.</p>
<div style="background: rgba(88, 166, 255, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h5 id="level-2-how-would-you-implement-dvp-in-a-distributed-system">Level 2: &quot;How would you implement DVP in a distributed system?&quot;</h5>
<p><strong>Expected Answer</strong>: This is a <a href="/topics/system-design/2pc">[two-phase commit]</a> problem:</p>
<p><strong>Phase 1 (Prepare)</strong>:</p>
<ul>
<li>Lock buyer's cash account (verify funds, prevent withdrawal)</li>
<li>Lock seller's security account (verify shares, prevent transfer)</li>
<li>Both systems respond &quot;ready&quot; or &quot;abort&quot;</li>
</ul>
<p><strong>Phase 2 (Commit)</strong>:</p>
<ul>
<li>If both ready: execute both transfers atomically</li>
<li>If either aborts: release both locks, transaction fails</li>
</ul>
<p><strong>Challenge</strong>: Cross-system atomicity. Cash might be at one bank, securities at another depository. Solution: Use a trusted coordinator (the CCP) that has authority over both systems.</p>
<div style="background: rgba(137, 87, 229, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h6 id="level-3-what-are-the-cap-theorem-implications-for-settlement-systems">Level 3: &quot;What are the CAP theorem implications for settlement systems?&quot;</h6>
<p><strong>Expected Answer</strong>: Settlement systems are <strong>CP</strong> (Consistent, Partition-tolerant, sacrificing Availability):</p>
<p><strong>Consistency is non-negotiable</strong>: Double-spending or phantom securities would destroy market integrity. Every participant must see the same state.</p>
<p><strong>Availability is sacrificed</strong>: If connectivity to the CCP is lost, new settlements cannot occur. This is acceptable because:</p>
<ol>
<li>Settlement happens in batch windows, not real-time</li>
<li>Brief delays (minutes to hours) don't affect already-executed trades</li>
<li>Human operators can intervene during extended outages</li>
</ol>
<p><strong>Partition handling</strong>: During network partition, the system halts rather than risking inconsistency. This is why settlement has fixed &quot;cutoff times&quot; - the window is defined, and anything outside the window waits for the next day.</p>
<p><strong>Alternative view</strong>: Some argue settlement should be <strong>AP</strong> during the day (allow optimistic settlement) and reconcile to <strong>CP</strong> at end of day. This increases throughput but requires robust error correction.</p>
</div>
</div>
</div>
</div>
<hr />
<h2 id="section-4-latency-optimization">Section 4: Latency Optimization</h2>
<div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px; padding: 32px; margin: 20px 0">
<h3 id="latency-core-concept">Core Concept: The Speed Arms Race</h3>
<p>In electronic trading, latency directly translates to profitability. A 1-millisecond advantage can mean capturing favorable prices before competitors. Modern HFT systems target single-digit microsecond latency.</p>
<div style="background: rgba(248, 81, 73, 0.1);border-radius: 12px; padding: 20px; margin: 20px 0">
<h4 id="assumption-latency-investment-has-diminishing-returns">Assumption: Latency Investment Has Diminishing Returns</h4>
<p>Each microsecond of improvement costs exponentially more to achieve. Going from 1ms to 100us might cost $1M; going from 100us to 10us might cost $10M. At some point, the edge is too small to recoup the investment.</p>
<p><strong>Trade-off</strong>: Resources spent on latency could be spent on better trading strategies. The optimal allocation depends on the competitive landscape.</p>
</div>
<h3 id="latency-breakdown">Latency Breakdown by Component</h3>
<div class="diagram-container" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 24px; margin: 20px 0">
<div class="flow-diagram" style="gap: 8px">
<div style="display: grid; grid-template-columns: 200px 100px 1fr; align-items: center; gap: 16px; padding: 12px; background: rgba(248, 81, 73, 0.1); border-radius: 8px; width: 100%">
<div style="color: #f85149; font-weight: 600">Network (cross-country)</div>
<div style="color: #f85149; font-weight: 700">~20,000 us</div>
<div style="height: 8px; background: #f85149; border-radius: 4px"></div>
</div>
<div style="display: grid; grid-template-columns: 200px 100px 1fr; align-items: center; gap: 16px; padding: 12px; background: rgba(240, 136, 62, 0.1); border-radius: 8px; width: 100%">
<div style="color: #f0883e; font-weight: 600">Network (co-located)</div>
<div style="color: #f0883e; font-weight: 700">~5-50 us</div>
<div style="height: 8px; background: #f0883e; border-radius: 4px; width: 2%"></div>
</div>
<div style="display: grid; grid-template-columns: 200px 100px 1fr; align-items: center; gap: 16px; padding: 12px; background: rgba(137, 87, 229, 0.1); border-radius: 8px; width: 100%">
<div style="color: #a371f7; font-weight: 600">Kernel network stack</div>
<div style="color: #a371f7; font-weight: 700">~10-50 us</div>
<div style="height: 8px; background: #a371f7; border-radius: 4px; width: 2%"></div>
</div>
<div style="display: grid; grid-template-columns: 200px 100px 1fr; align-items: center; gap: 16px; padding: 12px; background: rgba(88, 166, 255, 0.1); border-radius: 8px; width: 100%">
<div style="color: #58a6ff; font-weight: 600">Application processing</div>
<div style="color: #58a6ff; font-weight: 700">~1-10 us</div>
<div style="height: 8px; background: #58a6ff; border-radius: 4px; width: 0.5%"></div>
</div>
<div style="display: grid; grid-template-columns: 200px 100px 1fr; align-items: center; gap: 16px; padding: 12px; background: rgba(126, 231, 135, 0.1); border-radius: 8px; width: 100%">
<div style="color: #7ee787; font-weight: 600">Memory access (cache hit)</div>
<div style="color: #7ee787; font-weight: 700">~0.0004 us</div>
<div style="height: 8px; background: #7ee787; border-radius: 4px; width: 0.01%"></div>
</div>
<div style="text-align: center; margin-top: 20px; padding: 16px; background: rgba(248, 81, 73, 0.1); border-radius: 8px; width: 100%">
<span style="color: #f85149; font-weight: 600">Key Insight: Network is the dominant factor. Co-location eliminates the biggest variable.</span>
</div>
</div>
</div>
<h3 id="optimization-techniques">Optimization Techniques by Layer</h3>
<div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 20px 0">
<p><strong>1. Physical Layer</strong></p>
<ul>
<li><strong>Co-location</strong>: Rent rack space in exchange's data center (~$10K-$100K/month)</li>
<li><strong>Cross-connects</strong>: Direct fiber to exchange's matching engine (eliminate public internet)</li>
<li><strong>Microwave/Laser</strong>: For cross-data-center links (speed of light in air &gt; fiber)</li>
</ul>
<p><strong>2. Network Layer</strong></p>
<ul>
<li><strong>DPDK (Data Plane Development Kit)</strong>: Bypass kernel, poll NIC directly in user space</li>
<li><strong>RDMA</strong>: Remote Direct Memory Access for zero-copy network transfers</li>
<li><strong>Solarflare/Mellanox NICs</strong>: Hardware timestamping, kernel bypass support</li>
<li><strong>FPGA-based NICs</strong>: Implement trading logic directly in network card</li>
</ul>
<p><strong>3. Operating System</strong></p>
<ul>
<li><strong>CPU isolation</strong>: <code>isolcpus</code> kernel parameter to prevent scheduler interference</li>
<li><strong>NUMA pinning</strong>: Keep process and its memory on same CPU socket</li>
<li><strong>Huge pages</strong>: 2MB pages reduce TLB misses</li>
<li><strong>Disable hyperthreading</strong>: Prevents cache thrashing between siblings</li>
</ul>
<p><strong>4. Application</strong></p>
<ul>
<li><strong>Lock-free data structures</strong>: <a href="/topics/concurrency/compare-and-swap">[CAS]</a> operations instead of mutexes</li>
<li><strong>Object pooling</strong>: Pre-allocate all objects; never malloc during trading</li>
<li><strong>Busy polling</strong>: Spin on CPU rather than blocking on I/O</li>
<li><strong>JIT warmup</strong>: For Java/JVM, pre-warm code paths before market open</li>
</ul>
</div>
<div style="background: rgba(240, 136, 62, 0.1);border-radius: 12px; padding: 20px; margin: 20px 0">
<h4 id="design-choice-fpga-vs-software">Design Choice: FPGA vs Software</h4>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>FPGA</th>
<th>Software (C++)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Latency</strong></td>
<td>~1 microsecond</td>
<td>~10 microseconds</td>
</tr>
<tr>
<td><strong>Development cost</strong></td>
<td>$1M+ per strategy</td>
<td>$100K+ per strategy</td>
</tr>
<tr>
<td><strong>Flexibility</strong></td>
<td>Weeks to change</td>
<td>Hours to change</td>
</tr>
<tr>
<td><strong>Expertise needed</strong></td>
<td>Hardware engineers</td>
<td>Software engineers</td>
</tr>
<tr>
<td><strong>Power consumption</strong></td>
<td>~50W</td>
<td>~200W</td>
</tr>
</tbody>
</table>
<p><strong>When FPGA wins</strong>: High-frequency strategies where being first matters (market making, arbitrage). The 9us advantage is worth the development cost.</p>
<p><strong>When software wins</strong>: Complex strategies with many conditional branches, frequent updates, or where 10us is &quot;fast enough&quot; (most institutional trading).</p>
</div>
<h3 id="latency-interview-questions">3-Level Recursive Interview Questions: Latency</h3>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="level-1-how-would-you-reduce-order-submission-latency-from-10ms-to-1ms">Level 1: &quot;How would you reduce order submission latency from 10ms to 1ms?&quot;</h4>
<p><strong>Expected Answer</strong>: Profile to find bottlenecks. Typically:</p>
<ol>
<li>Move to co-located servers (eliminates network transit time)</li>
<li>Use persistent connections (avoid TCP handshake per request)</li>
<li>Switch from JSON to binary protocol (FIX or custom)</li>
<li>Use connection pooling for database</li>
<li>Cache frequently accessed data in memory</li>
</ol>
<div style="background: rgba(88, 166, 255, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h5 id="level-2-were-already-co-located-but-competitors-are-5us-faster-whats-left-to-optimize">Level 2: &quot;We're already co-located but competitors are 5us faster. What's left to optimize?&quot;</h5>
<p><strong>Expected Answer</strong>: At this level, focus shifts to determinism over raw speed:</p>
<ol>
<li><strong>Kernel bypass</strong>: DPDK eliminates ~30us of kernel networking overhead</li>
<li><strong>CPU pinning + isolation</strong>: Guarantees your thread runs without interruption</li>
<li><strong>Memory pre-touching</strong>: Access all data structures before market open to load into cache</li>
<li><strong>Disable NUMA balancing</strong>: Prevent kernel from migrating memory between sockets</li>
<li><strong>Use TSC for timing</strong>: CPU timestamp counter is faster than gettimeofday()</li>
</ol>
<p><strong>Critical insight</strong>: At microsecond scale, variance matters as much as mean. A system with 5us mean and 1us stddev beats one with 4us mean and 5us stddev, because the latter occasionally hits 20us outliers.</p>
<div style="background: rgba(137, 87, 229, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h6 id="level-3-how-do-you-measure-and-attribute-latency-when-your-target-is-sub-microsecond">Level 3: &quot;How do you measure and attribute latency when your target is sub-microsecond?&quot;</h6>
<p><strong>Expected Answer</strong>: Standard profiling tools (gprof, perf) have overhead that distorts measurements at this scale. Instead:</p>
<ol>
<li><strong>Hardware timestamping</strong>: NIC records packet arrival time in hardware with nanosecond precision</li>
<li><strong>CPU cycle counting</strong>: <code>RDTSC</code> instruction reads CPU cycle counter; convert to time via known frequency</li>
<li><strong>EBPF probes</strong>: Kernel-level tracing with minimal overhead</li>
<li><strong>Statistical sampling</strong>: Measure every Nth event to reduce overhead</li>
</ol>
<p><strong>Attribution methodology</strong>:</p>
<pre><code>Total latency = T_network_in + T_deserialize + T_validate + T_match + T_serialize + T_network_out
</code></pre>
<p>Measure each segment independently. The segment with highest variance is often more important than the one with highest mean (variance indicates contention or resource starvation).</p>
<p><strong>The &quot;coordinated omission&quot; trap</strong>: If your load generator pauses during slow responses, you undercount those responses in percentile calculations. Use <a href="/topics/observability/metrics">[HDR Histogram]</a> or similar to capture full latency distribution accurately.</p>
</div>
</div>
</div>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="level-1-why-is-java-used-in-trading-systems-despite-being-slow">Level 1: &quot;Why is Java used in trading systems despite being 'slow'?&quot;</h4>
<p><strong>Expected Answer</strong>: JVM performance has improved dramatically. With proper tuning (G1GC or ZGC, JIT warmup, off-heap memory), Java achieves single-digit microsecond latency. Benefits: developer productivity, rich ecosystem, easier to hire. LMAX Exchange processes 6M transactions/second in Java.</p>
<div style="background: rgba(88, 166, 255, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h5 id="level-2-how-do-you-prevent-gc-pauses-from-causing-latency-spikes">Level 2: &quot;How do you prevent GC pauses from causing latency spikes?&quot;</h5>
<p><strong>Expected Answer</strong>: Multiple strategies:</p>
<ol>
<li><strong>Object pooling</strong>: Reuse objects instead of creating new ones; no garbage = no collection</li>
<li><strong>Off-heap memory</strong>: Store large data structures outside JVM heap using <code>Unsafe</code> or memory-mapped files</li>
<li><strong>Concurrent collectors</strong>: G1GC or ZGC pause for ~1-10ms vs 100ms+ for old collectors</li>
<li><strong>GC tuning</strong>: <code>-XX:MaxGCPauseMillis=10</code> sets target pause time</li>
<li><strong>Heap sizing</strong>: Make heap large enough that collections are infrequent</li>
</ol>
<p><strong>The &quot;GC-free&quot; path</strong>: LMAX Disruptor achieves millions of operations per second without GC by pre-allocating all ring buffer entries and mutating in place rather than creating new objects.</p>
<div style="background: rgba(137, 87, 229, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h6 id="level-3-what-is-the-lmax-disruptor-pattern-and-why-is-it-faster-than-traditional-queues">Level 3: &quot;What is the LMAX Disruptor pattern and why is it faster than traditional queues?&quot;</h6>
<p><strong>Expected Answer</strong>: The Disruptor is a lock-free, bounded, pre-allocated ring buffer that achieves ~6M ops/second single-threaded.</p>
<p><strong>Key innovations</strong>:</p>
<ol>
<li>
<p><strong>Mechanical sympathy</strong>: Ring buffer entries are cache-line aligned (64 bytes). Sequential access pattern allows CPU prefetcher to predict next access.</p>
</li>
<li>
<p><strong>Single-writer principle</strong>: Only one thread writes to any variable. Eliminates need for memory barriers on writes.</p>
</li>
<li>
<p><strong>Sequence barriers</strong>: Instead of locks, consumers track a sequence number. Compare-and-swap only on sequence increment.</p>
</li>
<li>
<p><strong>Batching</strong>: Producer can publish multiple events with single barrier. Consumer can process multiple events before updating its sequence.</p>
</li>
</ol>
<p><strong>Why faster than BlockingQueue</strong>:</p>
<ul>
<li><code>ArrayBlockingQueue.put()</code>: Lock acquisition (~100ns when contested), notify waiting thread (~10us context switch)</li>
<li>Disruptor: Increment sequence (single CPU instruction), consumer is busy-polling (no wakeup needed)</li>
</ul>
<p><strong>The trade-off</strong>: Disruptor trades CPU cycles (busy polling) for latency predictability. In a trading system, burning a core to spin is cheaper than a single slow order.</p>
</div>
</div>
</div>
</div>
<hr />
<h2 id="section-5-regulatory-compliance">Section 5: Regulatory Compliance</h2>
<div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px; padding: 32px; margin: 20px 0">
<h3 id="compliance-core-concept">Core Concept: The Rules of Engagement</h3>
<p>Financial markets are heavily regulated to ensure fairness, prevent fraud, and maintain systemic stability. Key regulations affecting stockbroker systems:</p>
<ul>
<li><strong>SEC (US)</strong>: Registration, best execution, trade reporting</li>
<li><strong>FINRA (US)</strong>: Broker-dealer supervision, market manipulation rules</li>
<li><strong>MiFID II (EU)</strong>: Transaction reporting, algorithmic trading controls</li>
<li><strong>MAR (EU)</strong>: Market abuse detection and reporting</li>
</ul>
<div style="background: rgba(248, 81, 73, 0.1);border-radius: 12px; padding: 20px; margin: 20px 0">
<h4 id="assumption-audit-trail-immutability">Assumption: Audit Trail Immutability</h4>
<p>Regulators assume that once a record is written to the audit trail, it cannot be modified or deleted. Systems must be designed to make tampering technically difficult and detectable.</p>
<p><strong>Trade-off</strong>: True immutability conflicts with data correction needs. Solution: Never delete; append correction records that reference the original.</p>
</div>
<h3 id="compliance-requirements">Key Compliance Requirements</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 20px 0">
<div style="background: rgba(126, 231, 135, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #7ee787; font-weight: 700; margin-bottom: 12px">Best Execution (Reg NMS / MiFID II)</div>
<div style="color: #8b949e; font-size: 13px">
<p>Brokers must execute client orders at the best available price across all exchanges. Requires:</p>
<ul style="margin: 8px 0; padding-left: 20px">
<li>Real-time connectivity to all lit venues</li>
<li>Order routing logic to compare prices</li>
<li>Documentation of execution quality</li>
<li>Periodic best execution reports to clients</li>
</ul>
</div>
</div>
<div style="background: rgba(88, 166, 255, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #58a6ff; font-weight: 700; margin-bottom: 12px">Order Audit Trail (CAT / MIFIR)</div>
<div style="color: #8b949e; font-size: 13px">
<p>Every order must be logged with precise timing and attribution:</p>
<ul style="margin: 8px 0; padding-left: 20px">
<li>Timestamp to millisecond (US) or microsecond (EU)</li>
<li>Customer ID (anonymized in CAT)</li>
<li>Order details (symbol, side, quantity, price, type)</li>
<li>All modifications and final status</li>
</ul>
</div>
</div>
<div style="background: rgba(137, 87, 229, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #a371f7; font-weight: 700; margin-bottom: 12px">Market Manipulation Detection</div>
<div style="color: #8b949e; font-size: 13px">
<p>Systems must detect and report suspicious patterns:</p>
<ul style="margin: 8px 0; padding-left: 20px">
<li>Spoofing: Placing orders with intent to cancel</li>
<li>Layering: Multiple orders at different prices to create false depth</li>
<li>Wash trading: Trading with yourself to inflate volume</li>
<li>Pump and dump: Coordinated price manipulation</li>
</ul>
</div>
</div>
<div style="background: rgba(240, 136, 62, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #f0883e; font-weight: 700; margin-bottom: 12px">Risk Controls (SEC Rule 15c3-5)</div>
<div style="color: #8b949e; font-size: 13px">
<p>Pre-trade risk checks must be implemented:</p>
<ul style="margin: 8px 0; padding-left: 20px">
<li>Credit limits per customer and aggregate</li>
<li>Position limits per security</li>
<li>Order size limits (no "fat finger" trades)</li>
<li>Price collars (reject orders far from market)</li>
</ul>
</div>
</div>
</div>
<h3 id="audit-trail-architecture">Internal Mechanism: Audit Trail Architecture</h3>
<div class="diagram-container" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 24px; margin: 20px 0">
<div class="flow-diagram">
<div class="flow-row">
<div class="flow-box info" style="min-width: 150px">
<div class="flow-box-title">Trading System</div>
<div class="flow-box-subtitle">Order Events</div>
</div>
<div class="flow-arrow">&#8594;</div>
<div class="flow-box purple" style="min-width: 150px">
<div class="flow-box-title">Event Stream</div>
<div class="flow-box-subtitle">Kafka (immutable log)</div>
</div>
</div>
<div class="flow-row">
<div class="flow-arrow">&#8601;</div>
<div class="flow-arrow vertical">&#8595;</div>
<div class="flow-arrow">&#8600;</div>
</div>
<div class="flow-row">
<div class="flow-box success" style="min-width: 140px">
<div class="flow-box-title">Hot Storage</div>
<div class="flow-box-subtitle">TimescaleDB - 90 days</div>
</div>
<div class="flow-box warning" style="min-width: 140px">
<div class="flow-box-title">Warm Storage</div>
<div class="flow-box-subtitle">S3 + Athena - 7 years</div>
</div>
<div class="flow-box error" style="min-width: 140px">
<div class="flow-box-title">Cold Archive</div>
<div class="flow-box-subtitle">Glacier - Permanent</div>
</div>
</div>
</div>
</div>
<div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 20px 0">
<p><strong>Audit Record Schema (simplified)</strong>:</p>
<pre><code class="language-json">{
  &quot;event_id&quot;: &quot;uuid-v7-with-embedded-timestamp&quot;,
  &quot;event_type&quot;: &quot;ORDER_PLACED&quot;,
  &quot;timestamp_received&quot;: &quot;2024-01-15T14:30:00.123456Z&quot;,
  &quot;timestamp_processed&quot;: &quot;2024-01-15T14:30:00.123789Z&quot;,
  &quot;order_id&quot;: &quot;ORD-2024-0115-12345&quot;,
  &quot;client_id_hash&quot;: &quot;sha256(client_id + daily_salt)&quot;,
  &quot;symbol&quot;: &quot;AAPL&quot;,
  &quot;side&quot;: &quot;BUY&quot;,
  &quot;quantity&quot;: 100,
  &quot;price&quot;: &quot;182.50&quot;,
  &quot;order_type&quot;: &quot;LIMIT&quot;,
  &quot;time_in_force&quot;: &quot;DAY&quot;,
  &quot;routing_decision&quot;: {
    &quot;selected_venue&quot;: &quot;NYSE&quot;,
    &quot;reason&quot;: &quot;BEST_PRICE&quot;,
    &quot;alternatives_considered&quot;: [&quot;NASDAQ&quot;, &quot;BATS&quot;],
    &quot;prices_at_decision&quot;: {&quot;NYSE&quot;: &quot;182.50&quot;, &quot;NASDAQ&quot;: &quot;182.51&quot;, &quot;BATS&quot;: &quot;182.52&quot;}
  },
  &quot;system_metadata&quot;: {
    &quot;server_id&quot;: &quot;trade-server-prod-03&quot;,
    &quot;version&quot;: &quot;2.14.3&quot;,
    &quot;request_trace_id&quot;: &quot;trace-abc123&quot;
  }
}
</code></pre>
<p><strong>Key design decisions</strong>:</p>
<ul>
<li>UUID v7 includes timestamp, enabling chronological sorting without secondary index</li>
<li>Client ID is hashed to protect privacy while maintaining traceability</li>
<li>Routing decision includes full context to demonstrate best execution</li>
<li>System metadata enables forensic debugging</li>
</ul>
</div>
<div style="background: rgba(240, 136, 62, 0.1);border-radius: 12px; padding: 20px; margin: 20px 0">
<h4 id="design-choice-time-synchronization">Design Choice: Time Synchronization</h4>
<p>Regulatory timestamps must be accurate to prevent disputes and enable cross-system correlation. Options:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Accuracy</th>
<th>Cost</th>
<th>Complexity</th>
</tr>
</thead>
<tbody>
<tr>
<td>NTP</td>
<td>~10ms</td>
<td>Free</td>
<td>Low</td>
</tr>
<tr>
<td>PTP (IEEE 1588)</td>
<td>~1us</td>
<td>$10K+ per server</td>
<td>Medium</td>
</tr>
<tr>
<td>GPS disciplined oscillator</td>
<td>~100ns</td>
<td>$50K+ per server</td>
<td>High</td>
</tr>
<tr>
<td>Atomic clock</td>
<td>~1ns</td>
<td>$100K+</td>
<td>Very High</td>
</tr>
</tbody>
</table>
<p><strong>Production choice</strong>: PTP for trading servers (satisfies microsecond requirement), NTP for support systems. All servers sync to same grandmaster clock to ensure consistency across the fleet.</p>
<p><strong>The GPS vulnerability</strong>: GPS-based timing can be spoofed. Defense: Multiple independent time sources with anomaly detection. See <a href="/topics/distributed-systems/clocks">[distributed-clocks]</a>.</p>
</div>
<h3 id="compliance-interview-questions">3-Level Recursive Interview Questions: Compliance</h3>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="level-1-how-do-you-ensure-audit-trail-integrity">Level 1: &quot;How do you ensure audit trail integrity?&quot;</h4>
<p><strong>Expected Answer</strong>: Write to append-only storage (Kafka with compaction disabled), replicate to multiple locations, calculate checksums for each record, and use WORM (Write Once Read Many) storage for long-term archives. Regular integrity verification compares checksums.</p>
<div style="background: rgba(88, 166, 255, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h5 id="level-2-a-regulator-requests-all-orders-for-client-x-from-3-years-ago-how-do-you-retrieve-them-efficiently">Level 2: &quot;A regulator requests all orders for client X from 3 years ago. How do you retrieve them efficiently?&quot;</h5>
<p><strong>Expected Answer</strong>: Multi-tier storage architecture:</p>
<ol>
<li><strong>Recent data (90 days)</strong>: Query TimescaleDB directly, indexed by client_id_hash and timestamp</li>
<li><strong>Older data (90 days - 7 years)</strong>: Query via Athena against Parquet files in S3, partitioned by date</li>
<li><strong>Very old data (7+ years)</strong>: Restore from Glacier to S3, then query via Athena</li>
</ol>
<p><strong>Optimization for regulatory queries</strong>:</p>
<ul>
<li>Pre-aggregate daily summaries (order counts, volumes) for quick filtering</li>
<li>Maintain client-level indexes even in cold storage</li>
<li>Regulatory query service with query cost estimation before execution</li>
</ul>
<p><strong>Timeline</strong>: Hot query returns in seconds; warm query in minutes; cold query may take hours (Glacier restore time).</p>
<div style="background: rgba(137, 87, 229, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h6 id="level-3-how-do-you-handle-gdpr-right-to-be-forgotten-requests-while-maintaining-regulatory-audit-trails">Level 3: &quot;How do you handle GDPR 'right to be forgotten' requests while maintaining regulatory audit trails?&quot;</h6>
<p><strong>Expected Answer</strong>: This is a genuine conflict between privacy law (GDPR) and financial regulation (MiFID II, SEC rules). Resolution:</p>
<p><strong>Legal position</strong>: Financial regulations typically have carve-outs for records required by other laws. Audit trail retention is a legal obligation that supersedes GDPR deletion rights.</p>
<p><strong>Technical implementation</strong>:</p>
<ol>
<li><strong>Pseudonymization</strong>: Client PII stored separately from audit records. Audit records contain only client_id_hash.</li>
<li><strong>Key deletion</strong>: For GDPR deletion, delete the key that maps client_id_hash to real identity. Audit records remain but become anonymous.</li>
<li><strong>Regulatory access</strong>: Maintain a &quot;break glass&quot; capability for regulators to request mapping recovery (from encrypted backup) with proper authorization.</li>
</ol>
<p><strong>The uncomfortable truth</strong>: True deletion is impossible in an event-sourced system. The system is designed for immutability. GDPR compliance is achieved through anonymization, not deletion.</p>
</div>
</div>
</div>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="level-1-what-is-market-manipulation-and-how-do-you-detect-it">Level 1: &quot;What is market manipulation and how do you detect it?&quot;</h4>
<p><strong>Expected Answer</strong>: Market manipulation is intentionally creating artificial prices or trading activity. Detection involves pattern recognition: high order-to-trade ratios (spoofing), coordinated trading across accounts (wash trading), or unusual position building before news (insider trading). Systems use both rules-based alerts and ML anomaly detection.</p>
<div style="background: rgba(88, 166, 255, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h5 id="level-2-how-do-you-distinguish-between-legitimate-algorithmic-trading-and-spoofing">Level 2: &quot;How do you distinguish between legitimate algorithmic trading and spoofing?&quot;</h5>
<p><strong>Expected Answer</strong>: Spoofing involves placing orders you intend to cancel to manipulate prices. Legitimate algorithms also cancel orders (responding to market changes).</p>
<p><strong>Key differentiators</strong>:</p>
<ol>
<li><strong>Cancel-to-fill ratio</strong>: Spoofers have &gt;95% cancellation; legitimate algos typically &lt;80%</li>
<li><strong>Time in book</strong>: Spoof orders exist for milliseconds; legitimate orders persist longer</li>
<li><strong>Price aggressiveness</strong>: Spoof orders are placed away from touch; legitimate orders are at or near best bid/ask</li>
<li><strong>Pattern after cancel</strong>: Spoofers trade in opposite direction immediately after cancel; legitimate algos don't</li>
</ol>
<p><strong>Implementation challenge</strong>: These are probabilistic signals, not proof. Alert for human review; don't auto-block.</p>
<div style="background: rgba(137, 87, 229, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0">
<h6 id="level-3-how-do-you-build-a-real-time-surveillance-system-that-processes-millions-of-orders-to-detect-manipulation-patterns">Level 3: &quot;How do you build a real-time surveillance system that processes millions of orders to detect manipulation patterns?&quot;</h6>
<p><strong>Expected Answer</strong>: Stream processing architecture using <a href="/topics/system-design/kafka-streams">[Kafka Streams]</a> or <a href="/topics/system-design/apache-flink">[Flink]</a>:</p>
<p><strong>Architecture</strong>:</p>
<pre><code>Orders -&gt; Kafka -&gt; Flink Jobs -&gt; Alerts -&gt; Investigation Queue
                    |
              State Store (per-account metrics)
</code></pre>
<p><strong>Per-account state maintained</strong>:</p>
<ul>
<li>Rolling 1-minute order/cancel/fill counts</li>
<li>Position changes over multiple windows</li>
<li>Historical pattern baseline</li>
</ul>
<p><strong>Detection jobs</strong>:</p>
<ol>
<li><strong>Spoofing detector</strong>: Windowed aggregation of order lifecycle events; alert if cancel_ratio &gt; threshold AND orders were on opposite side of subsequent fill</li>
<li><strong>Layering detector</strong>: Multiple orders at different price levels cancelled together</li>
<li><strong>Wash trade detector</strong>: Graph analysis of order flow between related accounts (shared IP, similar patterns)</li>
</ol>
<p><strong>Scale considerations</strong>:</p>
<ul>
<li>Partition by symbol for parallel processing</li>
<li>Use RocksDB state backend for large state</li>
<li>Checkpoint every 10 seconds for fault tolerance</li>
<li>Alert deduplication to prevent flood of similar alerts</li>
</ul>
<p><strong>The ML angle</strong>: Train models on confirmed manipulation cases. Features include order book imbalance before/after, price impact, temporal patterns. Challenge: very few positive examples (manipulation is rare and often undetected).</p>
</div>
</div>
</div>
</div>
<hr />
<h2 id="edge-cases-failure-modes">Edge Cases & Failure Modes</h2>
<div style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-radius: 16px; padding: 32px; margin: 20px 0">
<p>Understanding failure modes is critical for building resilient trading systems. This section catalogs common edge cases and their mitigations.</p>
<h3 id="order-handling-failures">Order Handling Failures</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin: 20px 0">
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #ef4444; font-weight: 700; margin-bottom: 8px">Fat Finger Orders</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">User accidentally enters 10,000 shares instead of 100, or $1,000 price instead of $100.</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">Price collars (reject if >5% from last trade), notional value limits, confirmation dialogs for large orders, cooling-off period for unusual sizes.</div>
</div>
</div>
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #ef4444; font-weight: 700; margin-bottom: 8px">Duplicate Order Submission</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">Network timeout causes client to retry, but original order already processed.</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">Client-generated idempotency key on each order. Server rejects duplicates within time window. Return cached response for retried requests.</div>
</div>
</div>
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #ef4444; font-weight: 700; margin-bottom: 8px">Stale Quote Execution</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">Order executed against quote that had already been cancelled/updated.</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">Optimistic locking with version numbers. Check order book version before and after match. Reject if version changed during processing.</div>
</div>
</div>
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #ef4444; font-weight: 700; margin-bottom: 8px">Partial Fill Abandonment</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">Large order partially fills, remaining quantity sits unfilled as market moves away.</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">Immediate-or-Cancel (IOC) or Fill-or-Kill (FOK) order types. TWAP/VWAP algorithms for large orders. Alert thresholds for aged unfilled orders.</div>
</div>
</div>
</div>
<h3 id="system-failures">System Failures</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin: 20px 0">
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #f59e0b; font-weight: 700; margin-bottom: 8px">Matching Engine Crash Mid-Match</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">Engine crashes after debiting buyer but before crediting seller.</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">Write-ahead logging with transaction boundaries. On recovery, complete or rollback partial transactions. Use saga pattern with compensating transactions.</div>
</div>
</div>
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #f59e0b; font-weight: 700; margin-bottom: 8px">Network Partition (Split Brain)</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">Primary and secondary matching engines both accept orders, causing duplicate executions.</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">Consensus protocol (Raft/Paxos) for leader election. Fencing tokens to reject stale leader's operations. Prefer unavailability over inconsistency (CP system).</div>
</div>
</div>
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #f59e0b; font-weight: 700; margin-bottom: 8px">Clock Drift</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">Servers have different time, causing out-of-order timestamps and fairness violations.</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">PTP time sync with <1us accuracy. Logical clocks (Lamport timestamps) as backup. Monitor drift and alert if exceeds threshold.</div>
</div>
</div>
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #f59e0b; font-weight: 700; margin-bottom: 8px">Message Queue Backpressure</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">Sudden volume spike overwhelms message queue, causing cascading delays.</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">Bounded queues with drop policy for non-critical messages. Priority queues for order flow. Auto-scaling consumers. Load shedding for market data updates.</div>
</div>
</div>
</div>
<h3 id="market-condition-failures">Market Condition Failures</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin: 20px 0">
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #8b5cf6; font-weight: 700; margin-bottom: 8px">Flash Crash</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">Cascading sell orders cause price to drop 90% in seconds.</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">Circuit breakers halt trading at 7%, 13%, 20% drops. Limit-up/limit-down bands. Volatility auctions instead of continuous matching.</div>
</div>
</div>
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #8b5cf6; font-weight: 700; margin-bottom: 8px">Liquidity Dry-Up</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">Market makers withdraw during high volatility, leaving no buyers/sellers.</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">Market maker obligations (minimum quote requirements). Designated market makers with last-resort obligations. Widen price bands during volatility.</div>
</div>
</div>
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #8b5cf6; font-weight: 700; margin-bottom: 8px">Erroneous Trade (Clearly Erroneous)</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">Trade executes at price clearly outside market (e.g., $0.01 for a $100 stock).</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">Clearly erroneous trade rules allow cancellation within time window. Automatic detection and flagging. Busting requires exchange/regulatory approval.</div>
</div>
</div>
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #8b5cf6; font-weight: 700; margin-bottom: 8px">Corporate Action Mishandling</div>
<div style="color: #8b949e; font-size: 13px; margin-bottom: 12px">Stock split occurs but system still uses old price/quantity, causing massive over/under fills.</div>
<div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px">
<div style="color: #10b981; font-weight: 600; font-size: 12px">MITIGATION</div>
<div style="color: #8b949e; font-size: 12px">Corporate action database with effective dates. Automated adjustment of open orders. Halt trading in affected symbol during corporate action processing.</div>
</div>
</div>
</div>
</div>
<hr />
<h2 id="scaling-strategies">Scaling Strategies</h2>
<div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 16px; padding: 32px; margin: 20px 0">
<p>Scaling a stockbroker system requires different strategies for different components, as each has unique latency and consistency requirements.</p>
<h3 id="horizontal-scaling">Horizontal Scaling Patterns</h3>
<div class="diagram-container" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 24px; margin: 20px 0">
<div class="flow-diagram">
<div style="text-align: center; margin-bottom: 16px; color: #10b981; font-weight: 700">Partition by Symbol Strategy</div>
<div class="flow-row">
<div class="flow-box primary" style="min-width: 180px">
<div class="flow-box-title">Order Gateway</div>
<div class="flow-box-subtitle">Routes by symbol hash</div>
</div>
</div>
<div class="flow-row">
<div class="flow-arrow">&#8601;</div>
<div class="flow-arrow vertical">&#8595;</div>
<div class="flow-arrow">&#8600;</div>
</div>
<div class="flow-row">
<div class="flow-box success" style="min-width: 140px">
<div class="flow-box-title">Engine A</div>
<div class="flow-box-subtitle">AAPL-GOOG</div>
</div>
<div class="flow-box success" style="min-width: 140px">
<div class="flow-box-title">Engine B</div>
<div class="flow-box-subtitle">GOOGL-MSFT</div>
</div>
<div class="flow-box success" style="min-width: 140px">
<div class="flow-box-title">Engine C</div>
<div class="flow-box-subtitle">MSFT-ZZZZ</div>
</div>
</div>
</div>
</div>
<div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 20px 0">
<p><strong>Component-Specific Scaling Strategies:</strong></p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Scaling Strategy</th>
<th>Key Consideration</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Matching Engine</strong></td>
<td>Partition by symbol</td>
<td>Single-threaded per symbol for determinism</td>
</tr>
<tr>
<td><strong>Market Data</strong></td>
<td>Fan-out with multicast</td>
<td>Conflation to reduce bandwidth</td>
</tr>
<tr>
<td><strong>Order Gateway</strong></td>
<td>Stateless horizontal</td>
<td>Sticky sessions for in-flight orders</td>
</tr>
<tr>
<td><strong>Risk Engine</strong></td>
<td>Read replicas</td>
<td>Eventual consistency acceptable for reads</td>
</tr>
<tr>
<td><strong>Audit Trail</strong></td>
<td>Append-only sharding</td>
<td>Partition by time for efficient archival</td>
</tr>
<tr>
<td><strong>Settlement</strong></td>
<td>Batch processing</td>
<td>Nightly batch scales with trade volume</td>
</tr>
</tbody>
</table>
</div>
<h3 id="vertical-scaling">Vertical Scaling Optimizations</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin: 20px 0">
<div style="background: rgba(16, 185, 129, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #10b981; font-weight: 700; margin-bottom: 12px">CPU Optimization</div>
<ul style="color: #8b949e; font-size: 13px; margin: 0; padding-left: 20px">
<li>CPU pinning with isolcpus</li>
<li>Disable hyperthreading for matching threads</li>
<li>NUMA-aware memory allocation</li>
<li>Busy-polling instead of interrupt-driven I/O</li>
</ul>
</div>
<div style="background: rgba(59, 130, 246, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #3b82f6; font-weight: 700; margin-bottom: 12px">Memory Optimization</div>
<ul style="color: #8b949e; font-size: 13px; margin: 0; padding-left: 20px">
<li>Huge pages (2MB) to reduce TLB misses</li>
<li>Pre-allocate all data structures at startup</li>
<li>Object pooling to eliminate GC</li>
<li>Memory-mapped files for large datasets</li>
</ul>
</div>
<div style="background: rgba(139, 92, 246, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #8b5cf6; font-weight: 700; margin-bottom: 12px">Network Optimization</div>
<ul style="color: #8b949e; font-size: 13px; margin: 0; padding-left: 20px">
<li>Kernel bypass with DPDK</li>
<li>RDMA for inter-server communication</li>
<li>Hardware timestamping NICs</li>
<li>Jumbo frames for bulk transfers</li>
</ul>
</div>
<div style="background: rgba(245, 158, 11, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #f59e0b; font-weight: 700; margin-bottom: 12px">Storage Optimization</div>
<ul style="color: #8b949e; font-size: 13px; margin: 0; padding-left: 20px">
<li>NVMe SSDs with direct I/O</li>
<li>Append-only write patterns</li>
<li>Tiered storage (hot/warm/cold)</li>
<li>Compression for archival data</li>
</ul>
</div>
</div>
<h3 id="capacity-planning">Capacity Planning Guidelines</h3>
<div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 20px 0">
<p><strong>Traffic Estimation Formula:</strong></p>
<pre><code>Peak Orders/Second = (Daily Volume * Peak Multiplier) / Trading Seconds
                   = (10M orders * 5x) / 23,400 seconds
                   = ~2,140 orders/second

With 10x headroom for spikes: Target capacity = 21,400 orders/second
</code></pre>
<p><strong>Resource Sizing:</strong></p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Baseline</th>
<th>10x Growth Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>Orders/day</td>
<td>10M</td>
<td>100M</td>
</tr>
<tr>
<td>Peak orders/sec</td>
<td>2,000</td>
<td>20,000</td>
</tr>
<tr>
<td>Market data msgs/sec</td>
<td>1M</td>
<td>10M</td>
</tr>
<tr>
<td>Concurrent connections</td>
<td>10K</td>
<td>100K</td>
</tr>
<tr>
<td>Storage/day (audit)</td>
<td>50 GB</td>
<td>500 GB</td>
</tr>
<tr>
<td>Matching engine servers</td>
<td>4 (1 per symbol range)</td>
<td>40</td>
</tr>
<tr>
<td>Market data fanout</td>
<td>10 servers</td>
<td>100 servers</td>
</tr>
</tbody>
</table>
</div>
<h3 id="disaster-recovery">Disaster Recovery</h3>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin: 20px 0">
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #10b981; font-weight: 700; margin-bottom: 12px">Hot Standby (Active-Passive)</div>
<div style="color: #8b949e; font-size: 13px">
<p><strong>RTO:</strong> < 5 seconds</p>
<p><strong>RPO:</strong> 0 (synchronous replication)</p>
<p>Standby replays event log in real-time. On primary failure, promote standby. Highest cost, lowest risk.</p>
</div>
</div>
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #3b82f6; font-weight: 700; margin-bottom: 12px">Warm Standby</div>
<div style="color: #8b949e; font-size: 13px">
<p><strong>RTO:</strong> < 5 minutes</p>
<p><strong>RPO:</strong> < 1 minute (async replication)</p>
<p>Standby receives batched updates. On failure, catch up from last checkpoint, then take over. Balance of cost and recovery time.</p>
</div>
</div>
<div style="background: var(--color-bg-primary, #ffffff);border-radius: 12px; padding: 20px">
<div style="color: #f59e0b; font-weight: 700; margin-bottom: 12px">Cold Standby</div>
<div style="color: #8b949e; font-size: 13px">
<p><strong>RTO:</strong> < 1 hour</p>
<p><strong>RPO:</strong> < 1 hour</p>
<p>Infrastructure provisioned but not running. On failure, restore from backup and replay logs. Lowest cost, highest risk.</p>
</div>
</div>
</div>
<div style="background: rgba(239, 68, 68, 0.1);border-radius: 12px; padding: 20px; margin: 20px 0">
<p><strong>Critical DR Considerations for Trading Systems:</strong></p>
<ol>
<li><strong>Geographic diversity</strong>: DR site must be in different seismic zone, power grid, and network backbone</li>
<li><strong>Regulatory requirements</strong>: Some jurisdictions require DR site within country borders</li>
<li><strong>Failover testing</strong>: Monthly failover drills to DR site (outside market hours)</li>
<li><strong>Data sovereignty</strong>: Audit data may need to remain in specific jurisdictions</li>
<li><strong>Communication plan</strong>: Clear runbook for notifying clients, regulators, and counterparties</li>
</ol>
</div>
</div>
<hr />
<h2 id="cross-cutting-concerns">Cross-Cutting Concerns</h2>
<div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px; padding: 32px; margin: 20px 0">
<h3 id="distributed-patterns">Distributed Systems Patterns Applied</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0">
<div style="background: rgba(88, 166, 255, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #58a6ff; font-weight: 700; margin-bottom: 12px">Event Sourcing</div>
<div style="color: #8b949e; font-size: 13px">
All state changes are stored as immutable events. Current state is derived by replaying events. Enables audit trail, debugging, and recovery. See [[event-sourcing]](/topics/system-design/event-sourcing).
</div>
</div>
<div style="background: rgba(126, 231, 135, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #7ee787; font-weight: 700; margin-bottom: 12px">CQRS</div>
<div style="color: #8b949e; font-size: 13px">
Separate write path (order submission) from read path (portfolio queries). Allows independent scaling and optimization. See [[cqrs]](/topics/system-design/cqrs).
</div>
</div>
<div style="background: rgba(137, 87, 229, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #a371f7; font-weight: 700; margin-bottom: 12px">Saga Pattern</div>
<div style="color: #8b949e; font-size: 13px">
Multi-step transactions (order -> risk check -> match -> settle) implemented as sequence of local transactions with compensating actions. See [[saga-pattern]](/topics/system-design/saga-pattern).
</div>
</div>
<div style="background: rgba(240, 136, 62, 0.1);border-radius: 12px; padding: 20px">
<div style="color: #f0883e; font-weight: 700; margin-bottom: 12px">Circuit Breaker</div>
<div style="color: #8b949e; font-size: 13px">
External dependencies (exchange connections, payment gateways) wrapped in circuit breakers. Fail fast rather than queue indefinitely. See [[circuit-breaker]](/topics/system-design/circuit-breaker).
</div>
</div>
</div>
<h3 id="technology-stack">Technology Stack Summary</h3>
<div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin: 20px 0">
<table>
<thead>
<tr>
<th>Component</th>
<th>Technology</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Order Book</strong></td>
<td>Redis Sorted Sets</td>
<td>O(log n) operations, sub-ms latency</td>
</tr>
<tr>
<td><strong>Event Store</strong></td>
<td>Apache Kafka</td>
<td>Durability, ordering, replay capability</td>
</tr>
<tr>
<td><strong>Hot Data</strong></td>
<td>TimescaleDB</td>
<td>Time-series optimized, SQL compatible</td>
</tr>
<tr>
<td><strong>Cold Archive</strong></td>
<td>S3 + Glacier</td>
<td>Cost-effective long-term retention</td>
</tr>
<tr>
<td><strong>Compute</strong></td>
<td>EKS / Kubernetes</td>
<td>Auto-scaling, standardized deployment</td>
</tr>
<tr>
<td><strong>Caching</strong></td>
<td>Redis Cluster</td>
<td>Session state, rate limiting, hot data</td>
</tr>
<tr>
<td><strong>Search</strong></td>
<td>Elasticsearch</td>
<td>Full-text search on audit logs</td>
</tr>
<tr>
<td><strong>Monitoring</strong></td>
<td>Prometheus + Grafana</td>
<td>Metrics, alerting, dashboards</td>
</tr>
</tbody>
</table>
</div>
<h3 id="final-synthesis">Final Interview Synthesis Question</h3>
<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 24px; margin: 20px 0">
<h4 id="walk-me-through-what-happens-when-a-user-clicks-buy-100-aapl-at-market-on-their-phone">&quot;Walk me through what happens when a user clicks 'Buy 100 AAPL at Market' on their phone.&quot;</h4>
<p><strong>Expected comprehensive answer covering all five sections:</strong></p>
<p><strong>1. Order Submission (Latency)</strong></p>
<ul>
<li>Mobile app sends HTTPS request to API gateway (50-200ms mobile network)</li>
<li>Gateway authenticates via JWT, rate limits, routes to order service</li>
<li>Order service validates: account exists, not restricted, sufficient buying power</li>
</ul>
<p><strong>2. Risk Check (Compliance)</strong></p>
<ul>
<li>Pre-trade risk engine checks position limits, credit limits, price reasonableness</li>
<li>Audit log entry created with timestamp, decision, and reasoning</li>
</ul>
<p><strong>3. Order Routing (Market Data)</strong></p>
<ul>
<li>Smart order router checks NBBO from all exchanges</li>
<li>Determines NYSE has best ask at $182.50</li>
<li>Routes order to NYSE (co-located server, ~5us network)</li>
</ul>
<p><strong>4. Matching (Matching Engine)</strong></p>
<ul>
<li>Order enters NYSE matching engine queue</li>
<li>Matches against resting sell orders at $182.50</li>
<li>Execution report generated within ~10us</li>
</ul>
<p><strong>5. Post-Trade (Settlement)</strong></p>
<ul>
<li>Execution report sent back to broker (~50us)</li>
<li>Portfolio updated in real-time</li>
<li>Trade queued for T+1 settlement</li>
<li>DTCC receives trade details for clearing</li>
<li>Next business day: Cash debited, shares credited</li>
<li>Audit record finalized with settlement status</li>
</ul>
<p><strong>Total user-visible latency</strong>: ~300ms (dominated by mobile network)<br />
<strong>Exchange latency</strong>: ~50 microseconds<br />
<strong>Settlement finality</strong>: T+1 (next business day)</p>
</div>
</div>
<hr />
<h2 id="related-topics">Related Topics</h2>
<ul>
<li><a href="/topics/trading/order-types">[order-types]</a> - Market, limit, stop orders explained</li>
<li><a href="/topics/trading/market-microstructure">[market-microstructure]</a> - How markets work at the millisecond level</li>
<li><a href="/topics/trading/hft">[high-frequency-trading]</a> - Algorithmic trading strategies</li>
<li><a href="/topics/system-design/distributed-transactions">[distributed-transactions]</a> - 2PC, Saga, and compensation</li>
<li><a href="/topics/system-design/event-sourcing">[event-sourcing]</a> - Immutable event logs</li>
<li><a href="/topics/system-design/cap-theorem">[cap-theorem]</a> - Consistency vs availability trade-offs</li>
<li><a href="/topics/system-design/kafka">[kafka]</a> - Distributed event streaming</li>
<li><a href="/topics/databases/redis">[redis]</a> - In-memory data structures</li>
</ul>
