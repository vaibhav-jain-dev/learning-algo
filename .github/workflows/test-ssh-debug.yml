name: Debug SSH Connection

on:
  workflow_dispatch:

jobs:
  debug-ssh:
    name: Debug SSH Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Check secrets are set
        run: |
          echo "=========================================="
          echo "  Checking GitHub Secrets"
          echo "=========================================="

          if [ -n "${{ secrets.SSH_HOST }}" ]; then
            echo "✓ SSH_HOST is set (length: ${#SSH_HOST})"
          else
            echo "✗ SSH_HOST is NOT set"
          fi

          if [ -n "${{ secrets.SSH_USERNAME }}" ]; then
            echo "✓ SSH_USERNAME is set (length: ${#SSH_USERNAME})"
          else
            echo "✗ SSH_USERNAME is NOT set"
          fi

          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            SSH_KEY_LEN="${#SSH_PRIVATE_KEY}"
            echo "✓ SSH_PRIVATE_KEY is set (length: $SSH_KEY_LEN)"

            # Check if it looks like a valid key
            if echo "${{ secrets.SSH_PRIVATE_KEY }}" | grep -q "BEGIN.*PRIVATE KEY"; then
              echo "  ✓ Key contains BEGIN PRIVATE KEY header"
            else
              echo "  ✗ Key does NOT contain BEGIN PRIVATE KEY header"
            fi

            if echo "${{ secrets.SSH_PRIVATE_KEY }}" | grep -q "END.*PRIVATE KEY"; then
              echo "  ✓ Key contains END PRIVATE KEY footer"
            else
              echo "  ✗ Key does NOT contain END PRIVATE KEY footer"
            fi
          else
            echo "✗ SSH_PRIVATE_KEY is NOT set"
          fi

          if [ -n "${{ secrets.SSH_PORT }}" ]; then
            echo "✓ SSH_PORT is set: ${{ secrets.SSH_PORT }}"
          else
            echo "○ SSH_PORT is NOT set (will use default: 22)"
          fi

      - name: Test DNS resolution
        run: |
          echo "=========================================="
          echo "  Testing DNS Resolution"
          echo "=========================================="

          if [ -n "${{ secrets.SSH_HOST }}" ]; then
            echo "Resolving: ${{ secrets.SSH_HOST }}"
            nslookup "${{ secrets.SSH_HOST }}" || echo "DNS resolution failed"
            echo ""
            ping -c 3 "${{ secrets.SSH_HOST }}" || echo "Ping failed (might be blocked)"
          fi

      - name: Setup SSH key and test
        if: success()
        run: |
          echo "=========================================="
          echo "  Setting up SSH Key"
          echo "=========================================="

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write SSH key
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Validate key file
          echo "Key file created, checking format..."
          if ssh-keygen -l -f ~/.ssh/deploy_key; then
            echo "✓ SSH key is valid"
          else
            echo "✗ SSH key validation failed"
            echo ""
            echo "Key file contents (first 2 lines):"
            head -2 ~/.ssh/deploy_key
            exit 1
          fi

      - name: Test SSH connection (verbose)
        if: success()
        run: |
          echo "=========================================="
          echo "  Testing SSH Connection (VERBOSE)"
          echo "=========================================="
          echo "Host: ${{ secrets.SSH_HOST }}"
          echo "User: ${{ secrets.SSH_USERNAME }}"
          echo "Port: ${{ secrets.SSH_PORT || 22 }}"
          echo "=========================================="

          # Add host to known_hosts
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

          # Try connection with verbose output
          ssh -vvv -o BatchMode=yes \
              -o ConnectTimeout=30 \
              -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              -p ${{ secrets.SSH_PORT || 22 }} \
              ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
              "echo 'Connection successful'; uname -a" 2>&1 || {
            echo ""
            echo "=========================================="
            echo "SSH CONNECTION FAILED"
            echo "=========================================="
            exit 1
          }

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
