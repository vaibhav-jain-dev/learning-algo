# Docker Compose Deployment via SSH
#
# This workflow deploys a Docker Compose application to a remote server using
# a single SSH session. It handles code synchronization, container management,
# and environment variable handling safely.
#
# Required Secrets:
#   - SSH_PRIVATE_KEY: Private key for SSH authentication (required)
#   - SSH_HOST: Server IP or hostname (can be in Secrets or Variables)
#   - SSH_USERNAME: SSH user (can be in Secrets or Variables)
#
# Optional Secrets:
#   - SSH_PORT: SSH port (default: 22)
#   - ENV_FILE: Content of .env file for the application (optional)
#   - ENV_VARS: Environment variables (optional, base64 encoded for safety)

name: Deploy Docker Compose
run-name: "Deploy: ${{ github.event.head_commit.message }}"

on:
  # Automatic deployment on push to master
  push:
    branches:
      - master
      - main

  # Manual trigger also available
  workflow_dispatch:
    inputs:
      force_restart:
        description: 'Force restart (teardown and rebuild all containers)'
        required: false
        default: false
        type: boolean
      project_path:
        description: 'Custom project path on server (default: /projects/<repo-name>)'
        required: false
        type: string

env:
  DEFAULT_PROJECT_BASE: /projects

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      has_env_file: ${{ steps.check.outputs.has_env_file }}
      has_env_vars: ${{ steps.check.outputs.has_env_vars }}
      validation_passed: ${{ steps.check.outputs.validation_passed }}
    steps:
      - name: Check required secrets and variables
        id: check
        run: |
          echo "=========================================="
          echo "  Configuration Validation"
          echo "=========================================="
          echo ""

          VALIDATION_PASSED=true
          MISSING_KEYS=""

          # Check SSH_HOST (can be secret or variable)
          echo "[Checking] SSH_HOST..."
          if [ -n "${{ secrets.SSH_HOST }}" ] || [ -n "${{ vars.SSH_HOST }}" ]; then
            echo "  ✓ SSH_HOST: Present"
          else
            echo "  ✗ SSH_HOST: MISSING"
            MISSING_KEYS="${MISSING_KEYS}\n  - SSH_HOST (Add to Secrets or Variables)"
            VALIDATION_PASSED=false
          fi

          # Check SSH_USERNAME (can be secret or variable)
          echo "[Checking] SSH_USERNAME..."
          if [ -n "${{ secrets.SSH_USERNAME }}" ] || [ -n "${{ vars.SSH_USERNAME }}" ]; then
            echo "  ✓ SSH_USERNAME: Present"
          else
            echo "  ✗ SSH_USERNAME: MISSING"
            MISSING_KEYS="${MISSING_KEYS}\n  - SSH_USERNAME (Add to Secrets or Variables)"
            VALIDATION_PASSED=false
          fi

          # Check SSH_PRIVATE_KEY (must be secret)
          echo "[Checking] SSH_PRIVATE_KEY..."
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "  ✓ SSH_PRIVATE_KEY: Present (from Secrets)"
          else
            echo "  ✗ SSH_PRIVATE_KEY: MISSING (REQUIRED)"
            MISSING_KEYS="${MISSING_KEYS}\n  - SSH_PRIVATE_KEY (MUST be added to Secrets, not Variables)"
            VALIDATION_PASSED=false
          fi

          # Check SSH_PORT (optional, can be secret or variable)
          echo "[Checking] SSH_PORT..."
          if [ -n "${{ secrets.SSH_PORT }}" ] || [ -n "${{ vars.SSH_PORT }}" ]; then
            echo "  ✓ SSH_PORT: Present"
          else
            echo "  ○ SSH_PORT: Not set (will use default: 22)"
          fi

          # Check ENV_FILE (optional)
          echo "[Checking] ENV_FILE..."
          if [ -n "${{ secrets.ENV_FILE }}" ]; then
            echo "  ✓ ENV_FILE: Present (from Secrets)"
            echo "has_env_file=true" >> $GITHUB_OUTPUT
          else
            echo "  ○ ENV_FILE: Not configured (optional)"
            echo "has_env_file=false" >> $GITHUB_OUTPUT
          fi

          # Check ENV_VARS (optional)
          echo "[Checking] ENV_VARS..."
          if [ -n "${{ secrets.ENV_VARS }}" ]; then
            echo "  ✓ ENV_VARS: Present (from Secrets)"
            echo "has_env_vars=true" >> $GITHUB_OUTPUT
          else
            echo "  ○ ENV_VARS: Not configured (optional)"
            echo "has_env_vars=false" >> $GITHUB_OUTPUT
          fi

          echo ""
          echo "=========================================="

          if [ "$VALIDATION_PASSED" = "false" ]; then
            echo ""
            echo "❌ VALIDATION FAILED"
            echo ""
            echo "Missing required configuration:"
            echo -e "$MISSING_KEYS"
            echo ""
            echo "=========================================="
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo ""
          echo "✅ All required configuration present"
          echo "validation_passed=true" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.validation_passed == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Determine project path
        id: project
        run: |
          if [ -n "${{ inputs.project_path }}" ]; then
            PROJECT_PATH="${{ inputs.project_path }}"
          else
            PROJECT_PATH="${{ env.DEFAULT_PROJECT_BASE }}/${{ github.event.repository.name }}"
          fi
          echo "path=$PROJECT_PATH" >> $GITHUB_OUTPUT
          echo "Project will be deployed to: $PROJECT_PATH"

      - name: Run deploy.sh locally (deploys to remote server via SSH)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || vars.SSH_HOST }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME || vars.SSH_USERNAME }}
          SSH_PORT: ${{ secrets.SSH_PORT || vars.SSH_PORT || '22' }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          PROJECT_PATH: ${{ steps.project.outputs.path }}
          FORCE_RESTART: ${{ inputs.force_restart || 'false' }}
          ENV_VARS_B64: ${{ secrets.ENV_VARS }}
        run: |
          # Encode ENV_VARS to base64 if present
          if [ -n "$ENV_VARS_B64" ]; then
            export ENV_VARS_B64=$(printf '%s' "$ENV_VARS_B64" | base64 -w0)
          fi

          # Use the SSH key we created
          export SSH_PRIVATE_KEY="$HOME/.ssh/deploy_key"

          # Make deploy.sh executable and run it
          chmod +x scripts/deploy.sh

          # Run deploy.sh and capture output
          ./scripts/deploy.sh | tee /tmp/deploy_output.txt

          # Extract metrics and write to job summary
          echo "## Deployment Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract metrics table from output (between "Deployment Metrics:" and "Application URLs:")
          sed -n '/Deployment Metrics:/,/Application URLs:/p' /tmp/deploy_output.txt | \
            grep -v "Application URLs:" | \
            sed 's/\x1b\[[0-9;]*m//g' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract deployment info
          DEPLOYED_INFO=$(grep "Deployed:" /tmp/deploy_output.txt | sed 's/\x1b\[[0-9;]*m//g')
          echo "$DEPLOYED_INFO" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          echo "SSH key cleaned up"
