# DSAlgo Learn Platform - Development Dockerfile
# Optimized for hot-reload development with minimal footprint
#
# DEPENDENCY CACHING STRATEGY:
# Dependency files (go.mod, requirements.txt, package.json) are copied BEFORE
# source code. This creates cached layers that only rebuild when deps change.
# At runtime, source is overridden by volume mounts for hot reload.
#
# IMPORTANT: Requires Docker BuildKit (DOCKER_BUILDKIT=1 or Docker 23.0+)

FROM golang:1.21-alpine

# Install minimal dependencies and wkhtmltopdf for PDF generation
RUN apk add --no-cache \
    python3 \
    py3-pip \
    git \
    nodejs \
    npm \
    wget \
    fontconfig \
    libgcc \
    libstdc++ \
    libx11 \
    libxrender \
    libxext \
    libssl3 \
    musl \
    && wget -q -O /tmp/wkhtmltopdf.apk \
    https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltopdf-0.12.6-1.alpine318.x86_64.apk \
    && apk add --allow-untrusted /tmp/wkhtmltopdf.apk \
    && rm -f /tmp/wkhtmltopdf.apk \
    && rm -rf /var/cache/apk/*

# Install air for Go hot reload
RUN go install github.com/air-verse/air@latest

WORKDIR /app

# =============================================================================
# DEPENDENCY CACHING with BuildKit cache mounts
# =============================================================================

# Python dependencies (cached layer)
COPY requirements.txt ./
RUN pip install --no-cache-dir --break-system-packages -r requirements.txt 2>/dev/null || true

# Frontend dependencies (cached layer)
COPY frontend/package*.json ./frontend/
RUN cd frontend && npm install 2>/dev/null || true

# =============================================================================
# Copy all source code (will be overridden by volume mounts at runtime)
# =============================================================================
COPY backend/ ./backend/

# Go dependencies - run go mod tidy to download deps with complete go.sum
# BuildKit cache mount persists modules across builds
RUN --mount=type=cache,target=/go/pkg/mod \
    cd backend && go mod tidy
COPY frontend/ ./frontend/
COPY problems/ ./problems/
COPY topics/ ./topics/

EXPOSE 8080

# Run with air for hot reload
CMD ["air", "-c", ".air.toml"]
