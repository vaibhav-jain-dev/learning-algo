# DSAlgo Learn Platform - Development Dockerfile
# Optimized for hot-reload development with minimal footprint
#
# DEPENDENCY CACHING STRATEGY:
# Uses Docker BuildKit cache mounts to persist dependencies across builds.
# At runtime, source is overridden by volume mounts for hot reload.
#
# IMPORTANT: Requires Docker BuildKit (DOCKER_BUILDKIT=1 or Docker 23.0+)

FROM golang:1.21-alpine

# Install minimal dependencies
RUN apk add --no-cache \
    python3 \
    py3-pip \
    git \
    nodejs \
    npm \
    && rm -rf /var/cache/apk/*

# Install air for Go hot reload
RUN go install github.com/air-verse/air@latest

WORKDIR /app

# =============================================================================
# DEPENDENCY CACHING with BuildKit cache mounts
# =============================================================================

# Python dependencies (cached layer)
COPY requirements.txt ./
RUN pip install --no-cache-dir --break-system-packages -r requirements.txt 2>/dev/null || true

# Frontend dependencies (cached layer)
COPY frontend/package*.json ./frontend/
RUN cd frontend && npm install 2>/dev/null || true

# =============================================================================
# Copy all source code (will be overridden by volume mounts at runtime)
# =============================================================================
COPY backend/ ./backend/
COPY frontend/ ./frontend/
COPY problems/ ./problems/
COPY topics/ ./topics/

# Download Go dependencies (uses BuildKit cache)
RUN --mount=type=cache,target=/go/pkg/mod \
    cd backend && go mod tidy

EXPOSE 8080

# Run with air for hot reload
CMD ["air", "-c", ".air.toml"]
