<link rel="stylesheet" href="/static/css/interview-questions.css">

<div class="interview-topic-layout">
    <a href="/interview-question" class="back-to-dashboard">‚Üê Back to All Topics</a>

    <h1>üîî Notification System Design</h1>
    <p class="topic-description">Design a multi-channel notification system supporting Push, Email, SMS, In-App at massive scale</p>

    <div class="quick-nav">
        <h4>Navigation</h4>
        <a href="#mvp">MVP Stage</a>
        <a href="#pan-india">PAN-India</a>
        <a href="#high-traffic">High Traffic</a>
        <a href="#global">Global</a>
    </div>

    <!-- ============================================ -->
    <!-- MVP STAGE -->
    <!-- ============================================ -->
    <div class="stage-section" id="mvp">
        <div class="stage-header">
            <span class="stage-badge mvp">MVP Stage</span>
            <h2 style="margin: 0;">Single Region ‚Ä¢ 100K users ‚Ä¢ 1M notifications/day</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>üìã Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Push notifications (FCM/APNS)</li>
                        <li>Email notifications (transactional)</li>
                        <li>SMS notifications (OTP, alerts)</li>
                        <li>In-app notifications (bell icon)</li>
                        <li>User preference management (opt-in/out)</li>
                        <li>Scheduled notifications</li>
                        <li>Template-based content with personalization</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Delivery latency: &lt;30s for transactional</li>
                        <li>Throughput: 10K notifications/min</li>
                        <li>Reliability: 99.9% delivery rate</li>
                        <li>Deduplication: No duplicate sends</li>
                        <li>Retry: Exponential backoff on failure</li>
                        <li>Rate limiting: Per user anti-spam</li>
                        <li>Audit: Full delivery tracking</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE DIAGRAM -->
        <h3>üèóÔ∏è Architecture</h3>
        <div class="diagram-container">
            <h4>MVP Architecture - Event-Driven</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <!-- Layer 1: Producers -->
                <div style="display: flex; gap: 40px;">
                    <div class="arch-box client">Order Service</div>
                    <div class="arch-box client">Auth Service</div>
                    <div class="arch-box client">Marketing Service</div>
                </div>
                <div class="arch-arrow">‚Üì</div>

                <!-- Layer 2: API Gateway -->
                <div class="arch-box lb">API Gateway<br><small>Rate limiting, Auth</small></div>
                <div class="arch-arrow">‚Üì</div>

                <!-- Layer 3: Notification Service -->
                <div class="arch-box server">Notification Service<br><small>Validation, Dedup, Routing</small></div>
                <div class="arch-arrow">‚Üì</div>

                <!-- Layer 4: Message Queue -->
                <div class="arch-box queue">Kafka<br><small>Priority Topics (critical, high, medium, low)</small></div>
                <div class="arch-arrow">‚Üì</div>

                <!-- Layer 5: Workers -->
                <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                    <div class="arch-box worker">Push Worker<br><small>FCM/APNS</small></div>
                    <div class="arch-box worker">Email Worker<br><small>SES</small></div>
                    <div class="arch-box worker">SMS Worker<br><small>Twilio</small></div>
                    <div class="arch-box worker">In-App Worker<br><small>WebSocket</small></div>
                </div>
                <div class="arch-arrow">‚Üì</div>

                <!-- Layer 6: Providers -->
                <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                    <div class="arch-box external">FCM</div>
                    <div class="arch-box external">APNS</div>
                    <div class="arch-box external">Amazon SES</div>
                    <div class="arch-box external">Twilio</div>
                </div>
                <div class="arch-arrow">‚Üì</div>

                <!-- Layer 7: Data -->
                <div style="display: flex; gap: 40px; align-items: flex-start;">
                    <div style="text-align: center;">
                        <div class="arch-box db">PostgreSQL<br><small>Notifications, Templates</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Primary + Read Replica</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box cache">Redis<br><small>Dedup, Rate Limit</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">TTL-based dedup keys</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW -->
        <h3>üîÑ Data Flow - Send Notification</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Producer</div>
                    <div class="flow-step-label">POST /send</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Notification Svc</div>
                    <div class="flow-step-label">Validate + Dedup</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box queue" style="padding: 10px 16px;">Kafka</div>
                    <div class="flow-step-label">Route to topic</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box worker" style="padding: 10px 16px;">Channel Worker</div>
                    <div class="flow-step-label">Render template</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box external" style="padding: 10px 16px;">Provider</div>
                    <div class="flow-step-label">Deliver</div>
                </div>
            </div>
        </div>

        <h3>üîÑ Data Flow - Delivery Status Update</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box external" style="padding: 10px 16px;">Provider</div>
                    <div class="flow-step-label">Webhook callback</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Webhook Handler</div>
                    <div class="flow-step-label">Parse status</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box db" style="padding: 10px 16px;">delivery_logs</div>
                    <div class="flow-step-label">Update status</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box cache" style="padding: 10px 16px;">Analytics</div>
                    <div class="flow-step-label">Increment counters</div>
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div style="color: #ef4444; font-weight: 600;">Failure path:</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box queue" style="padding: 10px 16px;">Retry Queue</div>
                <div class="arch-arrow">‚Üí</div>
                <div>Exponential backoff (1s, 2s, 4s, 8s...)</div>
            </div>
        </div>

        <!-- DATABASE SCHEMA -->
        <h3>üóÑÔ∏è Database Schema</h3>
        <div class="diagram-container">
            <h4>PostgreSQL Schema with Relationships</h4>
            <div class="schema-diagram">
                <div class="schema-table">
                    <div class="schema-table-header">üì¶ notification_templates</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-idx">name</span><span class="field-type">VARCHAR(100) UNIQUE</span></div>
                        <div class="schema-field"><span class="field-name">channel</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">subject_template</span><span class="field-type">TEXT</span></div>
                        <div class="schema-field"><span class="field-name">body_template</span><span class="field-type">TEXT</span></div>
                        <div class="schema-field"><span class="field-name">variables_schema</span><span class="field-type">JSONB</span></div>
                        <div class="schema-field"><span class="field-name">is_active</span><span class="field-type">BOOLEAN</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
                    <span>N</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">üîî notifications</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK ‚Üí users.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">template_id</span><span class="field-type">UUID FK ‚Üí templates.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">channel</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">priority</span><span class="field-type">VARCHAR(10)</span></div>
                        <div class="schema-field"><span class="field-name">variables</span><span class="field-type">JSONB</span></div>
                        <div class="schema-field"><span class="field-name field-idx">idempotency_key</span><span class="field-type">VARCHAR(64) UNIQUE</span></div>
                        <div class="schema-field"><span class="field-name">scheduled_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">sent_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">‚öôÔ∏è user_preferences</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk field-idx">user_id</span><span class="field-type">UUID FK UNIQUE</span></div>
                        <div class="schema-field"><span class="field-name">push_enabled</span><span class="field-type">BOOLEAN DEFAULT true</span></div>
                        <div class="schema-field"><span class="field-name">email_enabled</span><span class="field-type">BOOLEAN DEFAULT true</span></div>
                        <div class="schema-field"><span class="field-name">sms_enabled</span><span class="field-type">BOOLEAN DEFAULT true</span></div>
                        <div class="schema-field"><span class="field-name">in_app_enabled</span><span class="field-type">BOOLEAN DEFAULT true</span></div>
                        <div class="schema-field"><span class="field-name">quiet_hours_start</span><span class="field-type">TIME</span></div>
                        <div class="schema-field"><span class="field-name">quiet_hours_end</span><span class="field-type">TIME</span></div>
                        <div class="schema-field"><span class="field-name">timezone</span><span class="field-type">VARCHAR(50)</span></div>
                        <div class="schema-field"><span class="field-name">category_prefs</span><span class="field-type">JSONB</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
                    <span>N</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">üì± device_tokens</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk field-idx">user_id</span><span class="field-type">UUID FK ‚Üí users.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">token</span><span class="field-type">VARCHAR(255) UNIQUE</span></div>
                        <div class="schema-field"><span class="field-name">platform</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">device_id</span><span class="field-type">VARCHAR(100)</span></div>
                        <div class="schema-field"><span class="field-name">is_active</span><span class="field-type">BOOLEAN DEFAULT true</span></div>
                        <div class="schema-field"><span class="field-name">last_used_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">üìä delivery_logs</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk field-idx">notification_id</span><span class="field-type">UUID FK ‚Üí notifications.id</span></div>
                        <div class="schema-field"><span class="field-name">provider</span><span class="field-type">VARCHAR(50)</span></div>
                        <div class="schema-field"><span class="field-name">provider_message_id</span><span class="field-type">VARCHAR(100)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">error_code</span><span class="field-type">VARCHAR(50)</span></div>
                        <div class="schema-field"><span class="field-name">error_message</span><span class="field-type">TEXT</span></div>
                        <div class="schema-field"><span class="field-name">attempt_number</span><span class="field-type">INT</span></div>
                        <div class="schema-field"><span class="field-name">delivered_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">opened_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">clicked_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>
            </div>

            <!-- Index Justification -->
            <div class="index-justification" style="margin-top: 24px;">
                <h5>üîç Index Strategy</h5>
                <table style="width: 100%; font-size: 14px;">
                    <tr>
                        <td><code>idx_notifications_user_status</code></td>
                        <td>B-tree on <code>(user_id, status)</code></td>
                        <td>User's notification inbox with filtering</td>
                    </tr>
                    <tr>
                        <td><code>idx_notifications_idempotency</code></td>
                        <td>B-tree UNIQUE on <code>idempotency_key</code></td>
                        <td>Deduplication check - prevent double sends</td>
                    </tr>
                    <tr>
                        <td><code>idx_notifications_scheduled</code></td>
                        <td>B-tree on <code>scheduled_at</code></td>
                        <td>Scheduler job: SELECT WHERE scheduled_at <= NOW()</td>
                    </tr>
                    <tr>
                        <td><code>idx_device_tokens_user</code></td>
                        <td>B-tree on <code>user_id</code></td>
                        <td>Fetch all user's devices for push</td>
                    </tr>
                    <tr>
                        <td><code>idx_delivery_logs_notification</code></td>
                        <td>B-tree on <code>notification_id</code></td>
                        <td>Fetch delivery history for a notification</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- SQL Queries -->
        <h3>üìù SQL Queries</h3>
        <div class="sql-query">
            <h5>Create Tables</h5>
<pre>CREATE TABLE notification_templates (
    id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name              VARCHAR(100) UNIQUE NOT NULL,
    channel           VARCHAR(20) NOT NULL,
    subject_template  TEXT,
    body_template     TEXT NOT NULL,
    variables_schema  JSONB DEFAULT '{}',
    is_active         BOOLEAN DEFAULT true,
    created_at        TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE notifications (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id),
    template_id     UUID REFERENCES notification_templates(id),
    channel         VARCHAR(20) NOT NULL,
    status          VARCHAR(20) DEFAULT 'pending',
    priority        VARCHAR(10) DEFAULT 'medium',
    variables       JSONB DEFAULT '{}',
    idempotency_key VARCHAR(64) UNIQUE,
    scheduled_at    TIMESTAMPTZ,
    sent_at         TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE user_preferences (
    id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id           UUID UNIQUE NOT NULL REFERENCES users(id),
    push_enabled      BOOLEAN DEFAULT true,
    email_enabled     BOOLEAN DEFAULT true,
    sms_enabled       BOOLEAN DEFAULT true,
    in_app_enabled    BOOLEAN DEFAULT true,
    quiet_hours_start TIME,
    quiet_hours_end   TIME,
    timezone          VARCHAR(50) DEFAULT 'UTC',
    category_prefs    JSONB DEFAULT '{}',
    created_at        TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE device_tokens (
    id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id      UUID NOT NULL REFERENCES users(id),
    token        VARCHAR(255) UNIQUE NOT NULL,
    platform     VARCHAR(20) NOT NULL,
    device_id    VARCHAR(100),
    is_active    BOOLEAN DEFAULT true,
    last_used_at TIMESTAMPTZ,
    created_at   TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE delivery_logs (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    notification_id     UUID NOT NULL REFERENCES notifications(id),
    provider            VARCHAR(50) NOT NULL,
    provider_message_id VARCHAR(100),
    status              VARCHAR(20) NOT NULL,
    error_code          VARCHAR(50),
    error_message       TEXT,
    attempt_number      INT DEFAULT 1,
    delivered_at        TIMESTAMPTZ,
    opened_at           TIMESTAMPTZ,
    clicked_at          TIMESTAMPTZ,
    created_at          TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_notifications_user_status ON notifications(user_id, status);
CREATE INDEX idx_notifications_scheduled ON notifications(scheduled_at) WHERE scheduled_at IS NOT NULL;
CREATE INDEX idx_device_tokens_user ON device_tokens(user_id) WHERE is_active = true;
CREATE INDEX idx_delivery_logs_notification ON delivery_logs(notification_id);</pre>
        </div>

        <div class="sql-query">
            <h5>API Queries</h5>
<pre>-- Fetch user preferences with channel check
SELECT push_enabled, email_enabled, sms_enabled, in_app_enabled,
       quiet_hours_start, quiet_hours_end, timezone, category_prefs
FROM user_preferences WHERE user_id = $1;

-- Get user's active device tokens for push
SELECT token, platform FROM device_tokens
WHERE user_id = $1 AND is_active = true;

-- Fetch user's recent notifications (inbox)
SELECT n.id, n.channel, n.status, n.created_at,
       t.name as template_name, n.variables
FROM notifications n
LEFT JOIN notification_templates t ON n.template_id = t.id
WHERE n.user_id = $1
ORDER BY n.created_at DESC LIMIT 50;

-- Deduplication check before sending
SELECT EXISTS(SELECT 1 FROM notifications WHERE idempotency_key = $1);

-- Fetch scheduled notifications for processing
SELECT id, user_id, template_id, channel, variables, priority
FROM notifications
WHERE status = 'scheduled' AND scheduled_at <= NOW()
ORDER BY priority DESC, scheduled_at ASC
LIMIT 1000 FOR UPDATE SKIP LOCKED;

-- Batch insert for bulk notifications
INSERT INTO notifications (user_id, template_id, channel, priority, variables, idempotency_key)
SELECT unnest($1::uuid[]), $2, $3, $4, $5, unnest($6::varchar[]);</pre>
        </div>

        <!-- API Design -->
        <h3>üîå API Design</h3>
        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/notifications/send</span>
<pre>
Request:
{
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "template": "order_confirmation",
    "channels": ["push", "email"],
    "variables": {
        "order_id": "ORD-12345",
        "amount": "599.00",
        "currency": "INR"
    },
    "priority": "high",
    "idempotency_key": "order-12345-confirm"
}

Response: 202 Accepted
{
    "notification_id": "660e8400-e29b-41d4-a716-446655440001",
    "status": "queued",
    "channels_targeted": ["push", "email"],
    "estimated_delivery": "< 30 seconds"
}

Errors:
- 400: Invalid template or missing required variables
- 404: User not found
- 409: Duplicate idempotency_key (already sent)
- 429: Rate limit exceeded for user</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/notifications/bulk</span>
<pre>
Request:
{
    "user_ids": ["uuid1", "uuid2", "uuid3"],
    "segment": "premium_users",           // alternative to user_ids
    "template": "promo_offer",
    "channels": ["push"],
    "variables": {
        "offer_code": "SAVE20",
        "expiry": "2024-02-01"
    },
    "priority": "low",
    "schedule_at": "2024-01-15T10:00:00Z" // optional
}

Response: 202 Accepted
{
    "batch_id": "batch-550e8400",
    "total_recipients": 15000,
    "status": "processing",
    "estimated_completion": "2024-01-15T10:05:00Z"
}</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method get">GET</span> <span class="api-path">/api/v1/notifications/user/:userId</span>
<pre>
Response: 200 OK
{
    "notifications": [
        {
            "id": "notif-001",
            "template": "order_shipped",
            "channel": "push",
            "status": "delivered",
            "title": "Your order is on the way!",
            "body": "Order #12345 shipped via BlueDart",
            "read": false,
            "created_at": "2024-01-14T15:30:00Z"
        }
    ],
    "unread_count": 5,
    "pagination": {
        "cursor": "eyJpZCI6MTAwfQ==",
        "has_more": true
    }
}</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method websocket">WS</span> <span class="api-path">/ws/notifications</span>
<pre>
// WebSocket for real-time in-app notifications
Connect: wss://api.example.com/ws/notifications?token=jwt

// Server pushes new notifications
{
    "type": "notification",
    "payload": {
        "id": "notif-002",
        "title": "Payment received!",
        "body": "‚Çπ599 credited to your wallet",
        "action_url": "/wallet"
    }
}

// Client acknowledges read
{
    "type": "mark_read",
    "notification_ids": ["notif-001", "notif-002"]
}</pre>
        </div>

        <!-- Message Queue Alternatives -->
        <h3>üîÄ Message Queue Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>‚úÖ Apache Kafka (Selected)</h5>
                <p>High throughput, ordering, replay capability</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Millions msg/sec throughput</li>
                            <li>Message replay for debugging</li>
                            <li>Partition-level ordering</li>
                            <li>Consumer groups for scaling</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Operational complexity</li>
                            <li>Higher latency (batching)</li>
                            <li>ZooKeeper dependency</li>
                        </ul>
                    </div>
                </div>
                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; font-size: 13px;">
                    <strong>‚ö†Ô∏è Config:</strong> Use separate topics per priority. Partition by user_id for ordering.
                </div>
            </div>

            <div class="alternative-card">
                <h5>Amazon SQS</h5>
                <p>Serverless, zero ops, pay-per-message</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Zero operational overhead<br>
                    <span style="color: #22c55e;">‚úì</span> FIFO queues for ordering<br>
                    <span style="color: #22c55e;">‚úì</span> Dead letter queues built-in<br>
                    <span style="color: #ef4444;">‚úó</span> 120K msg/sec limit per queue<br>
                    <span style="color: #ef4444;">‚úó</span> No message replay
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> AWS-native, lower volume, want zero ops
                </div>
            </div>

            <div class="alternative-card">
                <h5>RabbitMQ</h5>
                <p>Flexible routing, priority queues native</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Native priority queue support<br>
                    <span style="color: #22c55e;">‚úì</span> Complex routing (exchanges)<br>
                    <span style="color: #22c55e;">‚úì</span> Lower latency than Kafka<br>
                    <span style="color: #ef4444;">‚úó</span> Lower throughput ceiling<br>
                    <span style="color: #ef4444;">‚úó</span> No built-in replay
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Complex routing needs, lower scale
                </div>
            </div>
        </div>

        <!-- Push Provider Alternatives -->
        <h3>üîÄ Push Provider Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>‚úÖ FCM + APNS (Selected)</h5>
                <p>Direct integration with platform providers</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Free unlimited notifications</li>
                            <li>Direct platform integration</li>
                            <li>Rich notification support</li>
                            <li>Topic-based broadcasting</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Separate APIs (FCM/APNS)</li>
                            <li>Token management complexity</li>
                            <li>Limited analytics</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="alternative-card">
                <h5>OneSignal</h5>
                <p>Unified API, rich analytics, segmentation</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Single API for all platforms<br>
                    <span style="color: #22c55e;">‚úì</span> Built-in A/B testing<br>
                    <span style="color: #22c55e;">‚úì</span> Automatic retry handling<br>
                    <span style="color: #ef4444;">‚úó</span> Cost at scale ($0.002/msg)<br>
                    <span style="color: #ef4444;">‚úó</span> Vendor lock-in
                </div>
            </div>

            <div class="alternative-card">
                <h5>AWS SNS Mobile Push</h5>
                <p>AWS-native, unified platform endpoints</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> AWS ecosystem integration<br>
                    <span style="color: #22c55e;">‚úì</span> Unified API abstraction<br>
                    <span style="color: #22c55e;">‚úì</span> $0.50 per million<br>
                    <span style="color: #ef4444;">‚úó</span> Limited analytics<br>
                    <span style="color: #ef4444;">‚úó</span> Basic feature set
                </div>
            </div>
        </div>

        <!-- Email Provider Alternatives -->
        <h3>üîÄ Email Provider Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>‚úÖ Amazon SES (Selected)</h5>
                <p>Cost-effective, high deliverability, AWS-native</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>$0.10 per 1000 emails</li>
                            <li>High deliverability (DKIM, SPF)</li>
                            <li>Native AWS integration</li>
                            <li>Dedicated IPs available</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Basic templating</li>
                            <li>Limited analytics UI</li>
                            <li>Sandbox restrictions initially</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="alternative-card">
                <h5>SendGrid</h5>
                <p>Developer-friendly, excellent deliverability</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Visual template editor<br>
                    <span style="color: #22c55e;">‚úì</span> Detailed analytics<br>
                    <span style="color: #22c55e;">‚úì</span> Webhook events<br>
                    <span style="color: #ef4444;">‚úó</span> Higher cost ($15/50K)<br>
                    <span style="color: #ef4444;">‚úó</span> Rate limits on lower tiers
                </div>
            </div>

            <div class="alternative-card">
                <h5>Mailgun</h5>
                <p>Developer-focused, powerful API</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Excellent API design<br>
                    <span style="color: #22c55e;">‚úì</span> Email validation service<br>
                    <span style="color: #22c55e;">‚úì</span> Detailed logs<br>
                    <span style="color: #ef4444;">‚úó</span> $0.80 per 1000 emails<br>
                    <span style="color: #ef4444;">‚úó</span> EU data residency extra cost
                </div>
            </div>
        </div>

        <!-- Design Patterns -->
        <h3>üß© Design Patterns Used</h3>
        <div class="patterns-grid">
            <div class="pattern-card">
                <h5>Template Method Pattern</h5>
                <p>Base NotificationSender with abstract send(). EmailSender, PushSender, SMSSender override with channel-specific logic while sharing validation, logging.</p>
            </div>
            <div class="pattern-card">
                <h5>Strategy Pattern</h5>
                <p>ChannelStrategy interface. Runtime selection based on user preferences and notification type. Easy to add WhatsApp, Slack channels.</p>
            </div>
            <div class="pattern-card">
                <h5>Observer Pattern</h5>
                <p>DeliveryStatusObserver notified on status changes. Triggers analytics update, user badge refresh, retry scheduling.</p>
            </div>
            <div class="pattern-card">
                <h5>Retry with Exponential Backoff</h5>
                <p>On provider failure: retry after 1s, 2s, 4s, 8s, 16s. Max 5 attempts. Move to DLQ after exhaustion. Jitter to avoid thundering herd.</p>
            </div>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">Retry with Exponential Backoff Implementation</h5>
<pre>type RetryConfig struct {
    MaxAttempts     int
    InitialDelay    time.Duration
    MaxDelay        time.Duration
    BackoffFactor   float64
}

func (w *Worker) sendWithRetry(ctx context.Context, notif Notification) error {
    config := RetryConfig{
        MaxAttempts:   5,
        InitialDelay:  1 * time.Second,
        MaxDelay:      30 * time.Second,
        BackoffFactor: 2.0,
    }

    var lastErr error
    delay := config.InitialDelay

    for attempt := 1; attempt <= config.MaxAttempts; attempt++ {
        err := w.provider.Send(ctx, notif)
        if err == nil {
            return nil
        }

        lastErr = err
        if !isRetryable(err) {
            return fmt.Errorf("non-retryable error: %w", err)
        }

        // Add jitter: ¬±25% randomization
        jitter := delay / 4
        sleepTime := delay + time.Duration(rand.Int63n(int64(jitter*2))) - jitter

        log.Printf("Attempt %d failed, retrying in %v: %v", attempt, sleepTime, err)
        time.Sleep(sleepTime)

        delay = time.Duration(float64(delay) * config.BackoffFactor)
        if delay > config.MaxDelay {
            delay = config.MaxDelay
        }
    }

    // Move to Dead Letter Queue
    w.dlq.Publish(notif)
    return fmt.Errorf("max retries exceeded: %w", lastErr)
}</pre>
        </div>

        <!-- AWS Cost Estimation -->
        <h3>üí∞ AWS Cost Estimation (MVP)</h3>
        <div class="feature-card">
            <table class="cost-table">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Spec</th>
                        <th>Monthly Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="cost-tag aws">SES</span> Email (1M emails)</td>
                        <td>$0.10 per 1000 emails</td>
                        <td>$100</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">SNS</span> Push (1M notifications)</td>
                        <td>$0.50 per 1M mobile push</td>
                        <td>$1</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">Lambda</span> Workers (1M invocations)</td>
                        <td>128MB, 500ms avg duration</td>
                        <td>$15</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">SQS</span> Message Queue</td>
                        <td>1M requests</td>
                        <td>$0.40</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">RDS</span> PostgreSQL</td>
                        <td>db.t3.medium, Multi-AZ</td>
                        <td>$140</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">ElastiCache</span> Redis</td>
                        <td>cache.t3.small (dedup, rate limit)</td>
                        <td>$25</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag external">Twilio</span> SMS (100K)</td>
                        <td>$0.0075 per SMS (India)</td>
                        <td>$750</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="2"><strong>Total MVP Monthly</strong></td>
                        <td><strong>~$1,031/month</strong></td>
                    </tr>
                </tbody>
            </table>
            <p style="font-size: 13px; color: #64748b; margin-top: 12px;">* SMS is typically the highest cost. Consider push-first strategy to reduce costs.</p>
        </div>

        <!-- Deployment -->
        <h3>üöÄ Deployment (K8s)</h3>
        <div class="deployment-diagram">
            <h4>Kubernetes Architecture - Separate Workers per Channel</h4>
            <div class="k8s-cluster">
                <h5>EKS Cluster - ap-south-1</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                    <div class="k8s-pod">üî∑ notification-api (replicas: 3)</div>
                    <div class="k8s-pod">üî∑ api-hpa (min:2, max:20)</div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                    <div class="k8s-pod" style="background: #f59e0b;">üì± push-worker (replicas: 5)</div>
                    <div class="k8s-pod" style="background: #10b981;">üìß email-worker (replicas: 3)</div>
                    <div class="k8s-pod" style="background: #8b5cf6;">üí¨ sms-worker (replicas: 2)</div>
                    <div class="k8s-pod" style="background: #ec4899;">üîî inapp-worker (replicas: 2)</div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <div class="k8s-pod" style="background: #7c3aed;">üìä Service: ClusterIP</div>
                    <div class="k8s-pod" style="background: #0891b2;">üåê Ingress: ALB</div>
                    <div class="k8s-pod" style="background: #dc2626;">üîê Secrets: provider-creds</div>
                </div>
            </div>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">push-worker-deployment.yaml</h5>
<pre>apiVersion: apps/v1
kind: Deployment
metadata:
  name: push-worker
spec:
  replicas: 5
  selector:
    matchLabels:
      app: push-worker
  template:
    spec:
      containers:
      - name: worker
        image: notification-system:v1.0.0
        args: ["--worker=push"]
        env:
        - name: KAFKA_BROKERS
          value: "kafka:9092"
        - name: KAFKA_TOPIC
          value: "notifications.push"
        - name: FCM_CREDENTIALS
          valueFrom:
            secretKeyRef:
              name: provider-creds
              key: fcm-key
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "256Mi"
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: push-worker-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: push-worker
  minReplicas: 2
  maxReplicas: 20
  metrics:
  - type: External
    external:
      metric:
        name: kafka_consumer_lag
        selector:
          matchLabels:
            topic: notifications.push
      target:
        type: AverageValue
        averageValue: "1000"</pre>
        </div>

        <!-- CI/CD -->
        <h3>üîÑ CI/CD Pipeline</h3>
        <div class="diagram-container">
            <h4>GitHub Actions ‚Üí ECR ‚Üí EKS (with Canary for Templates)</h4>
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 16px;">
                <div class="arch-box client" style="background: #24292e;">Git Push</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box server" style="background: #2088FF;">GitHub Actions</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box storage">ECR</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box gateway">Argo Rollouts</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box server">EKS</div>
            </div>
            <div style="margin-top: 20px; text-align: left; max-width: 700px; margin-left: auto; margin-right: auto;">
                <strong>Pipeline Steps:</strong>
                <ol style="font-size: 14px; margin-top: 8px;">
                    <li>Run tests (go test ./..., template validation)</li>
                    <li>Lint notification templates (variable schema check)</li>
                    <li>Build Docker images (api, workers)</li>
                    <li>Push to ECR with git SHA tag</li>
                    <li>Template changes ‚Üí Canary: 5% traffic for 30min</li>
                    <li>Monitor delivery rate, error rate during canary</li>
                    <li>Auto-promote or rollback based on metrics</li>
                    <li>Full rollout with rolling update</li>
                </ol>
            </div>
        </div>

        <!-- Rollback Strategy -->
        <h3>‚è™ Rollback Strategy</h3>
        <div class="feature-card warning">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4>Instant Rollback</h4>
                    <div class="code-example" style="margin: 12px 0;">
<pre>kubectl rollout undo deployment/push-worker
kubectl rollout undo deployment/email-worker</pre>
                    </div>
                    <p style="font-size: 14px;">K8s keeps last 10 ReplicaSets. Rollback in &lt;30s.</p>
                </div>
                <div>
                    <h4>Feature Flags for New Notification Types</h4>
                    <ul style="font-size: 14px;">
                        <li>LaunchDarkly flags per notification type</li>
                        <li><code>whatsapp_notifications_enabled: false</code></li>
                        <li>Gradual rollout: 1% ‚Üí 10% ‚Üí 50% ‚Üí 100%</li>
                        <li>Kill switch for problematic templates</li>
                    </ul>
                </div>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: #fef2f2; border-radius: 8px;">
                <strong>üö® Template Rollback:</strong> Keep last 5 versions of each template in DB. If delivery rate drops &gt;10%, auto-revert to previous version.
            </div>
        </div>

        <!-- Scale Metrics -->
        <h3>üìä Scale Metrics (MVP)</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">~115</div>
                <div class="label">Notifications/sec</div>
            </div>
            <div class="metric">
                <div class="value">99.5%</div>
                <div class="label">Delivery Rate</div>
            </div>
            <div class="metric">
                <div class="value">&lt;10s</div>
                <div class="label">P99 Delivery Latency</div>
            </div>
            <div class="metric">
                <div class="value">99.9%</div>
                <div class="label">API Availability</div>
            </div>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Notification Storm (Millions at Once)</div>
                <p>Flash sale announcement or system alert triggers millions of notifications simultaneously.</p>
                <div class="case-solution">Use priority queues with separate topics. Rate limit marketing to 100K/min. Auto-scale workers based on Kafka consumer lag. Implement backpressure at API level.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">User Unsubscribed Mid-Delivery</div>
                <p>User opts out while notification is queued but not yet delivered.</p>
                <div class="case-solution">Check user preferences at delivery time (not just queue time). Cache preferences in Redis with short TTL (60s). Honor unsubscribe immediately - better to miss one notification than annoy user.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Push Token Expired/Invalid</div>
                <p>FCM/APNS returns "NotRegistered" or "InvalidToken" error.</p>
                <div class="case-solution">Mark device_token as is_active=false immediately. Don't retry invalid tokens. Clean up stale tokens via batch job (>90 days unused). Track token refresh rate as health metric.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Email Bounces (Hard/Soft)</div>
                <p>Email delivery fails due to invalid address or full mailbox.</p>
                <div class="case-solution">Hard bounce: Mark email as invalid, stop future sends. Soft bounce: Retry 3x over 24h, then mark as problematic. Use SES bounce notifications via SNS webhook. Maintain bounce rate < 5% to protect sender reputation.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">SMS Delivery Failure</div>
                <p>SMS fails due to invalid number, carrier issues, or DND registration.</p>
                <div class="case-solution">Parse provider error codes (invalid number vs temporary failure). Retry temporary failures with exponential backoff. Log detailed error for invalid numbers. Fallback to email/push for critical notifications.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Provider Rate Limiting (FCM, APNs, SES)</div>
                <p>Provider returns 429 Too Many Requests or throttling errors.</p>
                <div class="case-solution">Implement client-side rate limiting (token bucket). Respect Retry-After headers. Use multiple provider accounts for higher limits. Queue overflow to DLQ, process when rate limit resets.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">AI-Driven Send Time Optimization</div>
                <p>Use ML to predict optimal delivery time per user based on engagement history.</p>
                <div class="future-approach">Collect open/click timestamps. Train model on user engagement patterns. Predict best hour/day per user. For new users, use cohort-based defaults. A/B test optimized vs fixed times.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Personalized Content with LLM</div>
                <p>Generate dynamic notification content based on user context and preferences.</p>
                <div class="future-approach">Use GPT-4 for template variants. Input: user profile, past purchases, browsing history. Output: personalized subject line and body. Cache generated content for similar user segments.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Cross-Channel Orchestration</div>
                <p>Intelligently route notifications across channels based on urgency and user behavior.</p>
                <div class="future-approach">Define channel priority per notification type. If push not opened in 5 min, send email. If email not opened in 1 hour, send SMS. Track cross-channel attribution.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Preference Learning</div>
                <p>Automatically learn user channel and frequency preferences from behavior.</p>
                <div class="future-approach">Track unsubscribes, mutes, open rates per channel. Build preference model per user. Suggest optimal settings. Auto-reduce frequency for low-engagement users.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement priority queues for notifications?</div>
                    <div class="followup-hint">Separate Kafka topics per priority (critical/high/medium/low). Workers consume from critical first. Use weighted fair queuing. Critical = OTP/security, High = orders, Medium = updates, Low = marketing.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">What delivery guarantees do you provide? At-least-once or exactly-once?</div>
                    <div class="followup-hint">At-least-once with idempotency. Kafka provides at-least-once. Use idempotency_key + Redis SETNX for dedup. Accept rare duplicates (better than message loss). Exactly-once too expensive for notifications.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle template management and versioning?</div>
                    <div class="followup-hint">Store templates in DB with version column. A/B test new templates with traffic split. Rollback via version revert. Validate variable schema before save. Cache compiled templates in Redis.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement notification scheduling and timezone handling?</div>
                    <div class="followup-hint">Store scheduled_at in UTC. Scheduler job runs every minute: SELECT WHERE scheduled_at <= NOW(). For timezone-aware: convert user's preferred time to UTC at creation. Batch fetch scheduled notifications with FOR UPDATE SKIP LOCKED.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How do you prevent notification fatigue and spam?</div>
                    <div class="followup-hint">Per-user rate limit (10/hour for marketing). Frequency capping per category. Quiet hours (don't send 10pm-8am). Aggregate similar notifications. Track unsubscribe rate as quality metric.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>MVP Stage - Complete Notification Flow</h4>
            <div class="flow-vertical">
                <!-- Send Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">NOTIFICATION SEND FLOW</div>
                    <div class="flow-row">
                        <div class="flow-node user">Event<br><small>Order placed</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Queue<br><small>Kafka topic</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node gateway">Priority Sort<br><small>Critical first</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Channel Select<br><small>Push/Email/SMS</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node cache">Rate Limit<br><small>Token bucket</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node external">Provider<br><small>FCM/SES/Twilio</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node user">Delivery<br><small>+ Tracking</small></div>
                    </div>
                </div>

                <!-- Multi-Channel Flow -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">MULTI-CHANNEL DELIVERY</div>
                    <div class="flow-row" style="justify-content: center; gap: 24px;">
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #f59e0b; color: white;">Push<br><small>FCM/APNs</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Instant, Free</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #3b82f6; color: white;">Email<br><small>SES</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Rich content</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #22c55e; color: white;">SMS<br><small>Twilio</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">High urgency</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #8b5cf6; color: white;">In-App<br><small>WebSocket</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Real-time</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution Across Stages</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">MVP</div>
                    <div class="evolution-label">MVP</div>
                    <div class="evolution-db">PostgreSQL</div>
                    <div class="evolution-detail">Single primary<br>All tables colocated</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">+</div>
                    <div class="evolution-label">Events</div>
                    <div class="evolution-db">Kafka</div>
                    <div class="evolution-detail">Event streaming<br>Priority topics</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">+</div>
                    <div class="evolution-label">Analytics</div>
                    <div class="evolution-db">ClickHouse</div>
                    <div class="evolution-detail">Delivery logs<br>Columnar analytics</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">+</div>
                    <div class="evolution-label">Preferences</div>
                    <div class="evolution-db">ScyllaDB</div>
                    <div class="evolution-detail">User preferences<br>Low-latency reads</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- PAN-INDIA SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="pan-india">
        <div class="stage-header">
            <span class="stage-badge pan-india">PAN-India Scale</span>
            <h2 style="margin: 0;">Multi-Region ‚Ä¢ 10M users ‚Ä¢ 50M notifications/day</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>üìã Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Multi-language templates (Hindi, Tamil, Telugu, etc.)</li>
                        <li>WhatsApp Business API integration</li>
                        <li>Regional SMS providers (failover)</li>
                        <li>DND compliance (TRAI registry)</li>
                        <li>Time-zone aware scheduling</li>
                        <li>User segment targeting</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Throughput: 500K notifications/min</li>
                        <li>Latency: &lt;5s for critical (OTP)</li>
                        <li>Regional latency: &lt;50ms API</li>
                        <li>Multi-provider failover: &lt;30s</li>
                        <li>Cost optimization: Push-first strategy</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE -->
        <h3>üèóÔ∏è Architecture Evolution</h3>
        <div class="diagram-container">
            <h4>Multi-Region Architecture</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <div class="arch-box client">Producers (All India)</div>
                <div class="arch-arrow">‚Üì</div>
                <div class="arch-box lb">Route 53 (Latency-based Routing)</div>
                <div class="arch-arrow">‚Üì</div>
                <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: center;">
                    <div style="text-align: center; padding: 16px; border: 2px dashed #3b82f6; border-radius: 12px;">
                        <strong style="color: #3b82f6;">Mumbai (ap-south-1)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">API (5x)</div>
                            <div class="arch-box queue" style="padding: 10px;">Kafka</div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; justify-content: center;">
                            <div class="arch-box worker" style="padding: 8px; font-size: 11px;">Push (10x)</div>
                            <div class="arch-box worker" style="padding: 8px; font-size: 11px;">Email (5x)</div>
                            <div class="arch-box worker" style="padding: 8px; font-size: 11px;">SMS (3x)</div>
                        </div>
                        <div class="arch-box db" style="margin-top: 12px;">RDS Primary</div>
                    </div>
                    <div style="text-align: center; padding: 16px; border: 2px dashed #22c55e; border-radius: 12px;">
                        <strong style="color: #22c55e;">Hyderabad (ap-south-2)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">API (3x)</div>
                            <div class="arch-box queue" style="padding: 10px;">Kafka</div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; justify-content: center;">
                            <div class="arch-box worker" style="padding: 8px; font-size: 11px;">Push (5x)</div>
                            <div class="arch-box worker" style="padding: 8px; font-size: 11px;">Email (3x)</div>
                            <div class="arch-box worker" style="padding: 8px; font-size: 11px;">SMS (2x)</div>
                        </div>
                        <div class="arch-box db" style="margin-top: 12px; opacity: 0.7;">RDS Read Replica</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW -->
        <h3>üîÑ Data Flow - Multi-Language Notification</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Request</div>
                    <div class="flow-step-label">template + user_id</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box db" style="padding: 10px 16px;">User Prefs</div>
                    <div class="flow-step-label">Get language: "hi"</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Template Svc</div>
                    <div class="flow-step-label">Load Hindi template</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box worker" style="padding: 10px 16px;">Render</div>
                    <div class="flow-step-label">Personalize vars</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box external" style="padding: 10px 16px;">Send</div>
                    <div class="flow-step-label">"‡§Ü‡§™‡§ï‡§æ ‡§ë‡§∞‡•ç‡§°‡§∞..."</div>
                </div>
            </div>
        </div>

        <!-- DATABASE SCHEMA ADDITIONS -->
        <h3>üóÑÔ∏è Schema Additions</h3>
        <div class="diagram-container">
            <div class="schema-diagram">
                <div class="schema-table">
                    <div class="schema-table-header">üåê template_translations</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">template_id</span><span class="field-type">UUID FK</span></div>
                        <div class="schema-field"><span class="field-name field-idx">language_code</span><span class="field-type">VARCHAR(5)</span></div>
                        <div class="schema-field"><span class="field-name">subject</span><span class="field-type">TEXT</span></div>
                        <div class="schema-field"><span class="field-name">body</span><span class="field-type">TEXT</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>N</span>
                    <span>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
                    <span>1</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">üìµ dnd_registry</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk field-idx">phone_number</span><span class="field-type">VARCHAR(15) PK</span></div>
                        <div class="schema-field"><span class="field-name">category</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">registered_at</span><span class="field-type">DATE</span></div>
                        <div class="schema-field"><span class="field-name">source</span><span class="field-type">VARCHAR(20)</span></div>
                    </div>
                </div>
            </div>
        </div>

        <h3>üìà What Changes</h3>
        <div class="feature-card">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 30%;"><strong>Multi-Language</strong></td>
                    <td>Template per language. Fallback: en ‚Üí hi ‚Üí default. Store user language_preference.</td>
                </tr>
                <tr>
                    <td><strong>WhatsApp Integration</strong></td>
                    <td>Meta Business API. Pre-approved templates only. HSM (Highly Structured Message) format.</td>
                </tr>
                <tr>
                    <td><strong>SMS Provider Failover</strong></td>
                    <td>Primary: Twilio. Fallover: Msg91, Kaleyra. Circuit breaker per provider.</td>
                </tr>
                <tr>
                    <td><strong>DND Compliance</strong></td>
                    <td>Sync TRAI DND registry daily. Check before promotional SMS. Transactional exempt.</td>
                </tr>
                <tr>
                    <td><strong>Cross-Region Kafka</strong></td>
                    <td>MirrorMaker 2 for replication. Consumer in each region. Produce locally.</td>
                </tr>
            </table>
        </div>

        <!-- SMS Provider Failover -->
        <h3>üîÄ SMS Provider Failover Strategy</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 16px;">
                <div class="arch-box worker">SMS Worker</div>
                <div class="arch-arrow">‚Üí</div>
                <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                    <div class="arch-box external" style="background: #22c55e;">Twilio (Primary)</div>
                    <div style="font-size: 12px; color: #ef4444;">Circuit Open?</div>
                    <div class="arch-arrow">‚Üì</div>
                    <div class="arch-box external" style="background: #f59e0b;">Msg91 (Secondary)</div>
                    <div style="font-size: 12px; color: #ef4444;">Circuit Open?</div>
                    <div class="arch-arrow">‚Üì</div>
                    <div class="arch-box external" style="background: #64748b;">Kaleyra (Tertiary)</div>
                </div>
            </div>
            <div style="margin-top: 16px; text-align: center; font-size: 14px;">
                <strong>Circuit Breaker:</strong> 5 failures in 30s ‚Üí Open circuit for 60s ‚Üí Half-open ‚Üí Test ‚Üí Close
            </div>
        </div>

        <h3>üí∞ Cost at PAN-India Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr>
                    <td>EKS (2 regions, 25 nodes total)</td>
                    <td>$2,500</td>
                </tr>
                <tr>
                    <td>RDS Primary + Replica</td>
                    <td>$600</td>
                </tr>
                <tr>
                    <td>Amazon MSK (Kafka, 2 regions)</td>
                    <td>$1,200</td>
                </tr>
                <tr>
                    <td>ElastiCache (2 regions)</td>
                    <td>$200</td>
                </tr>
                <tr>
                    <td>SES (50M emails)</td>
                    <td>$5,000</td>
                </tr>
                <tr>
                    <td>SMS (10M via Twilio/Msg91 mix)</td>
                    <td>$50,000</td>
                </tr>
                <tr>
                    <td>WhatsApp Business (5M)</td>
                    <td>$25,000</td>
                </tr>
                <tr class="total-row">
                    <td><strong>Total</strong></td>
                    <td><strong>~$84,500/month</strong></td>
                </tr>
            </table>
            <p style="font-size: 13px; color: #64748b; margin-top: 12px;">* Push notifications remain free (FCM/APNS). Push-first strategy critical for cost control.</p>
        </div>

        <!-- Scale Metrics -->
        <h3>üìä Scale Metrics (PAN-India)</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">~580</div>
                <div class="label">Notifications/sec</div>
            </div>
            <div class="metric">
                <div class="value">99.7%</div>
                <div class="label">Delivery Rate</div>
            </div>
            <div class="metric">
                <div class="value">&lt;5s</div>
                <div class="label">P99 Critical Latency</div>
            </div>
            <div class="metric">
                <div class="value">12</div>
                <div class="label">Languages Supported</div>
            </div>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Notification Storm During Festival Sales (Diwali, Big Billion Days)</div>
                <p>50M notifications triggered within minutes during flash sale start.</p>
                <div class="case-solution">Pre-warm workers 30min before sale. Use priority queues - transactional (OTP) gets dedicated capacity. Marketing notifications throttled to 500K/min. Implement circuit breakers on all provider calls.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Regional Language Template Missing</div>
                <p>User's preferred language (e.g., Kannada) template not available for notification type.</p>
                <div class="case-solution">Fallback chain: user_language ‚Üí Hindi ‚Üí English. Log missing translations for ops team. Show fallback indicator in analytics. Never fail delivery due to missing translation.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">DND Registry Check Failure</div>
                <p>TRAI DND API timeout or error during promotional SMS send.</p>
                <div class="case-solution">Cache DND list locally (sync daily). On cache miss + API failure: block promotional, allow transactional. Err on side of caution - better to not send than violate DND.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">WhatsApp Template Rejection</div>
                <p>Meta rejects template or marks business as spam.</p>
                <div class="case-solution">Pre-approve all templates before use. Monitor template quality score. Have fallback to SMS for critical messages. Maintain separate numbers for transactional vs marketing.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">SMS Provider Regional Outage</div>
                <p>Twilio experiencing issues in specific telecom circles (e.g., BSNL).</p>
                <div class="case-solution">Multi-provider setup with circuit breaker per provider-carrier combo. Route BSNL numbers to Msg91 if Twilio failing. Real-time delivery rate monitoring per carrier.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Cross-Region Kafka Replication Lag</div>
                <p>MirrorMaker lag causes duplicate processing or message loss during failover.</p>
                <div class="case-solution">Use idempotency keys that survive cross-region replay. Accept eventual consistency (seconds). Monitor replication lag in Grafana. Manual failover only when lag < 1000 messages.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">AI-Powered Regional Content Optimization</div>
                <p>Use ML to optimize notification content for regional preferences and cultural context.</p>
                <div class="future-approach">Train models on engagement data per region. Adjust tone, timing, and offers for cultural events (Pongal, Onam, Durga Puja). A/B test regional variants automatically.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Intelligent Channel Selection with ML</div>
                <p>Predict best channel per user based on historical engagement and context.</p>
                <div class="future-approach">Features: time of day, user's past open rates per channel, notification type, device active status. Model outputs channel probability. Route to highest probability channel first.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Cross-Channel Orchestration Engine</div>
                <p>Cascade notifications across channels based on delivery and engagement.</p>
                <div class="future-approach">Define workflows: Push first ‚Üí if no open in 10min ‚Üí Email ‚Üí if no open in 2hr ‚Üí SMS. Track cross-channel attribution. Respect user fatigue limits across channels.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Voice Notification Channel (IVR)</div>
                <p>Add automated voice calls for critical notifications to non-smartphone users.</p>
                <div class="future-approach">Integrate with Exotel/Knowlarity for IVR. Use for COD confirmation, delivery OTP for elderly users. Text-to-speech in regional languages. Fallback for SMS failures.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle multi-language template management at scale?</div>
                    <div class="followup-hint">Separate translation table with (template_id, language_code) PK. Use i18n libraries for variable interpolation. Crowdsource translations via internal tools. Cache compiled templates per language in Redis.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement SMS provider failover without message loss?</div>
                    <div class="followup-hint">Circuit breaker per provider. On failure: don't ack Kafka message, it retries with next provider. Track provider health score (success rate last 5 min). Weighted routing based on health + cost.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How do you ensure DND compliance while maintaining delivery SLAs?</div>
                    <div class="followup-hint">Daily DND registry sync to local cache. Check cache first (P99 < 1ms). Transactional SMS exempt from DND. For promotional: block if in DND, offer WhatsApp/email alternative. Audit log all DND checks.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle WhatsApp Business API rate limits and template approvals?</div>
                    <div class="followup-hint">Pre-approve template library. Monitor quality rating (needs > 4/5). Rate limit: start with 1K/day, scale to 100K based on quality. Implement queueing when approaching limits. Fallback to SMS for overflow.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How do you implement timezone-aware scheduling for PAN-India users?</div>
                    <div class="followup-hint">Store user timezone in preferences. Convert scheduled_at to UTC at creation. Scheduler fetches by UTC time. For "send at 10am local": expand to multiple UTC times. Batch users by timezone for efficiency.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>PAN-India Stage - Multi-Region Notification Flow</h4>
            <div class="flow-vertical">
                <!-- Regional Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">REGIONAL NOTIFICATION FLOW</div>
                    <div class="flow-row">
                        <div class="flow-node user">Event<br><small>Any region</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node gateway">Route 53<br><small>Latency routing</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Regional API<br><small>Mumbai/Hyd</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node cache">Language<br><small>Load template</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">DND Check<br><small>TRAI registry</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node external">Provider<br><small>Failover enabled</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node user">Delivery<br><small>Regional</small></div>
                    </div>
                </div>

                <!-- Multi-Channel with Regional Providers -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">REGIONAL PROVIDER ROUTING</div>
                    <div class="flow-row" style="justify-content: center; gap: 24px;">
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #f59e0b; color: white;">Push<br><small>FCM/APNs</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Global</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #3b82f6; color: white;">Email<br><small>SES Mumbai</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Regional SES</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #22c55e; color: white;">SMS<br><small>Twilio‚ÜíMsg91</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Failover chain</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #25D366; color: white;">WhatsApp<br><small>Meta Business</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">HSM templates</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution - PAN-India Stage</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">PG</div>
                    <div class="evolution-label">Core Data</div>
                    <div class="evolution-db">PostgreSQL</div>
                    <div class="evolution-detail">Primary Mumbai<br>Read replica Hyd</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">K</div>
                    <div class="evolution-label">Events</div>
                    <div class="evolution-db">Kafka (MSK)</div>
                    <div class="evolution-detail">Cross-region<br>MirrorMaker 2</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">CH</div>
                    <div class="evolution-label">Analytics</div>
                    <div class="evolution-db">ClickHouse</div>
                    <div class="evolution-detail">Regional delivery<br>Language metrics</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">R</div>
                    <div class="evolution-label">Cache</div>
                    <div class="evolution-db">Redis Cluster</div>
                    <div class="evolution-detail">DND cache<br>Template cache</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- HIGH TRAFFIC -->
    <!-- ============================================ -->
    <div class="stage-section" id="high-traffic">
        <div class="stage-header">
            <span class="stage-badge high-traffic">High Traffic</span>
            <h2 style="margin: 0;">100M users ‚Ä¢ 500M notifications/day ‚Ä¢ 10K/sec peak</h2>
        </div>

        <h3>‚ö†Ô∏è What Breaks First</h3>
        <div class="feature-card warning">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 25%;"><strong>1. Kafka Lag</strong></td>
                    <td>Workers can't keep up during flash sales</td>
                    <td style="color: #22c55e;"><strong>‚Üí Auto-scale workers on lag metric</strong></td>
                </tr>
                <tr>
                    <td><strong>2. Provider Rate Limits</strong></td>
                    <td>FCM: 500K/min, SES: 500/sec default</td>
                    <td style="color: #22c55e;"><strong>‚Üí Request limit increases, multi-account</strong></td>
                </tr>
                <tr>
                    <td><strong>3. DB Write Throughput</strong></td>
                    <td>Logging 10K status updates/sec</td>
                    <td style="color: #22c55e;"><strong>‚Üí Batch writes, move to ClickHouse</strong></td>
                </tr>
                <tr>
                    <td><strong>4. Dedup Cache Size</strong></td>
                    <td>100M idempotency keys in Redis</td>
                    <td style="color: #22c55e;"><strong>‚Üí Bloom filter + shorter TTL</strong></td>
                </tr>
                <tr>
                    <td><strong>5. Template Rendering</strong></td>
                    <td>CPU-bound personalization at scale</td>
                    <td style="color: #22c55e;"><strong>‚Üí Pre-render popular templates, cache</strong></td>
                </tr>
            </table>
        </div>

        <h3>üèóÔ∏è Architecture at Scale</h3>
        <div class="diagram-container">
            <h4>High-Traffic Architecture - Event Sourcing</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                <div class="arch-box lb">API Gateway (Rate Limiting per Tenant)</div>
                <div class="arch-arrow">‚Üì</div>
                <div class="arch-box server">Notification Service (Stateless, 20 pods)</div>
                <div class="arch-arrow">‚Üì</div>
                <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                    <div style="text-align: center;">
                        <div class="arch-box queue" style="background: #dc2626;">Critical Topic<br><small>OTP, Security</small></div>
                        <div style="font-size: 11px; color: #64748b;">Partitions: 32</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box queue" style="background: #f59e0b;">High Topic<br><small>Orders, Payments</small></div>
                        <div style="font-size: 11px; color: #64748b;">Partitions: 64</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box queue" style="background: #3b82f6;">Medium Topic<br><small>Updates</small></div>
                        <div style="font-size: 11px; color: #64748b;">Partitions: 32</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box queue" style="background: #64748b;">Low Topic<br><small>Marketing</small></div>
                        <div style="font-size: 11px; color: #64748b;">Partitions: 16</div>
                    </div>
                </div>
                <div class="arch-arrow">‚Üì</div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                    <div class="arch-box worker">Push Workers<br><small>50 pods</small></div>
                    <div class="arch-box worker">Email Workers<br><small>20 pods</small></div>
                    <div class="arch-box worker">SMS Workers<br><small>10 pods</small></div>
                    <div class="arch-box worker">WhatsApp Workers<br><small>10 pods</small></div>
                </div>
                <div class="arch-arrow">‚Üì</div>
                <div style="display: flex; gap: 40px; align-items: flex-start;">
                    <div style="text-align: center;">
                        <div class="arch-box db">PostgreSQL<br><small>Sharded (4 shards)</small></div>
                        <div style="font-size: 12px; color: #64748b;">Notifications, Prefs</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box storage">ClickHouse<br><small>Analytics Cluster</small></div>
                        <div style="font-size: 12px; color: #64748b;">Delivery Logs (append-only)</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box cache">Redis Cluster<br><small>16 shards</small></div>
                        <div style="font-size: 12px; color: #64748b;">Dedup, Rate Limit</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW -->
        <h3>üîÑ Data Flow - Bulk Campaign (10M users)</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Marketing</div>
                    <div class="flow-step-label">Create campaign</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Segment Svc</div>
                    <div class="flow-step-label">Query 10M users</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Batch Splitter</div>
                    <div class="flow-step-label">1000 batches √ó 10K</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box queue" style="padding: 10px 16px;">Kafka (Low)</div>
                    <div class="flow-step-label">Throttled produce</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box worker" style="padding: 10px 16px;">Workers</div>
                    <div class="flow-step-label">~2 hours to complete</div>
                </div>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; text-align: center;">
                <strong>‚ö†Ô∏è Throttling:</strong> Marketing campaigns capped at 100K/min to avoid swamping providers and impacting transactional notifications
            </div>
        </div>

        <!-- DATABASE SCHEMA -->
        <h3>üóÑÔ∏è Sharding Strategy</h3>
        <div class="diagram-container">
            <h4>PostgreSQL Sharding by user_id</h4>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;">
                <div class="arch-box db">Shard 0<br><small>user_id % 4 = 0</small></div>
                <div class="arch-box db">Shard 1<br><small>user_id % 4 = 1</small></div>
                <div class="arch-box db">Shard 2<br><small>user_id % 4 = 2</small></div>
                <div class="arch-box db">Shard 3<br><small>user_id % 4 = 3</small></div>
            </div>
            <div style="background: #eff6ff; padding: 16px; border-radius: 8px;">
                <strong>Sharding Key: user_id</strong>
                <ul style="margin: 8px 0 0 0; font-size: 14px;">
                    <li>All user's notifications on same shard (no cross-shard queries for inbox)</li>
                    <li>Bulk sends scatter across shards (good write distribution)</li>
                    <li>Use Citus for managed sharding on PostgreSQL</li>
                </ul>
            </div>
        </div>

        <div class="sql-query">
            <h5>ClickHouse for Analytics (Delivery Logs)</h5>
<pre>-- ClickHouse table for delivery logs (append-only, columnar)
CREATE TABLE delivery_logs_analytics (
    notification_id UUID,
    user_id UUID,
    channel LowCardinality(String),
    provider LowCardinality(String),
    status LowCardinality(String),
    attempt_number UInt8,
    latency_ms UInt32,
    delivered_at DateTime,
    created_at DateTime
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(created_at)
ORDER BY (channel, status, created_at);

-- Query: Delivery rate by channel (last 24h)
SELECT
    channel,
    countIf(status = 'delivered') / count() * 100 as delivery_rate,
    avg(latency_ms) as avg_latency_ms,
    quantile(0.99)(latency_ms) as p99_latency_ms
FROM delivery_logs_analytics
WHERE created_at > now() - INTERVAL 24 HOUR
GROUP BY channel;</pre>
        </div>

        <!-- Design Patterns -->
        <h3>üß© Additional Patterns at Scale</h3>
        <div class="patterns-grid">
            <div class="pattern-card">
                <h5>Bulkhead Pattern</h5>
                <p>Separate worker pools per priority. Critical pool never starved by marketing. Resource isolation prevents cascade failures.</p>
            </div>
            <div class="pattern-card">
                <h5>Token Bucket Rate Limiter</h5>
                <p>Per-user: 10 notifications/minute. Per-tenant: 10K/minute. Prevents single bad actor from exhausting provider limits.</p>
            </div>
            <div class="pattern-card">
                <h5>Bloom Filter for Dedup</h5>
                <p>1% false positive acceptable. 100M keys in 120MB vs 10GB+ in Redis. Check bloom ‚Üí if maybe exists ‚Üí check DB.</p>
            </div>
            <div class="pattern-card">
                <h5>CQRS</h5>
                <p>Writes ‚Üí PostgreSQL (notifications table). Reads ‚Üí ClickHouse (analytics). Different models optimized for their workload.</p>
            </div>
        </div>

        <h3>üí∞ Cost at High Traffic</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (100 nodes, c5.2xlarge)</td><td>$25,000</td></tr>
                <tr><td>RDS (4 shards, db.r5.2xlarge)</td><td>$8,000</td></tr>
                <tr><td>ClickHouse Cloud</td><td>$3,000</td></tr>
                <tr><td>Amazon MSK (12 brokers)</td><td>$4,000</td></tr>
                <tr><td>ElastiCache Cluster (16 nodes)</td><td>$3,000</td></tr>
                <tr><td>SES (500M emails)</td><td>$50,000</td></tr>
                <tr><td>SMS (50M, multi-provider)</td><td>$250,000</td></tr>
                <tr><td>WhatsApp (100M messages)</td><td>$500,000</td></tr>
                <tr><td>Data Transfer</td><td>$5,000</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$848,000/month</strong></td></tr>
            </table>
        </div>

        <!-- Scale Metrics -->
        <h3>üìä Scale Metrics (High Traffic)</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">10K</div>
                <div class="label">Peak Notifications/sec</div>
            </div>
            <div class="metric">
                <div class="value">99.8%</div>
                <div class="label">Delivery Rate</div>
            </div>
            <div class="metric">
                <div class="value">&lt;3s</div>
                <div class="label">P99 Critical Latency</div>
            </div>
            <div class="metric">
                <div class="value">99.95%</div>
                <div class="label">API Availability</div>
            </div>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Notification Storm at 10K/sec (Black Friday Peak)</div>
                <p>All channels hit simultaneously during major sale event.</p>
                <div class="case-solution">Pre-scale workers 2x expected peak. Implement adaptive rate limiting per channel. Use separate Kafka clusters for critical vs marketing. Shed low-priority traffic gracefully when at capacity.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Kafka Consumer Lag Explosion</div>
                <p>Consumer lag grows to millions, causing notification delays.</p>
                <div class="case-solution">Alert on lag > 10K messages. Auto-scale consumers based on lag metric (KEDA). Implement backpressure - reject new low-priority requests when lag high. Consider dropping expired marketing notifications.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Database Shard Hotspot</div>
                <p>One shard receives disproportionate traffic (celebrity user, viral campaign).</p>
                <div class="case-solution">Monitor per-shard metrics. Use consistent hashing with virtual nodes for better distribution. Implement read replicas per shard. Consider splitting hot shard dynamically.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Bloom Filter False Positives Spike</div>
                <p>Dedup bloom filter returning too many false positives, blocking legitimate notifications.</p>
                <div class="case-solution">Monitor false positive rate. Rebuild bloom filter when FP rate > 2%. Use counting bloom filter to support deletions. Fallback to Redis check on positive bloom result.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Provider Multi-Account Rate Limit Coordination</div>
                <p>Using multiple FCM/SES accounts but still hitting aggregate limits.</p>
                <div class="case-solution">Distribute users across accounts by user_id hash. Track rate limit per account in Redis. Implement account-level circuit breakers. Request enterprise limits from providers.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">ClickHouse Insert Lag During Peak</div>
                <p>Analytics writes falling behind, losing delivery tracking data.</p>
                <div class="case-solution">Buffer writes in Kafka before ClickHouse. Use async batch inserts (10K rows/batch). Implement backpressure - don't block delivery on analytics write. Accept eventual consistency for analytics.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">Real-Time ML Personalization at Scale</div>
                <p>Use streaming ML models to personalize notification content in real-time.</p>
                <div class="future-approach">Deploy ML models on Kubernetes with GPU nodes. Use feature store (Feast) for real-time features. Implement A/B testing framework for model variants. Target < 10ms inference latency.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Predictive Send Time Optimization</div>
                <p>ML model predicts optimal send time per user to maximize engagement.</p>
                <div class="future-approach">Train on historical open/click timestamps. Features: user timezone, past engagement patterns, notification type. Batch score users nightly, cache optimal times. A/B test against fixed schedule.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Intelligent Notification Aggregation</div>
                <p>Automatically batch similar notifications to reduce fatigue.</p>
                <div class="future-approach">Hold notifications for configurable window (5-15 min). Group by category/type. Generate digest notification. Use ML to learn optimal aggregation per user.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Self-Healing Provider Routing</div>
                <p>ML-based automatic provider selection and failover.</p>
                <div class="future-approach">Train on provider performance data (latency, success rate, cost). Real-time scoring of provider health. Automatic traffic shifting based on predicted success. Learn carrier-specific routing.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How do you implement priority queues that guarantee critical notifications are never delayed?</div>
                    <div class="followup-hint">Dedicated Kafka cluster for critical (OTP/security). Separate worker pools with resource isolation (bulkhead). Critical pool never shares resources with marketing. Alert if critical queue depth > 100.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle exactly-once delivery semantics at this scale?</div>
                    <div class="followup-hint">True exactly-once is expensive. Use at-least-once with idempotency. Bloom filter + Redis for dedup. Accept 0.01% duplicate rate as acceptable tradeoff. For critical: use DB unique constraint as final check.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How do you manage template versioning and A/B testing at 10K/sec?</div>
                    <div class="followup-hint">Store template versions in DB. Cache active versions in Redis. A/B split at notification creation time (not delivery). Track metrics per version. Gradual rollout: 1% ‚Üí 10% ‚Üí 50% ‚Üí 100%. Auto-rollback if engagement drops.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How do you implement efficient bulk notifications for 100M users?</div>
                    <div class="followup-hint">Segment service pre-computes user lists. Split into 10K batches. Throttled produce to Kafka (avoid thundering herd). Workers process in parallel. Progress tracking via Redis counters. Estimated completion time shown in UI.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle database sharding for notifications?</div>
                    <div class="followup-hint">Shard by user_id (all user's notifications colocated). Use Citus for PostgreSQL sharding. Cross-shard queries only for analytics (use ClickHouse). Shard key in all queries. Consider time-based partitioning within shards.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>High Traffic Stage - Scaled Notification Flow</h4>
            <div class="flow-vertical">
                <!-- High Volume Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">HIGH-VOLUME NOTIFICATION FLOW (10K/sec)</div>
                    <div class="flow-row">
                        <div class="flow-node user">Event<br><small>Bulk/Single</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node gateway">API Gateway<br><small>Rate limit</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node cache">Bloom Filter<br><small>Dedup check</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Priority Queue<br><small>4 topics</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Worker Pool<br><small>90 pods</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node external">Providers<br><small>Multi-account</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node db">ClickHouse<br><small>Analytics</small></div>
                    </div>
                </div>

                <!-- Priority Queue Distribution -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">PRIORITY QUEUE DISTRIBUTION</div>
                    <div class="flow-row" style="justify-content: center; gap: 24px;">
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #dc2626; color: white;">Critical<br><small>OTP, Security</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">32 partitions</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #f59e0b; color: white;">High<br><small>Orders</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">64 partitions</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #3b82f6; color: white;">Medium<br><small>Updates</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">32 partitions</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #64748b; color: white;">Low<br><small>Marketing</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">16 partitions</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution - High Traffic Stage</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">PG</div>
                    <div class="evolution-label">Sharded</div>
                    <div class="evolution-db">PostgreSQL (Citus)</div>
                    <div class="evolution-detail">4 shards<br>user_id based</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">K</div>
                    <div class="evolution-label">Events</div>
                    <div class="evolution-db">Kafka (MSK)</div>
                    <div class="evolution-detail">12 brokers<br>144 partitions</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">CH</div>
                    <div class="evolution-label">Analytics</div>
                    <div class="evolution-db">ClickHouse Cluster</div>
                    <div class="evolution-detail">500M logs/day<br>30-day retention</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">R</div>
                    <div class="evolution-label">Cache</div>
                    <div class="evolution-db">Redis Cluster</div>
                    <div class="evolution-detail">16 shards<br>Bloom + dedup</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- GLOBAL SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="global">
        <div class="stage-header">
            <span class="stage-badge global">Global Scale</span>
            <h2 style="margin: 0;">500M users ‚Ä¢ 5B notifications/day ‚Ä¢ 100K/sec peak</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>üìã Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>50+ language support</li>
                        <li>Regional compliance (GDPR, CCPA)</li>
                        <li>Cross-channel orchestration</li>
                        <li>A/B testing for templates</li>
                        <li>ML-based send time optimization</li>
                        <li>Real-time personalization</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Throughput: 100K notifications/sec</li>
                        <li>Global latency: &lt;100ms API anywhere</li>
                        <li>Availability: 99.99% (4 nines)</li>
                        <li>Data residency compliance</li>
                        <li>Zero message loss guarantee</li>
                    </ul>
                </div>
            </div>
        </div>

        <h3>üåç Global Architecture</h3>
        <div class="diagram-container">
            <h4>Multi-Region Active-Active</h4>
            <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;">
                <div style="text-align: center; padding: 20px; background: rgba(59,130,246,0.1); border-radius: 12px;">
                    <strong>US-East (Virginia)</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box queue" style="margin-top: 8px;">Kafka</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 8px;">Americas traffic</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(34,197,94,0.1); border-radius: 12px;">
                    <strong>EU-West (Ireland)</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box queue" style="margin-top: 8px;">Kafka</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 8px;">EMEA traffic + GDPR</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(249,115,22,0.1); border-radius: 12px;">
                    <strong>Asia-Pacific (Singapore)</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box queue" style="margin-top: 8px;">Kafka</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 8px;">APAC traffic</div>
                </div>
            </div>
            <p style="margin-top: 16px; text-align: center;"><strong>CockroachDB:</strong> Distributed SQL with geo-partitioning. User data stays in their region. Cross-region reads for global templates.</p>
        </div>

        <!-- DATA FLOW -->
        <h3>üîÑ Data Flow - Cross-Region Notification</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">EU User</div>
                    <div class="flow-step-label">Action triggers notif</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box lb" style="padding: 10px 16px;">Route 53</div>
                    <div class="flow-step-label">‚Üí EU-West API</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">EU API</div>
                    <div class="flow-step-label">Check: user in EU?</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box queue" style="padding: 10px 16px;">EU Kafka</div>
                    <div class="flow-step-label">Process locally</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box worker" style="padding: 10px 16px;">EU Worker</div>
                    <div class="flow-step-label">Send via EU provider</div>
                </div>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: #dbeafe; border-radius: 8px; text-align: center;">
                <strong>Data Residency:</strong> EU user data never leaves EU region. Notifications processed entirely within EU infrastructure.
            </div>
        </div>

        <!-- K8s Deployment -->
        <h3>üöÄ Global K8s Deployment</h3>
        <div class="deployment-diagram">
            <h4>Multi-Cluster Federation</h4>
            <div class="k8s-cluster">
                <h5>Global Fleet Management (Argo CD)</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; justify-content: center;">
                    <div style="padding: 12px; background: rgba(59,130,246,0.2); border-radius: 8px;">
                        <strong>US-East</strong><br>
                        <span style="font-size: 12px;">50 API pods, 200 workers</span>
                    </div>
                    <div style="padding: 12px; background: rgba(34,197,94,0.2); border-radius: 8px;">
                        <strong>EU-West</strong><br>
                        <span style="font-size: 12px;">30 API pods, 150 workers</span>
                    </div>
                    <div style="padding: 12px; background: rgba(249,115,22,0.2); border-radius: 8px;">
                        <strong>AP-Southeast</strong><br>
                        <span style="font-size: 12px;">40 API pods, 180 workers</span>
                    </div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                    <div class="k8s-pod" style="background: #7c3aed;">Global Config (ConfigMap sync)</div>
                    <div class="k8s-pod" style="background: #0891b2;">Cross-cluster Service Mesh (Istio)</div>
                    <div class="k8s-pod" style="background: #dc2626;">Centralized Secrets (Vault)</div>
                </div>
            </div>
        </div>

        <!-- CI/CD -->
        <h3>üîÑ Global CI/CD Pipeline</h3>
        <div class="diagram-container">
            <h4>Progressive Rollout Across Regions</h4>
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 16px;">
                <div class="arch-box client" style="background: #24292e;">Git Push</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box server" style="background: #2088FF;">GitHub Actions</div>
                <div class="arch-arrow">‚Üí</div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div class="arch-box gateway" style="padding: 8px; font-size: 12px;">1. US-East (Canary 5%)</div>
                    <div class="arch-arrow">‚Üì (30 min, metrics OK)</div>
                    <div class="arch-box gateway" style="padding: 8px; font-size: 12px;">2. US-East (100%)</div>
                    <div class="arch-arrow">‚Üì (1 hour)</div>
                    <div class="arch-box gateway" style="padding: 8px; font-size: 12px;">3. EU + APAC</div>
                </div>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px;">
                <strong>Rollout Gates:</strong> Delivery rate > 99%, Error rate < 0.1%, P99 latency < 5s. Auto-rollback if breached.
            </div>
        </div>

        <!-- Rollback Strategy -->
        <h3>‚è™ Global Rollback Strategy</h3>
        <div class="feature-card warning">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4>Regional Isolation</h4>
                    <ul style="font-size: 14px;">
                        <li>Each region independently rollbackable</li>
                        <li>Traffic shift via Route 53 weights</li>
                        <li>Drain region, rollback, re-enable</li>
                    </ul>
                    <div class="code-example" style="margin: 12px 0;">
<pre># Rollback single region
argocd app rollback notification-us-east
kubectl --context=us-east rollout undo deployment/api</pre>
                    </div>
                </div>
                <div>
                    <h4>Feature Flag Kill Switches</h4>
                    <ul style="font-size: 14px;">
                        <li>Per-region feature flags</li>
                        <li>Template version per region</li>
                        <li>Provider routing overrides</li>
                        <li>Emergency: disable entire channel globally</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- AWS Cost -->
        <h3>üí∞ Cost at Global Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (3 regions, 300 nodes total)</td><td>$100,000</td></tr>
                <tr><td>CockroachDB Cloud (3 regions)</td><td>$50,000</td></tr>
                <tr><td>Amazon MSK (3 regions, 36 brokers)</td><td>$15,000</td></tr>
                <tr><td>ElastiCache Global (48 nodes)</td><td>$12,000</td></tr>
                <tr><td>ClickHouse Cloud</td><td>$10,000</td></tr>
                <tr><td>SES (5B emails)</td><td>$500,000</td></tr>
                <tr><td>Push (free via FCM/APNS)</td><td>$0</td></tr>
                <tr><td>SMS (500M, global providers)</td><td>$2,500,000</td></tr>
                <tr><td>WhatsApp (1B messages)</td><td>$5,000,000</td></tr>
                <tr><td>Data Transfer (cross-region)</td><td>$50,000</td></tr>
                <tr><td>Monitoring (Datadog)</td><td>$30,000</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$8.27M/month</strong></td></tr>
            </table>
            <p style="font-size: 13px; color: #64748b; margin-top: 12px;">* Messaging (SMS/WhatsApp) dominates cost. Push-first strategy saves $3-5M/month.</p>
        </div>

        <!-- Scale Metrics -->
        <h3>üìä Scale Metrics (Global)</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">100K</div>
                <div class="label">Peak Notifications/sec</div>
            </div>
            <div class="metric">
                <div class="value">99.9%</div>
                <div class="label">Delivery Rate</div>
            </div>
            <div class="metric">
                <div class="value">&lt;2s</div>
                <div class="label">P99 Critical Latency</div>
            </div>
            <div class="metric">
                <div class="value">99.99%</div>
                <div class="label">Availability</div>
            </div>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Global Notification Storm (100K/sec Multi-Region)</div>
                <p>Worldwide product launch or incident notification hits all regions simultaneously.</p>
                <div class="case-solution">Pre-coordinate capacity across regions. Use global rate limiter with regional quotas. Implement cross-region load shedding. Critical notifications get reserved capacity in each region.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Cross-Region Data Consistency During Failover</div>
                <p>User preferences updated in EU, notification sent from US before replication completes.</p>
                <div class="case-solution">Use CockroachDB follower reads for preferences (accept staleness). For critical preferences (unsubscribe): synchronous replication with higher latency. Accept eventual consistency for non-critical preferences.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">GDPR Right to Erasure Mid-Campaign</div>
                <p>EU user requests data deletion while marketing campaign is in progress.</p>
                <div class="case-solution">Immediate soft-delete blocks all future sends. Kafka consumers check deletion status before delivery. Purge from all regional caches. Audit log deletion request for compliance. Complete hard delete within 30 days.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Regional Provider Outage (AWS SES EU-West Down)</div>
                <p>Email provider experiences regional outage affecting millions of users.</p>
                <div class="case-solution">Multi-region provider failover (route to US-East SES). Queue emails during outage with TTL. Implement provider health checks per region. Consider multi-cloud (SES + SendGrid) for critical regions.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Time-Sensitive Notification Across Timezones</div>
                <p>Flash sale notification needs to arrive at exactly 10am local time across 50+ timezones.</p>
                <div class="case-solution">Pre-compute send times in UTC for each timezone. Batch users by timezone. Stagger Kafka produce to match timezone windows. Account for DST transitions. Monitor delivery timing accuracy.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Regulatory Compliance Conflict (GDPR vs Local Law)</div>
                <p>EU user traveling in country with different data laws receives notification.</p>
                <div class="case-solution">Always apply user's home region compliance rules. Route all processing through user's registered region. Geo-IP only for latency optimization, not compliance. Legal review of cross-border scenarios.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">AI-Powered Global Content Optimization</div>
                <p>Use LLMs to generate culturally-appropriate notification content for each region.</p>
                <div class="future-approach">Train regional content models on engagement data. Consider cultural nuances, holidays, local events. A/B test AI-generated vs human-written content. Implement content safety filters for each region.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Predictive Cross-Channel Orchestration</div>
                <p>ML model determines optimal channel sequence per user across global touchpoints.</p>
                <div class="future-approach">Build user journey models spanning channels and regions. Predict: push in morning ‚Üí email if not opened ‚Üí WhatsApp for high-intent users. Learn regional channel preferences automatically.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Real-Time Personalization with Edge ML</div>
                <p>Deploy ML models at edge locations for sub-10ms personalization.</p>
                <div class="future-approach">Use TensorFlow Lite models at CloudFront edge. Personalize notification content based on real-time user context. A/B test edge vs centralized personalization. Target P99 < 5ms for model inference.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Autonomous Notification System</div>
                <p>Self-optimizing system that automatically adjusts frequency, timing, and content.</p>
                <div class="future-approach">Reinforcement learning for send time optimization. Auto-adjust frequency based on engagement signals. Self-healing provider routing. Human oversight for major changes only.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How do you implement priority queues with global consistency?</div>
                    <div class="followup-hint">Each region has independent Kafka clusters with same topic structure. Critical notifications processed locally first. Cross-region replication only for analytics/audit. Use global rate limiter (Redis Global) to prevent total system overload.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">How do you guarantee delivery while respecting data residency?</div>
                    <div class="followup-hint">Route all user data processing through user's home region. Use CockroachDB geo-partitioning. Notification metadata can be global, PII stays regional. For cross-region notifications: send request to user's home region for processing.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How do you manage template versioning across 50+ languages?</div>
                    <div class="followup-hint">Translation management system (Lokalise/Phrase). Template version + language_code as cache key. Gradual rollout per language. Fallback chain: user_lang ‚Üí region_default ‚Üí English. Track engagement per language version.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How do you implement global rate limiting without adding latency?</div>
                    <div class="followup-hint">Use Redis Global Datastore for distributed rate limiting. Local rate limit check first (region quota). Global check only when approaching limits. Accept slight over-delivery vs adding latency. Async reconciliation of global counters.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle notification delivery during regional failover?</div>
                    <div class="followup-hint">Active-active means no failover needed for most cases. If region totally down: Route 53 health checks redirect traffic. Pending notifications replayed from Kafka (retained 7 days). Accept temporary increase in latency during failover. User preferences cached globally with TTL.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>Global Stage - Multi-Region Notification Flow</h4>
            <div class="flow-vertical">
                <!-- Global Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">GLOBAL NOTIFICATION FLOW (100K/sec)</div>
                    <div class="flow-row">
                        <div class="flow-node user">Event<br><small>Any region</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node gateway">Route 53<br><small>Geo routing</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Regional API<br><small>US/EU/APAC</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node db">CockroachDB<br><small>Geo-partitioned</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Regional Kafka<br><small>Local process</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node external">Regional Provider<br><small>Compliance</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node user">Global Delivery<br><small>Analytics</small></div>
                    </div>
                </div>

                <!-- Multi-Region Distribution -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">REGIONAL DISTRIBUTION (Data Residency)</div>
                    <div class="flow-row" style="justify-content: center; gap: 24px;">
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #3b82f6; color: white;">US-East<br><small>Americas</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">CCPA compliant</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #22c55e; color: white;">EU-West<br><small>EMEA</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">GDPR compliant</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #f59e0b; color: white;">AP-Southeast<br><small>APAC</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Regional laws</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="flow-node" style="background: #8b5cf6; color: white;">Global<br><small>Coordination</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Argo CD sync</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution - Global Stage</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">CRDB</div>
                    <div class="evolution-label">Distributed SQL</div>
                    <div class="evolution-db">CockroachDB</div>
                    <div class="evolution-detail">Geo-partitioned<br>3 regions</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">K</div>
                    <div class="evolution-label">Regional Events</div>
                    <div class="evolution-db">Kafka (MSK)</div>
                    <div class="evolution-detail">36 brokers<br>3 clusters</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">CH</div>
                    <div class="evolution-label">Global Analytics</div>
                    <div class="evolution-db">ClickHouse Cloud</div>
                    <div class="evolution-detail">5B events/day<br>Cross-region</div>
                </div>
                <div class="evolution-arrow">‚Üí</div>
                <div class="evolution-stage">
                    <div class="evolution-icon">Scy</div>
                    <div class="evolution-label">Preferences</div>
                    <div class="evolution-db">ScyllaDB Global</div>
                    <div class="evolution-detail">User prefs<br>Sub-ms reads</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tooltip System -->
<div class="tooltip-overlay" id="tooltipOverlay" onclick="closeTooltip()"></div>
<div class="tooltip-popup" id="tooltipPopup">
    <button class="tooltip-close" onclick="closeTooltip()">&times;</button>
    <h4 id="tooltipTitle"></h4>
    <div id="tooltipContent"></div>
</div>

<script>
const termDefinitions = {
    'kafka': {
        title: 'Apache Kafka / Amazon MSK',
        content: `<p>Distributed event streaming platform for high-throughput notification processing.</p>
        <div style="margin-top: 16px;">
            <strong>Architecture:</strong>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0;">
                <span style="background: #ec4899; color: white; padding: 4px 8px; border-radius: 4px;">Producer (API)</span>
                <span>‚Üí</span>
                <span style="background: #8b5cf6; color: white; padding: 4px 8px; border-radius: 4px;">Broker 1</span>
                <span style="background: #8b5cf6; color: white; padding: 4px 8px; border-radius: 4px;">Broker 2</span>
                <span style="background: #8b5cf6; color: white; padding: 4px 8px; border-radius: 4px;">Broker 3</span>
                <span>‚Üí</span>
                <span style="background: #22c55e; color: white; padding: 4px 8px; border-radius: 4px;">Workers</span>
            </div>
        </div>
        <div style="margin-top: 12px;">
            <strong>Topics:</strong> notifications.critical, notifications.high, notifications.medium, notifications.low
        </div>`
    },
    'fcm': {
        title: 'Firebase Cloud Messaging (FCM)',
        content: `<p>Google's free push notification service for Android and iOS.</p>
        <div style="margin-top: 12px;">
            <strong>Key Features:</strong>
            <ul style="margin: 8px 0;">
                <li>Unlimited free notifications</li>
                <li>Topic-based broadcasting</li>
                <li>Delivery receipts via BigQuery export</li>
            </ul>
        </div>
        <div style="margin-top: 12px;">
            <strong>Rate Limits:</strong> 500K messages/minute (request increase for higher)
        </div>`
    },
    'ses': {
        title: 'Amazon Simple Email Service (SES)',
        content: `<p>AWS managed email sending service with high deliverability.</p>
        <div style="margin-top: 12px;">
            <strong>Pricing:</strong> $0.10 per 1,000 emails
        </div>
        <div style="margin-top: 12px;">
            <strong>Features:</strong>
            <ul style="margin: 8px 0;">
                <li>DKIM/SPF authentication</li>
                <li>Dedicated IPs available</li>
                <li>Bounce/complaint handling</li>
            </ul>
        </div>`
    }
};

function showTooltip(term) {
    const def = termDefinitions[term];
    if (def) {
        document.getElementById('tooltipTitle').textContent = def.title;
        document.getElementById('tooltipContent').innerHTML = def.content;
        document.getElementById('tooltipOverlay').classList.add('show');
        document.getElementById('tooltipPopup').classList.add('show');
    }
}

function closeTooltip() {
    document.getElementById('tooltipOverlay').classList.remove('show');
    document.getElementById('tooltipPopup').classList.remove('show');
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeTooltip(); });

// Scroll spy
window.addEventListener('scroll', function() {
    const sections = document.querySelectorAll('.stage-section');
    const navLinks = document.querySelectorAll('.quick-nav a');
    let current = '';
    sections.forEach(section => {
        if (scrollY >= section.offsetTop - 200) current = section.id;
    });
    navLinks.forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === '#' + current);
    });
});
</script>
