<link rel="stylesheet" href="/static/css/interview-questions.css">

<div class="interview-topic-layout">
    <a href="/interview-question" class="back-to-dashboard">‚Üê Back to All Topics</a>

    <h1>üçî Food Ordering System Design</h1>
    <p class="topic-description">Design an online food delivery platform like Swiggy/Zomato handling millions of orders with real-time tracking</p>

    <div class="quick-nav">
        <h4>Navigation</h4>
        <a href="#mvp">MVP Stage</a>
        <a href="#pan-india">PAN-India</a>
        <a href="#high-traffic">High Traffic</a>
        <a href="#global">Global</a>
        <a href="#cap-analysis">CAP Analysis</a>
    </div>

    <!-- ============================================ -->
    <!-- MVP STAGE -->
    <!-- ============================================ -->
    <div class="stage-section" id="mvp">
        <div class="stage-header">
            <span class="stage-badge mvp">MVP Stage</span>
            <h2 style="margin: 0;">Single City ‚Ä¢ 10K users ‚Ä¢ 500 Restaurants</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>üìã Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Browse restaurants by location</li>
                        <li>Search by cuisine/dish name</li>
                        <li>View menu and add to cart</li>
                        <li>Place order with payment</li>
                        <li>Real-time order tracking</li>
                        <li>Rate and review restaurants</li>
                        <li>Restaurant order management</li>
                        <li>Delivery partner assignment</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Latency: &lt;200ms API response</li>
                        <li>Order Success Rate: 99.5%</li>
                        <li>Availability: 99.9%</li>
                        <li>Real-time tracking: &lt;3s updates</li>
                        <li>Search results: &lt;100ms</li>
                        <li>Payment processing: &lt;5s</li>
                        <li>Read:Write ratio = 10:1</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE DIAGRAM -->
        <h3>üèóÔ∏è Architecture</h3>
        <div class="diagram-container">
            <h4>MVP Architecture - Single City</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <!-- Layer 1: Clients -->
                <div style="display: flex; gap: 40px;">
                    <div class="arch-box client">Customer App<br><small>iOS/Android/Web</small></div>
                    <div class="arch-box client">Restaurant App<br><small>Order Management</small></div>
                    <div class="arch-box client">Delivery App<br><small>Partner Tracking</small></div>
                </div>
                <div class="arch-arrow">‚Üì</div>

                <!-- Layer 2: API Gateway -->
                <div class="arch-box lb">AWS ALB + <a href="/interview-question/glossary#api-gateway" class="info-term">API Gateway<span class="info-i">i</span></a><br><small>Auth, Rate Limiting, SSL</small></div>
                <div class="arch-arrow">‚Üì</div>

                <!-- Layer 3: Microservices -->
                <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                    <div class="arch-box server">Order Service<br><small>Node.js</small></div>
                    <div class="arch-box server">Restaurant Service<br><small>Node.js</small></div>
                    <div class="arch-box server">Delivery Service<br><small>Go</small></div>
                    <div class="arch-box server">Payment Service<br><small>Node.js</small></div>
                </div>
                <div class="arch-arrow">‚Üì</div>

                <!-- Layer 4: Data -->
                <div style="display: flex; gap: 40px; align-items: flex-start; flex-wrap: wrap; justify-content: center;">
                    <div style="text-align: center;">
                        <div class="arch-box db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> + <a href="/interview-question/glossary#postgresql" class="info-term">PostGIS<span class="info-i">i</span></a><br><small>db.t3.medium</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Geospatial queries<br>Multi-AZ</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box cache">ElastiCache <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a><br><small>Session + Cache</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Menu cache<br>Rate limiting</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box queue">Amazon MSK<br><small><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a></small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Order events<br>Location updates</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Place Order -->
        <h3>üîÑ Data Flow - Place Order</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Customer</div>
                    <div class="flow-step-label">POST /orders</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Order Svc</div>
                    <div class="flow-step-label">Validate cart</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Payment</div>
                    <div class="flow-step-label">Process payment</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box db" style="padding: 10px 16px;"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">INSERT order</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box queue" style="padding: 10px 16px;"><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">order.placed</div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Restaurant Accept -->
        <h3>üîÑ Data Flow - Restaurant Accept Order</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Restaurant</div>
                    <div class="flow-step-label">Accept order</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Order Svc</div>
                    <div class="flow-step-label">Update status</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box queue" style="padding: 10px 16px;"><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">order.confirmed</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Delivery Svc</div>
                    <div class="flow-step-label">Find partner</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Customer</div>
                    <div class="flow-step-label">Push notification</div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Delivery Assignment -->
        <h3>üîÑ Data Flow - Delivery Partner Assignment</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Delivery Svc</div>
                    <div class="flow-step-label">Query nearby</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box db" style="padding: 10px 16px;"><a href="/interview-question/glossary#postgresql" class="info-term">PostGIS<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">ST_DWithin 3km</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Ranking</div>
                    <div class="flow-step-label">Score partners</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Partner App</div>
                    <div class="flow-step-label">Accept request</div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Real-time Tracking -->
        <h3>üîÑ Data Flow - Real-time Tracking</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Partner App</div>
                    <div class="flow-step-label">GPS every 5s</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box queue" style="padding: 10px 16px;"><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">location.update</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box cache" style="padding: 10px 16px;"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">GEOADD partner</div>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box server" style="padding: 10px 16px;">WebSocket</div>
                    <div class="flow-step-label">Push to customer</div>
                </div>
            </div>
        </div>

        <!-- DATABASE SCHEMA -->
        <h3>üóÑÔ∏è Database Schema</h3>
        <div class="diagram-container">
            <h4><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> + <a href="/interview-question/glossary#postgresql" class="info-term">PostGIS<span class="info-i">i</span></a> Schema with Relationships</h4>
            <div class="schema-diagram">
                <div class="schema-table">
                    <div class="schema-table-header">üì¶ restaurants</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR(255) NOT NULL</span></div>
                        <div class="schema-field"><span class="field-name field-idx">location</span><span class="field-type">GEOGRAPHY(POINT, 4326)</span></div>
                        <div class="schema-field"><span class="field-name">address</span><span class="field-type">TEXT</span></div>
                        <div class="schema-field"><span class="field-name field-idx">cuisine_types</span><span class="field-type">VARCHAR[] </span></div>
                        <div class="schema-field"><span class="field-name">rating</span><span class="field-type">DECIMAL(3,2)</span></div>
                        <div class="schema-field"><span class="field-name">avg_delivery_time</span><span class="field-type">INT</span></div>
                        <div class="schema-field"><span class="field-name field-idx">is_open</span><span class="field-type">BOOLEAN DEFAULT true</span></div>
                        <div class="schema-field"><span class="field-name">opening_hours</span><span class="field-type">JSONB</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
                    <span>N</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">üçΩÔ∏è menu_items</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">restaurant_id</span><span class="field-type">UUID FK ‚Üí restaurants.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">name</span><span class="field-type">VARCHAR(255)</span></div>
                        <div class="schema-field"><span class="field-name">description</span><span class="field-type">TEXT</span></div>
                        <div class="schema-field"><span class="field-name">price</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">category</span><span class="field-type">VARCHAR(100)</span></div>
                        <div class="schema-field"><span class="field-name">is_veg</span><span class="field-type">BOOLEAN</span></div>
                        <div class="schema-field"><span class="field-name">is_available</span><span class="field-type">BOOLEAN DEFAULT true</span></div>
                        <div class="schema-field"><span class="field-name">image_url</span><span class="field-type">TEXT</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">üìã orders</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK ‚Üí users.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">restaurant_id</span><span class="field-type">UUID FK ‚Üí restaurants.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">delivery_partner_id</span><span class="field-type">UUID FK ‚Üí delivery_partners.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(50)</span></div>
                        <div class="schema-field"><span class="field-name">total_amount</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">delivery_fee</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">delivery_address</span><span class="field-type">JSONB</span></div>
                        <div class="schema-field"><span class="field-name">delivery_location</span><span class="field-type">GEOGRAPHY(POINT)</span></div>
                        <div class="schema-field"><span class="field-name">estimated_delivery</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name field-idx">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
                    <span>N</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">üõí order_items</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">order_id</span><span class="field-type">UUID FK ‚Üí orders.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">menu_item_id</span><span class="field-type">UUID FK ‚Üí menu_items.id</span></div>
                        <div class="schema-field"><span class="field-name">quantity</span><span class="field-type">INT NOT NULL</span></div>
                        <div class="schema-field"><span class="field-name">unit_price</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">customizations</span><span class="field-type">JSONB</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">üö¥ delivery_partners</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR(255)</span></div>
                        <div class="schema-field"><span class="field-name">phone</span><span class="field-type">VARCHAR(15) UNIQUE</span></div>
                        <div class="schema-field"><span class="field-name field-idx">current_location</span><span class="field-type">GEOGRAPHY(POINT)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">is_available</span><span class="field-type">BOOLEAN</span></div>
                        <div class="schema-field"><span class="field-name">rating</span><span class="field-type">DECIMAL(3,2)</span></div>
                        <div class="schema-field"><span class="field-name">vehicle_type</span><span class="field-type">VARCHAR(50)</span></div>
                        <div class="schema-field"><span class="field-name">total_deliveries</span><span class="field-type">INT DEFAULT 0</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span></span>
                    <span>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>
                    <span></span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">üí≥ payments</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">order_id</span><span class="field-type">UUID FK ‚Üí orders.id UNIQUE</span></div>
                        <div class="schema-field"><span class="field-name">amount</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">method</span><span class="field-type">VARCHAR(50)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(50)</span></div>
                        <div class="schema-field"><span class="field-name">gateway_txn_id</span><span class="field-type">VARCHAR(255)</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>
            </div>

            <!-- Index Justification -->
            <div class="index-justification" style="margin-top: 24px;">
                <h5>üîç Index Strategy</h5>
                <table style="width: 100%; font-size: 14px;">
                    <tr>
                        <td><code>idx_restaurants_location</code></td>
                        <td>GIST on <code>location</code></td>
                        <td>Geospatial queries - find nearby restaurants O(log n)</td>
                    </tr>
                    <tr>
                        <td><code>idx_restaurants_cuisine</code></td>
                        <td>GIN on <code>cuisine_types</code></td>
                        <td>Array containment - filter by cuisine</td>
                    </tr>
                    <tr>
                        <td><code>idx_orders_user_status</code></td>
                        <td>B-tree on <code>(user_id, status)</code></td>
                        <td>User's active orders - "My Orders" screen</td>
                    </tr>
                    <tr>
                        <td><code>idx_orders_restaurant</code></td>
                        <td>B-tree on <code>(restaurant_id, created_at)</code></td>
                        <td>Restaurant order dashboard</td>
                    </tr>
                    <tr>
                        <td><code>idx_partners_location</code></td>
                        <td>GIST on <code>current_location</code></td>
                        <td>Find available partners within radius</td>
                    </tr>
                    <tr>
                        <td><code>idx_partners_available</code></td>
                        <td>B-tree on <code>is_available</code> WHERE true</td>
                        <td>Partial index - only available partners</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- SQL Queries -->
        <h3>üìù SQL Queries</h3>
        <div class="sql-query">
            <h5>Create Tables with PostGIS</h5>
<pre>-- Enable PostGIS extension
CREATE EXTENSION IF NOT EXISTS postgis;

CREATE TABLE restaurants (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name            VARCHAR(255) NOT NULL,
    location        GEOGRAPHY(POINT, 4326) NOT NULL,
    address         TEXT,
    cuisine_types   VARCHAR[] DEFAULT '{}',
    rating          DECIMAL(3,2) DEFAULT 0,
    avg_delivery_time INT DEFAULT 30,
    is_open         BOOLEAN DEFAULT true,
    opening_hours   JSONB,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE menu_items (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id   UUID REFERENCES restaurants(id) ON DELETE CASCADE,
    name            VARCHAR(255) NOT NULL,
    description     TEXT,
    price           DECIMAL(10,2) NOT NULL,
    category        VARCHAR(100),
    is_veg          BOOLEAN DEFAULT false,
    is_available    BOOLEAN DEFAULT true,
    image_url       TEXT
);

CREATE TABLE orders (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id             UUID NOT NULL REFERENCES users(id),
    restaurant_id       UUID NOT NULL REFERENCES restaurants(id),
    delivery_partner_id UUID REFERENCES delivery_partners(id),
    status              VARCHAR(50) DEFAULT 'placed',
    total_amount        DECIMAL(10,2) NOT NULL,
    delivery_fee        DECIMAL(10,2) DEFAULT 0,
    delivery_address    JSONB NOT NULL,
    delivery_location   GEOGRAPHY(POINT, 4326),
    estimated_delivery  TIMESTAMPTZ,
    created_at          TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE delivery_partners (
    id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name             VARCHAR(255) NOT NULL,
    phone            VARCHAR(15) UNIQUE NOT NULL,
    current_location GEOGRAPHY(POINT, 4326),
    is_available     BOOLEAN DEFAULT false,
    rating           DECIMAL(3,2) DEFAULT 5.0,
    vehicle_type     VARCHAR(50),
    total_deliveries INT DEFAULT 0
);

-- Geospatial Indexes
CREATE INDEX idx_restaurants_location ON restaurants USING GIST(location);
CREATE INDEX idx_restaurants_cuisine ON restaurants USING GIN(cuisine_types);
CREATE INDEX idx_partners_location ON delivery_partners USING GIST(current_location);
CREATE INDEX idx_partners_available ON delivery_partners(is_available) WHERE is_available = true;
CREATE INDEX idx_orders_user_status ON orders(user_id, status);
CREATE INDEX idx_orders_restaurant ON orders(restaurant_id, created_at DESC);</pre>
        </div>

        <div class="sql-query">
            <h5>Restaurant Search Query (Geospatial)</h5>
<pre>-- Find restaurants within 5km, sorted by distance
SELECT
    r.id, r.name, r.cuisine_types, r.rating, r.avg_delivery_time,
    ST_Distance(r.location, ST_MakePoint($1, $2)::geography) AS distance_meters
FROM restaurants r
WHERE
    r.is_open = true
    AND ST_DWithin(r.location, ST_MakePoint($1, $2)::geography, 5000)  -- 5km radius
    AND ($3 = '' OR $3 = ANY(r.cuisine_types))  -- optional cuisine filter
ORDER BY distance_meters ASC
LIMIT 50;

-- Find available delivery partners within 3km of restaurant
SELECT
    dp.id, dp.name, dp.rating,
    ST_Distance(dp.current_location, r.location) AS distance_meters
FROM delivery_partners dp
CROSS JOIN restaurants r
WHERE
    r.id = $1  -- restaurant_id
    AND dp.is_available = true
    AND ST_DWithin(dp.current_location, r.location, 3000)
ORDER BY dp.rating DESC, distance_meters ASC
LIMIT 10;</pre>
        </div>

        <div class="sql-query">
            <h5>Order Queries</h5>
<pre>-- Create order (POST /orders)
INSERT INTO orders (user_id, restaurant_id, total_amount, delivery_fee, delivery_address, delivery_location, estimated_delivery)
VALUES ($1, $2, $3, $4, $5, ST_MakePoint($6, $7)::geography, NOW() + INTERVAL '35 minutes')
RETURNING id, status, estimated_delivery, created_at;

-- Update order status (State Machine transition)
UPDATE orders
SET status = $2,
    delivery_partner_id = COALESCE($3, delivery_partner_id)
WHERE id = $1 AND status = $4  -- Ensure valid state transition
RETURNING id, status;

-- Get user's active orders
SELECT o.*, r.name as restaurant_name, dp.name as partner_name, dp.phone as partner_phone
FROM orders o
JOIN restaurants r ON o.restaurant_id = r.id
LEFT JOIN delivery_partners dp ON o.delivery_partner_id = dp.id
WHERE o.user_id = $1 AND o.status NOT IN ('delivered', 'cancelled')
ORDER BY o.created_at DESC;</pre>
        </div>

        <!-- API Design -->
        <h3>üîå API Design</h3>
        <div class="api-endpoint">
            <span class="api-method get">GET</span> <span class="api-path">/api/v1/restaurants</span>
<pre>
Request:
GET /api/v1/restaurants?lat=12.9716&lng=77.5946&cuisine=indian&radius=5000

Response: 200 OK
{
    <span class="json-key">"restaurants"</span>: [
        {
            <span class="json-key">"id"</span>: <span class="json-string">"uuid"</span>,
            <span class="json-key">"name"</span>: <span class="json-string">"Meghana Foods"</span>,
            <span class="json-key">"cuisine_types"</span>: [<span class="json-string">"biryani"</span>, <span class="json-string">"indian"</span>],
            <span class="json-key">"rating"</span>: <span class="json-number">4.5</span>,
            <span class="json-key">"avg_delivery_time"</span>: <span class="json-number">35</span>,
            <span class="json-key">"distance_km"</span>: <span class="json-number">1.2</span>,
            <span class="json-key">"is_open"</span>: <span class="json-boolean">true</span>,
            <span class="json-key">"delivery_fee"</span>: <span class="json-number">30</span>
        }
    ],
    <span class="json-key">"total"</span>: <span class="json-number">45</span>,
    <span class="json-key">"page"</span>: <span class="json-number">1</span>
}

Errors:
- 400: Invalid coordinates
- 429: Rate limit exceeded</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/orders</span>
<pre>
Request:
{
    <span class="json-key">"restaurant_id"</span>: <span class="json-string">"uuid"</span>,
    <span class="json-key">"items"</span>: [
        {
            <span class="json-key">"menu_item_id"</span>: <span class="json-string">"uuid"</span>,
            <span class="json-key">"quantity"</span>: <span class="json-number">2</span>,
            <span class="json-key">"customizations"</span>: {<span class="json-key">"spice_level"</span>: <span class="json-string">"medium"</span>, <span class="json-key">"extras"</span>: [<span class="json-string">"cheese"</span>]}
        }
    ],
    <span class="json-key">"delivery_address"</span>: {
        <span class="json-key">"lat"</span>: <span class="json-number">12.9800</span>,
        <span class="json-key">"lng"</span>: <span class="json-number">77.6000</span>,
        <span class="json-key">"address_line"</span>: <span class="json-string">"123 Main St, Bangalore"</span>,
        <span class="json-key">"landmark"</span>: <span class="json-string">"Near Metro Station"</span>
    },
    <span class="json-key">"payment_method"</span>: <span class="json-string">"upi"</span>,
    <span class="json-key">"coupon_code"</span>: <span class="json-string">"FIRST50"</span>
}

Response: 201 Created
{
    <span class="json-key">"order_id"</span>: <span class="json-string">"uuid"</span>,
    <span class="json-key">"status"</span>: <span class="json-string">"placed"</span>,
    <span class="json-key">"total_amount"</span>: <span class="json-number">599</span>,
    <span class="json-key">"delivery_fee"</span>: <span class="json-number">30</span>,
    <span class="json-key">"discount"</span>: <span class="json-number">50</span>,
    <span class="json-key">"estimated_delivery"</span>: <span class="json-string">"2024-01-15T13:30:00Z"</span>,
    <span class="json-key">"payment_status"</span>: <span class="json-string">"pending"</span>
}

Errors:
- 400: Invalid items / Restaurant closed
- 402: Payment failed
- 409: Item no longer available</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method ws">WS</span> <span class="api-path">/api/v1/orders/:orderId/track</span>
<pre>
// WebSocket connection for real-time order tracking
// Client connects after order is placed

// Server pushes updates:
{
    <span class="json-key">"type"</span>: <span class="json-string">"status_update"</span>,
    <span class="json-key">"order_id"</span>: <span class="json-string">"uuid"</span>,
    <span class="json-key">"status"</span>: <span class="json-string">"out_for_delivery"</span>,
    <span class="json-key">"partner"</span>: {
        <span class="json-key">"name"</span>: <span class="json-string">"Rahul"</span>,
        <span class="json-key">"phone"</span>: <span class="json-string">"+91-9876543210"</span>,
        <span class="json-key">"photo_url"</span>: <span class="json-string">"https://..."</span>
    },
    <span class="json-key">"location"</span>: {
        <span class="json-key">"lat"</span>: <span class="json-number">12.9750</span>,
        <span class="json-key">"lng"</span>: <span class="json-number">77.5980</span>
    },
    <span class="json-key">"eta_minutes"</span>: <span class="json-number">8</span>,
    <span class="json-key">"timestamp"</span>: <span class="json-string">"2024-01-15T13:22:00Z"</span>
}

// Status transitions pushed:
// placed ‚Üí confirmed ‚Üí preparing ‚Üí ready ‚Üí picked_up ‚Üí delivered</pre>
        </div>

        <!-- Database Alternatives -->
        <h3>üîÄ Database Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>‚úÖ <a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> + <a href="/interview-question/glossary#postgresql" class="info-term">PostGIS<span class="info-i">i</span></a> (Selected)</h5>
                <p>ACID compliance, geospatial support, proven at scale</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Native geospatial with <a href="/interview-question/glossary#postgresql" class="info-term">PostGIS<span class="info-i">i</span></a></li>
                            <li>ACID for order consistency</li>
                            <li>JSONB for flexible schemas</li>
                            <li>Rich ecosystem</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Single-node write bottleneck</li>
                            <li>Sharding complexity (Citus)</li>
                            <li>Real-time location updates load</li>
                        </ul>
                    </div>
                </div>
                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; font-size: 13px;">
                    <strong>‚ö†Ô∏è Care:</strong> Use <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> for high-frequency location updates. Batch DB writes every 30s.
                </div>
            </div>

            <div class="alternative-card">
                <h5><a href="/interview-question/glossary#mongodb" class="info-term">MongoDB<span class="info-i">i</span></a></h5>
                <p>Document store with geospatial indexes</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Native 2dsphere indexes<br>
                    <span style="color: #22c55e;">‚úì</span> Flexible menu schemas<br>
                    <span style="color: #22c55e;">‚úì</span> Easy horizontal scaling<br>
                    <span style="color: #ef4444;">‚úó</span> No ACID across documents<br>
                    <span style="color: #ef4444;">‚úó</span> Order consistency concerns
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> If menu schemas vary wildly across restaurants
                </div>
            </div>

            <div class="alternative-card">
                <h5>Cassandra</h5>
                <p>Wide-column store for order history</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Excellent write throughput<br>
                    <span style="color: #22c55e;">‚úì</span> Linear scalability<br>
                    <span style="color: #22c55e;">‚úì</span> Time-series order data<br>
                    <span style="color: #ef4444;">‚úó</span> No geospatial support<br>
                    <span style="color: #ef4444;">‚úó</span> Limited query flexibility
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Order history archive (completed orders, analytics)
                </div>
            </div>
        </div>

        <!-- Search Alternatives -->
        <h3>üîÄ Search Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>‚úÖ <a href="/interview-question/glossary#elasticsearch" class="info-term">Elasticsearch<span class="info-i">i</span></a> (Selected)</h5>
                <p>Full-text search with geo queries</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Typo tolerance (fuzzy search)</li>
                            <li>Relevance scoring</li>
                            <li>Geo_distance queries</li>
                            <li>Aggregations for filters</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Operational complexity</li>
                            <li>Memory hungry</li>
                            <li>Sync lag with primary DB</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="alternative-card">
                <h5><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> Full-Text Search</h5>
                <p>Built-in tsvector/tsquery</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> No extra infrastructure<br>
                    <span style="color: #22c55e;">‚úì</span> Always in sync<br>
                    <span style="color: #ef4444;">‚úó</span> Limited relevance tuning<br>
                    <span style="color: #ef4444;">‚úó</span> No fuzzy matching
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> MVP with &lt;10K restaurants, simple search needs
                </div>
            </div>

            <div class="alternative-card">
                <h5>Algolia</h5>
                <p>Managed search-as-a-service</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> &lt;10ms latency globally<br>
                    <span style="color: #22c55e;">‚úì</span> Zero ops<br>
                    <span style="color: #22c55e;">‚úì</span> Typo tolerance built-in<br>
                    <span style="color: #ef4444;">‚úó</span> Cost at scale ($$$)<br>
                    <span style="color: #ef4444;">‚úó</span> Vendor lock-in
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Fast time-to-market, budget available
                </div>
            </div>
        </div>

        <!-- Real-time Alternatives -->
        <h3>üîÄ Real-time Communication Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>‚úÖ WebSocket (Selected)</h5>
                <p>Full-duplex real-time communication</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Bi-directional communication</li>
                            <li>Low latency updates</li>
                            <li>Efficient for frequent updates</li>
                            <li>Wide browser support</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Connection management overhead</li>
                            <li>Scaling requires sticky sessions</li>
                            <li>Reconnection logic needed</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="alternative-card">
                <h5>Server-Sent Events (SSE)</h5>
                <p>Unidirectional server-to-client</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Simpler than WebSocket<br>
                    <span style="color: #22c55e;">‚úì</span> Auto-reconnection built-in<br>
                    <span style="color: #22c55e;">‚úì</span> Works over HTTP/2<br>
                    <span style="color: #ef4444;">‚úó</span> One-way only<br>
                    <span style="color: #ef4444;">‚úó</span> Limited browser connections
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Status updates only (no location from client)
                </div>
            </div>

            <div class="alternative-card">
                <h5>Long Polling</h5>
                <p>HTTP request held open</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Works everywhere<br>
                    <span style="color: #22c55e;">‚úì</span> No special infrastructure<br>
                    <span style="color: #22c55e;">‚úì</span> Firewall friendly<br>
                    <span style="color: #ef4444;">‚úó</span> Higher latency<br>
                    <span style="color: #ef4444;">‚úó</span> More server resources
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Fallback for WebSocket failures
                </div>
            </div>
        </div>

        <!-- Design Patterns -->
        <h3>üß© Design Patterns Used</h3>
        <div class="patterns-grid">
            <div class="pattern-card">
                <h5>State Machine Pattern</h5>
                <p>Order status transitions: placed ‚Üí confirmed ‚Üí preparing ‚Üí ready ‚Üí picked_up ‚Üí delivered. Each transition validates allowed states, triggers events.</p>
            </div>
            <div class="pattern-card">
                <h5>Saga Pattern</h5>
                <p>Distributed transaction for order: Reserve inventory ‚Üí Process payment ‚Üí Confirm order. Compensating actions on failure (refund, release inventory).</p>
            </div>
            <div class="pattern-card">
                <h5>CQRS Pattern</h5>
                <p>Separate read/write models. Writes to <a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> (orders), reads from <a href="/interview-question/glossary#elasticsearch" class="info-term">Elasticsearch<span class="info-i">i</span></a> (search) and <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> (tracking). Optimized for each use case.</p>
            </div>
            <div class="pattern-card">
                <h5>Event Sourcing</h5>
                <p>Store order events (OrderPlaced, OrderConfirmed, etc.) in <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a>. Rebuild state from events. Full audit trail for disputes.</p>
            </div>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">Order State Machine Implementation</h5>
<pre>const ORDER_TRANSITIONS = {
    'placed':     ['confirmed', 'cancelled'],
    'confirmed':  ['preparing', 'cancelled'],
    'preparing':  ['ready', 'cancelled'],
    'ready':      ['picked_up'],
    'picked_up':  ['delivered'],
    'delivered':  [],  // Terminal state
    'cancelled':  []   // Terminal state
};

class OrderStateMachine {
    constructor(order) {
        this.order = order;
    }

    canTransition(newStatus) {
        const allowed = ORDER_TRANSITIONS[this.order.status] || [];
        return allowed.includes(newStatus);
    }

    async transition(newStatus, metadata = {}) {
        if (!this.canTransition(newStatus)) {
            throw new Error(`Invalid transition: ${this.order.status} ‚Üí ${newStatus}`);
        }

        // Update order
        this.order.status = newStatus;
        await this.order.save();

        // Publish event
        await kafka.publish('order.status.changed', {
            orderId: this.order.id,
            fromStatus: this.order.status,
            toStatus: newStatus,
            timestamp: new Date(),
            ...metadata
        });

        return this.order;
    }
}</pre>
        </div>

        <!-- AWS Cost Estimation -->
        <h3>üí∞ AWS Cost Estimation (MVP)</h3>
        <div class="feature-card">
            <table class="cost-table">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Spec</th>
                        <th>Monthly Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="cost-tag aws">EC2</span> API Servers (4x)</td>
                        <td>t3.medium, 2 vCPU, 4GB</td>
                        <td>$120</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">RDS</span> <a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> + <a href="/interview-question/glossary#postgresql" class="info-term">PostGIS<span class="info-i">i</span></a></td>
                        <td>db.t3.large, Multi-AZ, 200GB</td>
                        <td>$250</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">ElastiCache</span> <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a></td>
                        <td>cache.t3.medium, 3GB</td>
                        <td>$50</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">OpenSearch</span> <a href="/interview-question/glossary#elasticsearch" class="info-term">Elasticsearch<span class="info-i">i</span></a></td>
                        <td>t3.small.search, 2 nodes</td>
                        <td>$80</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">MSK</span> <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a></td>
                        <td>kafka.t3.small, 3 brokers</td>
                        <td>$200</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">ALB</span> <a href="/interview-question/glossary#load-balancer" class="info-term">Load Balancer<span class="info-i">i</span></a></td>
                        <td>Application LB + 5M requests</td>
                        <td>$50</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag maps">Maps API</span> Google Maps</td>
                        <td>50K distance/directions calls</td>
                        <td>$250</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">S3</span> Images + Backups</td>
                        <td>100GB storage + <a href="/interview-question/glossary#cdn" class="info-term">CDN<span class="info-i">i</span></a></td>
                        <td>$30</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="2"><strong>Total MVP Monthly</strong></td>
                        <td><strong>~$1,030/month</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Deployment -->
        <h3>üöÄ Deployment (K8s)</h3>
        <div class="deployment-diagram">
            <h4>Kubernetes Architecture - <a href="/interview-question/glossary#microservices" class="info-term">Microservices<span class="info-i">i</span></a></h4>
            <div class="k8s-cluster">
                <h5>EKS Cluster - ap-south-1</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                    <div class="k8s-pod">üî∑ order-service (replicas: 3)</div>
                    <div class="k8s-pod">üî∑ restaurant-service (replicas: 2)</div>
                    <div class="k8s-pod">üî∑ delivery-service (replicas: 3)</div>
                    <div class="k8s-pod">üî∑ payment-service (replicas: 2)</div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <div class="k8s-pod" style="background: #7c3aed;">üìä Service Mesh: Istio</div>
                    <div class="k8s-pod" style="background: #0891b2;">üåê Ingress: ALB</div>
                    <div class="k8s-pod" style="background: #dc2626;">üîê Secrets: Vault</div>
                    <div class="k8s-pod" style="background: #ea580c;">üìà HPA: CPU/Memory</div>
                </div>
            </div>
        </div>

        <div class="diagram-container">
            <h4>K8s Deployment Architecture</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                <!-- Ingress Layer -->
                <div class="arch-box lb">ALB Ingress Controller<br><small>SSL termination, path routing</small></div>
                <div class="arch-arrow">‚Üì</div>

                <!-- Service Mesh -->
                <div style="padding: 16px; border: 2px dashed #7c3aed; border-radius: 12px; width: 90%; max-width: 600px;">
                    <div style="text-align: center; color: #7c3aed; font-weight: 600; margin-bottom: 12px;">Istio Service Mesh</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
                        <div style="text-align: center;">
                            <div class="arch-box server" style="padding: 10px 16px;">order-service<br><small>Deployment (3 replicas)</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">HPA: 3-20 pods</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="arch-box server" style="padding: 10px 16px;">restaurant-svc<br><small>Deployment (2 replicas)</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">HPA: 2-10 pods</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="arch-box server" style="padding: 10px 16px;">delivery-svc<br><small>Deployment (3 replicas)</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">HPA: 3-15 pods</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="arch-box server" style="padding: 10px 16px;">payment-svc<br><small>Deployment (2 replicas)</small></div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">HPA: 2-8 pods</div>
                        </div>
                    </div>
                </div>
                <div class="arch-arrow">‚Üì</div>

                <!-- Config & Secrets -->
                <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;">
                    <div class="arch-box" style="background: #dc2626; padding: 10px 16px;">Vault Secrets<br><small>DB creds, API keys</small></div>
                    <div class="arch-box" style="background: #0891b2; padding: 10px 16px;">ConfigMaps<br><small>Feature flags, env</small></div>
                    <div class="arch-box" style="background: #ea580c; padding: 10px 16px;">HPA/VPA<br><small>Auto-scaling</small></div>
                </div>
            </div>

            <div style="margin-top: 20px; background: #1e293b; padding: 16px; border-radius: 8px;">
                <div style="font-size: 13px; color: #94a3b8;">
                    <strong style="color: #60a5fa;">Key K8s Resources per Service:</strong>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 8px;">
                        <div><code>Deployment</code> - Pod replicas with rolling updates</div>
                        <div><code>Service</code> - ClusterIP for internal routing</div>
                        <div><code>HPA</code> - Scale on CPU/memory (70% threshold)</div>
                        <div><code>PodDisruptionBudget</code> - Min available during updates</div>
                        <div><code>ServiceAccount</code> - IRSA for AWS access</div>
                        <div><code>NetworkPolicy</code> - Pod-to-pod security</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CI/CD -->
        <h3>üîÑ CI/CD Pipeline</h3>
        <div class="diagram-container">
            <h4>GitHub Actions ‚Üí ECR ‚Üí EKS (Per-Service)</h4>
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 16px;">
                <div class="arch-box client" style="background: #24292e;">Git Push</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box server" style="background: #2088FF;">GitHub Actions</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box storage">ECR</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box gateway">ArgoCD</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box server">EKS</div>
            </div>
            <div style="margin-top: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                <strong>Pipeline Steps (Per Microservice):</strong>
                <ol style="font-size: 14px; margin-top: 8px;">
                    <li>Run unit tests (jest/mocha)</li>
                    <li>Run integration tests with testcontainers</li>
                    <li>Build Docker image</li>
                    <li>Push to ECR with git SHA tag</li>
                    <li>Update Kubernetes manifests (GitOps)</li>
                    <li>ArgoCD syncs to cluster (rolling update)</li>
                    <li>Run E2E smoke tests</li>
                    <li>Notify Slack on success/failure</li>
                </ol>
            </div>
        </div>

        <!-- Rollback Strategy -->
        <h3>‚è™ Rollback Strategy</h3>
        <div class="feature-card warning">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4>Instant Rollback</h4>
                    <div class="code-example" style="margin: 12px 0;">
<pre># Rollback specific service
kubectl rollout undo deployment/order-service

# Or via ArgoCD
argocd app rollback food-ordering --revision 42</pre>
                    </div>
                    <p style="font-size: 14px;">K8s keeps last 10 ReplicaSets. Rollback in &lt;30s.</p>
                </div>
                <div>
                    <h4>Feature Flags (LaunchDarkly)</h4>
                    <ul style="font-size: 14px;">
                        <li><code>new_payment_flow</code> - Toggle new UPI integration</li>
                        <li><code>surge_pricing</code> - Disable during PR issues</li>
                        <li><code>batch_delivery</code> - Gradual rollout 5% ‚Üí 100%</li>
                        <li>Instant disable without deployment</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Scale Metrics -->
        <h3>üìä Scale Metrics (MVP)</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">5K</div>
                <div class="label">Orders/Day</div>
            </div>
            <div class="metric">
                <div class="value">35min</div>
                <div class="label">Avg Delivery</div>
            </div>
            <div class="metric">
                <div class="value">500</div>
                <div class="label">Restaurants</div>
            </div>
            <div class="metric">
                <div class="value">99.5%</div>
                <div class="label">Order Success</div>
            </div>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Item Goes Out of Stock After Order Placed</div>
                <p>Customer orders an item, payment succeeds, but restaurant marks item unavailable before confirming.</p>
                <div class="case-solution">Implement inventory hold during checkout (5-min lock). On stock-out: auto-suggest substitutes via push notification, offer partial refund + credit, or full cancellation. Track "stock accuracy score" per restaurant for quality control.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Restaurant Closes Mid-Order</div>
                <p>Restaurant goes offline (closes early, emergency) after accepting order but before completion.</p>
                <div class="case-solution">Implement heartbeat check every 2 minutes from restaurant app. On 3 missed heartbeats: alert ops team, attempt phone call, auto-cancel if unresponsive for 10 min. Full refund + compensation coupon. <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a> event triggers customer notification.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">No Delivery Partner Available</div>
                <p>Order ready for pickup but no delivery partners within acceptable radius or all busy.</p>
                <div class="case-solution">Implement tiered radius expansion (3km ‚Üí 5km ‚Üí 8km). Activate surge incentives for partners. Show "high demand" warning at checkout. Fallback: offer self-pickup discount. Track "partner availability score" by zone/time for capacity planning.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Payment Failure After Food Prepared</div>
                <p>Async payment confirmation fails (bank timeout, insufficient funds detected late) after restaurant started cooking.</p>
                <div class="case-solution">Use payment pre-authorization (hold funds) before order confirmation. For COD: implement customer trust score based on history. Restaurant compensation fund for genuine failures. Flag repeat offenders, require prepaid only.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Order Modification After Confirmation</div>
                <p>Customer wants to add items, change address, or modify order after restaurant accepted.</p>
                <div class="case-solution">Allow modifications only in "confirmed" state, not "preparing". Address changes: recalculate delivery fee, check if within serviceable area. Item additions: create linked supplementary order. Implement modification window (e.g., 2 minutes post-confirmation).</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Customer Cancellation After Preparation Started</div>
                <p>Customer cancels order when food is already being prepared or ready.</p>
                <div class="case-solution">Implement progressive cancellation policy: full refund if "confirmed", 50% if "preparing", no refund if "ready". Show clear cancellation terms at checkout. Prepared food: offer to nearby customers at discount (food rescue feature) or donate to partner NGOs.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">Ghost Kitchens Management</div>
                <p>Support cloud kitchens operating multiple virtual brands from single location.</p>
                <div class="future-approach">New `virtual_brands` table linked to physical kitchen. Separate menus, ratings, and branding per brand. Shared inventory and preparation queue. Analytics dashboard for kitchen owners to optimize brand performance.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Drone Delivery Integration</div>
                <p>Autonomous drone delivery for short-distance orders in approved zones.</p>
                <div class="future-approach">Integrate with drone fleet API (Wing, Zipline). Geofence eligible delivery zones. Weight/size restrictions per order. Dual-mode: drone to hub + last-mile partner for restricted areas. Real-time airspace coordination.</div>
            </div>

            <div class="future-item">
                <div class="future-title">AI Menu Recommendations</div>
                <p>Personalized menu suggestions based on order history, time, weather, and preferences.</p>
                <div class="future-approach">ML model trained on user behavior (collaborative filtering + content-based). Real-time features: weather API, time of day, recent orders. A/B test recommendation placement. Track conversion lift per recommendation type.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Dynamic Delivery Zones</div>
                <p>Adjust restaurant delivery radius based on real-time demand, partner availability, and traffic.</p>
                <div class="future-approach">ML model predicts delivery time by zone. Contract radius during peak hours or bad weather. Expand for high-rated restaurants with good packaging. Real-time zone boundaries stored in <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a>, updated every 5 minutes.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How would you design the order state machine? What states and transitions are needed?</div>
                    <div class="followup-hint">States: placed ‚Üí confirmed ‚Üí preparing ‚Üí ready ‚Üí picked_up ‚Üí in_transit ‚Üí delivered. Also: cancelled, refunded. Validate transitions server-side. Store state history for disputes. Use <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a> events for each transition.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">How do you optimize delivery partner assignment to minimize delivery time?</div>
                    <div class="followup-hint">Multi-factor scoring: distance to restaurant, current order load, partner rating, vehicle type, historical performance in area. Consider batching nearby orders. Use <a href="/interview-question/glossary#postgresql" class="info-term">PostGIS<span class="info-i">i</span></a> for geospatial queries, rank top 10 candidates, send to best first with timeout.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">Design the restaurant onboarding flow. What validations and data are needed?</div>
                    <div class="followup-hint">KYC: FSSAI license verification, GST, bank account. Menu upload: structured format with categories, prices, images. Location verification via field visit or video call. Trial period with limited orders. Quality checklist before going live.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle peak hour traffic (IPL final + dinner time)?</div>
                    <div class="followup-hint">Queue-based order acceptance with back-pressure. Restaurant-level order caps. Pre-scale infrastructure based on event calendar. Surge pricing to balance demand. Disable non-essential features (reviews, recommendations). Cache aggressively.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle payment reconciliation with restaurants?</div>
                    <div class="followup-hint">Daily settlement batch job. Deduct platform commission, delivery partner payout, refunds, promotions. Generate detailed statement per restaurant. Handle disputes with order-level audit trail. Weekly/biweekly payout cycles based on restaurant tier.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>MVP Stage - Complete Order Flow</h4>
            <div class="flow-vertical">
                <!-- Customer Order Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">CUSTOMER ORDER JOURNEY</div>
                    <div class="flow-row">
                        <div class="flow-node user">Browse<br><small>Search restaurants</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Cart<br><small>Add items</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Checkout<br><small>Address + payment</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node gateway">Payment<br><small>UPI/Card/COD</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node db">Order Created<br><small>status: placed</small></div>
                    </div>
                </div>

                <!-- Order State Machine -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">ORDER STATE MACHINE</div>
                    <div class="flow-row">
                        <div class="flow-node" style="background: #fef3c7; color: #92400e;">PLACED</div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node" style="background: #dbeafe; color: #1e40af;">CONFIRMED</div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node" style="background: #fce7f3; color: #9d174d;">PREPARING</div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node" style="background: #d1fae5; color: #065f46;">READY</div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node" style="background: #e0e7ff; color: #3730a3;">PICKED UP</div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node" style="background: #dcfce7; color: #166534;">DELIVERED</div>
                    </div>
                    <div style="text-align: center; margin-top: 8px; font-size: 12px; color: #64748b;">
                        Any state can transition to CANCELLED (with refund rules based on current state)
                    </div>
                </div>

                <!-- Delivery Assignment Flow -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #dc2626; margin-bottom: 12px;">DELIVERY ASSIGNMENT FLOW</div>
                    <div class="flow-row">
                        <div class="flow-node service">Order Ready<br><small>Kafka event</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node db">Find Partners<br><small>PostGIS 3km</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Rank & Score<br><small>Distance + rating</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node cache">Push Request<br><small>30s timeout</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node user">Partner Accepts<br><small>Update order</small></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution Across Stages</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">üå±</div>
                    <div class="evolution-label">MVP</div>
                    <div class="evolution-db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> + <a href="/interview-question/glossary#postgresql" class="info-term">PostGIS<span class="info-i">i</span></a></div>
                    <div class="evolution-detail">Single primary<br>Multi-AZ standby<br>Geospatial queries</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">üîç</div>
                    <div class="evolution-label">+ Search</div>
                    <div class="evolution-db"><a href="/interview-question/glossary#elasticsearch" class="info-term">Elasticsearch<span class="info-i">i</span></a></div>
                    <div class="evolution-detail">Full-text search<br>Menu + restaurant<br>Fuzzy matching</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">üìñ</div>
                    <div class="evolution-label">+ Replicas</div>
                    <div class="evolution-db">Read Replicas</div>
                    <div class="evolution-detail">Separate read traffic<br>Analytics queries<br>Reporting dashboard</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">üìú</div>
                    <div class="evolution-label">+ Events</div>
                    <div class="evolution-db">Event Sourcing</div>
                    <div class="evolution-detail">Order event log<br>Full audit trail<br>State reconstruction</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- PAN-INDIA SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="pan-india">
        <div class="stage-header">
            <span class="stage-badge pan-india">PAN-India Scale</span>
            <h2 style="margin: 0;">Multi-City ‚Ä¢ 1M users ‚Ä¢ 50K Restaurants</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>üìã Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional Additions</h4>
                    <ul>
                        <li>Multi-city operations (50+ cities)</li>
                        <li>Regional language support</li>
                        <li>Multiple payment gateways (UPI, wallets)</li>
                        <li>Subscription plans (Pro membership)</li>
                        <li>Dynamic pricing (surge)</li>
                        <li>Restaurant self-onboarding</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Latency: &lt;150ms (regional)</li>
                        <li>Order Success Rate: 99.9%</li>
                        <li>Availability: 99.95%</li>
                        <li>50K concurrent users</li>
                        <li>100K orders/hour peak</li>
                    </ul>
                </div>
            </div>
        </div>

        <h3>üèóÔ∏è Architecture Evolution</h3>
        <div class="diagram-container">
            <h4>Multi-Region Architecture</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <div class="arch-box client">Users (All India)</div>
                <div class="arch-arrow">‚Üì</div>
                <div class="arch-box cdn">CloudFront <a href="/interview-question/glossary#cdn" class="info-term">CDN<span class="info-i">i</span></a><br><small>Static assets, menu images</small></div>
                <div class="arch-arrow">‚Üì</div>
                <div class="arch-box lb">Route 53 (Latency-based)</div>
                <div class="arch-arrow">‚Üì</div>
                <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: center;">
                    <div style="text-align: center; padding: 16px; border: 2px dashed #3b82f6; border-radius: 12px;">
                        <strong style="color: #3b82f6;">Mumbai (ap-south-1)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">EKS (8 nodes)</div>
                            <div class="arch-box cache" style="padding: 10px;">Redis Cluster</div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <div class="arch-box db" style="padding: 10px;">RDS Primary</div>
                            <div class="arch-box storage" style="padding: 10px;">OpenSearch</div>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 16px; border: 2px dashed #22c55e; border-radius: 12px;">
                        <strong style="color: #22c55e;">Hyderabad (ap-south-2)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">EKS (4 nodes)</div>
                            <div class="arch-box cache" style="padding: 10px;">Redis Replica</div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <div class="arch-box db" style="padding: 10px; opacity: 0.7;">RDS Read Replica</div>
                            <div class="arch-box storage" style="padding: 10px;">OpenSearch</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h3>üìà What Changes</h3>
        <div class="feature-card">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 30%;"><strong>City-based Sharding</strong></td>
                    <td>Restaurants and orders partitioned by city_id. Each city's data localized.</td>
                </tr>
                <tr>
                    <td><strong>Regional <a href="/interview-question/glossary#elasticsearch" class="info-term">Elasticsearch<span class="info-i">i</span></a></strong></td>
                    <td>Separate indices per region. Mumbai cluster handles West/South, Hyderabad handles East/North.</td>
                </tr>
                <tr>
                    <td><strong><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Global Datastore</strong></td>
                    <td>ElastiCache Global for session/cache. Cross-region replication &lt;1s.</td>
                </tr>
                <tr>
                    <td><strong>Payment Gateway Routing</strong></td>
                    <td>Razorpay primary, PayU fallback. Route based on success rates per region.</td>
                </tr>
                <tr>
                    <td><strong>Surge Pricing Engine</strong></td>
                    <td>Real-time demand/supply calculation per zone. <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a> streams for partner availability.</td>
                </tr>
            </table>
        </div>

        <!-- Database Schema Changes -->
        <h3>üóÑÔ∏è Database Schema - City Partitioning</h3>
        <div class="sql-query">
            <h5>Partitioned Tables for Multi-City</h5>
<pre>-- Partition orders by city for query performance
CREATE TABLE orders (
    id UUID NOT NULL,
    city_id INT NOT NULL,
    user_id UUID NOT NULL,
    restaurant_id UUID NOT NULL,
    status VARCHAR(50),
    total_amount DECIMAL(10,2),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (city_id, id)
) PARTITION BY LIST (city_id);

-- Create partitions for major cities
CREATE TABLE orders_mumbai PARTITION OF orders FOR VALUES IN (1);
CREATE TABLE orders_delhi PARTITION OF orders FOR VALUES IN (2);
CREATE TABLE orders_bangalore PARTITION OF orders FOR VALUES IN (3);
CREATE TABLE orders_hyderabad PARTITION OF orders FOR VALUES IN (4);
CREATE TABLE orders_other PARTITION OF orders DEFAULT;

-- City-based restaurant search
CREATE INDEX idx_restaurants_city_location ON restaurants
    USING GIST(location) WHERE city_id = ANY(ARRAY[1,2,3,4]);</pre>
        </div>

        <h3>üí∞ Cost at PAN-India Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr>
                    <td>EKS (12 nodes across 2 regions)</td>
                    <td>$2,000</td>
                </tr>
                <tr>
                    <td>RDS Primary + Read Replica</td>
                    <td>$800</td>
                </tr>
                <tr>
                    <td>ElastiCache Global (2 regions)</td>
                    <td>$300</td>
                </tr>
                <tr>
                    <td>OpenSearch (2 clusters)</td>
                    <td>$500</td>
                </tr>
                <tr>
                    <td>MSK Kafka (6 brokers)</td>
                    <td>$600</td>
                </tr>
                <tr>
                    <td>CloudFront (50TB transfer)</td>
                    <td>$4,000</td>
                </tr>
                <tr>
                    <td>Google Maps API (500K calls)</td>
                    <td>$2,500</td>
                </tr>
                <tr>
                    <td>Route 53 + Health Checks</td>
                    <td>$100</td>
                </tr>
                <tr class="total-row">
                    <td><strong>Total</strong></td>
                    <td><strong>~$10,800/month</strong></td>
                </tr>
            </table>
        </div>

        <!-- Scale Metrics -->
        <h3>üìä Scale Metrics (PAN-India)</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">500K</div>
                <div class="label">Orders/Day</div>
            </div>
            <div class="metric">
                <div class="value">28min</div>
                <div class="label">Avg Delivery</div>
            </div>
            <div class="metric">
                <div class="value">50K</div>
                <div class="label">Restaurants</div>
            </div>
            <div class="metric">
                <div class="value">15/day</div>
                <div class="label">New Restaurants</div>
            </div>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Cross-City Order Routing Failure</div>
                <p>User's GPS shows different city than delivery address, or order routed to wrong regional cluster.</p>
                <div class="case-solution">Use delivery address (not user location) for city routing. Validate city_id matches restaurant's city. Implement cross-city order rejection at checkout. Monitor city mismatch metrics in Datadog.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Regional Payment Gateway Outage</div>
                <p>Primary payment gateway (Razorpay) fails in specific region while other regions work fine.</p>
                <div class="case-solution">Multi-gateway setup: Razorpay primary, PayU secondary, Paytm tertiary. Circuit breaker per gateway per region. Auto-failover within 30s of detecting failures. Regional success rate dashboards for proactive switching.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Restaurant Chain Sync Issues</div>
                <p>Chain restaurant (Domino's) updates menu centrally but changes don't propagate to all outlets uniformly.</p>
                <div class="case-solution">Implement central menu template with outlet-level overrides. Event-driven sync via <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a>. Version tracking per outlet. Admin dashboard showing sync status. Alert on outlets with stale menu (>24h).</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Surge Pricing Backlash During Crisis</div>
                <p>Automatic surge pricing activates during natural disaster or emergency, causing PR crisis.</p>
                <div class="case-solution">Implement "crisis mode" flag that ops can activate per city. Auto-disable surge during declared emergencies. Geo-fence affected areas. Monitoring for unusual surge patterns + human review trigger.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Partner App Version Fragmentation</div>
                <p>Delivery partners using outdated app versions causing tracking failures or feature incompatibility.</p>
                <div class="case-solution">Force upgrade for critical versions. Graceful degradation for older versions. Backend compatibility layer for 2 versions back. In-app upgrade prompts with incentives. Track version distribution metrics.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Regional Language Menu Translation Errors</div>
                <p>Auto-translated menu items are incorrect or offensive in regional languages (Hindi, Tamil, etc.).</p>
                <div class="case-solution">Human-reviewed translations for top 1000 dishes. ML translation with confidence scores. Low-confidence items flagged for review. Restaurant-provided regional names preferred. User feedback loop for corrections.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">Multi-Restaurant Orders (Cart from Multiple Places)</div>
                <p>Allow customers to order from multiple nearby restaurants in single checkout.</p>
                <div class="future-approach">Group restaurants by delivery zone proximity. Single delivery partner picks up from multiple locations. Complex ETA calculation considering all stops. Split payment attribution per restaurant. Higher delivery fee for multi-stop.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Subscription Meal Plans</div>
                <p>Weekly/monthly subscription for regular meals (office lunch, diet plans).</p>
                <div class="future-approach">New `subscriptions` table with frequency, menu preferences. Auto-order generation at scheduled times. Pause/modify functionality. Discounted rates for commitment. Partner with health-focused restaurants for diet plans.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Live Kitchen Cameras</div>
                <p>Stream restaurant kitchen for food preparation transparency.</p>
                <div class="future-approach">WebRTC streaming integration. Opt-in for restaurants (premium badge). CDN for stream distribution. Recording for dispute resolution. Privacy-compliant with worker consent.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Predictive Pre-Ordering</div>
                <p>ML-based prediction of user's likely order, pre-staged at nearby restaurant.</p>
                <div class="future-approach">Train model on order history, time, day, weather. Confidence threshold for pre-staging. Restaurant incentives for participating. Significant delivery time reduction. Inventory risk mitigation strategy.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle database sharding by city while supporting cross-city users?</div>
                    <div class="followup-hint">Shard by city_id with routing layer. User profiles in separate global DB. Order queries always include city_id. Cross-city order history via scatter-gather (expensive, acceptable for history). Use Citus or Vitess for <a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> sharding.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">Design a surge pricing algorithm that balances supply and demand fairly.</div>
                    <div class="followup-hint">Calculate demand/supply ratio per zone (H3 hexagons). Tiers: 1.0x, 1.2x, 1.5x, 2.0x based on ratio. Cap at 2x to avoid backlash. Show surge prominently before checkout. Time-decay: reduce surge as partners arrive. ML model for demand prediction.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement restaurant self-onboarding at scale?</div>
                    <div class="followup-hint">Digital KYC via DigiLocker API. Automated FSSAI verification. Menu builder with image upload to S3. Contract signing via DocuSign. Initial low order cap (10/day) with gradual increase. Quality score based on early reviews.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How do you ensure read replicas are consistent for order tracking?</div>
                    <div class="followup-hint">Critical reads (order status) go to primary. Accept eventual consistency for search/browse (few seconds lag). Use <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> for real-time tracking (source of truth during delivery). Replica lag monitoring with automatic routing to primary if lag > 2s.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">Design the delivery partner incentive system to maximize coverage.</div>
                    <div class="followup-hint">Zone-based incentives for underserved areas. Peak hour bonuses. Streak bonuses (5 deliveries = extra). Rain/bad weather multipliers. Weekly guaranteed minimum for full-time partners. Real-time incentive display in partner app.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>PAN-India Stage - Multi-Region Order Flow</h4>
            <div class="flow-vertical">
                <!-- Regional Routing Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">REGIONAL REQUEST ROUTING</div>
                    <div class="flow-row">
                        <div class="flow-node user">User Request<br><small>Any city</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node gateway">Route 53<br><small>Latency-based</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node cdn">CloudFront<br><small>Edge cache</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Regional EKS<br><small>Mumbai/Hyderabad</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node db">City Shard<br><small>Partitioned data</small></div>
                    </div>
                </div>

                <!-- Cross-Region Data Sync -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">DATA SYNCHRONIZATION</div>
                    <div class="flow-row">
                        <div class="flow-node db">Primary DB<br><small>Mumbai (writes)</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node queue">Replication<br><small>Async &lt;1s</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node db">Read Replica<br><small>Hyderabad</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node cache"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Global<br><small>Session sync</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node storage">ES Cluster<br><small>Search index</small></div>
                    </div>
                </div>

                <!-- Order State at Scale -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #dc2626; margin-bottom: 12px;">DISTRIBUTED ORDER PROCESSING</div>
                    <div class="flow-row">
                        <div class="flow-node service">Order Service<br><small>Validate city</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node queue"><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a><br><small>City partition</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">City Consumer<br><small>Process order</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node db">City Shard<br><small>INSERT order</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Notify<br><small>Restaurant app</small></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution - PAN-India Stage</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">üèôÔ∏è</div>
                    <div class="evolution-label">City Partitions</div>
                    <div class="evolution-db">PostgreSQL Partitions</div>
                    <div class="evolution-detail">LIST partition by city_id<br>Partition pruning<br>Per-city indexes</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">üìñ</div>
                    <div class="evolution-label">Read Replicas</div>
                    <div class="evolution-db">Cross-Region Replicas</div>
                    <div class="evolution-detail">Mumbai ‚Üí Hyderabad<br>Read traffic split<br>&lt;1s replication lag</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">üåê</div>
                    <div class="evolution-label">Global Cache</div>
                    <div class="evolution-db">ElastiCache Global</div>
                    <div class="evolution-detail">Redis replication<br>Session sharing<br>Menu cache sync</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">üìä</div>
                    <div class="evolution-label">Analytics Split</div>
                    <div class="evolution-db">Redshift/BigQuery</div>
                    <div class="evolution-detail">OLAP workloads<br>Historical analysis<br>ML feature store</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- HIGH TRAFFIC -->
    <!-- ============================================ -->
    <div class="stage-section" id="high-traffic">
        <div class="stage-header">
            <span class="stage-badge high-traffic">High Traffic</span>
            <h2 style="margin: 0;">10M users ‚Ä¢ 200K Restaurants ‚Ä¢ 500K orders/hour</h2>
        </div>

        <h3>‚ö†Ô∏è What Breaks First</h3>
        <div class="feature-card warning">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 25%;"><strong>1. Order Service</strong></td>
                    <td>100K orders/minute during IPL match + dinner</td>
                    <td style="color: #22c55e;"><strong>‚Üí Queue-based order acceptance</strong></td>
                </tr>
                <tr>
                    <td><strong>2. Restaurant Overload</strong></td>
                    <td>Popular restaurants can't accept more orders</td>
                    <td style="color: #22c55e;"><strong>‚Üí Active order cap per restaurant</strong></td>
                </tr>
                <tr>
                    <td><strong>3. Partner Shortage</strong></td>
                    <td>Not enough drivers during peak hours</td>
                    <td style="color: #22c55e;"><strong>‚Üí Surge pricing + batch deliveries</strong></td>
                </tr>
                <tr>
                    <td><strong>4. Location Updates</strong></td>
                    <td>100K partners √ó 1 update/5s = 20K writes/sec</td>
                    <td style="color: #22c55e;"><strong>‚Üí <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Streams + batch to DB</strong></td>
                </tr>
                <tr>
                    <td><strong>5. Search Spikes</strong></td>
                    <td>Everyone searching "biryani" at 8pm</td>
                    <td style="color: #22c55e;"><strong>‚Üí Search result caching + <a href="/interview-question/glossary#cdn" class="info-term">CDN<span class="info-i">i</span></a></strong></td>
                </tr>
            </table>
        </div>

        <h3>üèóÔ∏è Architecture at Scale</h3>
        <div class="diagram-container">
            <h4>High-Traffic Architecture</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                <div class="arch-box cdn">CloudFront <a href="/interview-question/glossary#cdn" class="info-term">CDN<span class="info-i">i</span></a> (95% static hit rate)</div>
                <div class="arch-arrow">‚Üì</div>
                <div class="arch-box lb">NLB (Layer 4) + <a href="/interview-question/glossary#api-gateway" class="info-term">API Gateway<span class="info-i">i</span></a></div>
                <div class="arch-arrow">‚Üì</div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                    <div class="arch-box server">Order Pods (x20)</div>
                    <div class="arch-box server">Restaurant Pods (x10)</div>
                    <div class="arch-box server">Delivery Pods (x15)</div>
                    <div class="arch-box server">Search Pods (x8)</div>
                </div>
                <div class="arch-arrow">‚Üì</div>
                <div style="display: flex; gap: 30px; flex-wrap: wrap; justify-content: center;">
                    <div style="text-align: center;">
                        <div class="arch-box cache"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Cluster<br><small>32 shards</small></div>
                        <div style="font-size: 11px; color: #64748b;">Location + Session</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box queue"><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a><br><small>Order events</small></div>
                        <div style="font-size: 11px; color: #64748b;">100K msg/sec</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box storage">OpenSearch<br><small>5 node cluster</small></div>
                        <div style="font-size: 11px; color: #64748b;">Search + Analytics</div>
                    </div>
                </div>
                <div class="arch-arrow">‚Üì</div>
                <div style="display: flex; gap: 20px;">
                    <div class="arch-box db">Shard 0<br><small>Mumbai</small></div>
                    <div class="arch-box db">Shard 1<br><small>Delhi</small></div>
                    <div class="arch-box db">Shard 2<br><small>Bangalore</small></div>
                    <div class="arch-box db">Shard 3<br><small>Others</small></div>
                </div>
            </div>
        </div>

        <!-- High Traffic Solutions -->
        <h3>üõ†Ô∏è Solutions for Peak Traffic</h3>
        <div class="alternatives-grid">
            <div class="alternative-card">
                <h5>Order Queue System</h5>
                <p>Accept orders into <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a> queue, process async</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Never reject during peak<br>
                    <span style="color: #22c55e;">‚úì</span> Back-pressure handling<br>
                    <span style="color: #22c55e;">‚úì</span> Retry failed orders<br>
                    <span style="color: #ef4444;">‚úó</span> Slightly higher latency
                </div>
            </div>
            <div class="alternative-card">
                <h5>Restaurant Throttling</h5>
                <p>Cap active orders per restaurant</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Prevents kitchen overload<br>
                    <span style="color: #22c55e;">‚úì</span> Better delivery times<br>
                    <span style="color: #22c55e;">‚úì</span> Dynamic cap based on history<br>
                    <span style="color: #ef4444;">‚úó</span> Lost revenue during peak
                </div>
            </div>
            <div class="alternative-card">
                <h5>Delivery Batching</h5>
                <p>Combine nearby deliveries for same partner</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Better partner utilization<br>
                    <span style="color: #22c55e;">‚úì</span> Reduced delivery cost<br>
                    <span style="color: #ef4444;">‚úó</span> Complex routing algorithm<br>
                    <span style="color: #ef4444;">‚úó</span> Customer communication
                </div>
            </div>
        </div>

        <h3>üîÄ Message Queue Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>‚úÖ Amazon MSK (<a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a>)</h5>
                <p>High throughput, ordering guarantees</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Millions msg/sec<br>
                    <span style="color: #22c55e;">‚úì</span> Partition by order_id for ordering<br>
                    <span style="color: #22c55e;">‚úì</span> Replay capability<br>
                    <span style="color: #ef4444;">‚úó</span> Operational complexity
                </div>
            </div>
            <div class="alternative-card">
                <h5>Amazon SQS + SNS</h5>
                <p>Serverless pub/sub</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Zero ops<br>
                    <span style="color: #22c55e;">‚úì</span> Pay per message<br>
                    <span style="color: #ef4444;">‚úó</span> FIFO limited to 300 msg/sec<br>
                    <span style="color: #ef4444;">‚úó</span> No replay
                </div>
            </div>
            <div class="alternative-card">
                <h5><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Streams</h5>
                <p>Lightweight event streaming</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">‚úì</span> Already using <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a><br>
                    <span style="color: #22c55e;">‚úì</span> Consumer groups<br>
                    <span style="color: #ef4444;">‚úó</span> Memory-bound<br>
                    <span style="color: #ef4444;">‚úó</span> Less durable
                </div>
            </div>
        </div>

        <h3>üí∞ Cost at High Traffic</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (50 nodes, c5.2xlarge)</td><td>$12,000</td></tr>
                <tr><td>RDS Aurora (4 shards, db.r5.2xlarge)</td><td>$8,000</td></tr>
                <tr><td>ElastiCache Cluster (32 nodes)</td><td>$4,000</td></tr>
                <tr><td>MSK Kafka (12 brokers)</td><td>$3,000</td></tr>
                <tr><td>OpenSearch (5 nodes, r5.2xlarge)</td><td>$2,500</td></tr>
                <tr><td>CloudFront (200TB)</td><td>$16,000</td></tr>
                <tr><td>Google Maps API (2M calls)</td><td>$10,000</td></tr>
                <tr><td>Data Transfer</td><td>$3,000</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$58,500/month</strong></td></tr>
            </table>
        </div>

        <!-- Scale Metrics -->
        <h3>üìä Scale Metrics (High Traffic)</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">2M+</div>
                <div class="label">Orders/Day</div>
            </div>
            <div class="metric">
                <div class="value">25min</div>
                <div class="label">Avg Delivery</div>
            </div>
            <div class="metric">
                <div class="value">200K</div>
                <div class="label">Restaurants</div>
            </div>
            <div class="metric">
                <div class="value">99.9%</div>
                <div class="label">Order Success</div>
            </div>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title"><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a> Consumer Lag During Peak</div>
                <p>Order events pile up in <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a> faster than consumers can process during IPL final + dinner rush.</p>
                <div class="case-solution">Auto-scale consumer pods based on lag metrics. Implement priority queues (paid orders first). Shed load by temporarily rejecting new orders in overloaded zones. Pre-warm consumers before predicted peaks. Partition by zone for parallel processing.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Database Connection Pool Exhaustion</div>
                <p>All DB connections consumed, new requests timeout waiting for connection.</p>
                <div class="case-solution">Use PgBouncer for connection pooling (100 app connections ‚Üí 20 DB connections). Implement request queuing with timeout. Circuit breaker to fast-fail when pool exhausted. Monitor pool utilization, alert at 70%.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Cluster Node Failure</div>
                <p>One <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> cluster node dies, causing cache misses and increased DB load.</p>
                <div class="case-solution"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Cluster with replicas (3 masters + 3 replicas). Automatic failover in &lt;30s. Client-side retry with exponential backoff. Fallback to DB with circuit breaker. Monitor cluster health, pre-emptive node replacement.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Batch Delivery Coordination Failure</div>
                <p>Partner assigned multiple orders but one restaurant significantly delayed, affecting other orders in batch.</p>
                <div class="case-solution">Real-time batch rebalancing: split batch if delay >10 min. Reassign delayed order to another partner. Customer notification about delay with compensation offer. ML model to predict restaurant prep time for better batching.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Search Index Out of Sync</div>
                <p><a href="/interview-question/glossary#elasticsearch" class="info-term">Elasticsearch<span class="info-i">i</span></a> index lags behind <a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a>, showing closed restaurants as open or wrong prices.</p>
                <div class="case-solution">Real-time sync via Debezium CDC (Change Data Capture). Reconciliation job every hour. Critical fields (is_open, price) also checked against <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> cache. Monitoring for index lag with alerting. Force refresh on critical updates.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Hot Partition Problem</div>
                <p>One popular restaurant or zone creates hot partition in sharded database, causing uneven load.</p>
                <div class="case-solution">Sub-partition hot keys (restaurant_id + date). Implement request rate limiting per restaurant. Cache hot restaurant data more aggressively. Consider separate "celebrity restaurant" handling with dedicated resources.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">Real-time Demand Prediction</div>
                <p>ML model predicting order volume per zone 30-60 minutes ahead for proactive scaling.</p>
                <div class="future-approach">Features: historical patterns, weather, events, holidays, time. Model: LSTM or Prophet. Output: predicted orders per H3 hexagon. Actions: pre-scale pods, alert partner supply team, adjust surge pricing proactively.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Autonomous Delivery Robots</div>
                <p>Sidewalk robots for last-mile delivery in supported areas (campuses, gated communities).</p>
                <div class="future-approach">Partner with Starship or Nuro. Geofence supported areas. Customer app shows robot tracking. Secure compartment with OTP access. Fallback to human partner for failures. Cost savings on short-distance deliveries.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Voice Ordering Integration</div>
                <p>Order food via Alexa, Google Assistant, or in-app voice commands.</p>
                <div class="future-approach">NLU model for food ordering intent. Context-aware: "order my usual" uses order history. Confirmation flow before payment. Accessibility feature for visually impaired users. Integration with smart home routines.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Dynamic Kitchen Load Balancing</div>
                <p>Route orders to less busy outlet of chain restaurants based on real-time kitchen load.</p>
                <div class="future-approach">Real-time kitchen queue depth from restaurant app. For chains: suggest alternate outlet with shorter wait. Customer choice with ETA comparison. Incentivize switching with small discount. Analytics for restaurants on capacity optimization.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle thundering herd when a popular restaurant comes online?</div>
                    <div class="followup-hint">Rate limiting at API gateway per restaurant. Request coalescing for identical queries. Staggered cache warming. Virtual queue with estimated wait time. Lottery system for initial slots if demand exceeds capacity.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">Design the delivery batching algorithm to maximize efficiency without hurting customer experience.</div>
                    <div class="followup-hint">Constraints: max 2-3 orders per batch, all pickups within 500m, all deliveries within 2km radius, max 15 min added delay. Algorithm: greedy matching with constraint satisfaction. Customer opt-in for batch discount. Clear communication of batch status.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How do you implement circuit breakers across microservices?</div>
                    <div class="followup-hint">Use Istio service mesh or Hystrix/Resilience4j. Three states: closed, open, half-open. Metrics: error rate, latency percentiles. Per-service thresholds. Fallback responses (cached data, degraded experience). Dashboard showing circuit states.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement restaurant capacity management to prevent kitchen overload?</div>
                    <div class="followup-hint">Track active orders per restaurant. Dynamic cap based on historical completion rate. "Busy" indicator on customer app. Temporary pause accepting orders (restaurant-initiated). ML model learning optimal cap per restaurant per time slot.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">Design the real-time location tracking system for 100K concurrent delivery partners.</div>
                    <div class="followup-hint">Partner app sends GPS every 5s ‚Üí <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a> (partitioned by zone) ‚Üí <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> GEOADD. WebSocket server subscribes to relevant zone. Customer app connects via WebSocket, receives updates. Batch writes to <a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> every 30s for history. Compression for mobile data efficiency.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>High Traffic Stage - Peak Load Flow</h4>
            <div class="flow-vertical">
                <!-- Queue-Based Order Processing -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">QUEUE-BASED ORDER ACCEPTANCE</div>
                    <div class="flow-row">
                        <div class="flow-node user">Customer<br><small>Place order</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node gateway">API Gateway<br><small>Rate limit</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Validate<br><small>Quick checks</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node queue"><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a> Queue<br><small>order.pending</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node user">Ack: "Processing"<br><small>&lt;100ms</small></div>
                    </div>
                </div>

                <!-- Async Processing -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">ASYNC ORDER PROCESSING (BACK-PRESSURE HANDLING)</div>
                    <div class="flow-row">
                        <div class="flow-node queue"><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a><br><small>Consumer group</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Process Order<br><small>Auto-scaled pods</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node db">DB Shard<br><small>INSERT</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node cache"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a><br><small>Update status</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Push Notify<br><small>"Order confirmed"</small></div>
                    </div>
                </div>

                <!-- High-Frequency Location Updates -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #dc2626; margin-bottom: 12px;">LOCATION UPDATES (20K/sec)</div>
                    <div class="flow-row">
                        <div class="flow-node user">Partner GPS<br><small>Every 5s</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node queue"><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a> Stream<br><small>Zone partition</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node cache"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> GEOADD<br><small>Real-time</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">WebSocket<br><small>Push to customers</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node db">Batch to DB<br><small>Every 30s</small></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution - High Traffic Stage</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">üîÄ</div>
                    <div class="evolution-label">Sharding</div>
                    <div class="evolution-db">Vitess/Citus</div>
                    <div class="evolution-detail">Horizontal sharding<br>4 shards by city<br>Distributed queries</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">‚ö°</div>
                    <div class="evolution-label">Write Optimization</div>
                    <div class="evolution-db">Aurora + Redis</div>
                    <div class="evolution-detail">Write to Redis first<br>Async persist to DB<br>Eventual consistency</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">üìä</div>
                    <div class="evolution-label">CQRS</div>
                    <div class="evolution-db">Separate Read/Write</div>
                    <div class="evolution-detail">Write: PostgreSQL<br>Read: Elasticsearch<br>Sync via CDC</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">üî•</div>
                    <div class="evolution-label">Hot Data Tier</div>
                    <div class="evolution-db"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Cluster</div>
                    <div class="evolution-detail">Active orders in <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a><br>32 shard cluster<br>Sub-ms latency</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- GLOBAL SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="global">
        <div class="stage-header">
            <span class="stage-badge global">Global Scale</span>
            <h2 style="margin: 0;">100M users ‚Ä¢ 1M Restaurants ‚Ä¢ 10M orders/day</h2>
        </div>

        <h3>üåç Global Architecture</h3>
        <div class="diagram-container">
            <h4>Multi-Region Active-Active</h4>
            <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;">
                <div style="text-align: center; padding: 20px; background: rgba(59,130,246,0.1); border-radius: 12px;">
                    <strong>Asia-Pacific</strong>
                    <div style="font-size: 12px; color: #64748b;">India, SEA, ANZ</div>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(34,197,94,0.1); border-radius: 12px;">
                    <strong>Middle East</strong>
                    <div style="font-size: 12px; color: #64748b;">UAE, Saudi, Egypt</div>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(249,115,22,0.1); border-radius: 12px;">
                    <strong>Europe</strong>
                    <div style="font-size: 12px; color: #64748b;">UK, Germany, France</div>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(168,85,247,0.1); border-radius: 12px;">
                    <strong>Americas</strong>
                    <div style="font-size: 12px; color: #64748b;">US, Brazil, Mexico</div>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
            </div>
            <p style="margin-top: 16px;"><strong>CockroachDB:</strong> Distributed SQL with automatic geo-partitioning. Data stays in region for compliance (GDPR). Cross-region replication for disaster recovery.</p>
        </div>

        <h3>üìã Requirements at Global Scale</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Multi-currency support</li>
                        <li>Regional payment methods</li>
                        <li>Multi-language (20+ languages)</li>
                        <li>Local compliance (GDPR, etc.)</li>
                        <li>Regional cuisines and preferences</li>
                        <li>Cloud kitchen support</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Latency: &lt;100ms (regional)</li>
                        <li>Availability: 99.99%</li>
                        <li>RPO: &lt;1 minute</li>
                        <li>RTO: &lt;5 minutes</li>
                        <li>Data residency compliance</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- K8s at Global Scale -->
        <h3>üöÄ K8s Deployment at Global Scale</h3>
        <div class="deployment-diagram">
            <h4>Multi-Cluster Kubernetes with Service Mesh</h4>
            <div class="k8s-cluster">
                <h5>Global Service Mesh (Istio Multi-Cluster)</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                    <div class="k8s-pod">üåè ap-south-1 (100 pods)</div>
                    <div class="k8s-pod">üåç eu-west-1 (80 pods)</div>
                    <div class="k8s-pod">üåé us-east-1 (60 pods)</div>
                    <div class="k8s-pod">üèúÔ∏è me-south-1 (40 pods)</div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <div class="k8s-pod" style="background: #7c3aed;">üîÄ Global Load Balancer</div>
                    <div class="k8s-pod" style="background: #0891b2;">üìä Prometheus Federation</div>
                    <div class="k8s-pod" style="background: #dc2626;">üîê Vault (Multi-DC)</div>
                    <div class="k8s-pod" style="background: #ea580c;">üìà Cluster Autoscaler</div>
                </div>
            </div>
        </div>

        <!-- CI/CD at Global Scale -->
        <h3>üîÑ CI/CD Pipeline (Global)</h3>
        <div class="diagram-container">
            <h4>Canary Deployment by Region</h4>
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 16px;">
                <div class="arch-box client" style="background: #24292e;">Merge to main</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box server" style="background: #2088FF;">Build + Test</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box storage">Canary (5%)</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box gateway">Region by Region</div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box server">Global (100%)</div>
            </div>
            <div style="margin-top: 20px; text-align: left; max-width: 700px; margin-left: auto; margin-right: auto;">
                <strong>Rollout Strategy:</strong>
                <ol style="font-size: 14px; margin-top: 8px;">
                    <li>Deploy to canary cluster (5% traffic in ap-south-1)</li>
                    <li>Monitor error rates, latency for 30 minutes</li>
                    <li>Automated rollback if error rate &gt; 0.1%</li>
                    <li>Gradual rollout: ap-south-1 ‚Üí me-south-1 ‚Üí eu-west-1 ‚Üí us-east-1</li>
                    <li>Each region: 25% ‚Üí 50% ‚Üí 100% over 2 hours</li>
                    <li>Full global deployment in ~8 hours</li>
                </ol>
            </div>
        </div>

        <!-- Rollback Strategy -->
        <h3>‚è™ Rollback Strategy (Global)</h3>
        <div class="feature-card warning">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4>Canary by Region</h4>
                    <div class="code-example" style="margin: 12px 0;">
<pre># Rollback specific region
kubectl --context=ap-south-1 rollout undo deployment/order-service

# Progressive rollback (Argo Rollouts)
kubectl argo rollouts abort order-service</pre>
                    </div>
                    <p style="font-size: 14px;">Each region independent. One region failure doesn't affect others.</p>
                </div>
                <div>
                    <h4>Feature Flags for New Flows</h4>
                    <ul style="font-size: 14px;">
                        <li><code>new_checkout_flow</code> - By region/country</li>
                        <li><code>ml_eta_prediction</code> - Gradual by city</li>
                        <li><code>group_ordering</code> - By user cohort</li>
                        <li>Kill switch: Disable feature globally in &lt;1 min</li>
                    </ul>
                </div>
            </div>
        </div>

        <h3>üí∞ Cost at Global Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (4 regions, 300 nodes total)</td><td>$80,000</td></tr>
                <tr><td>CockroachDB Cloud (4 regions)</td><td>$50,000</td></tr>
                <tr><td>ElastiCache Global (4 regions)</td><td>$15,000</td></tr>
                <tr><td>OpenSearch (4 clusters)</td><td>$12,000</td></tr>
                <tr><td>Kafka/MSK (4 regions)</td><td>$15,000</td></tr>
                <tr><td>CloudFront (1PB)</td><td>$50,000</td></tr>
                <tr><td>Google Maps API (10M calls)</td><td>$50,000</td></tr>
                <tr><td>Monitoring (Datadog)</td><td>$10,000</td></tr>
                <tr><td>Data Transfer (cross-region)</td><td>$20,000</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$302,000/month</strong></td></tr>
            </table>
        </div>

        <!-- Scale Metrics -->
        <h3>üìä Scale Metrics (Global)</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">10M+</div>
                <div class="label">Orders/Day</div>
            </div>
            <div class="metric">
                <div class="value">22min</div>
                <div class="label">Avg Delivery</div>
            </div>
            <div class="metric">
                <div class="value">1M+</div>
                <div class="label">Restaurants</div>
            </div>
            <div class="metric">
                <div class="value">99.99%</div>
                <div class="label">Availability</div>
            </div>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Cross-Region Network Partition</div>
                <p>Network connectivity between regions fails (e.g., Asia-Pacific can't reach Europe), causing split-brain scenario.</p>
                <div class="case-solution">CockroachDB handles partitions via Raft consensus. Orders continue in each region independently. Conflict resolution on reconnection (last-write-wins with vector clocks). Monitor inter-region latency, alert on degradation. Graceful degradation: serve local data only.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">GDPR Data Deletion Across Regions</div>
                <p>EU user requests data deletion but their order history exists in multiple regional databases.</p>
                <div class="case-solution">Centralized GDPR service orchestrates deletion. Async deletion jobs per region with tracking. Verify deletion in all regions before confirmation. Anonymization for analytics retention. Audit log of deletion requests and completions.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Currency Exchange Rate Fluctuation</div>
                <p>Exchange rate changes between order placement and restaurant payout, causing financial discrepancy.</p>
                <div class="case-solution">Lock exchange rate at order time, store with order. Hedge currency exposure for large volumes. Settlement in local currency with platform absorbing minor fluctuations. Real-time rate feeds from multiple providers with fallback.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Regional Regulatory Changes</div>
                <p>New food delivery regulation in specific country (e.g., delivery fee caps, worker classification) requires immediate compliance.</p>
                <div class="case-solution">Feature flags per country/region. Compliance rule engine that can be updated without deployment. Legal review workflow for configuration changes. Region-specific pricing and policies. Kill switch for entire country if needed.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">DNS/<a href="/interview-question/glossary#cdn" class="info-term">CDN<span class="info-i">i</span></a> Global Outage</div>
                <p>CloudFront or Route 53 has global outage affecting all regions simultaneously.</p>
                <div class="case-solution">Multi-<a href="/interview-question/glossary#cdn" class="info-term">CDN<span class="info-i">i</span></a> strategy (CloudFront + Fastly). DNS failover to secondary provider. IP-based fallback (hardcoded IPs for critical services). Regional edge deployments. Chaos engineering to test failure scenarios quarterly.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Time Zone Edge Cases</div>
                <p>User orders at 11:55 PM, restaurant closes at midnight, delivery happens next day - which day's surge pricing applies?</p>
                <div class="case-solution">All timestamps in UTC internally. Lock pricing at order confirmation time. Restaurant hours evaluated in restaurant's local timezone. Clear display of "order for tomorrow" when crossing midnight. Edge case testing for DST transitions.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">Web3 Loyalty Program</div>
                <p>Blockchain-based loyalty tokens that can be traded or used across partner platforms.</p>
                <div class="future-approach">ERC-20 tokens on Polygon (low gas fees). Earn tokens per order. Redeem for discounts or trade on DEX. Partner integrations for cross-platform utility. Wallet connect for Web3 users, custodial wallet for others.</div>
            </div>

            <div class="future-item">
                <div class="future-title">AR Menu Visualization</div>
                <p>See 3D representation of dishes using phone camera before ordering.</p>
                <div class="future-approach">Partner with restaurants for 3D dish scans. WebXR for browser-based AR. Integration with Apple ARKit and Google ARCore. Start with top 100 dishes per city. User-generated content for community dishes.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Predictive Fleet Positioning</div>
                <p>ML-driven pre-positioning of delivery partners based on predicted demand patterns.</p>
                <div class="future-approach">Historical demand heatmaps + real-time signals (events, weather). Optimize partner distribution across H3 hexagons. Incentives for partners to relocate to predicted hot zones. Reduce average pickup time by 20%.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Sustainable Delivery Options</div>
                <p>Carbon-neutral delivery option with EV/bicycle fleet and carbon offset.</p>
                <div class="future-approach">Track carbon footprint per delivery. EV-only fleet in supported cities. Carbon offset integration for remaining emissions. "Green delivery" badge for eco-conscious users. Premium for express, discount for batched sustainable delivery.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle data sovereignty requirements (GDPR, data localization laws)?</div>
                    <div class="followup-hint">Geo-partitioning in CockroachDB: EU data stays in EU. PII encryption with region-specific keys. Data residency compliance dashboard. Cross-region queries blocked for sensitive data. Legal entity per major region.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">Design the global payment system supporting 50+ currencies and local payment methods.</div>
                    <div class="followup-hint">Stripe/Adyen as primary global processor. Local gateways for specific markets (Razorpay India, iDEAL Netherlands). Currency conversion at checkout with locked rate. Multi-currency settlement with restaurants. Fraud detection models trained per region.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How do you achieve 99.99% availability across 4 regions?</div>
                    <div class="followup-hint">Active-active deployment in all regions. Any region can serve any request (with latency penalty). Health checks and automatic traffic shifting. Zero-downtime deployments with canary. Chaos engineering (region failure drills). On-call rotation across time zones.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How would you design the global search system for 1M restaurants across different languages?</div>
                    <div class="followup-hint"><a href="/interview-question/glossary#elasticsearch" class="info-term">Elasticsearch<span class="info-i">i</span></a> per region with local language analyzers. Transliteration support (searching "biryani" finds "‡§¨‡§ø‡§∞‡§Ø‡§æ‡§®‡•Ä"). Federated search for travelers (query home region + current region). Search ranking tuned per market. A/B testing search relevance per region.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">Design the multi-region deployment strategy to minimize blast radius of bad deployments.</div>
                    <div class="followup-hint">Deploy to smallest region first (canary). Automated rollback on error rate spike. Progressive rollout: 5% ‚Üí 25% ‚Üí 50% ‚Üí 100% per region. Region-by-region with 2-hour soak time. Feature flags for instant disable. Separate deployment pipelines per region.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>Global Scale - Multi-Region Active-Active Flow</h4>
            <div class="flow-vertical">
                <!-- Global Request Routing -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">GLOBAL REQUEST ROUTING</div>
                    <div class="flow-row">
                        <div class="flow-node user">User Request<br><small>Any country</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node cdn">CloudFront <a href="/interview-question/glossary#cdn" class="info-term">CDN<span class="info-i">i</span></a><br><small>400+ edge locations</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node gateway">Route 53<br><small>Geo + latency</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node service">Nearest Region<br><small>EKS cluster</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node db">CockroachDB<br><small>Geo-partitioned</small></div>
                    </div>
                </div>

                <!-- Cross-Region Data Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">CROSS-REGION DATA SYNCHRONIZATION</div>
                    <div class="flow-row">
                        <div class="flow-node db">APAC<br><small>Primary for Asia</small></div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div class="flow-arrow">‚ü∑</div>
                            <span style="font-size: 10px; color: #64748b;">Raft consensus</span>
                        </div>
                        <div class="flow-node db">EMEA<br><small>Primary for Europe</small></div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div class="flow-arrow">‚ü∑</div>
                            <span style="font-size: 10px; color: #64748b;">Raft consensus</span>
                        </div>
                        <div class="flow-node db">Americas<br><small>Primary for US</small></div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div class="flow-arrow">‚ü∑</div>
                            <span style="font-size: 10px; color: #64748b;">Raft consensus</span>
                        </div>
                        <div class="flow-node db">ME<br><small>Primary for MENA</small></div>
                    </div>
                </div>

                <!-- Canary Deployment Flow -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #dc2626; margin-bottom: 12px;">CANARY DEPLOYMENT FLOW</div>
                    <div class="flow-row">
                        <div class="flow-node service">New Version<br><small>Build + test</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node" style="background: #fef3c7; color: #92400e;">Canary 5%<br><small>ap-south-1</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node" style="background: #dbeafe; color: #1e40af;">Region 1<br><small>Full rollout</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node" style="background: #d1fae5; color: #065f46;">Region 2-4<br><small>Sequential</small></div>
                        <div class="flow-arrow">‚Üí</div>
                        <div class="flow-node" style="background: #dcfce7; color: #166534;">Global 100%<br><small>~8 hours</small></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution - Global Scale</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">üåç</div>
                    <div class="evolution-label">Global SQL</div>
                    <div class="evolution-db">CockroachDB</div>
                    <div class="evolution-detail">Distributed SQL<br>Auto-sharding<br>Geo-partitioning</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">üîê</div>
                    <div class="evolution-label">Data Residency</div>
                    <div class="evolution-db">Regional Isolation</div>
                    <div class="evolution-detail">GDPR compliance<br>PII in-region<br>Encryption per region</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">üì°</div>
                    <div class="evolution-label">Event Mesh</div>
                    <div class="evolution-db">Confluent Global</div>
                    <div class="evolution-detail">Multi-region Kafka<br>Cluster linking<br>Geo-replication</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">üß†</div>
                    <div class="evolution-label">ML Platform</div>
                    <div class="evolution-db">Feature Store</div>
                    <div class="evolution-detail">Real-time features<br>Model serving<br>A/B experiments</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- CAP THEOREM ANALYSIS -->
    <!-- ============================================ -->
    <div class="cap-analysis-section" id="cap-analysis">
        <h2>CAP Theorem Analysis</h2>
        <p class="section-intro">Understanding the distributed systems tradeoffs in Food Ordering System design. <a href="/interview-question/components#cap-theorem" class="info-term">Learn more about CAP Theorem<span class="info-i">i</span></a></p>

        <div class="cap-choice-card mixed">
            <div class="cap-badge">Mixed CP/AP System</div>
            <h3>Food Ordering Uses Different CAP Choices for Different Components</h3>
            <p>A food ordering system can't be purely CP or AP. Order placement and payments need strong consistency to prevent double-charging or lost orders, while menu browsing and order tracking can use eventual consistency for better availability and performance.</p>
        </div>

        <!-- Component-wise CAP Analysis -->
        <div class="cap-component-breakdown">
            <h4>Component-wise CAP Analysis</h4>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>CAP Choice</th>
                        <th>Why?</th>
                        <th>Impact of Wrong Choice</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Order Placement</strong></td>
                        <td><span class="cap-tag cp">CP</span></td>
                        <td>Can't have duplicate orders or lost orders - money is involved</td>
                        <td>Double charging customer, restaurant makes food twice, inventory mismatch</td>
                    </tr>
                    <tr>
                        <td><strong>Payment Processing</strong></td>
                        <td><span class="cap-tag cp">CP</span></td>
                        <td>Financial transactions must be consistent - no partial debits</td>
                        <td>Money lost, disputes, legal issues, refund nightmares</td>
                    </tr>
                    <tr>
                        <td><strong>Restaurant Menu/Catalog</strong></td>
                        <td><span class="cap-tag ap">AP</span></td>
                        <td>Stale menu data for 30 seconds is acceptable</td>
                        <td>User sees old price - handle at checkout with price verification</td>
                    </tr>
                    <tr>
                        <td><strong>Order Tracking</strong></td>
                        <td><span class="cap-tag ap">AP</span></td>
                        <td>Status update 5 seconds late is fine for users</td>
                        <td>User sees "preparing" instead of "out for delivery" - minor UX issue</td>
                    </tr>
                    <tr>
                        <td><strong>Delivery Partner Location</strong></td>
                        <td><span class="cap-tag ap">AP</span></td>
                        <td>Location can be 10 seconds stale - GPS updates frequently anyway</td>
                        <td>Map shows slightly old position - acceptable for tracking</td>
                    </tr>
                    <tr>
                        <td><strong>Restaurant Availability</strong></td>
                        <td><span class="cap-tag ap">AP</span></td>
                        <td>Better to show potentially closed restaurant than error page</td>
                        <td>Handle "restaurant closed" gracefully at order time</td>
                    </tr>
                    <tr>
                        <td><strong>Inventory/Stock Levels</strong></td>
                        <td><span class="cap-tag cp">CP</span></td>
                        <td>Can't oversell items - leads to cancellations and bad UX</td>
                        <td>Order accepted but item unavailable, forced cancellation</td>
                    </tr>
                    <tr>
                        <td><strong>Ratings & Reviews</strong></td>
                        <td><span class="cap-tag ap">AP</span></td>
                        <td>New review appearing 1 minute late is acceptable</td>
                        <td>Slightly stale rating - negligible impact on decisions</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- CAP Decision Grid -->
        <div class="cap-decision-grid">
            <h4>Decision Framework: When to Choose CP vs AP</h4>
            <div class="decision-columns">
                <div class="decision-column cp">
                    <div class="column-header">
                        <span class="cap-tag cp">CP - Consistency + Partition Tolerance</span>
                    </div>
                    <div class="column-content">
                        <p><strong>Choose when:</strong></p>
                        <ul>
                            <li>Money is involved (payments, refunds)</li>
                            <li>Data loss is unacceptable (orders)</li>
                            <li>Duplicate actions cause real harm</li>
                            <li>Legal/compliance requirements exist</li>
                            <li>Inventory/stock management</li>
                        </ul>
                        <p><strong>Food Ordering Examples:</strong></p>
                        <ul>
                            <li>Order Service - exactly-once semantics</li>
                            <li>Payment Gateway integration</li>
                            <li>Wallet/credits deduction</li>
                            <li>Coupon redemption (one-time use)</li>
                        </ul>
                        <p><strong>Trade-off:</strong> Users may see errors during network partitions, but data integrity is preserved.</p>
                    </div>
                </div>
                <div class="decision-column ap">
                    <div class="column-header">
                        <span class="cap-tag ap">AP - Availability + Partition Tolerance</span>
                    </div>
                    <div class="column-content">
                        <p><strong>Choose when:</strong></p>
                        <ul>
                            <li>Stale data is acceptable temporarily</li>
                            <li>Read-heavy workloads dominate</li>
                            <li>User experience trumps perfect accuracy</li>
                            <li>Data can be reconciled later</li>
                            <li>High availability is critical for revenue</li>
                        </ul>
                        <p><strong>Food Ordering Examples:</strong></p>
                        <ul>
                            <li>Restaurant search and browse</li>
                            <li>Menu display with cached prices</li>
                            <li>Delivery tracking updates</li>
                            <li>Ratings and reviews display</li>
                        </ul>
                        <p><strong>Trade-off:</strong> Users always see a response, but data might be slightly outdated.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visual CAP Diagram -->
        <div class="cap-visual-diagram">
            <h4>Food Ordering System CAP Mapping</h4>
            <div class="cap-triangle-container">
                <div class="cap-triangle">
                    <div class="cap-vertex consistency">
                        <div class="vertex-label">Consistency</div>
                        <div class="vertex-desc">Every read receives the most recent write</div>
                    </div>
                    <div class="cap-vertex availability">
                        <div class="vertex-label">Availability</div>
                        <div class="vertex-desc">Every request receives a response</div>
                    </div>
                    <div class="cap-vertex partition">
                        <div class="vertex-label">Partition Tolerance</div>
                        <div class="vertex-desc">System operates despite network failures</div>
                    </div>
                    <div class="cap-center-text">Pick 2</div>
                </div>
                <div class="cap-services-mapping">
                    <div class="service-group cp-services">
                        <div class="group-label">CP Services (Consistency Priority)</div>
                        <div class="service-badges">
                            <span class="service-badge">Order Service</span>
                            <span class="service-badge">Payment Service</span>
                            <span class="service-badge">Inventory Service</span>
                            <span class="service-badge">Wallet Service</span>
                        </div>
                    </div>
                    <div class="service-group ap-services">
                        <div class="group-label">AP Services (Availability Priority)</div>
                        <div class="service-badges">
                            <span class="service-badge">Restaurant Catalog</span>
                            <span class="service-badge">Menu Service</span>
                            <span class="service-badge">Tracking Service</span>
                            <span class="service-badge">Search Service</span>
                            <span class="service-badge">Reviews Service</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Impact Analysis -->
        <div class="cap-business-impact">
            <h4>Business Impact Analysis</h4>
            <div class="impact-grid">
                <div class="impact-card negative">
                    <div class="impact-header">
                        <span class="impact-icon">X</span>
                        <span class="impact-title">Wrong: AP for Order Placement</span>
                    </div>
                    <div class="impact-body">
                        <p><strong>Scenario:</strong> User places order, network partition occurs, order written to one node but not replicated.</p>
                        <p><strong>Result:</strong></p>
                        <ul>
                            <li>Customer charged but restaurant never receives order</li>
                            <li>Or: Duplicate order created on partition heal</li>
                            <li>Support tickets, refunds, angry customers</li>
                            <li>Revenue loss from cancellations</li>
                        </ul>
                    </div>
                </div>
                <div class="impact-card positive">
                    <div class="impact-header">
                        <span class="impact-icon">OK</span>
                        <span class="impact-title">Correct: CP for Order Placement</span>
                    </div>
                    <div class="impact-body">
                        <p><strong>Scenario:</strong> Network partition occurs during order placement.</p>
                        <p><strong>Result:</strong></p>
                        <ul>
                            <li>User sees "Unable to place order, please retry"</li>
                            <li>No money charged until order confirmed</li>
                            <li>Order either fully succeeds or fully fails</li>
                            <li>Clean state, easy to retry</li>
                        </ul>
                    </div>
                </div>
                <div class="impact-card negative">
                    <div class="impact-header">
                        <span class="impact-icon">X</span>
                        <span class="impact-title">Wrong: CP for Menu Browsing</span>
                    </div>
                    <div class="impact-body">
                        <p><strong>Scenario:</strong> Network partition occurs, menu service waits for consistency.</p>
                        <p><strong>Result:</strong></p>
                        <ul>
                            <li>User sees loading spinner or error</li>
                            <li>User leaves app, orders from competitor</li>
                            <li>Lost revenue from browse-to-order funnel drop</li>
                            <li>Poor app store ratings</li>
                        </ul>
                    </div>
                </div>
                <div class="impact-card positive">
                    <div class="impact-header">
                        <span class="impact-icon">OK</span>
                        <span class="impact-title">Correct: AP for Menu Browsing</span>
                    </div>
                    <div class="impact-body">
                        <p><strong>Scenario:</strong> Network partition occurs during menu browse.</p>
                        <p><strong>Result:</strong></p>
                        <ul>
                            <li>User sees cached menu (maybe 30 sec stale)</li>
                            <li>User can browse, add items to cart</li>
                            <li>Price verification happens at checkout (CP)</li>
                            <li>High conversion, happy users</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Implementation Patterns -->
        <div class="cap-implementation">
            <h4>Implementation Patterns for Food Ordering</h4>
            <div class="implementation-cards">
                <div class="impl-card">
                    <div class="impl-header">
                        <span class="impl-icon">1</span>
                        <span class="impl-title">Saga Pattern for Orders (CP)</span>
                    </div>
                    <div class="impl-body">
                        <p>Use distributed saga for order placement to maintain consistency across services:</p>
                        <div class="code-example">
                            <pre>Order Saga Steps:
1. Reserve inventory      ‚Üí (compensate: release)
2. Authorize payment      ‚Üí (compensate: void auth)
3. Confirm with restaurant ‚Üí (compensate: cancel)
4. Assign delivery partner ‚Üí (compensate: unassign)
5. Finalize order         ‚Üí Saga complete

If step 3 fails: Run compensations for 2,1
Result: All-or-nothing order creation</pre>
                        </div>
                    </div>
                </div>
                <div class="impl-card">
                    <div class="impl-header">
                        <span class="impl-icon">2</span>
                        <span class="impl-title">CQRS for Menu/Catalog (AP)</span>
                    </div>
                    <div class="impl-body">
                        <p>Separate read and write models for high availability reads:</p>
                        <div class="code-example">
                            <pre>Write Side (CP):
- Restaurant updates menu in PostgreSQL
- Change event published to Kafka
- Strong consistency for writes

Read Side (AP):
- Menu cached in Redis (TTL: 30s)
- Elasticsearch for search
- Multiple read replicas
- Serve stale data during partitions

Reconciliation:
- Verify price at checkout time
- Show "price changed" if mismatch</pre>
                        </div>
                    </div>
                </div>
                <div class="impl-card">
                    <div class="impl-header">
                        <span class="impl-icon">3</span>
                        <span class="impl-title">Event Sourcing for Tracking (AP)</span>
                    </div>
                    <div class="impl-body">
                        <p>Use event sourcing for order tracking with eventual consistency:</p>
                        <div class="code-example">
                            <pre>Events Stream (Kafka):
- OrderPlaced
- OrderConfirmed
- PreparationStarted
- ReadyForPickup
- PartnerAssigned
- PickedUp
- OutForDelivery
- Delivered

Read Model:
- Project events to tracking state
- WebSocket pushes to user
- 3-5 second delay acceptable
- Multiple consumers for availability</pre>
                        </div>
                    </div>
                </div>
                <div class="impl-card">
                    <div class="impl-header">
                        <span class="impl-icon">4</span>
                        <span class="impl-title">Idempotency for Payments (CP)</span>
                    </div>
                    <div class="impl-body">
                        <p>Ensure exactly-once payment processing with idempotency keys:</p>
                        <div class="code-example">
                            <pre>Payment Flow:
1. Generate idempotency_key on client
2. Send payment request with key
3. Server checks: key exists in DB?
   - Yes: Return cached response
   - No: Process payment, store result

Database:
CREATE TABLE payment_requests (
  idempotency_key UUID PRIMARY KEY,
  order_id UUID NOT NULL,
  status VARCHAR(20),
  response JSONB,
  created_at TIMESTAMP
);

Result: Retry-safe payments</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consistency Boundaries -->
        <div class="cap-boundaries">
            <h4>Consistency Boundaries in Food Ordering</h4>
            <div class="boundary-diagram">
                <div class="boundary-zone cp-zone">
                    <div class="zone-header">Strong Consistency Zone (CP)</div>
                    <div class="zone-content">
                        <div class="zone-service">Order DB (PostgreSQL)</div>
                        <div class="zone-arrow">sync</div>
                        <div class="zone-service">Payment Service</div>
                        <div class="zone-arrow">sync</div>
                        <div class="zone-service">Inventory Service</div>
                    </div>
                    <div class="zone-note">Transactions span these services via Saga</div>
                </div>
                <div class="boundary-bridge">
                    <div class="bridge-label">Event Bridge (Async)</div>
                    <div class="bridge-tech">Kafka / SQS</div>
                </div>
                <div class="boundary-zone ap-zone">
                    <div class="zone-header">Eventual Consistency Zone (AP)</div>
                    <div class="zone-content">
                        <div class="zone-service">Menu Cache (Redis)</div>
                        <div class="zone-service">Search (Elasticsearch)</div>
                        <div class="zone-service">Tracking (WebSocket)</div>
                        <div class="zone-service">Analytics</div>
                    </div>
                    <div class="zone-note">Can be stale, rebuilt from events</div>
                </div>
            </div>
        </div>

        <!-- Interview Tip -->
        <div class="interview-tip">
            <h4>Interview Tip: Discussing CAP for Food Ordering</h4>
            <p><strong>Key talking points:</strong></p>
            <ul>
                <li><strong>Lead with business impact:</strong> "Order placement must be CP because a lost order means lost revenue and angry customers, while menu browsing can be AP because showing a 30-second stale menu is better than showing an error."</li>
                <li><strong>Show you understand trade-offs:</strong> "We sacrifice some availability on order placement (user might need to retry) to guarantee consistency. We sacrifice perfect consistency on menu display to ensure users can always browse."</li>
                <li><strong>Mention specific patterns:</strong> "We use Saga pattern for distributed transactions in order placement, CQRS for menu reads, and idempotency keys for payment retries."</li>
                <li><strong>Discuss the boundary:</strong> "The key is defining clear boundaries - CP services communicate with AP services through async events, allowing each zone to optimize for its priority."</li>
            </ul>
        </div>
    </div>
</div>

<!-- Tooltip System -->
<div class="tooltip-overlay" id="tooltipOverlay" onclick="closeTooltip()"></div>
<div class="tooltip-popup" id="tooltipPopup">
    <button class="tooltip-close" onclick="closeTooltip()">&times;</button>
    <h4 id="tooltipTitle"></h4>
    <div id="tooltipContent"></div>
</div>

<script>
const termDefinitions = {
    'postgis': {
        title: 'PostGIS - Geospatial Extension',
        content: `<p>PostgreSQL extension for geographic objects and spatial queries.</p>
        <div style="margin-top: 16px;">
            <strong>Key Functions:</strong>
            <pre style="background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; font-size: 13px;">-- Find restaurants within 5km
ST_DWithin(location, point, 5000)

-- Calculate distance
ST_Distance(a.location, b.location)

-- Create point from coordinates
ST_MakePoint(longitude, latitude)</pre>
        </div>`
    },
    'kafka': {
        title: 'Apache Kafka / Amazon MSK',
        content: `<p>Distributed event streaming platform for high-throughput messaging.</p>
        <div style="margin-top: 16px;">
            <strong>Order Events:</strong>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0;">
                <span style="background: #22c55e; color: white; padding: 4px 8px; border-radius: 4px;">order.placed</span>
                <span style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px;">order.confirmed</span>
                <span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px;">order.preparing</span>
                <span style="background: #8b5cf6; color: white; padding: 4px 8px; border-radius: 4px;">order.delivered</span>
            </div>
        </div>`
    },
    'saga': {
        title: 'Saga Pattern',
        content: `<p>Manage distributed transactions across microservices with compensating actions.</p>
        <div style="margin-top: 16px;">
            <strong>Order Saga:</strong>
            <ol style="font-size: 13px;">
                <li>Reserve inventory ‚Üí (compensate: release inventory)</li>
                <li>Process payment ‚Üí (compensate: refund)</li>
                <li>Confirm order ‚Üí (compensate: cancel order)</li>
                <li>Assign delivery ‚Üí (compensate: unassign)</li>
            </ol>
        </div>`
    }
};

function showTooltip(term) {
    const def = termDefinitions[term];
    if (def) {
        document.getElementById('tooltipTitle').textContent = def.title;
        document.getElementById('tooltipContent').innerHTML = def.content;
        document.getElementById('tooltipOverlay').classList.add('show');
        document.getElementById('tooltipPopup').classList.add('show');
    }
}

function closeTooltip() {
    document.getElementById('tooltipOverlay').classList.remove('show');
    document.getElementById('tooltipPopup').classList.remove('show');
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeTooltip(); });

// Scroll spy
window.addEventListener('scroll', function() {
    const sections = document.querySelectorAll('.stage-section, .cap-analysis-section');
    const navLinks = document.querySelectorAll('.quick-nav a');
    let current = '';
    sections.forEach(section => {
        if (scrollY >= section.offsetTop - 200) current = section.id;
    });
    navLinks.forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === '#' + current);
    });
});
</script>
