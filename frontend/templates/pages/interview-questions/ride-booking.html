<link rel="stylesheet" href="/static/css/interview-questions.css">

<div class="interview-topic-layout">
    <a href="/interview-question" class="back-to-dashboard">← Back to All Topics</a>

    <h1>Ride Booking System Design</h1>
    <p class="topic-description">Design a ride-sharing platform like Uber/Ola with real-time matching, GPS tracking, and surge pricing</p>

    <div class="quick-nav">
        <h4>Navigation</h4>
        <a href="#mvp">MVP Stage</a>
        <a href="#pan-india">PAN-India</a>
        <a href="#high-traffic">High Traffic</a>
        <a href="#global">Global</a>
        <a href="#cap-analysis">CAP Analysis</a>
    </div>

    <!-- ============================================ -->
    <!-- MVP STAGE -->
    <!-- ============================================ -->
    <div class="stage-section" id="mvp">
        <div class="stage-header">
            <span class="stage-badge mvp">MVP Stage</span>
            <h2 style="margin: 0;">Single City - 10K drivers - 50K rides/day</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Request ride with pickup/dropoff</li>
                        <li>Match nearest available driver</li>
                        <li>Real-time trip tracking</li>
                        <li>Fare calculation with distance/time</li>
                        <li>Driver/rider ratings (1-5 stars)</li>
                        <li>Payment processing</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Matching latency: &lt;3 seconds</li>
                        <li>Location update: every 4 seconds</li>
                        <li>Availability: 99.9%</li>
                        <li>Throughput: 1000 rides/hour</li>
                        <li>ETA accuracy: +/- 2 minutes</li>
                        <li>Driver radius: 5km search</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE DIAGRAM -->
        <h3>Architecture</h3>
        <div class="diagram-container">
            <h4>MVP Architecture - Single City</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <!-- Layer 1: Clients -->
                <div style="display: flex; gap: 40px;">
                    <div class="arch-box client">Rider App<br><small>iOS/Android</small></div>
                    <div class="arch-box client">Driver App<br><small>iOS/Android</small></div>
                </div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 2: Load Balancer -->
                <div class="arch-box lb"><a href="/interview-question/glossary#load-balancer" class="info-term">Load Balancer<span class="info-i">i</span></a><br><small>WebSocket + REST</small></div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 3: Services -->
                <div style="display: flex; gap: 20px;">
                    <div class="arch-box server">API Server<br><small>Go/Fiber</small></div>
                    <div class="arch-box server">Location Service<br><small><a href="/interview-question/glossary#websocket" class="info-term">WebSocket<span class="info-i">i</span></a></small></div>
                    <div class="arch-box server">Matching Engine<br><small><a href="/interview-question/glossary#postgresql" class="info-term">Geospatial<span class="info-i">i</span></a></small></div>
                </div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 4: Data -->
                <div style="display: flex; gap: 40px; align-items: flex-start;">
                    <div style="text-align: center;">
                        <div class="arch-box cache"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> GEO<br><small>Driver Locations</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">GEOADD/GEORADIUS<br>4-sec TTL</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> + PostGIS<br><small>db.r5.large</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Rides, Users<br>Multi-AZ</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box queue"><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a><br><small>Events</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Location stream<br>Analytics</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Ride Request -->
        <h3>Data Flow - Ride Request</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Rider</div>
                    <div class="flow-step-label">POST /ride/request</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">API</div>
                    <div class="flow-step-label">Validate + Create</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box db" style="padding: 10px 16px;">PostgreSQL</div>
                    <div class="flow-step-label">INSERT ride_request</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box queue" style="padding: 10px 16px;">Kafka</div>
                    <div class="flow-step-label">ride.requested event</div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Driver Matching -->
        <h3>Data Flow - Driver Matching</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Matching</div>
                    <div class="flow-step-label">Consume event</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box cache" style="padding: 10px 16px;">Redis GEO</div>
                    <div class="flow-step-label">GEORADIUS 5km</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Score</div>
                    <div class="flow-step-label">Rank by distance+rating</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Driver</div>
                    <div class="flow-step-label">Push notification</div>
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div style="color: #f59e0b; font-weight: 600;">15s timeout:</div>
                <div class="arch-arrow">→</div>
                <div>Cascade to next driver</div>
                <div class="arch-arrow">→</div>
                <div style="color: #ef4444;">After 3 attempts: No drivers available</div>
            </div>
        </div>

        <!-- DATA FLOW - Real-time Tracking -->
        <h3>Data Flow - Real-time Tracking</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Driver GPS</div>
                    <div class="flow-step-label">Every 4 sec</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box cache" style="padding: 10px 16px;">Redis</div>
                    <div class="flow-step-label">GEOADD + PUBLISH</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">WS Server</div>
                    <div class="flow-step-label">Subscribe channel</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Rider App</div>
                    <div class="flow-step-label">Update map marker</div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Fare Calculation -->
        <h3>Data Flow - Fare Calculation</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Driver</div>
                    <div class="flow-step-label">End trip</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Fare Engine</div>
                    <div class="flow-step-label">base + (km*rate) + (min*rate)</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Surge</div>
                    <div class="flow-step-label">Apply multiplier</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box db" style="padding: 10px 16px;">Payment</div>
                    <div class="flow-step-label">Charge rider</div>
                </div>
            </div>
        </div>

        <!-- DATABASE SCHEMA -->
        <h3>Database Schema</h3>
        <div class="diagram-container">
            <h4>PostgreSQL + PostGIS Schema</h4>
            <div class="schema-diagram">
                <div class="schema-table">
                    <div class="schema-table-header">users</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR(255)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">phone</span><span class="field-type">VARCHAR(15) UNIQUE</span></div>
                        <div class="schema-field"><span class="field-name">email</span><span class="field-type">VARCHAR(255)</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>─────</span>
                    <span>1</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">drivers</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK → users.id</span></div>
                        <div class="schema-field"><span class="field-name">vehicle_type</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">vehicle_number</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">rating</span><span class="field-type">DECIMAL(3,2)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(20)</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">ride_requests</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">rider_id</span><span class="field-type">UUID FK → users.id</span></div>
                        <div class="schema-field"><span class="field-name">pickup_location</span><span class="field-type">GEOGRAPHY(POINT)</span></div>
                        <div class="schema-field"><span class="field-name">dropoff_location</span><span class="field-type">GEOGRAPHY(POINT)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">vehicle_type</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>─────</span>
                    <span>1</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">rides</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">request_id</span><span class="field-type">UUID FK → ride_requests.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">driver_id</span><span class="field-type">UUID FK → drivers.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">pickup_time</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">dropoff_time</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">distance_km</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">fare</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">surge_multiplier</span><span class="field-type">DECIMAL(3,2)</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">driver_locations</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">driver_id</span><span class="field-type">UUID PK FK</span></div>
                        <div class="schema-field"><span class="field-name field-idx">location</span><span class="field-type">GEOGRAPHY(POINT)</span></div>
                        <div class="schema-field"><span class="field-name">heading</span><span class="field-type">INTEGER</span></div>
                        <div class="schema-field"><span class="field-name field-idx">is_available</span><span class="field-type">BOOLEAN</span></div>
                        <div class="schema-field"><span class="field-name">updated_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">payments</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">ride_id</span><span class="field-type">UUID FK → rides.id</span></div>
                        <div class="schema-field"><span class="field-name">amount</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">method</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">ratings</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">ride_id</span><span class="field-type">UUID FK → rides.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">from_user_id</span><span class="field-type">UUID FK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">to_user_id</span><span class="field-type">UUID FK</span></div>
                        <div class="schema-field"><span class="field-name">score</span><span class="field-type">INTEGER (1-5)</span></div>
                        <div class="schema-field"><span class="field-name">comment</span><span class="field-type">TEXT</span></div>
                    </div>
                </div>
            </div>

            <!-- Index Strategy -->
            <div class="index-justification" style="margin-top: 24px;">
                <h5>Index Strategy</h5>
                <table style="width: 100%; font-size: 14px;">
                    <tr>
                        <td><code>idx_driver_locations_geo</code></td>
                        <td>GIST on <code>location</code></td>
                        <td>O(log n) geospatial queries - GEORADIUS equivalent</td>
                    </tr>
                    <tr>
                        <td><code>idx_driver_locations_avail</code></td>
                        <td>B-tree on <code>(is_available, location)</code></td>
                        <td>Filter available drivers before geo query</td>
                    </tr>
                    <tr>
                        <td><code>idx_rides_status</code></td>
                        <td>B-tree on <code>(status, created_at)</code></td>
                        <td>Active rides monitoring dashboard</td>
                    </tr>
                    <tr>
                        <td><code>idx_rides_driver</code></td>
                        <td>B-tree on <code>driver_id</code></td>
                        <td>Driver's ride history and earnings</td>
                    </tr>
                    <tr>
                        <td><code>idx_payments_status</code></td>
                        <td>B-tree on <code>(status, created_at)</code></td>
                        <td>Pending payment reconciliation</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- SQL Queries -->
        <h3>SQL Queries</h3>
        <div class="sql-query">
            <h5>Create Tables with PostGIS</h5>
<pre>CREATE EXTENSION IF NOT EXISTS postgis;

CREATE TABLE users (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name        VARCHAR(255) NOT NULL,
    phone       VARCHAR(15) UNIQUE NOT NULL,
    email       VARCHAR(255),
    created_at  TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE drivers (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID REFERENCES users(id) ON DELETE CASCADE,
    vehicle_type    VARCHAR(20) NOT NULL,  -- 'auto', 'sedan', 'suv'
    vehicle_number  VARCHAR(20) NOT NULL,
    rating          DECIMAL(3,2) DEFAULT 5.0,
    status          VARCHAR(20) DEFAULT 'offline'  -- 'online', 'busy', 'offline'
);

CREATE TABLE driver_locations (
    driver_id    UUID PRIMARY KEY REFERENCES drivers(id),
    location     GEOGRAPHY(POINT, 4326) NOT NULL,
    heading      INTEGER,  -- 0-360 degrees
    is_available BOOLEAN DEFAULT false,
    updated_at   TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_driver_locations_geo ON driver_locations USING GIST(location);
CREATE INDEX idx_driver_locations_avail ON driver_locations(is_available);

CREATE TABLE ride_requests (
    id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    rider_id         UUID REFERENCES users(id),
    pickup_location  GEOGRAPHY(POINT, 4326) NOT NULL,
    dropoff_location GEOGRAPHY(POINT, 4326) NOT NULL,
    status           VARCHAR(20) DEFAULT 'pending',
    vehicle_type     VARCHAR(20) NOT NULL,
    created_at       TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE rides (
    id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    request_id       UUID REFERENCES ride_requests(id),
    driver_id        UUID REFERENCES drivers(id),
    status           VARCHAR(20) DEFAULT 'matched',
    pickup_time      TIMESTAMPTZ,
    dropoff_time     TIMESTAMPTZ,
    distance_km      DECIMAL(10,2),
    fare             DECIMAL(10,2),
    surge_multiplier DECIMAL(3,2) DEFAULT 1.0
);

CREATE INDEX idx_rides_status ON rides(status, created_at DESC);
CREATE INDEX idx_rides_driver ON rides(driver_id);</pre>
        </div>

        <div class="sql-query">
            <h5>Location and Matching Queries</h5>
<pre>-- Find available drivers within 5km radius (PostGIS)
SELECT d.id, d.rating, d.vehicle_type,
       ST_Distance(dl.location, ST_MakePoint($1, $2)::geography) as distance_m
FROM drivers d
JOIN driver_locations dl ON d.id = dl.driver_id
WHERE dl.is_available = true
  AND d.vehicle_type = $3
  AND ST_DWithin(dl.location, ST_MakePoint($1, $2)::geography, 5000)
ORDER BY distance_m ASC
LIMIT 10;

-- Update driver location (called every 4 seconds)
INSERT INTO driver_locations (driver_id, location, heading, is_available, updated_at)
VALUES ($1, ST_MakePoint($2, $3)::geography, $4, $5, NOW())
ON CONFLICT (driver_id)
DO UPDATE SET location = EXCLUDED.location,
              heading = EXCLUDED.heading,
              is_available = EXCLUDED.is_available,
              updated_at = NOW();

-- Get ride with all details
SELECT r.*, rr.pickup_location, rr.dropoff_location,
       u.name as rider_name, u.phone as rider_phone,
       d.vehicle_number, du.name as driver_name
FROM rides r
JOIN ride_requests rr ON r.request_id = rr.id
JOIN users u ON rr.rider_id = u.id
JOIN drivers d ON r.driver_id = d.id
JOIN users du ON d.user_id = du.id
WHERE r.id = $1;</pre>
        </div>

        <!-- API Design -->
        <h3>API Design</h3>
        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/ride/request</span>
<pre>
Request:
{
    <span class="json-key">"pickup"</span>: {<span class="json-key">"lat"</span>: <span class="json-number">12.9716</span>, <span class="json-key">"lng"</span>: <span class="json-number">77.5946</span>},
    <span class="json-key">"dropoff"</span>: {<span class="json-key">"lat"</span>: <span class="json-number">12.9352</span>, <span class="json-key">"lng"</span>: <span class="json-number">77.6245</span>},
    <span class="json-key">"vehicle_type"</span>: <span class="json-string">"sedan"</span>
}

Response: <span class="json-number">201</span> Created
{
    <span class="json-key">"request_id"</span>: <span class="json-string">"uuid-123"</span>,
    <span class="json-key">"status"</span>: <span class="json-string">"searching"</span>,
    <span class="json-key">"fare_estimate"</span>: {<span class="json-key">"min"</span>: <span class="json-number">150</span>, <span class="json-key">"max"</span>: <span class="json-number">180</span>, <span class="json-key">"surge"</span>: <span class="json-number">1.0</span>},
    <span class="json-key">"eta_minutes"</span>: <span class="json-number">5</span>
}

Errors:
- <span class="json-number">400</span>: Invalid coordinates
- <span class="json-number">404</span>: No drivers available
- <span class="json-number">429</span>: Rate limit exceeded</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method ws">WS</span> <span class="api-path">/api/v1/ride/:rideId/track</span>
<pre>
// <a href="/interview-question/glossary#websocket" class="info-term">WebSocket<span class="info-i">i</span></a> for real-time tracking
// Server → Client messages:

{ <span class="json-key">"type"</span>: <span class="json-string">"driver_location"</span>, <span class="json-key">"lat"</span>: <span class="json-number">12.9720</span>, <span class="json-key">"lng"</span>: <span class="json-number">77.5950</span>, <span class="json-key">"heading"</span>: <span class="json-number">45</span> }
{ <span class="json-key">"type"</span>: <span class="json-string">"eta_update"</span>, <span class="json-key">"eta_seconds"</span>: <span class="json-number">180</span> }
{ <span class="json-key">"type"</span>: <span class="json-string">"status_change"</span>, <span class="json-key">"status"</span>: <span class="json-string">"arrived"</span>, <span class="json-key">"timestamp"</span>: <span class="json-string">"..."</span> }
{ <span class="json-key">"type"</span>: <span class="json-string">"trip_started"</span>, <span class="json-key">"timestamp"</span>: <span class="json-string">"..."</span> }
{ <span class="json-key">"type"</span>: <span class="json-string">"trip_completed"</span>, <span class="json-key">"fare"</span>: <span class="json-number">165.50</span>, <span class="json-key">"distance_km"</span>: <span class="json-number">8.2</span> }

// Client → Server messages:
{ <span class="json-key">"type"</span>: <span class="json-string">"ping"</span> }  // Keep-alive every 30s</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/ride/:rideId/complete</span>
<pre>
Request: (Driver app)
{
    <span class="json-key">"dropoff_location"</span>: {<span class="json-key">"lat"</span>: <span class="json-number">12.9352</span>, <span class="json-key">"lng"</span>: <span class="json-number">77.6245</span>},
    <span class="json-key">"distance_km"</span>: <span class="json-number">8.2</span>,
    <span class="json-key">"duration_minutes"</span>: <span class="json-number">25</span>
}

Response: <span class="json-number">200</span> OK
{
    <span class="json-key">"ride_id"</span>: <span class="json-string">"uuid-123"</span>,
    <span class="json-key">"fare"</span>: <span class="json-number">165.50</span>,
    <span class="json-key">"breakdown"</span>: {
        <span class="json-key">"base_fare"</span>: <span class="json-number">50</span>,
        <span class="json-key">"distance_charge"</span>: <span class="json-number">82.00</span>,
        <span class="json-key">"time_charge"</span>: <span class="json-number">25.00</span>,
        <span class="json-key">"surge_multiplier"</span>: <span class="json-number">1.0</span>,
        <span class="json-key">"taxes"</span>: <span class="json-number">8.50</span>
    },
    <span class="json-key">"payment_status"</span>: <span class="json-string">"charged"</span>
}</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/driver/location</span>
<pre>
Request: (Every 4 seconds when driver online)
{
    <span class="json-key">"lat"</span>: <span class="json-number">12.9716</span>,
    <span class="json-key">"lng"</span>: <span class="json-number">77.5946</span>,
    <span class="json-key">"heading"</span>: <span class="json-number">180</span>,
    <span class="json-key">"is_available"</span>: <span class="json-boolean">true</span>
}

Response: <span class="json-number">200</span> OK
{ <span class="json-key">"ack"</span>: <span class="json-boolean">true</span> }

// Batched internally, written to <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> immediately</pre>
        </div>

        <!-- Database Alternatives -->
        <h3>Database Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> + PostGIS (Selected)</h5>
                <p>ACID compliance with native <a href="/interview-question/glossary#postgresql" class="info-term">geospatial<span class="info-i">i</span></a> support</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>GIST index for geo queries</li>
                            <li>ST_DWithin for radius search</li>
                            <li>Transactional ride state</li>
                            <li>Proven at Uber's scale</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>High-frequency writes need tuning</li>
                            <li>Geo index rebuild on updates</li>
                            <li>Connection pooling required</li>
                        </ul>
                    </div>
                </div>
                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; font-size: 13px;">
                    <strong>Care:</strong> Use Redis for real-time locations, PostgreSQL for ride state
                </div>
            </div>

            <div class="alternative-card">
                <h5>MongoDB with Geospatial</h5>
                <p>Document store with 2dsphere indexes</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> $geoNear aggregation pipeline<br>
                    <span style="color: #22c55e;">+</span> Flexible schema for ride metadata<br>
                    <span style="color: #ef4444;">-</span> No multi-document transactions (pre-4.0)<br>
                    <span style="color: #ef4444;">-</span> Write concern complexity
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Rapid prototyping, flexible ride metadata
                </div>
            </div>

            <div class="alternative-card">
                <h5><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> GEO (Hot Path Only)</h5>
                <p>In-memory <a href="/interview-question/glossary#postgresql" class="info-term">geospatial<span class="info-i">i</span></a> with GEORADIUS</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Sub-ms GEORADIUS queries<br>
                    <span style="color: #22c55e;">+</span> Built-in sorted sets<br>
                    <span style="color: #ef4444;">-</span> Not durable (needs backup)<br>
                    <span style="color: #ef4444;">-</span> Memory-bound
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Real-time driver locations (complement to PostgreSQL)
                </div>
            </div>
        </div>

        <!-- Location Alternatives -->
        <h3>Location Index Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> GEO (Selected)</h5>
                <p>In-memory <a href="/interview-question/glossary#postgresql" class="info-term">geospatial<span class="info-i">i</span></a> with sorted sets</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>O(log N) GEORADIUS</li>
                            <li>Sub-ms response</li>
                            <li>WITHDIST, WITHCOORD options</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Memory bound</li>
                            <li>Single-threaded commands</li>
                            <li>No complex filtering</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="alternative-card">
                <h5>H3 Hexagonal Indexing</h5>
                <p>Uber's hierarchical geospatial index</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Consistent cell sizes<br>
                    <span style="color: #22c55e;">+</span> k-ring for neighbors<br>
                    <span style="color: #22c55e;">+</span> Resolution levels (0-15)<br>
                    <span style="color: #ef4444;">-</span> Implementation complexity<br>
                    <span style="color: #ef4444;">-</span> Cell boundary edge cases
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> High scale, surge pricing zones, heat maps
                </div>
            </div>

            <div class="alternative-card">
                <h5>QuadTree / R-Tree</h5>
                <p>Spatial partitioning data structure</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> In-memory efficiency<br>
                    <span style="color: #22c55e;">+</span> Range queries<br>
                    <span style="color: #ef4444;">-</span> Rebalancing on updates<br>
                    <span style="color: #ef4444;">-</span> Custom implementation
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Custom matching engine, in-memory processing
                </div>
            </div>
        </div>

        <!-- Matching Algorithm Alternatives -->
        <h3>Matching Algorithm Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>Greedy Nearest (Selected)</h5>
                <p>Assign closest available driver</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>O(n log n) with geo index</li>
                            <li>Simple to implement</li>
                            <li>Fast match time</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Not globally optimal</li>
                            <li>Can cause driver starvation</li>
                            <li>Ignores future requests</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="alternative-card">
                <h5>Hungarian Algorithm</h5>
                <p>Optimal bipartite matching</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Global optimum<br>
                    <span style="color: #22c55e;">+</span> Minimizes total distance<br>
                    <span style="color: #ef4444;">-</span> O(n^3) complexity<br>
                    <span style="color: #ef4444;">-</span> Requires batching requests
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Batch matching during surge, ride pooling
                </div>
            </div>

            <div class="alternative-card">
                <h5>Batch Matching</h5>
                <p>Collect requests, match in batches</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Better global efficiency<br>
                    <span style="color: #22c55e;">+</span> Enables ride pooling<br>
                    <span style="color: #ef4444;">-</span> Adds latency (2-5s batch window)<br>
                    <span style="color: #ef4444;">-</span> User perceived delay
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> High-density areas, airport queues
                </div>
            </div>
        </div>

        <!-- Design Patterns -->
        <h3>Design Patterns Used</h3>
        <div class="patterns-grid">
            <div class="pattern-card">
                <h5>State Machine Pattern</h5>
                <p>Ride status transitions: requested → matched → driver_arrived → in_progress → completed/cancelled. Enforces valid transitions only.</p>
            </div>
            <div class="pattern-card">
                <h5>Observer Pattern</h5>
                <p>Location updates via <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Pub/Sub. Driver publishes location, rider's <a href="/interview-question/glossary#websocket" class="info-term">WebSocket<span class="info-i">i</span></a> subscribes to ride channel for real-time updates.</p>
            </div>
            <div class="pattern-card">
                <h5>Strategy Pattern</h5>
                <p>Matching algorithm selection. GreedyMatcher, HungarianMatcher, BatchMatcher implement IMatcher interface. Switch via config.</p>
            </div>
            <div class="pattern-card">
                <h5>Command Pattern</h5>
                <p>Ride actions as commands: RequestRideCommand, AcceptRideCommand, StartTripCommand. Enables undo, logging, and async processing.</p>
            </div>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">Ride State Machine</h5>
<pre>type RideStatus string

const (
    StatusRequested   RideStatus = "requested"
    StatusMatched     RideStatus = "matched"
    StatusDriverArrived RideStatus = "driver_arrived"
    StatusInProgress  RideStatus = "in_progress"
    StatusCompleted   RideStatus = "completed"
    StatusCancelled   RideStatus = "cancelled"
)

var validTransitions = map[RideStatus][]RideStatus{
    StatusRequested:     {StatusMatched, StatusCancelled},
    StatusMatched:       {StatusDriverArrived, StatusCancelled},
    StatusDriverArrived: {StatusInProgress, StatusCancelled},
    StatusInProgress:    {StatusCompleted},
}

func (r *Ride) CanTransitionTo(newStatus RideStatus) bool {
    allowed, exists := validTransitions[r.Status]
    if !exists { return false }
    for _, s := range allowed {
        if s == newStatus { return true }
    }
    return false
}</pre>
        </div>

        <!-- AWS Cost Estimation -->
        <h3>AWS Cost Estimation (MVP)</h3>
        <div class="feature-card">
            <table class="cost-table">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Spec</th>
                        <th>Monthly Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="cost-tag aws">EC2</span> API Servers (3x)</td>
                        <td>c5.large, 2 vCPU, 4GB</td>
                        <td>$180</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">EC2</span> Location Service (2x)</td>
                        <td>c5.large, WebSocket</td>
                        <td>$120</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">RDS</span> <a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> + PostGIS</td>
                        <td>db.r5.large, Multi-AZ</td>
                        <td>$350</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">ElastiCache</span> <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a></td>
                        <td>cache.r5.large, 13GB</td>
                        <td>$200</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">MSK</span> <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a></td>
                        <td>kafka.t3.small, 3 brokers</td>
                        <td>$150</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">ALB</span> <a href="/interview-question/glossary#load-balancer" class="info-term">Load Balancer<span class="info-i">i</span></a></td>
                        <td>Application LB + 5M requests</td>
                        <td>$50</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">Lambda</span> Edge (Location)</td>
                        <td>1M invocations/day</td>
                        <td>$30</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">Kinesis</span> Location Stream</td>
                        <td>2 shards</td>
                        <td>$30</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="2"><strong>Total MVP Monthly</strong></td>
                        <td><strong>~$1,110/month</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- K8s Deployment -->
        <h3>Deployment (K8s)</h3>
        <div class="deployment-diagram">
            <h4>Kubernetes Architecture</h4>
            <div class="k8s-cluster">
                <h5>EKS Cluster - ap-south-1</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                    <div class="k8s-pod">api-deployment (replicas: 3)</div>
                    <div class="k8s-pod">matching-deployment (replicas: 2)</div>
                    <div class="k8s-pod">location-deployment (replicas: 2)</div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <div class="k8s-pod" style="background: #7c3aed;">Service: api-svc</div>
                    <div class="k8s-pod" style="background: #7c3aed;">Service: matching-svc</div>
                    <div class="k8s-pod" style="background: #0891b2;">Ingress: ALB</div>
                    <div class="k8s-pod" style="background: #dc2626;">Secret: db-creds</div>
                    <div class="k8s-pod" style="background: #dc2626;">Secret: redis-creds</div>
                </div>
            </div>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">deployment.yaml (simplified)</h5>
<pre><span class="yaml-key">apiVersion</span>: apps/v1
<span class="yaml-key">kind</span>: Deployment
<span class="yaml-key">metadata</span>:
  <span class="yaml-key">name</span>: ride-api
<span class="yaml-key">spec</span>:
  <span class="yaml-key">replicas</span>: <span class="yaml-number">3</span>
  <span class="yaml-key">template</span>:
    <span class="yaml-key">spec</span>:
      <span class="yaml-key">containers</span>:
      - <span class="yaml-key">name</span>: api
        <span class="yaml-key">image</span>: ride-booking:v1.0.0
        <span class="yaml-key">ports</span>: [<span class="yaml-number">8080</span>]
        <span class="yaml-key">envFrom</span>: [secretRef: {name: db-creds}]
        <span class="yaml-key">resources</span>:
          <span class="yaml-key">requests</span>: {cpu: <span class="yaml-string">"500m"</span>, memory: <span class="yaml-string">"512Mi"</span>}
          <span class="yaml-key">limits</span>: {cpu: <span class="yaml-string">"1000m"</span>, memory: <span class="yaml-string">"1Gi"</span>}
        <span class="yaml-key">readinessProbe</span>:
          <span class="yaml-key">httpGet</span>: {path: /health, port: <span class="yaml-number">8080</span>}
---
<span class="yaml-comment"># Matching Service: 2 replicas, 1 CPU, 1Gi memory</span>
<span class="yaml-key">kind</span>: Deployment
<span class="yaml-key">metadata</span>: {<span class="yaml-key">name</span>: ride-matching}
<span class="yaml-key">spec</span>: {<span class="yaml-key">replicas</span>: <span class="yaml-number">2</span>}
---
<span class="yaml-comment"># Location Service: 2 replicas, <a href="/interview-question/glossary#websocket" class="info-term">WebSocket<span class="info-i">i</span></a> on port 8081</span>
<span class="yaml-key">kind</span>: Deployment
<span class="yaml-key">metadata</span>: {<span class="yaml-key">name</span>: ride-location}
<span class="yaml-key">spec</span>: {<span class="yaml-key">replicas</span>: <span class="yaml-number">2</span>}</pre>
        </div>

        <!-- CI/CD Pipeline -->
        <h3>CI/CD Pipeline</h3>
        <div class="diagram-container">
            <h4>GitHub Actions → ECR → EKS</h4>
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 16px;">
                <div class="arch-box client" style="background: #24292e;">Git Push</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box server" style="background: #2088FF;">GitHub Actions</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box storage">ECR</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box gateway">kubectl apply</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box server">EKS</div>
            </div>
            <div style="margin-top: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                <strong>Pipeline Steps:</strong>
                <ol style="font-size: 14px; margin-top: 8px;">
                    <li>Run tests (go test ./... + integration)</li>
                    <li>Build Docker images (api, matching, location)</li>
                    <li>Push to ECR with git SHA tag</li>
                    <li>Update K8s deployments (rolling update)</li>
                    <li>Run smoke tests (request ride, check matching)</li>
                </ol>
            </div>
        </div>

        <!-- Rollback Strategy -->
        <h3>Rollback Strategy</h3>
        <div class="feature-card warning">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4>Instant Rollback</h4>
                    <div class="code-example" style="margin: 12px 0;">
<pre>kubectl rollout undo deployment/ride-api
kubectl rollout undo deployment/ride-matching</pre>
                    </div>
                    <p style="font-size: 14px;">K8s keeps last 10 ReplicaSets. Rollback in &lt;30s.</p>
                </div>
                <div>
                    <h4>Canary for Matching Changes</h4>
                    <ul style="font-size: 14px;">
                        <li>Deploy new matching algorithm to 5% traffic</li>
                        <li>Monitor: match time, driver acceptance rate</li>
                        <li>If degradation: instant rollback via Istio</li>
                        <li>Gradual rollout: 5% → 25% → 50% → 100%</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Driver Cancellation Mid-Ride</div>
                <p>Driver cancels after pickup but before dropoff, leaving rider stranded.</p>
                <div class="case-solution">Immediately trigger re-matching for nearby drivers. Store trip progress (waypoints traveled). Calculate partial fare. Penalize driver (cancellation score affects future assignments). Notify rider with ETA for new driver.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">GPS Drift in Tunnels/Underground</div>
                <p>GPS signal lost in tunnels, parking garages, or dense urban areas causing erratic location updates.</p>
                <div class="case-solution">Implement dead reckoning using last known velocity + heading. Use cell tower triangulation as fallback. Smooth location jumps with Kalman filter. Flag abnormal speed (&gt;200 km/h) as GPS error. Resume normal tracking when signal stabilizes.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Surge Pricing During Emergencies</div>
                <p>Natural disasters or emergencies trigger extreme surge (10x+), causing PR backlash.</p>
                <div class="case-solution">Implement surge caps (max 3x during declared emergencies). Geo-fence affected areas. Automatic detection via sudden demand spike + news API. Free ride credits for evacuations. Partner with emergency services for priority dispatch.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Payment Failure After Ride Completion</div>
                <p>Card declined or wallet empty after ride ends. Driver already marked trip complete.</p>
                <div class="case-solution">Pre-authorize estimated fare before ride starts. Queue failed payments for retry (exponential backoff). Block rider from new rides until settled. Offer alternative payment methods. After 3 days, send to collections and credit driver from reserve fund.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Driver-Rider Disputes</div>
                <p>Disagreements on route taken, fare charged, or ride quality. Both parties blame each other.</p>
                <div class="case-solution">Store complete GPS trace for audit. Record trip audio (with consent, region-specific). Implement in-app dispute flow with evidence upload. ML-based initial resolution (compare actual vs optimal route). Escalate to human review for complex cases.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">No Drivers Available in Area</div>
                <p>Rider requests in low-supply area. Multiple retry attempts fail.</p>
                <div class="case-solution">Expand search radius progressively (5km → 10km → 15km). Show "Notify me when available" option. Suggest pickup point adjustment to nearby high-supply area. Incentivize drivers to reposition with heat maps. Offer scheduled ride for future time.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">Autonomous Vehicle Integration</div>
                <p>Self-driving cars joining the driver fleet with different matching and safety requirements.</p>
                <div class="future-approach">Create separate vehicle_type='autonomous'. Different pickup UX (locate car by plate, unlock via app). Remote operations center for edge cases. Gradual rollout in geo-fenced zones. Handle handoff between AV and human driver modes.</div>
            </div>

            <div class="future-item">
                <div class="future-title">ML-Optimized Ride Pooling</div>
                <p>Match multiple riders heading in similar directions to share rides efficiently.</p>
                <div class="future-approach">Build pooling graph with compatible pickup/dropoff pairs. Use ML to predict rider flexibility (time vs cost preference). Dynamic pricing based on pool efficiency. Real-time route optimization as riders join/leave. Handle partial matches and rider consent flow.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Carbon Footprint Tracking</div>
                <p>Calculate and display environmental impact of rides, promote green choices.</p>
                <div class="future-approach">Track CO2 per ride based on vehicle type, distance, occupancy. Gamify with "green ride" badges and streaks. Offer carbon offset at checkout. Partner with EV charging networks. Show emissions saved via pooling vs solo rides.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Subscription Models</div>
                <p>Monthly plans for frequent riders with discounted fares and priority matching.</p>
                <div class="future-approach">Tier-based plans (5, 10, 20 rides/month). Priority matching during surge (skip queue). Fixed fare corridors (home to office). Rollover unused rides. Family plans with multiple rider profiles. Corporate accounts with expense integration.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How does your matching algorithm balance driver proximity vs driver rating?</div>
                    <div class="followup-hint">Weighted scoring: score = (1 - distance/max_radius) * 0.6 + (rating/5) * 0.4. Adjust weights based on rider preference. Consider driver acceptance rate history. Premium riders might weight rating higher.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">Why use Redis GEO over PostGIS for real-time driver locations?</div>
                    <div class="followup-hint">Redis GEO: sub-ms GEORADIUS, handles 10K drivers × 15 updates/min easily. PostGIS: GIST index slower for high-frequency updates. Use Redis for hot path (matching), PostGIS for ride history and analytics. Redis GEOADD is O(log N).</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle WebSocket connection failures during a ride?</div>
                    <div class="followup-hint">Client-side reconnection with exponential backoff. Store last known position in Redis with TTL. On reconnect, send missed location updates from buffer. Fallback to polling API if WebSocket unavailable. Show "reconnecting" UI state.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How would you calculate ETA that accounts for traffic?</div>
                    <div class="followup-hint">Use Google Maps / Mapbox Distance Matrix API for traffic-aware routing. Cache route segments by time-of-day. ML model trained on historical trip durations. Update ETA in real-time based on actual progress vs predicted. Show confidence range (5-8 min).</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">What happens if the driver's app crashes mid-ride?</div>
                    <div class="followup-hint">Detect via missing heartbeats (&gt;30s gap). Cache last known state in Redis. On app restart, restore ride context from server. Show rider a "driver reconnecting" message. If prolonged (&gt;5 min), offer rider option to cancel with no penalty.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>MVP Stage - Complete Ride Booking Flow</h4>
            <div class="flow-vertical">
                <!-- Booking Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">RIDE BOOKING FLOW</div>
                    <div class="flow-row">
                        <div class="flow-node user">Rider<br><small>POST /ride/request</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node gateway">ALB<br><small>Route to API</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">API Server<br><small>Validate + Create</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node db">PostgreSQL<br><small>INSERT request</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Kafka<br><small>ride.requested</small></div>
                    </div>
                </div>

                <!-- Matching Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #7c3aed; margin-bottom: 12px;">DRIVER MATCHING FLOW</div>
                    <div class="flow-row">
                        <div class="flow-node service">Matching<br><small>Consume event</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node cache">Redis GEO<br><small>GEORADIUS 5km</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Score<br><small>distance + rating</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Push<br><small>FCM/APNS</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node user">Driver<br><small>Accept (15s)</small></div>
                    </div>
                </div>

                <!-- Real-time Tracking Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #0891b2; margin-bottom: 12px;">REAL-TIME TRACKING (WebSocket)</div>
                    <div class="flow-row">
                        <div class="flow-node user">Driver GPS<br><small>Every 4s</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node cache">Redis<br><small>GEOADD + PUBLISH</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">WS Server<br><small>Subscribe channel</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node user">Rider App<br><small>Update map</small></div>
                    </div>
                </div>

                <!-- Trip Completion Flow -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #dc2626; margin-bottom: 12px;">TRIP COMPLETION + PAYMENT</div>
                    <div class="flow-row">
                        <div class="flow-node user">Driver<br><small>End Trip</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Fare Engine<br><small>Calculate fare</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Payment<br><small>Charge rider</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node db">PostgreSQL<br><small>UPDATE ride</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node user">Both Apps<br><small>Rate 1-5 stars</small></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution Across Stages</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x1F331;</div>
                    <div class="evolution-label">MVP</div>
                    <div class="evolution-db">PostgreSQL + PostGIS</div>
                    <div class="evolution-detail">Single primary<br>Redis for locations</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x1F1EE;&#x1F1F3;</div>
                    <div class="evolution-label">PAN-India</div>
                    <div class="evolution-db">Redis GEO Sharded</div>
                    <div class="evolution-detail">City-based keys<br>Read replicas</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x26A1;</div>
                    <div class="evolution-label">High Traffic</div>
                    <div class="evolution-db">H3 Hexagonal Index</div>
                    <div class="evolution-detail">Resolution 8-9<br>Surge zones</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x1F30D;</div>
                    <div class="evolution-label">Global</div>
                    <div class="evolution-db">CockroachDB</div>
                    <div class="evolution-detail">Geo-partitioned<br>Data residency</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- PAN-INDIA SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="pan-india">
        <div class="stage-header">
            <span class="stage-badge pan-india">PAN-India Scale</span>
            <h2 style="margin: 0;">Multi-City - 100K drivers - 500K rides/day</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Multi-city operations (50+ cities)</li>
                        <li>Regional pricing and surge</li>
                        <li>City-specific regulations</li>
                        <li>Ride pooling (share rides)</li>
                        <li>Scheduled rides</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Latency: &lt;100ms (regional)</li>
                        <li>Throughput: 10K rides/hour</li>
                        <li>Data locality: city-level</li>
                        <li>Failover: &lt;30s</li>
                    </ul>
                </div>
            </div>
        </div>

        <h3>Architecture Evolution</h3>
        <div class="diagram-container">
            <h4>Multi-Region Architecture</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <div class="arch-box client">Rider/Driver Apps (All India)</div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box cdn">CloudFront<br><small>Static assets + API cache</small></div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box lb">Route 53 (Latency-based)</div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: center;">
                    <div style="text-align: center; padding: 16px; border: 2px dashed #3b82f6; border-radius: 12px;">
                        <strong style="color: #3b82f6;">Mumbai (ap-south-1)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">API (5x)</div>
                            <div class="arch-box server" style="padding: 10px;">Match (3x)</div>
                            <div class="arch-box cache" style="padding: 10px;">Redis</div>
                        </div>
                        <div class="arch-box db" style="margin-top: 12px;">RDS Primary</div>
                        <div style="font-size: 12px; margin-top: 8px;">West + South India</div>
                    </div>
                    <div style="text-align: center; padding: 16px; border: 2px dashed #22c55e; border-radius: 12px;">
                        <strong style="color: #22c55e;">Hyderabad (ap-south-2)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">API (3x)</div>
                            <div class="arch-box server" style="padding: 10px;">Match (2x)</div>
                            <div class="arch-box cache" style="padding: 10px;">Redis</div>
                        </div>
                        <div class="arch-box db" style="margin-top: 12px; opacity: 0.7;">RDS Read Replica</div>
                        <div style="font-size: 12px; margin-top: 8px;">North + East India</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Flow -->
        <h3>Data Flow - Cross-Region</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Delhi User</div>
                    <div class="flow-step-label">Ride request</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box lb" style="padding: 10px 16px;">Route 53</div>
                    <div class="flow-step-label">Latency routing</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Hyderabad API</div>
                    <div class="flow-step-label">Process request</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box cache" style="padding: 10px 16px;">Regional Redis</div>
                    <div class="flow-step-label">Delhi drivers</div>
                </div>
            </div>
        </div>

        <!-- Database Schema Changes -->
        <h3>Database Schema - Regional Sharding</h3>
        <div class="diagram-container">
            <div class="schema-diagram">
                <div class="schema-table">
                    <div class="schema-table-header">cities</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR(100)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">region</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">base_fare</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">per_km_rate</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">per_min_rate</span><span class="field-type">DECIMAL(10,2)</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>─────</span>
                    <span>N</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">surge_zones</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">city_id</span><span class="field-type">UUID FK → cities.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">h3_index</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">demand_count</span><span class="field-type">INTEGER</span></div>
                        <div class="schema-field"><span class="field-name">supply_count</span><span class="field-type">INTEGER</span></div>
                        <div class="schema-field"><span class="field-name">surge_multiplier</span><span class="field-type">DECIMAL(3,2)</span></div>
                        <div class="schema-field"><span class="field-name">updated_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>
            </div>
        </div>

        <h3>What Changes</h3>
        <div class="feature-card">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 30%;"><strong>Regional Databases</strong></td>
                    <td>Each region has its own PostgreSQL. Drivers matched within city only.</td>
                </tr>
                <tr>
                    <td><strong>Redis per Region</strong></td>
                    <td>Driver locations sharded by city. GEORADIUS scoped to city key.</td>
                </tr>
                <tr>
                    <td><strong>Surge by Zone</strong></td>
                    <td>H3 hexagonal cells for surge calculation. Updated every 30 seconds.</td>
                </tr>
                <tr>
                    <td><strong>Central Analytics</strong></td>
                    <td>Replicate to data warehouse (Redshift) for business intelligence.</td>
                </tr>
            </table>
        </div>

        <!-- API Design -->
        <h3>API Design - Regional</h3>
        <div class="api-endpoint">
            <span class="api-method get">GET</span> <span class="api-path">/api/v1/surge/:cityId</span>
<pre>
Response: <span class="json-number">200</span> OK
{
    <span class="json-key">"city_id"</span>: <span class="json-string">"mumbai"</span>,
    <span class="json-key">"zones"</span>: [
        {<span class="json-key">"h3_index"</span>: <span class="json-string">"8928308280fffff"</span>, <span class="json-key">"surge"</span>: <span class="json-number">1.5</span>, <span class="json-key">"demand"</span>: <span class="json-number">45</span>, <span class="json-key">"supply"</span>: <span class="json-number">20</span>},
        {<span class="json-key">"h3_index"</span>: <span class="json-string">"8928308281fffff"</span>, <span class="json-key">"surge"</span>: <span class="json-number">1.0</span>, <span class="json-key">"demand"</span>: <span class="json-number">12</span>, <span class="json-key">"supply"</span>: <span class="json-number">15</span>}
    ],
    <span class="json-key">"updated_at"</span>: <span class="json-string">"2024-01-15T10:30:00Z"</span>
}</pre>
        </div>

        <h3>Cost at PAN-India Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr>
                    <td>EKS (2 regions, 15 nodes)</td>
                    <td>$2,500</td>
                </tr>
                <tr>
                    <td>RDS Primary + Replica</td>
                    <td>$1,200</td>
                </tr>
                <tr>
                    <td>ElastiCache (2 regions)</td>
                    <td>$600</td>
                </tr>
                <tr>
                    <td>MSK Kafka (2 regions)</td>
                    <td>$500</td>
                </tr>
                <tr>
                    <td>CloudFront + Route 53</td>
                    <td>$300</td>
                </tr>
                <tr>
                    <td>Kinesis (location streaming)</td>
                    <td>$200</td>
                </tr>
                <tr class="total-row">
                    <td><strong>Total</strong></td>
                    <td><strong>~$5,300/month</strong></td>
                </tr>
            </table>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Cross-City Border Rides</div>
                <p>Rider in City A requests ride to City B which has different pricing and regulations.</p>
                <div class="case-solution">Detect cross-city at request time via dropoff coordinates. Apply origin city's base fare + destination city's per-km rate. Show fare estimate with breakdown. Ensure driver is licensed for both jurisdictions. Handle currency if crossing state lines.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Regional Database Failover</div>
                <p>Mumbai region RDS primary goes down during peak hours. 50% of India traffic affected.</p>
                <div class="case-solution">Multi-AZ RDS with automatic failover (&lt;60s). Route 53 health checks redirect to Hyderabad. Regional Redis has cached active rides. Accept slight staleness (30s) during failover. Replay uncommitted transactions from Kafka.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Surge Zone Boundary Gaming</div>
                <p>Riders request pickup just outside surge zone to avoid multiplier, causing driver deadhead.</p>
                <div class="case-solution">Apply surge based on pickup H3 cell + adjacent cells (k-ring=1). Smooth surge transitions at boundaries. Show heat map to riders. Calculate driver's actual pickup distance, not straight-line. Minimum fare covers deadhead cost.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Driver Location Spoofing</div>
                <p>Drivers fake GPS to appear in high-demand areas or claim completed rides.</p>
                <div class="case-solution">Detect teleportation (impossible speed between pings). Cross-reference with cell tower data. Track accelerometer/gyroscope patterns. Flag accounts with anomalous location patterns. Trip photos at pickup/dropoff verification.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Payment Gateway Regional Outage</div>
                <p>Razorpay down in South India. Rides completing but payments failing.</p>
                <div class="case-solution">Multi-gateway setup (Razorpay + PayU + Stripe). Circuit breaker per gateway per region. Fallback to wallet balance. Queue payments for retry. COD option for repeat riders. Credit driver immediately, reconcile later.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Intercity Scheduled Ride No-Show</div>
                <p>Driver travels 50km for scheduled airport pickup. Rider cancels last minute.</p>
                <div class="case-solution">Enforce cancellation policy (escalating fees closer to pickup time). Compensate driver for deadhead based on distance traveled. Priority matching for return trip. Show driver acceptance rate for scheduled rides. Pre-authorize full fare.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">Predictive Driver Positioning</div>
                <p>ML model suggests where drivers should wait based on historical demand patterns.</p>
                <div class="future-approach">Train on historical ride data by hour/day/location. Factor in events (concerts, sports), weather, holidays. Push heat maps to driver app. Gamify with bonuses for positioning in underserved areas. Reduce average pickup time by 30%.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Multi-Modal Trip Planning</div>
                <p>Combine ride-booking with metro, bus, and bike rentals for optimal routes.</p>
                <div class="future-approach">Integrate public transit APIs (GTFS feeds). Calculate time + cost for multi-modal options. Offer "first/last mile" rides to transit hubs. Unified payment across modes. Show CO2 comparison vs car-only.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Driver Earnings Guarantee</div>
                <p>Guarantee minimum hourly earnings during specific hours to ensure supply.</p>
                <div class="future-approach">Define guarantee zones and time slots. Track driver online time vs ride time. Top-up difference if below threshold. Require minimum acceptance rate. ML to predict guarantee cost and optimize zones.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Voice-First Booking</div>
                <p>Book rides via voice assistants (Alexa, Google Home, Siri) for hands-free experience.</p>
                <div class="future-approach">Integrate with Alexa Skills Kit / Google Actions. Store frequent destinations. Voice confirmation of ETA and surge. Push to phone for tracking. Support local languages (Hindi, Tamil, etc.).</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How do you implement city-based sharding for driver locations?</div>
                    <div class="followup-hint">Use Redis key pattern: drivers:{city_id}. Determine city from coordinates using city polygon lookup (PostGIS ST_Contains). Each city in separate Redis cluster. Cross-city queries rare, acceptable to query multiple clusters.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">How does H3 help with surge pricing?</div>
                    <div class="followup-hint">H3 resolution 8 (~1km hexagons) for surge zones. Count demand (requests) and supply (available drivers) per cell. Surge = demand/supply ratio with smoothing. Update every 30s. K-ring for neighbor-aware pricing. Consistent cell sizes unlike geohash.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle latency for users in Tier-2/3 cities far from data centers?</div>
                    <div class="followup-hint">Edge caching (CloudFront) for static assets. Regional read replicas in Hyderabad for North/East India. Optimistic UI updates (show "searching" before confirmation). Compress payloads. Use persistent connections (WebSocket/HTTP2).</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement ride pooling matching efficiently?</div>
                    <div class="followup-hint">Batch requests in 10s windows. Build graph: nodes = requests, edges = compatible pairs (same direction, time overlap). Use approximation algorithms for max matching. Consider detour tolerance per rider. Price discount proportional to pooling efficiency.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How do you ensure data consistency between primary and replica during writes?</div>
                    <div class="followup-hint">Writes always go to primary (Mumbai). Read-after-write: use primary for user's own data. Replica lag monitoring (should be &lt;100ms). For critical reads (ride state), route to primary. Accept eventual consistency for analytics/dashboards.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>PAN-India Stage - Multi-Region Flow</h4>
            <div class="flow-vertical">
                <!-- Request Routing Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">LATENCY-BASED REQUEST ROUTING</div>
                    <div class="flow-row">
                        <div class="flow-node user">Delhi Rider<br><small>Ride request</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node gateway">Route 53<br><small>Latency routing</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Hyderabad API<br><small>Nearest region</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node cache">Regional Redis<br><small>drivers:delhi</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node db">RDS Replica<br><small>Read-heavy</small></div>
                    </div>
                </div>

                <!-- Write Path Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #dc2626; margin-bottom: 12px;">WRITE PATH (Cross-Region)</div>
                    <div class="flow-row">
                        <div class="flow-node service">Hyderabad API<br><small>Ride confirmed</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node db">Mumbai RDS<br><small>Primary write</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Async Replication<br><small>&lt;100ms lag</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node db">Hyderabad Replica<br><small>Eventually consistent</small></div>
                    </div>
                </div>

                <!-- Surge Calculation Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #f59e0b; margin-bottom: 12px;">SURGE CALCULATION (H3 Zones)</div>
                    <div class="flow-row">
                        <div class="flow-node cache">Redis<br><small>Location counts</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Surge Worker<br><small>Every 30s</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">H3 Aggregation<br><small>demand/supply</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node db">surge_zones<br><small>UPDATE multiplier</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node user">App Heat Map<br><small>Show to riders</small></div>
                    </div>
                </div>

                <!-- Real-time Tracking (WebSocket) -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #0891b2; margin-bottom: 12px;">REAL-TIME TRACKING (Regional WebSocket)</div>
                    <div class="flow-row">
                        <div class="flow-node user">Driver App<br><small>GPS update</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Regional WS<br><small>Sticky session</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node cache">Redis Pub/Sub<br><small>ride:{id} channel</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">WS Broadcast<br><small>Same region</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node user">Rider App<br><small>Map update</small></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution Across Stages</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x1F331;</div>
                    <div class="evolution-label">MVP</div>
                    <div class="evolution-db">PostgreSQL + PostGIS</div>
                    <div class="evolution-detail">Single primary<br>Redis for locations</div>
                </div>
                <div class="evolution-stage current">
                    <div class="evolution-icon">&#x1F1EE;&#x1F1F3;</div>
                    <div class="evolution-label">PAN-India</div>
                    <div class="evolution-db">Redis GEO Sharded</div>
                    <div class="evolution-detail">City-based keys<br>Read replicas</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x26A1;</div>
                    <div class="evolution-label">High Traffic</div>
                    <div class="evolution-db">H3 Hexagonal Index</div>
                    <div class="evolution-detail">Resolution 8-9<br>Surge zones</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x1F30D;</div>
                    <div class="evolution-label">Global</div>
                    <div class="evolution-db">CockroachDB</div>
                    <div class="evolution-detail">Geo-partitioned<br>Data residency</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- HIGH TRAFFIC -->
    <!-- ============================================ -->
    <div class="stage-section" id="high-traffic">
        <div class="stage-header">
            <span class="stage-badge high-traffic">High Traffic</span>
            <h2 style="margin: 0;">500K drivers - 2M rides/day - Event Surge</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Handle 10x surge (concerts, NYE)</li>
                        <li>Predictive driver positioning</li>
                        <li>Dynamic pricing with caps</li>
                        <li>Priority queue for premium users</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Throughput: 50K rides/hour</li>
                        <li>Location updates: 10M/minute</li>
                        <li>Match latency: &lt;2s at surge</li>
                        <li>Zero downtime during spikes</li>
                    </ul>
                </div>
            </div>
        </div>

        <h3>What Breaks First</h3>
        <div class="feature-card warning">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 25%;"><strong>1. Location Writes</strong></td>
                    <td>500K drivers x 15 updates/min = 7.5M writes/min</td>
                    <td style="color: #22c55e;"><strong>Kinesis stream + batch to <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a></strong></td>
                </tr>
                <tr>
                    <td><strong>2. Matching Service</strong></td>
                    <td>GEORADIUS with millions of keys</td>
                    <td style="color: #22c55e;"><strong>City-sharded <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> + H3 pre-indexing</strong></td>
                </tr>
                <tr>
                    <td><strong>3. <a href="/interview-question/glossary#websocket" class="info-term">WebSocket<span class="info-i">i</span></a> Connections</strong></td>
                    <td>1M concurrent connections</td>
                    <td style="color: #22c55e;"><strong>Dedicated WS fleet + sticky sessions</strong></td>
                </tr>
                <tr>
                    <td><strong>4. Database Writes</strong></td>
                    <td>Ride state updates bottleneck</td>
                    <td style="color: #22c55e;"><strong>Event sourcing + eventual consistency</strong></td>
                </tr>
            </table>
        </div>

        <h3>Architecture at Scale</h3>
        <div class="diagram-container">
            <h4>High-Traffic Architecture</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                <div style="display: flex; gap: 20px;">
                    <div class="arch-box client">Rider Apps</div>
                    <div class="arch-box client">Driver Apps</div>
                </div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box lb">NLB (Layer 4, millions conn)</div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                    <div class="arch-box server">API (10x)</div>
                    <div class="arch-box server">Matching (5x)</div>
                    <div class="arch-box server">Location WS (10x)</div>
                    <div class="arch-box server">Surge Calculator</div>
                </div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 40px;">
                    <div style="text-align: center;">
                        <div class="arch-box queue">Kinesis<br><small>Location stream</small></div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box cache"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Cluster<br><small>32 shards</small></div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box queue"><a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a><br><small>Events</small></div>
                    </div>
                </div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 20px;">
                    <div class="arch-box db">PG Shard 0<br><small>North</small></div>
                    <div class="arch-box db">PG Shard 1<br><small>South</small></div>
                    <div class="arch-box db">PG Shard 2<br><small>East</small></div>
                    <div class="arch-box db">PG Shard 3<br><small>West</small></div>
                </div>
            </div>
        </div>

        <!-- Data Flow - Location at Scale -->
        <h3>Data Flow - Location at Scale</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Driver GPS</div>
                    <div class="flow-step-label">7.5M/min</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box queue" style="padding: 10px 16px;">Kinesis</div>
                    <div class="flow-step-label">Buffer 500ms</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Lambda</div>
                    <div class="flow-step-label">Batch process</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box cache" style="padding: 10px 16px;">Redis Cluster</div>
                    <div class="flow-step-label">GEOADD pipeline</div>
                </div>
            </div>
        </div>

        <!-- Streaming Alternatives -->
        <h3>Streaming Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>Amazon Kinesis (Selected)</h5>
                <p>Managed streaming for location data</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Auto-scaling shards<br>
                    <span style="color: #22c55e;">+</span> Lambda integration<br>
                    <span style="color: #22c55e;">+</span> 7-day retention<br>
                    <span style="color: #ef4444;">-</span> AWS lock-in<br>
                    <span style="color: #ef4444;">-</span> Shard limits (1MB/s write)
                </div>
            </div>

            <div class="alternative-card">
                <h5>Apache <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a> (MSK)</h5>
                <p>High-throughput event streaming</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Higher throughput<br>
                    <span style="color: #22c55e;">+</span> Exactly-once semantics<br>
                    <span style="color: #ef4444;">-</span> Operational complexity<br>
                    <span style="color: #ef4444;">-</span> ZooKeeper management
                </div>
            </div>

            <div class="alternative-card">
                <h5>Apache Pulsar</h5>
                <p>Multi-tenant messaging</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Geo-replication built-in<br>
                    <span style="color: #22c55e;">+</span> Tiered storage<br>
                    <span style="color: #ef4444;">-</span> Less mature ecosystem<br>
                    <span style="color: #ef4444;">-</span> No managed AWS option
                </div>
            </div>
        </div>

        <h3>Cost at High Traffic</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (35 nodes, c5.2xlarge)</td><td>$8,000</td></tr>
                <tr><td>RDS (4 shards, db.r5.2xlarge)</td><td>$6,000</td></tr>
                <tr><td>ElastiCache Cluster (32 nodes)</td><td>$4,000</td></tr>
                <tr><td>Kinesis (50 shards)</td><td>$2,500</td></tr>
                <tr><td>MSK Kafka (12 brokers)</td><td>$3,000</td></tr>
                <tr><td>NLB + Data Transfer</td><td>$2,000</td></tr>
                <tr><td>Lambda (location processing)</td><td>$500</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$26,000/month</strong></td></tr>
            </table>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Flash Mob Event (Concert Ends)</div>
                <p>50K people exit stadium simultaneously. Demand spikes 100x in 5 minutes.</p>
                <div class="case-solution">Pre-position drivers based on event schedule. Queue requests with fair ordering. Cap surge at 3x with wait time estimates. Temporary pickup zones (GPS-guided). Batch matching every 2s instead of instant. Communicate delays proactively.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Kinesis Shard Hot Spotting</div>
                <p>Single H3 cell (airport) overwhelms one Kinesis shard with location updates.</p>
                <div class="case-solution">Use random partition keys within hot zones. Enable adaptive capacity. Split hot shards automatically. Buffer writes client-side with jitter. Aggregate locations per cell before writing. Monitor IteratorAge metric.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Redis Cluster Node Failure</div>
                <p>One of 32 Redis cluster nodes dies. 1/32 of driver locations unavailable.</p>
                <div class="case-solution">Redis Cluster automatic failover to replica (&lt;15s). Drivers re-announce location on reconnect. Matching engine gracefully degrades (slightly larger search radius). Monitor cluster health with Prometheus. Persist to disk for recovery.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Matching Service Overload</div>
                <p>Matching service can't keep up with 50K rides/hour. Requests backing up in Kafka.</p>
                <div class="case-solution">Horizontal auto-scale based on Kafka consumer lag. Partition by city for parallel processing. Shed load by delaying low-priority matches (scheduled rides). Circuit breaker if downstream (Redis) slow. Pre-compute driver availability bitmaps.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Lambda Cold Start Storm</div>
                <p>Traffic spike triggers massive Lambda scaling. Cold starts cause 2-3s delays.</p>
                <div class="case-solution">Provisioned concurrency for baseline (500 instances). Warm pools via scheduled ping. Reduce package size (&lt;50MB). Use SnapStart for Java. Fallback to direct Kinesis-to-Redis for critical path. Monitor throttling errors.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Database Shard Hotspot</div>
                <p>Mumbai shard (35% of traffic) hitting write limits during peak.</p>
                <div class="case-solution">Further shard Mumbai into zones (North/South). Async writes for non-critical updates. Use Redis write-behind cache. Promote read replica to accept writes temporarily. Monitor IOPS and latency per shard.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">ML-Based Demand Forecasting</div>
                <p>Predict ride demand 30 minutes ahead for proactive supply positioning.</p>
                <div class="future-approach">Time-series model (Prophet/LSTM) trained on historical data. Features: time, day, weather, events, holidays. Output: rides/H3 cell/30min. Feed to driver app as "busy zones". Reduce surge by 20% through better positioning.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Dynamic Pricing with Caps</div>
                <p>Real-time pricing that balances demand while protecting consumers.</p>
                <div class="future-approach">Gradient-based pricing: small demand/supply ratio changes = small price changes. Hard caps per city (regulated). Show "wait 10 min for lower price" option. A/B test price sensitivity. Audit logs for regulatory compliance.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Event-Driven Architecture</div>
                <p>Full CQRS/Event Sourcing for audit trail and system reliability.</p>
                <div class="future-approach">All state changes as events in Kafka. Rebuild state from event log. Separate read models (Elasticsearch for search, Redis for matching). Enable replay for debugging. Support event versioning and migration.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Real-Time Fraud Detection</div>
                <p>ML model detecting fraudulent rides, fake GPS, collusion in real-time.</p>
                <div class="future-approach">Stream processing (Flink) on ride events. Features: route deviation, driver-rider history, fare patterns. Flag for review or auto-block. Feedback loop from manual reviews. Low latency (&lt;5s) for in-progress ride intervention.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle 7.5M location updates per minute efficiently?</div>
                    <div class="followup-hint">Kinesis with 50 shards (150K/shard/min). Lambda consumers batch 500ms of updates. Pipeline GEOADD commands to Redis (100 commands per round-trip). Compress payloads (protobuf). Accept 500ms staleness for matching.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">Why use H3 over geohash for high-scale geospatial operations?</div>
                    <div class="followup-hint">H3 hexagons have consistent area (unlike geohash rectangles). No edge distortion at poles. K-ring gives exactly N neighbors. Hierarchy for zoom levels. Better for demand/supply aggregation. Uber open-sourced, battle-tested.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement priority matching for premium users during surge?</div>
                    <div class="followup-hint">Separate Kafka topics by rider tier. Premium queue processed first. Lower latency SLA (2s vs 5s). Access to larger driver pool (7km vs 5km radius). Driver incentive to accept premium rides. A/B test impact on non-premium conversion.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle sticky WebSocket sessions with NLB?</div>
                    <div class="followup-hint">NLB uses 5-tuple hash for connection stickiness. Store connection → server mapping in Redis. On reconnect, route to same server or replay missed messages from Redis buffer. Graceful shutdown drains connections. Health checks exclude WebSocket endpoints.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How do you scale PostgreSQL shards for ride data?</div>
                    <div class="followup-hint">Shard by region (North/South/East/West). Use Vitess or Citus for transparent sharding. Shard key in every query. Cross-shard joins avoided (denormalize). Each shard has own connection pool. Monitor per-shard latency independently.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>High Traffic Stage - Event Surge Flow</h4>
            <div class="flow-vertical">
                <!-- Location Ingestion at Scale -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">LOCATION INGESTION (7.5M/min)</div>
                    <div class="flow-row">
                        <div class="flow-node user">500K Drivers<br><small>GPS every 4s</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">NLB<br><small>Layer 4</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Kinesis<br><small>50 shards</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Lambda<br><small>Batch 500ms</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node cache">Redis Cluster<br><small>GEOADD pipeline</small></div>
                    </div>
                </div>

                <!-- Matching at Scale -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #7c3aed; margin-bottom: 12px;">MATCHING (50K rides/hour)</div>
                    <div class="flow-row">
                        <div class="flow-node service">Kafka<br><small>ride.requested</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Matching (5x)<br><small>Partition by city</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node cache">Redis Cluster<br><small>GEORADIUS</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Scoring<br><small>H3 + rating</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node user">Driver Push<br><small>FCM batch</small></div>
                    </div>
                </div>

                <!-- Real-time WebSocket at Scale -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #0891b2; margin-bottom: 12px;">WEBSOCKET (1M connections)</div>
                    <div class="flow-row">
                        <div class="flow-node user">Apps<br><small>Persistent conn</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">NLB<br><small>5-tuple sticky</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">WS Fleet (10x)<br><small>100K conn each</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node cache">Redis Pub/Sub<br><small>Cluster mode</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node user">Broadcast<br><small>Location updates</small></div>
                    </div>
                </div>

                <!-- Event Surge Handling -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #dc2626; margin-bottom: 12px;">SURGE HANDLING (Concert Exit)</div>
                    <div class="flow-row">
                        <div class="flow-node user">50K Requests<br><small>5 min burst</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Queue<br><small>Fair ordering</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Batch Match<br><small>Every 2s</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Surge Cap<br><small>Max 3x</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node user">ETA + Wait<br><small>Communicate delay</small></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution Across Stages</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x1F331;</div>
                    <div class="evolution-label">MVP</div>
                    <div class="evolution-db">PostgreSQL + PostGIS</div>
                    <div class="evolution-detail">Single primary<br>Redis for locations</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x1F1EE;&#x1F1F3;</div>
                    <div class="evolution-label">PAN-India</div>
                    <div class="evolution-db">Redis GEO Sharded</div>
                    <div class="evolution-detail">City-based keys<br>Read replicas</div>
                </div>
                <div class="evolution-stage current">
                    <div class="evolution-icon">&#x26A1;</div>
                    <div class="evolution-label">High Traffic</div>
                    <div class="evolution-db">H3 Hexagonal Index</div>
                    <div class="evolution-detail">Resolution 8-9<br>Surge zones</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x1F30D;</div>
                    <div class="evolution-label">Global</div>
                    <div class="evolution-db">CockroachDB</div>
                    <div class="evolution-detail">Geo-partitioned<br>Data residency</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- GLOBAL SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="global">
        <div class="stage-header">
            <span class="stage-badge global">Global Scale</span>
            <h2 style="margin: 0;">5M drivers - 20M rides/day - 50 countries</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Multi-currency support</li>
                        <li>Local payment methods</li>
                        <li>Regulatory compliance (GDPR, etc.)</li>
                        <li>Multi-language support</li>
                        <li>Cross-border rides</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Global latency: &lt;150ms</li>
                        <li>Availability: 99.99%</li>
                        <li>Data residency compliance</li>
                        <li>Active-active multi-region</li>
                    </ul>
                </div>
            </div>
        </div>

        <h3>Global Architecture</h3>
        <div class="diagram-container">
            <h4>Multi-Region Active-Active</h4>
            <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;">
                <div style="text-align: center; padding: 20px; background: rgba(59,130,246,0.1); border-radius: 12px;">
                    <strong>Americas</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">Redis</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(34,197,94,0.1); border-radius: 12px;">
                    <strong>Europe</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">Redis</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(249,115,22,0.1); border-radius: 12px;">
                    <strong>Asia-Pacific</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">Redis</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(236,72,153,0.1); border-radius: 12px;">
                    <strong>Middle East</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">Redis</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
            </div>
            <p style="margin-top: 16px;"><strong>CockroachDB:</strong> Distributed SQL with automatic geo-partitioning. Data stays in region for compliance.</p>
        </div>

        <!-- Data Flow -->
        <h3>Data Flow - Global Request</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Paris User</div>
                    <div class="flow-step-label">Ride request</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box cdn" style="padding: 10px 16px;">CloudFront</div>
                    <div class="flow-step-label">Edge POP</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">EU API</div>
                    <div class="flow-step-label">Frankfurt</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box db" style="padding: 10px 16px;">CockroachDB</div>
                    <div class="flow-step-label">EU partition</div>
                </div>
            </div>
        </div>

        <!-- Database Schema - Global -->
        <h3>Database Schema - Geo-Partitioned</h3>
        <div class="sql-query">
            <h5>CockroachDB Geo-Partitioning</h5>
<pre>-- Create table with region column for partitioning
CREATE TABLE rides (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    region STRING NOT NULL,
    rider_id UUID NOT NULL,
    driver_id UUID NOT NULL,
    status STRING NOT NULL,
    fare DECIMAL(10,2),
    currency STRING DEFAULT 'USD',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    INDEX (region, created_at)
) PARTITION BY LIST (region) (
    PARTITION americas VALUES IN ('us-east', 'us-west', 'brazil'),
    PARTITION europe VALUES IN ('eu-west', 'eu-central'),
    PARTITION apac VALUES IN ('ap-south', 'ap-southeast', 'ap-northeast'),
    PARTITION mena VALUES IN ('me-south', 'af-south')
);

-- Pin partitions to regions for data residency
ALTER PARTITION americas OF TABLE rides
    CONFIGURE ZONE USING constraints='[+region=us-east-1]';
ALTER PARTITION europe OF TABLE rides
    CONFIGURE ZONE USING constraints='[+region=eu-central-1]';</pre>
        </div>

        <!-- Scale Metrics -->
        <h3>Scale Metrics</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">5M+</div>
                <div class="label">Active Drivers</div>
            </div>
            <div class="metric">
                <div class="value">20M</div>
                <div class="label">Rides/Day</div>
            </div>
            <div class="metric">
                <div class="value">&lt;2s</div>
                <div class="label">Match Latency</div>
            </div>
            <div class="metric">
                <div class="value">99.99%</div>
                <div class="label">Availability</div>
            </div>
        </div>

        <div class="metrics-card" style="margin-top: 16px;">
            <div class="metric">
                <div class="value">50+</div>
                <div class="label">Countries</div>
            </div>
            <div class="metric">
                <div class="value">100M</div>
                <div class="label">Location Updates/min</div>
            </div>
            <div class="metric">
                <div class="value">1.5-3x</div>
                <div class="label">Surge Range</div>
            </div>
            <div class="metric">
                <div class="value">4</div>
                <div class="label">Active Regions</div>
            </div>
        </div>

        <!-- Design Patterns at Scale -->
        <h3>Design Patterns at Global Scale</h3>
        <div class="patterns-grid">
            <div class="pattern-card">
                <h5>CQRS Pattern</h5>
                <p>Separate read/write models. Writes to CockroachDB, reads from regional Redis + read replicas. Eventual consistency accepted.</p>
            </div>
            <div class="pattern-card">
                <h5>Event Sourcing</h5>
                <p>Ride lifecycle as events: RideRequested, DriverMatched, TripStarted, TripCompleted. Enables replay, audit, analytics.</p>
            </div>
            <div class="pattern-card">
                <h5>Saga Pattern</h5>
                <p>Distributed transaction for ride: Reserve driver → Confirm pickup → Process payment. Compensating actions on failure.</p>
            </div>
            <div class="pattern-card">
                <h5>Circuit Breaker</h5>
                <p>Wrap payment gateway, maps API. If 5 failures in 10s → open circuit → fallback to cached ETA/fare estimate.</p>
            </div>
        </div>

        <!-- K8s at Global -->
        <h3>K8s Deployment - Global</h3>
        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">Multi-Cluster Federation (simplified)</h5>
<pre><span class="yaml-key">apiVersion</span>: apps/v1
<span class="yaml-key">kind</span>: Deployment
<span class="yaml-key">metadata</span>:
  <span class="yaml-key">name</span>: ride-api
  <span class="yaml-key">labels</span>: {app: ride-api, region: eu-central}
<span class="yaml-key">spec</span>:
  <span class="yaml-key">replicas</span>: <span class="yaml-number">20</span>
  <span class="yaml-key">strategy</span>: {type: RollingUpdate, maxSurge: <span class="yaml-string">"25%"</span>, maxUnavailable: <span class="yaml-number">0</span>}
  <span class="yaml-key">template</span>:
    <span class="yaml-key">spec</span>:
      <span class="yaml-key">topologySpreadConstraints</span>:
      - <span class="yaml-key">maxSkew</span>: <span class="yaml-number">1</span>
        <span class="yaml-key">topologyKey</span>: topology.kubernetes.io/zone
      <span class="yaml-key">containers</span>:
      - <span class="yaml-key">name</span>: api
        <span class="yaml-key">image</span>: ride-booking:v3.0.0
        <span class="yaml-key">env</span>: [{name: REGION, value: <span class="yaml-string">"eu-central"</span>}]
        <span class="yaml-key">envFrom</span>: [secretRef: {name: db-creds}]
        <span class="yaml-key">resources</span>:
          <span class="yaml-key">requests</span>: {cpu: <span class="yaml-string">"2000m"</span>, memory: <span class="yaml-string">"4Gi"</span>}
          <span class="yaml-key">limits</span>: {cpu: <span class="yaml-string">"4000m"</span>, memory: <span class="yaml-string">"8Gi"</span>}
---
<span class="yaml-key">apiVersion</span>: autoscaling/v2
<span class="yaml-key">kind</span>: HorizontalPodAutoscaler
<span class="yaml-key">metadata</span>: {<span class="yaml-key">name</span>: ride-api-hpa}
<span class="yaml-key">spec</span>:
  <span class="yaml-key">scaleTargetRef</span>: {kind: Deployment, name: ride-api}
  <span class="yaml-key">minReplicas</span>: <span class="yaml-number">20</span>
  <span class="yaml-key">maxReplicas</span>: <span class="yaml-number">100</span>
  <span class="yaml-key">metrics</span>:
  - <span class="yaml-key">type</span>: Resource
    <span class="yaml-key">resource</span>: {name: cpu, target: {type: Utilization, averageUtilization: <span class="yaml-number">60</span>}}
  <span class="yaml-key">behavior</span>:
    <span class="yaml-key">scaleUp</span>: {stabilizationWindowSeconds: <span class="yaml-number">60</span>}</pre>
        </div>

        <!-- Rollback at Global -->
        <h3>Rollback Strategy - Global</h3>
        <div class="feature-card warning">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4>Region-by-Region Rollout</h4>
                    <ol style="font-size: 14px;">
                        <li>Deploy to staging (internal traffic)</li>
                        <li>Canary in smallest region (ME)</li>
                        <li>Expand to APAC (off-peak for US/EU)</li>
                        <li>EU during EU morning</li>
                        <li>Americas during Americas morning</li>
                    </ol>
                </div>
                <div>
                    <h4>Instant Region Failover</h4>
                    <div class="code-example" style="margin: 12px 0;">
<pre># Drain region via Route 53
aws route53 change-resource-record-sets \
  --hosted-zone-id Z123 \
  --change-batch file://failover.json</pre>
                    </div>
                    <p style="font-size: 14px;">Traffic shifts to next-nearest region in &lt;60s.</p>
                </div>
            </div>
        </div>

        <!-- Cost at Global -->
        <h3>Cost at Global Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (4 regions, 200 nodes total)</td><td>$50,000</td></tr>
                <tr><td>CockroachDB Cloud (4 regions)</td><td>$40,000</td></tr>
                <tr><td>ElastiCache Global (128 nodes)</td><td>$15,000</td></tr>
                <tr><td>Kinesis (200 shards)</td><td>$10,000</td></tr>
                <tr><td>Kafka/MSK (4 regions)</td><td>$12,000</td></tr>
                <tr><td>CloudFront + Route 53</td><td>$8,000</td></tr>
                <tr><td>Maps API (Google/Mapbox)</td><td>$25,000</td></tr>
                <tr><td>Monitoring (Datadog)</td><td>$10,000</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$170,000/month</strong></td></tr>
            </table>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Cross-Border Ride (EU → Non-EU)</div>
                <p>Rider starts in Germany, ends in Switzerland. Different data residency, currency, and regulations.</p>
                <div class="case-solution">Detect border crossing at booking via route analysis. Show dual-jurisdiction notice. Store data in both regions (GDPR allows transfer with consent). Handle currency conversion at booking rate. Partner with local operators for license compliance.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">CockroachDB Region Failure</div>
                <p>Entire EU region of CockroachDB goes offline. Millions of European rides affected.</p>
                <div class="case-solution">CockroachDB survives minority region loss (quorum in remaining regions). Writes redirect to nearest region. Temporary latency increase (100ms → 200ms). Partition data survives on 2 of 3 replicas. Monitor range unavailability dashboards. Manually rebalance after recovery.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Maps API Quota Exceeded</div>
                <p>Google Maps API quota exhausted mid-day. ETA and routing unavailable globally.</p>
                <div class="case-solution">Multi-vendor maps (Google + Mapbox + HERE). Circuit breaker per provider. Cache popular routes (airport → downtown). Fallback to straight-line distance with buffer. Pre-negotiate enterprise quotas. Real-time quota monitoring with auto-switch.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Time Zone Edge Cases</div>
                <p>Scheduled ride spans DST change. Rider books "9 AM" but clocks change overnight.</p>
                <div class="case-solution">Store all times in UTC internally. Convert to local only for display. Detect DST transitions at booking time. Confirm with rider if ambiguous (2 AM happens twice). Use IANA timezone database. Send reminders in local time with UTC backup.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Payment Method Not Supported in Region</div>
                <p>Rider with Indian wallet tries to book in UAE. Wallet not available in that region.</p>
                <div class="case-solution">Check payment method availability at booking based on rider + pickup location. Offer alternative methods (international cards, local wallets). Pre-authorize before ride. Allow cash in supported regions. Show clear error with alternatives.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Language/Script Mismatch</div>
                <p>Japanese driver, Arabic-speaking rider. Address in Arabic script, driver can't read.</p>
                <div class="case-solution">Transliterate addresses to driver's language. Show phonetic pronunciation. In-app translation for chat. Pin drop for pickup/dropoff (reduce text dependency). Multilingual voice directions. Support RTL and LTR layouts.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">Federated Learning for Global ML</div>
                <p>Train ML models on decentralized data without moving data across borders.</p>
                <div class="future-approach">Train local models per region (GDPR-compliant). Aggregate gradients centrally without raw data. Personalization stays local. Global model improves from all regions. Handle non-IID data across regions. Reduce model sync frequency to save bandwidth.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Carbon-Neutral Operations</div>
                <p>Achieve net-zero carbon for all rides globally through offsets and EV incentives.</p>
                <div class="future-approach">Track emissions per ride (vehicle type, distance, occupancy). Partner with verified offset providers. Rider opt-in for carbon-neutral rides (small fee). Driver EV incentives (higher earnings). Green badges and leaderboards. Annual sustainability reports.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Interoperability with Public Transit</div>
                <p>Seamless integration with local transit agencies worldwide for unified mobility.</p>
                <div class="future-approach">Integrate MaaS (Mobility as a Service) standards. Partner with transit authorities. Unified ticketing and payment. Show ride + transit combinations. First/last mile optimization. Real-time transit data integration (GTFS-RT).</div>
            </div>

            <div class="future-item">
                <div class="future-title">Drone/Air Taxi Integration</div>
                <p>Future urban air mobility for premium long-distance routes.</p>
                <div class="future-approach">Separate vehicle class for air mobility. Vertiport integration (booking landing slots). Weather-aware availability. Regulatory compliance per airspace. Ground transport coordination for first/last mile. Premium pricing model.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">Why CockroachDB over PostgreSQL with Citus for global scale?</div>
                    <div class="followup-hint">CockroachDB: native geo-partitioning, automatic rebalancing, survives region failure. Citus: extension, manual sharding, single-region focus. CockroachDB SERIALIZE isolation. Data residency via zone constraints. PostgreSQL-compatible wire protocol.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle GDPR right to deletion across distributed system?</div>
                    <div class="followup-hint">Soft delete with 30-day grace period. Cascade to all services via Kafka event. Audit log of deletion (metadata only). Anonymize analytics (can't delete aggregates). Hard delete from all replicas. Provide export before deletion. Compliance dashboard.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement global driver repositioning incentives?</div>
                    <div class="followup-hint">ML model predicts demand by region/time. Calculate driver surplus/deficit per H3 cell. Offer bonuses for repositioning to deficit areas. Show heat maps in driver app. Factor in driver preferences and distance. A/B test incentive amounts.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How do you ensure consistent experience across 50 countries?</div>
                    <div class="followup-hint">Core platform is global, customization via config. Feature flags per region. Local payment integrations. Regulatory rule engine. A/B test new features per market. Global SLAs with regional monitoring. Follow-the-sun on-call rotation.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle 100M location updates per minute globally?</div>
                    <div class="followup-hint">Regional Kinesis/Kafka (no cross-region streaming). 200 shards globally. Edge processing with Lambda@Edge. Aggregate before writing to Redis. Accept 1s staleness globally. Monitor per-region ingestion lag. Auto-scale consumers based on backlog.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>Global Stage - Multi-Region Active-Active Flow</h4>
            <div class="flow-vertical">
                <!-- Global Request Routing -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">GLOBAL REQUEST ROUTING</div>
                    <div class="flow-row">
                        <div class="flow-node user">Paris Rider<br><small>Ride request</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node gateway">CloudFront<br><small>Edge POP</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node gateway">Route 53<br><small>Geolocation</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">EU API<br><small>Frankfurt</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node db">CockroachDB<br><small>EU partition</small></div>
                    </div>
                </div>

                <!-- Multi-Region Matching -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #7c3aed; margin-bottom: 12px;">REGIONAL MATCHING (Isolated per Region)</div>
                    <div class="flow-row">
                        <div class="flow-node service">EU Kafka<br><small>ride.requested</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">EU Matching<br><small>Frankfurt cluster</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node cache">EU Redis<br><small>Paris drivers</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">FCM Europe<br><small>Low latency push</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node user">French Driver<br><small>Accept ride</small></div>
                    </div>
                </div>

                <!-- Cross-Region Data Sync -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #f59e0b; margin-bottom: 12px;">DATA RESIDENCY (GDPR Compliant)</div>
                    <div class="flow-row">
                        <div class="flow-node db">CockroachDB EU<br><small>EU user data</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Zone Constraint<br><small>Data stays in EU</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Global Metadata<br><small>Anonymized only</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node db">Analytics<br><small>Aggregated stats</small></div>
                    </div>
                </div>

                <!-- WebSocket Global -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #0891b2; margin-bottom: 12px;">REAL-TIME TRACKING (Regional WebSocket)</div>
                    <div class="flow-row">
                        <div class="flow-node user">Driver GPS<br><small>Every 4s</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">Regional WS<br><small>Nearest edge</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node cache">Regional Redis<br><small>Pub/Sub local</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node service">WS Broadcast<br><small>Same region</small></div>
                        <div class="flow-arrow">&#8594;</div>
                        <div class="flow-node user">Rider App<br><small>&lt;150ms latency</small></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution Across Stages</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x1F331;</div>
                    <div class="evolution-label">MVP</div>
                    <div class="evolution-db">PostgreSQL + PostGIS</div>
                    <div class="evolution-detail">Single primary<br>Redis for locations</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x1F1EE;&#x1F1F3;</div>
                    <div class="evolution-label">PAN-India</div>
                    <div class="evolution-db">Redis GEO Sharded</div>
                    <div class="evolution-detail">City-based keys<br>Read replicas</div>
                </div>
                <div class="evolution-stage">
                    <div class="evolution-icon">&#x26A1;</div>
                    <div class="evolution-label">High Traffic</div>
                    <div class="evolution-db">H3 Hexagonal Index</div>
                    <div class="evolution-detail">Resolution 8-9<br>Surge zones</div>
                </div>
                <div class="evolution-stage current">
                    <div class="evolution-icon">&#x1F30D;</div>
                    <div class="evolution-label">Global</div>
                    <div class="evolution-db">CockroachDB</div>
                    <div class="evolution-detail">Geo-partitioned<br>Data residency</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- CAP ANALYSIS SECTION -->
    <!-- ============================================ -->
    <div class="stage-section" id="cap-analysis">
        <div class="stage-header">
            <span class="stage-badge" style="background: linear-gradient(135deg, #f59e0b 0%, #8b5cf6 100%); color: white;">Mixed CP/AP</span>
            <h2 style="margin: 0;">CAP Theorem Analysis - Ride Booking System</h2>
        </div>

        <p class="topic-description" style="margin-bottom: 24px;">
            A ride booking system like Uber/Ola is a <strong>mixed CP/AP system</strong> - different components have different consistency requirements.
            Driver assignment needs strong consistency (CP) to prevent double-booking, while location tracking can tolerate eventual consistency (AP) for better availability.
        </p>

        <!-- CAP VISUAL OVERVIEW -->
        <h3>Component-Wise CAP Classification</h3>
        <div class="diagram-container">
            <h4>Ride Booking System - CAP Breakdown</h4>
            <div class="cap-visual-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; width: 100%;">

                <!-- CP Components -->
                <div class="cap-component-card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 16px; padding: 20px; border-left: 5px solid #3b82f6;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <span style="background: #3b82f6; color: white; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 13px;">CP</span>
                        <span style="color: #1e40af; font-weight: 700;">Consistency + Partition Tolerance</span>
                    </div>
                    <ul style="margin: 0; padding-left: 20px; color: #1e40af; font-size: 14px; line-height: 1.8;">
                        <li><strong>Driver Assignment</strong> - Can't assign same driver to two riders</li>
                        <li><strong>Fare Calculation</strong> - Must be accurate, no discrepancies</li>
                        <li><strong>Payment Processing</strong> - Double-charge prevention critical</li>
                        <li><strong>Promo Code Redemption</strong> - Single-use enforcement</li>
                    </ul>
                </div>

                <!-- AP Components -->
                <div class="cap-component-card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 16px; padding: 20px; border-left: 5px solid #22c55e;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <span style="background: #22c55e; color: white; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 13px;">AP</span>
                        <span style="color: #166534; font-weight: 700;">Availability + Partition Tolerance</span>
                    </div>
                    <ul style="margin: 0; padding-left: 20px; color: #166534; font-size: 14px; line-height: 1.8;">
                        <li><strong>Driver Location Tracking</strong> - 4-sec staleness acceptable</li>
                        <li><strong>ETA Calculations</strong> - Approximate is fine</li>
                        <li><strong>Ride History</strong> - Eventual consistency OK</li>
                        <li><strong>Ratings & Reviews</strong> - Can sync later</li>
                    </ul>
                </div>

                <!-- Special Handling -->
                <div class="cap-component-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; padding: 20px; border-left: 5px solid #f59e0b;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <span style="background: #f59e0b; color: white; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 13px;">SOFT RT</span>
                        <span style="color: #92400e; font-weight: 700;">Soft Real-Time Requirements</span>
                    </div>
                    <ul style="margin: 0; padding-left: 20px; color: #92400e; font-size: 14px; line-height: 1.8;">
                        <li><strong>Driver Availability</strong> - Needs quick updates, not strict CP</li>
                        <li><strong>Surge Pricing</strong> - Near real-time, small delay OK</li>
                        <li><strong>Notifications</strong> - Best-effort delivery acceptable</li>
                        <li><strong>Map Updates</strong> - Refresh every few seconds</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- DETAILED CAP BREAKDOWN TABLE -->
        <h3>Detailed CAP Analysis by Component</h3>
        <div class="feature-card">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>CAP Choice</th>
                        <th>Why This Choice?</th>
                        <th>Failure Impact</th>
                        <th>Implementation</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Driver Assignment</strong></td>
                        <td><span class="cap-badge cp">CP</span></td>
                        <td>Double-booking = two angry customers + driver confusion</td>
                        <td style="color: #dc2626;">Critical - Legal liability, refunds</td>
                        <td>Distributed lock with Redis SETNX + PostgreSQL transaction</td>
                    </tr>
                    <tr>
                        <td><strong>Fare Calculation</strong></td>
                        <td><span class="cap-badge cp">CP</span></td>
                        <td>Inconsistent fares = disputes, regulatory issues</td>
                        <td style="color: #dc2626;">Critical - Customer trust, compliance</td>
                        <td>Single source of truth, calculated server-side</td>
                    </tr>
                    <tr>
                        <td><strong>Payment Processing</strong></td>
                        <td><span class="cap-badge cp">CP</span></td>
                        <td>Double-charge or missed payment = financial loss</td>
                        <td style="color: #dc2626;">Critical - Financial, chargebacks</td>
                        <td>Idempotency keys, payment gateway integration</td>
                    </tr>
                    <tr>
                        <td><strong>Driver Location</strong></td>
                        <td><span class="cap-badge ap">AP</span></td>
                        <td>4-second old location still usable for matching</td>
                        <td style="color: #f59e0b;">Medium - Slightly inaccurate ETA</td>
                        <td>Redis GEO with TTL, last-write-wins</td>
                    </tr>
                    <tr>
                        <td><strong>Driver Availability</strong></td>
                        <td><span class="cap-badge soft-rt">Soft RT</span></td>
                        <td>Brief staleness OK, but needs quick convergence</td>
                        <td style="color: #f59e0b;">Medium - Wasted matching attempts</td>
                        <td>Redis with short TTL (10s), heartbeat refresh</td>
                    </tr>
                    <tr>
                        <td><strong>Ride History</strong></td>
                        <td><span class="cap-badge ap">AP</span></td>
                        <td>Historical data can be eventually consistent</td>
                        <td style="color: #22c55e;">Low - Delayed display acceptable</td>
                        <td>Async write to PostgreSQL, read replicas</td>
                    </tr>
                    <tr>
                        <td><strong>Ratings & Reviews</strong></td>
                        <td><span class="cap-badge ap">AP</span></td>
                        <td>Aggregate rating can be slightly stale</td>
                        <td style="color: #22c55e;">Low - Minor UX impact</td>
                        <td>Write to queue, batch process, cache result</td>
                    </tr>
                    <tr>
                        <td><strong>Surge Pricing</strong></td>
                        <td><span class="cap-badge soft-rt">Soft RT</span></td>
                        <td>30-second delay acceptable, but not minutes</td>
                        <td style="color: #f59e0b;">Medium - Revenue/demand mismatch</td>
                        <td>Redis pub/sub, recalculate every 30s per zone</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- DRIVER ASSIGNMENT DEEP DIVE -->
        <h3>Deep Dive: Driver Assignment (CP Critical Path)</h3>
        <div class="diagram-container">
            <h4>Preventing Double-Booking with Distributed Locking</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <!-- Flow Diagram -->
                <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                    <div class="flow-step">
                        <div class="flow-step-number">1</div>
                        <div class="arch-box server" style="padding: 10px 16px;">Matching Engine</div>
                        <div class="flow-step-label">Find top 3 drivers</div>
                    </div>
                    <div class="arch-arrow">&#8594;</div>
                    <div class="flow-step">
                        <div class="flow-step-number">2</div>
                        <div class="arch-box cache" style="padding: 10px 16px;">Redis SETNX</div>
                        <div class="flow-step-label">Lock driver:123</div>
                    </div>
                    <div class="arch-arrow">&#8594;</div>
                    <div class="flow-step">
                        <div class="flow-step-number">3</div>
                        <div class="arch-box db" style="padding: 10px 16px;">PostgreSQL</div>
                        <div class="flow-step-label">BEGIN TRANSACTION</div>
                    </div>
                    <div class="arch-arrow">&#8594;</div>
                    <div class="flow-step">
                        <div class="flow-step-number">4</div>
                        <div class="arch-box db" style="padding: 10px 16px;">Check & Update</div>
                        <div class="flow-step-label">Verify + Assign</div>
                    </div>
                    <div class="arch-arrow">&#8594;</div>
                    <div class="flow-step">
                        <div class="flow-step-number">5</div>
                        <div class="arch-box server" style="padding: 10px 16px;">Commit/Rollback</div>
                        <div class="flow-step-label">Release lock</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Example: Distributed Locking -->
        <div class="code-example">
            <h5>Driver Assignment with Distributed Locking</h5>
            <pre><span class="keyword">async function</span> <span class="function">assignDriverToRide</span>(rideId: <span class="class-name">string</span>, driverIds: <span class="class-name">string</span>[]) {
    <span class="keyword">for</span> (<span class="keyword">const</span> driverId <span class="keyword">of</span> driverIds) {
        <span class="comment">// Step 1: Acquire distributed lock (15s TTL)</span>
        <span class="keyword">const</span> lockKey = <span class="string">`lock:driver:</span>${driverId}<span class="string">`</span>;
        <span class="keyword">const</span> lockAcquired = <span class="keyword">await</span> redis.<span class="function">set</span>(lockKey, rideId, <span class="string">'NX'</span>, <span class="string">'EX'</span>, <span class="number">15</span>);

        <span class="keyword">if</span> (!lockAcquired) {
            <span class="keyword">continue</span>; <span class="comment">// Driver being assigned elsewhere, try next</span>
        }

        <span class="keyword">try</span> {
            <span class="comment">// Step 2: Database transaction with SERIALIZABLE isolation</span>
            <span class="keyword">await</span> db.<span class="function">transaction</span>(<span class="keyword">async</span> (trx) => {
                <span class="comment">// Double-check driver is still available</span>
                <span class="keyword">const</span> driver = <span class="keyword">await</span> trx(<span class="string">'drivers'</span>)
                    .<span class="function">where</span>({ id: driverId, status: <span class="string">'available'</span> })
                    .<span class="function">forUpdate</span>()  <span class="comment">// Row-level lock</span>
                    .<span class="function">first</span>();

                <span class="keyword">if</span> (!driver) {
                    <span class="keyword">throw new</span> <span class="class-name">Error</span>(<span class="string">'Driver no longer available'</span>);
                }

                <span class="comment">// Atomic update: ride + driver status</span>
                <span class="keyword">await</span> trx(<span class="string">'rides'</span>).<span class="function">update</span>({ driver_id: driverId, status: <span class="string">'assigned'</span> }).<span class="function">where</span>({ id: rideId });
                <span class="keyword">await</span> trx(<span class="string">'drivers'</span>).<span class="function">update</span>({ status: <span class="string">'on_trip'</span>, current_ride_id: rideId }).<span class="function">where</span>({ id: driverId });
            });

            <span class="comment">// Step 3: Update Redis cache (async, best-effort)</span>
            <span class="keyword">await</span> redis.<span class="function">srem</span>(<span class="string">'available_drivers:mumbai'</span>, driverId);

            <span class="keyword">return</span> { success: <span class="keyword">true</span>, driverId };

        } <span class="keyword">catch</span> (error) {
            <span class="comment">// Transaction failed, driver was taken</span>
            <span class="keyword">continue</span>; <span class="comment">// Try next driver</span>
        } <span class="keyword">finally</span> {
            <span class="comment">// Always release lock</span>
            <span class="keyword">await</span> redis.<span class="function">del</span>(lockKey);
        }
    }

    <span class="keyword">return</span> { success: <span class="keyword">false</span>, reason: <span class="string">'No available drivers'</span> };
}</pre>
        </div>

        <!-- Race Condition Scenarios -->
        <h3>Race Condition Scenarios & Solutions</h3>
        <div class="pros-cons-grid">
            <div class="pros-section" style="border-color: #ef4444;">
                <h4 style="color: #991b1b;">Problem: Two Riders Request Same Driver</h4>
                <div style="background: #fef2f2; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <p style="font-size: 14px; color: #7f1d1d; margin: 0;">
                        <strong>Scenario:</strong> Rider A and Rider B both see driver X as nearest.
                        Both matching engines try to assign driver X simultaneously.
                    </p>
                </div>
                <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border-left: 4px solid #22c55e;">
                    <p style="font-size: 14px; color: #166534; margin: 0;">
                        <strong>Solution:</strong> Redis SETNX ensures only one request acquires the lock.
                        The loser immediately tries the next best driver. Total latency impact: ~5ms.
                    </p>
                </div>
            </div>

            <div class="pros-section" style="border-color: #f59e0b;">
                <h4 style="color: #92400e;">Problem: Driver Goes Offline During Assignment</h4>
                <div style="background: #fffbeb; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <p style="font-size: 14px; color: #78350f; margin: 0;">
                        <strong>Scenario:</strong> Driver X closes app while matching engine is assigning them.
                        Lock acquired, but driver won't respond.
                    </p>
                </div>
                <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border-left: 4px solid #22c55e;">
                    <p style="font-size: 14px; color: #166534; margin: 0;">
                        <strong>Solution:</strong> 15-second accept timeout. If driver doesn't accept,
                        ride status reverts, driver marked stale, cascade to next driver.
                    </p>
                </div>
            </div>
        </div>

        <!-- Location Tracking (AP) Deep Dive -->
        <h3>Deep Dive: Location Tracking (AP - Eventual Consistency)</h3>
        <div class="diagram-container">
            <h4>Why AP is Acceptable for Driver Locations</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; width: 100%;">
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h5 style="color: #3b82f6; margin: 0 0 12px 0;">Update Frequency</h5>
                    <p style="font-size: 14px; color: #475569; margin: 0;">
                        Drivers send GPS every <strong>4 seconds</strong>. Even if an update is lost,
                        the next one arrives shortly. At 60 km/h, 4 seconds = 66 meters - acceptable margin.
                    </p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h5 style="color: #22c55e; margin: 0 0 12px 0;">Last-Write-Wins</h5>
                    <p style="font-size: 14px; color: #475569; margin: 0;">
                        Conflicting writes don't matter - we always want the <strong>most recent location</strong>.
                        Redis GEOADD naturally overwrites, no conflict resolution needed.
                    </p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h5 style="color: #f59e0b; margin: 0 0 12px 0;">Graceful Degradation</h5>
                    <p style="font-size: 14px; color: #475569; margin: 0;">
                        If Redis node fails, matching uses slightly stale data from replica.
                        Better to show <strong>approximate nearby drivers</strong> than show nothing.
                    </p>
                </div>
            </div>
        </div>

        <!-- Code Example: Location Update -->
        <div class="code-example">
            <h5>Location Update - AP Strategy with Redis GEO</h5>
            <pre><span class="comment">// Driver app sends location every 4 seconds</span>
<span class="keyword">async function</span> <span class="function">updateDriverLocation</span>(driverId: <span class="class-name">string</span>, lat: <span class="class-name">number</span>, lng: <span class="class-name">number</span>) {
    <span class="keyword">const</span> city = <span class="keyword">await</span> <span class="function">getCityFromCoords</span>(lat, lng);
    <span class="keyword">const</span> geoKey = <span class="string">`drivers:location:</span>${city}<span class="string">`</span>;

    <span class="comment">// Fire-and-forget: Don't wait for confirmation (AP choice)</span>
    redis.<span class="function">pipeline</span>()
        <span class="comment">// Update geospatial index for matching queries</span>
        .<span class="function">geoadd</span>(geoKey, lng, lat, driverId)
        <span class="comment">// Set TTL - auto-expire if driver stops sending (10s)</span>
        .<span class="function">expire</span>(geoKey, <span class="number">3600</span>)  <span class="comment">// Key TTL</span>
        <span class="comment">// Track individual driver freshness</span>
        .<span class="function">setex</span>(<span class="string">`driver:heartbeat:</span>${driverId}<span class="string">`</span>, <span class="number">10</span>, Date.<span class="function">now</span>())
        <span class="comment">// Publish for real-time tracking (WebSocket consumers)</span>
        .<span class="function">publish</span>(<span class="string">`location:</span>${driverId}<span class="string">`</span>, JSON.<span class="function">stringify</span>({ lat, lng, ts: Date.<span class="function">now</span>() }))
        .<span class="function">exec</span>();  <span class="comment">// Non-blocking execution</span>

    <span class="comment">// Async: Write to Kafka for analytics (eventual consistency)</span>
    kafka.<span class="function">produce</span>(<span class="string">'driver-locations'</span>, { driverId, lat, lng, timestamp: Date.<span class="function">now</span>() });
}

<span class="comment">// Matching query - tolerates staleness</span>
<span class="keyword">async function</span> <span class="function">findNearbyDrivers</span>(lat: <span class="class-name">number</span>, lng: <span class="class-name">number</span>, radiusKm: <span class="class-name">number</span>) {
    <span class="keyword">const</span> city = <span class="keyword">await</span> <span class="function">getCityFromCoords</span>(lat, lng);

    <span class="comment">// GEORADIUS returns drivers within radius, sorted by distance</span>
    <span class="keyword">const</span> drivers = <span class="keyword">await</span> redis.<span class="function">georadius</span>(
        <span class="string">`drivers:location:</span>${city}<span class="string">`</span>,
        lng, lat, radiusKm, <span class="string">'km'</span>,
        <span class="string">'WITHDIST'</span>, <span class="string">'ASC'</span>, <span class="string">'COUNT'</span>, <span class="number">20</span>
    );

    <span class="comment">// Filter out stale drivers (no heartbeat in 10s)</span>
    <span class="keyword">const</span> freshDrivers = [];
    <span class="keyword">for</span> (<span class="keyword">const</span> [driverId, distance] <span class="keyword">of</span> drivers) {
        <span class="keyword">const</span> heartbeat = <span class="keyword">await</span> redis.<span class="function">get</span>(<span class="string">`driver:heartbeat:</span>${driverId}<span class="string">`</span>);
        <span class="keyword">if</span> (heartbeat) freshDrivers.<span class="function">push</span>({ driverId, distance });
    }

    <span class="keyword">return</span> freshDrivers;
}</pre>
        </div>

        <!-- Business Impact Justification -->
        <h3>Business Impact: Why These CAP Choices?</h3>
        <div class="feature-card" style="border-left-color: #8b5cf6;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                <div>
                    <h4 style="color: #6b21a8;">CP for Driver Assignment</h4>
                    <table style="width: 100%; font-size: 14px; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px 0; color: #dc2626;"><strong>Cost of Inconsistency:</strong></td>
                            <td style="padding: 8px 0;">$50-100 refund + support call + 2 angry customers</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #dc2626;"><strong>Brand Impact:</strong></td>
                            <td style="padding: 8px 0;">Negative reviews, social media complaints</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #dc2626;"><strong>Operational:</strong></td>
                            <td style="padding: 8px 0;">Driver trust erosion, potential churn</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #22c55e;"><strong>CP Overhead:</strong></td>
                            <td style="padding: 8px 0;">+5-15ms latency per assignment (acceptable)</td>
                        </tr>
                    </table>
                </div>
                <div>
                    <h4 style="color: #6b21a8;">AP for Location Tracking</h4>
                    <table style="width: 100%; font-size: 14px; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px 0; color: #22c55e;"><strong>Cost of Staleness:</strong></td>
                            <td style="padding: 8px 0;">ETA off by ~30 seconds (users tolerate)</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #22c55e;"><strong>Availability Gain:</strong></td>
                            <td style="padding: 8px 0;">99.99% vs 99.9% with CP (10x fewer outages)</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #22c55e;"><strong>Scale Benefit:</strong></td>
                            <td style="padding: 8px 0;">Handle 7.5M updates/min without coordination</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #f59e0b;"><strong>CP Alternative:</strong></td>
                            <td style="padding: 8px 0;">Would need consensus (Raft) - 100ms+ latency, complex</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Driver Availability - Special Case -->
        <h3>Special Case: Driver Availability (Soft Real-Time)</h3>
        <div class="diagram-container">
            <h4>Why Driver Availability Needs Special Handling</h4>
            <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box;">
                <p style="font-size: 15px; color: #334155; margin: 0 0 20px 0;">
                    Driver availability is <strong>neither strictly CP nor AP</strong>. It needs to be "fresh enough"
                    to avoid wasted matching attempts, but doesn't need ACID guarantees.
                </p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div style="background: #fef2f2; padding: 16px; border-radius: 8px;">
                        <h5 style="color: #991b1b; margin: 0 0 8px 0;">Too Stale (>30s)</h5>
                        <p style="font-size: 13px; color: #7f1d1d; margin: 0;">
                            Matching tries offline drivers. Timeout wastes 15s. Poor experience.
                        </p>
                    </div>
                    <div style="background: #fef3c7; padding: 16px; border-radius: 8px;">
                        <h5 style="color: #92400e; margin: 0 0 8px 0;">Sweet Spot (5-10s)</h5>
                        <p style="font-size: 13px; color: #78350f; margin: 0;">
                            Heartbeat with 10s TTL. Miss 2-3 updates before marked unavailable.
                        </p>
                    </div>
                    <div style="background: #fef2f2; padding: 16px; border-radius: 8px;">
                        <h5 style="color: #991b1b; margin: 0 0 8px 0;">Too Strict (CP)</h5>
                        <p style="font-size: 13px; color: #7f1d1d; margin: 0;">
                            Consensus for every heartbeat? 500K drivers = millions of ops/sec. Not scalable.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Implementation Pattern -->
        <div class="code-example">
            <h5>Soft Real-Time Availability with Heartbeat</h5>
            <pre><span class="comment">// Driver availability: Heartbeat-based with short TTL</span>

<span class="comment">// Driver sends heartbeat every 4s (same as location update)</span>
<span class="keyword">async function</span> <span class="function">markDriverAvailable</span>(driverId: <span class="class-name">string</span>, city: <span class="class-name">string</span>) {
    <span class="keyword">const</span> ttl = <span class="number">10</span>; <span class="comment">// Expire after 10s without heartbeat</span>

    <span class="keyword">await</span> redis.<span class="function">pipeline</span>()
        <span class="comment">// Add to available set with score = timestamp</span>
        .<span class="function">zadd</span>(<span class="string">`available:</span>${city}<span class="string">`</span>, Date.<span class="function">now</span>(), driverId)
        <span class="comment">// Individual TTL key for freshness check</span>
        .<span class="function">setex</span>(<span class="string">`available:</span>${driverId}<span class="string">`</span>, ttl, <span class="string">'1'</span>)
        .<span class="function">exec</span>();
}

<span class="comment">// Background job: Cleanup stale entries every 5s</span>
<span class="keyword">async function</span> <span class="function">cleanupStaleDrivers</span>(city: <span class="class-name">string</span>) {
    <span class="keyword">const</span> cutoff = Date.<span class="function">now</span>() - <span class="number">10000</span>; <span class="comment">// 10s ago</span>

    <span class="comment">// Remove drivers who haven't sent heartbeat</span>
    <span class="keyword">await</span> redis.<span class="function">zremrangebyscore</span>(<span class="string">`available:</span>${city}<span class="string">`</span>, <span class="number">0</span>, cutoff);
}

<span class="comment">// Matching: Check freshness before assignment</span>
<span class="keyword">async function</span> <span class="function">getAvailableDrivers</span>(city: <span class="class-name">string</span>, limit: <span class="class-name">number</span>) {
    <span class="comment">// Get recently active drivers</span>
    <span class="keyword">const</span> candidates = <span class="keyword">await</span> redis.<span class="function">zrevrange</span>(<span class="string">`available:</span>${city}<span class="string">`</span>, <span class="number">0</span>, limit * <span class="number">2</span>);

    <span class="comment">// Double-check individual freshness keys</span>
    <span class="keyword">const</span> pipeline = redis.<span class="function">pipeline</span>();
    candidates.<span class="function">forEach</span>(d => pipeline.<span class="function">exists</span>(<span class="string">`available:</span>${d}<span class="string">`</span>));
    <span class="keyword">const</span> results = <span class="keyword">await</span> pipeline.<span class="function">exec</span>();

    <span class="keyword">return</span> candidates.<span class="function">filter</span>((_, i) => results[i][<span class="number">1</span>] === <span class="number">1</span>).<span class="function">slice</span>(<span class="number">0</span>, limit);
}</pre>
        </div>

        <!-- Partition Handling -->
        <h3>Network Partition Handling</h3>
        <div class="feature-card" style="border-left-color: #ef4444;">
            <h4 style="color: #991b1b;">What Happens During a Network Partition?</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 16px;">
                <div style="background: #fef2f2; padding: 20px; border-radius: 12px;">
                    <h5 style="color: #dc2626; margin: 0 0 12px 0;">CP Components (Assignment, Payment)</h5>
                    <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #7f1d1d;">
                        <li>Requests <strong>rejected</strong> if can't reach primary</li>
                        <li>Users see "Service temporarily unavailable"</li>
                        <li>Prefer correctness over availability</li>
                        <li>Auto-retry when partition heals</li>
                    </ul>
                </div>
                <div style="background: #f0fdf4; padding: 20px; border-radius: 12px;">
                    <h5 style="color: #166534; margin: 0 0 12px 0;">AP Components (Location, History)</h5>
                    <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #166534;">
                        <li>Continue serving from <strong>local replica</strong></li>
                        <li>May show slightly stale data</li>
                        <li>Sync when partition heals</li>
                        <li>Users experience minimal disruption</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Interview Tips -->
        <div class="followup-features" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left-color: #f59e0b;">
            <h4 style="color: #92400e;">Interview Tips: CAP for Ride Booking</h4>

            <div class="followup-item" style="background: white; border-color: #fde68a;">
                <div class="followup-number" style="background: #f59e0b;">1</div>
                <div class="followup-content">
                    <div class="followup-question" style="color: #92400e;">"Why is ride booking a mixed CP/AP system?"</div>
                    <div class="followup-hint" style="background: #fffbeb; color: #78350f;">
                        Different components have different consistency needs. Driver assignment is CP because double-booking
                        causes refunds and angry customers. Location tracking is AP because 4-second staleness is acceptable
                        and we need to handle 7.5M updates/min at scale.
                    </div>
                </div>
            </div>

            <div class="followup-item" style="background: white; border-color: #fde68a;">
                <div class="followup-number" style="background: #f59e0b;">2</div>
                <div class="followup-content">
                    <div class="followup-question" style="color: #92400e;">"How do you prevent two riders from getting the same driver?"</div>
                    <div class="followup-hint" style="background: #fffbeb; color: #78350f;">
                        Two-phase approach: First, acquire a distributed lock (Redis SETNX with TTL). Then, database transaction
                        with row-level locking (SELECT FOR UPDATE). If lock fails, immediately try next best driver.
                        Total latency overhead: ~10ms - worth it to avoid double-booking.
                    </div>
                </div>
            </div>

            <div class="followup-item" style="background: white; border-color: #fde68a;">
                <div class="followup-number" style="background: #f59e0b;">3</div>
                <div class="followup-content">
                    <div class="followup-question" style="color: #92400e;">"What if Redis fails during driver assignment?"</div>
                    <div class="followup-hint" style="background: #fffbeb; color: #78350f;">
                        Redis is only for the fast-path lock. If Redis is down, fall back to database-only locking (slower but correct).
                        The PostgreSQL transaction with FOR UPDATE provides the actual consistency guarantee.
                        Redis just reduces contention and speeds up the common case.
                    </div>
                </div>
            </div>

            <div class="followup-item" style="background: white; border-color: #fde68a;">
                <div class="followup-number" style="background: #f59e0b;">4</div>
                <div class="followup-content">
                    <div class="followup-question" style="color: #92400e;">"Why not use CP for everything for simplicity?"</div>
                    <div class="followup-hint" style="background: #fffbeb; color: #78350f;">
                        CP requires coordination (consensus protocols like Raft/Paxos). At 7.5M location updates/minute,
                        coordination would add 50-100ms latency per update and create a scalability bottleneck.
                        Location data naturally fits last-write-wins semantics - we always want the latest position.
                    </div>
                </div>
            </div>

            <div class="followup-item" style="background: white; border-color: #fde68a;">
                <div class="followup-number" style="background: #f59e0b;">5</div>
                <div class="followup-content">
                    <div class="followup-question" style="color: #92400e;">"How do you handle surge pricing consistency?"</div>
                    <div class="followup-hint" style="background: #fffbeb; color: #78350f;">
                        Surge pricing is "soft real-time" - recalculated every 30 seconds per H3 zone. Slight staleness is acceptable
                        (rider sees 1.5x but actual might be 1.6x). The fare shown at booking time is locked in - that's the CP part.
                        The surge multiplier itself can be eventually consistent.
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Reference Card -->
        <div class="summary-flow">
            <h4>CAP Quick Reference - Ride Booking</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; width: 100%;">
                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">CP</div>
                    <div style="font-weight: 700; color: #1e40af; margin-bottom: 8px;">Strong Consistency</div>
                    <div style="font-size: 13px; color: #3b82f6;">
                        Driver Assignment<br>
                        Fare Calculation<br>
                        Payment Processing<br>
                        Promo Codes
                    </div>
                </div>
                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">AP</div>
                    <div style="font-weight: 700; color: #166534; margin-bottom: 8px;">High Availability</div>
                    <div style="font-size: 13px; color: #22c55e;">
                        Driver Location<br>
                        ETA Display<br>
                        Ride History<br>
                        Ratings
                    </div>
                </div>
                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px;">
                    <div style="font-size: 32px; margin-bottom: 8px;">Soft RT</div>
                    <div style="font-weight: 700; color: #92400e; margin-bottom: 8px;">Soft Real-Time</div>
                    <div style="font-size: 13px; color: #b45309;">
                        Driver Availability<br>
                        Surge Pricing<br>
                        Push Notifications<br>
                        Map Updates
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tooltip System -->
<div class="tooltip-overlay" id="tooltipOverlay" onclick="closeTooltip()"></div>
<div class="tooltip-popup" id="tooltipPopup">
    <button class="tooltip-close" onclick="closeTooltip()">&times;</button>
    <h4 id="tooltipTitle"></h4>
    <div id="tooltipContent"></div>
</div>

<script>
const termDefinitions = {
    'redis-geo': {
        title: 'Redis GEO Commands',
        content: `<p>Redis geospatial indexing for driver locations.</p>
        <div style="margin-top: 12px;">
            <strong>Key Commands:</strong>
            <pre style="background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; font-size: 13px;">GEOADD drivers:mumbai 77.59 12.97 "driver_123"
GEORADIUS drivers:mumbai 77.59 12.97 5 km WITHDIST ASC COUNT 10
GEOPOS drivers:mumbai "driver_123"</pre>
        </div>`
    },
    'h3': {
        title: 'H3 Hexagonal Indexing',
        content: `<p>Uber's hierarchical geospatial index system.</p>
        <div style="margin-top: 12px;">
            <strong>Resolution Levels:</strong>
            <ul>
                <li>Resolution 7: ~5km hexagons (city zones)</li>
                <li>Resolution 8: ~1km hexagons (neighborhoods)</li>
                <li>Resolution 9: ~200m hexagons (blocks)</li>
            </ul>
            <strong>Use Cases:</strong> Surge pricing zones, heat maps, supply/demand analysis
        </div>`
    },
    'cockroachdb': {
        title: 'CockroachDB',
        content: `<p>Distributed SQL database with automatic sharding and geo-partitioning.</p>
        <div style="margin-top: 12px;">
            <strong>Key Features:</strong>
            <ul>
                <li>SERIALIZABLE isolation</li>
                <li>Automatic rebalancing</li>
                <li>Geo-partitioning for data residency</li>
                <li>PostgreSQL wire protocol</li>
            </ul>
        </div>`
    }
};

function showTooltip(term) {
    const def = termDefinitions[term];
    if (def) {
        document.getElementById('tooltipTitle').textContent = def.title;
        document.getElementById('tooltipContent').innerHTML = def.content;
        document.getElementById('tooltipOverlay').classList.add('show');
        document.getElementById('tooltipPopup').classList.add('show');
    }
}

function closeTooltip() {
    document.getElementById('tooltipOverlay').classList.remove('show');
    document.getElementById('tooltipPopup').classList.remove('show');
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeTooltip(); });

// Scroll spy
window.addEventListener('scroll', function() {
    const sections = document.querySelectorAll('.stage-section');
    const navLinks = document.querySelectorAll('.quick-nav a');
    let current = '';
    sections.forEach(section => {
        if (scrollY >= section.offsetTop - 200) current = section.id;
    });
    navLinks.forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === '#' + current);
    });
});
</script>
