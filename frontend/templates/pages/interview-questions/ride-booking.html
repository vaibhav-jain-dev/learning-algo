<link rel="stylesheet" href="/static/css/interview-questions.css">

<div class="interview-topic-layout">
    <a href="/interview-question" class="back-to-dashboard">← Back to All Topics</a>

    <h1>Ride Booking System Design</h1>
    <p class="topic-description">Design a ride-sharing platform like Uber/Ola with real-time matching, GPS tracking, and surge pricing</p>

    <div class="quick-nav">
        <h4>Navigation</h4>
        <a href="#mvp">MVP Stage</a>
        <a href="#pan-india">PAN-India</a>
        <a href="#high-traffic">High Traffic</a>
        <a href="#global">Global</a>
    </div>

    <!-- ============================================ -->
    <!-- MVP STAGE -->
    <!-- ============================================ -->
    <div class="stage-section" id="mvp">
        <div class="stage-header">
            <span class="stage-badge mvp">MVP Stage</span>
            <h2 style="margin: 0;">Single City - 10K drivers - 50K rides/day</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Request ride with pickup/dropoff</li>
                        <li>Match nearest available driver</li>
                        <li>Real-time trip tracking</li>
                        <li>Fare calculation with distance/time</li>
                        <li>Driver/rider ratings (1-5 stars)</li>
                        <li>Payment processing</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Matching latency: &lt;3 seconds</li>
                        <li>Location update: every 4 seconds</li>
                        <li>Availability: 99.9%</li>
                        <li>Throughput: 1000 rides/hour</li>
                        <li>ETA accuracy: +/- 2 minutes</li>
                        <li>Driver radius: 5km search</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE DIAGRAM -->
        <h3>Architecture</h3>
        <div class="diagram-container">
            <h4>MVP Architecture - Single City</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <!-- Layer 1: Clients -->
                <div style="display: flex; gap: 40px;">
                    <div class="arch-box client">Rider App<br><small>iOS/Android</small></div>
                    <div class="arch-box client">Driver App<br><small>iOS/Android</small></div>
                </div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 2: Load Balancer -->
                <div class="arch-box lb">AWS ALB<br><small>WebSocket + REST</small></div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 3: Services -->
                <div style="display: flex; gap: 20px;">
                    <div class="arch-box server">API Server<br><small>Go/Fiber</small></div>
                    <div class="arch-box server">Location Service<br><small>WebSocket</small></div>
                    <div class="arch-box server">Matching Engine<br><small>Geospatial</small></div>
                </div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 4: Data -->
                <div style="display: flex; gap: 40px; align-items: flex-start;">
                    <div style="text-align: center;">
                        <div class="arch-box cache">Redis GEO<br><small>Driver Locations</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">GEOADD/GEORADIUS<br>4-sec TTL</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box db">PostgreSQL + PostGIS<br><small>db.r5.large</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Rides, Users<br>Multi-AZ</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box queue">Kafka<br><small>Events</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Location stream<br>Analytics</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Ride Request -->
        <h3>Data Flow - Ride Request</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Rider</div>
                    <div class="flow-step-label">POST /ride/request</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">API</div>
                    <div class="flow-step-label">Validate + Create</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box db" style="padding: 10px 16px;">PostgreSQL</div>
                    <div class="flow-step-label">INSERT ride_request</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box queue" style="padding: 10px 16px;">Kafka</div>
                    <div class="flow-step-label">ride.requested event</div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Driver Matching -->
        <h3>Data Flow - Driver Matching</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Matching</div>
                    <div class="flow-step-label">Consume event</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box cache" style="padding: 10px 16px;">Redis GEO</div>
                    <div class="flow-step-label">GEORADIUS 5km</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Score</div>
                    <div class="flow-step-label">Rank by distance+rating</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Driver</div>
                    <div class="flow-step-label">Push notification</div>
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div style="color: #f59e0b; font-weight: 600;">15s timeout:</div>
                <div class="arch-arrow">→</div>
                <div>Cascade to next driver</div>
                <div class="arch-arrow">→</div>
                <div style="color: #ef4444;">After 3 attempts: No drivers available</div>
            </div>
        </div>

        <!-- DATA FLOW - Real-time Tracking -->
        <h3>Data Flow - Real-time Tracking</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Driver GPS</div>
                    <div class="flow-step-label">Every 4 sec</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box cache" style="padding: 10px 16px;">Redis</div>
                    <div class="flow-step-label">GEOADD + PUBLISH</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">WS Server</div>
                    <div class="flow-step-label">Subscribe channel</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Rider App</div>
                    <div class="flow-step-label">Update map marker</div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Fare Calculation -->
        <h3>Data Flow - Fare Calculation</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Driver</div>
                    <div class="flow-step-label">End trip</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Fare Engine</div>
                    <div class="flow-step-label">base + (km*rate) + (min*rate)</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Surge</div>
                    <div class="flow-step-label">Apply multiplier</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box db" style="padding: 10px 16px;">Payment</div>
                    <div class="flow-step-label">Charge rider</div>
                </div>
            </div>
        </div>

        <!-- DATABASE SCHEMA -->
        <h3>Database Schema</h3>
        <div class="diagram-container">
            <h4>PostgreSQL + PostGIS Schema</h4>
            <div class="schema-diagram">
                <div class="schema-table">
                    <div class="schema-table-header">users</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR(255)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">phone</span><span class="field-type">VARCHAR(15) UNIQUE</span></div>
                        <div class="schema-field"><span class="field-name">email</span><span class="field-type">VARCHAR(255)</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>─────</span>
                    <span>1</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">drivers</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK → users.id</span></div>
                        <div class="schema-field"><span class="field-name">vehicle_type</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">vehicle_number</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">rating</span><span class="field-type">DECIMAL(3,2)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(20)</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">ride_requests</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">rider_id</span><span class="field-type">UUID FK → users.id</span></div>
                        <div class="schema-field"><span class="field-name">pickup_location</span><span class="field-type">GEOGRAPHY(POINT)</span></div>
                        <div class="schema-field"><span class="field-name">dropoff_location</span><span class="field-type">GEOGRAPHY(POINT)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">vehicle_type</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>─────</span>
                    <span>1</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">rides</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">request_id</span><span class="field-type">UUID FK → ride_requests.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">driver_id</span><span class="field-type">UUID FK → drivers.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">pickup_time</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">dropoff_time</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">distance_km</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">fare</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">surge_multiplier</span><span class="field-type">DECIMAL(3,2)</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">driver_locations</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">driver_id</span><span class="field-type">UUID PK FK</span></div>
                        <div class="schema-field"><span class="field-name field-idx">location</span><span class="field-type">GEOGRAPHY(POINT)</span></div>
                        <div class="schema-field"><span class="field-name">heading</span><span class="field-type">INTEGER</span></div>
                        <div class="schema-field"><span class="field-name field-idx">is_available</span><span class="field-type">BOOLEAN</span></div>
                        <div class="schema-field"><span class="field-name">updated_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">payments</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">ride_id</span><span class="field-type">UUID FK → rides.id</span></div>
                        <div class="schema-field"><span class="field-name">amount</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">method</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">status</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">ratings</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">ride_id</span><span class="field-type">UUID FK → rides.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">from_user_id</span><span class="field-type">UUID FK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">to_user_id</span><span class="field-type">UUID FK</span></div>
                        <div class="schema-field"><span class="field-name">score</span><span class="field-type">INTEGER (1-5)</span></div>
                        <div class="schema-field"><span class="field-name">comment</span><span class="field-type">TEXT</span></div>
                    </div>
                </div>
            </div>

            <!-- Index Strategy -->
            <div class="index-justification" style="margin-top: 24px;">
                <h5>Index Strategy</h5>
                <table style="width: 100%; font-size: 14px;">
                    <tr>
                        <td><code>idx_driver_locations_geo</code></td>
                        <td>GIST on <code>location</code></td>
                        <td>O(log n) geospatial queries - GEORADIUS equivalent</td>
                    </tr>
                    <tr>
                        <td><code>idx_driver_locations_avail</code></td>
                        <td>B-tree on <code>(is_available, location)</code></td>
                        <td>Filter available drivers before geo query</td>
                    </tr>
                    <tr>
                        <td><code>idx_rides_status</code></td>
                        <td>B-tree on <code>(status, created_at)</code></td>
                        <td>Active rides monitoring dashboard</td>
                    </tr>
                    <tr>
                        <td><code>idx_rides_driver</code></td>
                        <td>B-tree on <code>driver_id</code></td>
                        <td>Driver's ride history and earnings</td>
                    </tr>
                    <tr>
                        <td><code>idx_payments_status</code></td>
                        <td>B-tree on <code>(status, created_at)</code></td>
                        <td>Pending payment reconciliation</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- SQL Queries -->
        <h3>SQL Queries</h3>
        <div class="sql-query">
            <h5>Create Tables with PostGIS</h5>
<pre>CREATE EXTENSION IF NOT EXISTS postgis;

CREATE TABLE users (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name        VARCHAR(255) NOT NULL,
    phone       VARCHAR(15) UNIQUE NOT NULL,
    email       VARCHAR(255),
    created_at  TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE drivers (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID REFERENCES users(id) ON DELETE CASCADE,
    vehicle_type    VARCHAR(20) NOT NULL,  -- 'auto', 'sedan', 'suv'
    vehicle_number  VARCHAR(20) NOT NULL,
    rating          DECIMAL(3,2) DEFAULT 5.0,
    status          VARCHAR(20) DEFAULT 'offline'  -- 'online', 'busy', 'offline'
);

CREATE TABLE driver_locations (
    driver_id    UUID PRIMARY KEY REFERENCES drivers(id),
    location     GEOGRAPHY(POINT, 4326) NOT NULL,
    heading      INTEGER,  -- 0-360 degrees
    is_available BOOLEAN DEFAULT false,
    updated_at   TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_driver_locations_geo ON driver_locations USING GIST(location);
CREATE INDEX idx_driver_locations_avail ON driver_locations(is_available);

CREATE TABLE ride_requests (
    id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    rider_id         UUID REFERENCES users(id),
    pickup_location  GEOGRAPHY(POINT, 4326) NOT NULL,
    dropoff_location GEOGRAPHY(POINT, 4326) NOT NULL,
    status           VARCHAR(20) DEFAULT 'pending',
    vehicle_type     VARCHAR(20) NOT NULL,
    created_at       TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE rides (
    id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    request_id       UUID REFERENCES ride_requests(id),
    driver_id        UUID REFERENCES drivers(id),
    status           VARCHAR(20) DEFAULT 'matched',
    pickup_time      TIMESTAMPTZ,
    dropoff_time     TIMESTAMPTZ,
    distance_km      DECIMAL(10,2),
    fare             DECIMAL(10,2),
    surge_multiplier DECIMAL(3,2) DEFAULT 1.0
);

CREATE INDEX idx_rides_status ON rides(status, created_at DESC);
CREATE INDEX idx_rides_driver ON rides(driver_id);</pre>
        </div>

        <div class="sql-query">
            <h5>Location and Matching Queries</h5>
<pre>-- Find available drivers within 5km radius (PostGIS)
SELECT d.id, d.rating, d.vehicle_type,
       ST_Distance(dl.location, ST_MakePoint($1, $2)::geography) as distance_m
FROM drivers d
JOIN driver_locations dl ON d.id = dl.driver_id
WHERE dl.is_available = true
  AND d.vehicle_type = $3
  AND ST_DWithin(dl.location, ST_MakePoint($1, $2)::geography, 5000)
ORDER BY distance_m ASC
LIMIT 10;

-- Update driver location (called every 4 seconds)
INSERT INTO driver_locations (driver_id, location, heading, is_available, updated_at)
VALUES ($1, ST_MakePoint($2, $3)::geography, $4, $5, NOW())
ON CONFLICT (driver_id)
DO UPDATE SET location = EXCLUDED.location,
              heading = EXCLUDED.heading,
              is_available = EXCLUDED.is_available,
              updated_at = NOW();

-- Get ride with all details
SELECT r.*, rr.pickup_location, rr.dropoff_location,
       u.name as rider_name, u.phone as rider_phone,
       d.vehicle_number, du.name as driver_name
FROM rides r
JOIN ride_requests rr ON r.request_id = rr.id
JOIN users u ON rr.rider_id = u.id
JOIN drivers d ON r.driver_id = d.id
JOIN users du ON d.user_id = du.id
WHERE r.id = $1;</pre>
        </div>

        <!-- API Design -->
        <h3>API Design</h3>
        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/ride/request</span>
<pre>
Request:
{
    "pickup": {"lat": 12.9716, "lng": 77.5946},
    "dropoff": {"lat": 12.9352, "lng": 77.6245},
    "vehicle_type": "sedan"
}

Response: 201 Created
{
    "request_id": "uuid-123",
    "status": "searching",
    "fare_estimate": {"min": 150, "max": 180, "surge": 1.0},
    "eta_minutes": 5
}

Errors:
- 400: Invalid coordinates
- 404: No drivers available
- 429: Rate limit exceeded</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method ws">WS</span> <span class="api-path">/api/v1/ride/:rideId/track</span>
<pre>
// WebSocket for real-time tracking
// Server → Client messages:

{ "type": "driver_location", "lat": 12.9720, "lng": 77.5950, "heading": 45 }
{ "type": "eta_update", "eta_seconds": 180 }
{ "type": "status_change", "status": "arrived", "timestamp": "..." }
{ "type": "trip_started", "timestamp": "..." }
{ "type": "trip_completed", "fare": 165.50, "distance_km": 8.2 }

// Client → Server messages:
{ "type": "ping" }  // Keep-alive every 30s</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/ride/:rideId/complete</span>
<pre>
Request: (Driver app)
{
    "dropoff_location": {"lat": 12.9352, "lng": 77.6245},
    "distance_km": 8.2,
    "duration_minutes": 25
}

Response: 200 OK
{
    "ride_id": "uuid-123",
    "fare": 165.50,
    "breakdown": {
        "base_fare": 50,
        "distance_charge": 82.00,
        "time_charge": 25.00,
        "surge_multiplier": 1.0,
        "taxes": 8.50
    },
    "payment_status": "charged"
}</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/driver/location</span>
<pre>
Request: (Every 4 seconds when driver online)
{
    "lat": 12.9716,
    "lng": 77.5946,
    "heading": 180,
    "is_available": true
}

Response: 200 OK
{ "ack": true }

// Batched internally, written to Redis immediately</pre>
        </div>

        <!-- Database Alternatives -->
        <h3>Database Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>PostgreSQL + PostGIS (Selected)</h5>
                <p>ACID compliance with native geospatial support</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>GIST index for geo queries</li>
                            <li>ST_DWithin for radius search</li>
                            <li>Transactional ride state</li>
                            <li>Proven at Uber's scale</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>High-frequency writes need tuning</li>
                            <li>Geo index rebuild on updates</li>
                            <li>Connection pooling required</li>
                        </ul>
                    </div>
                </div>
                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; font-size: 13px;">
                    <strong>Care:</strong> Use Redis for real-time locations, PostgreSQL for ride state
                </div>
            </div>

            <div class="alternative-card">
                <h5>MongoDB with Geospatial</h5>
                <p>Document store with 2dsphere indexes</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> $geoNear aggregation pipeline<br>
                    <span style="color: #22c55e;">+</span> Flexible schema for ride metadata<br>
                    <span style="color: #ef4444;">-</span> No multi-document transactions (pre-4.0)<br>
                    <span style="color: #ef4444;">-</span> Write concern complexity
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Rapid prototyping, flexible ride metadata
                </div>
            </div>

            <div class="alternative-card">
                <h5>Redis GEO (Hot Path Only)</h5>
                <p>In-memory geospatial with GEORADIUS</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Sub-ms GEORADIUS queries<br>
                    <span style="color: #22c55e;">+</span> Built-in sorted sets<br>
                    <span style="color: #ef4444;">-</span> Not durable (needs backup)<br>
                    <span style="color: #ef4444;">-</span> Memory-bound
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Real-time driver locations (complement to PostgreSQL)
                </div>
            </div>
        </div>

        <!-- Location Alternatives -->
        <h3>Location Index Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>Redis GEO (Selected)</h5>
                <p>In-memory geospatial with sorted sets</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>O(log N) GEORADIUS</li>
                            <li>Sub-ms response</li>
                            <li>WITHDIST, WITHCOORD options</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Memory bound</li>
                            <li>Single-threaded commands</li>
                            <li>No complex filtering</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="alternative-card">
                <h5>H3 Hexagonal Indexing</h5>
                <p>Uber's hierarchical geospatial index</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Consistent cell sizes<br>
                    <span style="color: #22c55e;">+</span> k-ring for neighbors<br>
                    <span style="color: #22c55e;">+</span> Resolution levels (0-15)<br>
                    <span style="color: #ef4444;">-</span> Implementation complexity<br>
                    <span style="color: #ef4444;">-</span> Cell boundary edge cases
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> High scale, surge pricing zones, heat maps
                </div>
            </div>

            <div class="alternative-card">
                <h5>QuadTree / R-Tree</h5>
                <p>Spatial partitioning data structure</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> In-memory efficiency<br>
                    <span style="color: #22c55e;">+</span> Range queries<br>
                    <span style="color: #ef4444;">-</span> Rebalancing on updates<br>
                    <span style="color: #ef4444;">-</span> Custom implementation
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Custom matching engine, in-memory processing
                </div>
            </div>
        </div>

        <!-- Matching Algorithm Alternatives -->
        <h3>Matching Algorithm Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>Greedy Nearest (Selected)</h5>
                <p>Assign closest available driver</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>O(n log n) with geo index</li>
                            <li>Simple to implement</li>
                            <li>Fast match time</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Not globally optimal</li>
                            <li>Can cause driver starvation</li>
                            <li>Ignores future requests</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="alternative-card">
                <h5>Hungarian Algorithm</h5>
                <p>Optimal bipartite matching</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Global optimum<br>
                    <span style="color: #22c55e;">+</span> Minimizes total distance<br>
                    <span style="color: #ef4444;">-</span> O(n^3) complexity<br>
                    <span style="color: #ef4444;">-</span> Requires batching requests
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Batch matching during surge, ride pooling
                </div>
            </div>

            <div class="alternative-card">
                <h5>Batch Matching</h5>
                <p>Collect requests, match in batches</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Better global efficiency<br>
                    <span style="color: #22c55e;">+</span> Enables ride pooling<br>
                    <span style="color: #ef4444;">-</span> Adds latency (2-5s batch window)<br>
                    <span style="color: #ef4444;">-</span> User perceived delay
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> High-density areas, airport queues
                </div>
            </div>
        </div>

        <!-- Design Patterns -->
        <h3>Design Patterns Used</h3>
        <div class="patterns-grid">
            <div class="pattern-card">
                <h5>State Machine Pattern</h5>
                <p>Ride status transitions: requested → matched → driver_arrived → in_progress → completed/cancelled. Enforces valid transitions only.</p>
            </div>
            <div class="pattern-card">
                <h5>Observer Pattern</h5>
                <p>Location updates via Redis Pub/Sub. Driver publishes location, rider's WebSocket subscribes to ride channel for real-time updates.</p>
            </div>
            <div class="pattern-card">
                <h5>Strategy Pattern</h5>
                <p>Matching algorithm selection. GreedyMatcher, HungarianMatcher, BatchMatcher implement IMatcher interface. Switch via config.</p>
            </div>
            <div class="pattern-card">
                <h5>Command Pattern</h5>
                <p>Ride actions as commands: RequestRideCommand, AcceptRideCommand, StartTripCommand. Enables undo, logging, and async processing.</p>
            </div>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">Ride State Machine</h5>
<pre>type RideStatus string

const (
    StatusRequested   RideStatus = "requested"
    StatusMatched     RideStatus = "matched"
    StatusDriverArrived RideStatus = "driver_arrived"
    StatusInProgress  RideStatus = "in_progress"
    StatusCompleted   RideStatus = "completed"
    StatusCancelled   RideStatus = "cancelled"
)

var validTransitions = map[RideStatus][]RideStatus{
    StatusRequested:     {StatusMatched, StatusCancelled},
    StatusMatched:       {StatusDriverArrived, StatusCancelled},
    StatusDriverArrived: {StatusInProgress, StatusCancelled},
    StatusInProgress:    {StatusCompleted},
}

func (r *Ride) CanTransitionTo(newStatus RideStatus) bool {
    allowed, exists := validTransitions[r.Status]
    if !exists { return false }
    for _, s := range allowed {
        if s == newStatus { return true }
    }
    return false
}</pre>
        </div>

        <!-- AWS Cost Estimation -->
        <h3>AWS Cost Estimation (MVP)</h3>
        <div class="feature-card">
            <table class="cost-table">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Spec</th>
                        <th>Monthly Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="cost-tag aws">EC2</span> API Servers (3x)</td>
                        <td>c5.large, 2 vCPU, 4GB</td>
                        <td>$180</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">EC2</span> Location Service (2x)</td>
                        <td>c5.large, WebSocket</td>
                        <td>$120</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">RDS</span> PostgreSQL + PostGIS</td>
                        <td>db.r5.large, Multi-AZ</td>
                        <td>$350</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">ElastiCache</span> Redis</td>
                        <td>cache.r5.large, 13GB</td>
                        <td>$200</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">MSK</span> Kafka</td>
                        <td>kafka.t3.small, 3 brokers</td>
                        <td>$150</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">ALB</span> Load Balancer</td>
                        <td>Application LB + 5M requests</td>
                        <td>$50</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">Lambda</span> Edge (Location)</td>
                        <td>1M invocations/day</td>
                        <td>$30</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">Kinesis</span> Location Stream</td>
                        <td>2 shards</td>
                        <td>$30</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="2"><strong>Total MVP Monthly</strong></td>
                        <td><strong>~$1,110/month</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- K8s Deployment -->
        <h3>Deployment (K8s)</h3>
        <div class="deployment-diagram">
            <h4>Kubernetes Architecture</h4>
            <div class="k8s-cluster">
                <h5>EKS Cluster - ap-south-1</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                    <div class="k8s-pod">api-deployment (replicas: 3)</div>
                    <div class="k8s-pod">matching-deployment (replicas: 2)</div>
                    <div class="k8s-pod">location-deployment (replicas: 2)</div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <div class="k8s-pod" style="background: #7c3aed;">Service: api-svc</div>
                    <div class="k8s-pod" style="background: #7c3aed;">Service: matching-svc</div>
                    <div class="k8s-pod" style="background: #0891b2;">Ingress: ALB</div>
                    <div class="k8s-pod" style="background: #dc2626;">Secret: db-creds</div>
                    <div class="k8s-pod" style="background: #dc2626;">Secret: redis-creds</div>
                </div>
            </div>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">deployment.yaml</h5>
<pre>apiVersion: apps/v1
kind: Deployment
metadata:
  name: ride-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ride-api
  template:
    spec:
      containers:
      - name: api
        image: ride-booking:v1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-creds
              key: url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-creds
              key: url
        resources:
          requests:
            cpu: "500m"
            memory: "512Mi"
          limits:
            cpu: "1000m"
            memory: "1Gi"
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ride-matching
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: matching
        image: ride-matching:v1.0.0
        resources:
          requests:
            cpu: "1000m"
            memory: "1Gi"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ride-location
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: location
        image: ride-location:v1.0.0
        ports:
        - containerPort: 8081  # WebSocket</pre>
        </div>

        <!-- CI/CD Pipeline -->
        <h3>CI/CD Pipeline</h3>
        <div class="diagram-container">
            <h4>GitHub Actions → ECR → EKS</h4>
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 16px;">
                <div class="arch-box client" style="background: #24292e;">Git Push</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box server" style="background: #2088FF;">GitHub Actions</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box storage">ECR</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box gateway">kubectl apply</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box server">EKS</div>
            </div>
            <div style="margin-top: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                <strong>Pipeline Steps:</strong>
                <ol style="font-size: 14px; margin-top: 8px;">
                    <li>Run tests (go test ./... + integration)</li>
                    <li>Build Docker images (api, matching, location)</li>
                    <li>Push to ECR with git SHA tag</li>
                    <li>Update K8s deployments (rolling update)</li>
                    <li>Run smoke tests (request ride, check matching)</li>
                </ol>
            </div>
        </div>

        <!-- Rollback Strategy -->
        <h3>Rollback Strategy</h3>
        <div class="feature-card warning">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4>Instant Rollback</h4>
                    <div class="code-example" style="margin: 12px 0;">
<pre>kubectl rollout undo deployment/ride-api
kubectl rollout undo deployment/ride-matching</pre>
                    </div>
                    <p style="font-size: 14px;">K8s keeps last 10 ReplicaSets. Rollback in &lt;30s.</p>
                </div>
                <div>
                    <h4>Canary for Matching Changes</h4>
                    <ul style="font-size: 14px;">
                        <li>Deploy new matching algorithm to 5% traffic</li>
                        <li>Monitor: match time, driver acceptance rate</li>
                        <li>If degradation: instant rollback via Istio</li>
                        <li>Gradual rollout: 5% → 25% → 50% → 100%</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- PAN-INDIA SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="pan-india">
        <div class="stage-header">
            <span class="stage-badge pan-india">PAN-India Scale</span>
            <h2 style="margin: 0;">Multi-City - 100K drivers - 500K rides/day</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Multi-city operations (50+ cities)</li>
                        <li>Regional pricing and surge</li>
                        <li>City-specific regulations</li>
                        <li>Ride pooling (share rides)</li>
                        <li>Scheduled rides</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Latency: &lt;100ms (regional)</li>
                        <li>Throughput: 10K rides/hour</li>
                        <li>Data locality: city-level</li>
                        <li>Failover: &lt;30s</li>
                    </ul>
                </div>
            </div>
        </div>

        <h3>Architecture Evolution</h3>
        <div class="diagram-container">
            <h4>Multi-Region Architecture</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <div class="arch-box client">Rider/Driver Apps (All India)</div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box cdn">CloudFront<br><small>Static assets + API cache</small></div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box lb">Route 53 (Latency-based)</div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: center;">
                    <div style="text-align: center; padding: 16px; border: 2px dashed #3b82f6; border-radius: 12px;">
                        <strong style="color: #3b82f6;">Mumbai (ap-south-1)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">API (5x)</div>
                            <div class="arch-box server" style="padding: 10px;">Match (3x)</div>
                            <div class="arch-box cache" style="padding: 10px;">Redis</div>
                        </div>
                        <div class="arch-box db" style="margin-top: 12px;">RDS Primary</div>
                        <div style="font-size: 12px; margin-top: 8px;">West + South India</div>
                    </div>
                    <div style="text-align: center; padding: 16px; border: 2px dashed #22c55e; border-radius: 12px;">
                        <strong style="color: #22c55e;">Hyderabad (ap-south-2)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">API (3x)</div>
                            <div class="arch-box server" style="padding: 10px;">Match (2x)</div>
                            <div class="arch-box cache" style="padding: 10px;">Redis</div>
                        </div>
                        <div class="arch-box db" style="margin-top: 12px; opacity: 0.7;">RDS Read Replica</div>
                        <div style="font-size: 12px; margin-top: 8px;">North + East India</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Flow -->
        <h3>Data Flow - Cross-Region</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Delhi User</div>
                    <div class="flow-step-label">Ride request</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box lb" style="padding: 10px 16px;">Route 53</div>
                    <div class="flow-step-label">Latency routing</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Hyderabad API</div>
                    <div class="flow-step-label">Process request</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box cache" style="padding: 10px 16px;">Regional Redis</div>
                    <div class="flow-step-label">Delhi drivers</div>
                </div>
            </div>
        </div>

        <!-- Database Schema Changes -->
        <h3>Database Schema - Regional Sharding</h3>
        <div class="diagram-container">
            <div class="schema-diagram">
                <div class="schema-table">
                    <div class="schema-table-header">cities</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR(100)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">region</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">base_fare</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">per_km_rate</span><span class="field-type">DECIMAL(10,2)</span></div>
                        <div class="schema-field"><span class="field-name">per_min_rate</span><span class="field-type">DECIMAL(10,2)</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>─────</span>
                    <span>N</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">surge_zones</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">city_id</span><span class="field-type">UUID FK → cities.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">h3_index</span><span class="field-type">VARCHAR(20)</span></div>
                        <div class="schema-field"><span class="field-name">demand_count</span><span class="field-type">INTEGER</span></div>
                        <div class="schema-field"><span class="field-name">supply_count</span><span class="field-type">INTEGER</span></div>
                        <div class="schema-field"><span class="field-name">surge_multiplier</span><span class="field-type">DECIMAL(3,2)</span></div>
                        <div class="schema-field"><span class="field-name">updated_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>
            </div>
        </div>

        <h3>What Changes</h3>
        <div class="feature-card">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 30%;"><strong>Regional Databases</strong></td>
                    <td>Each region has its own PostgreSQL. Drivers matched within city only.</td>
                </tr>
                <tr>
                    <td><strong>Redis per Region</strong></td>
                    <td>Driver locations sharded by city. GEORADIUS scoped to city key.</td>
                </tr>
                <tr>
                    <td><strong>Surge by Zone</strong></td>
                    <td>H3 hexagonal cells for surge calculation. Updated every 30 seconds.</td>
                </tr>
                <tr>
                    <td><strong>Central Analytics</strong></td>
                    <td>Replicate to data warehouse (Redshift) for business intelligence.</td>
                </tr>
            </table>
        </div>

        <!-- API Design -->
        <h3>API Design - Regional</h3>
        <div class="api-endpoint">
            <span class="api-method get">GET</span> <span class="api-path">/api/v1/surge/:cityId</span>
<pre>
Response: 200 OK
{
    "city_id": "mumbai",
    "zones": [
        {"h3_index": "8928308280fffff", "surge": 1.5, "demand": 45, "supply": 20},
        {"h3_index": "8928308281fffff", "surge": 1.0, "demand": 12, "supply": 15}
    ],
    "updated_at": "2024-01-15T10:30:00Z"
}</pre>
        </div>

        <h3>Cost at PAN-India Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr>
                    <td>EKS (2 regions, 15 nodes)</td>
                    <td>$2,500</td>
                </tr>
                <tr>
                    <td>RDS Primary + Replica</td>
                    <td>$1,200</td>
                </tr>
                <tr>
                    <td>ElastiCache (2 regions)</td>
                    <td>$600</td>
                </tr>
                <tr>
                    <td>MSK Kafka (2 regions)</td>
                    <td>$500</td>
                </tr>
                <tr>
                    <td>CloudFront + Route 53</td>
                    <td>$300</td>
                </tr>
                <tr>
                    <td>Kinesis (location streaming)</td>
                    <td>$200</td>
                </tr>
                <tr class="total-row">
                    <td><strong>Total</strong></td>
                    <td><strong>~$5,300/month</strong></td>
                </tr>
            </table>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- HIGH TRAFFIC -->
    <!-- ============================================ -->
    <div class="stage-section" id="high-traffic">
        <div class="stage-header">
            <span class="stage-badge high-traffic">High Traffic</span>
            <h2 style="margin: 0;">500K drivers - 2M rides/day - Event Surge</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Handle 10x surge (concerts, NYE)</li>
                        <li>Predictive driver positioning</li>
                        <li>Dynamic pricing with caps</li>
                        <li>Priority queue for premium users</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Throughput: 50K rides/hour</li>
                        <li>Location updates: 10M/minute</li>
                        <li>Match latency: &lt;2s at surge</li>
                        <li>Zero downtime during spikes</li>
                    </ul>
                </div>
            </div>
        </div>

        <h3>What Breaks First</h3>
        <div class="feature-card warning">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 25%;"><strong>1. Location Writes</strong></td>
                    <td>500K drivers × 15 updates/min = 7.5M writes/min</td>
                    <td style="color: #22c55e;"><strong>→ Kinesis stream + batch to Redis</strong></td>
                </tr>
                <tr>
                    <td><strong>2. Matching Service</strong></td>
                    <td>GEORADIUS with millions of keys</td>
                    <td style="color: #22c55e;"><strong>→ City-sharded Redis + H3 pre-indexing</strong></td>
                </tr>
                <tr>
                    <td><strong>3. WebSocket Connections</strong></td>
                    <td>1M concurrent connections</td>
                    <td style="color: #22c55e;"><strong>→ Dedicated WS fleet + sticky sessions</strong></td>
                </tr>
                <tr>
                    <td><strong>4. Database Writes</strong></td>
                    <td>Ride state updates bottleneck</td>
                    <td style="color: #22c55e;"><strong>→ Event sourcing + eventual consistency</strong></td>
                </tr>
            </table>
        </div>

        <h3>Architecture at Scale</h3>
        <div class="diagram-container">
            <h4>High-Traffic Architecture</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                <div style="display: flex; gap: 20px;">
                    <div class="arch-box client">Rider Apps</div>
                    <div class="arch-box client">Driver Apps</div>
                </div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box lb">NLB (Layer 4, millions conn)</div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                    <div class="arch-box server">API (10x)</div>
                    <div class="arch-box server">Matching (5x)</div>
                    <div class="arch-box server">Location WS (10x)</div>
                    <div class="arch-box server">Surge Calculator</div>
                </div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 40px;">
                    <div style="text-align: center;">
                        <div class="arch-box queue">Kinesis<br><small>Location stream</small></div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box cache">Redis Cluster<br><small>32 shards</small></div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box queue">Kafka<br><small>Events</small></div>
                    </div>
                </div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 20px;">
                    <div class="arch-box db">PG Shard 0<br><small>North</small></div>
                    <div class="arch-box db">PG Shard 1<br><small>South</small></div>
                    <div class="arch-box db">PG Shard 2<br><small>East</small></div>
                    <div class="arch-box db">PG Shard 3<br><small>West</small></div>
                </div>
            </div>
        </div>

        <!-- Data Flow - Location at Scale -->
        <h3>Data Flow - Location at Scale</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Driver GPS</div>
                    <div class="flow-step-label">7.5M/min</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box queue" style="padding: 10px 16px;">Kinesis</div>
                    <div class="flow-step-label">Buffer 500ms</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Lambda</div>
                    <div class="flow-step-label">Batch process</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box cache" style="padding: 10px 16px;">Redis Cluster</div>
                    <div class="flow-step-label">GEOADD pipeline</div>
                </div>
            </div>
        </div>

        <!-- Streaming Alternatives -->
        <h3>Streaming Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>Amazon Kinesis (Selected)</h5>
                <p>Managed streaming for location data</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Auto-scaling shards<br>
                    <span style="color: #22c55e;">+</span> Lambda integration<br>
                    <span style="color: #22c55e;">+</span> 7-day retention<br>
                    <span style="color: #ef4444;">-</span> AWS lock-in<br>
                    <span style="color: #ef4444;">-</span> Shard limits (1MB/s write)
                </div>
            </div>

            <div class="alternative-card">
                <h5>Apache Kafka (MSK)</h5>
                <p>High-throughput event streaming</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Higher throughput<br>
                    <span style="color: #22c55e;">+</span> Exactly-once semantics<br>
                    <span style="color: #ef4444;">-</span> Operational complexity<br>
                    <span style="color: #ef4444;">-</span> ZooKeeper management
                </div>
            </div>

            <div class="alternative-card">
                <h5>Apache Pulsar</h5>
                <p>Multi-tenant messaging</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Geo-replication built-in<br>
                    <span style="color: #22c55e;">+</span> Tiered storage<br>
                    <span style="color: #ef4444;">-</span> Less mature ecosystem<br>
                    <span style="color: #ef4444;">-</span> No managed AWS option
                </div>
            </div>
        </div>

        <h3>Cost at High Traffic</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (35 nodes, c5.2xlarge)</td><td>$8,000</td></tr>
                <tr><td>RDS (4 shards, db.r5.2xlarge)</td><td>$6,000</td></tr>
                <tr><td>ElastiCache Cluster (32 nodes)</td><td>$4,000</td></tr>
                <tr><td>Kinesis (50 shards)</td><td>$2,500</td></tr>
                <tr><td>MSK Kafka (12 brokers)</td><td>$3,000</td></tr>
                <tr><td>NLB + Data Transfer</td><td>$2,000</td></tr>
                <tr><td>Lambda (location processing)</td><td>$500</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$26,000/month</strong></td></tr>
            </table>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- GLOBAL SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="global">
        <div class="stage-header">
            <span class="stage-badge global">Global Scale</span>
            <h2 style="margin: 0;">5M drivers - 20M rides/day - 50 countries</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Multi-currency support</li>
                        <li>Local payment methods</li>
                        <li>Regulatory compliance (GDPR, etc.)</li>
                        <li>Multi-language support</li>
                        <li>Cross-border rides</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Global latency: &lt;150ms</li>
                        <li>Availability: 99.99%</li>
                        <li>Data residency compliance</li>
                        <li>Active-active multi-region</li>
                    </ul>
                </div>
            </div>
        </div>

        <h3>Global Architecture</h3>
        <div class="diagram-container">
            <h4>Multi-Region Active-Active</h4>
            <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;">
                <div style="text-align: center; padding: 20px; background: rgba(59,130,246,0.1); border-radius: 12px;">
                    <strong>Americas</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">Redis</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(34,197,94,0.1); border-radius: 12px;">
                    <strong>Europe</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">Redis</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(249,115,22,0.1); border-radius: 12px;">
                    <strong>Asia-Pacific</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">Redis</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(236,72,153,0.1); border-radius: 12px;">
                    <strong>Middle East</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">Redis</div>
                    <div class="arch-box db" style="margin-top: 8px;">CockroachDB</div>
                </div>
            </div>
            <p style="margin-top: 16px;"><strong>CockroachDB:</strong> Distributed SQL with automatic geo-partitioning. Data stays in region for compliance.</p>
        </div>

        <!-- Data Flow -->
        <h3>Data Flow - Global Request</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Paris User</div>
                    <div class="flow-step-label">Ride request</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box cdn" style="padding: 10px 16px;">CloudFront</div>
                    <div class="flow-step-label">Edge POP</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box server" style="padding: 10px 16px;">EU API</div>
                    <div class="flow-step-label">Frankfurt</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box db" style="padding: 10px 16px;">CockroachDB</div>
                    <div class="flow-step-label">EU partition</div>
                </div>
            </div>
        </div>

        <!-- Database Schema - Global -->
        <h3>Database Schema - Geo-Partitioned</h3>
        <div class="sql-query">
            <h5>CockroachDB Geo-Partitioning</h5>
<pre>-- Create table with region column for partitioning
CREATE TABLE rides (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    region STRING NOT NULL,
    rider_id UUID NOT NULL,
    driver_id UUID NOT NULL,
    status STRING NOT NULL,
    fare DECIMAL(10,2),
    currency STRING DEFAULT 'USD',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    INDEX (region, created_at)
) PARTITION BY LIST (region) (
    PARTITION americas VALUES IN ('us-east', 'us-west', 'brazil'),
    PARTITION europe VALUES IN ('eu-west', 'eu-central'),
    PARTITION apac VALUES IN ('ap-south', 'ap-southeast', 'ap-northeast'),
    PARTITION mena VALUES IN ('me-south', 'af-south')
);

-- Pin partitions to regions for data residency
ALTER PARTITION americas OF TABLE rides
    CONFIGURE ZONE USING constraints='[+region=us-east-1]';
ALTER PARTITION europe OF TABLE rides
    CONFIGURE ZONE USING constraints='[+region=eu-central-1]';</pre>
        </div>

        <!-- Scale Metrics -->
        <h3>Scale Metrics</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">5M+</div>
                <div class="label">Active Drivers</div>
            </div>
            <div class="metric">
                <div class="value">20M</div>
                <div class="label">Rides/Day</div>
            </div>
            <div class="metric">
                <div class="value">&lt;2s</div>
                <div class="label">Match Latency</div>
            </div>
            <div class="metric">
                <div class="value">99.99%</div>
                <div class="label">Availability</div>
            </div>
        </div>

        <div class="metrics-card" style="margin-top: 16px;">
            <div class="metric">
                <div class="value">50+</div>
                <div class="label">Countries</div>
            </div>
            <div class="metric">
                <div class="value">100M</div>
                <div class="label">Location Updates/min</div>
            </div>
            <div class="metric">
                <div class="value">1.5-3x</div>
                <div class="label">Surge Range</div>
            </div>
            <div class="metric">
                <div class="value">4</div>
                <div class="label">Active Regions</div>
            </div>
        </div>

        <!-- Design Patterns at Scale -->
        <h3>Design Patterns at Global Scale</h3>
        <div class="patterns-grid">
            <div class="pattern-card">
                <h5>CQRS Pattern</h5>
                <p>Separate read/write models. Writes to CockroachDB, reads from regional Redis + read replicas. Eventual consistency accepted.</p>
            </div>
            <div class="pattern-card">
                <h5>Event Sourcing</h5>
                <p>Ride lifecycle as events: RideRequested, DriverMatched, TripStarted, TripCompleted. Enables replay, audit, analytics.</p>
            </div>
            <div class="pattern-card">
                <h5>Saga Pattern</h5>
                <p>Distributed transaction for ride: Reserve driver → Confirm pickup → Process payment. Compensating actions on failure.</p>
            </div>
            <div class="pattern-card">
                <h5>Circuit Breaker</h5>
                <p>Wrap payment gateway, maps API. If 5 failures in 10s → open circuit → fallback to cached ETA/fare estimate.</p>
            </div>
        </div>

        <!-- K8s at Global -->
        <h3>K8s Deployment - Global</h3>
        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">Multi-Cluster Federation</h5>
<pre>apiVersion: apps/v1
kind: Deployment
metadata:
  name: ride-api
  labels:
    app: ride-api
    region: eu-central
spec:
  replicas: 20
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 0
  template:
    spec:
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
      containers:
      - name: api
        image: ride-booking:v3.0.0
        env:
        - name: REGION
          value: "eu-central"
        - name: COCKROACH_URL
          valueFrom:
            secretKeyRef:
              name: db-creds
              key: url
        resources:
          requests:
            cpu: "2000m"
            memory: "4Gi"
          limits:
            cpu: "4000m"
            memory: "8Gi"
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: ride-api-hpa
spec:
  scaleTargetRef:
    kind: Deployment
    name: ride-api
  minReplicas: 20
  maxReplicas: 100
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 60
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60</pre>
        </div>

        <!-- Rollback at Global -->
        <h3>Rollback Strategy - Global</h3>
        <div class="feature-card warning">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4>Region-by-Region Rollout</h4>
                    <ol style="font-size: 14px;">
                        <li>Deploy to staging (internal traffic)</li>
                        <li>Canary in smallest region (ME)</li>
                        <li>Expand to APAC (off-peak for US/EU)</li>
                        <li>EU during EU morning</li>
                        <li>Americas during Americas morning</li>
                    </ol>
                </div>
                <div>
                    <h4>Instant Region Failover</h4>
                    <div class="code-example" style="margin: 12px 0;">
<pre># Drain region via Route 53
aws route53 change-resource-record-sets \
  --hosted-zone-id Z123 \
  --change-batch file://failover.json</pre>
                    </div>
                    <p style="font-size: 14px;">Traffic shifts to next-nearest region in &lt;60s.</p>
                </div>
            </div>
        </div>

        <!-- Cost at Global -->
        <h3>Cost at Global Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (4 regions, 200 nodes total)</td><td>$50,000</td></tr>
                <tr><td>CockroachDB Cloud (4 regions)</td><td>$40,000</td></tr>
                <tr><td>ElastiCache Global (128 nodes)</td><td>$15,000</td></tr>
                <tr><td>Kinesis (200 shards)</td><td>$10,000</td></tr>
                <tr><td>Kafka/MSK (4 regions)</td><td>$12,000</td></tr>
                <tr><td>CloudFront + Route 53</td><td>$8,000</td></tr>
                <tr><td>Maps API (Google/Mapbox)</td><td>$25,000</td></tr>
                <tr><td>Monitoring (Datadog)</td><td>$10,000</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$170,000/month</strong></td></tr>
            </table>
        </div>
    </div>
</div>

<!-- Tooltip System -->
<div class="tooltip-overlay" id="tooltipOverlay" onclick="closeTooltip()"></div>
<div class="tooltip-popup" id="tooltipPopup">
    <button class="tooltip-close" onclick="closeTooltip()">&times;</button>
    <h4 id="tooltipTitle"></h4>
    <div id="tooltipContent"></div>
</div>

<script>
const termDefinitions = {
    'redis-geo': {
        title: 'Redis GEO Commands',
        content: `<p>Redis geospatial indexing for driver locations.</p>
        <div style="margin-top: 12px;">
            <strong>Key Commands:</strong>
            <pre style="background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; font-size: 13px;">GEOADD drivers:mumbai 77.59 12.97 "driver_123"
GEORADIUS drivers:mumbai 77.59 12.97 5 km WITHDIST ASC COUNT 10
GEOPOS drivers:mumbai "driver_123"</pre>
        </div>`
    },
    'h3': {
        title: 'H3 Hexagonal Indexing',
        content: `<p>Uber's hierarchical geospatial index system.</p>
        <div style="margin-top: 12px;">
            <strong>Resolution Levels:</strong>
            <ul>
                <li>Resolution 7: ~5km hexagons (city zones)</li>
                <li>Resolution 8: ~1km hexagons (neighborhoods)</li>
                <li>Resolution 9: ~200m hexagons (blocks)</li>
            </ul>
            <strong>Use Cases:</strong> Surge pricing zones, heat maps, supply/demand analysis
        </div>`
    },
    'cockroachdb': {
        title: 'CockroachDB',
        content: `<p>Distributed SQL database with automatic sharding and geo-partitioning.</p>
        <div style="margin-top: 12px;">
            <strong>Key Features:</strong>
            <ul>
                <li>SERIALIZABLE isolation</li>
                <li>Automatic rebalancing</li>
                <li>Geo-partitioning for data residency</li>
                <li>PostgreSQL wire protocol</li>
            </ul>
        </div>`
    }
};

function showTooltip(term) {
    const def = termDefinitions[term];
    if (def) {
        document.getElementById('tooltipTitle').textContent = def.title;
        document.getElementById('tooltipContent').innerHTML = def.content;
        document.getElementById('tooltipOverlay').classList.add('show');
        document.getElementById('tooltipPopup').classList.add('show');
    }
}

function closeTooltip() {
    document.getElementById('tooltipOverlay').classList.remove('show');
    document.getElementById('tooltipPopup').classList.remove('show');
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeTooltip(); });

// Scroll spy
window.addEventListener('scroll', function() {
    const sections = document.querySelectorAll('.stage-section');
    const navLinks = document.querySelectorAll('.quick-nav a');
    let current = '';
    sections.forEach(section => {
        if (scrollY >= section.offsetTop - 200) current = section.id;
    });
    navLinks.forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === '#' + current);
    });
});
</script>
