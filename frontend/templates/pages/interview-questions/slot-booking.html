<link rel="stylesheet" href="/static/css/interview-questions.css">

<div class="interview-topic-layout">
    <a href="/interview-question" class="back-to-dashboard">← Back to All Topics</a>

    <h1>Slot Booking System Design</h1>
    <p class="topic-description">Design a slot booking system for appointments, meetings, and resource scheduling with concurrency control</p>

    <div class="quick-nav">
        <h4>Navigation</h4>
        <a href="#mvp">MVP Stage</a>
        <a href="#pan-india">PAN-India</a>
        <a href="#high-traffic">High Traffic</a>
        <a href="#global">Global</a>
    </div>

    <!-- ============================================ -->
    <!-- MVP STAGE -->
    <!-- ============================================ -->
    <div class="stage-section" id="mvp">
        <div class="stage-header">
            <span class="stage-badge mvp">MVP Stage</span>
            <h2 style="margin: 0;">Single Clinic • 5K users • 10 Resources</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>View resource availability by date</li>
                        <li>Book a time slot (single booking)</li>
                        <li>Cancel/reschedule bookings</li>
                        <li>Recurring bookings (weekly/monthly)</li>
                        <li>Waitlist when slot is full</li>
                        <li>Reminders (email, SMS, push)</li>
                        <li>Calendar integration (Google, Outlook)</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Booking latency: &lt;200ms</li>
                        <li>Concurrency: Handle double-booking race</li>
                        <li>Availability: 99.9%</li>
                        <li>Consistency: No double bookings ever</li>
                        <li>Timezone: Store UTC, display local</li>
                        <li>No-show rate target: &lt;5%</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE DIAGRAM -->
        <h3>Architecture</h3>
        <div class="diagram-container">
            <h4>MVP Architecture - Single Clinic</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <!-- Layer 1: Clients -->
                <div style="display: flex; gap: 40px;">
                    <div class="arch-box client">Web App</div>
                    <div class="arch-box client">Mobile App</div>
                    <div class="arch-box client">Admin Portal</div>
                </div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 2: Load Balancer -->
                <div class="arch-box lb">AWS ALB<br><small>Health checks, SSL termination</small></div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 3: API + Services -->
                <div style="display: flex; gap: 20px;">
                    <div class="arch-box server">Booking API<br><small>Node.js/Express</small></div>
                    <div class="arch-box server">Notification Svc<br><small>Reminder worker</small></div>
                </div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 4: Data + Integrations -->
                <div style="display: flex; gap: 40px; align-items: flex-start;">
                    <div style="text-align: center;">
                        <div class="arch-box cache">Redis<br><small>Slot locks + queue</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Reminder queue<br>Distributed locks</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box db">PostgreSQL<br><small>db.t3.medium</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">ACID transactions<br>Optimistic locking</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box gateway">Calendar APIs<br><small>Google, Outlook</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">OAuth 2.0<br>Sync events</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - View Availability -->
        <h3>Data Flow - View Availability</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Client</div>
                    <div class="flow-step-label">GET /availability</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">API</div>
                    <div class="flow-step-label">Query schedule</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box db" style="padding: 10px 16px;">PostgreSQL</div>
                    <div class="flow-step-label">JOIN slots + bookings</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box server" style="padding: 10px 16px;">API</div>
                    <div class="flow-step-label">Generate slots</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Response</div>
                    <div class="flow-step-label">Available slots</div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Book Slot -->
        <h3>Data Flow - Book Slot (with Locking)</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Client</div>
                    <div class="flow-step-label">POST /bookings</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">API</div>
                    <div class="flow-step-label">BEGIN TXN</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box db" style="padding: 10px 16px;">PostgreSQL</div>
                    <div class="flow-step-label">SELECT FOR UPDATE</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box db" style="padding: 10px 16px;">PostgreSQL</div>
                    <div class="flow-step-label">INSERT booking</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box queue" style="padding: 10px 16px;">Redis</div>
                    <div class="flow-step-label">Queue reminder</div>
                </div>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                <strong style="color: #ef4444;">Race Condition:</strong> Two users click "Book" at same time → SELECT FOR UPDATE ensures only one succeeds
            </div>
        </div>

        <!-- DATA FLOW - Cancel Booking -->
        <h3>Data Flow - Cancel Booking</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Client</div>
                    <div class="flow-step-label">DELETE /bookings/:id</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box db" style="padding: 10px 16px;">PostgreSQL</div>
                    <div class="flow-step-label">UPDATE status=cancelled</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box db" style="padding: 10px 16px;">PostgreSQL</div>
                    <div class="flow-step-label">Check waitlist</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box queue" style="padding: 10px 16px;">Redis</div>
                    <div class="flow-step-label">Notify waitlist user</div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Waitlist Promotion -->
        <h3>Data Flow - Waitlist Promotion</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Worker</div>
                    <div class="flow-step-label">Slot cancelled</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box db" style="padding: 10px 16px;">PostgreSQL</div>
                    <div class="flow-step-label">SELECT first waitlist</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box gateway" style="padding: 10px 16px;">SES/Twilio</div>
                    <div class="flow-step-label">Send notification</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box db" style="padding: 10px 16px;">PostgreSQL</div>
                    <div class="flow-step-label">15min hold</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Auto-confirm</div>
                    <div class="flow-step-label">or next in queue</div>
                </div>
            </div>
        </div>

        <!-- DATABASE SCHEMA -->
        <h3>Database Schema</h3>
        <div class="diagram-container">
            <h4>PostgreSQL Schema with Relationships</h4>
            <div class="schema-diagram">
                <div class="schema-table">
                    <div class="schema-table-header">resources</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR(255)</span></div>
                        <div class="schema-field"><span class="field-name">type</span><span class="field-type">ENUM(doctor, room, equipment, service)</span></div>
                        <div class="schema-field"><span class="field-name">timezone</span><span class="field-type">VARCHAR(50)</span></div>
                        <div class="schema-field"><span class="field-name">slot_duration_mins</span><span class="field-type">INT DEFAULT 30</span></div>
                        <div class="schema-field"><span class="field-name">buffer_mins</span><span class="field-type">INT DEFAULT 0</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>─────</span>
                    <span>N</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">schedules</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">resource_id</span><span class="field-type">UUID FK → resources.id</span></div>
                        <div class="schema-field"><span class="field-name">day_of_week</span><span class="field-type">INT (0-6)</span></div>
                        <div class="schema-field"><span class="field-name">start_time</span><span class="field-type">TIME</span></div>
                        <div class="schema-field"><span class="field-name">end_time</span><span class="field-type">TIME</span></div>
                        <div class="schema-field"><span class="field-name">is_active</span><span class="field-type">BOOLEAN DEFAULT true</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">slots</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">resource_id</span><span class="field-type">UUID FK → resources.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">start_time</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">end_time</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM(available, booked, blocked)</span></div>
                        <div class="schema-field"><span class="field-name">version</span><span class="field-type">INT DEFAULT 1</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>─────</span>
                    <span>1</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">bookings</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">slot_id</span><span class="field-type">UUID FK UNIQUE → slots.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK → users.id</span></div>
                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM(pending, confirmed, cancelled, completed, no_show)</span></div>
                        <div class="schema-field"><span class="field-name">confirmation_code</span><span class="field-type">VARCHAR(10) UNIQUE</span></div>
                        <div class="schema-field"><span class="field-name">notes</span><span class="field-type">TEXT</span></div>
                        <div class="schema-field"><span class="field-name field-fk">recurring_id</span><span class="field-type">UUID FK → recurring_patterns.id</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">waitlist</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">slot_id</span><span class="field-type">UUID FK → slots.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK → users.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">position</span><span class="field-type">INT</span></div>
                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM(waiting, notified, expired, converted)</span></div>
                        <div class="schema-field"><span class="field-name">notified_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">expires_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">reminders</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">booking_id</span><span class="field-type">UUID FK → bookings.id</span></div>
                        <div class="schema-field"><span class="field-name">channel</span><span class="field-type">ENUM(email, sms, push)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">scheduled_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">sent_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM(pending, sent, failed)</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">recurring_patterns</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK → users.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">resource_id</span><span class="field-type">UUID FK → resources.id</span></div>
                        <div class="schema-field"><span class="field-name">rrule</span><span class="field-type">VARCHAR(255)</span></div>
                        <div class="schema-field"><span class="field-name">start_date</span><span class="field-type">DATE</span></div>
                        <div class="schema-field"><span class="field-name">end_date</span><span class="field-type">DATE</span></div>
                        <div class="schema-field"><span class="field-name">slot_time</span><span class="field-type">TIME</span></div>
                    </div>
                </div>
            </div>

            <!-- Index Strategy -->
            <div class="index-justification" style="margin-top: 24px;">
                <h5>Index Strategy</h5>
                <table style="width: 100%; font-size: 14px;">
                    <tr>
                        <td><code>idx_slots_resource_time</code></td>
                        <td>B-tree on <code>(resource_id, start_time)</code></td>
                        <td>O(log n) availability lookup by date range</td>
                    </tr>
                    <tr>
                        <td><code>idx_slots_time_range</code></td>
                        <td>B-tree on <code>(start_time, end_time)</code></td>
                        <td>Overlap detection for double-booking prevention</td>
                    </tr>
                    <tr>
                        <td><code>idx_bookings_user</code></td>
                        <td>B-tree on <code>user_id</code></td>
                        <td>User's booking history - "My Appointments"</td>
                    </tr>
                    <tr>
                        <td><code>idx_waitlist_slot_pos</code></td>
                        <td>B-tree on <code>(slot_id, position)</code></td>
                        <td>Fast waitlist position lookup</td>
                    </tr>
                    <tr>
                        <td><code>idx_reminders_scheduled</code></td>
                        <td>B-tree on <code>scheduled_at</code></td>
                        <td>Worker polling for pending reminders</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- SQL Queries -->
        <h3>SQL Queries</h3>
        <div class="sql-query">
            <h5>Create Tables</h5>
<pre>CREATE TYPE resource_type AS ENUM ('doctor', 'room', 'equipment', 'service');
CREATE TYPE slot_status AS ENUM ('available', 'booked', 'blocked');
CREATE TYPE booking_status AS ENUM ('pending', 'confirmed', 'cancelled', 'completed', 'no_show');
CREATE TYPE waitlist_status AS ENUM ('waiting', 'notified', 'expired', 'converted');
CREATE TYPE reminder_channel AS ENUM ('email', 'sms', 'push');

CREATE TABLE resources (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name            VARCHAR(255) NOT NULL,
    type            resource_type NOT NULL,
    timezone        VARCHAR(50) DEFAULT 'UTC',
    slot_duration   INT DEFAULT 30,
    buffer_mins     INT DEFAULT 0,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE slots (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    resource_id     UUID REFERENCES resources(id) ON DELETE CASCADE,
    start_time      TIMESTAMPTZ NOT NULL,
    end_time        TIMESTAMPTZ NOT NULL,
    status          slot_status DEFAULT 'available',
    version         INT DEFAULT 1,
    UNIQUE(resource_id, start_time)
);

CREATE TABLE bookings (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    slot_id             UUID UNIQUE REFERENCES slots(id),
    user_id             UUID NOT NULL,
    status              booking_status DEFAULT 'confirmed',
    confirmation_code   VARCHAR(10) UNIQUE NOT NULL,
    notes               TEXT,
    recurring_id        UUID,
    created_at          TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE waitlist (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    slot_id         UUID REFERENCES slots(id) ON DELETE CASCADE,
    user_id         UUID NOT NULL,
    position        INT NOT NULL,
    status          waitlist_status DEFAULT 'waiting',
    notified_at     TIMESTAMPTZ,
    expires_at      TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(slot_id, user_id)
);

CREATE TABLE reminders (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    booking_id      UUID REFERENCES bookings(id) ON DELETE CASCADE,
    channel         reminder_channel NOT NULL,
    scheduled_at    TIMESTAMPTZ NOT NULL,
    sent_at         TIMESTAMPTZ,
    status          VARCHAR(20) DEFAULT 'pending'
);

-- Time-range indexes for availability queries
CREATE INDEX idx_slots_resource_time ON slots(resource_id, start_time);
CREATE INDEX idx_slots_time_range ON slots(start_time, end_time);
CREATE INDEX idx_bookings_user ON bookings(user_id);
CREATE INDEX idx_waitlist_slot_pos ON waitlist(slot_id, position);
CREATE INDEX idx_reminders_scheduled ON reminders(scheduled_at) WHERE status = 'pending';</pre>
        </div>

        <div class="sql-query">
            <h5>Availability Query</h5>
<pre>-- Get available slots for a resource on a date
SELECT s.id, s.start_time, s.end_time, s.status
FROM slots s
WHERE s.resource_id = $1
  AND s.start_time >= $2::date
  AND s.start_time < ($2::date + INTERVAL '1 day')
  AND s.status = 'available'
ORDER BY s.start_time;</pre>
        </div>

        <div class="sql-query">
            <h5>Booking with SELECT FOR UPDATE (Pessimistic Lock)</h5>
<pre>-- Atomic booking with row-level lock
BEGIN;

-- Lock the slot row to prevent concurrent bookings
SELECT id, status, version FROM slots
WHERE id = $1 AND status = 'available'
FOR UPDATE NOWAIT;  -- Fail immediately if locked

-- If we get here, we have the lock
UPDATE slots SET status = 'booked', version = version + 1
WHERE id = $1;

INSERT INTO bookings (slot_id, user_id, confirmation_code, notes)
VALUES ($1, $2, $3, $4)
RETURNING id, confirmation_code;

-- Schedule reminders
INSERT INTO reminders (booking_id, channel, scheduled_at)
VALUES
    ($booking_id, 'email', $slot_time - INTERVAL '24 hours'),
    ($booking_id, 'sms', $slot_time - INTERVAL '2 hours');

COMMIT;</pre>
        </div>

        <div class="sql-query">
            <h5>Optimistic Locking Alternative</h5>
<pre>-- Book with version check (optimistic locking)
UPDATE slots
SET status = 'booked', version = version + 1
WHERE id = $1
  AND status = 'available'
  AND version = $2  -- Expected version from initial read
RETURNING id;

-- If no rows returned, slot was modified by another transaction
-- → Return error: "Slot no longer available, please try again"</pre>
        </div>

        <div class="sql-query">
            <h5>Waitlist Queries</h5>
<pre>-- Join waitlist
INSERT INTO waitlist (slot_id, user_id, position)
SELECT $1, $2, COALESCE(MAX(position), 0) + 1
FROM waitlist WHERE slot_id = $1 AND status = 'waiting';

-- Get next in waitlist when slot opens
SELECT w.id, w.user_id, u.email, u.phone
FROM waitlist w
JOIN users u ON u.id = w.user_id
WHERE w.slot_id = $1 AND w.status = 'waiting'
ORDER BY w.position
LIMIT 1
FOR UPDATE SKIP LOCKED;

-- Promote waitlist entry (15-min hold)
UPDATE waitlist
SET status = 'notified',
    notified_at = NOW(),
    expires_at = NOW() + INTERVAL '15 minutes'
WHERE id = $1;</pre>
        </div>

        <!-- API Design -->
        <h3>API Design</h3>
        <div class="api-endpoint">
            <span class="api-method get">GET</span> <span class="api-path">/api/v1/resources/:resourceId/availability</span>
<pre>
Query: ?date=2024-01-15&timezone=Asia/Kolkata

Response: 200 OK
{
    "resource_id": "uuid",
    "date": "2024-01-15",
    "timezone": "Asia/Kolkata",
    "slots": [
        { "id": "uuid", "start": "09:00", "end": "09:30", "status": "available" },
        { "id": "uuid", "start": "09:30", "end": "10:00", "status": "booked" },
        { "id": "uuid", "start": "10:00", "end": "10:30", "status": "available", "waitlist_count": 0 }
    ]
}

Errors:
- 400: Invalid date format
- 404: Resource not found</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/bookings</span>
<pre>
Request:
{
    "slot_id": "uuid",
    "notes": "Annual checkup",
    "reminders": ["email", "sms"],
    "calendar_sync": "google"  // optional
}

Response: 201 Created
{
    "booking_id": "uuid",
    "confirmation_code": "ABC123",
    "status": "confirmed",
    "slot": {
        "resource_name": "Dr. Smith",
        "start_time": "2024-01-15T09:00:00Z",
        "end_time": "2024-01-15T09:30:00Z"
    },
    "reminders_scheduled": 2,
    "calendar_event_id": "google_event_123"
}

Errors:
- 409: Slot already booked (concurrent booking)
- 400: Invalid slot_id
- 429: Rate limit exceeded</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method delete">DELETE</span> <span class="api-path">/api/v1/bookings/:bookingId</span>
<pre>
Response: 200 OK
{
    "status": "cancelled",
    "cancellation_time": "2024-01-14T10:00:00Z",
    "refund_eligible": true,
    "waitlist_notified": true
}

Errors:
- 404: Booking not found
- 400: Cannot cancel past booking
- 403: Not your booking</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/slots/:slotId/waitlist</span>
<pre>
Response: 201 Created
{
    "waitlist_id": "uuid",
    "position": 3,
    "estimated_wait": "unlikely",
    "notification_preference": "email"
}

Errors:
- 400: Slot is available (no need for waitlist)
- 409: Already on waitlist</pre>
        </div>

        <!-- CONCURRENCY CONTROL ALTERNATIVES -->
        <h3>Concurrency Control Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>Optimistic Locking (Selected)</h5>
                <p>Version column check at update time</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>No lock held during user think time</li>
                            <li>Higher throughput for reads</li>
                            <li>Simple implementation</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Retry needed on conflict</li>
                            <li>Starvation possible under high contention</li>
                        </ul>
                    </div>
                </div>
                <div style="background: #eff6ff; padding: 10px; border-radius: 6px; font-size: 13px;">
                    <strong>When to use:</strong> Low-medium contention (typical booking scenarios)
                </div>
            </div>

            <div class="alternative-card">
                <h5>Pessimistic Locking</h5>
                <p>SELECT FOR UPDATE row-level lock</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Guaranteed success if lock acquired<br>
                    <span style="color: #22c55e;">+</span> No retry logic needed<br>
                    <span style="color: #ef4444;">-</span> Blocks other transactions<br>
                    <span style="color: #ef4444;">-</span> Deadlock risk with multiple rows
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> High contention, flash-sale scenarios
                </div>
            </div>

            <div class="alternative-card">
                <h5>Redis Distributed Lock</h5>
                <p>SETNX with TTL before DB operation</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Works across multiple DB instances<br>
                    <span style="color: #22c55e;">+</span> Sub-ms lock acquisition<br>
                    <span style="color: #ef4444;">-</span> Redis as SPOF<br>
                    <span style="color: #ef4444;">-</span> Lock expiry edge cases
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Distributed systems, sharded DBs
                </div>
            </div>
        </div>

        <!-- DATABASE ALTERNATIVES -->
        <h3>Database Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>PostgreSQL (Selected)</h5>
                <p>ACID compliance, robust locking primitives</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>SELECT FOR UPDATE, SKIP LOCKED</li>
                            <li>TIMESTAMPTZ for timezones</li>
                            <li>Range types for availability</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Single-node write limit</li>
                            <li>Complex sharding</li>
                        </ul>
                    </div>
                </div>
                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; font-size: 13px;">
                    <strong>Care:</strong> Use connection pooling (PgBouncer). Set lock_timeout = 5s
                </div>
            </div>

            <div class="alternative-card">
                <h5>MongoDB</h5>
                <p>Document model, findAndModify atomic ops</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Flexible schema for slot metadata<br>
                    <span style="color: #22c55e;">+</span> Native sharding<br>
                    <span style="color: #ef4444;">-</span> No multi-document ACID (pre-4.0)<br>
                    <span style="color: #ef4444;">-</span> Weaker consistency guarantees
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Variable slot attributes per resource type
                </div>
            </div>

            <div class="alternative-card">
                <h5>DynamoDB</h5>
                <p>Serverless, conditional writes</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Auto-scaling, zero ops<br>
                    <span style="color: #22c55e;">+</span> Conditional expressions for locking<br>
                    <span style="color: #ef4444;">-</span> No joins (denormalize)<br>
                    <span style="color: #ef4444;">-</span> Hot partition on popular resources
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Serverless stack, simple access patterns
                </div>
            </div>
        </div>

        <!-- QUEUE ALTERNATIVES -->
        <h3>Queue Alternatives (Reminders)</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>Redis (Selected)</h5>
                <p>Sorted sets for scheduled reminders</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>ZRANGEBYSCORE for due reminders</li>
                            <li>Already using for locks</li>
                            <li>Sub-ms latency</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Memory-bound</li>
                            <li>Persistence config needed</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="alternative-card">
                <h5>Amazon SQS</h5>
                <p>Managed queue with delay support</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Zero ops, auto-scaling<br>
                    <span style="color: #22c55e;">+</span> DelaySeconds up to 15 min<br>
                    <span style="color: #ef4444;">-</span> Max 15 min delay (need scheduler)<br>
                    <span style="color: #ef4444;">-</span> At-least-once (handle duplicates)
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> AWS-native, with EventBridge for scheduling
                </div>
            </div>

            <div class="alternative-card">
                <h5>Apache Kafka</h5>
                <p>Event streaming, replay capability</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Event sourcing for bookings<br>
                    <span style="color: #22c55e;">+</span> Replay failed reminders<br>
                    <span style="color: #ef4444;">-</span> Overkill for simple reminders<br>
                    <span style="color: #ef4444;">-</span> No native delay queues
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Event-driven architecture, audit trail needed
                </div>
            </div>
        </div>

        <!-- DESIGN PATTERNS -->
        <h3>Design Patterns Used</h3>
        <div class="patterns-grid">
            <div class="pattern-card">
                <h5>Repository Pattern</h5>
                <p>Abstract slot/booking persistence. SlotRepository, BookingRepository interfaces. Swap PostgreSQL for DynamoDB without service changes.</p>
            </div>
            <div class="pattern-card">
                <h5>Unit of Work Pattern</h5>
                <p>Wrap booking + reminder creation in single transaction. Commit or rollback together. Ensures consistency.</p>
            </div>
            <div class="pattern-card">
                <h5>Observer Pattern</h5>
                <p>BookingCreated event triggers: send confirmation email, sync to Google Calendar, add to analytics. Decoupled handlers.</p>
            </div>
            <div class="pattern-card">
                <h5>State Pattern</h5>
                <p>Booking status transitions: pending → confirmed → completed/cancelled/no_show. Each state has allowed transitions and actions.</p>
            </div>
        </div>

        <!-- CONCURRENCY DEEP DIVE -->
        <h3>Concurrency Deep Dive</h3>
        <div class="diagram-container">
            <h4>Race Condition Scenario</h4>
            <div style="display: flex; flex-direction: column; gap: 12px; font-family: monospace; font-size: 14px;">
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr 150px; gap: 12px; align-items: center;">
                    <div style="font-weight: bold;">Time</div>
                    <div style="font-weight: bold; color: #3b82f6;">User A</div>
                    <div style="font-weight: bold; color: #22c55e;">User B</div>
                    <div style="font-weight: bold;">Slot Status</div>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr 150px; gap: 12px; align-items: center; padding: 8px; background: rgba(59,130,246,0.1); border-radius: 6px;">
                    <div>T1</div>
                    <div style="color: #3b82f6;">SELECT slot (available)</div>
                    <div></div>
                    <div><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px;">available</span></div>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr 150px; gap: 12px; align-items: center; padding: 8px; background: rgba(34,197,94,0.1); border-radius: 6px;">
                    <div>T2</div>
                    <div></div>
                    <div style="color: #22c55e;">SELECT slot (available)</div>
                    <div><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px;">available</span></div>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr 150px; gap: 12px; align-items: center; padding: 8px; background: rgba(59,130,246,0.1); border-radius: 6px;">
                    <div>T3</div>
                    <div style="color: #3b82f6;">UPDATE status=booked</div>
                    <div></div>
                    <div><span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px;">booked</span></div>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr 150px; gap: 12px; align-items: center; padding: 8px; background: rgba(239,68,68,0.1); border-radius: 6px;">
                    <div>T4</div>
                    <div></div>
                    <div style="color: #ef4444;">UPDATE status=booked (DOUBLE BOOKING!)</div>
                    <div><span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px;">CONFLICT</span></div>
                </div>
            </div>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">Solution: Version Column (Optimistic Lock)</h5>
<pre>// Read slot with version
const slot = await db.query(
    'SELECT id, status, version FROM slots WHERE id = $1',
    [slotId]
);

if (slot.status !== 'available') {
    return { error: 'SLOT_TAKEN' };
}

// Update with version check - atomic operation
const result = await db.query(`
    UPDATE slots
    SET status = 'booked', version = version + 1
    WHERE id = $1 AND version = $2
    RETURNING id`,
    [slotId, slot.version]
);

if (result.rowCount === 0) {
    // Another transaction modified the slot
    return { error: 'CONCURRENT_MODIFICATION' };
}

// Success - slot is now booked by this user</pre>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">Redis Distributed Lock - Lua Script</h5>
<pre>-- Atomic lock acquisition with Lua
local key = KEYS[1]
local token = ARGV[1]
local ttl = ARGV[2]

-- Only set if not exists
if redis.call('exists', key) == 0 then
    redis.call('set', key, token, 'PX', ttl)
    return 1
end
return 0

-- Usage in Node.js:
const lockKey = `slot_lock:${slotId}`;
const token = crypto.randomUUID();
const acquired = await redis.eval(lockScript, 1, lockKey, token, 30000);

if (!acquired) {
    return { error: 'SLOT_BEING_BOOKED' };
}

try {
    await bookSlotInDatabase(slotId, userId);
} finally {
    // Only release if we own the lock
    await redis.eval(`
        if redis.call('get', KEYS[1]) == ARGV[1] then
            return redis.call('del', KEYS[1])
        end
        return 0
    `, 1, lockKey, token);
}</pre>
        </div>

        <!-- AWS COST ESTIMATION -->
        <h3>AWS Cost Estimation (MVP)</h3>
        <div class="feature-card">
            <table class="cost-table">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Spec</th>
                        <th>Monthly Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="cost-tag aws">EC2</span> API Server (2x)</td>
                        <td>t3.medium, 2 vCPU, 4GB</td>
                        <td>$60</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">RDS</span> PostgreSQL</td>
                        <td>db.t3.medium, Multi-AZ, 50GB</td>
                        <td>$140</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">ElastiCache</span> Redis</td>
                        <td>cache.t3.small, 1.5GB</td>
                        <td>$25</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">Lambda</span> Reminder Worker</td>
                        <td>1M invocations, 256MB</td>
                        <td>$5</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">SES</span> Email Reminders</td>
                        <td>50K emails/month</td>
                        <td>$5</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">SNS</span> SMS Reminders</td>
                        <td>10K SMS/month (India)</td>
                        <td>$20</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">ALB</span> Load Balancer</td>
                        <td>Application LB</td>
                        <td>$25</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="2"><strong>Total MVP Monthly</strong></td>
                        <td><strong>~$280/month</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- K8s DEPLOYMENT -->
        <h3>Deployment (K8s)</h3>
        <div class="deployment-diagram">
            <h4>Kubernetes Architecture</h4>
            <div class="k8s-cluster">
                <h5>EKS Cluster - ap-south-1</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                    <div class="k8s-pod">api-deployment (replicas: 2)</div>
                    <div class="k8s-pod">reminder-worker (replicas: 1)</div>
                    <div class="k8s-pod">api-hpa (min:2, max:10)</div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <div class="k8s-pod" style="background: #7c3aed;">Service: ClusterIP</div>
                    <div class="k8s-pod" style="background: #0891b2;">Ingress: ALB</div>
                    <div class="k8s-pod" style="background: #dc2626;">Secret: db-creds</div>
                    <div class="k8s-pod" style="background: #ea580c;">CronJob: slot-generator</div>
                </div>
            </div>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">deployment.yaml (API + Reminder Worker)</h5>
<pre>apiVersion: apps/v1
kind: Deployment
metadata:
  name: booking-api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: booking-api
  template:
    spec:
      containers:
      - name: api
        image: booking-api:v1.0.0
        ports:
        - containerPort: 3000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-creds
              key: url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-creds
              key: url
        resources:
          requests:
            cpu: "250m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        readinessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reminder-worker
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reminder-worker
  template:
    spec:
      containers:
      - name: worker
        image: booking-api:v1.0.0
        command: ["node", "worker/reminder.js"]
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-creds
              key: url
        - name: SES_REGION
          value: "ap-south-1"
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: booking-api-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: booking-api
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70</pre>
        </div>

        <!-- CI/CD -->
        <h3>CI/CD Pipeline</h3>
        <div class="diagram-container">
            <h4>GitHub Actions to EKS</h4>
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 16px;">
                <div class="arch-box client" style="background: #24292e;">Git Push</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box server" style="background: #2088FF;">GitHub Actions</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box storage">ECR</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box gateway">kubectl apply</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box server">EKS</div>
            </div>
            <div style="margin-top: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                <strong>Pipeline Steps:</strong>
                <ol style="font-size: 14px; margin-top: 8px;">
                    <li>Run tests (npm test, jest --coverage)</li>
                    <li>Lint and type check (eslint, tsc)</li>
                    <li>Build Docker image with git SHA tag</li>
                    <li>Push to ECR</li>
                    <li>Update K8s deployment (rolling update)</li>
                    <li>Run integration tests against staging</li>
                    <li>Notify Slack on success/failure</li>
                </ol>
            </div>
        </div>

        <!-- ROLLBACK STRATEGY -->
        <h3>Rollback Strategy</h3>
        <div class="feature-card warning">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4>Instant Rollback</h4>
                    <div class="code-example" style="margin: 12px 0;">
<pre>kubectl rollout undo deployment/booking-api</pre>
                    </div>
                    <p style="font-size: 14px;">K8s keeps last 10 ReplicaSets. Rollback in &lt;30s.</p>
                </div>
                <div>
                    <h4>Feature Flags for Booking Rules</h4>
                    <ul style="font-size: 14px;">
                        <li><code>enable_waitlist</code>: Toggle waitlist feature</li>
                        <li><code>enable_recurring</code>: Toggle recurring bookings</li>
                        <li><code>max_advance_days</code>: How far ahead can book</li>
                        <li><code>cancellation_window_hrs</code>: Min hours before slot</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Feature Additions -->
        <h3>Feature Addition: Recurring Bookings</h3>
        <div class="feature-card addition">
            <h4>RRULE Format (iCal Standard)</h4>
            <div class="code-example">
<pre>// Weekly on Monday and Wednesday until end of year
RRULE:FREQ=WEEKLY;BYDAY=MO,WE;UNTIL=20241231T235959Z

// Every 2 weeks on Friday, 10 occurrences
RRULE:FREQ=WEEKLY;INTERVAL=2;BYDAY=FR;COUNT=10

// Monthly on the 15th
RRULE:FREQ=MONTHLY;BYMONTHDAY=15

// Node.js: Use rrule library to expand dates
const rule = RRule.fromString(rruleStr);
const dates = rule.between(startDate, endDate);</pre>
            </div>
        </div>

        <h3>Feature Addition: Calendar Integration</h3>
        <div class="feature-card addition">
            <h4>Google Calendar Sync</h4>
            <ul>
                <li>OAuth 2.0 consent flow</li>
                <li>On booking: Create event via Calendar API</li>
                <li>On cancel: Delete event via Calendar API</li>
                <li>Store event_id in bookings table for updates</li>
            </ul>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- PAN-INDIA SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="pan-india">
        <div class="stage-header">
            <span class="stage-badge pan-india">PAN-India Scale</span>
            <h2 style="margin: 0;">Multi-tenant SaaS • 10K Clinics • 1M Users</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Multi-tenant isolation</li>
                        <li>Tenant-specific configurations</li>
                        <li>Cross-clinic booking (same chain)</li>
                        <li>Analytics dashboard per tenant</li>
                        <li>Bulk slot management</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Tenant data isolation: 100%</li>
                        <li>Multi-timezone support (IST, UTC)</li>
                        <li>99.95% availability</li>
                        <li>Horizontal scaling per region</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE -->
        <h3>Architecture Evolution</h3>
        <div class="diagram-container">
            <h4>Multi-Tenant Architecture</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <div class="arch-box client">Users (All India)</div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box cdn">CloudFront CDN<br><small>Static assets, API caching</small></div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box lb">Route 53 (Latency-based)</div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: center;">
                    <div style="text-align: center; padding: 16px; border: 2px dashed #3b82f6; border-radius: 12px;">
                        <strong style="color: #3b82f6;">Mumbai (ap-south-1)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">API (4x)</div>
                            <div class="arch-box server" style="padding: 10px;">Worker (2x)</div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box cache" style="padding: 10px;">Redis Cluster</div>
                        </div>
                        <div class="arch-box db" style="margin-top: 12px;">RDS Primary</div>
                    </div>
                    <div style="text-align: center; padding: 16px; border: 2px dashed #22c55e; border-radius: 12px;">
                        <strong style="color: #22c55e;">Hyderabad (ap-south-2)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">API (2x)</div>
                            <div class="arch-box server" style="padding: 10px;">Worker (1x)</div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box cache" style="padding: 10px;">Redis Replica</div>
                        </div>
                        <div class="arch-box db" style="margin-top: 12px; opacity: 0.7;">RDS Read Replica</div>
                    </div>
                </div>
            </div>
        </div>

        <h3>Multi-tenancy Strategy</h3>
        <div class="feature-card">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 30%;"><strong>Tenant Identification</strong></td>
                    <td>Subdomain (apollo.booking.com) or X-Tenant-ID header</td>
                </tr>
                <tr>
                    <td><strong>Data Isolation</strong></td>
                    <td>Row-level: tenant_id column on all tables + RLS policies</td>
                </tr>
                <tr>
                    <td><strong>Schema per Tenant</strong></td>
                    <td>Alternative: tenant_apollo.slots (better isolation, harder migrations)</td>
                </tr>
                <tr>
                    <td><strong>Timezone Handling</strong></td>
                    <td>Store all times in UTC. Display in tenant's configured timezone</td>
                </tr>
            </table>
        </div>

        <div class="sql-query">
            <h5>Row-Level Security for Multi-tenancy</h5>
<pre>-- Enable RLS
ALTER TABLE slots ENABLE ROW LEVEL SECURITY;

-- Policy: Tenants can only see their own data
CREATE POLICY tenant_isolation ON slots
    USING (tenant_id = current_setting('app.current_tenant')::uuid);

-- Set tenant context at connection start
SET app.current_tenant = 'tenant-uuid-here';</pre>
        </div>

        <!-- COST -->
        <h3>Cost at PAN-India Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr>
                    <td>EKS (6 nodes across 2 regions)</td>
                    <td>$450</td>
                </tr>
                <tr>
                    <td>RDS Primary + Read Replica</td>
                    <td>$500</td>
                </tr>
                <tr>
                    <td>ElastiCache (2 clusters)</td>
                    <td>$150</td>
                </tr>
                <tr>
                    <td>Lambda (Reminders, 10M invocations)</td>
                    <td>$50</td>
                </tr>
                <tr>
                    <td>SES + SNS (Notifications)</td>
                    <td>$200</td>
                </tr>
                <tr>
                    <td>Route 53 + CloudFront</td>
                    <td>$100</td>
                </tr>
                <tr class="total-row">
                    <td><strong>Total</strong></td>
                    <td><strong>~$1,450/month</strong></td>
                </tr>
            </table>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- HIGH TRAFFIC -->
    <!-- ============================================ -->
    <div class="stage-section" id="high-traffic">
        <div class="stage-header">
            <span class="stage-badge high-traffic">High Traffic</span>
            <h2 style="margin: 0;">Flash Sale Scenario • 100K concurrent users</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Virtual waiting room</li>
                        <li>Fair slot distribution</li>
                        <li>Reservation hold (5-min checkout)</li>
                        <li>Rate limiting per user</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Handle 10K booking requests/second</li>
                        <li>Zero double bookings under load</li>
                        <li>Graceful degradation</li>
                        <li>Queue position updates (real-time)</li>
                    </ul>
                </div>
            </div>
        </div>

        <h3>What Breaks First</h3>
        <div class="feature-card warning">
            <p><strong>Scenario:</strong> Celebrity doctor releases 50 slots at 10 AM. 100,000 users try to book simultaneously.</p>
            <table style="width: 100%; font-size: 15px; margin-top: 12px;">
                <tr>
                    <td style="width: 25%;"><strong>1. DB Lock Contention</strong></td>
                    <td>All requests trying to lock same slot rows</td>
                    <td style="color: #22c55e;"><strong>→ Pre-lock in Redis, then DB</strong></td>
                </tr>
                <tr>
                    <td><strong>2. Thundering Herd</strong></td>
                    <td>All users refresh availability at same time</td>
                    <td style="color: #22c55e;"><strong>→ Cache with stale-while-revalidate</strong></td>
                </tr>
                <tr>
                    <td><strong>3. Unfair Distribution</strong></td>
                    <td>Fastest clickers/bots win all slots</td>
                    <td style="color: #22c55e;"><strong>→ Virtual queue with random assignment</strong></td>
                </tr>
                <tr>
                    <td><strong>4. Connection Pool</strong></td>
                    <td>DB connections exhausted</td>
                    <td style="color: #22c55e;"><strong>→ PgBouncer transaction pooling</strong></td>
                </tr>
            </table>
        </div>

        <!-- ARCHITECTURE -->
        <h3>Architecture at Scale</h3>
        <div class="diagram-container">
            <h4>High-Traffic Architecture with Virtual Queue</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                <div class="arch-box client">100K Concurrent Users</div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box cdn">CloudFront + WAF<br><small>Rate limiting, DDoS protection</small></div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box gateway">Virtual Queue<br><small>Redis Sorted Set</small></div>
                <div class="arch-arrow">↓ (batch of 100)</div>
                <div class="arch-box lb">NLB (Layer 4)</div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 12px;">
                    <div class="arch-box server">API Pod 1</div>
                    <div class="arch-box server">API Pod 2</div>
                    <div class="arch-box server">...</div>
                    <div class="arch-box server">API Pod 20</div>
                </div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 40px;">
                    <div class="arch-box cache">Redis Cluster<br><small>Slot locks + queue</small></div>
                    <div class="arch-box db">PostgreSQL<br><small>With PgBouncer</small></div>
                </div>
            </div>
        </div>

        <h3>Virtual Waiting Room</h3>
        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">Redis-based Queue Implementation</h5>
<pre>// User enters queue
const position = await redis.zadd('queue:slot:123', Date.now(), `user:${userId}`);

// WebSocket: Send position updates
const rank = await redis.zrank('queue:slot:123', `user:${userId}`);
ws.send({ type: 'queue_position', position: rank + 1 });

// Worker: Process queue in batches
async function processQueue(slotId) {
    // Get next 10 users
    const users = await redis.zpopmin(`queue:slot:${slotId}`, 10);

    for (const userId of users) {
        // Give each user 5 minutes to complete booking
        await redis.setex(`reservation:${slotId}:${userId}`, 300, 'held');
        await notifyUser(userId, 'Your turn to book!');
    }
}</pre>
        </div>

        <h3>Slot Reservation with Timeout</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">User's Turn</div>
                    <div class="flow-step-label">From queue</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box cache" style="padding: 10px 16px;">Redis</div>
                    <div class="flow-step-label">SETEX reservation 5min</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Checkout UI</div>
                    <div class="flow-step-label">5:00 countdown</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box db" style="padding: 10px 16px;">Confirm</div>
                    <div class="flow-step-label">Or release slot</div>
                </div>
            </div>
        </div>

        <!-- COST -->
        <h3>Cost at High Traffic</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (20 nodes, c5.xlarge)</td><td>$2,500</td></tr>
                <tr><td>RDS (db.r5.xlarge + replicas)</td><td>$1,800</td></tr>
                <tr><td>ElastiCache Cluster (16 nodes)</td><td>$2,000</td></tr>
                <tr><td>CloudFront + WAF</td><td>$1,500</td></tr>
                <tr><td>Lambda + SQS (notifications)</td><td>$300</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$8,100/month</strong></td></tr>
            </table>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- GLOBAL SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="global">
        <div class="stage-header">
            <span class="stage-badge global">Global Scale</span>
            <h2 style="margin: 0;">International SaaS • 50M Users • 200 Countries</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Multi-timezone scheduling</li>
                        <li>Regional holiday calendars</li>
                        <li>Multi-currency payments</li>
                        <li>Localized notifications (i18n)</li>
                        <li>Cross-border booking (telemedicine)</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Latency: &lt;100ms globally</li>
                        <li>Availability: 99.99%</li>
                        <li>HIPAA (US), GDPR (EU) compliance</li>
                        <li>Data residency (regional DBs)</li>
                        <li>Active-active multi-region</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE -->
        <h3>Global Architecture</h3>
        <div class="diagram-container">
            <h4>Multi-Region Active-Active</h4>
            <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;">
                <div style="text-align: center; padding: 20px; background: rgba(59,130,246,0.1); border-radius: 12px;">
                    <strong>US-East (Virginia)</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">ElastiCache</div>
                    <div class="arch-box db" style="margin-top: 8px;">Aurora Global</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 8px;">HIPAA compliant</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(34,197,94,0.1); border-radius: 12px;">
                    <strong>EU-West (Frankfurt)</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">ElastiCache</div>
                    <div class="arch-box db" style="margin-top: 8px;">Aurora Global</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 8px;">GDPR compliant</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(249,115,22,0.1); border-radius: 12px;">
                    <strong>Asia-Pacific (Mumbai)</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">ElastiCache</div>
                    <div class="arch-box db" style="margin-top: 8px;">Aurora Global</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Data residency</div>
                </div>
            </div>
            <p style="margin-top: 16px;"><strong>Aurora Global Database:</strong> &lt;1 second cross-region replication. Write to nearest primary, read locally.</p>
        </div>

        <h3>Global Considerations</h3>
        <div class="feature-card">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 25%;"><strong>Timezone Handling</strong></td>
                    <td>Store UTC + IANA timezone (America/New_York). Display in user's local time. Handle DST transitions.</td>
                </tr>
                <tr>
                    <td><strong>Conflict Resolution</strong></td>
                    <td>Last-write-wins with vector clocks. Booking conflicts resolved by timestamp (UTC).</td>
                </tr>
                <tr>
                    <td><strong>Data Residency</strong></td>
                    <td>EU users' PII stays in Frankfurt. Route by user's country at API gateway.</td>
                </tr>
                <tr>
                    <td><strong>Compliance</strong></td>
                    <td>Audit logs, encryption at rest (KMS), access controls, data retention policies.</td>
                </tr>
            </table>
        </div>

        <!-- SCALE METRICS -->
        <h3>Scale Metrics</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">10M+</div>
                <div class="label">Bookings/month</div>
            </div>
            <div class="metric">
                <div class="value">&lt;0.01%</div>
                <div class="label">Double-booking Rate</div>
            </div>
            <div class="metric">
                <div class="value">&lt;3%</div>
                <div class="label">No-show Rate</div>
            </div>
            <div class="metric">
                <div class="value">99.99%</div>
                <div class="label">Availability</div>
            </div>
        </div>

        <!-- COST -->
        <h3>Cost at Global Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (3 regions, 50 nodes total)</td><td>$12,000</td></tr>
                <tr><td>Aurora Global (3 regions)</td><td>$15,000</td></tr>
                <tr><td>ElastiCache Global</td><td>$6,000</td></tr>
                <tr><td>CloudFront (Global CDN)</td><td>$8,000</td></tr>
                <tr><td>Lambda + SQS + SNS (Notifications)</td><td>$2,000</td></tr>
                <tr><td>Monitoring (Datadog)</td><td>$3,000</td></tr>
                <tr><td>Compliance (Auditing, Encryption)</td><td>$2,000</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$48,000/month</strong></td></tr>
            </table>
        </div>
    </div>
</div>

<!-- Tooltip System -->
<div class="tooltip-overlay" id="tooltipOverlay" onclick="closeTooltip()"></div>
<div class="tooltip-popup" id="tooltipPopup">
    <button class="tooltip-close" onclick="closeTooltip()">&times;</button>
    <h4 id="tooltipTitle"></h4>
    <div id="tooltipContent"></div>
</div>

<script>
const termDefinitions = {
    'optimistic-lock': {
        title: 'Optimistic Locking',
        content: `<p>A concurrency control method that allows multiple transactions to proceed without locking, checking for conflicts only at commit time.</p>
        <div style="margin-top: 12px;">
            <strong>How it works:</strong>
            <ol style="margin: 8px 0; padding-left: 20px; font-size: 14px;">
                <li>Read row with version number</li>
                <li>Perform business logic</li>
                <li>UPDATE ... WHERE version = expected_version</li>
                <li>If 0 rows affected → conflict, retry</li>
            </ol>
        </div>`
    },
    'pessimistic-lock': {
        title: 'Pessimistic Locking',
        content: `<p>Locks the row immediately when read, preventing other transactions from modifying it.</p>
        <div style="margin-top: 12px;">
            <strong>SQL:</strong>
            <pre style="background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; font-size: 13px;">SELECT * FROM slots WHERE id = $1 FOR UPDATE;</pre>
        </div>`
    }
};

function showTooltip(term) {
    const def = termDefinitions[term];
    if (def) {
        document.getElementById('tooltipTitle').textContent = def.title;
        document.getElementById('tooltipContent').innerHTML = def.content;
        document.getElementById('tooltipOverlay').classList.add('show');
        document.getElementById('tooltipPopup').classList.add('show');
    }
}

function closeTooltip() {
    document.getElementById('tooltipOverlay').classList.remove('show');
    document.getElementById('tooltipPopup').classList.remove('show');
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeTooltip(); });

// Scroll spy
window.addEventListener('scroll', function() {
    const sections = document.querySelectorAll('.stage-section');
    const navLinks = document.querySelectorAll('.quick-nav a');
    let current = '';
    sections.forEach(section => {
        if (scrollY >= section.offsetTop - 200) current = section.id;
    });
    navLinks.forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === '#' + current);
    });
});
</script>
