<link rel="stylesheet" href="/static/css/interview-questions.css">

<div class="interview-topic-layout">
    <a href="/interview-question" class="back-to-dashboard">← Back to All Topics</a>

    <h1>Slot Booking System Design</h1>
    <p class="topic-description">Design a slot booking system for appointments, meetings, and resource scheduling with concurrency control</p>

    <div class="quick-nav">
        <h4>Navigation</h4>
        <a href="#mvp">MVP Stage</a>
        <a href="#pan-india">PAN-India</a>
        <a href="#high-traffic">High Traffic</a>
        <a href="#global">Global</a>
    </div>

    <!-- ============================================ -->
    <!-- MVP STAGE -->
    <!-- ============================================ -->
    <div class="stage-section" id="mvp">
        <div class="stage-header">
            <span class="stage-badge mvp">MVP Stage</span>
            <h2 style="margin: 0;">Single Clinic • 5K users • 10 Resources</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>View resource availability by date</li>
                        <li>Book a time slot (single booking)</li>
                        <li>Cancel/reschedule bookings</li>
                        <li>Recurring bookings (weekly/monthly)</li>
                        <li>Waitlist when slot is full</li>
                        <li>Reminders (email, SMS, push)</li>
                        <li>Calendar integration (Google, Outlook)</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Booking latency: &lt;200ms</li>
                        <li>Concurrency: Handle double-booking race</li>
                        <li>Availability: 99.9%</li>
                        <li>Consistency: No double bookings ever</li>
                        <li>Timezone: Store UTC, display local</li>
                        <li>No-show rate target: &lt;5%</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE DIAGRAM -->
        <h3>Architecture</h3>
        <div class="diagram-container">
            <h4>MVP Architecture - Single Clinic</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <!-- Layer 1: Clients -->
                <div style="display: flex; gap: 40px;">
                    <div class="arch-box client">Web App</div>
                    <div class="arch-box client">Mobile App</div>
                    <div class="arch-box client">Admin Portal</div>
                </div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 2: Load Balancer -->
                <div class="arch-box lb">AWS ALB<br><small>Health checks, SSL termination</small></div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 3: API + Services -->
                <div style="display: flex; gap: 20px;">
                    <div class="arch-box server">Booking API<br><small>Node.js/Express</small></div>
                    <div class="arch-box server">Notification Svc<br><small>Reminder worker</small></div>
                </div>
                <div class="arch-arrow">↓</div>

                <!-- Layer 4: Data + Integrations -->
                <div style="display: flex; gap: 40px; align-items: flex-start;">
                    <div style="text-align: center;">
                        <div class="arch-box cache"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a><br><small>Slot locks + queue</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Reminder queue<br>Distributed locks</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a><br><small>db.t3.medium</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">ACID transactions<br>Optimistic locking</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="arch-box gateway">Calendar APIs<br><small>Google, Outlook</small></div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 8px;">OAuth 2.0<br>Sync events</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - View Availability -->
        <h3>Data Flow - View Availability</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Client</div>
                    <div class="flow-step-label">GET /availability</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">API</div>
                    <div class="flow-step-label">Query schedule</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box db" style="padding: 10px 16px;"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">JOIN slots + bookings</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box server" style="padding: 10px 16px;">API</div>
                    <div class="flow-step-label">Generate slots</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Response</div>
                    <div class="flow-step-label">Available slots</div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Book Slot -->
        <h3>Data Flow - Book Slot (with Locking)</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Client</div>
                    <div class="flow-step-label">POST /bookings</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box server" style="padding: 10px 16px;">API</div>
                    <div class="flow-step-label">BEGIN TXN</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box db" style="padding: 10px 16px;"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">SELECT FOR UPDATE</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box db" style="padding: 10px 16px;"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">INSERT booking</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box queue" style="padding: 10px 16px;"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">Queue reminder</div>
                </div>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                <strong style="color: #ef4444;">Race Condition:</strong> Two users click "Book" at same time → SELECT FOR UPDATE ensures only one succeeds
            </div>
        </div>

        <!-- DATA FLOW - Cancel Booking -->
        <h3>Data Flow - Cancel Booking</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Client</div>
                    <div class="flow-step-label">DELETE /bookings/:id</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box db" style="padding: 10px 16px;"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">UPDATE status=cancelled</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box db" style="padding: 10px 16px;"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">Check waitlist</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box queue" style="padding: 10px 16px;"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">Notify waitlist user</div>
                </div>
            </div>
        </div>

        <!-- DATA FLOW - Waitlist Promotion -->
        <h3>Data Flow - Waitlist Promotion</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Worker</div>
                    <div class="flow-step-label">Slot cancelled</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box db" style="padding: 10px 16px;"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">SELECT first waitlist</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box gateway" style="padding: 10px 16px;">SES/Twilio</div>
                    <div class="flow-step-label">Send notification</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box db" style="padding: 10px 16px;"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">15min hold</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div class="arch-box server" style="padding: 10px 16px;">Auto-confirm</div>
                    <div class="flow-step-label">or next in queue</div>
                </div>
            </div>
        </div>

        <!-- DATABASE SCHEMA -->
        <h3>Database Schema</h3>
        <div class="diagram-container">
            <h4><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> Schema with Relationships</h4>
            <div class="schema-diagram">
                <div class="schema-table">
                    <div class="schema-table-header">resources</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR(255)</span></div>
                        <div class="schema-field"><span class="field-name">type</span><span class="field-type">ENUM(doctor, room, equipment, service)</span></div>
                        <div class="schema-field"><span class="field-name">timezone</span><span class="field-type">VARCHAR(50)</span></div>
                        <div class="schema-field"><span class="field-name">slot_duration_mins</span><span class="field-type">INT DEFAULT 30</span></div>
                        <div class="schema-field"><span class="field-name">buffer_mins</span><span class="field-type">INT DEFAULT 0</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>─────</span>
                    <span>N</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">schedules</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">resource_id</span><span class="field-type">UUID FK → resources.id</span></div>
                        <div class="schema-field"><span class="field-name">day_of_week</span><span class="field-type">INT (0-6)</span></div>
                        <div class="schema-field"><span class="field-name">start_time</span><span class="field-type">TIME</span></div>
                        <div class="schema-field"><span class="field-name">end_time</span><span class="field-type">TIME</span></div>
                        <div class="schema-field"><span class="field-name">is_active</span><span class="field-type">BOOLEAN DEFAULT true</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">slots</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">resource_id</span><span class="field-type">UUID FK → resources.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">start_time</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">end_time</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM(available, booked, blocked)</span></div>
                        <div class="schema-field"><span class="field-name">version</span><span class="field-type">INT DEFAULT 1</span></div>
                    </div>
                </div>

                <div class="relation-arrow">
                    <span>1</span>
                    <span>─────</span>
                    <span>1</span>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">bookings</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">slot_id</span><span class="field-type">UUID FK UNIQUE → slots.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK → users.id</span></div>
                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM(pending, confirmed, cancelled, completed, no_show)</span></div>
                        <div class="schema-field"><span class="field-name">confirmation_code</span><span class="field-type">VARCHAR(10) UNIQUE</span></div>
                        <div class="schema-field"><span class="field-name">notes</span><span class="field-type">TEXT</span></div>
                        <div class="schema-field"><span class="field-name field-fk">recurring_id</span><span class="field-type">UUID FK → recurring_patterns.id</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">waitlist</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">slot_id</span><span class="field-type">UUID FK → slots.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK → users.id</span></div>
                        <div class="schema-field"><span class="field-name field-idx">position</span><span class="field-type">INT</span></div>
                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM(waiting, notified, expired, converted)</span></div>
                        <div class="schema-field"><span class="field-name">notified_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">expires_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                    </div>
                </div>

                <div class="schema-table">
                    <div class="schema-table-header">reminders</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">booking_id</span><span class="field-type">UUID FK → bookings.id</span></div>
                        <div class="schema-field"><span class="field-name">channel</span><span class="field-type">ENUM(email, sms, push)</span></div>
                        <div class="schema-field"><span class="field-name field-idx">scheduled_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">sent_at</span><span class="field-type">TIMESTAMPTZ</span></div>
                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM(pending, sent, failed)</span></div>
                    </div>
                </div>
            </div>

            <div class="schema-diagram" style="margin-top: 24px;">
                <div class="schema-table">
                    <div class="schema-table-header">recurring_patterns</div>
                    <div class="schema-table-body">
                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK → users.id</span></div>
                        <div class="schema-field"><span class="field-name field-fk">resource_id</span><span class="field-type">UUID FK → resources.id</span></div>
                        <div class="schema-field"><span class="field-name">rrule</span><span class="field-type">VARCHAR(255)</span></div>
                        <div class="schema-field"><span class="field-name">start_date</span><span class="field-type">DATE</span></div>
                        <div class="schema-field"><span class="field-name">end_date</span><span class="field-type">DATE</span></div>
                        <div class="schema-field"><span class="field-name">slot_time</span><span class="field-type">TIME</span></div>
                    </div>
                </div>
            </div>

            <!-- Index Strategy -->
            <div class="index-justification" style="margin-top: 24px;">
                <h5>Index Strategy</h5>
                <table style="width: 100%; font-size: 14px;">
                    <tr>
                        <td><code>idx_slots_resource_time</code></td>
                        <td>B-tree on <code>(resource_id, start_time)</code></td>
                        <td>O(log n) availability lookup by date range</td>
                    </tr>
                    <tr>
                        <td><code>idx_slots_time_range</code></td>
                        <td>B-tree on <code>(start_time, end_time)</code></td>
                        <td>Overlap detection for double-booking prevention</td>
                    </tr>
                    <tr>
                        <td><code>idx_bookings_user</code></td>
                        <td>B-tree on <code>user_id</code></td>
                        <td>User's booking history - "My Appointments"</td>
                    </tr>
                    <tr>
                        <td><code>idx_waitlist_slot_pos</code></td>
                        <td>B-tree on <code>(slot_id, position)</code></td>
                        <td>Fast waitlist position lookup</td>
                    </tr>
                    <tr>
                        <td><code>idx_reminders_scheduled</code></td>
                        <td>B-tree on <code>scheduled_at</code></td>
                        <td>Worker polling for pending reminders</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- SQL Queries -->
        <h3>SQL Queries</h3>
        <div class="sql-query">
            <h5>Create Tables</h5>
<pre>CREATE TYPE resource_type AS ENUM ('doctor', 'room', 'equipment', 'service');
CREATE TYPE slot_status AS ENUM ('available', 'booked', 'blocked');
CREATE TYPE booking_status AS ENUM ('pending', 'confirmed', 'cancelled', 'completed', 'no_show');
CREATE TYPE waitlist_status AS ENUM ('waiting', 'notified', 'expired', 'converted');
CREATE TYPE reminder_channel AS ENUM ('email', 'sms', 'push');

CREATE TABLE resources (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name            VARCHAR(255) NOT NULL,
    type            resource_type NOT NULL,
    timezone        VARCHAR(50) DEFAULT 'UTC',
    slot_duration   INT DEFAULT 30,
    buffer_mins     INT DEFAULT 0,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE slots (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    resource_id     UUID REFERENCES resources(id) ON DELETE CASCADE,
    start_time      TIMESTAMPTZ NOT NULL,
    end_time        TIMESTAMPTZ NOT NULL,
    status          slot_status DEFAULT 'available',
    version         INT DEFAULT 1,
    UNIQUE(resource_id, start_time)
);

CREATE TABLE bookings (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    slot_id             UUID UNIQUE REFERENCES slots(id),
    user_id             UUID NOT NULL,
    status              booking_status DEFAULT 'confirmed',
    confirmation_code   VARCHAR(10) UNIQUE NOT NULL,
    notes               TEXT,
    recurring_id        UUID,
    created_at          TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE waitlist (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    slot_id         UUID REFERENCES slots(id) ON DELETE CASCADE,
    user_id         UUID NOT NULL,
    position        INT NOT NULL,
    status          waitlist_status DEFAULT 'waiting',
    notified_at     TIMESTAMPTZ,
    expires_at      TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(slot_id, user_id)
);

CREATE TABLE reminders (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    booking_id      UUID REFERENCES bookings(id) ON DELETE CASCADE,
    channel         reminder_channel NOT NULL,
    scheduled_at    TIMESTAMPTZ NOT NULL,
    sent_at         TIMESTAMPTZ,
    status          VARCHAR(20) DEFAULT 'pending'
);

-- Time-range indexes for availability queries
CREATE INDEX idx_slots_resource_time ON slots(resource_id, start_time);
CREATE INDEX idx_slots_time_range ON slots(start_time, end_time);
CREATE INDEX idx_bookings_user ON bookings(user_id);
CREATE INDEX idx_waitlist_slot_pos ON waitlist(slot_id, position);
CREATE INDEX idx_reminders_scheduled ON reminders(scheduled_at) WHERE status = 'pending';</pre>
        </div>

        <div class="sql-query">
            <h5>Availability Query</h5>
<pre>-- Get available slots for a resource on a date
SELECT s.id, s.start_time, s.end_time, s.status
FROM slots s
WHERE s.resource_id = $1
  AND s.start_time >= $2::date
  AND s.start_time < ($2::date + INTERVAL '1 day')
  AND s.status = 'available'
ORDER BY s.start_time;</pre>
        </div>

        <div class="sql-query">
            <h5>Booking with SELECT FOR UPDATE (Pessimistic Lock)</h5>
<pre>-- Atomic booking with row-level lock
BEGIN;

-- Lock the slot row to prevent concurrent bookings
SELECT id, status, version FROM slots
WHERE id = $1 AND status = 'available'
FOR UPDATE NOWAIT;  -- Fail immediately if locked

-- If we get here, we have the lock
UPDATE slots SET status = 'booked', version = version + 1
WHERE id = $1;

INSERT INTO bookings (slot_id, user_id, confirmation_code, notes)
VALUES ($1, $2, $3, $4)
RETURNING id, confirmation_code;

-- Schedule reminders
INSERT INTO reminders (booking_id, channel, scheduled_at)
VALUES
    ($booking_id, 'email', $slot_time - INTERVAL '24 hours'),
    ($booking_id, 'sms', $slot_time - INTERVAL '2 hours');

COMMIT;</pre>
        </div>

        <div class="sql-query">
            <h5>Optimistic Locking Alternative</h5>
<pre>-- Book with version check (optimistic locking)
UPDATE slots
SET status = 'booked', version = version + 1
WHERE id = $1
  AND status = 'available'
  AND version = $2  -- Expected version from initial read
RETURNING id;

-- If no rows returned, slot was modified by another transaction
-- → Return error: "Slot no longer available, please try again"</pre>
        </div>

        <div class="sql-query">
            <h5>Waitlist Queries</h5>
<pre>-- Join waitlist
INSERT INTO waitlist (slot_id, user_id, position)
SELECT $1, $2, COALESCE(MAX(position), 0) + 1
FROM waitlist WHERE slot_id = $1 AND status = 'waiting';

-- Get next in waitlist when slot opens
SELECT w.id, w.user_id, u.email, u.phone
FROM waitlist w
JOIN users u ON u.id = w.user_id
WHERE w.slot_id = $1 AND w.status = 'waiting'
ORDER BY w.position
LIMIT 1
FOR UPDATE SKIP LOCKED;

-- Promote waitlist entry (15-min hold)
UPDATE waitlist
SET status = 'notified',
    notified_at = NOW(),
    expires_at = NOW() + INTERVAL '15 minutes'
WHERE id = $1;</pre>
        </div>

        <!-- API Design -->
        <h3>API Design</h3>
        <div class="api-endpoint">
            <span class="api-method get">GET</span> <span class="api-path">/api/v1/resources/:resourceId/availability</span>
<pre>
Query: ?date=2024-01-15&timezone=Asia/Kolkata

Response: 200 OK
{
    <span class="json-key">"resource_id"</span>: <span class="json-string">"uuid"</span>,
    <span class="json-key">"date"</span>: <span class="json-string">"2024-01-15"</span>,
    <span class="json-key">"timezone"</span>: <span class="json-string">"Asia/Kolkata"</span>,
    <span class="json-key">"slots"</span>: [
        { <span class="json-key">"id"</span>: <span class="json-string">"uuid"</span>, <span class="json-key">"start"</span>: <span class="json-string">"09:00"</span>, <span class="json-key">"end"</span>: <span class="json-string">"09:30"</span>, <span class="json-key">"status"</span>: <span class="json-string">"available"</span> },
        { <span class="json-key">"id"</span>: <span class="json-string">"uuid"</span>, <span class="json-key">"start"</span>: <span class="json-string">"09:30"</span>, <span class="json-key">"end"</span>: <span class="json-string">"10:00"</span>, <span class="json-key">"status"</span>: <span class="json-string">"booked"</span> },
        { <span class="json-key">"id"</span>: <span class="json-string">"uuid"</span>, <span class="json-key">"start"</span>: <span class="json-string">"10:00"</span>, <span class="json-key">"end"</span>: <span class="json-string">"10:30"</span>, <span class="json-key">"status"</span>: <span class="json-string">"available"</span>, <span class="json-key">"waitlist_count"</span>: <span class="json-number">0</span> }
    ]
}

Errors:
- 400: Invalid date format
- 404: Resource not found</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/bookings</span>
<pre>
Request:
{
    <span class="json-key">"slot_id"</span>: <span class="json-string">"uuid"</span>,
    <span class="json-key">"notes"</span>: <span class="json-string">"Annual checkup"</span>,
    <span class="json-key">"reminders"</span>: [<span class="json-string">"email"</span>, <span class="json-string">"sms"</span>],
    <span class="json-key">"calendar_sync"</span>: <span class="json-string">"google"</span>  <span class="json-comment">// optional</span>
}

Response: 201 Created
{
    <span class="json-key">"booking_id"</span>: <span class="json-string">"uuid"</span>,
    <span class="json-key">"confirmation_code"</span>: <span class="json-string">"ABC123"</span>,
    <span class="json-key">"status"</span>: <span class="json-string">"confirmed"</span>,
    <span class="json-key">"slot"</span>: {
        <span class="json-key">"resource_name"</span>: <span class="json-string">"Dr. Smith"</span>,
        <span class="json-key">"start_time"</span>: <span class="json-string">"2024-01-15T09:00:00Z"</span>,
        <span class="json-key">"end_time"</span>: <span class="json-string">"2024-01-15T09:30:00Z"</span>
    },
    <span class="json-key">"reminders_scheduled"</span>: <span class="json-number">2</span>,
    <span class="json-key">"calendar_event_id"</span>: <span class="json-string">"google_event_123"</span>
}

Errors:
- 409: Slot already booked (concurrent booking)
- 400: Invalid slot_id
- 429: Rate limit exceeded</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method delete">DELETE</span> <span class="api-path">/api/v1/bookings/:bookingId</span>
<pre>
Response: 200 OK
{
    <span class="json-key">"status"</span>: <span class="json-string">"cancelled"</span>,
    <span class="json-key">"cancellation_time"</span>: <span class="json-string">"2024-01-14T10:00:00Z"</span>,
    <span class="json-key">"refund_eligible"</span>: <span class="json-boolean">true</span>,
    <span class="json-key">"waitlist_notified"</span>: <span class="json-boolean">true</span>
}

Errors:
- 404: Booking not found
- 400: Cannot cancel past booking
- 403: Not your booking</pre>
        </div>

        <div class="api-endpoint">
            <span class="api-method post">POST</span> <span class="api-path">/api/v1/slots/:slotId/waitlist</span>
<pre>
Response: 201 Created
{
    <span class="json-key">"waitlist_id"</span>: <span class="json-string">"uuid"</span>,
    <span class="json-key">"position"</span>: <span class="json-number">3</span>,
    <span class="json-key">"estimated_wait"</span>: <span class="json-string">"unlikely"</span>,
    <span class="json-key">"notification_preference"</span>: <span class="json-string">"email"</span>
}

Errors:
- 400: Slot is available (no need for waitlist)
- 409: Already on waitlist</pre>
        </div>

        <!-- CONCURRENCY CONTROL ALTERNATIVES -->
        <h3>Concurrency Control Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5>Optimistic Locking (Selected)</h5>
                <p>Version column check at update time</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>No lock held during user think time</li>
                            <li>Higher throughput for reads</li>
                            <li>Simple implementation</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Retry needed on conflict</li>
                            <li>Starvation possible under high contention</li>
                        </ul>
                    </div>
                </div>
                <div style="background: #eff6ff; padding: 10px; border-radius: 6px; font-size: 13px;">
                    <strong>When to use:</strong> Low-medium contention (typical booking scenarios)
                </div>
            </div>

            <div class="alternative-card">
                <h5>Pessimistic Locking</h5>
                <p>SELECT FOR UPDATE row-level lock</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Guaranteed success if lock acquired<br>
                    <span style="color: #22c55e;">+</span> No retry logic needed<br>
                    <span style="color: #ef4444;">-</span> Blocks other transactions<br>
                    <span style="color: #ef4444;">-</span> Deadlock risk with multiple rows
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> High contention, flash-sale scenarios
                </div>
            </div>

            <div class="alternative-card">
                <h5><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Distributed Lock</h5>
                <p>SETNX with TTL before DB operation</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Works across multiple DB instances<br>
                    <span style="color: #22c55e;">+</span> Sub-ms lock acquisition<br>
                    <span style="color: #ef4444;">-</span> <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> as SPOF<br>
                    <span style="color: #ef4444;">-</span> Lock expiry edge cases
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Distributed systems, sharded DBs
                </div>
            </div>
        </div>

        <!-- DATABASE ALTERNATIVES -->
        <h3>Database Alternatives</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> (Selected)</h5>
                <p>ACID compliance, robust locking primitives</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>SELECT FOR UPDATE, SKIP LOCKED</li>
                            <li>TIMESTAMPTZ for timezones</li>
                            <li>Range types for availability</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Single-node write limit</li>
                            <li>Complex sharding</li>
                        </ul>
                    </div>
                </div>
                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; font-size: 13px;">
                    <strong>Care:</strong> Use connection pooling (PgBouncer). Set lock_timeout = 5s
                </div>
            </div>

            <div class="alternative-card">
                <h5>MongoDB</h5>
                <p>Document model, findAndModify atomic ops</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Flexible schema for slot metadata<br>
                    <span style="color: #22c55e;">+</span> Native sharding<br>
                    <span style="color: #ef4444;">-</span> No multi-document ACID (pre-4.0)<br>
                    <span style="color: #ef4444;">-</span> Weaker consistency guarantees
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Variable slot attributes per resource type
                </div>
            </div>

            <div class="alternative-card">
                <h5>DynamoDB</h5>
                <p>Serverless, conditional writes</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Auto-scaling, zero ops<br>
                    <span style="color: #22c55e;">+</span> Conditional expressions for locking<br>
                    <span style="color: #ef4444;">-</span> No joins (denormalize)<br>
                    <span style="color: #ef4444;">-</span> Hot partition on popular resources
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Serverless stack, simple access patterns
                </div>
            </div>
        </div>

        <!-- QUEUE ALTERNATIVES -->
        <h3>Queue Alternatives (Reminders)</h3>
        <div class="alternatives-grid">
            <div class="alternative-card selected">
                <h5><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> (Selected)</h5>
                <p>Sorted sets for scheduled reminders</p>
                <div class="pros-cons-grid" style="margin: 12px 0;">
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <strong style="color: #166534;">Pros:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>ZRANGEBYSCORE for due reminders</li>
                            <li>Already using for locks</li>
                            <li>Sub-ms latency</li>
                        </ul>
                    </div>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                        <strong style="color: #991b1b;">Cons:</strong>
                        <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 13px;">
                            <li>Memory-bound</li>
                            <li>Persistence config needed</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="alternative-card">
                <h5>Amazon SQS</h5>
                <p>Managed queue with delay support</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Zero ops, auto-scaling<br>
                    <span style="color: #22c55e;">+</span> DelaySeconds up to 15 min<br>
                    <span style="color: #ef4444;">-</span> Max 15 min delay (need scheduler)<br>
                    <span style="color: #ef4444;">-</span> At-least-once (handle duplicates)
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> AWS-native, with EventBridge for scheduling
                </div>
            </div>

            <div class="alternative-card">
                <h5>Apache <a href="/interview-question/glossary#kafka" class="info-term">Kafka<span class="info-i">i</span></a></h5>
                <p>Event streaming, replay capability</p>
                <div style="font-size: 13px; margin-top: 8px;">
                    <span style="color: #22c55e;">+</span> Event sourcing for bookings<br>
                    <span style="color: #22c55e;">+</span> Replay failed reminders<br>
                    <span style="color: #ef4444;">-</span> Overkill for simple reminders<br>
                    <span style="color: #ef4444;">-</span> No native delay queues
                </div>
                <div style="background: #eff6ff; padding: 8px; border-radius: 6px; font-size: 12px; margin-top: 8px;">
                    <strong>When to use:</strong> Event-driven architecture, audit trail needed
                </div>
            </div>
        </div>

        <!-- DESIGN PATTERNS -->
        <h3>Design Patterns Used</h3>
        <div class="patterns-grid">
            <div class="pattern-card">
                <h5>Repository Pattern</h5>
                <p>Abstract slot/booking persistence. SlotRepository, BookingRepository interfaces. Swap <a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> for DynamoDB without service changes.</p>
            </div>
            <div class="pattern-card">
                <h5>Unit of Work Pattern</h5>
                <p>Wrap booking + reminder creation in single transaction. Commit or rollback together. Ensures consistency.</p>
            </div>
            <div class="pattern-card">
                <h5>Observer Pattern</h5>
                <p>BookingCreated event triggers: send confirmation email, sync to Google Calendar, add to analytics. Decoupled handlers.</p>
            </div>
            <div class="pattern-card">
                <h5>State Pattern</h5>
                <p>Booking status transitions: pending → confirmed → completed/cancelled/no_show. Each state has allowed transitions and actions.</p>
            </div>
        </div>

        <!-- CONCURRENCY DEEP DIVE -->
        <h3>Concurrency Deep Dive</h3>
        <div class="diagram-container">
            <h4>Race Condition Scenario</h4>
            <div style="display: flex; flex-direction: column; gap: 12px; font-family: monospace; font-size: 14px;">
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr 150px; gap: 12px; align-items: center;">
                    <div style="font-weight: bold;">Time</div>
                    <div style="font-weight: bold; color: #3b82f6;">User A</div>
                    <div style="font-weight: bold; color: #22c55e;">User B</div>
                    <div style="font-weight: bold;">Slot Status</div>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr 150px; gap: 12px; align-items: center; padding: 8px; background: rgba(59,130,246,0.1); border-radius: 6px;">
                    <div>T1</div>
                    <div style="color: #3b82f6;">SELECT slot (available)</div>
                    <div></div>
                    <div><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px;">available</span></div>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr 150px; gap: 12px; align-items: center; padding: 8px; background: rgba(34,197,94,0.1); border-radius: 6px;">
                    <div>T2</div>
                    <div></div>
                    <div style="color: #22c55e;">SELECT slot (available)</div>
                    <div><span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px;">available</span></div>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr 150px; gap: 12px; align-items: center; padding: 8px; background: rgba(59,130,246,0.1); border-radius: 6px;">
                    <div>T3</div>
                    <div style="color: #3b82f6;">UPDATE status=booked</div>
                    <div></div>
                    <div><span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 4px;">booked</span></div>
                </div>
                <div style="display: grid; grid-template-columns: 100px 1fr 1fr 150px; gap: 12px; align-items: center; padding: 8px; background: rgba(239,68,68,0.1); border-radius: 6px;">
                    <div>T4</div>
                    <div></div>
                    <div style="color: #ef4444;">UPDATE status=booked (DOUBLE BOOKING!)</div>
                    <div><span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px;">CONFLICT</span></div>
                </div>
            </div>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">Solution: Version Column (Optimistic Lock)</h5>
<pre>// Read slot with version
const slot = await db.query(
    'SELECT id, status, version FROM slots WHERE id = $1',
    [slotId]
);

if (slot.status !== 'available') {
    return { error: 'SLOT_TAKEN' };
}

// Update with version check - atomic operation
const result = await db.query(`
    UPDATE slots
    SET status = 'booked', version = version + 1
    WHERE id = $1 AND version = $2
    RETURNING id`,
    [slotId, slot.version]
);

if (result.rowCount === 0) {
    // Another transaction modified the slot
    return { error: 'CONCURRENT_MODIFICATION' };
}

// Success - slot is now booked by this user</pre>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Distributed Lock - Lua Script</h5>
<pre>-- Atomic lock acquisition with Lua
local key = KEYS[1]
local token = ARGV[1]
local ttl = ARGV[2]

-- Only set if not exists
if redis.call('exists', key) == 0 then
    redis.call('set', key, token, 'PX', ttl)
    return 1
end
return 0

-- Usage in Node.js:
const lockKey = `slot_lock:${slotId}`;
const token = crypto.randomUUID();
const acquired = await redis.eval(lockScript, 1, lockKey, token, 30000);

if (!acquired) {
    return { error: 'SLOT_BEING_BOOKED' };
}

try {
    await bookSlotInDatabase(slotId, userId);
} finally {
    // Only release if we own the lock
    await redis.eval(`
        if redis.call('get', KEYS[1]) == ARGV[1] then
            return redis.call('del', KEYS[1])
        end
        return 0
    `, 1, lockKey, token);
}</pre>
        </div>

        <!-- AWS COST ESTIMATION -->
        <h3>AWS Cost Estimation (MVP)</h3>
        <div class="feature-card">
            <table class="cost-table">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Spec</th>
                        <th>Monthly Cost</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="cost-tag aws">EC2</span> API Server (2x)</td>
                        <td>t3.medium, 2 vCPU, 4GB</td>
                        <td>$60</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">RDS</span> PostgreSQL</td>
                        <td>db.t3.medium, Multi-AZ, 50GB</td>
                        <td>$140</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">ElastiCache</span> Redis</td>
                        <td>cache.t3.small, 1.5GB</td>
                        <td>$25</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">Lambda</span> Reminder Worker</td>
                        <td>1M invocations, 256MB</td>
                        <td>$5</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">SES</span> Email Reminders</td>
                        <td>50K emails/month</td>
                        <td>$5</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">SNS</span> SMS Reminders</td>
                        <td>10K SMS/month (India)</td>
                        <td>$20</td>
                    </tr>
                    <tr>
                        <td><span class="cost-tag aws">ALB</span> Load Balancer</td>
                        <td>Application LB</td>
                        <td>$25</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="2"><strong>Total MVP Monthly</strong></td>
                        <td><strong>~$280/month</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- K8s DEPLOYMENT -->
        <h3>Deployment (K8s)</h3>
        <div class="deployment-diagram">
            <h4>Kubernetes Architecture</h4>
            <div class="k8s-cluster">
                <h5>EKS Cluster - ap-south-1</h5>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                    <div class="k8s-pod">api-deployment (replicas: 2)</div>
                    <div class="k8s-pod">reminder-worker (replicas: 1)</div>
                    <div class="k8s-pod">api-hpa (min:2, max:10)</div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <div class="k8s-pod" style="background: #7c3aed;">Service: ClusterIP</div>
                    <div class="k8s-pod" style="background: #0891b2;">Ingress: ALB</div>
                    <div class="k8s-pod" style="background: #dc2626;">Secret: db-creds</div>
                    <div class="k8s-pod" style="background: #ea580c;">CronJob: slot-generator</div>
                </div>
            </div>
        </div>

        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;">deployment.yaml (API + Reminder Worker)</h5>
<pre><span class="yaml-comment"># booking-api Deployment</span>
<span class="yaml-key">apiVersion</span>: apps/v1
<span class="yaml-key">kind</span>: Deployment
<span class="yaml-key">metadata</span>:
  <span class="yaml-key">name</span>: booking-api
<span class="yaml-key">spec</span>:
  <span class="yaml-key">replicas</span>: <span class="yaml-value">2</span>
  <span class="yaml-key">template</span>:
    <span class="yaml-key">containers</span>:
    - <span class="yaml-key">image</span>: booking-api:v1.0.0
      <span class="yaml-key">ports</span>: [<span class="yaml-value">3000</span>]
      <span class="yaml-key">envFrom</span>: [secretRef: db-creds, redis-creds]
      <span class="yaml-key">resources</span>: { cpu: 250m-500m, mem: 256Mi-512Mi }
      <span class="yaml-key">readinessProbe</span>: /health
---
<span class="yaml-comment"># reminder-worker Deployment</span>
<span class="yaml-key">kind</span>: Deployment
<span class="yaml-key">metadata</span>:
  <span class="yaml-key">name</span>: reminder-worker
<span class="yaml-key">spec</span>:
  <span class="yaml-key">replicas</span>: <span class="yaml-value">1</span>
  <span class="yaml-key">template</span>:
    <span class="yaml-key">containers</span>:
    - <span class="yaml-key">command</span>: ["node", "worker/reminder.js"]
      <span class="yaml-key">resources</span>: { cpu: 100m, mem: 128Mi }
---
<span class="yaml-comment"># HorizontalPodAutoscaler</span>
<span class="yaml-key">kind</span>: HorizontalPodAutoscaler
<span class="yaml-key">spec</span>:
  <span class="yaml-key">scaleTargetRef</span>: booking-api
  <span class="yaml-key">minReplicas</span>: <span class="yaml-value">2</span> | <span class="yaml-key">maxReplicas</span>: <span class="yaml-value">10</span>
  <span class="yaml-key">metrics</span>: cpu @ <span class="yaml-value">70%</span> utilization</pre>
        </div>

        <!-- CI/CD -->
        <h3>CI/CD Pipeline</h3>
        <div class="diagram-container">
            <h4>GitHub Actions to EKS</h4>
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 16px;">
                <div class="arch-box client" style="background: #24292e;">Git Push</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box server" style="background: #2088FF;">GitHub Actions</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box storage">ECR</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box gateway">kubectl apply</div>
                <div class="arch-arrow">→</div>
                <div class="arch-box server">EKS</div>
            </div>
            <div style="margin-top: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                <strong>Pipeline Steps:</strong>
                <ol style="font-size: 14px; margin-top: 8px;">
                    <li>Run tests (npm test, jest --coverage)</li>
                    <li>Lint and type check (eslint, tsc)</li>
                    <li>Build Docker image with git SHA tag</li>
                    <li>Push to ECR</li>
                    <li>Update K8s deployment (rolling update)</li>
                    <li>Run integration tests against staging</li>
                    <li>Notify Slack on success/failure</li>
                </ol>
            </div>
        </div>

        <!-- ROLLBACK STRATEGY -->
        <h3>Rollback Strategy</h3>
        <div class="feature-card warning">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4>Instant Rollback</h4>
                    <div class="code-example" style="margin: 12px 0;">
<pre>kubectl rollout undo deployment/booking-api</pre>
                    </div>
                    <p style="font-size: 14px;">K8s keeps last 10 ReplicaSets. Rollback in &lt;30s.</p>
                </div>
                <div>
                    <h4>Feature Flags for Booking Rules</h4>
                    <ul style="font-size: 14px;">
                        <li><code>enable_waitlist</code>: Toggle waitlist feature</li>
                        <li><code>enable_recurring</code>: Toggle recurring bookings</li>
                        <li><code>max_advance_days</code>: How far ahead can book</li>
                        <li><code>cancellation_window_hrs</code>: Min hours before slot</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Feature Additions -->
        <h3>Feature Addition: Recurring Bookings</h3>
        <div class="feature-card addition">
            <h4>RRULE Format (iCal Standard)</h4>
            <div class="code-example">
<pre>// Weekly on Monday and Wednesday until end of year
RRULE:FREQ=WEEKLY;BYDAY=MO,WE;UNTIL=20241231T235959Z

// Every 2 weeks on Friday, 10 occurrences
RRULE:FREQ=WEEKLY;INTERVAL=2;BYDAY=FR;COUNT=10

// Monthly on the 15th
RRULE:FREQ=MONTHLY;BYMONTHDAY=15

// Node.js: Use rrule library to expand dates
const rule = RRule.fromString(rruleStr);
const dates = rule.between(startDate, endDate);</pre>
            </div>
        </div>

        <h3>Feature Addition: Calendar Integration</h3>
        <div class="feature-card addition">
            <h4>Google Calendar Sync</h4>
            <ul>
                <li>OAuth 2.0 consent flow</li>
                <li>On booking: Create event via Calendar API</li>
                <li>On cancel: Delete event via Calendar API</li>
                <li>Store event_id in bookings table for updates</li>
            </ul>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Double Booking Race Condition</div>
                <p>Two users click "Book" simultaneously on the same slot, both see it as available.</p>
                <div class="case-solution">Use SELECT FOR UPDATE (pessimistic) or version column (optimistic). PostgreSQL row-level locks ensure only one transaction succeeds. Return 409 Conflict to the loser with retry suggestion.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">No-Show Handling</div>
                <p>User books slot but doesn't show up, wasting resource capacity.</p>
                <div class="case-solution">Implement no-show tracking per user. After 3 no-shows: require deposit or restrict booking. Auto-mark as no-show if not checked in within grace period (15 min). Notify waitlist immediately on no-show.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Overbooking Strategy</div>
                <p>Some industries intentionally overbook expecting cancellations (airlines, hotels).</p>
                <div class="case-solution">Add `overbooking_factor` to resources (e.g., 1.1 = 10% overbook). Track historical no-show rate per resource. Implement compensation workflow when overbooked slot actually fills up.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Timezone Confusion</div>
                <p>User in IST books 10 AM slot, expects IST but system stored UTC.</p>
                <div class="case-solution">Always store TIMESTAMPTZ (UTC). Display in user's browser timezone OR resource's timezone. Confirmation email shows both: "10:00 AM IST (04:30 UTC)". Handle DST transitions carefully.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Recurring Booking Conflicts</div>
                <p>Weekly recurring booking conflicts with a holiday or one-time block.</p>
                <div class="case-solution">Generate recurring instances at booking time (not lazily). Check each instance for conflicts. Allow "skip" for individual occurrences. Notify user of partial failures: "Booked 11/12 weeks, Dec 25 unavailable".</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Last-Minute Cancellation</div>
                <p>User cancels 5 minutes before appointment, leaving slot unfillable.</p>
                <div class="case-solution">Implement cancellation policies with cutoff times (e.g., 24h). Charge cancellation fee for late cancels. Auto-notify waitlist with "flash" availability. Consider partial refund tiers: 100% > 24h, 50% > 2h, 0% < 2h.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">AI Scheduling Assistant</div>
                <p>Natural language booking: "Book me with Dr. Smith next Tuesday afternoon".</p>
                <div class="future-approach">Integrate LLM for intent parsing. Extract: resource, date range, time preference. Query availability API. Present top 3 options. Confirm via voice or text. Store user preferences for personalization.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Predictive No-Show Detection</div>
                <p>ML model predicts likelihood of no-show to enable proactive overbooking.</p>
                <div class="future-approach">Features: user history, booking lead time, day of week, weather, distance from user location. Train XGBoost classifier. Score at booking time. Auto-waitlist if P(no-show) > 40%. Send extra reminders to high-risk bookings.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Waitlist Optimization</div>
                <p>Smart waitlist that maximizes fill rate and user satisfaction.</p>
                <div class="future-approach">Priority scoring: wait time + user value + flexibility. Batch notifications to multiple waitlist users simultaneously. First to confirm wins (FCFS with parallelism). A/B test notification timing for best conversion.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Resource Pooling</div>
                <p>Dynamically assign resources at check-in time rather than booking time.</p>
                <div class="future-approach">Book "any available doctor" instead of specific doctor. At check-in, assign based on current availability + skill match. Reduces no-show impact. Works well for fungible resources (massage therapists, meeting rooms).</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">When would you choose optimistic vs pessimistic locking?</div>
                    <div class="followup-hint">Optimistic: Low contention, read-heavy, user think time (typical booking). Pessimistic: High contention, flash sales, critical sections. Optimistic = higher throughput but requires retry logic. Pessimistic = simpler but can cause lock waits.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">How would you handle calendar sync conflicts? (User modifies event in Google Calendar)</div>
                    <div class="followup-hint">Webhook from Google Calendar on event change. Detect: delete = cancel booking, time change = attempt reschedule. If new time unavailable, notify user and revert calendar event. Store last_sync_at for conflict detection.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How do you efficiently query "next available slot" across 1000 resources?</div>
                    <div class="followup-hint">Materialized view of next_available per resource, refreshed on booking/cancel. Or: bitmap index where each bit = 15-min slot. For real-time: Redis sorted set with (resource_id, next_available_timestamp) as score.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">Design a fair booking system for high-demand slots (celebrity doctor, popular time)</div>
                    <div class="followup-hint">Virtual queue with randomized entry (lottery). Or: weighted priority (new patients, referred, loyalty). Release slots in batches. Rate limit per user. CAPTCHA to prevent bots. Consider appointment request + approval workflow.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement buffer time between appointments?</div>
                    <div class="followup-hint">Store buffer_minutes per resource. When checking availability, slot is "blocked" for (duration + buffer). Don't expose buffer to user. Use buffer for: cleanup, travel time, overrun. Can be asymmetric (15min after, 5min before).</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>MVP Stage - Complete Booking Flow</h4>
            <div class="flow-vertical">
                <!-- Booking Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">BOOK SLOT FLOW (with Locking)</div>
                    <div class="flow-row">
                        <div class="flow-node user">Client<br><small>POST /bookings</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node gateway">ALB<br><small>SSL + Auth</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node service">API Server<br><small>BEGIN TXN</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a><br><small>SELECT FOR UPDATE</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node service">Check<br><small>status=available?</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a><br><small>UPDATE + INSERT</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node cache"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a><br><small>Queue reminder</small></div>
                    </div>
                </div>

                <!-- Reminder Flow -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">REMINDER & CHECK-IN FLOW</div>
                    <div class="flow-row">
                        <div class="flow-node service">Worker<br><small>Poll due reminders</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node gateway">SES/Twilio<br><small>Send notification</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node user">User Arrives<br><small>Check-in</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a><br><small>status=completed</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node service">Analytics<br><small>Track metrics</small></div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                <strong>Locking Mechanism (Version Column):</strong>
                <div style="font-family: monospace; font-size: 13px; margin-top: 8px;">
                    1. READ: SELECT id, version FROM slots WHERE id = $1 --> version = 5<br>
                    2. UPDATE: UPDATE slots SET status='booked', version=6 WHERE id=$1 AND version=5<br>
                    3. If rowCount = 0 --> Concurrent modification, return 409 Conflict
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution Across Stages</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon mvp">MVP</div>
                    <div class="evolution-label">MVP</div>
                    <div class="evolution-db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="evolution-detail">SELECT FOR UPDATE<br>Optimistic locking<br>Single primary</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon pan-india">PAN</div>
                    <div class="evolution-label">PAN-India</div>
                    <div class="evolution-db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> + <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Lock</div>
                    <div class="evolution-detail">Distributed lock<br>SETNX with TTL<br>Read replicas</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon high-traffic">HT</div>
                    <div class="evolution-label">High Traffic</div>
                    <div class="evolution-db"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> + Sharded PG</div>
                    <div class="evolution-detail">Virtual queue<br>Pre-lock in Redis<br>Then persist to DB</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon global">GLB</div>
                    <div class="evolution-label">Global</div>
                    <div class="evolution-db">CRDTs + Aurora Global</div>
                    <div class="evolution-detail">Conflict-free types<br>Last-write-wins<br>Regional primaries</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- PAN-INDIA SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="pan-india">
        <div class="stage-header">
            <span class="stage-badge pan-india">PAN-India Scale</span>
            <h2 style="margin: 0;">Multi-tenant SaaS • 10K Clinics • 1M Users</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Multi-tenant isolation</li>
                        <li>Tenant-specific configurations</li>
                        <li>Cross-clinic booking (same chain)</li>
                        <li>Analytics dashboard per tenant</li>
                        <li>Bulk slot management</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Tenant data isolation: 100%</li>
                        <li>Multi-timezone support (IST, UTC)</li>
                        <li>99.95% availability</li>
                        <li>Horizontal scaling per region</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE -->
        <h3>Architecture Evolution</h3>
        <div class="diagram-container">
            <h4>Multi-Tenant Architecture</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                <div class="arch-box client">Users (All India)</div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box cdn">CloudFront CDN<br><small>Static assets, API caching</small></div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box lb">Route 53 (Latency-based)</div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: center;">
                    <div style="text-align: center; padding: 16px; border: 2px dashed #3b82f6; border-radius: 12px;">
                        <strong style="color: #3b82f6;">Mumbai (ap-south-1)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">API (4x)</div>
                            <div class="arch-box server" style="padding: 10px;">Worker (2x)</div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box cache" style="padding: 10px;">Redis Cluster</div>
                        </div>
                        <div class="arch-box db" style="margin-top: 12px;">RDS Primary</div>
                    </div>
                    <div style="text-align: center; padding: 16px; border: 2px dashed #22c55e; border-radius: 12px;">
                        <strong style="color: #22c55e;">Hyderabad (ap-south-2)</strong>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box server" style="padding: 10px;">API (2x)</div>
                            <div class="arch-box server" style="padding: 10px;">Worker (1x)</div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <div class="arch-box cache" style="padding: 10px;">Redis Replica</div>
                        </div>
                        <div class="arch-box db" style="margin-top: 12px; opacity: 0.7;">RDS Read Replica</div>
                    </div>
                </div>
            </div>
        </div>

        <h3>Multi-tenancy Strategy</h3>
        <div class="feature-card">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 30%;"><strong>Tenant Identification</strong></td>
                    <td>Subdomain (apollo.booking.com) or X-Tenant-ID header</td>
                </tr>
                <tr>
                    <td><strong>Data Isolation</strong></td>
                    <td>Row-level: tenant_id column on all tables + RLS policies</td>
                </tr>
                <tr>
                    <td><strong>Schema per Tenant</strong></td>
                    <td>Alternative: tenant_apollo.slots (better isolation, harder migrations)</td>
                </tr>
                <tr>
                    <td><strong>Timezone Handling</strong></td>
                    <td>Store all times in UTC. Display in tenant's configured timezone</td>
                </tr>
            </table>
        </div>

        <div class="sql-query">
            <h5>Row-Level Security for Multi-tenancy</h5>
<pre>-- Enable RLS
ALTER TABLE slots ENABLE ROW LEVEL SECURITY;

-- Policy: Tenants can only see their own data
CREATE POLICY tenant_isolation ON slots
    USING (tenant_id = current_setting('app.current_tenant')::uuid);

-- Set tenant context at connection start
SET app.current_tenant = 'tenant-uuid-here';</pre>
        </div>

        <!-- COST -->
        <h3>Cost at PAN-India Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr>
                    <td>EKS (6 nodes across 2 regions)</td>
                    <td>$450</td>
                </tr>
                <tr>
                    <td>RDS Primary + Read Replica</td>
                    <td>$500</td>
                </tr>
                <tr>
                    <td>ElastiCache (2 clusters)</td>
                    <td>$150</td>
                </tr>
                <tr>
                    <td>Lambda (Reminders, 10M invocations)</td>
                    <td>$50</td>
                </tr>
                <tr>
                    <td>SES + SNS (Notifications)</td>
                    <td>$200</td>
                </tr>
                <tr>
                    <td>Route 53 + CloudFront</td>
                    <td>$100</td>
                </tr>
                <tr class="total-row">
                    <td><strong>Total</strong></td>
                    <td><strong>~$1,450/month</strong></td>
                </tr>
            </table>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Cross-Tenant Data Leakage</div>
                <p>Bug in query allows Tenant A to see Tenant B's bookings.</p>
                <div class="case-solution">Always use Row-Level Security (RLS) in PostgreSQL. Set tenant context at connection level. Audit logs for cross-tenant queries. Penetration testing. Separate connection pools per tenant for premium tier.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Tenant Database Hotspot</div>
                <p>One large tenant (Apollo with 5000 clinics) overwhelms shared database.</p>
                <div class="case-solution">Monitor queries per tenant. Implement tenant-level rate limiting. Move large tenants to dedicated shards. Use tenant_id as partition key. Connection pooling per tenant with PgBouncer.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Cross-Clinic Booking Conflicts</div>
                <p>User books same time at two clinics in same chain, but can only attend one.</p>
                <div class="case-solution">Optional: Enable user-level conflict detection across tenant's clinics. Warn user: "You have another booking at 10 AM at Clinic B". Allow override for valid cases (different family members).</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Timezone at Tenant vs Resource Level</div>
                <p>Chain has clinics in Mumbai (IST) and Dubai (GST). Which timezone for display?</p>
                <div class="case-solution">Store timezone per resource (clinic), not tenant. Display in resource's timezone for booking. Show user's local time in confirmation. API always uses UTC; client converts for display.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Read Replica Lag</div>
                <p>User books slot, immediately checks "My Bookings" - doesn't see new booking (replica lag).</p>
                <div class="case-solution">Read-your-writes consistency: Route reads to primary for 5s after write. Or: Return booking from response, merge client-side. Use session stickiness to same replica.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Bulk Slot Update Failure</div>
                <p>Admin updates 1000 slots (holiday closure), partial failure occurs.</p>
                <div class="case-solution">Use database transactions for atomicity. Or: async job with progress tracking. Report partial success: "Updated 950/1000 slots. 50 failed (already booked)". Allow retry for failed items.</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">White-Label Mobile Apps</div>
                <p>Each tenant gets their own branded mobile app without code changes.</p>
                <div class="future-approach">React Native with theme injection. Tenant config: logo, colors, features enabled. Single codebase, build-time customization. App store submission per tenant or single app with tenant selector.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Cross-Tenant Analytics (Benchmarking)</div>
                <p>Anonymized comparison: "Your no-show rate is 8% vs industry average 5%".</p>
                <div class="future-approach">Aggregate metrics across tenants (anonymized). Industry benchmarks by specialty. Insights dashboard: "Clinics with SMS reminders have 40% fewer no-shows". Opt-in data sharing program.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Tenant Self-Service Configuration</div>
                <p>Tenants configure booking rules, cancellation policies, reminders without code changes.</p>
                <div class="future-approach">Admin portal with rule builder. Store config in tenant_settings table. Feature flags per tenant. Webhook configuration for integrations. Custom fields per tenant.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Marketplace for Integrations</div>
                <p>Third-party developers build integrations (EMR, payment, CRM).</p>
                <div class="future-approach">OAuth 2.0 for third-party apps. Scoped permissions (read:bookings, write:slots). Rate limiting per app. Revenue share model. App review process for quality.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How do you ensure tenant isolation in a shared database?</div>
                    <div class="followup-hint">Row-Level Security (RLS) policies. Tenant_id on every table. Set session variable (app.current_tenant). Audit queries. Alternative: schema-per-tenant (harder migrations) or database-per-tenant (expensive).</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">How would you handle a tenant requesting data export (GDPR)?</div>
                    <div class="followup-hint">Background job to export all tenant data. Include: bookings, users, audit logs. Format: JSON or CSV. Secure download link with expiry. Log the export request. Allow user-level export too.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">Design tenant-specific pricing tiers (Free, Pro, Enterprise)</div>
                    <div class="followup-hint">Limits table: max_bookings_per_month, max_resources, features_enabled. Check limits at booking time. Soft limit (warn) vs hard limit (block). Upgrade prompts. Usage-based billing option.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">How do you migrate a large tenant to their own dedicated database?</div>
                    <div class="followup-hint">Dual-write during migration. Copy historical data with pg_dump filtered by tenant_id. Verify row counts match. Switch read traffic, then writes. Keep old data for rollback period. Update tenant routing config.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement regional failover for Indian users?</div>
                    <div class="followup-hint">Primary in Mumbai (ap-south-1), standby in Hyderabad (ap-south-2). Route 53 health checks. RDS Multi-AZ for automatic DB failover. Redis Sentinel for cache failover. Test failover monthly.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>PAN-India Stage - Multi-Tenant Booking Flow</h4>
            <div class="flow-vertical">
                <!-- Tenant-Aware Booking Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">MULTI-TENANT BOOKING FLOW</div>
                    <div class="flow-row">
                        <div class="flow-node user">Client<br><small>apollo.booking.com</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node gateway">Route 53<br><small>Latency routing</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node gateway">ALB<br><small>Extract tenant</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node service">API Server<br><small>SET app.tenant</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a><br><small>RLS filter</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node cache"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a><br><small>tenant:slot:lock</small></div>
                    </div>
                </div>

                <!-- Cross-Region Read -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">READ REPLICA ROUTING</div>
                    <div class="flow-row">
                        <div class="flow-node user">User (Hyderabad)<br><small>GET /availability</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node gateway">Route 53<br><small>Nearest region</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node service">API (ap-south-2)<br><small>Read-only</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node db">Read Replica<br><small>~10ms lag</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node user">Response<br><small>Low latency</small></div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                <strong><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Distributed Lock (Multi-Region):</strong>
                <div style="font-family: monospace; font-size: 13px; margin-top: 8px;">
                    1. SETNX tenant:{tenant_id}:slot:{slot_id}:lock {request_id} EX 30<br>
                    2. If acquired: Proceed with DB transaction<br>
                    3. Release: DEL if value matches request_id (Lua script for atomicity)
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution - PAN-India Focus</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon mvp">MVP</div>
                    <div class="evolution-label">Single Tenant</div>
                    <div class="evolution-db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="evolution-detail">No tenant_id<br>Simple queries<br>db.t3.medium</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon pan-india">PAN</div>
                    <div class="evolution-label">Multi-Tenant</div>
                    <div class="evolution-db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a> + RLS</div>
                    <div class="evolution-detail">tenant_id on all tables<br>Row-Level Security<br>Read replicas</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon high-traffic">SHARD</div>
                    <div class="evolution-label">Large Tenants</div>
                    <div class="evolution-db">Citus (Distributed PG)</div>
                    <div class="evolution-detail">Shard by tenant_id<br>Dedicated shards<br>Parallel queries</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon global">ISOLATE</div>
                    <div class="evolution-label">Enterprise</div>
                    <div class="evolution-db">DB per Tenant</div>
                    <div class="evolution-detail">Full isolation<br>Custom retention<br>Compliance ready</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- HIGH TRAFFIC -->
    <!-- ============================================ -->
    <div class="stage-section" id="high-traffic">
        <div class="stage-header">
            <span class="stage-badge high-traffic">High Traffic</span>
            <h2 style="margin: 0;">Flash Sale Scenario • 100K concurrent users</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Virtual waiting room</li>
                        <li>Fair slot distribution</li>
                        <li>Reservation hold (5-min checkout)</li>
                        <li>Rate limiting per user</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Handle 10K booking requests/second</li>
                        <li>Zero double bookings under load</li>
                        <li>Graceful degradation</li>
                        <li>Queue position updates (real-time)</li>
                    </ul>
                </div>
            </div>
        </div>

        <h3>What Breaks First</h3>
        <div class="feature-card warning">
            <p><strong>Scenario:</strong> Celebrity doctor releases 50 slots at 10 AM. 100,000 users try to book simultaneously.</p>
            <table style="width: 100%; font-size: 15px; margin-top: 12px;">
                <tr>
                    <td style="width: 25%;"><strong>1. DB Lock Contention</strong></td>
                    <td>All requests trying to lock same slot rows</td>
                    <td style="color: #22c55e;"><strong>→ Pre-lock in Redis, then DB</strong></td>
                </tr>
                <tr>
                    <td><strong>2. Thundering Herd</strong></td>
                    <td>All users refresh availability at same time</td>
                    <td style="color: #22c55e;"><strong>→ Cache with stale-while-revalidate</strong></td>
                </tr>
                <tr>
                    <td><strong>3. Unfair Distribution</strong></td>
                    <td>Fastest clickers/bots win all slots</td>
                    <td style="color: #22c55e;"><strong>→ Virtual queue with random assignment</strong></td>
                </tr>
                <tr>
                    <td><strong>4. Connection Pool</strong></td>
                    <td>DB connections exhausted</td>
                    <td style="color: #22c55e;"><strong>→ PgBouncer transaction pooling</strong></td>
                </tr>
            </table>
        </div>

        <!-- ARCHITECTURE -->
        <h3>Architecture at Scale</h3>
        <div class="diagram-container">
            <h4>High-Traffic Architecture with Virtual Queue</h4>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                <div class="arch-box client">100K Concurrent Users</div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box cdn">CloudFront + WAF<br><small>Rate limiting, DDoS protection</small></div>
                <div class="arch-arrow">↓</div>
                <div class="arch-box gateway">Virtual Queue<br><small><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Sorted Set</small></div>
                <div class="arch-arrow">↓ (batch of 100)</div>
                <div class="arch-box lb">NLB (Layer 4)</div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 12px;">
                    <div class="arch-box server">API Pod 1</div>
                    <div class="arch-box server">API Pod 2</div>
                    <div class="arch-box server">...</div>
                    <div class="arch-box server">API Pod 20</div>
                </div>
                <div class="arch-arrow">↓</div>
                <div style="display: flex; gap: 40px;">
                    <div class="arch-box cache"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Cluster<br><small>Slot locks + queue</small></div>
                    <div class="arch-box db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a><br><small>With PgBouncer</small></div>
                </div>
            </div>
        </div>

        <h3>Virtual Waiting Room</h3>
        <div class="code-example">
            <h5 style="color: #60a5fa; margin-bottom: 12px;"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a>-based Queue Implementation</h5>
<pre>// User enters queue
const position = await redis.zadd('queue:slot:123', Date.now(), `user:${userId}`);

// WebSocket: Send position updates
const rank = await redis.zrank('queue:slot:123', `user:${userId}`);
ws.send({ type: 'queue_position', position: rank + 1 });

// Worker: Process queue in batches
async function processQueue(slotId) {
    // Get next 10 users
    const users = await redis.zpopmin(`queue:slot:${slotId}`, 10);

    for (const userId of users) {
        // Give each user 5 minutes to complete booking
        await redis.setex(`reservation:${slotId}:${userId}`, 300, 'held');
        await notifyUser(userId, 'Your turn to book!');
    }
}</pre>
        </div>

        <h3>Slot Reservation with Timeout</h3>
        <div class="diagram-container">
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px;">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div class="arch-box client" style="padding: 10px 16px;">User's Turn</div>
                    <div class="flow-step-label">From queue</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div class="arch-box cache" style="padding: 10px 16px;"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a></div>
                    <div class="flow-step-label">SETEX reservation 5min</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div class="arch-box client" style="padding: 10px 16px;">Checkout UI</div>
                    <div class="flow-step-label">5:00 countdown</div>
                </div>
                <div class="arch-arrow">→</div>
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div class="arch-box db" style="padding: 10px 16px;">Confirm</div>
                    <div class="flow-step-label">Or release slot</div>
                </div>
            </div>
        </div>

        <!-- COST -->
        <h3>Cost at High Traffic</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (20 nodes, c5.xlarge)</td><td>$2,500</td></tr>
                <tr><td>RDS (db.r5.xlarge + replicas)</td><td>$1,800</td></tr>
                <tr><td>ElastiCache Cluster (16 nodes)</td><td>$2,000</td></tr>
                <tr><td>CloudFront + WAF</td><td>$1,500</td></tr>
                <tr><td>Lambda + SQS (notifications)</td><td>$300</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$8,100/month</strong></td></tr>
            </table>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Queue Starvation (User Never Gets Turn)</div>
                <p>User joins queue but keeps getting pushed back by new arrivals or slow processing.</p>
                <div class="case-solution">Implement fair queuing with maximum wait time guarantee. After 10 minutes in queue, prioritize user. Show estimated wait time. Allow users to leave queue and get notified later.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Reservation Timeout During Payment</div>
                <p>User's 5-minute reservation expires while entering payment details.</p>
                <div class="case-solution">Extend reservation automatically if payment is in progress (check payment gateway status). Grace period of 60 seconds after expiry. If truly expired, notify user and offer to re-queue with priority.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Redis Cluster Failover During Flash Sale</div>
                <p>Redis node fails during peak load, losing queue state.</p>
                <div class="case-solution">Redis Cluster with replicas (3 masters, 3 replicas). AOF persistence for durability. Fallback to database-backed queue. Circuit breaker to reject new requests during failover.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Bot Attack Filling Queue</div>
                <p>Scalpers use bots to join queue thousands of times.</p>
                <div class="case-solution">CAPTCHA before queue entry. Device fingerprinting. Rate limit per IP/user. Phone verification for queue entry. Detect abnormal patterns (same browser fingerprint, timing). Ban repeat offenders.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Thundering Herd on Availability Check</div>
                <p>100K users refresh availability page simultaneously at sale start time.</p>
                <div class="case-solution">Cache availability at CDN edge (CloudFront). Stale-while-revalidate caching. Rate limit availability API. Pre-computed availability snapshots. WebSocket push instead of polling.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Partial System Failure (Some Pods Down)</div>
                <p>3 of 20 API pods crash under load, remaining pods get overwhelmed.</p>
                <div class="case-solution">Kubernetes HPA with aggressive scaling. Pod disruption budgets. Load shedding (reject requests when at capacity). Circuit breaker per downstream service. Graceful degradation (read-only mode).</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">Dynamic Pricing (Surge Pricing)</div>
                <p>Adjust slot prices based on demand, like Uber surge pricing.</p>
                <div class="future-approach">Price = base_price * demand_multiplier. Calculate multiplier from: queue length, historical demand, time of day. Show price upfront before queue entry. Cap maximum surge (3x). Discount for off-peak times.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Lottery System for Fairness</div>
                <p>Instead of FCFS, randomly select winners from registration pool.</p>
                <div class="future-approach">Registration window (e.g., 24 hours before sale). Random selection at sale time using verifiable randomness. Notify winners with time-limited booking link. Transparent: publish seed and algorithm.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Predictive Auto-Scaling</div>
                <p>Scale up infrastructure before flash sale based on predicted demand.</p>
                <div class="future-approach">ML model trained on: past sale patterns, marketing campaigns, day of week. Pre-warm Kubernetes nodes. Pre-scale Redis cluster. Load test at 2x predicted capacity. Automated runbook for sale events.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Real-Time Analytics Dashboard</div>
                <p>Live dashboard showing: queue depth, bookings/second, error rates.</p>
                <div class="future-approach">ClickHouse for real-time aggregations. Grafana dashboards with 1-second refresh. Alerts for anomalies. War room mode during flash sales. Post-sale automated reports.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement a fair virtual queue that prevents bots?</div>
                    <div class="followup-hint">CAPTCHA + phone verification. Proof-of-work puzzle (client must compute hash). Device fingerprint + behavioral analysis. Queue position tied to verified identity. Rate limit queue joins per phone number.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">Design a reservation system with checkout timeout. What happens on edge cases?</div>
                    <div class="followup-hint">Redis SETEX for reservation with TTL. Background job checks expired reservations. Edge cases: extend if payment in progress, grace period, re-queue with priority, compensation for lost reservation.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle WebSocket connections at 100K concurrent users?</div>
                    <div class="followup-hint">Sticky sessions to specific pods. Redis Pub/Sub for cross-pod messaging. Connection limits per pod (10K). Heartbeat for dead connection cleanup. Fallback to long-polling. Consider managed service (AWS API Gateway WebSocket).</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">What's your load shedding strategy when system is overwhelmed?</div>
                    <div class="followup-hint">Priority queues: existing reservations > queue members > new requests. Return 503 with Retry-After header. Disable non-critical features. Read-only mode (no new bookings). Queue depth circuit breaker.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How would you conduct a load test for flash sale scenario?</div>
                    <div class="followup-hint">Tools: k6, Locust, or Gatling. Simulate realistic user journey (not just API calls). Ramp up gradually to find breaking point. Test Redis failover mid-load. Chaos engineering (kill pods). Run in production-like environment.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>High Traffic Stage - Flash Sale Booking Flow</h4>
            <div class="flow-vertical">
                <!-- Queue Entry Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">VIRTUAL QUEUE FLOW</div>
                    <div class="flow-row">
                        <div class="flow-node user">100K Users<br><small>Sale starts</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node gateway">CloudFront + WAF<br><small>Rate limit</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node service">Queue Service<br><small>CAPTCHA verify</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node cache">Redis ZADD<br><small>Sorted by timestamp</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node user">WebSocket<br><small>Position updates</small></div>
                    </div>
                </div>

                <!-- Reservation Flow -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">RESERVATION CHECKOUT FLOW</div>
                    <div class="flow-row">
                        <div class="flow-node service">Worker<br><small>ZPOPMIN batch</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node cache">Redis SETEX<br><small>5-min hold</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node user">Checkout UI<br><small>Countdown timer</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node gateway">Payment<br><small>Stripe/Razorpay</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a><br><small>Confirm booking</small></div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                <strong>Reservation Timeout Handling:</strong>
                <div style="font-family: monospace; font-size: 13px; margin-top: 8px;">
                    1. <a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> key expires after 5 minutes (TTL)<br>
                    2. Background job: SCAN for expired reservations<br>
                    3. Release slot: UPDATE slots SET status='available' WHERE reservation_expired<br>
                    4. Notify next in queue: ZPOPMIN queue:{slot_id}
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution - High Traffic Focus</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon mvp">SINGLE</div>
                    <div class="evolution-label">Single DB</div>
                    <div class="evolution-db"><a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="evolution-detail">1K TPS limit<br>Connection pool<br>Breaks at 10K</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon pan-india">CACHE</div>
                    <div class="evolution-label">Add Caching</div>
                    <div class="evolution-db"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> + <a href="/interview-question/glossary#postgresql" class="info-term">PostgreSQL<span class="info-i">i</span></a></div>
                    <div class="evolution-detail">Hot data in Redis<br>10K read TPS<br>DB for writes only</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon high-traffic">QUEUE</div>
                    <div class="evolution-label">Virtual Queue</div>
                    <div class="evolution-db"><a href="/interview-question/glossary#redis" class="info-term">Redis<span class="info-i">i</span></a> Queue + PG</div>
                    <div class="evolution-detail">Absorb spike in queue<br>Controlled DB writes<br>100K concurrent</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon global">SHARD</div>
                    <div class="evolution-label">Sharded</div>
                    <div class="evolution-db">Vitess/Citus</div>
                    <div class="evolution-detail">Shard by resource<br>Parallel writes<br>Linear scaling</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- GLOBAL SCALE -->
    <!-- ============================================ -->
    <div class="stage-section" id="global">
        <div class="stage-header">
            <span class="stage-badge global">Global Scale</span>
            <h2 style="margin: 0;">International SaaS • 50M Users • 200 Countries</h2>
        </div>

        <!-- REQUIREMENTS -->
        <h3>Requirements</h3>
        <div class="feature-card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                    <h4 style="color: #22c55e;">Functional</h4>
                    <ul>
                        <li>Multi-timezone scheduling</li>
                        <li>Regional holiday calendars</li>
                        <li>Multi-currency payments</li>
                        <li>Localized notifications (i18n)</li>
                        <li>Cross-border booking (telemedicine)</li>
                    </ul>
                </div>
                <div>
                    <h4 style="color: #3b82f6;">Non-Functional</h4>
                    <ul>
                        <li>Latency: &lt;100ms globally</li>
                        <li>Availability: 99.99%</li>
                        <li>HIPAA (US), GDPR (EU) compliance</li>
                        <li>Data residency (regional DBs)</li>
                        <li>Active-active multi-region</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ARCHITECTURE -->
        <h3>Global Architecture</h3>
        <div class="diagram-container">
            <h4>Multi-Region Active-Active</h4>
            <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;">
                <div style="text-align: center; padding: 20px; background: rgba(59,130,246,0.1); border-radius: 12px;">
                    <strong>US-East (Virginia)</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">ElastiCache</div>
                    <div class="arch-box db" style="margin-top: 8px;">Aurora Global</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 8px;">HIPAA compliant</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(34,197,94,0.1); border-radius: 12px;">
                    <strong>EU-West (Frankfurt)</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">ElastiCache</div>
                    <div class="arch-box db" style="margin-top: 8px;">Aurora Global</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 8px;">GDPR compliant</div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(249,115,22,0.1); border-radius: 12px;">
                    <strong>Asia-Pacific (Mumbai)</strong>
                    <div class="arch-box server" style="margin-top: 12px;">EKS Cluster</div>
                    <div class="arch-box cache" style="margin-top: 8px;">ElastiCache</div>
                    <div class="arch-box db" style="margin-top: 8px;">Aurora Global</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 8px;">Data residency</div>
                </div>
            </div>
            <p style="margin-top: 16px;"><strong>Aurora Global Database:</strong> &lt;1 second cross-region replication. Write to nearest primary, read locally.</p>
        </div>

        <h3>Global Considerations</h3>
        <div class="feature-card">
            <table style="width: 100%; font-size: 15px;">
                <tr>
                    <td style="width: 25%;"><strong>Timezone Handling</strong></td>
                    <td>Store UTC + IANA timezone (America/New_York). Display in user's local time. Handle DST transitions.</td>
                </tr>
                <tr>
                    <td><strong>Conflict Resolution</strong></td>
                    <td>Last-write-wins with vector clocks. Booking conflicts resolved by timestamp (UTC).</td>
                </tr>
                <tr>
                    <td><strong>Data Residency</strong></td>
                    <td>EU users' PII stays in Frankfurt. Route by user's country at API gateway.</td>
                </tr>
                <tr>
                    <td><strong>Compliance</strong></td>
                    <td>Audit logs, encryption at rest (KMS), access controls, data retention policies.</td>
                </tr>
            </table>
        </div>

        <!-- SCALE METRICS -->
        <h3>Scale Metrics</h3>
        <div class="metrics-card">
            <div class="metric">
                <div class="value">10M+</div>
                <div class="label">Bookings/month</div>
            </div>
            <div class="metric">
                <div class="value">&lt;0.01%</div>
                <div class="label">Double-booking Rate</div>
            </div>
            <div class="metric">
                <div class="value">&lt;3%</div>
                <div class="label">No-show Rate</div>
            </div>
            <div class="metric">
                <div class="value">99.99%</div>
                <div class="label">Availability</div>
            </div>
        </div>

        <!-- COST -->
        <h3>Cost at Global Scale</h3>
        <div class="feature-card">
            <table class="cost-table">
                <tr><td>EKS (3 regions, 50 nodes total)</td><td>$12,000</td></tr>
                <tr><td>Aurora Global (3 regions)</td><td>$15,000</td></tr>
                <tr><td>ElastiCache Global</td><td>$6,000</td></tr>
                <tr><td>CloudFront (Global CDN)</td><td>$8,000</td></tr>
                <tr><td>Lambda + SQS + SNS (Notifications)</td><td>$2,000</td></tr>
                <tr><td>Monitoring (Datadog)</td><td>$3,000</td></tr>
                <tr><td>Compliance (Auditing, Encryption)</td><td>$2,000</td></tr>
                <tr class="total-row"><td><strong>Total</strong></td><td><strong>~$48,000/month</strong></td></tr>
            </table>
        </div>

        <!-- EDGE CASES -->
        <div class="edge-cases">
            <h4>Edge Cases & Error Handling</h4>

            <div class="edge-case-item">
                <div class="case-title">Cross-Region Booking Conflict</div>
                <p>User in US books slot, user in EU books same slot during replication lag.</p>
                <div class="case-solution">Use global unique booking IDs (ULID with region prefix). Last-write-wins with timestamp (UTC). Conflict detection at read time. Compensating transaction: notify loser, offer alternative. Consider single-leader for critical writes.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">DST Transition Booking</div>
                <p>User books 2 AM slot on DST change day. That hour doesn't exist or exists twice.</p>
                <div class="case-solution">Store timezone name (America/New_York), not offset. Use IANA timezone database (tzdata). For non-existent time: shift forward. For ambiguous time: assume standard time. Show warning to user during booking.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">GDPR Right to Erasure</div>
                <p>EU user requests deletion of all their data across all regions.</p>
                <div class="case-solution">Track all user data locations (data map). Async deletion job across regions. Retain anonymized booking records for business metrics. Audit log of deletion request. 30-day compliance window.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Region Failover Mid-Booking</div>
                <p>User starts booking in US-East, region fails, continues in US-West.</p>
                <div class="case-solution">Stateless API design (no server-side sessions). Store booking draft in user's browser (localStorage). Use global session store (Redis Global Datastore). Idempotency keys to prevent double booking on retry.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Telemedicine Cross-Border Booking</div>
                <p>Patient in India books with US doctor. Which timezone? Which compliance rules?</p>
                <div class="case-solution">Display time in both timezones. Resource determines compliance region. Check licensing (can this doctor treat patients in India?). Payment in patient's currency, payout in doctor's. Consider video call platform regional availability.</div>
            </div>

            <div class="edge-case-item">
                <div class="case-title">Data Residency Violation</div>
                <p>EU user's data accidentally replicated to US region.</p>
                <div class="case-solution">Geo-fencing at database level. Separate clusters per compliance region (not global replication). Route by user's registered country. Audit data location periodically. Encrypt with region-specific keys (can't decrypt in wrong region).</div>
            </div>
        </div>

        <!-- FUTURE ASPECTS -->
        <div class="future-aspects">
            <h4>Future Enhancements</h4>

            <div class="future-item">
                <div class="future-title">AI-Powered Smart Scheduling</div>
                <p>ML optimizes slot allocation based on no-show predictions, travel time, and preferences.</p>
                <div class="future-approach">Predict optimal appointment duration per patient (new vs returning). Suggest best times based on historical show rates. Auto-cluster appointments by patient location to reduce travel. Personalized reminders based on user behavior.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Blockchain Audit Trail</div>
                <p>Immutable record of all booking changes for compliance and dispute resolution.</p>
                <div class="future-approach">Hyperledger Fabric for private blockchain. Hash of each booking state change. Useful for: insurance claims, legal disputes, compliance audits. Query via traditional APIs, blockchain for verification.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Voice-First Booking (Alexa, Google Assistant)</div>
                <p>"Alexa, book me a dentist appointment next week".</p>
                <div class="future-approach">Alexa Skill / Google Action. Voice interface for: check availability, book, cancel, reschedule. Confirm via voice with confirmation code. Link to existing user account. Support multiple languages per region.</div>
            </div>

            <div class="future-item">
                <div class="future-title">Federated Learning for Privacy</div>
                <p>Train ML models across regions without sharing raw patient data.</p>
                <div class="future-approach">Each region trains local model on local data. Share only model gradients, not data. Aggregate globally for improved predictions. Compliant with GDPR, HIPAA. Use for: no-show prediction, demand forecasting.</div>
            </div>
        </div>

        <!-- INTERVIEW FOLLOW-UP FEATURES -->
        <div class="followup-features">
            <h4>Interview Follow-Up Questions</h4>

            <div class="followup-item">
                <div class="followup-number">1</div>
                <div class="followup-content">
                    <div class="followup-question">How do you handle booking conflicts in an active-active multi-region setup?</div>
                    <div class="followup-hint">Last-write-wins with vector clocks. Or: designate primary region per resource. CRDTs for conflict-free counters (waitlist position). Compensating transactions for true conflicts. Eventual consistency is OK for reads, strong for writes.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">2</div>
                <div class="followup-content">
                    <div class="followup-question">Design the data residency architecture for GDPR compliance</div>
                    <div class="followup-hint">EU data stays in EU region (Frankfurt). Separate database clusters, not global replication. Route by user's country at API gateway. Encrypt with region-specific KMS keys. Audit trail for data access. Right to erasure workflow.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">3</div>
                <div class="followup-content">
                    <div class="followup-question">How would you implement multi-timezone recurring bookings?</div>
                    <div class="followup-hint">Store RRULE with TZID (RRULE:FREQ=WEEKLY;BYDAY=MO;TZID=America/New_York). Expand occurrences using timezone-aware library (date-fns-tz, luxon). Handle DST: skip non-existent, disambiguate duplicates. Display in user's timezone.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">4</div>
                <div class="followup-content">
                    <div class="followup-question">Design a disaster recovery plan for a global booking system</div>
                    <div class="followup-hint">RPO: 1 second (Aurora Global). RTO: 5 minutes (DNS failover). Active-active preferred over active-passive. Chaos engineering (Gremlin). Runbook for region failover. Data backup to S3 cross-region. Test DR quarterly.</div>
                </div>
            </div>

            <div class="followup-item">
                <div class="followup-number">5</div>
                <div class="followup-content">
                    <div class="followup-question">How do you ensure consistency for cross-border telemedicine bookings?</div>
                    <div class="followup-hint">Single source of truth for booking (resource's region). Replicate to patient's region for read availability. Strong consistency for booking writes. Check: provider licensing, patient consent, payment regulations. Time display in both timezones.</div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FLOW DIAGRAM -->
        <div class="summary-flow">
            <h4>Global Stage - Cross-Region Booking Flow</h4>
            <div class="flow-vertical">
                <!-- Global Routing Flow -->
                <div style="width: 100%; margin-bottom: 24px;">
                    <div style="text-align: center; font-weight: 700; color: #166534; margin-bottom: 12px;">GLOBAL ROUTING FLOW</div>
                    <div class="flow-row">
                        <div class="flow-node user">User (Tokyo)<br><small>Book US doctor</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node gateway">CloudFront<br><small>Edge location</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node gateway">Route 53<br><small>Geolocation</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node service">API (US-East)<br><small>Resource's region</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node db">Aurora Global<br><small>Primary write</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node db">Replicas<br><small>&lt;1s sync</small></div>
                    </div>
                </div>

                <!-- Conflict Resolution Flow -->
                <div style="width: 100%;">
                    <div style="text-align: center; font-weight: 700; color: #1e40af; margin-bottom: 12px;">CONFLICT RESOLUTION (CRDTs)</div>
                    <div class="flow-row">
                        <div class="flow-node user">User A (US)<br><small>Book slot X</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node db">Region US<br><small>Write locally</small></div>
                        <div class="flow-arrow" style="color: #ef4444;">conflict</div>
                        <div class="flow-node db">Region EU<br><small>User B wrote</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node service">Resolver<br><small>Last-write-wins</small></div>
                        <div class="flow-arrow">-></div>
                        <div class="flow-node user">Notify Loser<br><small>Offer alternative</small></div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                <strong>CRDT-based Slot Counter:</strong>
                <div style="font-family: monospace; font-size: 13px; margin-top: 8px;">
                    // G-Counter (Grow-only Counter) for waitlist position<br>
                    Region US: {US: 5, EU: 0, APAC: 0} --> total = 5<br>
                    Region EU: {US: 5, EU: 3, APAC: 0} --> total = 8<br>
                    Merge: max per region --> {US: 5, EU: 3, APAC: 0} = 8
                </div>
            </div>
        </div>

        <!-- DB EVOLUTION -->
        <div class="db-evolution">
            <h4>Database Evolution - Global Focus</h4>
            <div class="evolution-timeline">
                <div class="evolution-stage">
                    <div class="evolution-icon mvp">SINGLE</div>
                    <div class="evolution-label">Single Region</div>
                    <div class="evolution-db">PostgreSQL</div>
                    <div class="evolution-detail">One region<br>High latency globally<br>Single point of failure</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon pan-india">REPLICA</div>
                    <div class="evolution-label">Read Replicas</div>
                    <div class="evolution-db">Aurora + Replicas</div>
                    <div class="evolution-detail">Reads from nearest<br>Writes to primary<br>100-200ms write latency</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon high-traffic">GLOBAL</div>
                    <div class="evolution-label">Aurora Global</div>
                    <div class="evolution-db">Aurora Global DB</div>
                    <div class="evolution-detail">Sub-second replication<br>Promote replica on failover<br>Single writer</div>
                </div>
                <div class="evolution-arrow">-></div>
                <div class="evolution-stage">
                    <div class="evolution-icon global">CRDT</div>
                    <div class="evolution-label">Active-Active</div>
                    <div class="evolution-db">CockroachDB / CRDTs</div>
                    <div class="evolution-detail">Multi-writer<br>Conflict-free<br>True global scale</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tooltip System -->
<div class="tooltip-overlay" id="tooltipOverlay" onclick="closeTooltip()"></div>
<div class="tooltip-popup" id="tooltipPopup">
    <button class="tooltip-close" onclick="closeTooltip()">&times;</button>
    <h4 id="tooltipTitle"></h4>
    <div id="tooltipContent"></div>
</div>

<script>
const termDefinitions = {
    'optimistic-lock': {
        title: 'Optimistic Locking',
        content: `<p>A concurrency control method that allows multiple transactions to proceed without locking, checking for conflicts only at commit time.</p>
        <div style="margin-top: 12px;">
            <strong>How it works:</strong>
            <ol style="margin: 8px 0; padding-left: 20px; font-size: 14px;">
                <li>Read row with version number</li>
                <li>Perform business logic</li>
                <li>UPDATE ... WHERE version = expected_version</li>
                <li>If 0 rows affected → conflict, retry</li>
            </ol>
        </div>`
    },
    'pessimistic-lock': {
        title: 'Pessimistic Locking',
        content: `<p>Locks the row immediately when read, preventing other transactions from modifying it.</p>
        <div style="margin-top: 12px;">
            <strong>SQL:</strong>
            <pre style="background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; font-size: 13px;">SELECT * FROM slots WHERE id = $1 FOR UPDATE;</pre>
        </div>`
    }
};

function showTooltip(term) {
    const def = termDefinitions[term];
    if (def) {
        document.getElementById('tooltipTitle').textContent = def.title;
        document.getElementById('tooltipContent').innerHTML = def.content;
        document.getElementById('tooltipOverlay').classList.add('show');
        document.getElementById('tooltipPopup').classList.add('show');
    }
}

function closeTooltip() {
    document.getElementById('tooltipOverlay').classList.remove('show');
    document.getElementById('tooltipPopup').classList.remove('show');
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeTooltip(); });

// Scroll spy
window.addEventListener('scroll', function() {
    const sections = document.querySelectorAll('.stage-section');
    const navLinks = document.querySelectorAll('.quick-nav a');
    let current = '';
    sections.forEach(section => {
        if (scrollY >= section.offsetTop - 200) current = section.id;
    });
    navLinks.forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === '#' + current);
    });
});
</script>
