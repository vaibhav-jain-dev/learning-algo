<style>
/* Interview Questions Page Styles */
.interview-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 24px;
    min-height: calc(100vh - 80px);
    padding: 24px;
    max-width: 1600px;
    margin: 0 auto;
}

.interview-nav {
    position: sticky;
    top: 100px;
    height: fit-content;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 16px;
    padding: 20px;
}

.interview-nav h2 {
    font-size: 16px;
    color: #1e293b;
    margin: 0 0 16px 0;
    padding-bottom: 12px;
    border-bottom: 2px solid #e2e8f0;
}

.system-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.system-list li {
    margin-bottom: 8px;
}

.system-link {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    border-radius: 10px;
    text-decoration: none;
    color: #475569;
    font-weight: 500;
    transition: all 0.2s ease;
    cursor: pointer;
}

.system-link:hover {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
}

.system-link.active {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.system-link .icon {
    font-size: 20px;
}

.interview-content {
    background: white;
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

/* Section Navigation within each system */
.section-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #e2e8f0;
}

.section-tab {
    padding: 8px 16px;
    border-radius: 8px;
    background: #f1f5f9;
    color: #475569;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

.section-tab:hover {
    background: #e2e8f0;
}

.section-tab.active {
    background: #3b82f6;
    color: white;
}

/* Term Tooltip */
.term-tooltip {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    color: #2563eb;
    cursor: pointer;
    font-weight: 600;
    border-bottom: 1px dashed #2563eb;
}

.term-tooltip .info-icon {
    font-size: 12px;
    width: 16px;
    height: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #2563eb;
    color: white;
    border-radius: 50%;
}

.tooltip-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    max-width: 500px;
    width: 90%;
}

.tooltip-popup.show {
    display: block;
}

.tooltip-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
}

.tooltip-overlay.show {
    display: block;
}

.tooltip-popup h4 {
    margin: 0 0 12px 0;
    color: #1e293b;
    font-size: 18px;
}

.tooltip-popup p {
    color: #475569;
    line-height: 1.7;
    margin: 0;
}

.tooltip-close {
    position: absolute;
    top: 12px;
    right: 12px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #94a3b8;
}

/* Diagram Container */
.diagram-container {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    padding: 24px;
    margin: 20px 0;
    overflow-x: auto;
}

.diagram-container h4 {
    text-align: center;
    color: #1e293b;
    margin: 0 0 20px 0;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Architecture Box Styles */
.arch-box {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    text-align: center;
}

.arch-box.client { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; }
.arch-box.server { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
.arch-box.db { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
.arch-box.cache { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
.arch-box.queue { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; }
.arch-box.cdn { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; }
.arch-box.lb { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; }

/* Arrow Styles */
.arch-arrow {
    color: #64748b;
    font-size: 20px;
    margin: 0 8px;
}

/* Section Styles */
.system-section {
    display: none;
}

.system-section.active {
    display: block;
}

.stage-section {
    margin-bottom: 40px;
    padding-bottom: 40px;
    border-bottom: 2px solid #e2e8f0;
}

.stage-section:last-child {
    border-bottom: none;
}

.stage-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
}

.stage-badge {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.stage-badge.mvp { background: #dcfce7; color: #166534; }
.stage-badge.pan-india { background: #dbeafe; color: #1e40af; }
.stage-badge.high-traffic { background: #fef3c7; color: #92400e; }
.stage-badge.global { background: #ede9fe; color: #5b21b6; }

/* Feature Card */
.feature-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin: 16px 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border-left: 4px solid #3b82f6;
}

.feature-card h4 {
    margin: 0 0 16px 0;
    color: #1e293b;
}

/* Pros/Cons Grid */
.pros-cons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin: 24px 0;
}

.pros-section, .cons-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
}

.pros-section {
    border: 2px solid #22c55e;
}

.cons-section {
    border: 2px solid #ef4444;
}

.pros-section h4 { color: #166534; }
.cons-section h4 { color: #991b1b; }

.care-points, .manage-points {
    background: #f8fafc;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
}

.care-points h5 { color: #059669; font-size: 12px; margin: 0 0 8px 0; }
.manage-points h5 { color: #dc2626; font-size: 12px; margin: 0 0 8px 0; }

/* API Design */
.api-endpoint {
    background: #1e293b;
    color: #e2e8f0;
    padding: 16px;
    border-radius: 8px;
    margin: 12px 0;
    font-family: monospace;
}

.api-method {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 12px;
    margin-right: 8px;
}

.api-method.get { background: #22c55e; color: white; }
.api-method.post { background: #3b82f6; color: white; }
.api-method.put { background: #f59e0b; color: white; }
.api-method.delete { background: #ef4444; color: white; }

/* Mobile Responsiveness */
@media (max-width: 900px) {
    .interview-layout {
        grid-template-columns: 1fr;
    }

    .interview-nav {
        position: relative;
        top: 0;
    }
}

/* Schema Diagram */
.schema-diagram {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    align-items: flex-start;
}

.schema-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    min-width: 200px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.schema-table-header {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    padding: 10px 16px;
    font-weight: 600;
    font-size: 14px;
}

.schema-table-body {
    padding: 12px 16px;
}

.schema-field {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    font-size: 12px;
    border-bottom: 1px solid #e2e8f0;
}

.schema-field:last-child {
    border-bottom: none;
}

.field-name { color: #1e293b; font-weight: 500; }
.field-type { color: #64748b; }
.field-pk { color: #f59e0b; font-weight: 600; }
.field-fk { color: #8b5cf6; font-weight: 600; }

.relation-arrow {
    display: flex;
    align-items: center;
    color: #64748b;
    font-size: 24px;
}
</style>

<div class="interview-layout">
    <!-- Left Navigation -->
    <nav class="interview-nav">
        <h2>üß† System Design Problems</h2>
        <ul class="system-list">
            <li><a class="system-link active" onclick="showSystem('url-shortener')" data-system="url-shortener"><span class="icon">üîó</span> URL Shortener</a></li>
            <li><a class="system-link" onclick="showSystem('parking-lot')" data-system="parking-lot"><span class="icon">üÖøÔ∏è</span> Parking Lot System</a></li>
            <li><a class="system-link" onclick="showSystem('ride-booking')" data-system="ride-booking"><span class="icon">üöó</span> Ride Booking System</a></li>
            <li><a class="system-link" onclick="showSystem('notification')" data-system="notification"><span class="icon">üîî</span> Notification System</a></li>
            <li><a class="system-link" onclick="showSystem('rate-limiter')" data-system="rate-limiter"><span class="icon">‚è±Ô∏è</span> Rate Limiter</a></li>
            <li><a class="system-link" onclick="showSystem('food-ordering')" data-system="food-ordering"><span class="icon">üçî</span> Food Ordering System</a></li>
            <li><a class="system-link" onclick="showSystem('slot-booking')" data-system="slot-booking"><span class="icon">üìÖ</span> Slot Booking System</a></li>
        </ul>

        <div style="margin-top: 24px; padding-top: 16px; border-top: 2px solid #e2e8f0;">
            <h3 style="font-size: 14px; color: #64748b; margin: 0 0 12px 0;">üìë Quick Navigation</h3>
            <div id="stage-nav" style="display: flex; flex-direction: column; gap: 6px;">
                <a href="#mvp" class="section-tab" style="text-align: left; display: block;">1Ô∏è‚É£ MVP Stage</a>
                <a href="#pan-india" class="section-tab" style="text-align: left; display: block;">2Ô∏è‚É£ PAN-India Scale</a>
                <a href="#high-traffic" class="section-tab" style="text-align: left; display: block;">3Ô∏è‚É£ High Traffic</a>
                <a href="#global" class="section-tab" style="text-align: left; display: block;">4Ô∏è‚É£ Global Scale</a>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="interview-content">
        <!-- URL Shortener Section -->
        <div id="url-shortener" class="system-section active">
            <h1>üîó URL Shortener System Design</h1>
            <p style="color: #64748b; margin-bottom: 24px;">Design a URL shortening service like bit.ly or TinyURL that handles billions of redirects</p>

            <div id="url-shortener-content">
                <!-- MVP STAGE -->
                <div class="stage-section" id="mvp">
                    <div class="stage-header">
                        <span class="stage-badge mvp">MVP Stage</span>
                        <h2 style="margin: 0;">Minimum Viable Product</h2>
                    </div>

                    <h3>üìä Database Strategy</h3>
                    <div class="feature-card">
                        <h4>Why PostgreSQL?</h4>
                        <p>For MVP, we choose <span class="term-tooltip" onclick="showTooltip('database-index')">PostgreSQL<span class="info-icon">i</span></span> for its ACID compliance, robust indexing, and proven reliability.</p>

                        <div class="pros-cons-grid">
                            <div class="pros-section">
                                <h4>‚úÖ Pros</h4>
                                <ul>
                                    <li><strong>ACID Compliance</strong> - Guaranteed data consistency</li>
                                    <li><strong>Rich Indexing</strong> - B-tree indexes for fast lookups</li>
                                    <li><strong>Mature Ecosystem</strong> - Extensive tooling and community</li>
                                </ul>
                                <div class="care-points">
                                    <h5>‚ö†Ô∏è What to Care About:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>Set up connection pooling (PgBouncer) from day 1</li>
                                        <li>Configure proper vacuum settings for high-write tables</li>
                                        <li>Monitor slow queries with pg_stat_statements</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="cons-section">
                                <h4>‚ùå Cons</h4>
                                <ul>
                                    <li><strong>Vertical Scaling</strong> - Single node limits</li>
                                    <li><strong>Write Bottleneck</strong> - Single primary for writes</li>
                                    <li><strong>Complex Sharding</strong> - Not native support</li>
                                </ul>
                                <div class="manage-points">
                                    <h5>üîß How to Manage:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>Plan for read replicas early in design</li>
                                        <li>Use Citus extension for future sharding</li>
                                        <li>Implement caching layer to reduce DB load</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <h4 style="margin-top: 24px;">Schema Design</h4>
                        <div class="diagram-container">
                            <h4>DATABASE SCHEMA</h4>
                            <div class="schema-diagram">
                                <div class="schema-table">
                                    <div class="schema-table-header">urls</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">BIGSERIAL PK</span></div>
                                        <div class="schema-field"><span class="field-name">short_code</span><span class="field-type">VARCHAR(8) UNIQUE</span></div>
                                        <div class="schema-field"><span class="field-name">original_url</span><span class="field-type">TEXT NOT NULL</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">BIGINT FK</span></div>
                                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMP</span></div>
                                        <div class="schema-field"><span class="field-name">expires_at</span><span class="field-type">TIMESTAMP</span></div>
                                        <div class="schema-field"><span class="field-name">click_count</span><span class="field-type">BIGINT DEFAULT 0</span></div>
                                    </div>
                                </div>
                                <div class="relation-arrow">1:N ‚Üê</div>
                                <div class="schema-table">
                                    <div class="schema-table-header">users</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">BIGSERIAL PK</span></div>
                                        <div class="schema-field"><span class="field-name">email</span><span class="field-type">VARCHAR(255)</span></div>
                                        <div class="schema-field"><span class="field-name">api_key</span><span class="field-type">VARCHAR(64)</span></div>
                                        <div class="schema-field"><span class="field-name">tier</span><span class="field-type">ENUM</span></div>
                                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMP</span></div>
                                    </div>
                                </div>
                            </div>
                            <p style="text-align: center; color: #64748b; font-size: 12px; margin-top: 16px;">Index on short_code (B-tree) for O(log n) lookups</p>
                        </div>
                    </div>

                    <h3>üèóÔ∏è Architecture (MVP)</h3>
                    <div class="diagram-container">
                        <h4>MVP ARCHITECTURE</h4>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;">
                            <div class="arch-box client">Browser/Client</div>
                            <span class="arch-arrow">‚Üí</span>
                            <div class="arch-box server">API Server (Go/Node)</div>
                            <span class="arch-arrow">‚Üí</span>
                            <div class="arch-box db">PostgreSQL</div>
                        </div>
                        <p style="text-align: center; color: #64748b; font-size: 13px; margin-top: 16px;">Simple 3-tier architecture for MVP. Single server handles ~1000 req/sec</p>
                    </div>

                    <h3>üîå API Design</h3>
                    <div class="feature-card">
                        <div class="api-endpoint">
                            <span class="api-method post">POST</span> /api/v1/shorten
                            <pre style="margin: 12px 0 0 0; color: #94a3b8;">
Request:  { "url": "https://example.com/very/long/path", "custom_alias": "mylink" }
Response: { "short_url": "https://short.ly/abc123", "expires_at": "2024-12-31" }</pre>
                        </div>
                        <p><strong>DB Impact:</strong> 1 INSERT to urls table</p>
                        <p><strong>Concurrency:</strong> Use <span class="term-tooltip" onclick="showTooltip('idempotency')">idempotency key<span class="info-icon">i</span></span> to prevent duplicate URLs</p>

                        <div class="api-endpoint">
                            <span class="api-method get">GET</span> /:shortCode
                            <pre style="margin: 12px 0 0 0; color: #94a3b8;">
Response: 301 Redirect to original_url
Headers:  Location: https://example.com/very/long/path</pre>
                        </div>
                        <p><strong>DB Impact:</strong> 1 SELECT + 1 UPDATE (increment click_count)</p>
                        <p><strong>Optimization:</strong> Use async click tracking to not block redirect</p>
                    </div>

                    <h3>üíæ Caching Strategy</h3>
                    <div class="feature-card">
                        <p>Use <span class="term-tooltip" onclick="showTooltip('redis')">Redis<span class="info-icon">i</span></span> for caching URL mappings with TTL-based invalidation.</p>

                        <div class="diagram-container">
                            <h4>CACHE FLOW</h4>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;">
                                <div class="arch-box client">Request</div>
                                <span class="arch-arrow">‚Üí</span>
                                <div class="arch-box cache">Redis (Check)</div>
                                <span class="arch-arrow">‚Üí miss ‚Üí</span>
                                <div class="arch-box db">PostgreSQL</div>
                                <span class="arch-arrow">‚Üí populate ‚Üí</span>
                                <div class="arch-box cache">Redis</div>
                            </div>
                        </div>

                        <h4>Cache Invalidation Strategy</h4>
                        <ul>
                            <li><strong>TTL-based:</strong> Cache entries expire after 24 hours</li>
                            <li><strong>Event-driven:</strong> On URL delete, publish to Redis pub/sub</li>
                            <li><strong>Write-through:</strong> Update cache on every URL creation</li>
                        </ul>

                        <div class="pros-cons-grid">
                            <div class="pros-section">
                                <h4>‚úÖ Cache Benefits</h4>
                                <ul>
                                    <li>99% cache hit rate for popular URLs</li>
                                    <li>Sub-millisecond redirect latency</li>
                                    <li>Reduces DB load by 95%</li>
                                </ul>
                            </div>
                            <div class="cons-section">
                                <h4>‚ùå Cache Risks</h4>
                                <ul>
                                    <li>Stale data if invalidation fails</li>
                                    <li>Cache stampede on cold start</li>
                                    <li>Memory costs for large datasets</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Addition 1 -->
                    <h3>üÜï Feature Addition 1: Analytics Dashboard</h3>
                    <div class="feature-card" style="border-left-color: #22c55e;">
                        <h4>Why Add Analytics?</h4>
                        <p>Users want to track click counts, geographic distribution, and referrers.</p>

                        <div class="diagram-container">
                            <h4>BEFORE vs AFTER</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                                <div>
                                    <h5 style="color: #ef4444; text-align: center;">Before</h5>
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                        <div class="arch-box server">API Server</div>
                                        <span>‚Üì</span>
                                        <div class="arch-box db">PostgreSQL</div>
                                    </div>
                                </div>
                                <div>
                                    <h5 style="color: #22c55e; text-align: center;">After</h5>
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                        <div class="arch-box server">API Server</div>
                                        <span>‚Üì</span>
                                        <div class="arch-box queue">Kafka</div>
                                        <span>‚Üì</span>
                                        <div style="display: flex; gap: 12px;">
                                            <div class="arch-box db">PostgreSQL</div>
                                            <div class="arch-box db" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">ClickHouse</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h4>New Components</h4>
                        <ul>
                            <li><strong><span class="term-tooltip" onclick="showTooltip('kafka')">Kafka<span class="info-icon">i</span></span>:</strong> Async event streaming for click events</li>
                            <li><strong>ClickHouse:</strong> Columnar DB for analytics queries</li>
                            <li><strong>Analytics API:</strong> New endpoints for dashboard data</li>
                        </ul>

                        <h4>Deployment Strategy</h4>
                        <p>Blue-green deployment with feature flag. Roll out to 5% users, monitor error rates, then full rollout.</p>

                        <h4>Rollback Strategy</h4>
                        <p>Disable feature flag instantly. Kafka consumer pauses. Analytics data preserved for retry.</p>
                    </div>

                    <!-- Feature Addition 2 -->
                    <h3>üÜï Feature Addition 2: Custom Domains</h3>
                    <div class="feature-card" style="border-left-color: #8b5cf6;">
                        <h4>Why Add Custom Domains?</h4>
                        <p>Enterprise users want branded short URLs (e.g., go.company.com/sale)</p>

                        <h4>Architecture Changes</h4>
                        <ul>
                            <li>Add <code>domains</code> table with SSL cert storage</li>
                            <li>Integrate Let's Encrypt for auto SSL provisioning</li>
                            <li>Add DNS verification workflow</li>
                            <li>Update routing to match domain + short_code</li>
                        </ul>

                        <div class="pros-cons-grid">
                            <div class="pros-section">
                                <h4>‚úÖ Pros</h4>
                                <ul>
                                    <li>Higher trust with branded domains</li>
                                    <li>Premium feature for monetization</li>
                                    <li>Better click-through rates</li>
                                </ul>
                                <div class="care-points">
                                    <h5>‚ö†Ô∏è What to Care About:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>SSL certificate renewal automation</li>
                                        <li>DNS propagation delays (up to 48h)</li>
                                        <li>Domain verification security</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="cons-section">
                                <h4>‚ùå Cons</h4>
                                <ul>
                                    <li>Complex SSL management</li>
                                    <li>Support burden for DNS issues</li>
                                    <li>Increased infrastructure cost</li>
                                </ul>
                                <div class="manage-points">
                                    <h5>üîß How to Manage:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>Use Caddy or cert-manager for auto SSL</li>
                                        <li>Build self-service DNS troubleshooter</li>
                                        <li>Tier pricing to offset costs</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Addition 3 -->
                    <h3>üÜï Feature Addition 3: Link Expiration & Password Protection</h3>
                    <div class="feature-card" style="border-left-color: #f59e0b;">
                        <h4>Why Add This?</h4>
                        <p>Security-conscious users need time-limited and password-protected links.</p>

                        <h4>Data Flow Changes</h4>
                        <div class="diagram-container">
                            <h4>PROTECTED LINK FLOW</h4>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">
                                <div class="arch-box client">User</div>
                                <span class="arch-arrow">‚Üí</span>
                                <div class="arch-box server">Check Expiry</div>
                                <span class="arch-arrow">‚Üí</span>
                                <div class="arch-box server">Check Password</div>
                                <span class="arch-arrow">‚Üí</span>
                                <div class="arch-box client">Redirect</div>
                            </div>
                        </div>

                        <h4>Schema Changes</h4>
                        <pre style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; overflow-x: auto;">
ALTER TABLE urls ADD COLUMN password_hash VARCHAR(255);
ALTER TABLE urls ADD COLUMN max_clicks INT;
ALTER TABLE urls ADD COLUMN is_active BOOLEAN DEFAULT true;
CREATE INDEX idx_urls_active ON urls(is_active, expires_at);</pre>
                    </div>

                    <!-- Feature Reversion -->
                    <h3>üîô Feature Reversion: Rolling Back Analytics</h3>
                    <div class="feature-card" style="border-left-color: #ef4444;">
                        <h4>Why Revert?</h4>
                        <p>Kafka cluster instability causing 5% of clicks to be lost. Need to stabilize before re-enabling.</p>

                        <h4>Reversion Strategy</h4>
                        <ol>
                            <li>Disable analytics feature flag (instant)</li>
                            <li>Switch click tracking back to sync PostgreSQL writes</li>
                            <li>Keep Kafka running to not lose queued events</li>
                            <li>Historical analytics remain accessible (read-only)</li>
                        </ol>

                        <h4>User Impact</h4>
                        <ul>
                            <li>Dashboard shows "Analytics temporarily unavailable"</li>
                            <li>Click counts still increment (via PostgreSQL)</li>
                            <li>Enterprise users notified via email</li>
                        </ul>

                        <h4>Backward Compatibility</h4>
                        <p>API endpoints return cached data with <code>stale: true</code> flag. Clients can show "Data may be outdated" warning.</p>
                    </div>
                </div>

                <!-- PAN-INDIA SCALE -->
                <div class="stage-section" id="pan-india">
                    <div class="stage-header">
                        <span class="stage-badge pan-india">PAN-India Scale</span>
                        <h2 style="margin: 0;">Regional Expansion</h2>
                    </div>

                    <h3>üó∫Ô∏è Architecture Evolution</h3>
                    <div class="diagram-container">
                        <h4>PAN-INDIA ARCHITECTURE</h4>
                        <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                            <div class="arch-box client">Users (All India)</div>
                            <span>‚Üì</span>
                            <div class="arch-box cdn">CDN (Cloudflare Edge)</div>
                            <span>‚Üì</span>
                            <div class="arch-box lb">Load Balancer (Regional)</div>
                            <span>‚Üì</span>
                            <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;">
                                <div style="text-align: center;">
                                    <div class="arch-box server">API (Mumbai)</div>
                                    <span style="display: block;">‚Üì</span>
                                    <div class="arch-box db">DB Primary</div>
                                </div>
                                <div style="text-align: center;">
                                    <div class="arch-box server">API (Delhi)</div>
                                    <span style="display: block;">‚Üì</span>
                                    <div class="arch-box db" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);">DB Replica</div>
                                </div>
                                <div style="text-align: center;">
                                    <div class="arch-box server">API (Bangalore)</div>
                                    <span style="display: block;">‚Üì</span>
                                    <div class="arch-box db" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);">DB Replica</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3>Key Changes</h3>
                    <div class="feature-card">
                        <ul>
                            <li><strong><span class="term-tooltip" onclick="showTooltip('cdn')">CDN<span class="info-icon">i</span></span> at Edge:</strong> Cache redirects at edge locations. 95% of redirects served without hitting origin.</li>
                            <li><strong><span class="term-tooltip" onclick="showTooltip('replica')">Read Replicas<span class="info-icon">i</span></span>:</strong> PostgreSQL replicas in each region for read queries.</li>
                            <li><strong>Regional <span class="term-tooltip" onclick="showTooltip('load-balancer')">Load Balancers<span class="info-icon">i</span></span>:</strong> Route to nearest healthy server.</li>
                            <li><strong>Redis Cluster:</strong> Distributed cache with consistent hashing.</li>
                        </ul>
                    </div>

                    <h3>üÜï Feature: QR Code Generation</h3>
                    <div class="feature-card" style="border-left-color: #06b6d4;">
                        <h4>Why Add QR Codes?</h4>
                        <p>Indian market heavily uses QR codes for payments (UPI). Adding QR generation increases adoption.</p>

                        <h4>Implementation</h4>
                        <ul>
                            <li>Generate QR on-demand (not pre-computed)</li>
                            <li>Cache generated QR images in CDN</li>
                            <li>Support custom colors and logo embedding</li>
                        </ul>

                        <div class="api-endpoint">
                            <span class="api-method get">GET</span> /api/v1/qr/:shortCode?size=300&color=000000
                            <pre style="margin: 12px 0 0 0; color: #94a3b8;">
Response: image/png (QR code image)
Cache: CDN caches for 7 days</pre>
                        </div>
                    </div>
                </div>

                <!-- HIGH TRAFFIC -->
                <div class="stage-section" id="high-traffic">
                    <div class="stage-header">
                        <span class="stage-badge high-traffic">High Traffic</span>
                        <h2 style="margin: 0;">Handling Massive Scale</h2>
                    </div>

                    <h3>‚ö†Ô∏è What Breaks First?</h3>
                    <div class="feature-card" style="border-left-color: #ef4444;">
                        <ol>
                            <li><strong>Database Writes:</strong> Single primary can't handle 100K writes/sec</li>
                            <li><strong>Short Code Generation:</strong> Counter becomes bottleneck</li>
                            <li><strong>Cache Memory:</strong> 1 billion URLs √ó 100 bytes = 100GB RAM needed</li>
                            <li><strong>Click Tracking:</strong> Kafka partitions max out</li>
                        </ol>
                    </div>

                    <h3>üõ†Ô∏è Solutions</h3>
                    <div class="feature-card">
                        <h4>1. Database <span class="term-tooltip" onclick="showTooltip('sharding')">Sharding<span class="info-icon">i</span></span></h4>
                        <p>Shard by first 2 characters of short_code. 36¬≤ = 1296 logical shards across 16 physical nodes.</p>

                        <div class="diagram-container">
                            <h4>SHARDING STRATEGY</h4>
                            <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                                <div class="schema-table">
                                    <div class="schema-table-header">Shard 0 (aa-az)</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name">aaBc4x</span><span class="field-type">‚Üí https://...</span></div>
                                        <div class="schema-field"><span class="field-name">azKm9p</span><span class="field-type">‚Üí https://...</span></div>
                                    </div>
                                </div>
                                <div class="schema-table">
                                    <div class="schema-table-header">Shard 1 (ba-bz)</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name">baXy2m</span><span class="field-type">‚Üí https://...</span></div>
                                        <div class="schema-field"><span class="field-name">bzPq7n</span><span class="field-type">‚Üí https://...</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h4>2. <span class="term-tooltip" onclick="showTooltip('consistent-hashing')">Consistent Hashing<span class="info-icon">i</span></span> for Cache</h4>
                        <p>Distribute cache keys across Redis cluster. Adding/removing nodes only redistributes K/n keys.</p>

                        <h4>3. Pre-generated Short Codes</h4>
                        <p>Background worker pre-generates 1M short codes. API picks from pool instead of computing.</p>
                    </div>

                    <h3>üìâ Degradation Strategies</h3>
                    <div class="pros-cons-grid">
                        <div class="pros-section">
                            <h4>üü¢ Graceful Degradation</h4>
                            <ul>
                                <li>Disable analytics during peak (writes only)</li>
                                <li>Return cached QR even if stale</li>
                                <li>Queue non-critical operations</li>
                            </ul>
                        </div>
                        <div class="cons-section">
                            <h4>üî¥ Hard Limits</h4>
                            <ul>
                                <li><span class="term-tooltip" onclick="showTooltip('rate-limiting')">Rate limit<span class="info-icon">i</span></span> to 1000 req/sec per user</li>
                                <li>Reject new URLs if queue > 10K</li>
                                <li><span class="term-tooltip" onclick="showTooltip('circuit-breaker')">Circuit breaker<span class="info-icon">i</span></span> for DB connections</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- GLOBAL SCALE -->
                <div class="stage-section" id="global">
                    <div class="stage-header">
                        <span class="stage-badge global">Global Scale</span>
                        <h2 style="margin: 0;">Worldwide Deployment</h2>
                    </div>

                    <div class="diagram-container">
                        <h4>GLOBAL ARCHITECTURE (HIGH-LEVEL)</h4>
                        <div style="display: flex; flex-direction: column; gap: 16px; align-items: center;">
                            <div class="arch-box cdn" style="width: 300px;">Global CDN (Cloudflare/Fastly)</div>
                            <span>‚Üì GeoDNS Routing ‚Üì</span>
                            <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box server" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">US Region</div>
                                <div class="arch-box server" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">EU Region</div>
                                <div class="arch-box server" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">Asia Region</div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>Key Considerations</h4>
                        <ul>
                            <li><strong>Data Locality:</strong> URLs created in EU stay in EU (GDPR compliance)</li>
                            <li><strong>Cross-Region Reads:</strong> <span class="term-tooltip" onclick="showTooltip('eventual-consistency')">Eventually consistent<span class="info-icon">i</span></span> replication for redirects</li>
                            <li><strong>Traffic Routing:</strong> GeoDNS + Anycast for lowest latency</li>
                            <li><strong>Failover:</strong> Region failure routes to nearest healthy region</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parking Lot Section -->
        <div id="parking-lot" class="system-section">
            <h1>üÖøÔ∏è Parking Lot System Design</h1>
            <p style="color: #64748b; margin-bottom: 24px;">Design a smart parking management system with real-time availability tracking</p>

            <div id="parking-lot-content">
                <!-- ==================== MVP STAGE ==================== -->
                <div class="stage-section" id="mvp">
                    <div class="stage-header">
                        <span class="stage-badge mvp">Stage 1</span>
                        <h2>MVP - Single Location Parking Management</h2>
                    </div>

                    <p>Build a basic parking management system for a single parking lot with real-time spot tracking using IoT sensors.</p>

                    <!-- Database Schema -->
                    <h3>Database Schema Design</h3>
                    <div class="diagram-container">
                        <h4>Core Tables and Relationships</h4>
                        <div class="schema-diagram">
                            <div class="schema-table">
                                <div class="schema-table-header">parking_lots</div>
                                <div class="schema-table-body">
                                    <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                    <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR(255)</span></div>
                                    <div class="schema-field"><span class="field-name">address</span><span class="field-type">TEXT</span></div>
                                    <div class="schema-field"><span class="field-name">latitude</span><span class="field-type">DECIMAL(10,8)</span></div>
                                    <div class="schema-field"><span class="field-name">longitude</span><span class="field-type">DECIMAL(11,8)</span></div>
                                    <div class="schema-field"><span class="field-name">total_capacity</span><span class="field-type">INT</span></div>
                                    <div class="schema-field"><span class="field-name">hourly_rate</span><span class="field-type">DECIMAL(8,2)</span></div>
                                    <div class="schema-field"><span class="field-name">operating_hours</span><span class="field-type">JSONB</span></div>
                                    <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMP</span></div>
                                </div>
                            </div>

                            <div class="relation-arrow">1 : N</div>

                            <div class="schema-table">
                                <div class="schema-table-header">parking_spots</div>
                                <div class="schema-table-body">
                                    <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                    <div class="schema-field"><span class="field-name field-fk">lot_id</span><span class="field-type">UUID FK</span></div>
                                    <div class="schema-field"><span class="field-name">spot_number</span><span class="field-type">VARCHAR(10)</span></div>
                                    <div class="schema-field"><span class="field-name">floor</span><span class="field-type">INT</span></div>
                                    <div class="schema-field"><span class="field-name">zone</span><span class="field-type">VARCHAR(10)</span></div>
                                    <div class="schema-field"><span class="field-name">spot_type</span><span class="field-type">ENUM</span></div>
                                    <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM</span></div>
                                    <div class="schema-field"><span class="field-name">sensor_id</span><span class="field-type">VARCHAR(50)</span></div>
                                    <div class="schema-field"><span class="field-name">is_active</span><span class="field-type">BOOLEAN</span></div>
                                </div>
                            </div>

                            <div class="relation-arrow">1 : N</div>

                            <div class="schema-table">
                                <div class="schema-table-header">bookings</div>
                                <div class="schema-table-body">
                                    <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                    <div class="schema-field"><span class="field-name field-fk">spot_id</span><span class="field-type">UUID FK</span></div>
                                    <div class="schema-field"><span class="field-name field-fk">vehicle_id</span><span class="field-type">UUID FK</span></div>
                                    <div class="schema-field"><span class="field-name">check_in_time</span><span class="field-type">TIMESTAMP</span></div>
                                    <div class="schema-field"><span class="field-name">check_out_time</span><span class="field-type">TIMESTAMP</span></div>
                                    <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM</span></div>
                                    <div class="schema-field"><span class="field-name">amount</span><span class="field-type">DECIMAL(10,2)</span></div>
                                    <div class="schema-field"><span class="field-name">payment_status</span><span class="field-type">ENUM</span></div>
                                </div>
                            </div>
                        </div>

                        <div class="schema-diagram" style="margin-top: 20px;">
                            <div class="schema-table">
                                <div class="schema-table-header">vehicles</div>
                                <div class="schema-table-body">
                                    <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                    <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK</span></div>
                                    <div class="schema-field"><span class="field-name">license_plate</span><span class="field-type">VARCHAR(20)</span></div>
                                    <div class="schema-field"><span class="field-name">vehicle_type</span><span class="field-type">ENUM</span></div>
                                    <div class="schema-field"><span class="field-name">make</span><span class="field-type">VARCHAR(50)</span></div>
                                    <div class="schema-field"><span class="field-name">model</span><span class="field-type">VARCHAR(50)</span></div>
                                    <div class="schema-field"><span class="field-name">color</span><span class="field-type">VARCHAR(30)</span></div>
                                    <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMP</span></div>
                                </div>
                            </div>

                            <div class="relation-arrow">N : 1</div>

                            <div class="schema-table">
                                <div class="schema-table-header">users</div>
                                <div class="schema-table-body">
                                    <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                    <div class="schema-field"><span class="field-name">email</span><span class="field-type">VARCHAR(255)</span></div>
                                    <div class="schema-field"><span class="field-name">phone</span><span class="field-type">VARCHAR(15)</span></div>
                                    <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR(100)</span></div>
                                    <div class="schema-field"><span class="field-name">password_hash</span><span class="field-type">VARCHAR(255)</span></div>
                                    <div class="schema-field"><span class="field-name">wallet_balance</span><span class="field-type">DECIMAL(10,2)</span></div>
                                    <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMP</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- High Level Design -->
                    <h3>High-Level Design (HLD)</h3>
                    <div class="diagram-container">
                        <h4>MVP Architecture with IoT Sensors</h4>
                        <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                            <!-- Layer 1: Clients -->
                            <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box client">Mobile App</div>
                                <div class="arch-box client">Kiosk Terminal</div>
                                <div class="arch-box client">Admin Dashboard</div>
                            </div>
                            <div class="arch-arrow" style="transform: rotate(90deg);">--></div>

                            <!-- Layer 2: API Gateway -->
                            <div class="arch-box lb">API Gateway / Load Balancer</div>
                            <div class="arch-arrow" style="transform: rotate(90deg);">--></div>

                            <!-- Layer 3: Services -->
                            <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box server">Parking Service</div>
                                <div class="arch-box server">Booking Service</div>
                                <div class="arch-box server">Payment Service</div>
                            </div>
                            <div class="arch-arrow" style="transform: rotate(90deg);">--></div>

                            <!-- Layer 4: Data Layer -->
                            <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box cache">Redis Cache</div>
                                <div class="arch-box db">PostgreSQL</div>
                                <div class="arch-box queue">Message Queue</div>
                            </div>
                        </div>

                        <!-- IoT Sensor Flow -->
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px dashed #e2e8f0;">
                            <h4>IoT Sensor Data Flow</h4>
                            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">Ultrasonic Sensor</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white;">Edge Gateway</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box queue">MQTT Broker</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box server">Sensor Processor</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box cache">Redis (Real-time)</div>
                            </div>
                        </div>
                    </div>

                    <!-- API Design -->
                    <h3>Core API Endpoints</h3>
                    <div class="feature-card">
                        <h4>1. Get Available Spots</h4>
                        <div class="api-endpoint">
                            <span class="api-method get">GET</span>
                            <span>/api/v1/lots/{lot_id}/spots/available?vehicle_type=car&floor=2</span>
                        </div>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 13px;">
// Response
{
  "lot_id": "uuid-123",
  "available_count": 45,
  "total_capacity": 200,
  "spots": [
    {
      "spot_id": "spot-001",
      "spot_number": "A-101",
      "floor": 2,
      "zone": "A",
      "type": "regular",
      "distance_to_exit": 50
    }
  ],
  "last_updated": "2024-01-15T10:30:00Z"
}</pre>
                    </div>

                    <div class="feature-card">
                        <h4>2. Book a Spot</h4>
                        <div class="api-endpoint">
                            <span class="api-method post">POST</span>
                            <span>/api/v1/bookings</span>
                        </div>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 13px;">
// Request
{
  "lot_id": "uuid-123",
  "spot_id": "spot-001",        // Optional: auto-assign if null
  "vehicle_id": "vehicle-456",
  "expected_duration_hours": 3
}

// Response
{
  "booking_id": "booking-789",
  "spot": {
    "spot_number": "A-101",
    "floor": 2,
    "directions": "Enter Gate A, turn left, spot on right"
  },
  "check_in_time": "2024-01-15T10:35:00Z",
  "estimated_cost": 150.00,
  "qr_code": "base64_encoded_qr"
}</pre>
                    </div>

                    <div class="feature-card">
                        <h4>3. Checkout</h4>
                        <div class="api-endpoint">
                            <span class="api-method post">POST</span>
                            <span>/api/v1/bookings/{booking_id}/checkout</span>
                        </div>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 13px;">
// Request
{
  "payment_method": "wallet",   // wallet | card | upi
  "promo_code": "FIRST50"       // Optional
}

// Response
{
  "booking_id": "booking-789",
  "duration_minutes": 185,
  "base_amount": 155.00,
  "discount": 50.00,
  "final_amount": 105.00,
  "payment_status": "completed",
  "exit_code": "EXIT-7891",
  "receipt_url": "https://..."
}</pre>
                    </div>

                    <!-- Real-time Availability Updates -->
                    <h3>Real-time Spot Availability</h3>
                    <div class="feature-card">
                        <h4>WebSocket-based Live Updates</h4>
                        <div class="diagram-container" style="margin: 0;">
                            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box" style="background: #10b981; color: white;">IoT Sensor</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box queue">Redis Pub/Sub</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box server">WebSocket Server</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box client">Mobile App</div>
                            </div>
                        </div>
                        <pre style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; margin-top: 16px; overflow-x: auto; font-size: 13px;">
// WebSocket subscription
ws.send(JSON.stringify({
  action: "subscribe",
  channel: "lot:uuid-123:availability"
}));

// Real-time update received
{
  "event": "spot_status_changed",
  "data": {
    "spot_id": "spot-001",
    "old_status": "available",
    "new_status": "occupied",
    "lot_available_count": 44,
    "timestamp": "2024-01-15T10:36:00Z"
  }
}</pre>
                    </div>

                    <!-- Cache Invalidation Strategy -->
                    <h3>Cache Invalidation for Real-time Availability</h3>
                    <div class="feature-card">
                        <h4>
                            <span class="term-tooltip" onclick="showTooltip('redis')">Redis<span class="info-icon">i</span></span>
                            Cache Strategy
                        </h4>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 13px;">
// Cache Keys Structure
lot:{lot_id}:availability      -> { available: 45, total: 200 }  TTL: 30s
lot:{lot_id}:spots             -> [spot objects array]           TTL: 60s
spot:{spot_id}:status          -> "available" | "occupied"       TTL: none (event-driven)

// Invalidation Triggers
1. Sensor Status Change:
   - Update spot:{spot_id}:status immediately
   - Increment/Decrement lot:{lot_id}:availability atomically
   - Publish to Redis Pub/Sub channel

2. Booking Created:
   - Invalidate spot:{spot_id}:status
   - Update lot:{lot_id}:availability
   - Set pessimistic lock for 5 minutes

3. Checkout Completed:
   - Wait for sensor confirmation (max 2 min)
   - If sensor confirms: update cache
   - If sensor timeout: mark spot as "pending_verification"</pre>
                    </div>

                    <!-- Decision: IoT Protocol Choice -->
                    <h3>Key Decision: IoT Communication Protocol</h3>
                    <div class="pros-cons-grid">
                        <div class="pros-section">
                            <h4>Pros of MQTT Protocol</h4>
                            <ul>
                                <li><strong>Lightweight:</strong> Minimal overhead, perfect for battery-powered sensors</li>
                                <li><strong>Reliable Delivery:</strong> QoS levels ensure message delivery even on unstable networks</li>
                                <li><strong>Bi-directional:</strong> Can send commands to sensors (calibration, status check)</li>
                            </ul>
                            <div class="care-points">
                                <h5>What to Care About</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>MQTT broker becomes single point of failure - need clustering</li>
                                    <li>Message ordering not guaranteed across topics</li>
                                    <li>Need TLS for security - adds CPU overhead on edge devices</li>
                                </ul>
                            </div>
                        </div>
                        <div class="cons-section">
                            <h4>Cons of MQTT Protocol</h4>
                            <ul>
                                <li><strong>Broker Dependency:</strong> Requires always-on broker infrastructure</li>
                                <li><strong>No Native HTTP:</strong> Need protocol translation for REST APIs</li>
                                <li><strong>Limited Tooling:</strong> Debugging is harder than HTTP-based systems</li>
                            </ul>
                            <div class="manage-points">
                                <h5>How to Manage</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>Use managed MQTT (AWS IoT Core, HiveMQ Cloud)</li>
                                    <li>Build MQTT-to-HTTP bridge service for API integration</li>
                                    <li>Implement comprehensive logging at edge gateway level</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- FEATURE 1: VIP Spots -->
                    <h3>Feature Addition 1: VIP/Premium Spots</h3>
                    <div class="feature-card" style="border-left-color: #22c55e;">
                        <h4>Before: Uniform Spot Pricing</h4>
                        <div class="diagram-container" style="margin: 12px 0;">
                            <div style="display: flex; gap: 12px; align-items: center; justify-content: center;">
                                <div class="arch-box db">parking_spots</div>
                                <div style="padding: 8px; background: white; border-radius: 8px; font-size: 12px;">
                                    spot_type: ENUM('regular', 'handicapped', 'ev_charging')
                                </div>
                            </div>
                        </div>

                        <h4 style="margin-top: 20px;">After: Tiered Spot System</h4>
                        <div class="diagram-container" style="margin: 12px 0;">
                            <div class="schema-diagram">
                                <div class="schema-table">
                                    <div class="schema-table-header">spot_tiers</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR</span></div>
                                        <div class="schema-field"><span class="field-name">price_multiplier</span><span class="field-type">DECIMAL</span></div>
                                        <div class="schema-field"><span class="field-name">perks</span><span class="field-type">JSONB</span></div>
                                    </div>
                                </div>
                                <div class="relation-arrow">1 : N</div>
                                <div class="schema-table">
                                    <div class="schema-table-header">parking_spots (updated)</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name">...</span><span class="field-type">existing</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">tier_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name">has_covered_parking</span><span class="field-type">BOOLEAN</span></div>
                                        <div class="schema-field"><span class="field-name">has_car_wash</span><span class="field-type">BOOLEAN</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Tier examples
{ "name": "VIP", "price_multiplier": 2.5, "perks": ["covered", "car_wash", "priority_exit"] }
{ "name": "Premium", "price_multiplier": 1.5, "perks": ["covered", "near_elevator"] }
{ "name": "Regular", "price_multiplier": 1.0, "perks": [] }</pre>
                    </div>

                    <!-- FEATURE 2: Dynamic Pricing -->
                    <h3>Feature Addition 2: Dynamic Pricing</h3>
                    <div class="feature-card" style="border-left-color: #f59e0b;">
                        <h4>Before: Static Hourly Rate</h4>
                        <div class="api-endpoint">
                            <span>parking_lots.hourly_rate = 50.00</span>
                        </div>

                        <h4 style="margin-top: 20px;">After: Demand-based Dynamic Pricing</h4>
                        <div class="diagram-container" style="margin: 12px 0;">
                            <div class="schema-diagram">
                                <div class="schema-table">
                                    <div class="schema-table-header">pricing_rules</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">lot_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name">rule_type</span><span class="field-type">ENUM</span></div>
                                        <div class="schema-field"><span class="field-name">condition</span><span class="field-type">JSONB</span></div>
                                        <div class="schema-field"><span class="field-name">multiplier</span><span class="field-type">DECIMAL</span></div>
                                        <div class="schema-field"><span class="field-name">priority</span><span class="field-type">INT</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Pricing Algorithm
function calculatePrice(lot, duration, currentOccupancy) {
  let baseRate = lot.hourly_rate;
  let multiplier = 1.0;

  // Occupancy-based surge
  if (currentOccupancy > 0.9) multiplier *= 1.5;      // >90% full
  else if (currentOccupancy > 0.75) multiplier *= 1.25; // >75% full

  // Time-based rules
  if (isPeakHour()) multiplier *= 1.3;  // 9-11 AM, 5-8 PM
  if (isWeekend()) multiplier *= 1.2;
  if (isSpecialEvent()) multiplier *= 2.0;  // nearby concert/match

  return baseRate * duration * multiplier;
}</pre>
                    </div>

                    <div class="pros-cons-grid">
                        <div class="pros-section">
                            <h4>Pros of Dynamic Pricing</h4>
                            <ul>
                                <li><strong>Revenue Optimization:</strong> 20-40% revenue increase during peak times</li>
                                <li><strong>Demand Distribution:</strong> Incentivizes off-peak parking</li>
                                <li><strong>Better Utilization:</strong> Reduces over-crowding during events</li>
                            </ul>
                            <div class="care-points">
                                <h5>What to Care About</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>Price transparency - users must see final price BEFORE booking</li>
                                    <li>Set maximum caps to prevent price gouging complaints</li>
                                    <li>Audit trail for all pricing decisions for disputes</li>
                                </ul>
                            </div>
                        </div>
                        <div class="cons-section">
                            <h4>Cons of Dynamic Pricing</h4>
                            <ul>
                                <li><strong>User Frustration:</strong> Price changes feel unfair to users</li>
                                <li><strong>Complexity:</strong> Harder to predict parking costs</li>
                                <li><strong>Gaming:</strong> Users may try to exploit pricing windows</li>
                            </ul>
                            <div class="manage-points">
                                <h5>How to Manage</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>Show price range estimate upfront ("$40-60 based on demand")</li>
                                    <li>Offer subscription plans with fixed rates for regular users</li>
                                    <li>Lock price at booking time, honor for pre-booked slots</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- FEATURE 3: Pre-booking -->
                    <h3>Feature Addition 3: Advance Pre-booking</h3>
                    <div class="feature-card" style="border-left-color: #8b5cf6;">
                        <h4>Before: Walk-in Only</h4>
                        <p>Users could only book spots when physically present at the parking lot.</p>

                        <h4 style="margin-top: 20px;">After: Advance Reservation System</h4>
                        <div class="diagram-container" style="margin: 12px 0;">
                            <div class="schema-diagram">
                                <div class="schema-table">
                                    <div class="schema-table-header">reservations</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">lot_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">spot_id</span><span class="field-type">UUID FK (nullable)</span></div>
                                        <div class="schema-field"><span class="field-name">reserved_from</span><span class="field-type">TIMESTAMP</span></div>
                                        <div class="schema-field"><span class="field-name">reserved_until</span><span class="field-type">TIMESTAMP</span></div>
                                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM</span></div>
                                        <div class="schema-field"><span class="field-name">advance_payment</span><span class="field-type">DECIMAL</span></div>
                                        <div class="schema-field"><span class="field-name">cancellation_deadline</span><span class="field-type">TIMESTAMP</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="api-endpoint">
                            <span class="api-method post">POST</span>
                            <span>/api/v1/reservations</span>
                        </div>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Request
{
  "lot_id": "uuid-123",
  "vehicle_id": "vehicle-456",
  "reserved_from": "2024-01-20T09:00:00Z",
  "reserved_until": "2024-01-20T18:00:00Z",
  "spot_preference": "covered"  // Optional preference
}

// Business Rules
- Advance booking: 15 minutes to 7 days ahead
- Grace period: 30 minutes after reserved_from
- No-show penalty: Forfeit advance payment (20% of estimated cost)
- Cancellation: Free if > 2 hours before, 50% fee otherwise</pre>
                    </div>

                    <!-- FEATURE REVERSION -->
                    <h3>Feature Reversion: Rolling Back Dynamic Pricing</h3>
                    <div class="feature-card" style="border-left-color: #ef4444;">
                        <h4>Scenario: User Complaints Lead to Rollback</h4>
                        <p style="color: #64748b;">After launch, dynamic pricing receives negative feedback. We need to revert while preserving data integrity.</p>

                        <div class="diagram-container">
                            <h4>Rollback Strategy</h4>
                            <pre style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-size: 13px; text-align: left;">
// Phase 1: Feature Flag Disable (Immediate - 0 downtime)
UPDATE feature_flags SET enabled = false WHERE name = 'dynamic_pricing';

// Phase 2: Freeze Active Dynamic Prices
UPDATE bookings
SET price_locked = true,
    price_lock_reason = 'dynamic_pricing_rollback'
WHERE status = 'active' AND pricing_type = 'dynamic';

// Phase 3: Database Migration (Backward Compatible)
-- Don't delete pricing_rules table yet! Keep for potential re-enable
ALTER TABLE pricing_rules ADD COLUMN deprecated_at TIMESTAMP;
UPDATE pricing_rules SET deprecated_at = NOW();

// Phase 4: Code Rollback
git revert --no-commit HEAD~3..HEAD  // Revert last 3 pricing commits
git commit -m "Revert dynamic pricing feature"

// Phase 5: Cache Invalidation
redis-cli KEYS "pricing:*" | xargs redis-cli DEL
redis-cli PUBLISH invalidation '{"pattern": "pricing:*"}'

// Phase 6: Communication
- In-app notification: "We've simplified our pricing!"
- Email to affected users with any refunds
- Update help center / FAQ</pre>
                        </div>

                        <div class="pros-cons-grid">
                            <div class="pros-section">
                                <h4>Rollback Safeguards</h4>
                                <ul>
                                    <li>Feature flags enable instant disable without deployment</li>
                                    <li>All dynamic prices logged for audit/refund processing</li>
                                    <li>Database changes are additive (no destructive migrations)</li>
                                </ul>
                            </div>
                            <div class="cons-section">
                                <h4>Rollback Risks</h4>
                                <ul>
                                    <li>Active bookings with dynamic prices need manual handling</li>
                                    <li>Analytics data may be inconsistent during transition</li>
                                    <li>Partner integrations may cache old pricing</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== PAN-INDIA SCALE ==================== -->
                <div class="stage-section" id="pan-india">
                    <div class="stage-header">
                        <span class="stage-badge pan-india">Stage 2</span>
                        <h2>PAN-India Scale - Multi-Location Expansion</h2>
                    </div>

                    <p>Scale from a single parking lot to hundreds of locations across India with regional data centers and payment integration.</p>

                    <!-- Multi-Location Architecture -->
                    <h3>Multi-Location Architecture</h3>
                    <div class="diagram-container">
                        <h4>Regional Data Center Design</h4>
                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            <!-- North Region -->
                            <div style="border: 2px solid #3b82f6; border-radius: 12px; padding: 16px;">
                                <h5 style="margin: 0 0 12px 0; color: #3b82f6;">North Region (Delhi)</h5>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; justify-content: center;">
                                    <div class="arch-box lb">Regional LB</div>
                                    <div class="arch-arrow">--></div>
                                    <div class="arch-box server">API Cluster</div>
                                    <div class="arch-arrow">--></div>
                                    <div class="arch-box db">PostgreSQL Primary</div>
                                    <div class="arch-box cache">Redis Cluster</div>
                                </div>
                            </div>

                            <!-- South Region -->
                            <div style="border: 2px solid #22c55e; border-radius: 12px; padding: 16px;">
                                <h5 style="margin: 0 0 12px 0; color: #22c55e;">South Region (Bangalore)</h5>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; justify-content: center;">
                                    <div class="arch-box lb">Regional LB</div>
                                    <div class="arch-arrow">--></div>
                                    <div class="arch-box server">API Cluster</div>
                                    <div class="arch-arrow">--></div>
                                    <div class="arch-box db">PostgreSQL Primary</div>
                                    <div class="arch-box cache">Redis Cluster</div>
                                </div>
                            </div>

                            <!-- West Region -->
                            <div style="border: 2px solid #f59e0b; border-radius: 12px; padding: 16px;">
                                <h5 style="margin: 0 0 12px 0; color: #f59e0b;">West Region (Mumbai)</h5>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; justify-content: center;">
                                    <div class="arch-box lb">Regional LB</div>
                                    <div class="arch-arrow">--></div>
                                    <div class="arch-box server">API Cluster</div>
                                    <div class="arch-arrow">--></div>
                                    <div class="arch-box db">PostgreSQL Primary</div>
                                    <div class="arch-box cache">Redis Cluster</div>
                                </div>
                            </div>

                            <!-- Central Services -->
                            <div style="border: 2px solid #8b5cf6; border-radius: 12px; padding: 16px; background: #f8fafc;">
                                <h5 style="margin: 0 0 12px 0; color: #8b5cf6;">Central/Shared Services</h5>
                                <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                                    <div class="arch-box" style="background: #8b5cf6; color: white;">User Service</div>
                                    <div class="arch-box" style="background: #8b5cf6; color: white;">Payment Gateway</div>
                                    <div class="arch-box" style="background: #8b5cf6; color: white;">Analytics</div>
                                    <div class="arch-box" style="background: #8b5cf6; color: white;">Global Config</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Partitioning Strategy -->
                    <h3>Data Partitioning by Region</h3>
                    <div class="feature-card">
                        <h4>
                            <span class="term-tooltip" onclick="showTooltip('sharding')">Sharding<span class="info-icon">i</span></span>
                            Strategy: Geographic Partitioning
                        </h4>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Shard Key: lot_region (north | south | west | east)

// parking_lots table partitioned by region
CREATE TABLE parking_lots (
    id UUID,
    region VARCHAR(10),
    ...
) PARTITION BY LIST (region);

CREATE TABLE parking_lots_north PARTITION OF parking_lots FOR VALUES IN ('north');
CREATE TABLE parking_lots_south PARTITION OF parking_lots FOR VALUES IN ('south');
CREATE TABLE parking_lots_west PARTITION OF parking_lots FOR VALUES IN ('west');

// Cross-region queries (rare, for analytics only)
// Use read replicas with slight lag acceptable</pre>

                        <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px;">
                            <strong>Note:</strong> User data remains centralized (users travel across regions).
                            Only parking lot operational data is partitioned.
                        </div>
                    </div>

                    <div class="pros-cons-grid">
                        <div class="pros-section">
                            <h4>Pros of Regional Partitioning</h4>
                            <ul>
                                <li><strong>Low Latency:</strong> Users connect to nearest datacenter (~20ms vs ~100ms)</li>
                                <li><strong>Data Locality:</strong> 95% of queries stay within region</li>
                                <li><strong>Fault Isolation:</strong> Regional outage doesn't affect other regions</li>
                            </ul>
                            <div class="care-points">
                                <h5>What to Care About</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>Cross-region user sessions (user from Delhi parking in Mumbai)</li>
                                    <li>Consistent user wallet balance across regions</li>
                                    <li>Global reporting and analytics aggregation</li>
                                </ul>
                            </div>
                        </div>
                        <div class="cons-section">
                            <h4>Cons of Regional Partitioning</h4>
                            <ul>
                                <li><strong>Operational Overhead:</strong> 3x infrastructure to manage</li>
                                <li><strong>Cross-region Complexity:</strong> Distributed transactions are hard</li>
                                <li><strong>Data Sync:</strong> Keeping shared data consistent is challenging</li>
                            </ul>
                            <div class="manage-points">
                                <h5>How to Manage</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>Use managed Kubernetes (EKS/GKE) for uniform deployments</li>
                                    <li>Implement saga pattern for cross-region transactions</li>
                                    <li>CDC (Change Data Capture) for async data replication</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Gateway Integration -->
                    <h3>Payment Gateway Integration</h3>
                    <div class="diagram-container">
                        <h4>Multi-Gateway Payment Flow</h4>
                        <div style="display: flex; flex-direction: column; gap: 16px; align-items: center;">
                            <div class="arch-box client">User Payment Request</div>
                            <div class="arch-arrow" style="transform: rotate(90deg);">--></div>
                            <div class="arch-box server">Payment Orchestrator</div>
                            <div class="arch-arrow" style="transform: rotate(90deg);">--></div>
                            <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box" style="background: #6366f1; color: white;">Razorpay</div>
                                <div class="arch-box" style="background: #22c55e; color: white;">PayTM</div>
                                <div class="arch-box" style="background: #f59e0b; color: white;">PhonePe</div>
                                <div class="arch-box" style="background: #3b82f6; color: white;">UPI Direct</div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>
                            <span class="term-tooltip" onclick="showTooltip('idempotency')">Idempotent<span class="info-icon">i</span></span>
                            Payment Processing
                        </h4>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Payment Request with Idempotency Key
POST /api/v1/payments
Headers:
  Idempotency-Key: "booking-789-payment-attempt-1"

{
  "booking_id": "booking-789",
  "amount": 105.00,
  "currency": "INR",
  "method": "upi",
  "upi_id": "user@paytm"
}

// Idempotency Implementation
async function processPayment(request, idempotencyKey) {
  // Check if already processed
  const existing = await redis.get(`idempotency:${idempotencyKey}`);
  if (existing) return JSON.parse(existing);

  // Acquire distributed lock
  const lock = await redlock.lock(`payment-lock:${idempotencyKey}`, 30000);

  try {
    const result = await paymentGateway.charge(request);
    await redis.setex(`idempotency:${idempotencyKey}`, 86400, JSON.stringify(result));
    return result;
  } finally {
    await lock.unlock();
  }
}</pre>
                    </div>

                    <!-- New Feature: Subscription Plans -->
                    <h3>New Feature: Subscription Plans</h3>
                    <div class="feature-card" style="border-left-color: #8b5cf6;">
                        <h4>Monthly/Annual Parking Subscriptions</h4>
                        <div class="diagram-container" style="margin: 12px 0;">
                            <div class="schema-diagram">
                                <div class="schema-table">
                                    <div class="schema-table-header">subscription_plans</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR</span></div>
                                        <div class="schema-field"><span class="field-name">duration_days</span><span class="field-type">INT</span></div>
                                        <div class="schema-field"><span class="field-name">price</span><span class="field-type">DECIMAL</span></div>
                                        <div class="schema-field"><span class="field-name">included_hours</span><span class="field-type">INT</span></div>
                                        <div class="schema-field"><span class="field-name">lot_access</span><span class="field-type">JSONB</span></div>
                                        <div class="schema-field"><span class="field-name">benefits</span><span class="field-type">JSONB</span></div>
                                    </div>
                                </div>
                                <div class="relation-arrow">1 : N</div>
                                <div class="schema-table">
                                    <div class="schema-table-header">user_subscriptions</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">plan_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name">start_date</span><span class="field-type">DATE</span></div>
                                        <div class="schema-field"><span class="field-name">end_date</span><span class="field-type">DATE</span></div>
                                        <div class="schema-field"><span class="field-name">hours_used</span><span class="field-type">INT</span></div>
                                        <div class="schema-field"><span class="field-name">auto_renew</span><span class="field-type">BOOLEAN</span></div>
                                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Subscription Plan Examples
{
  "name": "Office Commuter",
  "duration_days": 30,
  "price": 2500,
  "included_hours": 200,  // ~8 hrs/day weekdays
  "lot_access": ["lot-123", "lot-456"],  // Specific lots only
  "benefits": ["reserved_spot", "no_surge_pricing"]
}

{
  "name": "City Explorer",
  "duration_days": 30,
  "price": 4000,
  "included_hours": 100,
  "lot_access": ["*"],  // All lots in city
  "benefits": ["any_lot_access", "priority_booking"]
}

// Booking with Subscription
POST /api/v1/bookings
{
  "lot_id": "uuid-123",
  "vehicle_id": "vehicle-456",
  "use_subscription": true,
  "subscription_id": "sub-789"  // Deduct from included hours
}</pre>
                    </div>

                    <div class="pros-cons-grid">
                        <div class="pros-section">
                            <h4>Pros of Subscription Model</h4>
                            <ul>
                                <li><strong>Predictable Revenue:</strong> Monthly recurring revenue provides stability</li>
                                <li><strong>Customer Retention:</strong> Subscribers have 3x higher retention rate</li>
                                <li><strong>Reduced Payment Friction:</strong> No payment at each visit</li>
                            </ul>
                            <div class="care-points">
                                <h5>What to Care About</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>Accurate hour tracking across multiple lots</li>
                                    <li>Handling subscription exhaustion mid-booking</li>
                                    <li>Proration for mid-cycle cancellations</li>
                                </ul>
                            </div>
                        </div>
                        <div class="cons-section">
                            <h4>Cons of Subscription Model</h4>
                            <ul>
                                <li><strong>Revenue Cannibalization:</strong> Heavy users pay less per hour</li>
                                <li><strong>Capacity Planning:</strong> Subscribers expect guaranteed spots</li>
                                <li><strong>Churn Management:</strong> Failed renewals need careful handling</li>
                            </ul>
                            <div class="manage-points">
                                <h5>How to Manage</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>Set subscriber caps per lot (max 20% capacity reserved)</li>
                                    <li>Implement overage charges beyond included hours</li>
                                    <li>Dunning process: 3 retry attempts before suspension</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== HIGH TRAFFIC ==================== -->
                <div class="stage-section" id="high-traffic">
                    <div class="stage-header">
                        <span class="stage-badge high-traffic">Stage 3</span>
                        <h2>High Traffic - Mall/Airport Scenarios</h2>
                    </div>

                    <p>Handle extreme concurrency during peak events: airport holiday rush, mall weekend sales, stadium events with 10K+ concurrent check-ins.</p>

                    <!-- Concurrency Architecture -->
                    <h3>Handling 10K Concurrent Check-ins</h3>
                    <div class="diagram-container">
                        <h4>High-Concurrency Architecture</h4>
                        <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                            <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box client">10K Mobile Apps</div>
                                <div class="arch-box client">Kiosk Terminals</div>
                                <div class="arch-box client">ANPR Cameras</div>
                            </div>
                            <div class="arch-arrow" style="transform: rotate(90deg);">--></div>
                            <div class="arch-box cdn">CDN / Edge (Static + API Caching)</div>
                            <div class="arch-arrow" style="transform: rotate(90deg);">--></div>
                            <div class="arch-box lb">Global Load Balancer (AWS ALB)</div>
                            <div class="arch-arrow" style="transform: rotate(90deg);">--></div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box server">API Pod 1</div>
                                <div class="arch-box server">API Pod 2</div>
                                <div class="arch-box server">API Pod 3</div>
                                <div class="arch-box server">... Pod N</div>
                            </div>
                            <div class="arch-arrow" style="transform: rotate(90deg);">--></div>
                            <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box cache">Redis Cluster (6 nodes)</div>
                                <div class="arch-box queue">Kafka (Async Processing)</div>
                                <div class="arch-box db">PostgreSQL (Read Replicas)</div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>Optimistic Locking for Spot Reservation</h4>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Problem: 100 users trying to book the same spot simultaneously

// Solution 1: Redis-based Distributed Lock (for exact spot booking)
async function bookSpecificSpot(spotId, userId) {
  const lockKey = `spot-lock:${spotId}`;
  const lock = await redlock.lock(lockKey, 5000); // 5 second lock

  try {
    const spot = await getSpot(spotId);
    if (spot.status !== 'available') {
      throw new Error('Spot no longer available');
    }
    await updateSpotStatus(spotId, 'reserved', userId);
    return { success: true };
  } finally {
    await lock.unlock();
  }
}

// Solution 2: Atomic Counter for "Any Available Spot" (faster)
async function bookAnySpot(lotId, userId) {
  // Atomically decrement available count
  const remaining = await redis.decr(`lot:${lotId}:available`);

  if (remaining < 0) {
    await redis.incr(`lot:${lotId}:available`); // Rollback
    throw new Error('No spots available');
  }

  // Async: Find and assign specific spot via queue
  await kafka.produce('spot-assignment', { lotId, userId });

  return {
    success: true,
    message: 'Spot reserved! Assignment in progress...',
    estimated_assignment: '30 seconds'
  };
}</pre>
                    </div>

                    <!-- Queue Management -->
                    <h3>Virtual Queue Management</h3>
                    <div class="feature-card">
                        <h4>When Demand Exceeds Capacity</h4>
                        <div class="diagram-container" style="margin: 12px 0;">
                            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box client">User Request</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box" style="background: #ef4444; color: white;">Rate Limiter</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box queue">Virtual Queue</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box server">Processing</div>
                            </div>
                        </div>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Virtual Queue Implementation
class VirtualQueue {
  async joinQueue(lotId, userId) {
    const position = await redis.rpush(`queue:${lotId}`, userId);
    const estimatedWait = position * 30; // 30 seconds per person

    // Send WebSocket update
    ws.send(userId, {
      event: 'queue_joined',
      position: position,
      estimated_wait_seconds: estimatedWait
    });

    return { position, estimatedWait };
  }

  async processQueue(lotId) {
    while (true) {
      const availableSpots = await redis.get(`lot:${lotId}:available`);
      if (availableSpots <= 0) {
        await sleep(5000); // Wait 5 seconds
        continue;
      }

      const userId = await redis.lpop(`queue:${lotId}`);
      if (!userId) break;

      await this.assignSpot(lotId, userId);
      await this.notifyQueueUpdate(lotId); // Update all queue positions
    }
  }
}

// API Response when lot is full
{
  "status": "queued",
  "queue_position": 15,
  "estimated_wait_minutes": 8,
  "notification_channel": "ws://parking.app/queue/lot-123"
}</pre>
                    </div>

                    <!-- Failure Scenarios -->
                    <h3>Failure Scenarios and Handling</h3>

                    <div class="feature-card" style="border-left-color: #ef4444;">
                        <h4>Scenario 1: IoT Sensor Failure</h4>
                        <div style="background: #fef2f2; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <strong>Problem:</strong> Sensor reports spot as "available" but car is physically present (sensor malfunction).
                        </div>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Detection
- Heartbeat monitoring: Alert if sensor silent for > 5 minutes
- Anomaly detection: Spot changed status > 10 times in 1 hour
- Cross-validation: Entry/exit camera count vs sensor count mismatch

// Mitigation
1. Mark spot as "unverified" - don't assign to new bookings
2. Trigger manual verification (security staff notification)
3. Fallback to camera-based detection (ANPR at entry/exit)
4. Automatic sensor restart command via edge gateway

// Recovery
- Sensor replaced: Run calibration test (5 occupy/vacate cycles)
- Mark as "verified" only after 100% accuracy in test</pre>
                    </div>

                    <div class="feature-card" style="border-left-color: #f59e0b;">
                        <h4>Scenario 2: Payment Gateway Timeout</h4>
                        <div style="background: #fffbeb; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <strong>Problem:</strong> Payment gateway times out during checkout. User stuck at exit barrier.
                        </div>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Immediate Actions
1. Allow exit with "Payment Pending" status
   - Capture license plate, user ID, amount due
   - Raise exit barrier after 30 second timeout

2. Retry payment asynchronously
   async function handlePaymentTimeout(bookingId) {
     await markBookingPending(bookingId);
     await kafka.produce('payment-retry', { bookingId, attempts: 0 });
     await sms.send(userId, 'Payment pending. We will retry automatically.');
   }

3. Retry logic with exponential backoff
   - Attempt 1: Immediate
   - Attempt 2: After 5 minutes
   - Attempt 3: After 30 minutes
   - Attempt 4: After 2 hours
   - Final: Create invoice, block future bookings until paid

// Prevention
- Circuit breaker on payment gateway (fail fast after 3 failures)
- Maintain payment gateway health dashboard
- Auto-switch to backup gateway if primary fails</pre>
                    </div>

                    <div class="feature-card" style="border-left-color: #8b5cf6;">
                        <h4>Scenario 3: Database Overload</h4>
                        <div style="background: #f5f3ff; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <strong>Problem:</strong> Database CPU at 100% during stadium event. Queries timing out.
                        </div>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Immediate Response
1. Activate read replica routing for all read queries
2. Enable aggressive caching (extend TTL from 30s to 5min)
3. Defer non-critical writes to queue

// Query Optimization
- Spot availability: Serve from Redis (not DB)
- Booking history: Paginate, limit to last 10
- Analytics: Completely disabled during peak

// Architecture Changes (Post-incident)
CREATE TABLE bookings_active (LIKE bookings INCLUDING ALL);
-- Hot data: Only active bookings (< 1% of total)
-- Cold data: Archived bookings in separate table

// Auto-scaling triggers
if db_cpu > 80%:
    add_read_replica()
    enable_connection_pooling()
    activate_query_cache()</pre>
                    </div>

                    <div class="pros-cons-grid">
                        <div class="pros-section">
                            <h4>Pros of Queue-Based Architecture</h4>
                            <ul>
                                <li><strong>Graceful Degradation:</strong> System remains responsive under load</li>
                                <li><strong>Fair Access:</strong> FIFO ordering prevents racing conditions</li>
                                <li><strong>Predictable Wait Times:</strong> Users know their position</li>
                            </ul>
                            <div class="care-points">
                                <h5>What to Care About</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>Queue abandonment - users leave before their turn</li>
                                    <li>Priority handling for VIP/subscription users</li>
                                    <li>Queue persistence if system restarts</li>
                                </ul>
                            </div>
                        </div>
                        <div class="cons-section">
                            <h4>Cons of Queue-Based Architecture</h4>
                            <ul>
                                <li><strong>Added Latency:</strong> Even low-traffic requests go through queue</li>
                                <li><strong>Complexity:</strong> Queue management adds operational overhead</li>
                                <li><strong>User Frustration:</strong> Waiting is never a good UX</li>
                            </ul>
                            <div class="manage-points">
                                <h5>How to Manage</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>Bypass queue when load is below threshold (< 50% capacity)</li>
                                    <li>Gamify waiting: Show live map, estimated time updates</li>
                                    <li>Offer alternatives: "Nearby lot has 50 spots available"</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Rate Limiting -->
                    <h3>
                        <span class="term-tooltip" onclick="showTooltip('rate-limiting')">Rate Limiting<span class="info-icon">i</span></span>
                        Strategy
                    </h3>
                    <div class="feature-card">
                        <h4>Multi-Level Rate Limiting</h4>
                        <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; font-size: 13px;">
// Level 1: Per-User Rate Limit
- 10 requests/second for availability checks
- 2 booking attempts/minute
- 1 payment/10 seconds

// Level 2: Per-Lot Rate Limit
- Max 500 concurrent availability requests per lot
- Max 100 booking attempts/minute per lot

// Level 3: Global Rate Limit
- 50K requests/second across all services
- Circuit breaker at 80% capacity

// Implementation (Token Bucket)
class RateLimiter {
  async checkLimit(userId, action) {
    const key = `ratelimit:${userId}:${action}`;
    const limit = LIMITS[action];

    const current = await redis.incr(key);
    if (current === 1) {
      await redis.expire(key, limit.window);
    }

    if (current > limit.max) {
      return {
        allowed: false,
        retryAfter: await redis.ttl(key),
        message: `Rate limit exceeded. Try again in ${retryAfter}s`
      };
    }
    return { allowed: true };
  }
}</pre>
                    </div>
                </div>

                <!-- ==================== GLOBAL SCALE ==================== -->
                <div class="stage-section" id="global">
                    <div class="stage-header">
                        <span class="stage-badge global">Stage 4</span>
                        <h2>Global Scale - International Expansion</h2>
                    </div>

                    <p>Brief overview of considerations for expanding to international markets (US, Europe, Southeast Asia).</p>

                    <div class="diagram-container">
                        <h4>Global Architecture Overview</h4>
                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                                <div style="border: 2px solid #3b82f6; border-radius: 12px; padding: 16px; text-align: center;">
                                    <div class="arch-box" style="background: #3b82f6; color: white;">US Region</div>
                                    <div style="font-size: 12px; color: #64748b; margin-top: 8px;">AWS us-east-1, us-west-2</div>
                                </div>
                                <div style="border: 2px solid #22c55e; border-radius: 12px; padding: 16px; text-align: center;">
                                    <div class="arch-box" style="background: #22c55e; color: white;">EU Region</div>
                                    <div style="font-size: 12px; color: #64748b; margin-top: 8px;">AWS eu-west-1 (GDPR)</div>
                                </div>
                                <div style="border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; text-align: center;">
                                    <div class="arch-box" style="background: #f59e0b; color: white;">APAC Region</div>
                                    <div style="font-size: 12px; color: #64748b; margin-top: 8px;">AWS ap-south-1, ap-southeast-1</div>
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div class="arch-box" style="background: #8b5cf6; color: white;">Global Traffic Manager (AWS Route 53 / Cloudflare)</div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>Key Global Considerations</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                                <h5 style="margin: 0 0 8px 0; color: #1e293b;">Data Residency</h5>
                                <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #64748b;">
                                    <li>EU user data must stay in EU (GDPR)</li>
                                    <li>Payment data follows PCI-DSS regional rules</li>
                                    <li>Implement data residency tags in database</li>
                                </ul>
                            </div>
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                                <h5 style="margin: 0 0 8px 0; color: #1e293b;">Multi-Currency</h5>
                                <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #64748b;">
                                    <li>Store prices in local currency</li>
                                    <li>Real-time FX rates for cross-border</li>
                                    <li>Currency-specific payment gateways</li>
                                </ul>
                            </div>
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                                <h5 style="margin: 0 0 8px 0; color: #1e293b;">Localization</h5>
                                <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #64748b;">
                                    <li>Multi-language support (i18n)</li>
                                    <li>Local time zone handling</li>
                                    <li>Regional pricing strategies</li>
                                </ul>
                            </div>
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                                <h5 style="margin: 0 0 8px 0; color: #1e293b;">Latency Optimization</h5>
                                <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #64748b;">
                                    <li>Edge caching for static content</li>
                                    <li>Regional API endpoints</li>
                                    <li>GeoDNS routing to nearest DC</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="pros-cons-grid">
                        <div class="pros-section">
                            <h4>Pros of Global Expansion</h4>
                            <ul>
                                <li><strong>Market Size:</strong> 10x larger addressable market</li>
                                <li><strong>Diversification:</strong> Revenue not dependent on single market</li>
                                <li><strong>Follow Customers:</strong> Serve Indian travelers abroad</li>
                            </ul>
                            <div class="care-points">
                                <h5>What to Care About</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>Compliance varies dramatically by country</li>
                                    <li>Support in local languages and time zones</li>
                                    <li>Local competition with established players</li>
                                </ul>
                            </div>
                        </div>
                        <div class="cons-section">
                            <h4>Cons of Global Expansion</h4>
                            <ul>
                                <li><strong>Operational Complexity:</strong> 3x infrastructure and compliance</li>
                                <li><strong>Cost:</strong> Multi-region deployment is expensive</li>
                                <li><strong>Consistency:</strong> Keeping features in sync across regions</li>
                            </ul>
                            <div class="manage-points">
                                <h5>How to Manage</h5>
                                <ul style="font-size: 13px; margin: 0; padding-left: 20px;">
                                    <li>Start with one international market (Singapore)</li>
                                    <li>Use managed services to reduce ops burden</li>
                                    <li>Feature flags for region-specific rollouts</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Final Summary -->
                    <h3>System Evolution Summary</h3>
                    <div class="diagram-container">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: #f1f5f9;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Stage</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Scale</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Key Technologies</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">Main Challenges</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><span class="stage-badge mvp">MVP</span></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">1 lot, 500 spots</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">PostgreSQL, Redis, MQTT, WebSocket</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">IoT reliability, real-time updates</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><span class="stage-badge pan-india">PAN-India</span></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">500 lots, 100K spots</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">Regional sharding, Kafka, Payment gateways</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">Data partitioning, cross-region users</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><span class="stage-badge high-traffic">High Traffic</span></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">10K concurrent users/lot</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">Virtual queues, Circuit breakers, Auto-scaling</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">Concurrency, failure handling</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px;"><span class="stage-badge global">Global</span></td>
                                    <td style="padding: 12px;">Multi-country, millions of users</td>
                                    <td style="padding: 12px;">Multi-region, GeoDNS, Compliance tools</td>
                                    <td style="padding: 12px;">Data residency, localization</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ride Booking Section -->
        <div id="ride-booking" class="system-section">
            <h1>üöó Ride Booking System Design</h1>
            <p style="color: #64748b; margin-bottom: 24px;">Design a ride-hailing platform like Uber/Ola with real-time matching and tracking</p>

            <div id="ride-booking-content">
                <!-- ==================== MVP STAGE ==================== -->
                <section class="stage-section" id="ride-mvp">
                    <div class="stage-header">
                        <span class="stage-badge mvp">MVP Stage</span>
                        <h2 style="margin: 0;">Basic Ride Booking System</h2>
                    </div>
                    <p style="color: #64748b; margin-bottom: 24px;">Build core functionality for a single city: user can request rides, drivers accept and complete trips with real-time tracking.</p>

                    <!-- Database Schema -->
                    <div class="feature-card">
                        <h4>Database Schema Design</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">Core tables for ride booking with geospatial support</p>

                        <div class="diagram-container">
                            <h4>Entity Relationship Diagram</h4>
                            <div class="schema-diagram">
                                <!-- Users Table -->
                                <div class="schema-table">
                                    <div class="schema-table-header">users</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR</span></div>
                                        <div class="schema-field"><span class="field-name">email</span><span class="field-type">VARCHAR</span></div>
                                        <div class="schema-field"><span class="field-name">phone</span><span class="field-type">VARCHAR</span></div>
                                        <div class="schema-field"><span class="field-name">rating</span><span class="field-type">DECIMAL</span></div>
                                        <div class="schema-field"><span class="field-name">wallet_balance</span><span class="field-type">DECIMAL</span></div>
                                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMP</span></div>
                                    </div>
                                </div>

                                <div class="relation-arrow">---&lt;</div>

                                <!-- Rides Table -->
                                <div class="schema-table">
                                    <div class="schema-table-header">rides</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">driver_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM</span></div>
                                        <div class="schema-field"><span class="field-name">pickup_lat</span><span class="field-type">DECIMAL(10,7)</span></div>
                                        <div class="schema-field"><span class="field-name">pickup_lng</span><span class="field-type">DECIMAL(10,7)</span></div>
                                        <div class="schema-field"><span class="field-name">dropoff_lat</span><span class="field-type">DECIMAL(10,7)</span></div>
                                        <div class="schema-field"><span class="field-name">dropoff_lng</span><span class="field-type">DECIMAL(10,7)</span></div>
                                        <div class="schema-field"><span class="field-name">fare</span><span class="field-type">DECIMAL</span></div>
                                        <div class="schema-field"><span class="field-name">distance_km</span><span class="field-type">DECIMAL</span></div>
                                        <div class="schema-field"><span class="field-name">duration_min</span><span class="field-type">INTEGER</span></div>
                                        <div class="schema-field"><span class="field-name">requested_at</span><span class="field-type">TIMESTAMP</span></div>
                                        <div class="schema-field"><span class="field-name">completed_at</span><span class="field-type">TIMESTAMP</span></div>
                                    </div>
                                </div>

                                <div class="relation-arrow">&gt;---</div>

                                <!-- Drivers Table -->
                                <div class="schema-table">
                                    <div class="schema-table-header">drivers</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR</span></div>
                                        <div class="schema-field"><span class="field-name">phone</span><span class="field-type">VARCHAR</span></div>
                                        <div class="schema-field"><span class="field-name">vehicle_number</span><span class="field-type">VARCHAR</span></div>
                                        <div class="schema-field"><span class="field-name">vehicle_type</span><span class="field-type">ENUM</span></div>
                                        <div class="schema-field"><span class="field-name">rating</span><span class="field-type">DECIMAL</span></div>
                                        <div class="schema-field"><span class="field-name">is_available</span><span class="field-type">BOOLEAN</span></div>
                                        <div class="schema-field"><span class="field-name">current_lat</span><span class="field-type">DECIMAL(10,7)</span></div>
                                        <div class="schema-field"><span class="field-name">current_lng</span><span class="field-type">DECIMAL(10,7)</span></div>
                                        <div class="schema-field"><span class="field-name">last_location_update</span><span class="field-type">TIMESTAMP</span></div>
                                    </div>
                                </div>
                            </div>

                            <div class="schema-diagram" style="margin-top: 20px;">
                                <!-- Locations Table -->
                                <div class="schema-table">
                                    <div class="schema-table-header">driver_locations (Time-series)</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">BIGINT PK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">driver_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name">latitude</span><span class="field-type">DECIMAL(10,7)</span></div>
                                        <div class="schema-field"><span class="field-name">longitude</span><span class="field-type">DECIMAL(10,7)</span></div>
                                        <div class="schema-field"><span class="field-name">heading</span><span class="field-type">INTEGER</span></div>
                                        <div class="schema-field"><span class="field-name">speed</span><span class="field-type">DECIMAL</span></div>
                                        <div class="schema-field"><span class="field-name">timestamp</span><span class="field-type">TIMESTAMP</span></div>
                                    </div>
                                </div>

                                <div class="relation-arrow">---</div>

                                <!-- Saved Locations Table -->
                                <div class="schema-table">
                                    <div class="schema-table-header">saved_locations</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name">label</span><span class="field-type">VARCHAR</span></div>
                                        <div class="schema-field"><span class="field-name">address</span><span class="field-type">TEXT</span></div>
                                        <div class="schema-field"><span class="field-name">latitude</span><span class="field-type">DECIMAL(10,7)</span></div>
                                        <div class="schema-field"><span class="field-name">longitude</span><span class="field-type">DECIMAL(10,7)</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <strong style="color: #166534;">Ride Status ENUM Values:</strong>
                            <code style="display: block; margin-top: 8px; color: #475569;">
                                REQUESTED -> DRIVER_ASSIGNED -> DRIVER_ARRIVED -> IN_PROGRESS -> COMPLETED | CANCELLED
                            </code>
                        </div>
                    </div>

                    <!-- High Level Design -->
                    <div class="feature-card">
                        <h4>High Level Design (HLD)</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">Architecture for ride booking with location service, matching algorithm, and pricing engine</p>

                        <div class="diagram-container">
                            <h4>MVP Architecture</h4>
                            <div style="display: flex; flex-direction: column; gap: 24px; align-items: center;">
                                <!-- Clients Layer -->
                                <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                                    <div class="arch-box client">Rider App</div>
                                    <div class="arch-box client">Driver App</div>
                                </div>

                                <div class="arch-arrow" style="transform: rotate(90deg);">---></div>

                                <!-- Gateway Layer -->
                                <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                                    <div class="arch-box lb">API Gateway / Load Balancer</div>
                                    <div class="arch-box server" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                                        <span class="term-tooltip" onclick="showTooltip('websocket')">WebSocket Server<span class="info-icon">i</span></span>
                                    </div>
                                </div>

                                <div class="arch-arrow" style="transform: rotate(90deg);">---></div>

                                <!-- Services Layer -->
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                    <div class="arch-box server">Ride Service</div>
                                    <div class="arch-box server">Location Service</div>
                                    <div class="arch-box server">Matching Service</div>
                                    <div class="arch-box server">Pricing Service</div>
                                    <div class="arch-box server">User Service</div>
                                </div>

                                <div class="arch-arrow" style="transform: rotate(90deg);">---></div>

                                <!-- Data Layer -->
                                <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                                    <div class="arch-box db">PostgreSQL (Rides, Users)</div>
                                    <div class="arch-box cache">
                                        <span class="term-tooltip" onclick="showTooltip('redis')">Redis<span class="info-icon">i</span></span> (Driver Locations)
                                    </div>
                                    <div class="arch-box queue">
                                        <span class="term-tooltip" onclick="showTooltip('kafka')">Kafka<span class="info-icon">i</span></span> (Events)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Service Descriptions -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 20px;">
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <h5 style="margin: 0 0 8px 0; color: #1e293b;">Location Service</h5>
                                <ul style="margin: 0; padding-left: 20px; color: #64748b; font-size: 14px;">
                                    <li>Receives driver GPS updates every 3-5 seconds</li>
                                    <li>Stores current location in Redis for fast lookup</li>
                                    <li>Archives historical locations for trip tracking</li>
                                    <li>Provides geospatial queries (drivers within radius)</li>
                                </ul>
                            </div>
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid #22c55e;">
                                <h5 style="margin: 0 0 8px 0; color: #1e293b;">Matching Service</h5>
                                <ul style="margin: 0; padding-left: 20px; color: #64748b; font-size: 14px;">
                                    <li>Finds available drivers near pickup location</li>
                                    <li>Ranks by distance, rating, acceptance rate</li>
                                    <li>Sends ride request to best match</li>
                                    <li>Handles timeout and fallback to next driver</li>
                                </ul>
                            </div>
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <h5 style="margin: 0 0 8px 0; color: #1e293b;">Pricing Service</h5>
                                <ul style="margin: 0; padding-left: 20px; color: #64748b; font-size: 14px;">
                                    <li>Calculates fare based on distance + time</li>
                                    <li>Applies base fare + per km + per min rates</li>
                                    <li>Vehicle type multipliers (Auto, Mini, Sedan, SUV)</li>
                                    <li>Applies promo codes and discounts</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- API Design -->
                    <div class="feature-card">
                        <h4>API Design</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">RESTful APIs for ride booking operations</p>

                        <!-- Request Ride API -->
                        <div class="api-endpoint">
                            <div style="margin-bottom: 12px;">
                                <span class="api-method post">POST</span>
                                <span>/api/v1/rides/request</span>
                            </div>
                            <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">Request a new ride</div>
                            <pre style="margin: 0; font-size: 12px; color: #a5f3fc;">
// Request Body
{
  "pickup": {
    "latitude": 12.9716,
    "longitude": 77.5946,
    "address": "MG Road, Bangalore"
  },
  "dropoff": {
    "latitude": 12.9352,
    "longitude": 77.6245,
    "address": "Koramangala, Bangalore"
  },
  "vehicle_type": "SEDAN",
  "payment_method": "WALLET"
}

// Response
{
  "ride_id": "ride_abc123",
  "status": "SEARCHING_DRIVER",
  "estimated_fare": { "min": 180, "max": 220, "currency": "INR" },
  "estimated_pickup_time": "4 mins",
  "estimated_duration": "25 mins"
}</pre>
                        </div>

                        <!-- Get Nearby Drivers API -->
                        <div class="api-endpoint">
                            <div style="margin-bottom: 12px;">
                                <span class="api-method get">GET</span>
                                <span>/api/v1/drivers/nearby?lat=12.9716&lng=77.5946&radius=3000</span>
                            </div>
                            <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">Find available drivers within radius (meters)</div>
                            <pre style="margin: 0; font-size: 12px; color: #a5f3fc;">
// Response
{
  "drivers": [
    {
      "driver_id": "drv_001",
      "distance_meters": 850,
      "eta_minutes": 3,
      "location": { "lat": 12.9720, "lng": 77.5950 },
      "vehicle": { "type": "SEDAN", "number": "KA01AB1234", "model": "Swift Dzire" },
      "rating": 4.8
    }
  ],
  "total_available": 12
}</pre>
                        </div>

                        <!-- Update Ride Status API -->
                        <div class="api-endpoint">
                            <div style="margin-bottom: 12px;">
                                <span class="api-method put">PUT</span>
                                <span>/api/v1/rides/{ride_id}/status</span>
                            </div>
                            <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">Update ride status (driver actions)</div>
                            <pre style="margin: 0; font-size: 12px; color: #a5f3fc;">
// Request Body
{
  "status": "DRIVER_ARRIVED",
  "location": { "lat": 12.9716, "lng": 77.5946 },
  "otp": "1234"
}

// Response
{
  "ride_id": "ride_abc123",
  "status": "DRIVER_ARRIVED",
  "updated_at": "2024-01-15T10:30:00Z",
  "message": "Rider has been notified of your arrival"
}</pre>
                        </div>
                    </div>

                    <!-- Real-time Location Updates -->
                    <div class="feature-card">
                        <h4>Real-time Driver Location Updates</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">
                            <span class="term-tooltip" onclick="showTooltip('websocket')">WebSocket<span class="info-icon">i</span></span>
                            architecture for live tracking
                        </p>

                        <div class="diagram-container">
                            <h4>Location Update Flow</h4>
                            <div style="display: flex; flex-direction: column; gap: 16px;">
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                    <div class="arch-box client" style="min-width: 120px;">Driver App</div>
                                    <div class="arch-arrow">--GPS--></div>
                                    <div class="arch-box server" style="min-width: 150px; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">WebSocket Gateway</div>
                                    <div class="arch-arrow">--publish--></div>
                                    <div class="arch-box cache" style="min-width: 140px;">Redis Pub/Sub</div>
                                </div>
                                <div style="display: flex; justify-content: center;">
                                    <div class="arch-arrow" style="transform: rotate(90deg);">|</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                    <div class="arch-box client" style="min-width: 120px;">Rider App</div>
                                    <div class="arch-arrow"><--subscribe--</div>
                                    <div class="arch-box server" style="min-width: 150px; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">WebSocket Gateway</div>
                                    <div class="arch-arrow"><--channel--</div>
                                    <div class="arch-box cache" style="min-width: 140px;">Redis Pub/Sub</div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #1e293b; padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">WebSocket Message Format</div>
                            <pre style="margin: 0; font-size: 12px; color: #a5f3fc;">
// Driver sends location update every 3 seconds
{
  "type": "LOCATION_UPDATE",
  "driver_id": "drv_001",
  "ride_id": "ride_abc123",
  "payload": {
    "lat": 12.9718,
    "lng": 77.5948,
    "heading": 45,
    "speed": 25,
    "timestamp": 1705312200000
  }
}

// Rider receives real-time update
{
  "type": "DRIVER_LOCATION",
  "ride_id": "ride_abc123",
  "payload": {
    "lat": 12.9718,
    "lng": 77.5948,
    "eta_seconds": 180,
    "distance_meters": 750
  }
}</pre>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px;">
                                <strong style="color: #92400e; font-size: 13px;">Update Frequency</strong>
                                <p style="margin: 4px 0 0 0; color: #78716c; font-size: 12px;">3-5 sec during active ride, 30 sec when idle</p>
                            </div>
                            <div style="background: #dbeafe; padding: 12px; border-radius: 8px;">
                                <strong style="color: #1e40af; font-size: 13px;">Redis GEO Commands</strong>
                                <p style="margin: 4px 0 0 0; color: #64748b; font-size: 12px;">GEOADD, GEORADIUS for spatial queries</p>
                            </div>
                            <div style="background: #dcfce7; padding: 12px; border-radius: 8px;">
                                <strong style="color: #166534; font-size: 13px;">Channel Pattern</strong>
                                <p style="margin: 4px 0 0 0; color: #64748b; font-size: 12px;">ride:{ride_id}:location for targeted updates</p>
                            </div>
                        </div>
                    </div>

                    <!-- MVP Features -->
                    <div class="feature-card">
                        <h4>MVP Features</h4>

                        <!-- Feature 1: Ride Sharing -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #3b82f6;">
                            <h5 style="margin: 0 0 12px 0; color: #1e293b;">Feature 1: Ride Sharing (Share)</h5>
                            <p style="color: #64748b; margin-bottom: 12px;">Allow multiple riders to share a ride going in the same direction to reduce costs.</p>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                                <div>
                                    <strong style="color: #475569; font-size: 13px;">Database Changes:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                        <li>Add <code>ride_type</code> ENUM (SOLO, SHARE) to rides</li>
                                        <li>Add <code>ride_group_id</code> to link shared rides</li>
                                        <li>Add <code>seat_capacity</code> and <code>seats_booked</code></li>
                                    </ul>
                                </div>
                                <div>
                                    <strong style="color: #475569; font-size: 13px;">Matching Algorithm:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                        <li>Find rides with compatible routes (direction match)</li>
                                        <li>Calculate detour time (max 10 min extra)</li>
                                        <li>Split fare based on distance ratio</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Feature 2: Scheduled Rides -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #22c55e;">
                            <h5 style="margin: 0 0 12px 0; color: #1e293b;">Feature 2: Scheduled Rides</h5>
                            <p style="color: #64748b; margin-bottom: 12px;">Book rides in advance for airport pickups or planned trips.</p>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                                <div>
                                    <strong style="color: #475569; font-size: 13px;">Database Changes:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                        <li>Add <code>scheduled_at</code> TIMESTAMP to rides</li>
                                        <li>Add <code>is_scheduled</code> BOOLEAN flag</li>
                                        <li>Create <code>scheduled_rides</code> job queue table</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong style="color: #475569; font-size: 13px;">Implementation:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                        <li>Cron job checks rides due in 15 mins</li>
                                        <li>Pre-assigns driver 10 mins before</li>
                                        <li>SMS/Push reminder to both parties</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Feature 3: Multiple Stops -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #f59e0b;">
                            <h5 style="margin: 0 0 12px 0; color: #1e293b;">Feature 3: Multiple Stops</h5>
                            <p style="color: #64748b; margin-bottom: 12px;">Add intermediate stops during the ride for pickups or quick errands.</p>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                                <div>
                                    <strong style="color: #475569; font-size: 13px;">Database Changes:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                        <li>Create <code>ride_stops</code> table</li>
                                        <li>Fields: ride_id, stop_order, lat, lng, address, wait_time</li>
                                        <li>Add <code>current_stop_index</code> to rides</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong style="color: #475569; font-size: 13px;">Pricing Logic:</strong>
                                    <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                        <li>Calculate total route distance via all stops</li>
                                        <li>Add wait time charges (per minute)</li>
                                        <li>Max 3 stops, max 5 min wait per stop</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Reversion Scenario -->
                    <div class="feature-card" style="border-left-color: #ef4444;">
                        <h4 style="color: #991b1b;">Feature Reversion Scenario: Disabling Ride Sharing</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">
                            <strong>Situation:</strong> Ride sharing feature causes frequent complaints about long detours and incorrect fare splitting. Need to disable it quickly.
                        </p>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                            <div style="background: #fef2f2; padding: 16px; border-radius: 8px;">
                                <strong style="color: #991b1b; font-size: 14px;">Immediate Actions</strong>
                                <ol style="margin: 8px 0 0 0; padding-left: 20px; color: #7f1d1d; font-size: 13px;">
                                    <li>Feature flag: Set <code>RIDE_SHARE_ENABLED=false</code></li>
                                    <li>Hide "Share" option in rider app (config update)</li>
                                    <li>Complete existing shared rides normally</li>
                                    <li>Notify drivers of temporary suspension</li>
                                </ol>
                            </div>
                            <div style="background: #fef2f2; padding: 16px; border-radius: 8px;">
                                <strong style="color: #991b1b; font-size: 14px;">Data Handling</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #7f1d1d; font-size: 13px;">
                                    <li>Keep ride_group_id and shared ride data</li>
                                    <li>Mark affected rides for manual review</li>
                                    <li>Issue partial refunds where detour > 15 mins</li>
                                    <li>Do NOT delete columns (may re-enable later)</li>
                                </ul>
                            </div>
                        </div>

                        <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 16px;">
                            <strong style="color: #92400e;">Rollback Time:</strong>
                            <span style="color: #78716c;">Under 5 minutes with feature flag. No deployment needed.</span>
                        </div>
                    </div>

                    <!-- Pros and Cons -->
                    <div class="pros-cons-grid">
                        <div class="pros-section">
                            <h4>Pros of MVP Architecture</h4>
                            <ul style="padding-left: 20px; color: #475569;">
                                <li style="margin-bottom: 16px;">
                                    <strong>Redis for Real-time Location</strong>
                                    <div class="care-points">
                                        <h5>WHY IT WORKS</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>GEOADD/GEORADIUS have O(log(N)) complexity</li>
                                            <li>Handles 100K+ location updates/second</li>
                                            <li>Built-in TTL auto-expires stale locations</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>WebSocket for Live Tracking</strong>
                                    <div class="care-points">
                                        <h5>WHY IT WORKS</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Bi-directional: driver sends, rider receives instantly</li>
                                            <li>Lower latency than polling (no HTTP overhead)</li>
                                            <li>Connection multiplexing reduces server load</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>Kafka for Event Sourcing</strong>
                                    <div class="care-points">
                                        <h5>WHY IT WORKS</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Complete ride history for analytics/disputes</li>
                                            <li>Decouples services (async processing)</li>
                                            <li>Replay events for debugging issues</li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="cons-section">
                            <h4>Cons / Challenges</h4>
                            <ul style="padding-left: 20px; color: #475569;">
                                <li style="margin-bottom: 16px;">
                                    <strong>Single Redis Instance Bottleneck</strong>
                                    <div class="manage-points">
                                        <h5>HOW TO MANAGE</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Use Redis Cluster when scaling beyond 1 city</li>
                                            <li>Partition by geohash prefix for locality</li>
                                            <li>Add read replicas for GEORADIUS queries</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>WebSocket Connection Management</strong>
                                    <div class="manage-points">
                                        <h5>HOW TO MANAGE</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Implement heartbeat ping/pong (30 sec interval)</li>
                                            <li>Handle reconnection with exponential backoff</li>
                                            <li>Use sticky sessions or Redis for WS state</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>Matching Algorithm Accuracy</strong>
                                    <div class="manage-points">
                                        <h5>HOW TO MANAGE</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Factor in traffic data for accurate ETA</li>
                                            <li>A/B test different ranking algorithms</li>
                                            <li>Learn from driver acceptance patterns</li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- ==================== PAN-INDIA SCALE ==================== -->
                <section class="stage-section" id="ride-pan-india">
                    <div class="stage-header">
                        <span class="stage-badge pan-india">PAN-India Scale</span>
                        <h2 style="margin: 0;">Scaling to 100+ Cities</h2>
                    </div>
                    <p style="color: #64748b; margin-bottom: 24px;">Handle millions of daily rides across India with city-wise infrastructure, dynamic pricing, and driver incentive programs.</p>

                    <!-- City-wise Partitioning -->
                    <div class="feature-card">
                        <h4>City-wise Data Partitioning</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">
                            <span class="term-tooltip" onclick="showTooltip('sharding')">Sharding<span class="info-icon">i</span></span>
                            strategy for multi-city operations
                        </p>

                        <div class="diagram-container">
                            <h4>Sharding Architecture</h4>
                            <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                                <div class="arch-box lb">Global Load Balancer (Route by City)</div>
                                <div class="arch-arrow" style="transform: rotate(90deg);">---></div>
                                <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                                    <div style="text-align: center;">
                                        <div class="arch-box server" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">Bangalore Cluster</div>
                                        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Redis + PostgreSQL</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div class="arch-box server" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">Mumbai Cluster</div>
                                        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Redis + PostgreSQL</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div class="arch-box server" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">Delhi Cluster</div>
                                        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Redis + PostgreSQL</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div class="arch-box server" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);">Other Cities</div>
                                        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Shared Clusters</div>
                                    </div>
                                </div>
                                <div class="arch-arrow" style="transform: rotate(90deg);">---></div>
                                <div class="arch-box db" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);">Central Analytics DB (Read Replicas)</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 20px;">
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px;">
                                <strong style="color: #0369a1;">Shard Key: city_id</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                    <li>All rides within city stay on same shard</li>
                                    <li>No cross-shard joins needed for matching</li>
                                    <li>Easy to add new cities (new shard)</li>
                                </ul>
                            </div>
                            <div style="background: #fdf4ff; padding: 16px; border-radius: 8px;">
                                <strong style="color: #a21caf;">Cross-City Rides (Outstation)</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                    <li>Stored in origin city shard</li>
                                    <li>Sync driver location to destination shard</li>
                                    <li>Special pricing rules apply</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Surge Pricing Algorithm -->
                    <div class="feature-card">
                        <h4>Surge Pricing Algorithm</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">Dynamic pricing based on supply-demand ratio in micro-zones</p>

                        <div class="diagram-container">
                            <h4>Surge Calculation Flow</h4>
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                                    <div style="font-size: 24px;">5 km</div>
                                    <div style="font-size: 11px; color: #64748b;">Hexagonal Zone</div>
                                </div>
                                <div class="arch-arrow">--></div>
                                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                                    <div style="font-size: 16px;"><strong>Demand:</strong> 50 requests</div>
                                    <div style="font-size: 16px;"><strong>Supply:</strong> 20 drivers</div>
                                </div>
                                <div class="arch-arrow">--></div>
                                <div style="text-align: center; padding: 12px; background: #fef3c7; border-radius: 8px;">
                                    <div style="font-size: 14px;"><strong>Ratio:</strong> 2.5</div>
                                    <div style="font-size: 14px;"><strong>Surge:</strong> 1.8x</div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #1e293b; padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">Surge Pricing Formula</div>
                            <pre style="margin: 0; font-size: 12px; color: #a5f3fc;">
// Surge multiplier calculation
function calculateSurgeMultiplier(zoneId) {
  const demand = getActiveRideRequests(zoneId, last5Minutes);
  const supply = getAvailableDrivers(zoneId);
  const ratio = demand / Math.max(supply, 1);

  // Surge tiers
  if (ratio < 1.0) return 1.0;      // No surge
  if (ratio < 1.5) return 1.2;      // Light surge
  if (ratio < 2.0) return 1.5;      // Medium surge
  if (ratio < 3.0) return 1.8;      // High surge
  return Math.min(ratio * 0.7, 3.0); // Max 3x cap
}

// Applied fare = baseFare * surgeMultiplier
// Recalculate every 2 minutes per zone</pre>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">
                            <div style="background: #dcfce7; padding: 12px; border-radius: 8px;">
                                <strong style="color: #166534; font-size: 13px;">Heat Maps</strong>
                                <p style="margin: 4px 0 0 0; color: #64748b; font-size: 12px;">Show surge zones to drivers (attracts supply)</p>
                            </div>
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px;">
                                <strong style="color: #92400e; font-size: 13px;">Time Decay</strong>
                                <p style="margin: 4px 0 0 0; color: #64748b; font-size: 12px;">Surge drops gradually to prevent oscillation</p>
                            </div>
                            <div style="background: #dbeafe; padding: 12px; border-radius: 8px;">
                                <strong style="color: #1e40af; font-size: 13px;">Regulatory Caps</strong>
                                <p style="margin: 4px 0 0 0; color: #64748b; font-size: 12px;">City-specific max surge limits (some cap at 2x)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Driver Incentives System -->
                    <div class="feature-card">
                        <h4>Driver Incentives System</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">Gamification and rewards to ensure driver availability during peak hours</p>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                            <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border: 2px solid #22c55e;">
                                <h5 style="margin: 0 0 12px 0; color: #166534;">Quest Bonuses</h5>
                                <ul style="margin: 0; padding-left: 20px; color: #475569; font-size: 13px;">
                                    <li><strong>Daily Target:</strong> Complete 15 rides = Rs 500 bonus</li>
                                    <li><strong>Peak Hours:</strong> 5 rides 8-10 AM = Rs 200 extra</li>
                                    <li><strong>Weekend Streak:</strong> 40 rides Sat-Sun = Rs 1000</li>
                                </ul>
                                <div style="margin-top: 12px; padding: 8px; background: #dcfce7; border-radius: 4px; font-size: 12px;">
                                    <strong>DB Table:</strong> driver_quests (driver_id, quest_type, target, progress, bonus_amount)
                                </div>
                            </div>
                            <div style="background: #fdf4ff; padding: 16px; border-radius: 8px; border: 2px solid #a855f7;">
                                <h5 style="margin: 0 0 12px 0; color: #7e22ce;">Zone Incentives</h5>
                                <ul style="margin: 0; padding-left: 20px; color: #475569; font-size: 13px;">
                                    <li><strong>Airport Queue:</strong> Rs 50 per ride extra</li>
                                    <li><strong>Low Supply Zones:</strong> 1.2x earnings multiplier</li>
                                    <li><strong>Night Hours (11PM-5AM):</strong> Rs 30 per ride</li>
                                </ul>
                                <div style="margin-top: 12px; padding: 8px; background: #f5d0fe; border-radius: 4px; font-size: 12px;">
                                    <strong>DB Table:</strong> zone_incentives (zone_id, time_slot, multiplier, flat_bonus)
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- New Feature: Package Delivery -->
                    <div class="feature-card" style="border-left-color: #8b5cf6;">
                        <h4>New Feature: Package Delivery</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">Leverage driver network for same-day package delivery service</p>

                        <div class="diagram-container">
                            <h4>Package Delivery Flow</h4>
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: center; font-size: 13px;">
                                <div class="arch-box client">Sender App</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box server">Package Service</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box server">Matching (Bike/Auto)</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box client" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">Driver Pickup</div>
                                <div class="arch-arrow">--></div>
                                <div class="arch-box client" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">Receiver</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 16px;">
                            <div>
                                <strong style="color: #475569; font-size: 13px;">Database Additions:</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                    <li><code>packages</code> table: sender_id, receiver_phone, weight_kg, dimensions</li>
                                    <li><code>delivery_type</code> ENUM: INSTANT, SAME_DAY, SCHEDULED</li>
                                    <li>Add <code>has_package</code> flag to rides table</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: #475569; font-size: 13px;">Special Handling:</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                    <li>OTP verification at both pickup and delivery</li>
                                    <li>Photo proof of package condition</li>
                                    <li>Insurance option for valuable items</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Pros/Cons for PAN-India -->
                    <div class="pros-cons-grid">
                        <div class="pros-section">
                            <h4>Pros of City-wise Sharding</h4>
                            <ul style="padding-left: 20px; color: #475569;">
                                <li style="margin-bottom: 16px;">
                                    <strong>Data Locality</strong>
                                    <div class="care-points">
                                        <h5>WHY IT WORKS</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>99% of queries are city-specific (no cross-shard)</li>
                                            <li>Lower latency with regional database clusters</li>
                                            <li>Easy compliance with data residency laws</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>Independent Scaling</strong>
                                    <div class="care-points">
                                        <h5>WHY IT WORKS</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Metro cities get dedicated high-capacity clusters</li>
                                            <li>Smaller cities can share resources</li>
                                            <li>Scale each city based on actual demand</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>Fault Isolation</strong>
                                    <div class="care-points">
                                        <h5>WHY IT WORKS</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Mumbai outage does not affect Bangalore</li>
                                            <li>Rolling deployments city by city</li>
                                            <li>A/B test features in specific cities first</li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="cons-section">
                            <h4>Cons / Trade-offs</h4>
                            <ul style="padding-left: 20px; color: #475569;">
                                <li style="margin-bottom: 16px;">
                                    <strong>Cross-City Operations Complexity</strong>
                                    <div class="manage-points">
                                        <h5>HOW TO MANAGE</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Create dedicated "outstation" service</li>
                                            <li>Use eventual consistency for analytics</li>
                                            <li>Centralized user profile service</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>Surge Pricing Abuse</strong>
                                    <div class="manage-points">
                                        <h5>HOW TO MANAGE</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Detect artificial demand (multiple cancellations)</li>
                                            <li>Gradual surge increase (not instant spikes)</li>
                                            <li>Show surge forecast to riders</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>Incentive Cost Control</strong>
                                    <div class="manage-points">
                                        <h5>HOW TO MANAGE</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>ML model to predict optimal incentive amounts</li>
                                            <li>Cap total incentive budget per city per day</li>
                                            <li>Dynamic adjustment based on ROI</li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- ==================== HIGH TRAFFIC ==================== -->
                <section class="stage-section" id="ride-high-traffic">
                    <div class="stage-header">
                        <span class="stage-badge high-traffic">High Traffic</span>
                        <h2 style="margin: 0;">Peak Hours and Major Events</h2>
                    </div>
                    <p style="color: #64748b; margin-bottom: 24px;">Handle 10x traffic spikes during New Year Eve, IPL matches, concerts with optimized matching and geospatial indexing.</p>

                    <!-- Matching Algorithm Optimization -->
                    <div class="feature-card">
                        <h4>Matching Algorithm Optimization</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">Efficient driver-rider matching at scale with
                            <span class="term-tooltip" onclick="showTooltip('consistent-hashing')">Consistent Hashing<span class="info-icon">i</span></span>
                        </p>

                        <div class="diagram-container">
                            <h4>Optimized Matching Pipeline</h4>
                            <div style="display: flex; flex-direction: column; gap: 16px; align-items: center;">
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: center;">
                                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; min-width: 100px;">
                                        <div style="font-size: 24px; margin-bottom: 4px;">1</div>
                                        <div style="font-size: 12px; color: #64748b;">Ride Request</div>
                                    </div>
                                    <div class="arch-arrow">--></div>
                                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; min-width: 100px;">
                                        <div style="font-size: 24px; margin-bottom: 4px;">2</div>
                                        <div style="font-size: 12px; color: #64748b;">Geohash Lookup</div>
                                    </div>
                                    <div class="arch-arrow">--></div>
                                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; min-width: 100px;">
                                        <div style="font-size: 24px; margin-bottom: 4px;">3</div>
                                        <div style="font-size: 12px; color: #64748b;">Filter Drivers</div>
                                    </div>
                                    <div class="arch-arrow">--></div>
                                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; min-width: 100px;">
                                        <div style="font-size: 24px; margin-bottom: 4px;">4</div>
                                        <div style="font-size: 12px; color: #64748b;">Score and Rank</div>
                                    </div>
                                    <div class="arch-arrow">--></div>
                                    <div style="text-align: center; padding: 16px; background: #dcfce7; border-radius: 8px; min-width: 100px;">
                                        <div style="font-size: 24px; margin-bottom: 4px;">5</div>
                                        <div style="font-size: 12px; color: #166534;">Best Match</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #1e293b; padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">Driver Scoring Algorithm</div>
                            <pre style="margin: 0; font-size: 12px; color: #a5f3fc;">
function scoreDriver(driver, rideRequest) {
  let score = 0;

  // Distance score (40% weight) - closer is better
  const distance = haversineDistance(driver.location, rideRequest.pickup);
  score += (1 - Math.min(distance / 5000, 1)) * 40;

  // ETA score (25% weight) - factor in traffic
  const eta = calculateETA(driver.location, rideRequest.pickup);
  score += (1 - Math.min(eta / 600, 1)) * 25;

  // Rating score (15% weight)
  score += (driver.rating / 5) * 15;

  // Acceptance rate score (10% weight)
  score += driver.acceptance_rate * 10;

  // Heading score (10% weight) - driver facing towards pickup
  const headingDiff = angleDifference(driver.heading, bearingTo(rideRequest.pickup));
  score += (1 - headingDiff / 180) * 10;

  return score; // 0-100
}</pre>
                        </div>
                    </div>

                    <!-- Geospatial Indexing -->
                    <div class="feature-card">
                        <h4>Geospatial Indexing: QuadTree vs Geohash</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">Efficient spatial data structures for finding nearby drivers in O(log n) time</p>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <!-- QuadTree -->
                            <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border: 2px solid #22c55e;">
                                <h5 style="margin: 0 0 16px 0; color: #166534;">QuadTree</h5>
                                <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px; text-align: center;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 4px; width: 120px; height: 120px; margin: 0 auto;">
                                        <div style="background: #bbf7d0; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 2px;">
                                            <div style="background: #86efac;"></div>
                                            <div style="background: #86efac;"></div>
                                            <div style="background: #4ade80;"></div>
                                            <div style="background: #86efac;"></div>
                                        </div>
                                        <div style="background: #bbf7d0;"></div>
                                        <div style="background: #bbf7d0;"></div>
                                        <div style="background: #dcfce7;"></div>
                                    </div>
                                    <div style="font-size: 11px; color: #64748b; margin-top: 8px;">Recursive subdivision</div>
                                </div>
                                <ul style="margin: 0; padding-left: 20px; color: #475569; font-size: 13px;">
                                    <li><strong>Pros:</strong> Dynamic, adapts to density</li>
                                    <li><strong>Cons:</strong> Memory overhead, rebalancing</li>
                                    <li><strong>Best for:</strong> In-memory, single server</li>
                                </ul>
                            </div>

                            <!-- Geohash -->
                            <div style="background: #eff6ff; padding: 20px; border-radius: 12px; border: 2px solid #3b82f6;">
                                <h5 style="margin: 0 0 16px 0; color: #1e40af;">Geohash</h5>
                                <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px; text-align: center;">
                                    <div style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: center;">
                                        <div style="padding: 4px 8px; background: #dbeafe; border-radius: 4px; font-family: monospace; font-size: 11px;">tdr1</div>
                                        <div style="padding: 4px 8px; background: #dbeafe; border-radius: 4px; font-family: monospace; font-size: 11px;">tdr2</div>
                                        <div style="padding: 4px 8px; background: #93c5fd; border-radius: 4px; font-family: monospace; font-size: 11px;">tdr3</div>
                                        <div style="padding: 4px 8px; background: #dbeafe; border-radius: 4px; font-family: monospace; font-size: 11px;">tdr4</div>
                                    </div>
                                    <div style="margin-top: 8px; font-family: monospace; font-size: 12px; color: #3b82f6;">
                                        12.9716, 77.5946 -> "tdr3xp"
                                    </div>
                                    <div style="font-size: 11px; color: #64748b; margin-top: 4px;">String encoding of location</div>
                                </div>
                                <ul style="margin: 0; padding-left: 20px; color: #475569; font-size: 13px;">
                                    <li><strong>Pros:</strong> Simple string, easy to shard</li>
                                    <li><strong>Cons:</strong> Edge cases at boundaries</li>
                                    <li><strong>Best for:</strong> Distributed Redis/DB</li>
                                </ul>
                            </div>
                        </div>

                        <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <strong style="color: #92400e;">Our Choice: Geohash with Redis</strong>
                            <p style="margin: 8px 0 0 0; color: #78716c; font-size: 13px;">
                                Use geohash precision 6 (~1.2km x 0.6km cells). Store drivers as:
                                <code>ZADD drivers:geo:{geohash_prefix} {timestamp} {driver_id}</code>.
                                Query neighbors for edge cases: include 8 adjacent cells.
                            </p>
                        </div>
                    </div>

                    <!-- ETA Calculation at Scale -->
                    <div class="feature-card">
                        <h4>ETA Calculation at Scale</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">Accurate arrival time predictions considering real-time traffic</p>

                        <div class="diagram-container">
                            <h4>ETA Pipeline</h4>
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box server" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">Route Service</div>
                                <div class="arch-arrow">+</div>
                                <div class="arch-box server" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">Traffic Service</div>
                                <div class="arch-arrow">+</div>
                                <div class="arch-box server" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">Historical Data</div>
                                <div class="arch-arrow">=</div>
                                <div class="arch-box" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white;">Predicted ETA</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 20px;">
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                                <strong style="color: #475569; font-size: 14px;">Segment-based Calculation</strong>
                                <ol style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                    <li>Divide route into road segments</li>
                                    <li>Get current speed for each segment</li>
                                    <li>Sum segment times + buffer</li>
                                    <li>Add pickup wait time estimate</li>
                                </ol>
                            </div>
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                                <strong style="color: #475569; font-size: 14px;">Traffic Data Sources</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                    <li>Own driver GPS data (primary)</li>
                                    <li>Google Maps Traffic API (backup)</li>
                                    <li>Historical patterns by time/day</li>
                                    <li>Special events calendar</li>
                                </ul>
                            </div>
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                                <strong style="color: #475569; font-size: 14px;">Caching Strategy</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                    <li>Cache segment speeds (TTL: 2 min)</li>
                                    <li>Pre-compute popular routes</li>
                                    <li>Use CDN for static map tiles</li>
                                    <li>Batch ETA requests per zone</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Event Handling -->
                    <div class="feature-card" style="border-left-color: #f59e0b;">
                        <h4>Major Event Handling (IPL, Concerts, New Year)</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">Pre-planned capacity for predictable high-demand events</p>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                            <div style="background: #fef3c7; padding: 16px; border-radius: 8px;">
                                <strong style="color: #92400e; font-size: 14px;">Pre-Event (24h before)</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #78716c; font-size: 13px;">
                                    <li>Notify drivers of bonus incentives near venue</li>
                                    <li>Pre-scale matching service instances</li>
                                    <li>Warm up Redis caches for event zone</li>
                                    <li>Create dedicated driver queue at venue</li>
                                </ul>
                            </div>
                            <div style="background: #fee2e2; padding: 16px; border-radius: 8px;">
                                <strong style="color: #991b1b; font-size: 14px;">During Event</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #7f1d1d; font-size: 13px;">
                                    <li>Enable request queuing (fair ordering)</li>
                                    <li>Show estimated wait time to riders</li>
                                    <li>Surge cap at 2x (goodwill pricing)</li>
                                    <li>Dedicated support team on standby</li>
                                </ul>
                            </div>
                            <div style="background: #dcfce7; padding: 16px; border-radius: 8px;">
                                <strong style="color: #166534; font-size: 14px;">Post-Event (Surge exit)</strong>
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #14532d; font-size: 13px;">
                                    <li>Gradual surge reduction (15 min steps)</li>
                                    <li>Incentivize drivers to stay in area</li>
                                    <li>Process queued requests in order</li>
                                    <li>Post-event analytics report</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Pros/Cons for High Traffic -->
                    <div class="pros-cons-grid">
                        <div class="pros-section">
                            <h4>Pros of Geohash + Batch Matching</h4>
                            <ul style="padding-left: 20px; color: #475569;">
                                <li style="margin-bottom: 16px;">
                                    <strong>O(1) Spatial Lookups</strong>
                                    <div class="care-points">
                                        <h5>WHY IT WORKS</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Geohash converts 2D location to 1D string</li>
                                            <li>Simple hash table lookup per cell</li>
                                            <li>Prefix matching for variable precision</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>Horizontal Scaling</strong>
                                    <div class="care-points">
                                        <h5>WHY IT WORKS</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Each geohash cell can be its own shard</li>
                                            <li>Stateless matching workers scale linearly</li>
                                            <li>No single point of failure</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>ML-based ETA Accuracy</strong>
                                    <div class="care-points">
                                        <h5>WHY IT WORKS</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Learns from millions of completed rides</li>
                                            <li>Adapts to local traffic patterns</li>
                                            <li>Confidence intervals for user expectations</li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="cons-section">
                            <h4>Cons / Challenges</h4>
                            <ul style="padding-left: 20px; color: #475569;">
                                <li style="margin-bottom: 16px;">
                                    <strong>Geohash Boundary Problem</strong>
                                    <div class="manage-points">
                                        <h5>HOW TO MANAGE</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Always query 8 neighboring cells</li>
                                            <li>Use overlap zones at boundaries</li>
                                            <li>Final distance check after retrieval</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>Stale Location Data</strong>
                                    <div class="manage-points">
                                        <h5>HOW TO MANAGE</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>TTL of 30 seconds on driver locations</li>
                                            <li>Exclude drivers with old timestamps</li>
                                            <li>Fallback to last known + predicted movement</li>
                                        </ul>
                                    </div>
                                </li>
                                <li style="margin-bottom: 16px;">
                                    <strong>Event Surge Unpredictability</strong>
                                    <div class="manage-points">
                                        <h5>HOW TO MANAGE</h5>
                                        <ul style="padding-left: 16px; margin: 0; font-size: 12px;">
                                            <li>Maintain event calendar with venue data</li>
                                            <li>Auto-scaling triggers at 70% capacity</li>
                                            <li>Graceful degradation (queue vs reject)</li>
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- ==================== GLOBAL SCALE ==================== -->
                <section class="stage-section" id="ride-global">
                    <div class="stage-header">
                        <span class="stage-badge global">Global Scale</span>
                        <h2 style="margin: 0;">International Expansion</h2>
                    </div>
                    <p style="color: #64748b; margin-bottom: 24px;">Operating across 70+ countries with multi-region infrastructure, local compliance, and payment systems.</p>

                    <div class="diagram-container">
                        <h4>Global Infrastructure</h4>
                        <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                            <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;">
                                <div style="text-align: center;">
                                    <div class="arch-box server" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); min-width: 100px;">APAC Region</div>
                                    <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Singapore, Mumbai, Sydney</div>
                                </div>
                                <div style="text-align: center;">
                                    <div class="arch-box server" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); min-width: 100px;">Americas</div>
                                    <div style="font-size: 11px; color: #64748b; margin-top: 4px;">US-East, US-West, Brazil</div>
                                </div>
                                <div style="text-align: center;">
                                    <div class="arch-box server" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); min-width: 100px;">EMEA</div>
                                    <div style="font-size: 11px; color: #64748b; margin-top: 4px;">London, Frankfurt, UAE</div>
                                </div>
                            </div>
                            <div class="arch-arrow" style="transform: rotate(90deg);">|||</div>
                            <div class="arch-box db" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);">Global Control Plane (Config, Feature Flags, Analytics)</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 24px;">
                        <div class="feature-card" style="margin: 0;">
                            <h5 style="margin: 0 0 12px 0; color: #1e293b;">Multi-Region Data Strategy</h5>
                            <ul style="margin: 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                <li>User data stays in region (GDPR compliance)</li>
                                <li>Cross-region user profile sync (eventual)</li>
                                <li>Global user ID with regional sharding</li>
                                <li>Active-active setup for 99.99% availability</li>
                            </ul>
                        </div>
                        <div class="feature-card" style="margin: 0;">
                            <h5 style="margin: 0 0 12px 0; color: #1e293b;">Local Payment Integration</h5>
                            <ul style="margin: 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                <li>Region-specific payment gateways</li>
                                <li>Multi-currency support with live FX rates</li>
                                <li>Local wallets (Paytm India, GrabPay SEA)</li>
                                <li>Cash handling for cash-heavy markets</li>
                            </ul>
                        </div>
                        <div class="feature-card" style="margin: 0;">
                            <h5 style="margin: 0 0 12px 0; color: #1e293b;">Regulatory Compliance</h5>
                            <ul style="margin: 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                                <li>Driver background checks per country law</li>
                                <li>Insurance requirements vary by region</li>
                                <li>Surge pricing caps (legal limits)</li>
                                <li>Data retention policies per jurisdiction</li>
                            </ul>
                        </div>
                    </div>

                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 24px;">
                        <h4 style="margin: 0 0 16px 0; color: #1e293b;">Key Global Scale Numbers</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; text-align: center;">
                            <div style="background: white; padding: 16px; border-radius: 8px;">
                                <div style="font-size: 28px; font-weight: bold; color: #3b82f6;">25M+</div>
                                <div style="font-size: 12px; color: #64748b;">Daily Rides</div>
                            </div>
                            <div style="background: white; padding: 16px; border-radius: 8px;">
                                <div style="font-size: 28px; font-weight: bold; color: #22c55e;">5M+</div>
                                <div style="font-size: 12px; color: #64748b;">Active Drivers</div>
                            </div>
                            <div style="background: white; padding: 16px; border-radius: 8px;">
                                <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">70+</div>
                                <div style="font-size: 12px; color: #64748b;">Countries</div>
                            </div>
                            <div style="background: white; padding: 16px; border-radius: 8px;">
                                <div style="font-size: 28px; font-weight: bold; color: #8b5cf6;">1M+</div>
                                <div style="font-size: 12px; color: #64748b;">Requests/min Peak</div>
                            </div>
                            <div style="background: white; padding: 16px; border-radius: 8px;">
                                <div style="font-size: 28px; font-weight: bold; color: #ec4899;">99.99%</div>
                                <div style="font-size: 12px; color: #64748b;">Uptime SLA</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Deep Learning Q&A -->
                <section class="stage-section" style="border-bottom: none;">
                    <div class="stage-header">
                        <span class="stage-badge" style="background: #fce7f3; color: #be185d;">Deep Dive</span>
                        <h2 style="margin: 0;">Interview Questions and Answers</h2>
                    </div>

                    <div class="feature-card">
                        <h4>Q1: How do you handle driver location updates at scale?</h4>
                        <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <strong style="color: #166534;">Answer:</strong>
                            <p style="color: #475569; margin: 8px 0 0 0; font-size: 14px; line-height: 1.7;">
                                We use a multi-tier approach: <strong>1)</strong> Driver apps send GPS updates every 3-5 seconds via
                                <span class="term-tooltip" onclick="showTooltip('websocket')">WebSocket<span class="info-icon">i</span></span>
                                to minimize connection overhead. <strong>2)</strong> WebSocket servers publish to
                                <span class="term-tooltip" onclick="showTooltip('kafka')">Kafka<span class="info-icon">i</span></span>
                                topics partitioned by city. <strong>3)</strong> Location consumers update
                                <span class="term-tooltip" onclick="showTooltip('redis')">Redis<span class="info-icon">i</span></span>
                                GEO sorted sets with GEOADD command. <strong>4)</strong> Stale locations auto-expire with 30-second TTL.
                                For 1M active drivers updating every 4 seconds, that is around 250K updates/sec globally, handled by sharding Redis by geohash prefix.
                            </p>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>Q2: How does the driver-rider matching algorithm work?</h4>
                        <div style="background: #eff6ff; padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <strong style="color: #1e40af;">Answer:</strong>
                            <p style="color: #475569; margin: 8px 0 0 0; font-size: 14px; line-height: 1.7;">
                                <strong>Step 1:</strong> Calculate geohash of pickup location and query that cell + 8 neighbors from Redis.
                                <strong>Step 2:</strong> Filter for available drivers matching vehicle type.
                                <strong>Step 3:</strong> Score each driver using weighted factors: distance (40%), ETA with traffic (25%), rating (15%), acceptance rate (10%), heading direction (10%).
                                <strong>Step 4:</strong> Send request to top-scored driver with 15-second timeout.
                                <strong>Step 5:</strong> If declined/timeout, try next driver. After 3 failures, expand search radius.
                                We use
                                <span class="term-tooltip" onclick="showTooltip('consistent-hashing')">Consistent Hashing<span class="info-icon">i</span></span>
                                to route matching requests to specific workers per zone.
                            </p>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>Q3: How do you calculate surge pricing fairly?</h4>
                        <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <strong style="color: #92400e;">Answer:</strong>
                            <p style="color: #475569; margin: 8px 0 0 0; font-size: 14px; line-height: 1.7;">
                                We divide cities into hexagonal zones (~5km). Every 2 minutes, we calculate demand/supply ratio per zone.
                                Surge multiplier follows a curve: 1x (ratio less than 1), 1.2x (1-1.5), 1.5x (1.5-2), 1.8x (2-3), capped at 3x.
                                <strong>Key safeguards:</strong> Surge increases gradually (not instant spikes), we show riders the multiplier before booking,
                                surge heat maps incentivize drivers to move to high-demand areas, and we have city-specific regulatory caps.
                                During major events, we pre-announce fixed surge caps (goodwill pricing) and use request queuing instead of extreme surge.
                            </p>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>Q4: How do you handle database scaling for rides data?</h4>
                        <div style="background: #fdf4ff; padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <strong style="color: #a21caf;">Answer:</strong>
                            <p style="color: #475569; margin: 8px 0 0 0; font-size: 14px; line-height: 1.7;">
                                We use
                                <span class="term-tooltip" onclick="showTooltip('sharding')">Sharding<span class="info-icon">i</span></span>
                                by city_id as the primary strategy. Each major metro (Bangalore, Mumbai, Delhi) has dedicated PostgreSQL clusters.
                                Smaller cities share pooled clusters grouped by region. <strong>Why city-based?</strong> 99% of ride queries are city-scoped
                                (matching, pricing, analytics), so no cross-shard joins needed. For the 1% outstation rides, we store in origin city
                                and sync driver location to destination city Redis. Global user profiles are in a separate service with eventual consistency.
                            </p>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>Q5: What happens if the matching service goes down?</h4>
                        <div style="background: #fee2e2; padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <strong style="color: #991b1b;">Answer:</strong>
                            <p style="color: #475569; margin: 8px 0 0 0; font-size: 14px; line-height: 1.7;">
                                <strong>Circuit breaker pattern:</strong> If matching service fails 50% of requests in 30 seconds, circuit opens.
                                <strong>Fallback 1:</strong> Simple nearest-driver algorithm runs directly on ride service (degraded but functional).
                                <strong>Fallback 2:</strong> Queue requests in Kafka, process when service recovers (show "High demand, finding driver" to users).
                                <strong>Recovery:</strong> Half-open state tests 10% traffic, auto-close circuit if healthy.
                                <strong>Prevention:</strong> Matching service runs 3 replicas minimum per city, health checks every 5 seconds.
                            </p>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Notification Section -->
        <div id="notification" class="system-section">
            <h1>üîî Notification System Design</h1>
            <p style="color: #64748b; margin-bottom: 24px;">Design a multi-channel notification system supporting Push, SMS, Email at scale</p>

            <div id="notification-content">
                <!-- ==================== MVP STAGE ==================== -->
                <div class="stage-section" id="mvp">
                    <div class="stage-header">
                        <span class="stage-badge mvp">MVP Stage</span>
                        <h2>Multi-Channel Notification System</h2>
                    </div>
                    <p>Build a notification service supporting Push, SMS, and Email channels with template-based personalization.</p>

                    <!-- Database Schema -->
                    <div class="feature-card">
                        <h4>Database Schema Design</h4>
                        <div class="diagram-container">
                            <h4>Core Tables</h4>
                            <div class="schema-diagram">
                                <div class="schema-table">
                                    <div class="schema-table-header">users</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name">email</span><span class="field-type">VARCHAR(255)</span></div>
                                        <div class="schema-field"><span class="field-name">phone</span><span class="field-type">VARCHAR(20)</span></div>
                                        <div class="schema-field"><span class="field-name">device_token</span><span class="field-type">TEXT</span></div>
                                        <div class="schema-field"><span class="field-name">push_enabled</span><span class="field-type">BOOLEAN</span></div>
                                        <div class="schema-field"><span class="field-name">sms_enabled</span><span class="field-type">BOOLEAN</span></div>
                                        <div class="schema-field"><span class="field-name">email_enabled</span><span class="field-type">BOOLEAN</span></div>
                                        <div class="schema-field"><span class="field-name">timezone</span><span class="field-type">VARCHAR(50)</span></div>
                                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMP</span></div>
                                    </div>
                                </div>
                                <div class="relation-arrow">--&gt;</div>
                                <div class="schema-table">
                                    <div class="schema-table-header">notifications</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">user_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">template_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name">channel</span><span class="field-type">ENUM</span></div>
                                        <div class="schema-field"><span class="field-name">priority</span><span class="field-type">INT (1-5)</span></div>
                                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM</span></div>
                                        <div class="schema-field"><span class="field-name">payload</span><span class="field-type">JSONB</span></div>
                                        <div class="schema-field"><span class="field-name">scheduled_at</span><span class="field-type">TIMESTAMP</span></div>
                                        <div class="schema-field"><span class="field-name">created_at</span><span class="field-type">TIMESTAMP</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="schema-diagram" style="margin-top: 24px;">
                                <div class="schema-table">
                                    <div class="schema-table-header">templates</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name">name</span><span class="field-type">VARCHAR(100)</span></div>
                                        <div class="schema-field"><span class="field-name">channel</span><span class="field-type">ENUM</span></div>
                                        <div class="schema-field"><span class="field-name">subject</span><span class="field-type">VARCHAR(255)</span></div>
                                        <div class="schema-field"><span class="field-name">body</span><span class="field-type">TEXT</span></div>
                                        <div class="schema-field"><span class="field-name">variables</span><span class="field-type">JSONB</span></div>
                                        <div class="schema-field"><span class="field-name">is_active</span><span class="field-type">BOOLEAN</span></div>
                                        <div class="schema-field"><span class="field-name">version</span><span class="field-type">INT</span></div>
                                    </div>
                                </div>
                                <div class="relation-arrow">--&gt;</div>
                                <div class="schema-table">
                                    <div class="schema-table-header">delivery_logs</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name field-pk">id</span><span class="field-type">UUID PK</span></div>
                                        <div class="schema-field"><span class="field-name field-fk">notification_id</span><span class="field-type">UUID FK</span></div>
                                        <div class="schema-field"><span class="field-name">vendor</span><span class="field-type">VARCHAR(50)</span></div>
                                        <div class="schema-field"><span class="field-name">attempt_count</span><span class="field-type">INT</span></div>
                                        <div class="schema-field"><span class="field-name">status</span><span class="field-type">ENUM</span></div>
                                        <div class="schema-field"><span class="field-name">error_message</span><span class="field-type">TEXT</span></div>
                                        <div class="schema-field"><span class="field-name">vendor_response</span><span class="field-type">JSONB</span></div>
                                        <div class="schema-field"><span class="field-name">delivered_at</span><span class="field-type">TIMESTAMP</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- High Level Design -->
                    <div class="feature-card">
                        <h4>High-Level Design (HLD)</h4>
                        <div class="diagram-container">
                            <h4>Message Queue Architecture</h4>
                            <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                                <!-- Request Flow -->
                                <div style="display: flex; align-items: center; flex-wrap: wrap; justify-content: center; gap: 8px;">
                                    <div class="arch-box client">API Gateway</div>
                                    <span class="arch-arrow">--&gt;</span>
                                    <div class="arch-box server">Notification Service</div>
                                    <span class="arch-arrow">--&gt;</span>
                                    <div class="arch-box queue" onclick="showTooltip('message-queue')" style="cursor: pointer;">
                                        <span class="term-tooltip" style="color: white; border: none;">Message Queue<span class="info-icon">i</span></span>
                                    </div>
                                </div>
                                <!-- Queue Distribution -->
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="color: #64748b;">|</span>
                                </div>
                                <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: center;">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                        <div class="arch-box queue" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">Push Queue</div>
                                        <span class="arch-arrow" style="transform: rotate(90deg);">--&gt;</span>
                                        <div class="arch-box server">Push Worker</div>
                                        <span class="arch-arrow" style="transform: rotate(90deg);">--&gt;</span>
                                        <div class="arch-box cdn">FCM / APNS</div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                        <div class="arch-box queue" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">SMS Queue</div>
                                        <span class="arch-arrow" style="transform: rotate(90deg);">--&gt;</span>
                                        <div class="arch-box server">SMS Worker</div>
                                        <span class="arch-arrow" style="transform: rotate(90deg);">--&gt;</span>
                                        <div class="arch-box cdn">Twilio / MSG91</div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                                        <div class="arch-box queue" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">Email Queue</div>
                                        <span class="arch-arrow" style="transform: rotate(90deg);">--&gt;</span>
                                        <div class="arch-box server">Email Worker</div>
                                        <span class="arch-arrow" style="transform: rotate(90deg);">--&gt;</span>
                                        <div class="arch-box cdn">SendGrid / SES</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Channel Adapter Pattern -->
                        <div class="diagram-container" style="margin-top: 20px;">
                            <h4>Channel Adapter Pattern</h4>
                            <div style="display: flex; flex-direction: column; gap: 16px; align-items: center;">
                                <div style="background: #1e293b; color: #e2e8f0; padding: 16px 24px; border-radius: 8px; font-family: monospace; font-size: 13px; max-width: 100%; overflow-x: auto;">
<pre style="margin: 0; white-space: pre-wrap;">
interface ChannelAdapter {
    send(notification: Notification): Promise&lt;DeliveryResult&gt;
    getStatus(messageId: string): Promise&lt;Status&gt;
    validatePayload(payload: any): boolean
}

class PushAdapter implements ChannelAdapter {
    private fcmClient: FCMClient
    private apnsClient: APNSClient

    async send(notification) {
        const platform = notification.user.devicePlatform
        if (platform === 'android') {
            return this.fcmClient.send(notification)
        }
        return this.apnsClient.send(notification)
    }
}

class SMSAdapter implements ChannelAdapter { ... }
class EmailAdapter implements ChannelAdapter { ... }

// Factory Pattern for adapter selection
class AdapterFactory {
    static getAdapter(channel: Channel): ChannelAdapter {
        switch(channel) {
            case 'PUSH': return new PushAdapter()
            case 'SMS': return new SMSAdapter()
            case 'EMAIL': return new EmailAdapter()
        }
    }
}
</pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API Design -->
                    <div class="feature-card">
                        <h4>API Design</h4>

                        <div class="api-endpoint">
                            <span class="api-method post">POST</span>
                            <span>/api/v1/notify</span>
                            <p style="margin: 12px 0 0 0; font-size: 12px; color: #94a3b8;">Send notification to user(s)</p>
<pre style="margin: 12px 0 0 0; color: #94a3b8; font-size: 12px;">
Request Body:
{
    "user_ids": ["uuid1", "uuid2"],     // Target users
    "template_id": "welcome_email",      // Template reference
    "channels": ["PUSH", "EMAIL"],       // Delivery channels
    "priority": 3,                       // 1=Critical, 5=Low
    "variables": {                       // Template variables
        "user_name": "John",
        "order_id": "ORD123"
    },
    "scheduled_at": "2024-01-15T10:00:00Z",  // Optional scheduling
    "idempotency_key": "unique-request-id"   // Prevent duplicates
}

Response: 201 Created
{
    "notification_id": "notif_uuid",
    "status": "QUEUED",
    "estimated_delivery": "2024-01-15T10:00:05Z"
}
</pre>
                        </div>

                        <div class="api-endpoint">
                            <span class="api-method get">GET</span>
                            <span>/api/v1/notifications?user_id={id}&amp;status={status}&amp;page={n}</span>
                            <p style="margin: 12px 0 0 0; font-size: 12px; color: #94a3b8;">Fetch user notifications with pagination</p>
<pre style="margin: 12px 0 0 0; color: #94a3b8; font-size: 12px;">
Response: 200 OK
{
    "notifications": [
        {
            "id": "notif_uuid",
            "channel": "PUSH",
            "title": "Order Confirmed",
            "body": "Your order #ORD123 is confirmed",
            "status": "DELIVERED",
            "created_at": "2024-01-15T10:00:00Z",
            "read_at": null
        }
    ],
    "pagination": {
        "page": 1,
        "total_pages": 5,
        "total_count": 48
    }
}
</pre>
                        </div>

                        <div class="api-endpoint">
                            <span class="api-method put">PUT</span>
                            <span>/api/v1/preferences/{user_id}</span>
                            <p style="margin: 12px 0 0 0; font-size: 12px; color: #94a3b8;">Update user notification preferences</p>
<pre style="margin: 12px 0 0 0; color: #94a3b8; font-size: 12px;">
Request Body:
{
    "push_enabled": true,
    "sms_enabled": false,
    "email_enabled": true,
    "quiet_hours": {
        "enabled": true,
        "start": "22:00",
        "end": "08:00"
    },
    "category_preferences": {
        "marketing": false,
        "transactional": true,
        "updates": true
    }
}

Response: 200 OK
{
    "message": "Preferences updated successfully",
    "updated_at": "2024-01-15T10:00:00Z"
}
</pre>
                        </div>
                    </div>

                    <!-- Template Engine -->
                    <div class="feature-card">
                        <h4>Template Engine for Personalization</h4>
                        <div style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px;">
<pre style="margin: 0;">
// Template stored in DB
{
    "id": "order_confirmation",
    "subject": "Order {{order_id}} Confirmed!",
    "body": "Hi {{user_name}}, your order of {{item_count}} items
             worth {{currency}}{{total_amount}} is confirmed.

             {{#if express_delivery}}
             Express Delivery: Arriving by {{delivery_date}}
             {{else}}
             Standard Delivery: 3-5 business days
             {{/if}}

             Track your order: {{tracking_url}}"
}

// Template Engine (Handlebars-like)
class TemplateEngine {
    compile(template: string, variables: Record&lt;string, any&gt;): string {
        return template
            .replace(/\{\{(\w+)\}\}/g, (_, key) =&gt; variables[key] || '')
            .replace(/\{\{#if (\w+)\}\}(.*?)\{\{else\}\}(.*?)\{\{\/if\}\}/gs,
                (_, condition, ifTrue, ifFalse) =&gt;
                    variables[condition] ? ifTrue : ifFalse)
    }

    validate(template: string, requiredVars: string[]): boolean {
        const usedVars = template.match(/\{\{(\w+)\}\}/g) || []
        return requiredVars.every(v =&gt; usedVars.includes(`{{${v}}}`))
    }
}
</pre>
                        </div>
                    </div>

                    <!-- MVP Features -->
                    <div class="feature-card">
                        <h4>Feature 1: Notification Batching</h4>
                        <p>Group multiple notifications to the same user within a time window to prevent notification fatigue.</p>
                        <div style="background: #f1f5f9; padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 250px;">
                                    <strong style="color: #1e293b;">How it works:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; color: #475569;">
                                        <li>Buffer notifications in <span class="term-tooltip" onclick="showTooltip('redis')">Redis<span class="info-icon">i</span></span> with user_id as key</li>
                                        <li>Set TTL of 5 minutes on the buffer</li>
                                        <li>When TTL expires, batch all notifications</li>
                                        <li>Send single digest notification</li>
                                    </ul>
                                </div>
                                <div style="flex: 1; min-width: 250px;">
                                    <strong style="color: #1e293b;">Example:</strong>
                                    <div style="background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; margin-top: 8px;">
// Instead of 5 separate notifications:<br>
// "User A liked your post"<br>
// "User B liked your post"<br>
// "User C commented..."<br><br>
// Send one batched notification:<br>
"User A, B and 3 others interacted with your post"
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>Feature 2: Priority Queues</h4>
                        <p>Implement priority-based delivery to ensure critical notifications are sent first.</p>
                        <div class="diagram-container">
                            <h4>Priority Queue Implementation</h4>
                            <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                                <div style="background: #dc2626; color: white; padding: 16px; border-radius: 8px; text-align: center; min-width: 140px;">
                                    <div style="font-weight: 600;">P1 - Critical</div>
                                    <div style="font-size: 12px; margin-top: 4px;">OTP, Security Alerts</div>
                                    <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">Instant delivery</div>
                                </div>
                                <div style="background: #f59e0b; color: white; padding: 16px; border-radius: 8px; text-align: center; min-width: 140px;">
                                    <div style="font-weight: 600;">P2 - High</div>
                                    <div style="font-size: 12px; margin-top: 4px;">Order Updates</div>
                                    <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">&lt; 30 seconds</div>
                                </div>
                                <div style="background: #3b82f6; color: white; padding: 16px; border-radius: 8px; text-align: center; min-width: 140px;">
                                    <div style="font-weight: 600;">P3 - Normal</div>
                                    <div style="font-size: 12px; margin-top: 4px;">Promotions</div>
                                    <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">&lt; 5 minutes</div>
                                </div>
                                <div style="background: #6b7280; color: white; padding: 16px; border-radius: 8px; text-align: center; min-width: 140px;">
                                    <div style="font-weight: 600;">P4 - Low</div>
                                    <div style="font-size: 12px; margin-top: 4px;">Digests, Reports</div>
                                    <div style="font-size: 11px; margin-top: 4px; opacity: 0.8;">Best effort</div>
                                </div>
                            </div>
                        </div>
                        <div style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; margin-top: 12px;">
<pre style="margin: 0;">
// Using Redis Sorted Sets for priority queues
class PriorityQueueManager {
    private redis: Redis

    async enqueue(notification: Notification) {
        // Score = priority * 1e12 + timestamp (lower = higher priority)
        const score = notification.priority * 1e12 + Date.now()
        await this.redis.zadd('notification:queue', score, JSON.stringify(notification))
    }

    async dequeue(): Promise&lt;Notification | null&gt; {
        // Get lowest score (highest priority + oldest)
        const result = await this.redis.zpopmin('notification:queue')
        return result ? JSON.parse(result[0]) : null
    }
}
</pre>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>Feature 3: Scheduled Notifications</h4>
                        <p>Allow scheduling notifications for future delivery with timezone awareness.</p>
                        <div style="background: #f1f5f9; padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 280px;">
                                    <strong style="color: #1e293b;">Implementation:</strong>
                                    <div style="background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; margin-top: 8px;">
<pre style="margin: 0;">
// Scheduler Service
class NotificationScheduler {
    // Cron job runs every minute
    @Cron('* * * * *')
    async processScheduled() {
        const now = new Date()
        const due = await db.notifications.findMany({
            where: {
                scheduled_at: { lte: now },
                status: 'SCHEDULED'
            },
            take: 1000
        })

        for (const notif of due) {
            // Convert to user's timezone
            const userTz = notif.user.timezone
            const localTime = toTimezone(now, userTz)

            // Respect quiet hours
            if (!isQuietHours(localTime, notif.user)) {
                await queue.enqueue(notif)
            } else {
                // Reschedule to next available window
                await this.reschedule(notif)
            }
        }
    }
}
</pre>
                                    </div>
                                </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <strong style="color: #1e293b;">Use Cases:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; color: #475569;">
                                        <li>Birthday wishes at midnight user's time</li>
                                        <li>Sale reminders before event starts</li>
                                        <li>Weekly digest every Sunday 9 AM</li>
                                        <li>Appointment reminders 24h before</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Reversion -->
                    <div class="feature-card" style="border-left-color: #ef4444;">
                        <h4 style="color: #991b1b;">Feature Reversion: Batching Rollback</h4>
                        <p>Sometimes batching can delay critical notifications. Here's how to revert safely:</p>
                        <div style="background: #fef2f2; padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 250px;">
                                    <strong style="color: #991b1b;">Problem Identified:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; color: #7f1d1d;">
                                        <li>OTP notifications were being batched</li>
                                        <li>Users couldn't login due to delayed OTPs</li>
                                        <li>5-minute batch window too long for critical msgs</li>
                                    </ul>
                                </div>
                                <div style="flex: 1; min-width: 250px;">
                                    <strong style="color: #166534;">Reversion Strategy:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; color: #475569;">
                                        <li>Add priority check before batching</li>
                                        <li>P1/P2 notifications bypass batch buffer</li>
                                        <li>Feature flag to disable batching per category</li>
                                        <li>Gradual rollout: 10% -&gt; 50% -&gt; 100%</li>
                                    </ul>
                                </div>
                            </div>
<div style="background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; margin-top: 12px;">
// Fixed batching logic
if (notification.priority &lt;= 2 || notification.category === 'OTP') {
    await sendImmediately(notification)  // Bypass batching
} else {
    await addToBatchBuffer(notification)  // Normal flow
}
</div>
                        </div>
                    </div>

                    <!-- Delivery Guarantees -->
                    <div class="feature-card">
                        <h4>Delivery Guarantee Strategies</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 12px;">
                            <div style="background: #f0fdf4; border: 2px solid #22c55e; padding: 16px; border-radius: 8px;">
                                <strong style="color: #166534;">At-Least-Once Delivery</strong>
                                <p style="font-size: 13px; color: #475569; margin: 8px 0;">Message may be delivered multiple times but never lost.</p>
                                <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                    <li>Acknowledge only after successful delivery</li>
                                    <li>Retry on failure with backoff</li>
                                    <li>Use idempotency keys to handle duplicates</li>
                                    <li>Best for: Transactional notifications</li>
                                </ul>
                            </div>
                            <div style="background: #fefce8; border: 2px solid #eab308; padding: 16px; border-radius: 8px;">
                                <strong style="color: #854d0e;">At-Most-Once Delivery</strong>
                                <p style="font-size: 13px; color: #475569; margin: 8px 0;">Message delivered once or not at all. No retries.</p>
                                <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                    <li>Acknowledge before processing</li>
                                    <li>No retry mechanism</li>
                                    <li>Lower latency, simpler logic</li>
                                    <li>Best for: Marketing, non-critical alerts</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== PAN-INDIA SCALE ==================== -->
                <div class="stage-section" id="pan-india">
                    <div class="stage-header">
                        <span class="stage-badge pan-india">PAN-India Scale</span>
                        <h2>Scaling to 100M+ Users</h2>
                    </div>
                    <p>Handle millions of concurrent users with multi-vendor support, fault tolerance, and rate limiting.</p>

                    <!-- Multi-Vendor Support -->
                    <div class="feature-card">
                        <h4>Multi-Vendor Support</h4>
                        <p>Use multiple vendors per channel for redundancy and cost optimization.</p>
                        <div class="diagram-container">
                            <h4>Vendor Failover Architecture</h4>
                            <div style="display: flex; flex-direction: column; gap: 16px; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                    <div class="arch-box server">Channel Router</div>
                                    <span class="arch-arrow">--&gt;</span>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div class="arch-box cdn" style="font-size: 12px;">FCM (Primary)</div>
                                            <span style="color: #22c55e; font-size: 12px;">Active</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div class="arch-box cdn" style="font-size: 12px; opacity: 0.6;">APNS (Fallback)</div>
                                            <span style="color: #94a3b8; font-size: 12px;">Standby</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; margin-top: 12px;">
<pre style="margin: 0;">
// Vendor Configuration
const vendorConfig = {
    PUSH: {
        primary: { name: 'FCM', weight: 70, costPerMsg: 0.001 },
        secondary: { name: 'OneSignal', weight: 30, costPerMsg: 0.002 }
    },
    SMS: {
        primary: { name: 'Twilio', weight: 60, costPerMsg: 0.05 },
        secondary: { name: 'MSG91', weight: 40, costPerMsg: 0.03 }  // Cheaper for India
    },
    EMAIL: {
        primary: { name: 'SendGrid', weight: 80, costPerMsg: 0.0001 },
        secondary: { name: 'AWS SES', weight: 20, costPerMsg: 0.00008 }
    }
}

// Smart Router with health checks
class VendorRouter {
    async route(notification: Notification, channel: Channel) {
        const vendors = vendorConfig[channel]
        const healthyVendor = await this.getHealthyVendor(vendors)

        if (!healthyVendor) {
            await this.sendToDLQ(notification, 'ALL_VENDORS_DOWN')
            return
        }

        return this.send(notification, healthyVendor)
    }

    private async getHealthyVendor(vendors) {
        // Check circuit breaker status
        if (await circuitBreaker.isOpen(vendors.primary.name)) {
            return vendors.secondary
        }
        return vendors.primary
    }
}
</pre>
                        </div>
                    </div>

                    <!-- DLQ Handling -->
                    <div class="feature-card">
                        <h4>Dead Letter Queue (DLQ) Handling</h4>
                        <p>Capture and process failed notifications for analysis and retry.</p>
                        <div class="diagram-container">
                            <h4>DLQ Processing Flow</h4>
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                <div class="arch-box queue">Main Queue</div>
                                <span class="arch-arrow">--&gt;</span>
                                <div class="arch-box server">Worker</div>
                                <span class="arch-arrow">--&gt;</span>
                                <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                                    <div style="color: #22c55e; font-size: 12px;">Success --&gt; Done</div>
                                    <div style="color: #ef4444; font-size: 12px;">Fail (3x) --&gt;</div>
                                </div>
                                <div class="arch-box queue" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">DLQ</div>
                                <span class="arch-arrow">--&gt;</span>
                                <div class="arch-box server">DLQ Processor</div>
                            </div>
                        </div>
                        <div style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; margin-top: 12px;">
<pre style="margin: 0;">
// DLQ Processor
class DLQProcessor {
    async process() {
        const failedNotifs = await dlq.consume(100)

        for (const notif of failedNotifs) {
            const analysis = this.analyzeFailure(notif)

            switch(analysis.action) {
                case 'RETRY':
                    // Vendor was temporarily down, retry with different vendor
                    await mainQueue.enqueue({...notif, vendor: 'SECONDARY'})
                    break

                case 'DROP':
                    // Invalid user/token, log and drop
                    await this.logPermanentFailure(notif)
                    break

                case 'ALERT':
                    // Unusual pattern, alert on-call
                    await alerting.page('High DLQ volume', analysis)
                    break
            }
        }
    }

    analyzeFailure(notif) {
        if (notif.error.includes('INVALID_TOKEN')) return { action: 'DROP' }
        if (notif.error.includes('RATE_LIMITED')) return { action: 'RETRY' }
        if (notif.retryCount > 5) return { action: 'ALERT' }
        return { action: 'RETRY' }
    }
}
</pre>
                        </div>
                    </div>

                    <!-- Rate Limiting -->
                    <div class="feature-card">
                        <h4>Rate Limiting Per Channel</h4>
                        <p>Protect vendors and users from notification spam using <span class="term-tooltip" onclick="showTooltip('rate-limiting')">rate limiting<span class="info-icon">i</span></span>.</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 12px;">
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;">PUSH</div>
                                <div style="font-size: 14px; color: #475569;">1000/sec per app</div>
                                <div style="font-size: 12px; color: #94a3b8;">10/min per user</div>
                            </div>
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;">SMS</div>
                                <div style="font-size: 14px; color: #475569;">100/sec per account</div>
                                <div style="font-size: 12px; color: #94a3b8;">5/hour per user</div>
                            </div>
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;">EMAIL</div>
                                <div style="font-size: 14px; color: #475569;">500/sec per domain</div>
                                <div style="font-size: 12px; color: #94a3b8;">20/day per user</div>
                            </div>
                        </div>
                        <div style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; margin-top: 12px;">
<pre style="margin: 0;">
// Token Bucket Rate Limiter
class ChannelRateLimiter {
    private redis: Redis

    async checkLimit(channel: string, userId: string): Promise&lt;boolean&gt; {
        const key = `ratelimit:${channel}:${userId}`
        const limit = this.getLimitForChannel(channel)

        const current = await this.redis.incr(key)
        if (current === 1) {
            await this.redis.expire(key, limit.windowSeconds)
        }

        if (current > limit.maxRequests) {
            await metrics.increment('rate_limit.exceeded', { channel, userId })
            return false  // Rate limited
        }
        return true
    }

    getLimitForChannel(channel: string) {
        const limits = {
            'PUSH': { maxRequests: 10, windowSeconds: 60 },
            'SMS': { maxRequests: 5, windowSeconds: 3600 },
            'EMAIL': { maxRequests: 20, windowSeconds: 86400 }
        }
        return limits[channel]
    }
}
</pre>
                        </div>
                    </div>

                    <!-- Rich Notifications -->
                    <div class="feature-card" style="border-left-color: #8b5cf6;">
                        <h4>New Feature: Rich Notifications</h4>
                        <p>Support images, action buttons, and deep links in notifications.</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 12px;">
                            <div style="background: #f5f3ff; border: 2px solid #8b5cf6; padding: 16px; border-radius: 8px;">
                                <strong style="color: #5b21b6;">Rich Push Notification</strong>
                                <div style="background: white; border-radius: 8px; padding: 12px; margin-top: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div style="display: flex; gap: 12px;">
                                        <div style="width: 60px; height: 60px; background: #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center;">IMG</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 14px;">Flash Sale Live!</div>
                                            <div style="font-size: 12px; color: #64748b;">Up to 70% off on electronics</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                                        <button style="flex: 1; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 12px;">Shop Now</button>
                                        <button style="flex: 1; padding: 8px; background: #e2e8f0; border: none; border-radius: 4px; font-size: 12px;">Remind Later</button>
                                    </div>
                                </div>
                            </div>
                            <div style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 12px;">
<pre style="margin: 0;">
// Rich notification payload
{
    "title": "Flash Sale Live!",
    "body": "Up to 70% off on electronics",
    "image_url": "https://cdn.../sale.jpg",
    "actions": [
        {
            "id": "shop_now",
            "title": "Shop Now",
            "deeplink": "app://sale/electronics"
        },
        {
            "id": "remind",
            "title": "Remind Later",
            "action": "SCHEDULE_REMINDER"
        }
    ],
    "data": {
        "campaign_id": "flash_sale_jan",
        "tracking_id": "notif_123"
    }
}
</pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== HIGH TRAFFIC ==================== -->
                <div class="stage-section" id="high-traffic">
                    <div class="stage-header">
                        <span class="stage-badge high-traffic">High Traffic</span>
                        <h2>Flash Sales &amp; Breaking News</h2>
                    </div>
                    <p>Handle traffic spikes of 10M+ notifications in seconds during flash sales or breaking news events.</p>

                    <!-- Fan-out Strategies -->
                    <div class="feature-card">
                        <h4>Fan-out Strategies</h4>
                        <p>Efficiently distribute notifications to millions of users using <span class="term-tooltip" onclick="showTooltip('kafka')">Kafka<span class="info-icon">i</span></span> partitioning.</p>
                        <div class="diagram-container">
                            <h4>Partitioned Fan-out Architecture</h4>
                            <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                                <div class="arch-box server">Notification Publisher</div>
                                <div style="color: #64748b;">Publish to topic: notifications</div>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                                    <div style="background: #f1f5f9; padding: 12px; border-radius: 8px; text-align: center;">
                                        <div style="font-weight: 600; font-size: 13px;">Partition 0</div>
                                        <div style="font-size: 11px; color: #64748b;">user_id % 8 = 0</div>
                                        <div style="font-size: 11px; color: #64748b;">Worker Group A</div>
                                    </div>
                                    <div style="background: #f1f5f9; padding: 12px; border-radius: 8px; text-align: center;">
                                        <div style="font-weight: 600; font-size: 13px;">Partition 1</div>
                                        <div style="font-size: 11px; color: #64748b;">user_id % 8 = 1</div>
                                        <div style="font-size: 11px; color: #64748b;">Worker Group A</div>
                                    </div>
                                    <div style="background: #f1f5f9; padding: 12px; border-radius: 8px; text-align: center;">
                                        <div style="font-weight: 600; font-size: 13px;">...</div>
                                        <div style="font-size: 11px; color: #64748b;">...</div>
                                    </div>
                                    <div style="background: #f1f5f9; padding: 12px; border-radius: 8px; text-align: center;">
                                        <div style="font-weight: 600; font-size: 13px;">Partition 7</div>
                                        <div style="font-size: 11px; color: #64748b;">user_id % 8 = 7</div>
                                        <div style="font-size: 11px; color: #64748b;">Worker Group B</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; margin-top: 12px;">
<pre style="margin: 0;">
// High-throughput fan-out for flash sales
class FlashSaleNotifier {
    async notifyAllUsers(campaign: Campaign) {
        // Stream users in batches to avoid memory issues
        const userStream = db.users.stream({
            where: { push_enabled: true },
            batchSize: 10000
        })

        for await (const userBatch of userStream) {
            // Produce to Kafka in parallel
            const messages = userBatch.map(user =&gt; ({
                key: user.id,  // Partition by user_id
                value: JSON.stringify({
                    user_id: user.id,
                    campaign_id: campaign.id,
                    device_token: user.device_token
                })
            }))

            await kafka.producer.sendBatch({
                topic: 'flash-sale-notifications',
                messages
            })
        }
    }
}

// Worker auto-scaling based on lag
if (kafkaLag &gt; 100000) {
    await k8s.scaleDeployment('notification-worker', currentReplicas * 2)
}
</pre>
                        </div>
                    </div>

                    <!-- Deduplication -->
                    <div class="feature-card">
                        <h4>Deduplication</h4>
                        <p>Prevent duplicate notifications using idempotency keys and bloom filters.</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 12px;">
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 8px;">
                                <strong style="color: #1e293b;">Idempotency Key Strategy</strong>
                                <div style="background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; margin-top: 8px;">
<pre style="margin: 0;">
// Generate deterministic key
const idempotencyKey = hash(
    `${userId}:${campaignId}:${date}`
)

// Check before processing
const exists = await redis.setnx(
    `dedup:${idempotencyKey}`,
    '1',
    'EX', 86400  // 24 hour TTL
)

if (!exists) {
    return // Already processed
}
</pre>
                                </div>
                            </div>
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 8px;">
                                <strong style="color: #1e293b;">Bloom Filter for Scale</strong>
                                <div style="background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; margin-top: 8px;">
<pre style="margin: 0;">
// Bloom filter for 100M entries
// 1% false positive rate
const bloomFilter = new BloomFilter({
    size: 1e9,  // 1 billion bits
    hashes: 7
})

// Check with bloom filter first (fast)
if (bloomFilter.mightContain(key)) {
    // Double-check with Redis (slow but accurate)
    if (await redis.exists(`dedup:${key}`)) {
        return // Definitely duplicate
    }
}

// New notification
bloomFilter.add(key)
await redis.set(`dedup:${key}`, '1', 'EX', 86400)
</pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Retry with Exponential Backoff -->
                    <div class="feature-card">
                        <h4>Retry with Exponential Backoff</h4>
                        <p>Implement smart retry logic with <span class="term-tooltip" onclick="showTooltip('circuit-breaker')">circuit breaker<span class="info-icon">i</span></span> pattern.</p>
                        <div class="diagram-container">
                            <h4>Retry Timeline</h4>
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                <div style="background: #ef4444; color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px;">Attempt 1<br><span style="font-size: 10px;">t=0</span></div>
                                <span style="color: #64748b;">--&gt;</span>
                                <div style="background: #f59e0b; color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px;">Retry 1<br><span style="font-size: 10px;">t=1s</span></div>
                                <span style="color: #64748b;">--&gt;</span>
                                <div style="background: #f59e0b; color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px;">Retry 2<br><span style="font-size: 10px;">t=4s</span></div>
                                <span style="color: #64748b;">--&gt;</span>
                                <div style="background: #f59e0b; color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px;">Retry 3<br><span style="font-size: 10px;">t=16s</span></div>
                                <span style="color: #64748b;">--&gt;</span>
                                <div style="background: #6b7280; color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px;">DLQ<br><span style="font-size: 10px;">t=64s</span></div>
                            </div>
                            <div style="text-align: center; margin-top: 12px; color: #64748b; font-size: 12px;">
                                Formula: delay = min(base * 2^attempt + jitter, maxDelay)
                            </div>
                        </div>
                        <div style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; margin-top: 12px;">
<pre style="margin: 0;">
class RetryHandler {
    private circuitBreaker: CircuitBreaker

    async sendWithRetry(notification: Notification, maxRetries = 4) {
        for (let attempt = 0; attempt &lt;= maxRetries; attempt++) {
            try {
                // Check circuit breaker before attempting
                if (this.circuitBreaker.isOpen(notification.vendor)) {
                    throw new Error('Circuit open, using fallback')
                }

                const result = await this.send(notification)
                this.circuitBreaker.recordSuccess(notification.vendor)
                return result

            } catch (error) {
                this.circuitBreaker.recordFailure(notification.vendor)

                if (attempt === maxRetries) {
                    await dlq.enqueue(notification, error)
                    return
                }

                // Exponential backoff with jitter
                const baseDelay = 1000  // 1 second
                const maxDelay = 60000  // 1 minute
                const jitter = Math.random() * 1000
                const delay = Math.min(baseDelay * Math.pow(2, attempt) + jitter, maxDelay)

                await sleep(delay)
            }
        }
    }
}

// Circuit Breaker Configuration
const circuitBreaker = new CircuitBreaker({
    failureThreshold: 5,      // Open after 5 failures
    successThreshold: 3,       // Close after 3 successes
    timeout: 30000,            // Half-open after 30s
    volumeThreshold: 10        // Min requests before tripping
})
</pre>
                        </div>
                    </div>
                </div>

                <!-- ==================== GLOBAL SCALE ==================== -->
                <div class="stage-section" id="global">
                    <div class="stage-header">
                        <span class="stage-badge global">Global Scale</span>
                        <h2>Worldwide Deployment</h2>
                    </div>
                    <p>Expand to serve users globally with multi-region architecture and compliance considerations.</p>

                    <div class="feature-card">
                        <h4>Global Architecture Overview</h4>
                        <div class="diagram-container">
                            <h4>Multi-Region Deployment</h4>
                            <div style="display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;">
                                <div style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 180px;">
                                    <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">US-East</div>
                                    <div style="font-size: 12px; color: #64748b;">
                                        - Notification Service<br>
                                        - Kafka Cluster<br>
                                        - Redis Cluster<br>
                                        - PostgreSQL Primary
                                    </div>
                                </div>
                                <div style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 180px;">
                                    <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">EU-West</div>
                                    <div style="font-size: 12px; color: #64748b;">
                                        - Notification Service<br>
                                        - Kafka Cluster<br>
                                        - Redis Cluster<br>
                                        - PostgreSQL Replica
                                    </div>
                                </div>
                                <div style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 180px;">
                                    <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">APAC</div>
                                    <div style="font-size: 12px; color: #64748b;">
                                        - Notification Service<br>
                                        - Kafka Cluster<br>
                                        - Redis Cluster<br>
                                        - PostgreSQL Replica
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 16px;">
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 8px;">
                                <strong style="color: #1e293b;">Geo-Routing</strong>
                                <ul style="font-size: 13px; color: #475569; margin: 8px 0 0 0; padding-left: 16px;">
                                    <li>Route to nearest region based on user location</li>
                                    <li>Use GeoDNS for automatic routing</li>
                                    <li>Fallback to next closest region on failure</li>
                                </ul>
                            </div>
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 8px;">
                                <strong style="color: #1e293b;">Data Residency (GDPR)</strong>
                                <ul style="font-size: 13px; color: #475569; margin: 8px 0 0 0; padding-left: 16px;">
                                    <li>EU user data stays in EU region</li>
                                    <li>Separate Kafka topics per region</li>
                                    <li>Cross-region replication for metadata only</li>
                                </ul>
                            </div>
                            <div style="background: #f1f5f9; padding: 16px; border-radius: 8px;">
                                <strong style="color: #1e293b;">Vendor Selection by Region</strong>
                                <ul style="font-size: 13px; color: #475569; margin: 8px 0 0 0; padding-left: 16px;">
                                    <li>India: MSG91, Gupshup for SMS</li>
                                    <li>US/EU: Twilio, Vonage</li>
                                    <li>APAC: Local carriers for cost optimization</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== PROS & CONS ==================== -->
                <div class="stage-section">
                    <h2 style="margin-bottom: 24px;">Pros &amp; Cons Analysis</h2>

                    <div class="pros-cons-grid">
                        <div class="pros-section">
                            <h4>Pros</h4>

                            <div style="margin-bottom: 16px;">
                                <strong style="color: #166534;">1. Decoupled Architecture with Message Queues</strong>
                                <p style="font-size: 13px; color: #475569; margin: 4px 0;">Services communicate asynchronously, enabling independent scaling and fault isolation.</p>
                                <div class="care-points">
                                    <h5>What to Care:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>Message ordering guarantees</li>
                                        <li>Queue depth monitoring</li>
                                        <li>Consumer lag alerts</li>
                                    </ul>
                                </div>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <strong style="color: #166534;">2. Multi-Vendor Redundancy</strong>
                                <p style="font-size: 13px; color: #475569; margin: 4px 0;">No single point of failure with automatic failover between vendors.</p>
                                <div class="care-points">
                                    <h5>What to Care:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>Vendor API compatibility</li>
                                        <li>Cost variations between vendors</li>
                                        <li>Feature parity across vendors</li>
                                    </ul>
                                </div>
                            </div>

                            <div>
                                <strong style="color: #166534;">3. Priority-Based Processing</strong>
                                <p style="font-size: 13px; color: #475569; margin: 4px 0;">Critical notifications always delivered first, regardless of queue depth.</p>
                                <div class="care-points">
                                    <h5>What to Care:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>Priority starvation for low-priority items</li>
                                        <li>Correct priority assignment</li>
                                        <li>SLA monitoring per priority level</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="cons-section">
                            <h4>Cons</h4>

                            <div style="margin-bottom: 16px;">
                                <strong style="color: #991b1b;">1. Increased Operational Complexity</strong>
                                <p style="font-size: 13px; color: #475569; margin: 4px 0;">Managing Kafka, Redis, multiple databases, and vendor integrations requires expertise.</p>
                                <div class="manage-points">
                                    <h5>How to Manage:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>Use managed services (AWS MSK, ElastiCache)</li>
                                        <li>Implement comprehensive monitoring</li>
                                        <li>Create runbooks for common issues</li>
                                    </ul>
                                </div>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <strong style="color: #991b1b;">2. Eventual Consistency Challenges</strong>
                                <p style="font-size: 13px; color: #475569; margin: 4px 0;">Async processing means notification status may lag behind actual delivery.</p>
                                <div class="manage-points">
                                    <h5>How to Manage:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>Implement webhook callbacks from vendors</li>
                                        <li>Add polling for status reconciliation</li>
                                        <li>Use delivery receipts where available</li>
                                    </ul>
                                </div>
                            </div>

                            <div>
                                <strong style="color: #991b1b;">3. Cost at Scale</strong>
                                <p style="font-size: 13px; color: #475569; margin: 4px 0;">SMS and push notification costs can escalate quickly at millions of messages.</p>
                                <div class="manage-points">
                                    <h5>How to Manage:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>Implement smart batching to reduce API calls</li>
                                        <li>Use cheaper regional vendors</li>
                                        <li>Set budget alerts and per-user limits</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deep Learning Q&A Section -->
                <div class="stage-section">
                    <h2 style="margin-bottom: 24px;">Deep Learning Q&amp;A</h2>

                    <div class="feature-card">
                        <h4>Q1: How would you handle a notification storm during a flash sale?</h4>
                        <div style="background: #f1f5f9; padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <p style="color: #475569; margin: 0;"><strong>Answer:</strong> Implement a multi-layered approach:</p>
                            <ol style="color: #475569; margin: 8px 0 0 0; padding-left: 20px;">
                                <li><strong>Pre-warm infrastructure:</strong> Scale workers before the event based on expected load</li>
                                <li><strong>Rate limiting:</strong> Apply per-user limits to prevent spam (e.g., max 1 flash sale notification per user)</li>
                                <li><strong>Staggered delivery:</strong> Instead of sending all at once, use time-based sharding (hash(user_id) % 60 = second to send)</li>
                                <li><strong>Priority queues:</strong> Ensure transactional notifications (OTPs, order confirmations) aren't blocked by marketing bulk</li>
                                <li><strong>Auto-scaling:</strong> Use Kafka consumer lag as a scaling signal - if lag > threshold, spin up more workers</li>
                            </ol>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>Q2: What happens when a user has notifications disabled but you need to send a critical security alert?</h4>
                        <div style="background: #f1f5f9; padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <p style="color: #475569; margin: 0;"><strong>Answer:</strong> Implement a notification category hierarchy:</p>
                            <ul style="color: #475569; margin: 8px 0 0 0; padding-left: 20px;">
                                <li><strong>Category types:</strong> CRITICAL (cannot disable), TRANSACTIONAL (required for service), PROMOTIONAL (can disable)</li>
                                <li><strong>Channel fallback:</strong> If push is disabled, fall back to SMS for critical alerts</li>
                                <li><strong>Legal compliance:</strong> Ensure users can still disable promotional, but keep transactional enabled by default</li>
                                <li><strong>In-app fallback:</strong> Always show critical notifications in the app's notification center regardless of push settings</li>
                            </ul>
                        </div>
                    </div>

                    <div class="feature-card">
                        <h4>Q3: How do you ensure exactly-once delivery for payment notifications?</h4>
                        <div style="background: #f1f5f9; padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <p style="color: #475569; margin: 0;"><strong>Answer:</strong> True exactly-once is impossible in distributed systems, but you can achieve effectively-once:</p>
                            <ul style="color: #475569; margin: 8px 0 0 0; padding-left: 20px;">
                                <li><strong>Idempotency keys:</strong> Use transaction_id as the dedup key, stored in Redis with 24h TTL</li>
                                <li><strong>Database constraints:</strong> Add unique constraint on (user_id, transaction_id, notification_type)</li>
                                <li><strong>At-least-once + dedup:</strong> Accept duplicates at the producer level, deduplicate at consumer before sending</li>
                                <li><strong>Outbox pattern:</strong> Write notification to DB in same transaction as payment, then process asynchronously</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rate Limiter Section -->
        <div id="rate-limiter" class="system-section">
            <h1>‚è±Ô∏è Rate Limiter System Design</h1>
            <p style="color: #64748b; margin-bottom: 24px;">Design a distributed rate limiting service to protect APIs from abuse</p>

            <div id="rate-limiter-content">
                <!-- MVP STAGE -->
                <div class="stage-section" id="rl-mvp">
                    <div class="stage-header">
                        <span class="stage-badge mvp">MVP Stage</span>
                        <h2 style="margin: 0;">Single Server Rate Limiter</h2>
                    </div>

                    <h3>üìä Algorithm Selection</h3>
                    <div class="feature-card">
                        <h4>Why Token Bucket?</h4>
                        <p>For MVP, we choose the <strong>Token Bucket</strong> algorithm for its simplicity and burst-handling capability.</p>

                        <div class="diagram-container">
                            <h4>TOKEN BUCKET ALGORITHM</h4>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 24px; flex-wrap: wrap;">
                                <div style="text-align: center;">
                                    <div style="width: 80px; height: 100px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 8px; display: flex; flex-direction: column; justify-content: flex-end; padding: 8px;">
                                        <div style="background: #fbbf24; height: 60%; border-radius: 4px;"></div>
                                    </div>
                                    <p style="font-size: 12px; color: #64748b; margin-top: 8px;">Token Bucket<br>(6/10 tokens)</p>
                                </div>
                                <div style="text-align: center;">
                                    <p style="font-size: 24px;">‚¨áÔ∏è</p>
                                    <p style="font-size: 12px; color: #64748b;">Refill: 10 tokens/sec</p>
                                </div>
                                <div style="text-align: center;">
                                    <p style="font-size: 24px;">‚û°Ô∏è</p>
                                    <p style="font-size: 12px; color: #64748b;">Request consumes 1 token</p>
                                </div>
                            </div>
                        </div>

                        <div class="pros-cons-grid">
                            <div class="pros-section">
                                <h4>‚úÖ Pros</h4>
                                <ul>
                                    <li><strong>Allows Bursts</strong> - Handles traffic spikes gracefully</li>
                                    <li><strong>Memory Efficient</strong> - Only 2 values per user</li>
                                    <li><strong>Simple Implementation</strong> - Easy to understand</li>
                                </ul>
                                <div class="care-points">
                                    <h5>‚ö†Ô∏è What to Care About:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>Set bucket size based on expected burst patterns</li>
                                        <li>Monitor token consumption rates for tuning</li>
                                        <li>Consider per-endpoint vs per-user limits</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="cons-section">
                                <h4>‚ùå Cons</h4>
                                <ul>
                                    <li><strong>No Fixed Window</strong> - Can't guarantee exact rate</li>
                                    <li><strong>Burst at Boundaries</strong> - 2x rate at window edges</li>
                                    <li><strong>Memory per User</strong> - Grows with user count</li>
                                </ul>
                                <div class="manage-points">
                                    <h5>üîß How to Manage:</h5>
                                    <ul style="font-size: 12px; color: #475569; margin: 0; padding-left: 16px;">
                                        <li>Use sliding window for strict rate limiting</li>
                                        <li>Implement LRU eviction for inactive users</li>
                                        <li>Add secondary limits for abuse prevention</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3>üíæ Data Store</h3>
                    <div class="feature-card">
                        <h4>Why <span class="term-tooltip" onclick="showTooltip('redis')">Redis<span class="info-icon">i</span></span>?</h4>
                        <p>In-memory store with atomic operations and TTL support - perfect for rate limiting.</p>

                        <div class="diagram-container">
                            <h4>REDIS DATA STRUCTURE</h4>
                            <div class="schema-diagram">
                                <div class="schema-table">
                                    <div class="schema-table-header">rate_limit:{user_id}</div>
                                    <div class="schema-table-body">
                                        <div class="schema-field"><span class="field-name">tokens</span><span class="field-type">INT (current)</span></div>
                                        <div class="schema-field"><span class="field-name">last_refill</span><span class="field-type">TIMESTAMP</span></div>
                                        <div class="schema-field"><span class="field-name">TTL</span><span class="field-type">3600 sec</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3>üèóÔ∏è Architecture (MVP)</h3>
                    <div class="diagram-container">
                        <h4>MVP ARCHITECTURE</h4>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;">
                            <div class="arch-box client">Client</div>
                            <span class="arch-arrow">‚Üí</span>
                            <div class="arch-box lb">API Gateway</div>
                            <span class="arch-arrow">‚Üí</span>
                            <div class="arch-box cache">Rate Limiter</div>
                            <span class="arch-arrow">‚Üí</span>
                            <div class="arch-box server">Backend API</div>
                        </div>
                    </div>

                    <!-- Feature Additions -->
                    <h3>üÜï Feature Addition 1: Sliding Window Counter</h3>
                    <div class="feature-card" style="border-left-color: #22c55e;">
                        <h4>Why Add This?</h4>
                        <p>Token bucket allows bursts at window boundaries. Sliding window provides smoother rate limiting.</p>
                    </div>

                    <h3>üÜï Feature Addition 2: Tiered Rate Limits</h3>
                    <div class="feature-card" style="border-left-color: #8b5cf6;">
                        <h4>Why Add Tiers?</h4>
                        <p>Different users need different limits: Free (100/hr), Pro (1000/hr), Enterprise (10000/hr)</p>
                    </div>

                    <h3>üÜï Feature Addition 3: Real-time Analytics</h3>
                    <div class="feature-card" style="border-left-color: #f59e0b;">
                        <h4>Why Add Analytics?</h4>
                        <p>Ops team needs visibility into rate limit hits, top offenders, and attack patterns.</p>
                    </div>
                </div>

                <!-- PAN-INDIA SCALE -->
                <div class="stage-section" id="rl-pan-india">
                    <div class="stage-header">
                        <span class="stage-badge pan-india">PAN-India Scale</span>
                        <h2 style="margin: 0;">Distributed Rate Limiting</h2>
                    </div>

                    <div class="diagram-container">
                        <h4>DISTRIBUTED ARCHITECTURE</h4>
                        <div style="display: flex; flex-direction: column; gap: 16px; align-items: center;">
                            <div class="arch-box client">Clients</div>
                            <span>‚Üì</span>
                            <div class="arch-box lb">Load Balancer</div>
                            <span>‚Üì</span>
                            <div style="display: flex; gap: 16px;">
                                <div class="arch-box server">API 1</div>
                                <div class="arch-box server">API 2</div>
                                <div class="arch-box server">API N</div>
                            </div>
                            <span>‚Üì All check ‚Üì</span>
                            <div class="arch-box cache">Redis Cluster</div>
                        </div>
                    </div>
                </div>

                <!-- HIGH TRAFFIC -->
                <div class="stage-section" id="rl-high-traffic">
                    <div class="stage-header">
                        <span class="stage-badge high-traffic">High Traffic</span>
                        <h2 style="margin: 0;">Handling Attack Traffic</h2>
                    </div>

                    <h3>‚ö†Ô∏è What Breaks First?</h3>
                    <div class="feature-card" style="border-left-color: #ef4444;">
                        <ol>
                            <li><strong>Redis bottleneck:</strong> 100K+ checks/sec overwhelms single Redis</li>
                            <li><strong>Network latency:</strong> Cross-datacenter Redis calls add 5-10ms</li>
                            <li><strong>Memory explosion:</strong> Tracking millions of IPs during DDoS</li>
                        </ol>
                    </div>

                    <h3>üõ†Ô∏è Solution: Local + Global Rate Limiting</h3>
                    <div class="diagram-container">
                        <h4>HYBRID APPROACH</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px; align-items: center;">
                            <div class="arch-box client">Request</div>
                            <span>‚Üì</span>
                            <div class="arch-box server" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">Local Cache (0.1ms)</div>
                            <span>‚Üì if allowed ‚Üì</span>
                            <div class="arch-box cache">Global Redis (1ms)</div>
                            <span>‚Üì if allowed ‚Üì</span>
                            <div class="arch-box server">Process Request</div>
                        </div>
                    </div>
                </div>

                <!-- GLOBAL SCALE -->
                <div class="stage-section" id="rl-global">
                    <div class="stage-header">
                        <span class="stage-badge global">Global Scale</span>
                        <h2 style="margin: 0;">Multi-Region Rate Limiting</h2>
                    </div>

                    <div class="feature-card">
                        <h4>Key Considerations</h4>
                        <ul>
                            <li><strong>Regional Autonomy:</strong> Each region enforces limits locally</li>
                            <li><strong><span class="term-tooltip" onclick="showTooltip('eventual-consistency')">Eventual Consistency<span class="info-icon">i</span></span>:</strong> Global aggregation async (1-5 sec delay)</li>
                            <li><strong>Split Limits:</strong> 1000/hr global = 400 US + 300 EU + 300 Asia</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Food Ordering Section -->
        <div id="food-ordering" class="system-section">
            <h1>üçî Food Ordering System Design</h1>
            <p style="color: #64748b; margin-bottom: 24px;">Design an online food delivery platform like Swiggy/Zomato with real-time tracking</p>

            <div id="food-ordering-content">
                <div style="text-align: center; padding: 60px; color: #64748b;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                    <p>Loading Food Ordering content...</p>
                </div>
            </div>
        </div>

        <!-- Slot Booking Section -->
        <div id="slot-booking" class="system-section">
            <h1>üìÖ Slot Booking System Design</h1>
            <p style="color: #64748b; margin-bottom: 24px;">Design a slot booking system for appointments, meetings, and resource scheduling</p>

            <div id="slot-booking-content">
                <div style="text-align: center; padding: 60px; color: #64748b;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                    <p>Loading Slot Booking content...</p>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Tooltip Overlay -->
<div class="tooltip-overlay" id="tooltipOverlay" onclick="closeTooltip()"></div>
<div class="tooltip-popup" id="tooltipPopup">
    <button class="tooltip-close" onclick="closeTooltip()">&times;</button>
    <h4 id="tooltipTitle"></h4>
    <p id="tooltipContent"></p>
</div>

<script>
// Term definitions for tooltips
const termDefinitions = {
    'cdn': {
        title: 'CDN (Content Delivery Network)',
        content: 'A geographically distributed network of proxy servers that cache and deliver content closer to users. CDNs reduce latency by serving static assets from edge locations nearest to the user, improving load times and reducing origin server load.'
    },
    'load-balancer': {
        title: 'Load Balancer',
        content: 'A device or software that distributes incoming network traffic across multiple servers to ensure no single server becomes overwhelmed. Common algorithms include Round Robin, Least Connections, and IP Hash.'
    },
    'redis': {
        title: 'Redis',
        content: 'An in-memory data structure store used as a database, cache, and message broker. Redis supports various data structures like strings, hashes, lists, sets, and sorted sets with O(1) operations.'
    },
    'kafka': {
        title: 'Apache Kafka',
        content: 'A distributed event streaming platform capable of handling trillions of events per day. Used for real-time data pipelines, event sourcing, and as a commit log for distributed systems.'
    },
    'sharding': {
        title: 'Database Sharding',
        content: 'A horizontal scaling technique where data is partitioned across multiple database instances. Each shard contains a subset of the total data, determined by a sharding key (e.g., user_id % num_shards).'
    },
    'consistent-hashing': {
        title: 'Consistent Hashing',
        content: 'A distributed hashing technique where only K/n keys need to be remapped when a node is added or removed (K = total keys, n = number of nodes). Used in distributed caches and databases to minimize rebalancing.'
    },
    'rate-limiting': {
        title: 'Rate Limiting',
        content: 'A technique to control the rate of requests a user or client can make to an API. Common algorithms include Token Bucket (allows bursts), Leaky Bucket (smooths traffic), and Sliding Window (precise counting).'
    },
    'circuit-breaker': {
        title: 'Circuit Breaker Pattern',
        content: 'A design pattern that prevents cascading failures in distributed systems. When failures exceed a threshold, the circuit "opens" and fails fast, allowing the downstream service time to recover before retrying.'
    },
    'cap-theorem': {
        title: 'CAP Theorem',
        content: 'States that a distributed system can only provide two of three guarantees: Consistency (all nodes see same data), Availability (every request gets a response), Partition Tolerance (system works despite network partitions).'
    },
    'eventual-consistency': {
        title: 'Eventual Consistency',
        content: 'A consistency model where the system guarantees that if no new updates are made, eventually all reads will return the last updated value. Common in distributed systems prioritizing availability over immediate consistency.'
    },
    'idempotency': {
        title: 'Idempotency',
        content: 'A property where making the same request multiple times produces the same result as making it once. Critical for payment systems and APIs to handle retries safely without duplicating operations.'
    },
    'websocket': {
        title: 'WebSocket',
        content: 'A communication protocol providing full-duplex communication channels over a single TCP connection. Unlike HTTP request-response, WebSockets allow real-time bidirectional data transfer between client and server.'
    },
    'message-queue': {
        title: 'Message Queue',
        content: 'An asynchronous communication protocol where messages are stored in a queue until processed. Decouples producers from consumers, enabling better scalability, fault tolerance, and load leveling.'
    },
    'database-index': {
        title: 'Database Index',
        content: 'A data structure that improves the speed of data retrieval operations on a database table. B-tree indexes are common for range queries, while hash indexes are optimal for equality lookups.'
    },
    'replica': {
        title: 'Database Replica',
        content: 'A copy of the primary database that stays synchronized. Read replicas handle read traffic to scale horizontally. Replication can be synchronous (strong consistency) or asynchronous (better performance).'
    }
};

function showSystem(systemId) {
    // Hide all sections
    document.querySelectorAll('.system-section').forEach(s => s.classList.remove('active'));

    // Show selected section
    document.getElementById(systemId).classList.add('active');

    // Update nav links
    document.querySelectorAll('.system-link').forEach(l => l.classList.remove('active'));
    document.querySelector(`[data-system="${systemId}"]`).classList.add('active');
}

function showTooltip(term) {
    const def = termDefinitions[term];
    if (def) {
        document.getElementById('tooltipTitle').textContent = def.title;
        document.getElementById('tooltipContent').textContent = def.content;
        document.getElementById('tooltipOverlay').classList.add('show');
        document.getElementById('tooltipPopup').classList.add('show');
    }
}

function closeTooltip() {
    document.getElementById('tooltipOverlay').classList.remove('show');
    document.getElementById('tooltipPopup').classList.remove('show');
}

// Close tooltip on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeTooltip();
});
</script>
