<style>
    .fw-section { background: var(--bg-secondary, #f8fafc); padding: 24px; border-radius: 12px; margin-bottom: 24px; border: 1px solid var(--border-color, #e2e8f0); }
    .fw-section h2 { font-size: 1.5rem; margin-bottom: 12px; color: var(--accent-primary, #3b82f6); }
    .fw-section h3 { font-size: 1.2rem; margin-top: 20px; margin-bottom: 12px; color: var(--accent-secondary, #8b5cf6); }
    .code-example { background: #f8f9fa; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin: 16px 0; overflow-x: auto; }
    .code-example pre { margin: 0; color: #1e293b; font-family: 'Fira Code', monospace; font-size: 0.9rem; white-space: pre-wrap; word-wrap: break-word; }
    .concept-card { background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid var(--accent-secondary); }
    .concept-card h4 { color: var(--accent-secondary); margin-bottom: 10px; }
    .highlight-box { background: rgba(59, 130, 246, 0.08); padding: 16px; border-radius: 8px; border-left: 4px solid var(--accent-primary); margin: 16px 0; }
    .pros-cons { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0; }
    .pros, .cons { padding: 16px; border-radius: 8px; }
    .pros { background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; }
    .cons { background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; }
    .pros h4 { color: #10b981; } .cons h4 { color: #ef4444; }
    @media (max-width: 768px) { .pros-cons { grid-template-columns: 1fr; } }

    /* Flow Diagram Styles */
    .flow-diagram { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 12px; padding: 24px; margin: 20px 0; }
    .flow-vertical { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .flow-step { display: flex; align-items: center; gap: 12px; width: 100%; max-width: 500px; }
    .flow-num { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; flex-shrink: 0; }
    .flow-content { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; padding: 10px 14px; flex: 1; }
    .flow-content.blue { border-left: 3px solid #3b82f6; }
    .flow-content.green { border-left: 3px solid #10b981; }
    .flow-content.purple { border-left: 3px solid #8b5cf6; }
    .flow-content.orange { border-left: 3px solid #f59e0b; }
    .flow-content.cyan { border-left: 3px solid #06b6d4; }
    .flow-title { color: #f8fafc; font-size: 0.85rem; font-weight: 600; margin-bottom: 2px; }
    .flow-desc { color: #94a3b8; font-size: 0.75rem; }
    .flow-arrow { color: #475569; font-size: 1.2rem; }
</style>

<div class="page-layout">
    <div class="page-main">
        <nav style="margin-bottom: 16px;"><a href="/frameworks" style="color: var(--accent-primary);">&larr; Back to Frameworks</a></nav>

        <h1>FastAPI</h1>
        <p class="text-muted mb-4">Modern, fast Python web framework with automatic OpenAPI docs, type hints, and async support</p>

        <!-- Request Flow Overview -->
        <div class="fw-section">
            <h2>Request Flow: Input to Output</h2>
            <p>How FastAPI processes a request through all layers:</p>

            <div class="flow-diagram">
                <div class="flow-vertical">
                    <div class="flow-step">
                        <div class="flow-num">1</div>
                        <div class="flow-content blue">
                            <div class="flow-title">HTTP Request</div>
                            <div class="flow-desc">POST /users {name: 'John', email: 'john@example.com'}</div>
                        </div>
                    </div>
                    <div class="flow-arrow">↓</div>

                    <div class="flow-step">
                        <div class="flow-num">2</div>
                        <div class="flow-content">
                            <div class="flow-title">ASGI Server (Uvicorn)</div>
                            <div class="flow-desc">Receive HTTP, create scope & connection</div>
                        </div>
                    </div>
                    <div class="flow-arrow">↓</div>

                    <div class="flow-step">
                        <div class="flow-num">3</div>
                        <div class="flow-content purple">
                            <div class="flow-title">Middleware Stack</div>
                            <div class="flow-desc">CORS → Auth → Request ID → Logging</div>
                        </div>
                    </div>
                    <div class="flow-arrow">↓</div>

                    <div class="flow-step">
                        <div class="flow-num">4</div>
                        <div class="flow-content">
                            <div class="flow-title">Router & Path Matching</div>
                            <div class="flow-desc">Match /users route, extract path params</div>
                        </div>
                    </div>
                    <div class="flow-arrow">↓</div>

                    <div class="flow-step">
                        <div class="flow-num">5</div>
                        <div class="flow-content orange">
                            <div class="flow-title">Dependency Injection</div>
                            <div class="flow-desc">Resolve: get_db(), get_current_user()</div>
                        </div>
                    </div>
                    <div class="flow-arrow">↓</div>

                    <div class="flow-step">
                        <div class="flow-num">6</div>
                        <div class="flow-content purple">
                            <div class="flow-title">Request Validation (Pydantic)</div>
                            <div class="flow-desc">Validate & parse JSON against model</div>
                        </div>
                    </div>
                    <div class="flow-arrow">↓</div>

                    <div class="flow-step">
                        <div class="flow-num">7</div>
                        <div class="flow-content cyan">
                            <div class="flow-title">Route Handler</div>
                            <div class="flow-desc">async def create_user() - Business Logic</div>
                        </div>
                    </div>
                    <div class="flow-arrow">↓</div>

                    <div class="flow-step">
                        <div class="flow-num">8</div>
                        <div class="flow-content">
                            <div class="flow-title">Database (SQLAlchemy)</div>
                            <div class="flow-desc">INSERT INTO users VALUES (...)</div>
                        </div>
                    </div>
                    <div class="flow-arrow">↓</div>

                    <div class="flow-step">
                        <div class="flow-num">9</div>
                        <div class="flow-content green">
                            <div class="flow-title">Response</div>
                            <div class="flow-desc">Pydantic serialization → JSON Response 201</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Concepts -->
        <div class="fw-section">
            <h2>Key Concepts with Examples</h2>

            <div class="concept-card">
                <h4>1. Path Operations & Decorators</h4>
                <p>Decorators define HTTP method and path. Type hints enable automatic validation.</p>
                <div class="code-example">
                    <pre><code class="language-python">from fastapi import FastAPI, Path, Query, Body
from pydantic import BaseModel, EmailStr

app = FastAPI()

# Pydantic model for request/response
class UserCreate(BaseModel):
    name: str
    email: EmailStr
    age: int | None = None

class UserResponse(BaseModel):
    id: int
    name: str
    email: str

# POST with request body validation
@app.post("/users", response_model=UserResponse, status_code=201)
async def create_user(user: UserCreate):
    # user is already validated by Pydantic
    return {"id": 1, "name": user.name, "email": user.email}

# GET with path and query parameters
@app.get("/users/{user_id}")
async def get_user(
    user_id: int = Path(..., gt=0, description="User ID"),
    include_posts: bool = Query(False)
):
    return {"user_id": user_id, "include_posts": include_posts}</code></pre>
                </div>
            </div>

            <div class="concept-card">
                <h4>2. Dependency Injection</h4>
                <p>FastAPI's DI system allows clean, testable code by injecting dependencies into handlers.</p>
                <div class="code-example">
                    <pre><code class="language-python">from fastapi import Depends, HTTPException
from sqlalchemy.orm import Session

# Database session dependency
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# Auth dependency
async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: Session = Depends(get_db)
):
    user = verify_token(token, db)
    if not user:
        raise HTTPException(401, "Invalid token")
    return user

# Use dependencies in route
@app.get("/me")
async def get_me(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    return current_user

# Dependencies can be nested and cached per-request</code></pre>
                </div>
            </div>

            <div class="concept-card">
                <h4>3. Middleware</h4>
                <p>Middleware runs before and after every request for cross-cutting concerns.</p>
                <div class="code-example">
                    <pre><code class="language-python">from fastapi import Request
from fastapi.middleware.cors import CORSMiddleware
import time

# Built-in CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://myapp.com"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# Custom middleware for timing
@app.middleware("http")
async def add_timing(request: Request, call_next):
    start = time.time()
    response = await call_next(request)
    duration = time.time() - start
    response.headers["X-Response-Time"] = str(duration)
    return response

# Middleware execution order:
# 1. Request comes in
# 2. Middleware processes (top to bottom)
# 3. Route handler executes
# 4. Middleware processes response (bottom to top)
# 5. Response sent</code></pre>
                </div>
            </div>

            <div class="concept-card">
                <h4>4. Async/Await Support</h4>
                <p>FastAPI supports both sync and async handlers. Use async for I/O-bound operations.</p>
                <div class="code-example">
                    <pre><code class="language-python">import httpx
import asyncio

# Async handler for concurrent I/O
@app.get("/dashboard")
async def get_dashboard(user_id: int):
    async with httpx.AsyncClient() as client:
        # Run multiple API calls concurrently
        user_task = client.get(f"/api/users/{user_id}")
        posts_task = client.get(f"/api/users/{user_id}/posts")
        notifications_task = client.get(f"/api/notifications")

        user, posts, notifications = await asyncio.gather(
            user_task, posts_task, notifications_task
        )

    return {
        "user": user.json(),
        "posts": posts.json(),
        "notifications": notifications.json()
    }

# Sync handler (runs in thread pool)
@app.get("/sync-endpoint")
def sync_handler():
    # CPU-bound or blocking I/O
    return {"message": "This runs in a thread"}</code></pre>
                </div>
            </div>

            <div class="concept-card">
                <h4>5. Background Tasks</h4>
                <p>Run tasks after returning response for non-blocking operations.</p>
                <div class="code-example">
                    <pre><code class="language-python">from fastapi import BackgroundTasks

async def send_email(email: str, message: str):
    # Simulate slow email sending
    await asyncio.sleep(5)
    print(f"Email sent to {email}")

@app.post("/register")
async def register(
    user: UserCreate,
    background_tasks: BackgroundTasks
):
    # Create user immediately
    new_user = create_user_in_db(user)

    # Queue email to send after response
    background_tasks.add_task(
        send_email,
        user.email,
        "Welcome to our platform!"
    )

    # Response returns immediately
    return {"id": new_user.id, "message": "User created"}</code></pre>
                </div>
            </div>
        </div>

        <div class="fw-section">
            <h2>Why FastAPI?</h2>
            <div class="pros-cons">
                <div class="pros">
                    <h4>Advantages</h4>
                    <ul>
                        <li>Automatic OpenAPI/Swagger docs</li>
                        <li>Type hints = validation + IDE support</li>
                        <li>Async-first, very fast performance</li>
                        <li>Dependency injection built-in</li>
                        <li>Modern Python (3.7+) features</li>
                    </ul>
                </div>
                <div class="cons">
                    <h4>Considerations</h4>
                    <ul>
                        <li>Smaller ecosystem than Django/Flask</li>
                        <li>No built-in ORM (use SQLAlchemy)</li>
                        <li>No admin panel (use SQLAdmin)</li>
                        <li>Async learning curve</li>
                        <li>Less mature than alternatives</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <aside class="page-sidebar">
        <div class="panel">
            <div class="panel-header">Quick Facts</div>
            <div class="quick-ref-item"><span class="quick-ref-key">Type</span><span class="quick-ref-value">Async Framework</span></div>
            <div class="quick-ref-item"><span class="quick-ref-key">Server</span><span class="quick-ref-value">Uvicorn/Hypercorn</span></div>
            <div class="quick-ref-item"><span class="quick-ref-key">Validation</span><span class="quick-ref-value">Pydantic</span></div>
            <div class="quick-ref-item"><span class="quick-ref-key">ORM</span><span class="quick-ref-value">SQLAlchemy</span></div>
        </div>
        <div class="panel mt-4">
            <div class="panel-header">Related</div>
            <a href="/frameworks/flask" class="quick-ref-item" style="display:block;text-decoration:none;">Flask</a>
            <a href="/frameworks/django" class="quick-ref-item" style="display:block;text-decoration:none;">Django</a>
            <a href="/frameworks/sanic" class="quick-ref-item" style="display:block;text-decoration:none;">Sanic</a>
        </div>
    </aside>
</div>
