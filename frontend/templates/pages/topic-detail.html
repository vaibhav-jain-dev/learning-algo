<div class="topic-detail-page">
    <nav class="breadcrumb">
        <a href="/{{if eq .CategorySlug "system-design"}}system-design{{else if eq .CategorySlug "design-patterns"}}design-patterns{{else}}machine-coding{{end}}">‚Üê Back to {{.Category}}</a>
    </nav>

    <div class="topic-header">
        <span class="topic-badge">{{.Category}}</span>
        <h1>{{.Topic}}</h1>
    </div>

    {{if .HasContent}}
    <!-- ADHD-friendly three-column layout -->
    <div class="adhd-layout">
        <!-- Left navigation panel (auto-populated by JavaScript) -->
        <aside class="adhd-nav-panel">
            <!-- JavaScript will auto-generate table of contents from H2/H3 headings -->
        </aside>

        <!-- Main content area -->
        <main class="adhd-main-content">
            <div class="topic-content" id="topic-content">
                {{safeHTML .Content}}
            </div>
        </main>

        <!-- Right quick reference panel (auto-populated by JavaScript) -->
        <aside class="adhd-quick-ref">
            <!-- JavaScript will auto-generate quick reference cards -->
        </aside>
    </div>
    {{else}}
    <div class="coming-soon-card">
        <div class="coming-soon-icon">üöß</div>
        <h2>Content Coming Soon</h2>
        <p>We're working on detailed content for <strong>{{.Topic}}</strong>.</p>
        <p>This will include:</p>
        <ul>
            <li>Comprehensive explanation</li>
            <li>Code examples in Python and Go</li>
            <li>Visual diagrams</li>
            <li>Practice problems</li>
            <li>Interview tips</li>
        </ul>
        <div class="actions">
            <a href="/practice" class="btn btn-primary">Practice DSA Problems</a>
            <a href="/{{if eq .CategorySlug "system-design"}}system-design{{else if eq .CategorySlug "design-patterns"}}design-patterns{{else}}machine-coding{{end}}" class="btn btn-secondary">Browse Other Topics</a>
        </div>
    </div>
    {{end}}
</div>

<!-- Styles moved to /static/css/topic-detail.css -->

{{if .HasContent}}
<script>
// Initialize topic content with collapsible sections, code blocks, and animations
(function() {
    var content = document.getElementById('topic-content');
    if (!content) return;

    // ============================================
    // ANCHOR LINKS FOR HEADINGS
    // ============================================

    // Enable smooth scrolling for the entire document
    document.documentElement.style.scrollBehavior = 'smooth';

    // Create toast element for copy feedback
    var toast = document.createElement('div');
    toast.className = 'anchor-toast';
    toast.textContent = 'Link copied to clipboard!';
    document.body.appendChild(toast);

    // Function to show toast notification
    function showToast(message) {
        toast.textContent = message || 'Link copied to clipboard!';
        toast.classList.add('show');
        setTimeout(function() {
            toast.classList.remove('show');
        }, 2000);
    }

    // Function to copy URL to clipboard
    function copyAnchorLink(id) {
        var url = window.location.href.split('#')[0] + '#' + id;
        navigator.clipboard.writeText(url).then(function() {
            showToast('Link copied to clipboard!');
        }).catch(function(err) {
            // Fallback for older browsers
            var textArea = document.createElement('textarea');
            textArea.value = url;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Link copied to clipboard!');
            } catch (e) {
                showToast('Failed to copy link');
            }
            document.body.removeChild(textArea);
        });
    }

    // Add anchor links to all headings with IDs
    var headingsWithIds = content.querySelectorAll('h1[id], h2[id], h3[id], h4[id]');
    headingsWithIds.forEach(function(heading) {
        var id = heading.getAttribute('id');
        if (!id) return;

        // Skip if already has an anchor (added by global script in main.html)
        if (heading.querySelector('.heading-anchor')) return;

        // Create anchor link element
        var anchor = document.createElement('a');
        anchor.className = 'heading-anchor';
        anchor.href = '#' + id;
        anchor.setAttribute('aria-label', 'Link to this section');
        anchor.setAttribute('title', 'Click to copy link to this section');

        // Prevent default link behavior and copy to clipboard instead
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            copyAnchorLink(id);
            // Also update the URL hash without scrolling
            history.pushState(null, null, '#' + id);
        });

        // Insert anchor as first child of heading
        heading.insertBefore(anchor, heading.firstChild);

        // Also make the heading itself clickable to copy link
        heading.addEventListener('click', function(e) {
            // Don't trigger if clicking on the anchor or on collapsible icon
            if (e.target.classList.contains('heading-anchor') ||
                e.target.classList.contains('collapse-icon')) {
                return;
            }
            copyAnchorLink(id);
            history.pushState(null, null, '#' + id);
        });
    });

    // Handle initial hash in URL - scroll to section smoothly
    if (window.location.hash) {
        var targetId = window.location.hash.substring(1);
        var targetElement = document.getElementById(targetId);
        if (targetElement) {
            // Small delay to ensure page is fully loaded
            setTimeout(function() {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }

    // Handle hash changes (e.g., when clicking internal links)
    window.addEventListener('hashchange', function() {
        if (window.location.hash) {
            var targetId = window.location.hash.substring(1);
            var targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    });

    // Sections to make collapsible (initially collapsed)
    var collapseSections = [
        'Implementation', 'Python', 'Go', 'Golang',
        'Interview', 'Best Practices', 'Related',
        'Solution', 'Common Mistakes', 'Tips',
        'Data Structure', 'Memory', 'Complexity'
    ];

    // Make sections collapsible
    var headings = content.querySelectorAll('h2, h3');
    headings.forEach(function(heading) {
        var text = heading.textContent.trim();
        var shouldCollapse = collapseSections.some(function(s) {
            return text.toLowerCase().indexOf(s.toLowerCase()) !== -1;
        });

        if (shouldCollapse && !heading.dataset.collapsible) {
            heading.dataset.collapsible = 'true';
            heading.classList.add('collapsible-heading');

            // Add collapse icon
            var icon = document.createElement('span');
            icon.className = 'collapse-icon';
            icon.textContent = '‚ñ∂';
            heading.insertBefore(icon, heading.firstChild);

            // Find content elements until next heading of same or higher level
            var contentEls = [];
            var next = heading.nextElementSibling;
            var headingLevel = parseInt(heading.tagName.charAt(1));
            while (next) {
                if (next.tagName === 'H1' || next.tagName === 'H2' ||
                    (next.tagName === 'H3' && headingLevel <= 3)) {
                    var nextLevel = parseInt(next.tagName.charAt(1));
                    if (nextLevel <= headingLevel) break;
                }
                contentEls.push(next);
                next = next.nextElementSibling;
            }

            // Initially hide content
            contentEls.forEach(function(el) {
                el.style.display = 'none';
            });

            // Toggle on click with smooth animation
            heading.addEventListener('click', function() {
                var isHidden = contentEls.length > 0 && contentEls[0].style.display === 'none';
                contentEls.forEach(function(el) {
                    if (isHidden) {
                        el.style.display = '';
                        el.style.opacity = '0';
                        el.style.transform = 'translateY(-10px)';
                        setTimeout(function() {
                            el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                            el.style.opacity = '1';
                            el.style.transform = 'translateY(0)';
                        }, 10);
                    } else {
                        el.style.opacity = '0';
                        el.style.transform = 'translateY(-10px)';
                        setTimeout(function() {
                            el.style.display = 'none';
                            el.style.transition = '';
                        }, 300);
                    }
                });
                icon.textContent = isHidden ? '‚ñº' : '‚ñ∂';
                icon.style.transition = 'transform 0.2s ease';
            });
        }
    });

    // Add copy buttons to code blocks
    var codeBlocks = content.querySelectorAll('pre code');
    codeBlocks.forEach(function(block) {
        var pre = block.parentElement;
        if (!pre || pre.parentElement.classList.contains('code-block-wrapper')) return;

        // Create wrapper
        var wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);

        // Copy button
        var copyBtn = document.createElement('button');
        copyBtn.className = 'code-copy-btn';
        copyBtn.innerHTML = 'Copy';
        copyBtn.onclick = function(e) {
            e.stopPropagation();
            navigator.clipboard.writeText(block.textContent).then(function() {
                copyBtn.innerHTML = 'Copied!';
                copyBtn.style.background = '#10b981';
                copyBtn.style.color = 'white';
                setTimeout(function() {
                    copyBtn.innerHTML = 'Copy';
                    copyBtn.style.background = '';
                    copyBtn.style.color = '';
                }, 2000);
            });
        };
        wrapper.appendChild(copyBtn);
    });

    // Highlight code
    if (typeof hljs !== 'undefined') {
        content.querySelectorAll('pre code').forEach(function(block) {
            hljs.highlightElement(block);
        });
    }

    // ============================================
    // DIAGRAM ANIMATIONS
    // ============================================

    // Animate diagrams on scroll into view
    var diagramElements = content.querySelectorAll('.diagram-section, .circuit-diagram, .state-diagram, .lb-architecture, div[style*="border-radius: 12px"], div[style*="border-radius: 16px"]');

    var observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
    };

    var diagramObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-in');
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    diagramElements.forEach(function(el) {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
        diagramObserver.observe(el);
    });

    // Animate flow arrows in diagrams
    var arrows = content.querySelectorAll('.diagram-arrow, .lb-arrow');
    arrows.forEach(function(arrow) {
        arrow.style.animation = 'slideRight 2s ease-in-out infinite';
    });

    // Add interactive tooltips to diagram boxes
    var diagramBoxes = content.querySelectorAll('.diagram-box, .state-box, .client-box, .server-box');
    diagramBoxes.forEach(function(box) {
        box.style.cursor = 'pointer';
        box.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px) scale(1.05)';
            this.style.boxShadow = '0 12px 30px rgba(0, 0, 0, 0.2)';
        });
        box.addEventListener('mouseleave', function() {
            this.style.transform = '';
            this.style.boxShadow = '';
        });
    });

    // Animate state transitions on hover
    var stateTransitions = content.querySelectorAll('.state-transition');
    stateTransitions.forEach(function(trans) {
        trans.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.02)';
            this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.15)';
        });
        trans.addEventListener('mouseleave', function() {
            this.style.transform = '';
            this.style.boxShadow = '';
        });
    });

    // Add reading progress indicator
    var progressBar = document.createElement('div');
    progressBar.className = 'reading-progress';
    progressBar.style.cssText = 'position: fixed; top: 0; left: 0; height: 3px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); width: 0%; z-index: 1000; transition: width 0.1s ease-out;';
    document.body.appendChild(progressBar);

    window.addEventListener('scroll', function() {
        var scrollTop = window.scrollY;
        var docHeight = document.documentElement.scrollHeight - window.innerHeight;
        var scrollPercent = (scrollTop / docHeight) * 100;
        progressBar.style.width = scrollPercent + '%';
    });

    // Smooth scroll for internal links
    content.querySelectorAll('a[href^="#"]').forEach(function(anchor) {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            var target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });

    // Table of contents generation for long content
    // Uses goldmark-generated IDs if available, falls back to section-X
    var h2s = content.querySelectorAll('h2');
    if (h2s.length > 4) {
        var toc = document.createElement('div');
        toc.className = 'table-of-contents';
        toc.innerHTML = '<h4 style="margin: 0 0 0.75rem 0; color: var(--text-primary);">Contents</h4>';
        var tocList = document.createElement('ul');
        tocList.style.cssText = 'list-style: none; padding: 0; margin: 0;';

        h2s.forEach(function(h2, index) {
            // Use existing goldmark-generated ID if available, otherwise create one
            var id = h2.id || ('section-' + index);
            if (!h2.id) {
                h2.id = id;
            }
            var li = document.createElement('li');
            li.style.cssText = 'margin-bottom: 0.5rem;';
            var link = document.createElement('a');
            link.href = '#' + id;
            // Clean up the heading text (remove anchor symbol and collapse icons)
            var cleanText = h2.textContent.replace(/^#/, '').replace('‚ñ∂', '').replace('‚ñº', '').trim();
            link.textContent = cleanText;
            link.style.cssText = 'color: var(--accent-color); text-decoration: none; font-size: 0.9rem; display: block; padding: 0.25rem 0; border-left: 2px solid transparent; padding-left: 0.75rem; transition: all 0.2s;';
            link.addEventListener('mouseenter', function() {
                this.style.borderLeftColor = 'var(--accent-color)';
                this.style.paddingLeft = '1rem';
            });
            link.addEventListener('mouseleave', function() {
                this.style.borderLeftColor = 'transparent';
                this.style.paddingLeft = '0.75rem';
            });
            li.appendChild(link);
            tocList.appendChild(li);
        });

        toc.appendChild(tocList);
        toc.style.cssText = 'background: var(--bg-secondary, #f8fafc); padding: 1rem 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; border: none; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);';

        // Insert TOC after first h2 or at the start
        var firstH2 = content.querySelector('h2');
        if (firstH2) {
            content.insertBefore(toc, firstH2);
        }
    }
})();
</script>
{{end}}
